import{u as H,a as J,s as S,j as e,L as $}from"./index-CZifL8RL.js";import{r as l,R as Q}from"./vendor-react-B1g8b4mG.js";import{P as K}from"./PageHeader-BAjjnQJ8.js";import{F as T,aG as Y,aI as E,aB as F,b as Z,Q as z,t as W,T as X,aJ as ee,a7 as se,U as te,a2 as ae,R as re,l as le}from"./vendor-icons-BfsEacNp.js";import"./vendor-supabase-DSZ6Ejbd.js";const p={INSERT:{icon:se,color:"text-green-600",bg:"bg-green-100",label:"Created"},UPDATE:{icon:ee,color:"text-blue-600",bg:"bg-blue-100",label:"Updated"},DELETE:{icon:X,color:"text-red-600",bg:"bg-red-100",label:"Deleted"},SOFT_DELETE:{icon:W,color:"text-amber-600",bg:"bg-amber-100",label:"Archived"},RESTORE:{icon:z,color:"text-purple-600",bg:"bg-purple-100",label:"Restored"}},A={timesheets:"Timesheet",expenses:"Expense",resources:"Resource",partners:"Partner",milestones:"Milestone",deliverables:"Deliverable",kpis:"KPI",quality_standards:"Quality Standard",partner_invoices:"Invoice"};function xe(){const{profile:g}=H(),{currentProject:n}=J(),[i,b]=l.useState([]),[c,j]=l.useState(!0),[y,f]=l.useState(null),[r,N]=l.useState({table:"",action:"",user:"",dateFrom:"",dateTo:""}),[u,k]=l.useState(!1),[v,w]=l.useState(0),[R,D]=l.useState(!0),h=50,[P,U]=l.useState(new Set),[L,q]=l.useState([]),o=g?.role==="admin"||g?.role==="supplier_pm",x=l.useCallback(async(s=!1)=>{if(!(!o||!n?.id))try{j(!0),f(null);const a=s?0:v;s&&w(0);let t=S.from("audit_log").select("*").eq("project_id",n.id).order("created_at",{ascending:!1}).range(a*h,(a+1)*h-1);r.table&&(t=t.eq("table_name",r.table)),r.action&&(t=t.eq("action",r.action)),r.user&&(t=t.eq("user_email",r.user)),r.dateFrom&&(t=t.gte("created_at",r.dateFrom)),r.dateTo&&(t=t.lte("created_at",r.dateTo+"T23:59:59"));const{data:d,error:C}=await t;if(C)throw C;b(s?d||[]:V=>[...V,...d||[]]),D((d?.length||0)===h)}catch(a){f(a.message)}finally{j(!1)}},[o,n?.id,r,v]),_=l.useCallback(async()=>{if(!o||!n?.id)return;const{data:s}=await S.from("audit_log").select("user_email").eq("project_id",n.id).not("user_email","is",null);if(s){const a=[...new Set(s.map(t=>t.user_email))].filter(Boolean);q(a)}},[o,n?.id]);l.useEffect(()=>{x(!0),_()},[x,_]);const m=(s,a)=>{N(t=>({...t,[s]:a}))},O=()=>{x(!0)},I=()=>{N({table:"",action:"",user:"",dateFrom:"",dateTo:""})},M=s=>{U(a=>{const t=new Set(a);return t.has(s)?t.delete(s):t.add(s),t})},B=s=>new Date(s).toLocaleString("en-GB",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}),G=s=>!s||s.length===0?null:s.join(", ");return o?e.jsxs("div",{className:"p-6",children:[e.jsx(K,{title:"Audit Log",subtitle:"Track all changes made to project data",icon:T}),e.jsxs("div",{className:"mb-6 bg-white rounded-lg shadow-sm border border-gray-200",children:[e.jsxs("button",{onClick:()=>k(!u),className:"w-full px-4 py-3 flex items-center justify-between text-left",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Y,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"font-medium",children:"Filters"}),Object.values(r).some(s=>s)&&e.jsx("span",{className:"bg-primary text-white text-xs px-2 py-0.5 rounded-full",children:"Active"})]}),u?e.jsx(E,{className:"w-4 h-4"}):e.jsx(F,{className:"w-4 h-4"})]}),u&&e.jsxs("div",{className:"px-4 pb-4 border-t border-gray-200 pt-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[e.jsx(Z,{className:"w-3 h-3 inline mr-1"}),"Table"]}),e.jsxs("select",{value:r.table,onChange:s=>m("table",s.target.value),className:"w-full border border-gray-300 rounded-md px-3 py-2 text-sm",children:[e.jsx("option",{value:"",children:"All Tables"}),Object.entries(A).map(([s,a])=>e.jsx("option",{value:s,children:a},s))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Action"}),e.jsxs("select",{value:r.action,onChange:s=>m("action",s.target.value),className:"w-full border border-gray-300 rounded-md px-3 py-2 text-sm",children:[e.jsx("option",{value:"",children:"All Actions"}),Object.entries(p).map(([s,a])=>e.jsx("option",{value:s,children:a.label},s))]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[e.jsx(te,{className:"w-3 h-3 inline mr-1"}),"User"]}),e.jsxs("select",{value:r.user,onChange:s=>m("user",s.target.value),className:"w-full border border-gray-300 rounded-md px-3 py-2 text-sm",children:[e.jsx("option",{value:"",children:"All Users"}),L.map(s=>e.jsx("option",{value:s,children:s},s))]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[e.jsx(ae,{className:"w-3 h-3 inline mr-1"}),"From Date"]}),e.jsx("input",{type:"date",value:r.dateFrom,onChange:s=>m("dateFrom",s.target.value),className:"w-full border border-gray-300 rounded-md px-3 py-2 text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"To Date"}),e.jsx("input",{type:"date",value:r.dateTo,onChange:s=>m("dateTo",s.target.value),className:"w-full border border-gray-300 rounded-md px-3 py-2 text-sm"})]})]}),e.jsxs("div",{className:"flex gap-2 mt-4",children:[e.jsx("button",{onClick:O,className:"px-4 py-2 bg-primary text-white rounded-md text-sm hover:bg-primary-dark",children:"Apply Filters"}),e.jsx("button",{onClick:I,className:"px-4 py-2 border border-gray-300 rounded-md text-sm hover:bg-gray-50",children:"Clear"})]})]})]}),e.jsx("div",{className:"flex justify-end mb-4",children:e.jsxs("button",{onClick:()=>x(!0),disabled:c,className:"flex items-center gap-2 px-3 py-2 text-sm border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50",children:[e.jsx(re,{className:`w-4 h-4 ${c?"animate-spin":""}`}),"Refresh"]})}),y&&e.jsx("div",{className:"mb-4 bg-red-50 border border-red-200 rounded-lg p-4 text-red-700",children:y}),c&&i.length===0&&e.jsx("div",{className:"flex justify-center py-12",children:e.jsx($,{})}),!c&&i.length===0&&e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx(T,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No audit logs found"}),Object.values(r).some(s=>s)&&e.jsx("p",{className:"text-sm mt-2",children:"Try adjusting your filters"})]}),i.length>0&&e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Time"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Action"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Table"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"User"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Changes"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Details"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:i.map(s=>{const a=p[s.action]||p.UPDATE,t=a.icon,d=P.has(s.id);return e.jsxs(Q.Fragment,{children:[e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(le,{className:"w-3 h-3"}),B(s.created_at)]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${a.bg} ${a.color}`,children:[e.jsx(t,{className:"w-3 h-3"}),a.label]})}),e.jsx("td",{className:"px-4 py-3 text-sm",children:A[s.table_name]||s.table_name}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:s.user_email||"System"}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:s.changed_fields&&s.changed_fields.length>0?e.jsx("span",{className:"text-xs bg-gray-100 px-2 py-1 rounded",children:G(s.changed_fields)}):e.jsx("span",{className:"text-gray-400",children:"-"})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("button",{onClick:()=>M(s.id),className:"text-primary hover:text-primary-dark text-sm flex items-center gap-1",children:[d?"Hide":"View",d?e.jsx(E,{className:"w-3 h-3"}):e.jsx(F,{className:"w-3 h-3"})]})})]}),d&&e.jsx("tr",{className:"bg-gray-50",children:e.jsxs("td",{colSpan:6,className:"px-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[s.old_data&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-medium text-gray-500 uppercase mb-2",children:"Previous Values"}),e.jsx("pre",{className:"text-xs bg-white border border-gray-200 rounded p-3 overflow-auto max-h-48",children:JSON.stringify(s.old_data,null,2)})]}),s.new_data&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-xs font-medium text-gray-500 uppercase mb-2",children:"New Values"}),e.jsx("pre",{className:"text-xs bg-white border border-gray-200 rounded p-3 overflow-auto max-h-48",children:JSON.stringify(s.new_data,null,2)})]})]}),e.jsxs("div",{className:"mt-3 text-xs text-gray-500",children:["Record ID: ",e.jsx("code",{className:"bg-gray-200 px-1 rounded",children:s.record_id})]})]})})]},s.id)})})]})}),R&&e.jsx("div",{className:"px-4 py-3 border-t border-gray-200 text-center",children:e.jsx("button",{onClick:()=>{w(s=>s+1),x()},disabled:c,className:"text-primary hover:text-primary-dark text-sm disabled:opacity-50",children:c?"Loading...":"Load More"})})]}),i.length>0&&e.jsxs("div",{className:"mt-4 text-sm text-gray-500 text-right",children:["Showing ",i.length," entries"]})]}):e.jsx("div",{className:"p-6",children:e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 text-red-700",children:"You do not have permission to view audit logs."})})}export{xe as default};
