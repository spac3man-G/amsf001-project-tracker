import{u as H,a as V,b as K,s as D,j as e,L as Q}from"./index-Jc8UWcdf.js";import{r as n}from"./vendor-react-JFEV0ROX.js";import{P as z}from"./PageHeader-HY5rYnKa.js";import{C as T}from"./ConfirmDialog-BwKxWdna.js";import{F as J,aH as A,ac as I,af as W,U as X,ag as Z,k as ee,l as k,A as se,aD as te,R as ae,aF as re,ay as le,y as ne,T as ie}from"./vendor-icons-yzeFIsqS.js";import"./vendor-supabase-DgEUAXvv.js";const o={timesheets:{label:"Timesheets",icon:ee,color:"bg-blue-100 text-blue-700",displayField:s=>`${s.date} - ${s.hours_worked||s.hours||0}h`,descriptionField:s=>s.description||s.comments||"No description"},expenses:{label:"Expenses",icon:Z,color:"bg-green-100 text-green-700",displayField:s=>`${s.expense_ref||"Expense"} - £${(s.amount||0).toFixed(2)}`,descriptionField:s=>s.reason||s.category||"No description"},resources:{label:"Resources",icon:X,color:"bg-purple-100 text-purple-700",displayField:s=>s.name,descriptionField:s=>s.role||s.email||"No role"},partners:{label:"Partners",icon:W,color:"bg-amber-100 text-amber-700",displayField:s=>s.name,descriptionField:s=>s.contact_email||"No contact"},milestones:{label:"Milestones",icon:I,color:"bg-indigo-100 text-indigo-700",displayField:s=>`${s.milestone_ref||""} - ${s.name}`,descriptionField:s=>s.description?.substring(0,100)||"No description"},deliverables:{label:"Deliverables",icon:A,color:"bg-teal-100 text-teal-700",displayField:s=>`${s.deliverable_ref||""} - ${s.name}`,descriptionField:s=>s.description?.substring(0,100)||"No description"},kpis:{label:"KPIs",icon:I,color:"bg-rose-100 text-rose-700",displayField:s=>s.name,descriptionField:s=>`Target: ${s.target_value||"N/A"}`},quality_standards:{label:"Quality Standards",icon:A,color:"bg-cyan-100 text-cyan-700",displayField:s=>s.name,descriptionField:s=>`Target: ${s.target_value||"N/A"}%`},partner_invoices:{label:"Invoices",icon:J,color:"bg-orange-100 text-orange-700",displayField:s=>`${s.invoice_number||"Invoice"} - £${(s.total||0).toFixed(2)}`,descriptionField:s=>`Period: ${s.period_start||"N/A"} to ${s.period_end||"N/A"}`}};function ue(){const{profile:s}=H(),{currentProject:b}=V(),{showSuccess:_,showError:c}=K(),[y,P]=n.useState({}),[m,S]=n.useState(!0),[$,p]=n.useState(null),[u,f]=n.useState(null),[h,j]=n.useState(null),[g,R]=n.useState(""),[N,E]=n.useState(!1),[O,L]=n.useState(new Set(["timesheets","expenses"])),w=s?.role==="admin"||s?.role==="supplier_pm",v=s?.role==="admin",x=n.useCallback(async()=>{if(!(!w||!b?.id))try{S(!0);const t=Object.keys(o),r={};for(const a of t){let i=D.from(a).select("*").eq("project_id",b.id).eq("is_deleted",!0).order("deleted_at",{ascending:!1});if(N){const C=new Date;C.setDate(C.getDate()-30),i=i.lt("deleted_at",C.toISOString())}const{data:d,error:l}=await i;l||d&&d.length>0&&(r[a]=d)}P(r)}catch{c("Failed to load deleted items")}finally{S(!1)}},[w,b?.id,N,c]);n.useEffect(()=>{x()},[x]);const q=async(t,r)=>{try{p(r.id);const{error:a}=await D.from(t).update({is_deleted:!1,deleted_at:null,deleted_by:null}).eq("id",r.id);if(a)throw a;_(`${o[t].label.slice(0,-1)} restored successfully`),f(null),x()}catch(a){c("Failed to restore item: "+a.message)}finally{p(null)}},U=async(t,r)=>{if(!v){c("Only admins can permanently delete items");return}try{p(r.id);const{error:a}=await D.from(t).delete().eq("id",r.id);if(a)throw a;_(`${o[t].label.slice(0,-1)} permanently deleted`),j(null),x()}catch(a){c("Failed to delete item: "+a.message)}finally{p(null)}},B=t=>{L(r=>{const a=new Set(r);return a.has(t)?a.delete(t):a.add(t),a})},M=t=>t?new Date(t).toLocaleString("en-GB",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}):"Unknown",Y=t=>{if(!t)return null;const r=new Date(t),i=Math.floor((new Date-r)/(1e3*60*60*24));return i===0?"Today":i===1?"Yesterday":`${i} days ago`},F=Object.values(y).reduce((t,r)=>t+r.length,0),G=g?{[g]:y[g]||[]}:y;return w?e.jsxs("div",{className:"p-6",children:[e.jsx(z,{title:"Deleted Items",subtitle:"View and restore soft-deleted records",icon:k}),e.jsx("div",{className:"mb-6 bg-amber-50 border border-amber-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(se,{className:"w-5 h-5 text-amber-600 mt-0.5"}),e.jsxs("div",{children:[e.jsxs("h3",{className:"font-medium text-amber-800",children:[F," deleted ",F===1?"item":"items"," found"]}),e.jsxs("p",{className:"text-sm text-amber-700 mt-1",children:["Items shown here have been soft-deleted and can be restored.",v&&" Admins can permanently delete items."]})]})]})}),e.jsxs("div",{className:"mb-6 flex flex-wrap gap-4 items-center",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(te,{className:"w-4 h-4 text-gray-500"}),e.jsxs("select",{value:g,onChange:t=>R(t.target.value),className:"border border-gray-300 rounded-md px-3 py-2 text-sm",children:[e.jsx("option",{value:"",children:"All Tables"}),Object.entries(o).map(([t,r])=>e.jsx("option",{value:t,children:r.label},t))]})]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:N,onChange:t=>E(t.target.checked),className:"rounded border-gray-300"}),"Show only items > 30 days old"]}),e.jsxs("button",{onClick:x,disabled:m,className:"flex items-center gap-2 px-3 py-2 text-sm border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 ml-auto",children:[e.jsx(ae,{className:`w-4 h-4 ${m?"animate-spin":""}`}),"Refresh"]})]}),m&&e.jsx("div",{className:"flex justify-center py-12",children:e.jsx(Q,{})}),!m&&F===0&&e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx(k,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No deleted items found"}),e.jsx("p",{className:"text-sm mt-2",children:"Items you delete will appear here for recovery"})]}),!m&&Object.entries(G).map(([t,r])=>{if(!r||r.length===0)return null;const a=o[t],i=a.icon,d=O.has(t);return e.jsxs("div",{className:"mb-4 bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden",children:[e.jsxs("button",{onClick:()=>B(t),className:"w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:`p-2 rounded-lg ${a.color}`,children:e.jsx(i,{className:"w-4 h-4"})}),e.jsx("span",{className:"font-medium",children:a.label}),e.jsx("span",{className:"bg-gray-200 text-gray-700 text-xs px-2 py-0.5 rounded-full",children:r.length})]}),d?e.jsx(re,{className:"w-4 h-4"}):e.jsx(le,{className:"w-4 h-4"})]}),d&&e.jsx("div",{className:"border-t border-gray-200",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Item"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Description"}),e.jsx("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:"Deleted"}),e.jsx("th",{className:"px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:r.map(l=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3 text-sm font-medium",children:a.displayField(l)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600 max-w-xs truncate",children:a.descriptionField(l)}),e.jsxs("td",{className:"px-4 py-3 text-sm text-gray-500",children:[e.jsx("div",{children:M(l.deleted_at)}),e.jsx("div",{className:"text-xs text-gray-400",children:Y(l.deleted_at)})]}),e.jsx("td",{className:"px-4 py-3 text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsxs("button",{onClick:()=>f({table:t,item:l}),disabled:$===l.id,className:"inline-flex items-center gap-1 px-2 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200 disabled:opacity-50",children:[e.jsx(ne,{className:"w-3 h-3"}),"Restore"]}),v&&e.jsxs("button",{onClick:()=>j({table:t,item:l}),disabled:$===l.id,className:"inline-flex items-center gap-1 px-2 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200 disabled:opacity-50",children:[e.jsx(ie,{className:"w-3 h-3"}),"Purge"]})]})})]},l.id))})]})})]},t)}),u&&e.jsx(T,{title:"Restore Item",message:`Are you sure you want to restore this ${o[u.table].label.slice(0,-1).toLowerCase()}? It will be visible again in the application.`,confirmLabel:"Restore",confirmStyle:"primary",onConfirm:()=>q(u.table,u.item),onCancel:()=>f(null)}),h&&e.jsx(T,{title:"Permanently Delete",message:`Are you sure you want to PERMANENTLY delete this ${o[h.table].label.slice(0,-1).toLowerCase()}? This action cannot be undone!`,confirmLabel:"Delete Forever",confirmStyle:"danger",onConfirm:()=>U(h.table,h.item),onCancel:()=>j(null)})]}):e.jsx("div",{className:"p-6",children:e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 text-red-700",children:"You do not have permission to view deleted items."})})}export{ue as default};
