import{u as he,c as xe,j as e,a as Ee,b as Te,e as Ie,f as ze,m as Oe,k as Le,q as qe,d as j,L as Fe}from"./index-CZifL8RL.js";import{r as h,L as Ue}from"./vendor-react-B1g8b4mG.js";import{i as fe,b as Ke,c as ge,d as je,e as ne,g as Qe,h as $e,D as J,j as Be,k as We,f as me,l as Ge,S as te,m as ue,n as Ve}from"./deliverableCalculations-DfTdc6Xy.js";import{S as Ye,D as He}from"./SignatureBox-D5pnUBp2.js";import{P as ve,a as be,F as Xe,a2 as Je,l as se,i as le,h as re,a6 as Ze,T as es,a9 as Ne,e as de,Q as Se,a0 as _e,C as ie,a8 as ss,R as is,a7 as as,Y as ts}from"./vendor-icons-BfsEacNp.js";import"./vendor-supabase-DSZ6Ejbd.js";function ns(l=null){const{user:i,role:r,profile:c}=he(),{canCreateDeliverable:n,canEditDeliverable:m,canDeleteDeliverable:f,canReviewDeliverable:w,canSubmitDeliverable:Z,canSignAsSupplier:V,canSignAsCustomer:Y}=xe(),v=r==="admin",P=r==="supplier_pm",y=r==="customer_pm",b=r==="contributor",D=i?.id||null,o=c?.full_name||i?.email||"Unknown",g=l?fe(l):!1,_=l?Ke(l):!0,M=!0,x=n,O=g||!_?!1:!!(v||P||b&&l?.assigned_to===o),L=g?!1:f,E=!l||!ge(l)?!1:!!(v||P||b&&l?.assigned_to===o),R=!l||!je(l)?!1:w,T=R,A=R,q=!l||!ne(l)?!1:v||y,p=!V||!l?!1:Qe(l),F=!Y||!l?!1:$e(l),N=l?l.supplier_pm_signed_at&&l.customer_pm_signed_at:!1,S=!l||!ne(l)?!1:v||y;return{currentUserId:D,currentUserName:o,userRole:r,isAdmin:v,isSupplierPM:P,isCustomerPM:y,isContributor:b,canView:M,canCreate:x,canEdit:O,canDelete:L,canSubmit:E,canSubmitForReview:E,canReview:R,canAcceptReview:T,canRejectReview:A,canInitiateSignOff:q,canSignAsSupplier:p,canSignAsCustomer:F,isFullySigned:N,canAssessKPIsAndQS:S,isComplete:g,isEditable:_}}function ls({kpis:l,selectedIds:i,onChange:r,disabled:c}){return!l||l.length===0?e.jsxs("div",{className:"linked-items-section edit-mode",children:[e.jsxs("div",{className:"section-header",children:[e.jsx(le,{size:14}),"Link to KPIs"]}),e.jsx("div",{className:"no-items-message",children:"No KPIs available to link"})]}):e.jsxs("div",{className:"linked-items-section edit-mode",children:[e.jsxs("div",{className:"section-header",children:[e.jsx(le,{size:14}),"Link to KPIs",i.length>0&&!c&&e.jsx("button",{type:"button",onClick:()=>r([]),className:"clear-button",children:"Clear all"})]}),e.jsx("div",{className:"selector-list",children:l.map(n=>{const m=i.includes(n.id);return e.jsxs("div",{onClick:()=>{c||r(m?i.filter(f=>f!==n.id):[...i,n.id])},className:`selector-item ${m?"selected":""} ${c?"disabled":""}`,children:[e.jsx("input",{type:"checkbox",checked:m,onChange:()=>{},disabled:c}),e.jsxs("div",{className:"selector-item-content",children:[e.jsx("span",{className:"item-badge kpi",children:n.kpi_ref}),e.jsx("span",{className:"item-name",children:n.name})]})]},n.id)})}),e.jsxs("div",{className:"selector-count",children:[i.length," selected"]}),c&&e.jsx("span",{className:"hint",children:"Only Supplier PM can edit KPI links"})]})}function rs({qualityStandards:l,selectedIds:i,onChange:r,disabled:c}){return!l||l.length===0?e.jsxs("div",{className:"linked-items-section edit-mode",children:[e.jsxs("div",{className:"section-header",children:[e.jsx(re,{size:14}),"Link to Quality Standards"]}),e.jsx("div",{className:"no-items-message",children:"No Quality Standards available to link"})]}):e.jsxs("div",{className:"linked-items-section edit-mode",children:[e.jsxs("div",{className:"section-header",children:[e.jsx(re,{size:14}),"Link to Quality Standards",i.length>0&&!c&&e.jsx("button",{type:"button",onClick:()=>r([]),className:"clear-button",children:"Clear all"})]}),e.jsx("div",{className:"selector-list",children:l.map(n=>{const m=i.includes(n.id);return e.jsxs("div",{onClick:()=>{c||r(m?i.filter(f=>f!==n.id):[...i,n.id])},className:`selector-item ${m?"selected":""} ${c?"disabled":""}`,children:[e.jsx("input",{type:"checkbox",checked:m,onChange:()=>{},disabled:c}),e.jsxs("div",{className:"selector-item-content",children:[e.jsx("span",{className:"item-badge quality-standard",children:n.qs_ref}),e.jsx("span",{className:"item-name",children:n.name})]})]},n.id)})}),e.jsxs("div",{className:"selector-count",children:[i.length," selected"]}),c&&e.jsx("span",{className:"hint",children:"Only Supplier PM can edit Quality Standard links"})]})}function ds({isOpen:l,deliverable:i,milestones:r,kpis:c,qualityStandards:n,canEdit:m,canReview:f,canDelete:w,onClose:Z,onSave:V,onStatusChange:Y,onDelete:v,onOpenCompletion:P,onSign:y}){const[b,D]=h.useState(!1),[o,g]=h.useState({}),[_,M]=h.useState(!1),x=ns(i),O=x.isSupplierPM||x.isAdmin,L=x.isSupplierPM||x.isAdmin,E=x.isSupplierPM||x.isAdmin||x.isContributor,R=x.isSupplierPM||x.isAdmin||x.isContributor,T=x.isSupplierPM||x.isAdmin;if(h.useEffect(()=>{i&&(g({name:i.name||"",description:i.description||"",milestone_id:i.milestone_id||"",status:i.status||J.NOT_STARTED,progress:i.progress||0,kpi_ids:i.deliverable_kpis?.map(a=>a.kpi_id)||[],qs_ids:i.deliverable_quality_standards?.map(a=>a.quality_standard_id)||[]}),D(!1))},[i]),!l||!i)return null;const A=Be(i.status),q=A.icon,p=r?.find(a=>a.id===i.milestone_id),F=i.deliverable_kpis||[],N=i.deliverable_quality_standards||[],S=fe(i),I=m&&ge(i),H=f&&je(i),X=f&&ne(i),B=We(i),U=i.supplier_pm_signed_at||i.customer_pm_signed_at,ee=i.status===J.REVIEW_COMPLETE||U||S,K=p?.forecast_end_date||p?.end_date;async function ae(){M(!0);try{await V(i.id,o),D(!1)}finally{M(!1)}}function z(){D(!1),Z()}function W(a){Y(i,a),z()}function u(a){const Q={progress:a},G=Ve(o.status,a);G&&(Q.status=G),g({...o,...Q})}async function k(a){if(y){M(!0);try{await y(i.id,a)}finally{M(!1)}}}return e.jsx("div",{className:"deliverable-modal-overlay",onClick:z,children:e.jsxs("div",{className:"deliverable-modal",onClick:a=>a.stopPropagation(),children:[e.jsxs("div",{className:"deliverable-modal-header",children:[e.jsxs("div",{className:"deliverable-modal-header-left",children:[e.jsx("div",{className:"deliverable-modal-icon",style:{backgroundColor:A.bg,color:A.color},children:e.jsx(ve,{size:20})}),e.jsxs("div",{className:"deliverable-modal-titles",children:[e.jsx("h2",{children:i.deliverable_ref}),e.jsx("span",{className:"subtitle",children:i.name})]})]}),e.jsxs("div",{className:"deliverable-modal-header-right",children:[e.jsxs("span",{className:"status-badge",style:{backgroundColor:A.bg,color:A.color},children:[e.jsx(q,{size:14}),i.status]}),e.jsx("button",{className:"close-button",onClick:z,children:e.jsx(be,{size:24})})]})]}),e.jsx("div",{className:"deliverable-modal-content",children:b?e.jsxs("div",{className:"deliverable-edit-form",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Name *"}),e.jsx("input",{type:"text",className:"form-input",value:o.name,onChange:a=>g({...o,name:a.target.value}),disabled:!O}),!O&&e.jsx("span",{className:"hint",children:"Only Supplier PM can edit name"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Description"}),e.jsx("textarea",{className:"form-input",rows:3,value:o.description,onChange:a=>g({...o,description:a.target.value}),disabled:!E}),!E&&e.jsx("span",{className:"hint",children:"Only Supplier PM or Contributor can edit description"})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Milestone"}),e.jsxs("select",{className:"form-input",value:o.milestone_id,onChange:a=>g({...o,milestone_id:a.target.value}),disabled:!L,children:[e.jsx("option",{value:"",children:"-- Select milestone --"}),r?.map(a=>e.jsxs("option",{value:a.id,children:[a.milestone_ref," - ",a.name]},a.id))]}),!L&&e.jsx("span",{className:"hint",children:"Only Supplier PM can edit milestone"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Due Date"}),e.jsx("div",{className:"form-input readonly",children:(()=>{const a=r?.find(G=>G.id===o.milestone_id),Q=a?.forecast_end_date||a?.end_date;return Q?me(Q):"Set by milestone"})()}),e.jsx("span",{className:"hint",children:"Derived from milestone forecast date"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{children:["Progress: ",o.progress,"%"]}),e.jsx("div",{className:"progress-slider",children:e.jsx("input",{type:"range",min:"0",max:"100",value:o.progress,onChange:a=>u(parseInt(a.target.value)),disabled:!R||Ge(o.status)})}),!R&&e.jsx("span",{className:"hint",children:"Only Supplier PM or Contributor can edit progress"})]}),e.jsx(ls,{kpis:c,selectedIds:o.kpi_ids,onChange:a=>g({...o,kpi_ids:a}),disabled:!T}),e.jsx(rs,{qualityStandards:n,selectedIds:o.qs_ids,onChange:a=>g({...o,qs_ids:a}),disabled:!T})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"deliverable-key-details",children:[e.jsxs("div",{className:"detail-item",children:[e.jsx(Xe,{size:18,className:"detail-item-icon"}),e.jsxs("div",{className:"detail-item-content",children:[e.jsx("div",{className:"detail-item-label",children:"Milestone"}),e.jsx("div",{className:"detail-item-value",children:p?e.jsxs(Ue,{to:`/milestones/${p.id}`,children:[p.milestone_ref," - ",p.name]}):"Not assigned"})]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx(Je,{size:18,className:"detail-item-icon"}),e.jsxs("div",{className:"detail-item-content",children:[e.jsx("div",{className:"detail-item-label",children:"Due Date"}),e.jsx("div",{className:"detail-item-value",children:K?me(K):"Not set"})]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx(se,{size:18,className:"detail-item-icon"}),e.jsxs("div",{className:"detail-item-content",children:[e.jsx("div",{className:"detail-item-label",children:"Progress"}),e.jsxs("div",{className:"progress-display",children:[e.jsx("div",{className:"progress-bar",children:e.jsx("div",{className:`progress-bar-fill ${S?"complete":"in-progress"}`,style:{width:`${i.progress||0}%`}})}),e.jsxs("span",{className:"progress-value",children:[i.progress||0,"%"]})]})]})]})]}),e.jsxs("div",{className:"deliverable-description",children:[e.jsx("div",{className:"section-label",children:"Description"}),e.jsx("div",{className:`description-text ${i.description?"":"empty"}`,children:i.description||"No description provided"})]}),F.length>0&&e.jsxs("div",{className:"linked-items-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsx(le,{size:14}),"Linked KPIs (",F.length,")"]}),e.jsx("div",{className:"linked-items-list",children:F.map(a=>e.jsxs("span",{className:"linked-item-badge kpi",children:[a.kpis?.kpi_ref||"KPI"," - ",a.kpis?.name||"Unknown"]},a.kpi_id))})]}),N.length>0&&e.jsxs("div",{className:"linked-items-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsx(re,{size:14}),"Linked Quality Standards (",N.length,")"]}),e.jsx("div",{className:"linked-items-list",children:N.map(a=>e.jsxs("span",{className:"linked-item-badge quality-standard",children:[a.quality_standards?.qs_ref||"QS"," - ",a.quality_standards?.name||"Unknown"]},a.quality_standard_id))})]}),ee&&e.jsxs("div",{className:"sign-off-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsx(Ze,{size:14}),"Delivery Sign-off"]}),S&&B===te.SIGNED?e.jsx(Ye,{message:"Deliverable accepted and delivered"}):e.jsx(He,{supplier:{signedBy:i.supplier_pm_name,signedAt:i.supplier_pm_signed_at,canSign:x.canSignAsSupplier&&y,onSign:()=>k("supplier")},customer:{signedBy:i.customer_pm_name,signedAt:i.customer_pm_signed_at,canSign:x.canSignAsCustomer&&y,onSign:()=>k("customer")},saving:_,supplierButtonText:"Sign as Supplier PM",customerButtonText:"Sign as Customer PM"}),!S&&U&&e.jsxs("div",{className:"sign-off-status-indicator",children:[B===te.AWAITING_CUSTOMER&&e.jsx("span",{className:"awaiting-badge customer",children:"Awaiting Customer PM signature"}),B===te.AWAITING_SUPPLIER&&e.jsx("span",{className:"awaiting-badge supplier",children:"Awaiting Supplier PM signature"})]})]}),e.jsxs("div",{className:"deliverable-timestamps",children:[e.jsxs("div",{className:"timestamp-item",children:[e.jsx(se,{size:14}),"Created: ",i.created_at?ue(i.created_at):"Unknown"]}),i.updated_at&&i.updated_at!==i.created_at&&e.jsxs("div",{className:"timestamp-item",children:[e.jsx(se,{size:14}),"Updated: ",ue(i.updated_at)]})]})]})}),e.jsxs("div",{className:"deliverable-modal-footer",children:[e.jsx("div",{className:"footer-left",children:w&&!b&&!S&&e.jsxs("button",{className:"btn btn-danger",onClick:()=>{v(i.id),z()},children:[e.jsx(es,{size:16})," Delete"]})}),e.jsx("div",{className:"footer-right",children:b?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>D(!1),disabled:_,children:"Cancel"}),e.jsxs("button",{className:"btn btn-primary",onClick:ae,disabled:_,children:[e.jsx(Ne,{size:16})," ",_?"Saving...":"Save Changes"]})]}):e.jsxs(e.Fragment,{children:[I&&e.jsxs("button",{className:"btn btn-secondary",onClick:()=>W(J.SUBMITTED_FOR_REVIEW),children:[e.jsx(de,{size:16})," Submit for Review"]}),H&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"btn btn-danger",onClick:()=>W(J.RETURNED_FOR_MORE_WORK),children:[e.jsx(Se,{size:16})," Return for More Work"]}),e.jsxs("button",{className:"btn btn-success",onClick:()=>W(J.REVIEW_COMPLETE),children:[e.jsx(_e,{size:16})," Accept Review"]})]}),X&&!U&&e.jsxs("button",{className:"btn btn-success",onClick:()=>{P(i),z()},children:[e.jsx(ie,{size:16})," Assess & Sign Off"]}),m&&!S&&e.jsxs("button",{className:"btn btn-primary",onClick:()=>D(!0),children:[e.jsx(ss,{size:16})," Edit"]})]})})]})]})})}const cs=["Not Started","In Progress","Submitted for Review","Returned for More Work","Review Complete","Delivered"],pe={Delivered:{bg:"#dcfce7",color:"#16a34a",icon:ie},"Review Complete":{bg:"#dbeafe",color:"#2563eb",icon:_e},"Submitted for Review":{bg:"#fef3c7",color:"#d97706",icon:de},"In Progress":{bg:"#e0e7ff",color:"#4f46e5",icon:se},"Returned for More Work":{bg:"#fee2e2",color:"#dc2626",icon:Se},"Not Started":{bg:"#f1f5f9",color:"#64748b",icon:ts}};function os({kpis:l,selectedIds:i,onChange:r,label:c="Link to KPIs"}){return e.jsxs("div",{style:{marginTop:"1rem"},children:[e.jsxs("label",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("span",{children:c}),i.length>0&&e.jsx("button",{type:"button",onClick:()=>r([]),style:{fontSize:"0.8rem",color:"#dc2626",background:"none",border:"none",cursor:"pointer"},children:"Clear"})]}),e.jsx("div",{style:{maxHeight:"200px",overflowY:"auto",border:"1px solid #e2e8f0",borderRadius:"8px",padding:"0.5rem"},children:l.map(n=>{const m=i.includes(n.id);return e.jsxs("div",{onClick:()=>r(m?i.filter(f=>f!==n.id):[...i,n.id]),style:{display:"flex",alignItems:"flex-start",gap:"0.75rem",padding:"0.75rem",marginBottom:"0.5rem",backgroundColor:m?"#dbeafe":"#f8fafc",border:m?"2px solid #3b82f6":"1px solid #e2e8f0",borderRadius:"8px",cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:m,onChange:()=>{},style:{marginTop:"3px"}}),e.jsxs("div",{children:[e.jsx("span",{style:{backgroundColor:"#3b82f6",color:"white",padding:"0.125rem 0.375rem",borderRadius:"4px",fontSize:"0.75rem",fontWeight:"700"},children:n.kpi_ref})," ",e.jsx("span",{style:{fontWeight:"600"},children:n.name})]})]},n.id)})}),e.jsxs("div",{style:{marginTop:"0.5rem",fontSize:"0.85rem",color:"#64748b"},children:[i.length," selected"]})]})}function ms({qualityStandards:l,selectedIds:i,onChange:r,label:c="Link to Quality Standards"}){return e.jsxs("div",{style:{marginTop:"1rem"},children:[e.jsxs("label",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("span",{children:c}),i.length>0&&e.jsx("button",{type:"button",onClick:()=>r([]),style:{fontSize:"0.8rem",color:"#dc2626",background:"none",border:"none",cursor:"pointer"},children:"Clear"})]}),e.jsx("div",{style:{maxHeight:"200px",overflowY:"auto",border:"1px solid #e2e8f0",borderRadius:"8px",padding:"0.5rem"},children:l.map(n=>{const m=i.includes(n.id);return e.jsxs("div",{onClick:()=>r(m?i.filter(f=>f!==n.id):[...i,n.id]),style:{display:"flex",alignItems:"flex-start",gap:"0.75rem",padding:"0.75rem",marginBottom:"0.5rem",backgroundColor:m?"#f3e8ff":"#f8fafc",border:m?"2px solid #8b5cf6":"1px solid #e2e8f0",borderRadius:"8px",cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:m,onChange:()=>{},style:{marginTop:"3px"}}),e.jsxs("div",{children:[e.jsx("span",{style:{backgroundColor:"#8b5cf6",color:"white",padding:"0.125rem 0.375rem",borderRadius:"4px",fontSize:"0.75rem",fontWeight:"700"},children:n.qs_ref})," ",e.jsx("span",{style:{fontWeight:"600"},children:n.name})]})]},n.id)})}),e.jsxs("div",{style:{marginTop:"0.5rem",fontSize:"0.85rem",color:"#64748b"},children:[i.length," selected"]})]})}function js(){const{user:l,role:i}=he(),{projectId:r}=Ee(),{showSuccess:c,showError:n,showWarning:m}=Te(),{showTestUsers:f}=Ie(),w=l?.id||null,{canEditDeliverable:Z,canReviewDeliverable:V,canDeleteDeliverable:Y}=xe(),{refreshMetrics:v}=ze(),[P,y]=h.useState([]),[b,D]=h.useState([]),[o,g]=h.useState([]),[_,M]=h.useState([]),[x,O]=h.useState(!0),[L,E]=h.useState(!1),[R,T]=h.useState(!1),[A,q]=h.useState(!1),[p,F]=h.useState(null),[N,S]=h.useState({}),[I,H]=h.useState({}),[X,B]=h.useState(""),[U,ee]=h.useState(""),[K,ae]=h.useState(!1),[z,W]=h.useState({isOpen:!1,deliverable:null}),[u,k]=h.useState({deliverable_ref:"",name:"",description:"",milestone_id:"",status:"Not Started",progress:0,kpi_ids:[],qs_ids:[]}),a=h.useCallback(async()=>{if(r){O(!0);try{const s=await Oe.getAll(r,{orderBy:{column:"milestone_ref",ascending:!0}});D(s);const t=await Le.getAll(r,{orderBy:{column:"kpi_ref",ascending:!0}});g(t);const d=await qe.getAll(r,{orderBy:{column:"qs_ref",ascending:!0}});M(d);const $=await j.getAllWithRelations(r,f);y($||[])}catch{n("Failed to load deliverables")}finally{O(!1),E(!1)}}},[r,f,n]);h.useEffect(()=>{a()},[a]);async function Q(){E(!0),await a()}async function G(s){s.preventDefault();try{const t=await j.create({project_id:r,deliverable_ref:u.deliverable_ref,name:u.name,description:u.description,milestone_id:u.milestone_id||null,status:u.status,progress:parseInt(u.progress)||0,created_by:w});await j.syncKPILinks(t.id,u.kpi_ids),await j.syncQSLinks(t.id,u.qs_ids),k({deliverable_ref:"",name:"",description:"",milestone_id:"",status:"Not Started",progress:0,kpi_ids:[],qs_ids:[]}),T(!1),a(),v(),c("Deliverable added!")}catch(t){n("Failed: "+t.message)}}async function ye(s,t){try{await j.update(s,{name:t.name,description:t.description,milestone_id:t.milestone_id||null,status:t.status,progress:parseInt(t.progress)||0}),t.kpi_ids&&await j.syncKPILinks(s,t.kpi_ids),t.qs_ids&&await j.syncQSLinks(s,t.qs_ids),a(),v(),c("Deliverable updated!")}catch(d){n("Failed: "+d.message)}}async function ke(s,t){try{let d=s.progress;t==="Not Started"?d=0:["Submitted for Review","Review Complete","Delivered"].includes(t)?d=100:t==="Returned for More Work"&&(d=50),await j.update(s.id,{status:t,progress:d}),a(),v(),c(`Status changed to ${t}`)}catch(d){n("Failed: "+d.message)}}function Ce(s){F(s),S({}),H({}),q(!0)}async function we(){if(!p)return;const s=p.deliverable_kpis||[],t=p.deliverable_quality_standards||[];if(s.length>0&&!s.every(d=>N[d.kpi_id]!==void 0)){m("Please assess all linked KPIs.");return}if(t.length>0&&!t.every(d=>I[d.quality_standard_id]!==void 0)){m("Please assess all linked Quality Standards.");return}try{if(await j.update(p.id,{status:"Delivered",progress:100}),s.length>0){const d=s.map($=>({kpiId:$.kpi_id,criteriaMet:N[$.kpi_id]}));await j.upsertKPIAssessments(p.id,d,w)}if(t.length>0){const d=t.map($=>({qsId:$.quality_standard_id,criteriaMet:I[$.quality_standard_id]}));await j.upsertQSAssessments(p.id,d,w)}c("Deliverable marked as delivered!"),q(!1),a()}catch(d){n("Failed: "+d.message)}}async function De(s){if(confirm("Delete this deliverable?"))try{await j.delete(s,w),a(),c("Deleted")}catch(t){n("Failed: "+t.message)}}async function Re(s,t){try{const d=l?.user_metadata?.name||l?.email||"Unknown User";await j.signDeliverable(s,t,w,d),a(),v(),c(`Signed as ${t==="supplier"?"Supplier PM":"Customer PM"}`)}catch(d){n("Failed to sign: "+d.message)}}function Ae(s){W({isOpen:!0,deliverable:s})}let C=P;X&&(C=C.filter(s=>s.milestone_id===X)),U&&(C=C.filter(s=>s.status===U)),K&&(C=C.filter(s=>s.status==="Submitted for Review"));const ce=P.filter(s=>s.status==="Submitted for Review").length,oe=Z,Pe=V,Me=Y;return x?e.jsx(Fe,{message:"Loading deliverables...",size:"large",fullPage:!0}):e.jsxs("div",{className:"deliverables-page",children:[e.jsx("header",{className:"del-header",children:e.jsxs("div",{className:"del-header-content",children:[e.jsxs("div",{className:"del-header-left",children:[e.jsx("div",{className:"del-header-icon",children:e.jsx(ve,{size:24})}),e.jsxs("div",{children:[e.jsx("h1",{children:"Deliverables"}),e.jsx("p",{children:"Track project deliverables with review workflow"})]})]}),e.jsxs("div",{className:"del-header-actions",children:[e.jsxs("button",{className:"del-btn del-btn-secondary",onClick:Q,disabled:L,children:[e.jsx(is,{size:18,className:L?"spinning":""})," Refresh"]}),oe&&e.jsxs("button",{className:"del-btn del-btn-primary",onClick:()=>T(!R),children:[e.jsx(as,{size:18})," Add Deliverable"]})]})]})}),e.jsxs("div",{className:"del-content",children:[e.jsxs("div",{className:"del-filters",children:[e.jsxs("select",{value:X,onChange:s=>B(s.target.value),className:"del-filter-select",children:[e.jsx("option",{value:"",children:"All Milestones"}),b.map(s=>e.jsxs("option",{value:s.id,children:[s.milestone_ref," - ",s.name]},s.id))]}),e.jsxs("select",{value:U,onChange:s=>ee(s.target.value),className:"del-filter-select",children:[e.jsx("option",{value:"",children:"All Statuses"}),cs.map(s=>e.jsx("option",{value:s,children:s},s))]}),ce>0&&e.jsxs("button",{onClick:()=>{ae(!K),K||(B(""),ee(""))},className:`del-filter-badge ${K?"active":""}`,children:[e.jsx(de,{size:16})," ",ce," Awaiting Review"]})]}),R&&e.jsxs("div",{className:"del-add-form",children:[e.jsx("h3",{className:"del-add-form-title",children:"Add New Deliverable"}),e.jsxs("form",{onSubmit:G,children:[e.jsxs("div",{className:"del-form-row",children:[e.jsxs("div",{className:"del-form-group",children:[e.jsx("label",{children:"Ref *"}),e.jsx("input",{type:"text",value:u.deliverable_ref,onChange:s=>k({...u,deliverable_ref:s.target.value}),required:!0})]}),e.jsxs("div",{className:"del-form-group",style:{flex:2},children:[e.jsx("label",{children:"Name *"}),e.jsx("input",{type:"text",value:u.name,onChange:s=>k({...u,name:s.target.value}),required:!0})]})]}),e.jsxs("div",{className:"del-form-group",children:[e.jsx("label",{children:"Description"}),e.jsx("textarea",{value:u.description,onChange:s=>k({...u,description:s.target.value})})]}),e.jsxs("div",{className:"del-form-row",children:[e.jsxs("div",{className:"del-form-group",children:[e.jsx("label",{children:"Milestone *"}),e.jsxs("select",{value:u.milestone_id,onChange:s=>k({...u,milestone_id:s.target.value}),required:!0,children:[e.jsx("option",{value:"",children:"Select"}),b.map(s=>e.jsx("option",{value:s.id,children:s.milestone_ref},s.id))]})]}),e.jsxs("div",{className:"del-form-group",children:[e.jsx("label",{children:"Due Date"}),e.jsx("div",{className:"del-form-readonly",children:(()=>{const s=b.find(t=>t.id===u.milestone_id);return s?.forecast_end_date?new Date(s.forecast_end_date).toLocaleDateString("en-GB"):"Select milestone"})()})]})]}),e.jsx(os,{kpis:o,selectedIds:u.kpi_ids,onChange:s=>k({...u,kpi_ids:s})}),e.jsx(ms,{qualityStandards:_,selectedIds:u.qs_ids,onChange:s=>k({...u,qs_ids:s})}),e.jsxs("div",{className:"del-form-actions",children:[e.jsxs("button",{type:"submit",className:"del-btn del-btn-primary",children:[e.jsx(Ne,{size:16})," Save"]}),e.jsxs("button",{type:"button",className:"del-btn del-btn-secondary",onClick:()=>T(!1),children:[e.jsx(be,{size:16})," Cancel"]})]})]})]}),e.jsxs("div",{className:"del-table-card",children:[e.jsxs("div",{className:"del-table-header",children:[e.jsx("h2",{className:"del-table-title",children:"Project Deliverables"}),e.jsxs("span",{className:"del-table-count",children:[C.length," deliverable",C.length!==1?"s":""]})]}),e.jsxs("table",{className:"del-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Ref"}),e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Milestone"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Progress"})]})}),e.jsx("tbody",{children:C.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"del-empty-cell",children:"No deliverables found"})}):C.map(s=>{const t=pe[s.status]||pe["Not Started"],d=t.icon;return e.jsxs("tr",{onClick:()=>Ae(s),children:[e.jsx("td",{children:e.jsx("span",{className:"del-ref",children:s.deliverable_ref})}),e.jsx("td",{children:e.jsx("span",{className:"del-name",children:s.name})}),e.jsx("td",{children:s.milestones?e.jsx("span",{className:"del-milestone-link",children:s.milestones.milestone_ref}):"—"}),e.jsx("td",{children:e.jsxs("span",{className:"del-status-badge",style:{backgroundColor:t.bg,color:t.color},children:[e.jsx(d,{size:14}),s.status]})}),e.jsx("td",{children:e.jsxs("div",{className:"del-progress",children:[e.jsx("div",{className:"del-progress-bar",children:e.jsx("div",{className:"del-progress-fill",style:{width:`${s.progress||0}%`,backgroundColor:s.status==="Delivered"?"#16a34a":"#4f46e5"}})}),e.jsxs("span",{className:"del-progress-text",children:[s.progress||0,"%"]})]})})]},s.id)})})]})]})]}),e.jsx(ds,{isOpen:z.isOpen,deliverable:z.deliverable,milestones:b,kpis:o,qualityStandards:_,canEdit:oe,canReview:Pe,canDelete:Me,onClose:()=>W({isOpen:!1,deliverable:null}),onSave:ye,onStatusChange:ke,onDelete:De,onOpenCompletion:Ce,onSign:Re}),A&&p&&e.jsx("div",{className:"modal-overlay",children:e.jsxs("div",{className:"modal modal-lg",children:[e.jsx("div",{className:"modal-header",children:e.jsxs("h3",{className:"modal-title",children:[e.jsx(ie,{size:20,style:{color:"var(--color-success)"}})," Mark as Delivered"]})}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("p",{style:{color:"var(--color-text-secondary)",marginBottom:"var(--space-lg)"},children:[p.deliverable_ref," - ",p.name]}),p.deliverable_kpis?.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{padding:"var(--space-md)",backgroundColor:"var(--color-warning-light)",borderLeft:"4px solid var(--color-warning)",borderRadius:"var(--radius)",marginBottom:"var(--space-md)"},children:e.jsx("strong",{style:{color:"#92400e"},children:"KPI Assessment Required"})}),p.deliverable_kpis.map(s=>{const t=o.find(d=>d.id===s.kpi_id);return t?e.jsxs("div",{style:{padding:"var(--space-md)",border:"1px solid var(--color-border)",borderRadius:"var(--radius)",marginBottom:"var(--space-sm)",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsx("span",{className:"badge badge-info",children:t.kpi_ref})," ",e.jsx("strong",{style:{marginLeft:"var(--space-sm)"},children:t.name})]}),e.jsxs("div",{style:{display:"flex",gap:"var(--space-sm)"},children:[e.jsx("button",{onClick:()=>S({...N,[s.kpi_id]:!0}),className:`btn btn-sm ${N[s.kpi_id]===!0?"btn-success":"btn-secondary"}`,children:"✓ Yes"}),e.jsx("button",{onClick:()=>S({...N,[s.kpi_id]:!1}),className:`btn btn-sm ${N[s.kpi_id]===!1?"btn-danger":"btn-secondary"}`,children:"✗ No"})]})]},s.kpi_id):null})]}),p.deliverable_quality_standards?.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{padding:"var(--space-md)",backgroundColor:"var(--color-purple-light)",borderLeft:"4px solid var(--color-purple)",borderRadius:"var(--radius)",marginBottom:"var(--space-md)",marginTop:"var(--space-lg)"},children:e.jsx("strong",{style:{color:"#6b21a8"},children:"Quality Standards Assessment"})}),p.deliverable_quality_standards.map(s=>{const t=_.find(d=>d.id===s.quality_standard_id);return t?e.jsxs("div",{style:{padding:"var(--space-md)",border:"1px solid var(--color-border)",borderRadius:"var(--radius)",marginBottom:"var(--space-sm)",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsx("span",{className:"badge badge-purple",children:t.qs_ref})," ",e.jsx("strong",{style:{marginLeft:"var(--space-sm)"},children:t.name})]}),e.jsxs("div",{style:{display:"flex",gap:"var(--space-sm)"},children:[e.jsx("button",{onClick:()=>H({...I,[s.quality_standard_id]:!0}),className:`btn btn-sm ${I[s.quality_standard_id]===!0?"btn-success":"btn-secondary"}`,children:"✓ Yes"}),e.jsx("button",{onClick:()=>H({...I,[s.quality_standard_id]:!1}),className:`btn btn-sm ${I[s.quality_standard_id]===!1?"btn-danger":"btn-secondary"}`,children:"✗ No"})]})]},s.quality_standard_id):null})]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>q(!1),children:"Cancel"}),e.jsxs("button",{className:"btn btn-success",onClick:we,children:[e.jsx(ie,{size:16})," Mark Delivered"]})]})]})})]})}export{js as default};
