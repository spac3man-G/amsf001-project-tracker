import{u as me,c as ue,j as e,a as Pe,b as Me,e as Te,f as Ee,m as Ie,k as ze,q as qe,d as j,L as Oe}from"./index-BusnPVJF.js";import{r as o,L as Le}from"./vendor-react-B1g8b4mG.js";import{i as pe,b as Fe,c as he,d as fe,e as te,g as Ue,h as Be,D as J,j as We,k as Ke,f as de,l as Qe,S as ie,m as ce,n as $e}from"./deliverableCalculations-BIJkD8fM.js";import{S as Ge,D as Ve}from"./SignatureBox-BxsknfMt.js";import{P as xe,a as ge,F as Ye,a2 as He,l as se,i as Xe,h as Je,a6 as Ze,T as es,a9 as je,e as ne,Q as ve,a0 as be,C as ae,a8 as ss,R as as,a7 as is,Y as ts}from"./vendor-icons-D-7N55ks.js";import"./vendor-supabase-DSZ6Ejbd.js";function ns(n=null){const{user:a,role:l,profile:g}=me(),{canCreateDeliverable:d,canEditDeliverable:p,canDeleteDeliverable:S,canReviewDeliverable:D,canSubmitDeliverable:Z,canSignAsSupplier:$,canSignAsCustomer:G}=ue(),v=l==="admin",P=l==="supplier_pm",C=l==="customer_pm",b=l==="contributor",R=a?.id||null,m=g?.full_name||a?.email||"Unknown",N=n?pe(n):!1,y=n?Fe(n):!0,M=!0,h=d,I=N||!y?!1:!!(v||P||b&&n?.assigned_to===m),z=N?!1:S,T=!n||!he(n)?!1:!!(v||P||b&&n?.assigned_to===m),A=!n||!fe(n)?!1:D,k=A,V=A,_=!n||!te(n)?!1:v||C,u=!$||!n?!1:Ue(n),q=!G||!n?!1:Be(n),f=n?n.supplier_pm_signed_at&&n.customer_pm_signed_at:!1,O=!n||!te(n)?!1:v||C;return{currentUserId:R,currentUserName:m,userRole:l,isAdmin:v,isSupplierPM:P,isCustomerPM:C,isContributor:b,canView:M,canCreate:h,canEdit:I,canDelete:z,canSubmit:T,canSubmitForReview:T,canReview:A,canAcceptReview:k,canRejectReview:V,canInitiateSignOff:_,canSignAsSupplier:u,canSignAsCustomer:q,isFullySigned:f,canAssessKPIsAndQS:O,isComplete:N,isEditable:y}}function rs({isOpen:n,deliverable:a,milestones:l,kpis:g,qualityStandards:d,canEdit:p,canReview:S,canDelete:D,onClose:Z,onSave:$,onStatusChange:G,onDelete:v,onOpenCompletion:P,onSign:C}){const[b,R]=o.useState(!1),[m,N]=o.useState({}),[y,M]=o.useState(!1),h=ns(a),I=h.isSupplierPM||h.isAdmin,z=h.isSupplierPM||h.isAdmin,T=h.isSupplierPM||h.isAdmin||h.isContributor,A=h.isSupplierPM||h.isAdmin||h.isContributor;if(o.useEffect(()=>{a&&(N({name:a.name||"",description:a.description||"",milestone_id:a.milestone_id||"",status:a.status||J.NOT_STARTED,progress:a.progress||0,kpi_ids:a.deliverable_kpis?.map(i=>i.kpi_id)||[],qs_ids:a.deliverable_quality_standards?.map(i=>i.quality_standard_id)||[]}),R(!1))},[a]),!n||!a)return null;const k=We(a.status),V=k.icon,_=l?.find(i=>i.id===a.milestone_id),u=a.deliverable_kpis||[],q=a.deliverable_quality_standards||[],f=pe(a),O=p&&he(a),E=S&&fe(a),Y=S&&te(a),L=Ke(a),B=a.supplier_pm_signed_at||a.customer_pm_signed_at,H=a.status===J.REVIEW_COMPLETE||B||f,X=_?.forecast_end_date||_?.end_date;async function W(){M(!0);try{await $(a.id,m),R(!1)}finally{M(!1)}}function F(){R(!1),Z()}function K(i){G(a,i),F()}function ee(i){const x={progress:i},Q=$e(m.status,i);Q&&(x.status=Q),N({...m,...x})}async function c(i){if(C){M(!0);try{await C(a.id,i)}finally{M(!1)}}}return e.jsx("div",{className:"deliverable-modal-overlay",onClick:F,children:e.jsxs("div",{className:"deliverable-modal",onClick:i=>i.stopPropagation(),children:[e.jsxs("div",{className:"deliverable-modal-header",children:[e.jsxs("div",{className:"deliverable-modal-header-left",children:[e.jsx("div",{className:"deliverable-modal-icon",style:{backgroundColor:k.bg,color:k.color},children:e.jsx(xe,{size:20})}),e.jsxs("div",{className:"deliverable-modal-titles",children:[e.jsx("h2",{children:a.deliverable_ref}),e.jsx("span",{className:"subtitle",children:a.name})]})]}),e.jsxs("div",{className:"deliverable-modal-header-right",children:[e.jsxs("span",{className:"status-badge",style:{backgroundColor:k.bg,color:k.color},children:[e.jsx(V,{size:14}),a.status]}),e.jsx("button",{className:"close-button",onClick:F,children:e.jsx(ge,{size:24})})]})]}),e.jsx("div",{className:"deliverable-modal-content",children:b?e.jsxs("div",{className:"deliverable-edit-form",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Name *"}),e.jsx("input",{type:"text",className:"form-input",value:m.name,onChange:i=>N({...m,name:i.target.value}),disabled:!I}),!I&&e.jsx("span",{className:"hint",children:"Only Supplier PM can edit name"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Description"}),e.jsx("textarea",{className:"form-input",rows:3,value:m.description,onChange:i=>N({...m,description:i.target.value}),disabled:!T}),!T&&e.jsx("span",{className:"hint",children:"Only Supplier PM or Contributor can edit description"})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Milestone"}),e.jsxs("select",{className:"form-input",value:m.milestone_id,onChange:i=>N({...m,milestone_id:i.target.value}),disabled:!z,children:[e.jsx("option",{value:"",children:"-- Select milestone --"}),l?.map(i=>e.jsxs("option",{value:i.id,children:[i.milestone_ref," - ",i.name]},i.id))]}),!z&&e.jsx("span",{className:"hint",children:"Only Supplier PM can edit milestone"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Due Date"}),e.jsx("div",{className:"form-input readonly",children:(()=>{const i=l?.find(Q=>Q.id===m.milestone_id),x=i?.forecast_end_date||i?.end_date;return x?de(x):"Set by milestone"})()}),e.jsx("span",{className:"hint",children:"Derived from milestone forecast date"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{children:["Progress: ",m.progress,"%"]}),e.jsx("div",{className:"progress-slider",children:e.jsx("input",{type:"range",min:"0",max:"100",value:m.progress,onChange:i=>ee(parseInt(i.target.value)),disabled:!A||Qe(m.status)})}),!A&&e.jsx("span",{className:"hint",children:"Only Supplier PM or Contributor can edit progress"})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"deliverable-key-details",children:[e.jsxs("div",{className:"detail-item",children:[e.jsx(Ye,{size:18,className:"detail-item-icon"}),e.jsxs("div",{className:"detail-item-content",children:[e.jsx("div",{className:"detail-item-label",children:"Milestone"}),e.jsx("div",{className:"detail-item-value",children:_?e.jsxs(Le,{to:`/milestones/${_.id}`,children:[_.milestone_ref," - ",_.name]}):"Not assigned"})]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx(He,{size:18,className:"detail-item-icon"}),e.jsxs("div",{className:"detail-item-content",children:[e.jsx("div",{className:"detail-item-label",children:"Due Date"}),e.jsx("div",{className:"detail-item-value",children:X?de(X):"Not set"})]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx(se,{size:18,className:"detail-item-icon"}),e.jsxs("div",{className:"detail-item-content",children:[e.jsx("div",{className:"detail-item-label",children:"Progress"}),e.jsxs("div",{className:"progress-display",children:[e.jsx("div",{className:"progress-bar",children:e.jsx("div",{className:`progress-bar-fill ${f?"complete":"in-progress"}`,style:{width:`${a.progress||0}%`}})}),e.jsxs("span",{className:"progress-value",children:[a.progress||0,"%"]})]})]})]})]}),e.jsxs("div",{className:"deliverable-description",children:[e.jsx("div",{className:"section-label",children:"Description"}),e.jsx("div",{className:`description-text ${a.description?"":"empty"}`,children:a.description||"No description provided"})]}),u.length>0&&e.jsxs("div",{className:"linked-items-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsx(Xe,{size:14}),"Linked KPIs (",u.length,")"]}),e.jsx("div",{className:"linked-items-list",children:u.map(i=>e.jsxs("span",{className:"linked-item-badge kpi",children:[i.kpis?.kpi_ref||"KPI"," - ",i.kpis?.name||"Unknown"]},i.kpi_id))})]}),q.length>0&&e.jsxs("div",{className:"linked-items-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsx(Je,{size:14}),"Linked Quality Standards (",q.length,")"]}),e.jsx("div",{className:"linked-items-list",children:q.map(i=>e.jsxs("span",{className:"linked-item-badge quality-standard",children:[i.quality_standards?.qs_ref||"QS"," - ",i.quality_standards?.name||"Unknown"]},i.quality_standard_id))})]}),H&&e.jsxs("div",{className:"sign-off-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsx(Ze,{size:14}),"Delivery Sign-off"]}),f&&L===ie.SIGNED?e.jsx(Ge,{message:"Deliverable accepted and delivered"}):e.jsx(Ve,{supplier:{signedBy:a.supplier_pm_name,signedAt:a.supplier_pm_signed_at,canSign:h.canSignAsSupplier&&C,onSign:()=>c("supplier")},customer:{signedBy:a.customer_pm_name,signedAt:a.customer_pm_signed_at,canSign:h.canSignAsCustomer&&C,onSign:()=>c("customer")},saving:y,supplierButtonText:"Sign as Supplier PM",customerButtonText:"Sign as Customer PM"}),!f&&B&&e.jsxs("div",{className:"sign-off-status-indicator",children:[L===ie.AWAITING_CUSTOMER&&e.jsx("span",{className:"awaiting-badge customer",children:"Awaiting Customer PM signature"}),L===ie.AWAITING_SUPPLIER&&e.jsx("span",{className:"awaiting-badge supplier",children:"Awaiting Supplier PM signature"})]})]}),e.jsxs("div",{className:"deliverable-timestamps",children:[e.jsxs("div",{className:"timestamp-item",children:[e.jsx(se,{size:14}),"Created: ",a.created_at?ce(a.created_at):"Unknown"]}),a.updated_at&&a.updated_at!==a.created_at&&e.jsxs("div",{className:"timestamp-item",children:[e.jsx(se,{size:14}),"Updated: ",ce(a.updated_at)]})]})]})}),e.jsxs("div",{className:"deliverable-modal-footer",children:[e.jsx("div",{className:"footer-left",children:D&&!b&&!f&&e.jsxs("button",{className:"btn btn-danger",onClick:()=>{v(a.id),F()},children:[e.jsx(es,{size:16})," Delete"]})}),e.jsx("div",{className:"footer-right",children:b?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>R(!1),disabled:y,children:"Cancel"}),e.jsxs("button",{className:"btn btn-primary",onClick:W,disabled:y,children:[e.jsx(je,{size:16})," ",y?"Saving...":"Save Changes"]})]}):e.jsxs(e.Fragment,{children:[O&&e.jsxs("button",{className:"btn btn-secondary",onClick:()=>K(J.SUBMITTED_FOR_REVIEW),children:[e.jsx(ne,{size:16})," Submit for Review"]}),E&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"btn btn-danger",onClick:()=>K(J.RETURNED_FOR_MORE_WORK),children:[e.jsx(ve,{size:16})," Return for More Work"]}),e.jsxs("button",{className:"btn btn-success",onClick:()=>K(J.REVIEW_COMPLETE),children:[e.jsx(be,{size:16})," Accept Review"]})]}),Y&&!B&&e.jsxs("button",{className:"btn btn-success",onClick:()=>{P(a),F()},children:[e.jsx(ae,{size:16})," Assess & Sign Off"]}),p&&!f&&e.jsxs("button",{className:"btn btn-primary",onClick:()=>R(!0),children:[e.jsx(ss,{size:16})," Edit"]})]})})]})]})})}const ls=["Not Started","In Progress","Submitted for Review","Returned for More Work","Review Complete","Delivered"],oe={Delivered:{bg:"#dcfce7",color:"#16a34a",icon:ae},"Review Complete":{bg:"#dbeafe",color:"#2563eb",icon:be},"Submitted for Review":{bg:"#fef3c7",color:"#d97706",icon:ne},"In Progress":{bg:"#e0e7ff",color:"#4f46e5",icon:se},"Returned for More Work":{bg:"#fee2e2",color:"#dc2626",icon:ve},"Not Started":{bg:"#f1f5f9",color:"#64748b",icon:ts}};function ds({kpis:n,selectedIds:a,onChange:l,label:g="Link to KPIs"}){return e.jsxs("div",{style:{marginTop:"1rem"},children:[e.jsxs("label",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("span",{children:g}),a.length>0&&e.jsx("button",{type:"button",onClick:()=>l([]),style:{fontSize:"0.8rem",color:"#dc2626",background:"none",border:"none",cursor:"pointer"},children:"Clear"})]}),e.jsx("div",{style:{maxHeight:"200px",overflowY:"auto",border:"1px solid #e2e8f0",borderRadius:"8px",padding:"0.5rem"},children:n.map(d=>{const p=a.includes(d.id);return e.jsxs("div",{onClick:()=>l(p?a.filter(S=>S!==d.id):[...a,d.id]),style:{display:"flex",alignItems:"flex-start",gap:"0.75rem",padding:"0.75rem",marginBottom:"0.5rem",backgroundColor:p?"#dbeafe":"#f8fafc",border:p?"2px solid #3b82f6":"1px solid #e2e8f0",borderRadius:"8px",cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:p,onChange:()=>{},style:{marginTop:"3px"}}),e.jsxs("div",{children:[e.jsx("span",{style:{backgroundColor:"#3b82f6",color:"white",padding:"0.125rem 0.375rem",borderRadius:"4px",fontSize:"0.75rem",fontWeight:"700"},children:d.kpi_ref})," ",e.jsx("span",{style:{fontWeight:"600"},children:d.name})]})]},d.id)})}),e.jsxs("div",{style:{marginTop:"0.5rem",fontSize:"0.85rem",color:"#64748b"},children:[a.length," selected"]})]})}function cs({qualityStandards:n,selectedIds:a,onChange:l,label:g="Link to Quality Standards"}){return e.jsxs("div",{style:{marginTop:"1rem"},children:[e.jsxs("label",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("span",{children:g}),a.length>0&&e.jsx("button",{type:"button",onClick:()=>l([]),style:{fontSize:"0.8rem",color:"#dc2626",background:"none",border:"none",cursor:"pointer"},children:"Clear"})]}),e.jsx("div",{style:{maxHeight:"200px",overflowY:"auto",border:"1px solid #e2e8f0",borderRadius:"8px",padding:"0.5rem"},children:n.map(d=>{const p=a.includes(d.id);return e.jsxs("div",{onClick:()=>l(p?a.filter(S=>S!==d.id):[...a,d.id]),style:{display:"flex",alignItems:"flex-start",gap:"0.75rem",padding:"0.75rem",marginBottom:"0.5rem",backgroundColor:p?"#f3e8ff":"#f8fafc",border:p?"2px solid #8b5cf6":"1px solid #e2e8f0",borderRadius:"8px",cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:p,onChange:()=>{},style:{marginTop:"3px"}}),e.jsxs("div",{children:[e.jsx("span",{style:{backgroundColor:"#8b5cf6",color:"white",padding:"0.125rem 0.375rem",borderRadius:"4px",fontSize:"0.75rem",fontWeight:"700"},children:d.qs_ref})," ",e.jsx("span",{style:{fontWeight:"600"},children:d.name})]})]},d.id)})}),e.jsxs("div",{style:{marginTop:"0.5rem",fontSize:"0.85rem",color:"#64748b"},children:[a.length," selected"]})]})}function xs(){const{user:n,role:a}=me(),{projectId:l}=Pe(),{showSuccess:g,showError:d,showWarning:p}=Me(),{showTestUsers:S}=Te(),D=n?.id||null,{canEditDeliverable:Z,canReviewDeliverable:$,canDeleteDeliverable:G}=ue(),{refreshMetrics:v}=Ee(),[P,C]=o.useState([]),[b,R]=o.useState([]),[m,N]=o.useState([]),[y,M]=o.useState([]),[h,I]=o.useState(!0),[z,T]=o.useState(!1),[A,k]=o.useState(!1),[V,_]=o.useState(!1),[u,q]=o.useState(null),[f,O]=o.useState({}),[E,Y]=o.useState({}),[L,B]=o.useState(""),[H,X]=o.useState(""),[W,F]=o.useState(!1),[K,ee]=o.useState({isOpen:!1,deliverable:null}),[c,i]=o.useState({deliverable_ref:"",name:"",description:"",milestone_id:"",status:"Not Started",progress:0,kpi_ids:[],qs_ids:[]}),x=o.useCallback(async()=>{if(l){I(!0);try{const s=await Ie.getAll(l,{orderBy:{column:"milestone_ref",ascending:!0}});R(s);const t=await ze.getAll(l,{orderBy:{column:"kpi_ref",ascending:!0}});N(t);const r=await qe.getAll(l,{orderBy:{column:"qs_ref",ascending:!0}});M(r);const U=await j.getAllWithRelations(l,S);C(U||[])}catch{d("Failed to load deliverables")}finally{I(!1),T(!1)}}},[l,S,d]);o.useEffect(()=>{x()},[x]);async function Q(){T(!0),await x()}async function _e(s){s.preventDefault();try{const t=await j.create({project_id:l,deliverable_ref:c.deliverable_ref,name:c.name,description:c.description,milestone_id:c.milestone_id||null,status:c.status,progress:parseInt(c.progress)||0,created_by:D});await j.syncKPILinks(t.id,c.kpi_ids),await j.syncQSLinks(t.id,c.qs_ids),i({deliverable_ref:"",name:"",description:"",milestone_id:"",status:"Not Started",progress:0,kpi_ids:[],qs_ids:[]}),k(!1),x(),v(),g("Deliverable added!")}catch(t){d("Failed: "+t.message)}}async function Se(s,t){try{await j.update(s,{name:t.name,description:t.description,milestone_id:t.milestone_id||null,status:t.status,progress:parseInt(t.progress)||0}),t.kpi_ids&&await j.syncKPILinks(s,t.kpi_ids),t.qs_ids&&await j.syncQSLinks(s,t.qs_ids),x(),v(),g("Deliverable updated!")}catch(r){d("Failed: "+r.message)}}async function Ne(s,t){try{let r=s.progress;t==="Not Started"?r=0:["Submitted for Review","Review Complete","Delivered"].includes(t)?r=100:t==="Returned for More Work"&&(r=50),await j.update(s.id,{status:t,progress:r}),x(),v(),g(`Status changed to ${t}`)}catch(r){d("Failed: "+r.message)}}function ye(s){q(s),O({}),Y({}),_(!0)}async function ke(){if(!u)return;const s=u.deliverable_kpis||[],t=u.deliverable_quality_standards||[];if(s.length>0&&!s.every(r=>f[r.kpi_id]!==void 0)){p("Please assess all linked KPIs.");return}if(t.length>0&&!t.every(r=>E[r.quality_standard_id]!==void 0)){p("Please assess all linked Quality Standards.");return}try{if(await j.update(u.id,{status:"Delivered",progress:100}),s.length>0){const r=s.map(U=>({kpiId:U.kpi_id,criteriaMet:f[U.kpi_id]}));await j.upsertKPIAssessments(u.id,r,D)}if(t.length>0){const r=t.map(U=>({qsId:U.quality_standard_id,criteriaMet:E[U.quality_standard_id]}));await j.upsertQSAssessments(u.id,r,D)}g("Deliverable marked as delivered!"),_(!1),x()}catch(r){d("Failed: "+r.message)}}async function Ce(s){if(confirm("Delete this deliverable?"))try{await j.delete(s,D),x(),g("Deleted")}catch(t){d("Failed: "+t.message)}}async function we(s,t){try{const r=n?.user_metadata?.name||n?.email||"Unknown User";await j.signDeliverable(s,t,D,r),x(),v(),g(`Signed as ${t==="supplier"?"Supplier PM":"Customer PM"}`)}catch(r){d("Failed to sign: "+r.message)}}function De(s){ee({isOpen:!0,deliverable:s})}let w=P;L&&(w=w.filter(s=>s.milestone_id===L)),H&&(w=w.filter(s=>s.status===H)),W&&(w=w.filter(s=>s.status==="Submitted for Review"));const re=P.filter(s=>s.status==="Submitted for Review").length,le=Z,Re=$,Ae=G;return h?e.jsx(Oe,{message:"Loading deliverables...",size:"large",fullPage:!0}):e.jsxs("div",{className:"deliverables-page",children:[e.jsx("header",{className:"del-header",children:e.jsxs("div",{className:"del-header-content",children:[e.jsxs("div",{className:"del-header-left",children:[e.jsx("div",{className:"del-header-icon",children:e.jsx(xe,{size:24})}),e.jsxs("div",{children:[e.jsx("h1",{children:"Deliverables"}),e.jsx("p",{children:"Track project deliverables with review workflow"})]})]}),e.jsxs("div",{className:"del-header-actions",children:[e.jsxs("button",{className:"del-btn del-btn-secondary",onClick:Q,disabled:z,children:[e.jsx(as,{size:18,className:z?"spinning":""})," Refresh"]}),le&&e.jsxs("button",{className:"del-btn del-btn-primary",onClick:()=>k(!A),children:[e.jsx(is,{size:18})," Add Deliverable"]})]})]})}),e.jsxs("div",{className:"del-content",children:[e.jsxs("div",{className:"del-filters",children:[e.jsxs("select",{value:L,onChange:s=>B(s.target.value),className:"del-filter-select",children:[e.jsx("option",{value:"",children:"All Milestones"}),b.map(s=>e.jsxs("option",{value:s.id,children:[s.milestone_ref," - ",s.name]},s.id))]}),e.jsxs("select",{value:H,onChange:s=>X(s.target.value),className:"del-filter-select",children:[e.jsx("option",{value:"",children:"All Statuses"}),ls.map(s=>e.jsx("option",{value:s,children:s},s))]}),re>0&&e.jsxs("button",{onClick:()=>{F(!W),W||(B(""),X(""))},className:`del-filter-badge ${W?"active":""}`,children:[e.jsx(ne,{size:16})," ",re," Awaiting Review"]})]}),A&&e.jsxs("div",{className:"del-add-form",children:[e.jsx("h3",{className:"del-add-form-title",children:"Add New Deliverable"}),e.jsxs("form",{onSubmit:_e,children:[e.jsxs("div",{className:"del-form-row",children:[e.jsxs("div",{className:"del-form-group",children:[e.jsx("label",{children:"Ref *"}),e.jsx("input",{type:"text",value:c.deliverable_ref,onChange:s=>i({...c,deliverable_ref:s.target.value}),required:!0})]}),e.jsxs("div",{className:"del-form-group",style:{flex:2},children:[e.jsx("label",{children:"Name *"}),e.jsx("input",{type:"text",value:c.name,onChange:s=>i({...c,name:s.target.value}),required:!0})]})]}),e.jsxs("div",{className:"del-form-group",children:[e.jsx("label",{children:"Description"}),e.jsx("textarea",{value:c.description,onChange:s=>i({...c,description:s.target.value})})]}),e.jsxs("div",{className:"del-form-row",children:[e.jsxs("div",{className:"del-form-group",children:[e.jsx("label",{children:"Milestone *"}),e.jsxs("select",{value:c.milestone_id,onChange:s=>i({...c,milestone_id:s.target.value}),required:!0,children:[e.jsx("option",{value:"",children:"Select"}),b.map(s=>e.jsx("option",{value:s.id,children:s.milestone_ref},s.id))]})]}),e.jsxs("div",{className:"del-form-group",children:[e.jsx("label",{children:"Due Date"}),e.jsx("div",{className:"del-form-readonly",children:(()=>{const s=b.find(t=>t.id===c.milestone_id);return s?.forecast_end_date?new Date(s.forecast_end_date).toLocaleDateString("en-GB"):"Select milestone"})()})]})]}),e.jsx(ds,{kpis:m,selectedIds:c.kpi_ids,onChange:s=>i({...c,kpi_ids:s})}),e.jsx(cs,{qualityStandards:y,selectedIds:c.qs_ids,onChange:s=>i({...c,qs_ids:s})}),e.jsxs("div",{className:"del-form-actions",children:[e.jsxs("button",{type:"submit",className:"del-btn del-btn-primary",children:[e.jsx(je,{size:16})," Save"]}),e.jsxs("button",{type:"button",className:"del-btn del-btn-secondary",onClick:()=>k(!1),children:[e.jsx(ge,{size:16})," Cancel"]})]})]})]}),e.jsxs("div",{className:"del-table-card",children:[e.jsxs("div",{className:"del-table-header",children:[e.jsx("h2",{className:"del-table-title",children:"Project Deliverables"}),e.jsxs("span",{className:"del-table-count",children:[w.length," deliverable",w.length!==1?"s":""]})]}),e.jsxs("table",{className:"del-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Ref"}),e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Milestone"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Progress"})]})}),e.jsx("tbody",{children:w.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"del-empty-cell",children:"No deliverables found"})}):w.map(s=>{const t=oe[s.status]||oe["Not Started"],r=t.icon;return e.jsxs("tr",{onClick:()=>De(s),children:[e.jsx("td",{children:e.jsx("span",{className:"del-ref",children:s.deliverable_ref})}),e.jsx("td",{children:e.jsx("span",{className:"del-name",children:s.name})}),e.jsx("td",{children:s.milestones?e.jsx("span",{className:"del-milestone-link",children:s.milestones.milestone_ref}):"—"}),e.jsx("td",{children:e.jsxs("span",{className:"del-status-badge",style:{backgroundColor:t.bg,color:t.color},children:[e.jsx(r,{size:14}),s.status]})}),e.jsx("td",{children:e.jsxs("div",{className:"del-progress",children:[e.jsx("div",{className:"del-progress-bar",children:e.jsx("div",{className:"del-progress-fill",style:{width:`${s.progress||0}%`,backgroundColor:s.status==="Delivered"?"#16a34a":"#4f46e5"}})}),e.jsxs("span",{className:"del-progress-text",children:[s.progress||0,"%"]})]})})]},s.id)})})]})]})]}),e.jsx(rs,{isOpen:K.isOpen,deliverable:K.deliverable,milestones:b,kpis:m,qualityStandards:y,canEdit:le,canReview:Re,canDelete:Ae,onClose:()=>ee({isOpen:!1,deliverable:null}),onSave:Se,onStatusChange:Ne,onDelete:Ce,onOpenCompletion:ye,onSign:we}),V&&u&&e.jsx("div",{className:"modal-overlay",children:e.jsxs("div",{className:"modal modal-lg",children:[e.jsx("div",{className:"modal-header",children:e.jsxs("h3",{className:"modal-title",children:[e.jsx(ae,{size:20,style:{color:"var(--color-success)"}})," Mark as Delivered"]})}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("p",{style:{color:"var(--color-text-secondary)",marginBottom:"var(--space-lg)"},children:[u.deliverable_ref," - ",u.name]}),u.deliverable_kpis?.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{padding:"var(--space-md)",backgroundColor:"var(--color-warning-light)",borderLeft:"4px solid var(--color-warning)",borderRadius:"var(--radius)",marginBottom:"var(--space-md)"},children:e.jsx("strong",{style:{color:"#92400e"},children:"KPI Assessment Required"})}),u.deliverable_kpis.map(s=>{const t=m.find(r=>r.id===s.kpi_id);return t?e.jsxs("div",{style:{padding:"var(--space-md)",border:"1px solid var(--color-border)",borderRadius:"var(--radius)",marginBottom:"var(--space-sm)",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsx("span",{className:"badge badge-info",children:t.kpi_ref})," ",e.jsx("strong",{style:{marginLeft:"var(--space-sm)"},children:t.name})]}),e.jsxs("div",{style:{display:"flex",gap:"var(--space-sm)"},children:[e.jsx("button",{onClick:()=>O({...f,[s.kpi_id]:!0}),className:`btn btn-sm ${f[s.kpi_id]===!0?"btn-success":"btn-secondary"}`,children:"✓ Yes"}),e.jsx("button",{onClick:()=>O({...f,[s.kpi_id]:!1}),className:`btn btn-sm ${f[s.kpi_id]===!1?"btn-danger":"btn-secondary"}`,children:"✗ No"})]})]},s.kpi_id):null})]}),u.deliverable_quality_standards?.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{padding:"var(--space-md)",backgroundColor:"var(--color-purple-light)",borderLeft:"4px solid var(--color-purple)",borderRadius:"var(--radius)",marginBottom:"var(--space-md)",marginTop:"var(--space-lg)"},children:e.jsx("strong",{style:{color:"#6b21a8"},children:"Quality Standards Assessment"})}),u.deliverable_quality_standards.map(s=>{const t=y.find(r=>r.id===s.quality_standard_id);return t?e.jsxs("div",{style:{padding:"var(--space-md)",border:"1px solid var(--color-border)",borderRadius:"var(--radius)",marginBottom:"var(--space-sm)",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsx("span",{className:"badge badge-purple",children:t.qs_ref})," ",e.jsx("strong",{style:{marginLeft:"var(--space-sm)"},children:t.name})]}),e.jsxs("div",{style:{display:"flex",gap:"var(--space-sm)"},children:[e.jsx("button",{onClick:()=>Y({...E,[s.quality_standard_id]:!0}),className:`btn btn-sm ${E[s.quality_standard_id]===!0?"btn-success":"btn-secondary"}`,children:"✓ Yes"}),e.jsx("button",{onClick:()=>Y({...E,[s.quality_standard_id]:!1}),className:`btn btn-sm ${E[s.quality_standard_id]===!1?"btn-danger":"btn-secondary"}`,children:"✗ No"})]})]},s.quality_standard_id):null})]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>_(!1),children:"Cancel"}),e.jsxs("button",{className:"btn btn-success",onClick:ke,children:[e.jsx(ae,{size:16})," Mark Delivered"]})]})]})})]})}export{xs as default};
