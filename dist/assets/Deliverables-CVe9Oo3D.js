import{u as ue,c as pe,j as e,a as Re,b as Ee,e as Ae,f as Pe,m as Te,k as Me,q as Ie,d as v,L as Oe}from"./index-DgkPpMLd.js";import{r as h,L as ze}from"./vendor-react-B1g8b4mG.js";import{i as he,b as Le,c as xe,d as fe,e as te,g as Fe,h as qe,D as f,j as Ue,k as Be,f as ce,l as Ke,S as ie,m as oe,n as Qe,o as $e,p as me}from"./deliverableCalculations-CHC6RnqO.js";import{S as We,D as Ve}from"./SignatureBox-QhpN56ZH.js";import{P as je,a as ge,F as Ge,a2 as Ye,l as ae,i as ne,h as le,a6 as He,T as Xe,a9 as ve,e as Je,Q as Ze,a0 as es,C as ss,a8 as is,R as as,a7 as ts}from"./vendor-icons-BfsEacNp.js";import"./vendor-supabase-DSZ6Ejbd.js";function ns(l=null){const{user:i,role:r,profile:c}=ue(),{canCreateDeliverable:n,canEditDeliverable:m,canDeleteDeliverable:j,canReviewDeliverable:w,canSubmitDeliverable:Z,canSignAsSupplier:Y,canSignAsCustomer:H}=pe(),b=r==="admin",P=r==="supplier_pm",k=r==="customer_pm",N=r==="contributor",R=i?.id||null,o=c?.full_name||i?.email||"Unknown",g=l?he(l):!1,y=l?Le(l):!0,T=!0,x=n,L=g||!y?!1:!!(b||P||N&&l?.assigned_to===o),F=g?!1:j,M=!l||!xe(l)?!1:!!(b||P||N&&l?.assigned_to===o),E=!l||!fe(l)?!1:w,I=E,A=E,q=!l||!te(l)?!1:b||k,p=!Y||!l?!1:Fe(l),U=!H||!l?!1:qe(l),_=l?l.supplier_pm_signed_at&&l.customer_pm_signed_at:!1,S=!l||!te(l)?!1:b||k;return{currentUserId:R,currentUserName:o,userRole:r,isAdmin:b,isSupplierPM:P,isCustomerPM:k,isContributor:N,canView:T,canCreate:x,canEdit:L,canDelete:F,canSubmit:M,canSubmitForReview:M,canReview:E,canAcceptReview:I,canRejectReview:A,canInitiateSignOff:q,canSignAsSupplier:p,canSignAsCustomer:U,isFullySigned:_,canAssessKPIsAndQS:S,isComplete:g,isEditable:y}}function ls({kpis:l,selectedIds:i,onChange:r,disabled:c}){return!l||l.length===0?e.jsxs("div",{className:"linked-items-section edit-mode",children:[e.jsxs("div",{className:"section-header",children:[e.jsx(ne,{size:14}),"Link to KPIs"]}),e.jsx("div",{className:"no-items-message",children:"No KPIs available to link"})]}):e.jsxs("div",{className:"linked-items-section edit-mode",children:[e.jsxs("div",{className:"section-header",children:[e.jsx(ne,{size:14}),"Link to KPIs",i.length>0&&!c&&e.jsx("button",{type:"button",onClick:()=>r([]),className:"clear-button",children:"Clear all"})]}),e.jsx("div",{className:"selector-list",children:l.map(n=>{const m=i.includes(n.id);return e.jsxs("div",{onClick:()=>{c||r(m?i.filter(j=>j!==n.id):[...i,n.id])},className:`selector-item ${m?"selected":""} ${c?"disabled":""}`,children:[e.jsx("input",{type:"checkbox",checked:m,onChange:()=>{},disabled:c}),e.jsxs("div",{className:"selector-item-content",children:[e.jsx("span",{className:"item-badge kpi",children:n.kpi_ref}),e.jsx("span",{className:"item-name",children:n.name})]})]},n.id)})}),e.jsxs("div",{className:"selector-count",children:[i.length," selected"]}),c&&e.jsx("span",{className:"hint",children:"Only Supplier PM can edit KPI links"})]})}function rs({qualityStandards:l,selectedIds:i,onChange:r,disabled:c}){return!l||l.length===0?e.jsxs("div",{className:"linked-items-section edit-mode",children:[e.jsxs("div",{className:"section-header",children:[e.jsx(le,{size:14}),"Link to Quality Standards"]}),e.jsx("div",{className:"no-items-message",children:"No Quality Standards available to link"})]}):e.jsxs("div",{className:"linked-items-section edit-mode",children:[e.jsxs("div",{className:"section-header",children:[e.jsx(le,{size:14}),"Link to Quality Standards",i.length>0&&!c&&e.jsx("button",{type:"button",onClick:()=>r([]),className:"clear-button",children:"Clear all"})]}),e.jsx("div",{className:"selector-list",children:l.map(n=>{const m=i.includes(n.id);return e.jsxs("div",{onClick:()=>{c||r(m?i.filter(j=>j!==n.id):[...i,n.id])},className:`selector-item ${m?"selected":""} ${c?"disabled":""}`,children:[e.jsx("input",{type:"checkbox",checked:m,onChange:()=>{},disabled:c}),e.jsxs("div",{className:"selector-item-content",children:[e.jsx("span",{className:"item-badge quality-standard",children:n.qs_ref}),e.jsx("span",{className:"item-name",children:n.name})]})]},n.id)})}),e.jsxs("div",{className:"selector-count",children:[i.length," selected"]}),c&&e.jsx("span",{className:"hint",children:"Only Supplier PM can edit Quality Standard links"})]})}function ds({isOpen:l,deliverable:i,milestones:r,kpis:c,qualityStandards:n,canEdit:m,canReview:j,canDelete:w,onClose:Z,onSave:Y,onStatusChange:H,onDelete:b,onOpenCompletion:P,onSign:k}){const[N,R]=h.useState(!1),[o,g]=h.useState({}),[y,T]=h.useState(!1),x=ns(i),L=x.isSupplierPM||x.isAdmin,F=x.isSupplierPM||x.isAdmin,M=x.isSupplierPM||x.isAdmin||x.isContributor,E=x.isSupplierPM||x.isAdmin||x.isContributor,I=x.isSupplierPM||x.isAdmin;if(h.useEffect(()=>{i&&(g({name:i.name||"",description:i.description||"",milestone_id:i.milestone_id||"",status:i.status||f.NOT_STARTED,progress:i.progress||0,kpi_ids:i.deliverable_kpis?.map(a=>a.kpi_id)||[],qs_ids:i.deliverable_quality_standards?.map(a=>a.quality_standard_id)||[]}),R(!1))},[i]),!l||!i)return null;const A=Ue(i.status),q=A.icon,p=r?.find(a=>a.id===i.milestone_id),U=i.deliverable_kpis||[],_=i.deliverable_quality_standards||[],S=he(i),O=m&&xe(i),X=j&&fe(i),J=j&&te(i),W=Be(i),B=i.supplier_pm_signed_at||i.customer_pm_signed_at,ee=i.status===f.REVIEW_COMPLETE||B||S,K=p?.forecast_end_date||p?.end_date;async function se(){T(!0);try{await Y(i.id,o),R(!1)}finally{T(!1)}}function z(){R(!1),Z()}function V(a){H(i,a),z()}function u(a){const Q={progress:a},G=Qe(o.status,a);G&&(Q.status=G),g({...o,...Q})}async function C(a){if(k){T(!0);try{await k(i.id,a)}finally{T(!1)}}}return e.jsx("div",{className:"deliverable-modal-overlay",onClick:z,children:e.jsxs("div",{className:"deliverable-modal",onClick:a=>a.stopPropagation(),children:[e.jsxs("div",{className:"deliverable-modal-header",children:[e.jsxs("div",{className:"deliverable-modal-header-left",children:[e.jsx("div",{className:"deliverable-modal-icon",style:{backgroundColor:A.bg,color:A.color},children:e.jsx(je,{size:20})}),e.jsxs("div",{className:"deliverable-modal-titles",children:[e.jsx("h2",{children:i.deliverable_ref}),e.jsx("span",{className:"subtitle",children:i.name})]})]}),e.jsxs("div",{className:"deliverable-modal-header-right",children:[e.jsxs("span",{className:"status-badge",style:{backgroundColor:A.bg,color:A.color},children:[e.jsx(q,{size:14}),i.status]}),e.jsx("button",{className:"close-button",onClick:z,children:e.jsx(ge,{size:24})})]})]}),e.jsx("div",{className:"deliverable-modal-content",children:N?e.jsxs("div",{className:"deliverable-edit-form",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Name *"}),e.jsx("input",{type:"text",className:"form-input",value:o.name,onChange:a=>g({...o,name:a.target.value}),disabled:!L}),!L&&e.jsx("span",{className:"hint",children:"Only Supplier PM can edit name"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Description"}),e.jsx("textarea",{className:"form-input",rows:3,value:o.description,onChange:a=>g({...o,description:a.target.value}),disabled:!M}),!M&&e.jsx("span",{className:"hint",children:"Only Supplier PM or Contributor can edit description"})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Milestone"}),e.jsxs("select",{className:"form-input",value:o.milestone_id,onChange:a=>g({...o,milestone_id:a.target.value}),disabled:!F,children:[e.jsx("option",{value:"",children:"-- Select milestone --"}),r?.map(a=>e.jsxs("option",{value:a.id,children:[a.milestone_ref," - ",a.name]},a.id))]}),!F&&e.jsx("span",{className:"hint",children:"Only Supplier PM can edit milestone"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Due Date"}),e.jsx("div",{className:"form-input readonly",children:(()=>{const a=r?.find(G=>G.id===o.milestone_id),Q=a?.forecast_end_date||a?.end_date;return Q?ce(Q):"Set by milestone"})()}),e.jsx("span",{className:"hint",children:"Derived from milestone forecast date"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{children:["Progress: ",o.progress,"%"]}),e.jsx("div",{className:"progress-slider",children:e.jsx("input",{type:"range",min:"0",max:"100",value:o.progress,onChange:a=>u(parseInt(a.target.value)),disabled:!E||Ke(o.status)})}),!E&&e.jsx("span",{className:"hint",children:"Only Supplier PM or Contributor can edit progress"})]}),e.jsx(ls,{kpis:c,selectedIds:o.kpi_ids,onChange:a=>g({...o,kpi_ids:a}),disabled:!I}),e.jsx(rs,{qualityStandards:n,selectedIds:o.qs_ids,onChange:a=>g({...o,qs_ids:a}),disabled:!I})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"deliverable-key-details",children:[e.jsxs("div",{className:"detail-item",children:[e.jsx(Ge,{size:18,className:"detail-item-icon"}),e.jsxs("div",{className:"detail-item-content",children:[e.jsx("div",{className:"detail-item-label",children:"Milestone"}),e.jsx("div",{className:"detail-item-value",children:p?e.jsxs(ze,{to:`/milestones/${p.id}`,children:[p.milestone_ref," - ",p.name]}):"Not assigned"})]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx(Ye,{size:18,className:"detail-item-icon"}),e.jsxs("div",{className:"detail-item-content",children:[e.jsx("div",{className:"detail-item-label",children:"Due Date"}),e.jsx("div",{className:"detail-item-value",children:K?ce(K):"Not set"})]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx(ae,{size:18,className:"detail-item-icon"}),e.jsxs("div",{className:"detail-item-content",children:[e.jsx("div",{className:"detail-item-label",children:"Progress"}),e.jsxs("div",{className:"progress-display",children:[e.jsx("div",{className:"progress-bar",children:e.jsx("div",{className:`progress-bar-fill ${S?"complete":"in-progress"}`,style:{width:`${i.progress||0}%`}})}),e.jsxs("span",{className:"progress-value",children:[i.progress||0,"%"]})]})]})]})]}),e.jsxs("div",{className:"deliverable-description",children:[e.jsx("div",{className:"section-label",children:"Description"}),e.jsx("div",{className:`description-text ${i.description?"":"empty"}`,children:i.description||"No description provided"})]}),U.length>0&&e.jsxs("div",{className:"linked-items-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsx(ne,{size:14}),"Linked KPIs (",U.length,")"]}),e.jsx("div",{className:"linked-items-list",children:U.map(a=>e.jsxs("span",{className:"linked-item-badge kpi",children:[a.kpis?.kpi_ref||"KPI"," - ",a.kpis?.name||"Unknown"]},a.kpi_id))})]}),_.length>0&&e.jsxs("div",{className:"linked-items-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsx(le,{size:14}),"Linked Quality Standards (",_.length,")"]}),e.jsx("div",{className:"linked-items-list",children:_.map(a=>e.jsxs("span",{className:"linked-item-badge quality-standard",children:[a.quality_standards?.qs_ref||"QS"," - ",a.quality_standards?.name||"Unknown"]},a.quality_standard_id))})]}),ee&&e.jsxs("div",{className:"sign-off-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsx(He,{size:14}),"Delivery Sign-off"]}),S&&W===ie.SIGNED?e.jsx(We,{message:"Deliverable accepted and delivered"}):e.jsx(Ve,{supplier:{signedBy:i.supplier_pm_name,signedAt:i.supplier_pm_signed_at,canSign:x.canSignAsSupplier&&k,onSign:()=>C("supplier")},customer:{signedBy:i.customer_pm_name,signedAt:i.customer_pm_signed_at,canSign:x.canSignAsCustomer&&k,onSign:()=>C("customer")},saving:y,supplierButtonText:"Sign as Supplier PM",customerButtonText:"Sign as Customer PM"}),!S&&B&&e.jsxs("div",{className:"sign-off-status-indicator",children:[W===ie.AWAITING_CUSTOMER&&e.jsx("span",{className:"awaiting-badge customer",children:"Awaiting Customer PM signature"}),W===ie.AWAITING_SUPPLIER&&e.jsx("span",{className:"awaiting-badge supplier",children:"Awaiting Supplier PM signature"})]})]}),e.jsxs("div",{className:"deliverable-timestamps",children:[e.jsxs("div",{className:"timestamp-item",children:[e.jsx(ae,{size:14}),"Created: ",i.created_at?oe(i.created_at):"Unknown"]}),i.updated_at&&i.updated_at!==i.created_at&&e.jsxs("div",{className:"timestamp-item",children:[e.jsx(ae,{size:14}),"Updated: ",oe(i.updated_at)]})]})]})}),e.jsxs("div",{className:"deliverable-modal-footer",children:[e.jsx("div",{className:"footer-left",children:w&&!N&&!S&&e.jsxs("button",{className:"btn btn-danger",onClick:()=>{b(i.id),z()},children:[e.jsx(Xe,{size:16})," Delete"]})}),e.jsx("div",{className:"footer-right",children:N?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>R(!1),disabled:y,children:"Cancel"}),e.jsxs("button",{className:"btn btn-primary",onClick:se,disabled:y,children:[e.jsx(ve,{size:16})," ",y?"Saving...":"Save Changes"]})]}):e.jsxs(e.Fragment,{children:[O&&e.jsxs("button",{className:"btn btn-secondary",onClick:()=>V(f.SUBMITTED_FOR_REVIEW),children:[e.jsx(Je,{size:16})," Submit for Review"]}),X&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"btn btn-danger",onClick:()=>V(f.RETURNED_FOR_MORE_WORK),children:[e.jsx(Ze,{size:16})," Return for More Work"]}),e.jsxs("button",{className:"btn btn-success",onClick:()=>V(f.REVIEW_COMPLETE),children:[e.jsx(es,{size:16})," Accept Review"]})]}),J&&!B&&e.jsxs("button",{className:"btn btn-success",onClick:()=>{P(i),z()},children:[e.jsx(ss,{size:16})," Assess & Sign Off"]}),m&&!S&&e.jsxs("button",{className:"btn btn-primary",onClick:()=>R(!0),children:[e.jsx(is,{size:16})," Edit"]})]})})]})]})})}function cs({kpis:l,selectedIds:i,onChange:r,label:c="Link to KPIs"}){return e.jsxs("div",{style:{marginTop:"1rem"},children:[e.jsxs("label",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("span",{children:c}),i.length>0&&e.jsx("button",{type:"button",onClick:()=>r([]),style:{fontSize:"0.8rem",color:"#dc2626",background:"none",border:"none",cursor:"pointer"},children:"Clear"})]}),e.jsx("div",{style:{maxHeight:"200px",overflowY:"auto",border:"1px solid #e2e8f0",borderRadius:"8px",padding:"0.5rem"},children:l.map(n=>{const m=i.includes(n.id);return e.jsxs("div",{onClick:()=>r(m?i.filter(j=>j!==n.id):[...i,n.id]),style:{display:"flex",alignItems:"flex-start",gap:"0.75rem",padding:"0.75rem",marginBottom:"0.5rem",backgroundColor:m?"#dbeafe":"#f8fafc",border:m?"2px solid #3b82f6":"1px solid #e2e8f0",borderRadius:"8px",cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:m,onChange:()=>{},style:{marginTop:"3px"}}),e.jsxs("div",{children:[e.jsx("span",{style:{backgroundColor:"#3b82f6",color:"white",padding:"0.125rem 0.375rem",borderRadius:"4px",fontSize:"0.75rem",fontWeight:"700"},children:n.kpi_ref})," ",e.jsx("span",{style:{fontWeight:"600"},children:n.name})]})]},n.id)})}),e.jsxs("div",{style:{marginTop:"0.5rem",fontSize:"0.85rem",color:"#64748b"},children:[i.length," selected"]})]})}function os({qualityStandards:l,selectedIds:i,onChange:r,label:c="Link to Quality Standards"}){return e.jsxs("div",{style:{marginTop:"1rem"},children:[e.jsxs("label",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("span",{children:c}),i.length>0&&e.jsx("button",{type:"button",onClick:()=>r([]),style:{fontSize:"0.8rem",color:"#dc2626",background:"none",border:"none",cursor:"pointer"},children:"Clear"})]}),e.jsx("div",{style:{maxHeight:"200px",overflowY:"auto",border:"1px solid #e2e8f0",borderRadius:"8px",padding:"0.5rem"},children:l.map(n=>{const m=i.includes(n.id);return e.jsxs("div",{onClick:()=>r(m?i.filter(j=>j!==n.id):[...i,n.id]),style:{display:"flex",alignItems:"flex-start",gap:"0.75rem",padding:"0.75rem",marginBottom:"0.5rem",backgroundColor:m?"#f3e8ff":"#f8fafc",border:m?"2px solid #8b5cf6":"1px solid #e2e8f0",borderRadius:"8px",cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:m,onChange:()=>{},style:{marginTop:"3px"}}),e.jsxs("div",{children:[e.jsx("span",{style:{backgroundColor:"#8b5cf6",color:"white",padding:"0.125rem 0.375rem",borderRadius:"4px",fontSize:"0.75rem",fontWeight:"700"},children:n.qs_ref})," ",e.jsx("span",{style:{fontWeight:"600"},children:n.name})]})]},n.id)})}),e.jsxs("div",{style:{marginTop:"0.5rem",fontSize:"0.85rem",color:"#64748b"},children:[i.length," selected"]})]})}function js(){const{user:l,role:i}=ue(),{projectId:r}=Re(),{showSuccess:c,showError:n,showWarning:m}=Ee(),{showTestUsers:j}=Ae(),w=l?.id||null,{canEditDeliverable:Z,canReviewDeliverable:Y,canDeleteDeliverable:H}=pe(),{refreshMetrics:b}=Pe(),[P,k]=h.useState([]),[N,R]=h.useState([]),[o,g]=h.useState([]),[y,T]=h.useState([]),[x,L]=h.useState(!0),[F,M]=h.useState(!1),[E,I]=h.useState(!1),[A,q]=h.useState(!1),[p,U]=h.useState(null),[_,S]=h.useState({}),[O,X]=h.useState({}),[J,W]=h.useState(""),[B,ee]=h.useState(""),[K,se]=h.useState(!1),[z,V]=h.useState({isOpen:!1,deliverable:null}),[u,C]=h.useState({deliverable_ref:"",name:"",description:"",milestone_id:"",status:f.NOT_STARTED,progress:0,kpi_ids:[],qs_ids:[]}),a=h.useCallback(async()=>{if(r){L(!0);try{const s=await Te.getAll(r,{orderBy:{column:"milestone_ref",ascending:!0}});R(s);const t=await Me.getAll(r,{orderBy:{column:"kpi_ref",ascending:!0}});g(t);const d=await Ie.getAll(r,{orderBy:{column:"qs_ref",ascending:!0}});T(d);const $=await v.getAllWithRelations(r,j);k($||[])}catch{n("Failed to load deliverables")}finally{L(!1),M(!1)}}},[r,j,n]);h.useEffect(()=>{a()},[a]);async function Q(){M(!0),await a()}async function G(s){s.preventDefault();try{const t=await v.create({project_id:r,deliverable_ref:u.deliverable_ref,name:u.name,description:u.description,milestone_id:u.milestone_id||null,status:u.status,progress:parseInt(u.progress)||0,created_by:w});await v.syncKPILinks(t.id,u.kpi_ids),await v.syncQSLinks(t.id,u.qs_ids),C({deliverable_ref:"",name:"",description:"",milestone_id:"",status:f.NOT_STARTED,progress:0,kpi_ids:[],qs_ids:[]}),I(!1),a(),b(),c("Deliverable added!")}catch(t){n("Failed: "+t.message)}}async function be(s,t){try{await v.update(s,{name:t.name,description:t.description,milestone_id:t.milestone_id||null,status:t.status,progress:parseInt(t.progress)||0}),t.kpi_ids&&await v.syncKPILinks(s,t.kpi_ids),t.qs_ids&&await v.syncQSLinks(s,t.qs_ids),a(),b(),c("Deliverable updated!")}catch(d){n("Failed: "+d.message)}}async function Ne(s,t){try{let d=s.progress;t===f.NOT_STARTED?d=0:[f.SUBMITTED_FOR_REVIEW,f.REVIEW_COMPLETE,f.DELIVERED].includes(t)?d=100:t===f.RETURNED_FOR_MORE_WORK&&(d=50),await v.update(s.id,{status:t,progress:d}),a(),b(),c(`Status changed to ${t}`)}catch(d){n("Failed: "+d.message)}}function _e(s){U(s),S({}),X({}),q(!0)}async function Se(){if(!p)return;const s=p.deliverable_kpis||[],t=p.deliverable_quality_standards||[];if(s.length>0&&!s.every(d=>_[d.kpi_id]!==void 0)){m("Please assess all linked KPIs.");return}if(t.length>0&&!t.every(d=>O[d.quality_standard_id]!==void 0)){m("Please assess all linked Quality Standards.");return}try{if(await v.update(p.id,{status:f.DELIVERED,progress:100}),s.length>0){const d=s.map($=>({kpiId:$.kpi_id,criteriaMet:_[$.kpi_id]}));await v.upsertKPIAssessments(p.id,d,w)}if(t.length>0){const d=t.map($=>({qsId:$.quality_standard_id,criteriaMet:O[$.quality_standard_id]}));await v.upsertQSAssessments(p.id,d,w)}c("Deliverable marked as delivered!"),q(!1),a()}catch(d){n("Failed: "+d.message)}}async function ye(s){if(confirm("Delete this deliverable?"))try{await v.delete(s,w),a(),c("Deleted")}catch(t){n("Failed: "+t.message)}}async function ke(s,t){try{const d=l?.user_metadata?.name||l?.email||"Unknown User";await v.signDeliverable(s,t,w,d),a(),b(),c(`Signed as ${t==="supplier"?"Supplier PM":"Customer PM"}`)}catch(d){n("Failed to sign: "+d.message)}}function Ce(s){V({isOpen:!0,deliverable:s})}let D=P;J&&(D=D.filter(s=>s.milestone_id===J)),B&&(D=D.filter(s=>s.status===B)),K&&(D=D.filter(s=>s.status===f.SUBMITTED_FOR_REVIEW));const re=P.filter(s=>s.status===f.SUBMITTED_FOR_REVIEW).length,de=Z,De=Y,we=H;return x?e.jsx(Oe,{message:"Loading deliverables...",size:"large",fullPage:!0}):e.jsxs("div",{className:"deliverables-page",children:[e.jsx("header",{className:"del-header",children:e.jsxs("div",{className:"del-header-content",children:[e.jsxs("div",{className:"del-header-left",children:[e.jsx("div",{className:"del-header-icon",children:e.jsx(je,{size:24})}),e.jsxs("div",{children:[e.jsx("h1",{children:"Deliverables"}),e.jsx("p",{children:"Track project deliverables with review workflow"})]})]}),e.jsxs("div",{className:"del-header-actions",children:[e.jsxs("button",{className:"del-btn del-btn-secondary",onClick:Q,disabled:F,children:[e.jsx(as,{size:18,className:F?"spinning":""})," Refresh"]}),de&&e.jsxs("button",{className:"del-btn del-btn-primary",onClick:()=>I(!E),children:[e.jsx(ts,{size:18})," Add Deliverable"]})]})]})}),e.jsxs("div",{className:"del-content",children:[e.jsxs("div",{className:"del-filters",children:[e.jsxs("select",{value:J,onChange:s=>W(s.target.value),className:"del-filter-select",children:[e.jsx("option",{value:"",children:"All Milestones"}),N.map(s=>e.jsxs("option",{value:s.id,children:[s.milestone_ref," - ",s.name]},s.id))]}),e.jsxs("select",{value:B,onChange:s=>ee(s.target.value),className:"del-filter-select",children:[e.jsx("option",{value:"",children:"All Statuses"}),$e().map(s=>e.jsx("option",{value:s,children:s},s))]}),re>0&&e.jsxs("button",{onClick:()=>{se(!K),K||(W(""),ee(""))},className:`del-filter-badge ${K?"active":""}`,children:[e.jsx(Send,{size:16})," ",re," Awaiting Review"]})]}),E&&e.jsxs("div",{className:"del-add-form",children:[e.jsx("h3",{className:"del-add-form-title",children:"Add New Deliverable"}),e.jsxs("form",{onSubmit:G,children:[e.jsxs("div",{className:"del-form-row",children:[e.jsxs("div",{className:"del-form-group",children:[e.jsx("label",{children:"Ref *"}),e.jsx("input",{type:"text",value:u.deliverable_ref,onChange:s=>C({...u,deliverable_ref:s.target.value}),required:!0})]}),e.jsxs("div",{className:"del-form-group",style:{flex:2},children:[e.jsx("label",{children:"Name *"}),e.jsx("input",{type:"text",value:u.name,onChange:s=>C({...u,name:s.target.value}),required:!0})]})]}),e.jsxs("div",{className:"del-form-group",children:[e.jsx("label",{children:"Description"}),e.jsx("textarea",{value:u.description,onChange:s=>C({...u,description:s.target.value})})]}),e.jsxs("div",{className:"del-form-row",children:[e.jsxs("div",{className:"del-form-group",children:[e.jsx("label",{children:"Milestone *"}),e.jsxs("select",{value:u.milestone_id,onChange:s=>C({...u,milestone_id:s.target.value}),required:!0,children:[e.jsx("option",{value:"",children:"Select"}),N.map(s=>e.jsx("option",{value:s.id,children:s.milestone_ref},s.id))]})]}),e.jsxs("div",{className:"del-form-group",children:[e.jsx("label",{children:"Due Date"}),e.jsx("div",{className:"del-form-readonly",children:(()=>{const s=N.find(t=>t.id===u.milestone_id);return s?.forecast_end_date?new Date(s.forecast_end_date).toLocaleDateString("en-GB"):"Select milestone"})()})]})]}),e.jsx(cs,{kpis:o,selectedIds:u.kpi_ids,onChange:s=>C({...u,kpi_ids:s})}),e.jsx(os,{qualityStandards:y,selectedIds:u.qs_ids,onChange:s=>C({...u,qs_ids:s})}),e.jsxs("div",{className:"del-form-actions",children:[e.jsxs("button",{type:"submit",className:"del-btn del-btn-primary",children:[e.jsx(ve,{size:16})," Save"]}),e.jsxs("button",{type:"button",className:"del-btn del-btn-secondary",onClick:()=>I(!1),children:[e.jsx(ge,{size:16})," Cancel"]})]})]})]}),e.jsxs("div",{className:"del-table-card",children:[e.jsxs("div",{className:"del-table-header",children:[e.jsx("h2",{className:"del-table-title",children:"Project Deliverables"}),e.jsxs("span",{className:"del-table-count",children:[D.length," deliverable",D.length!==1?"s":""]})]}),e.jsxs("table",{className:"del-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Ref"}),e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Milestone"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Progress"})]})}),e.jsx("tbody",{children:D.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"del-empty-cell",children:"No deliverables found"})}):D.map(s=>{const t=me[s.status]||me[f.NOT_STARTED],d=t.icon;return e.jsxs("tr",{onClick:()=>Ce(s),children:[e.jsx("td",{children:e.jsx("span",{className:"del-ref",children:s.deliverable_ref})}),e.jsx("td",{children:e.jsx("span",{className:"del-name",children:s.name})}),e.jsx("td",{children:s.milestones?e.jsx("span",{className:"del-milestone-link",children:s.milestones.milestone_ref}):"—"}),e.jsx("td",{children:e.jsxs("span",{className:"del-status-badge",style:{backgroundColor:t.bg,color:t.color},children:[e.jsx(d,{size:14}),s.status]})}),e.jsx("td",{children:e.jsxs("div",{className:"del-progress",children:[e.jsx("div",{className:"del-progress-bar",children:e.jsx("div",{className:"del-progress-fill",style:{width:`${s.progress||0}%`,backgroundColor:s.status==="Delivered"?"#16a34a":"#4f46e5"}})}),e.jsxs("span",{className:"del-progress-text",children:[s.progress||0,"%"]})]})})]},s.id)})})]})]})]}),e.jsx(ds,{isOpen:z.isOpen,deliverable:z.deliverable,milestones:N,kpis:o,qualityStandards:y,canEdit:de,canReview:De,canDelete:we,onClose:()=>V({isOpen:!1,deliverable:null}),onSave:be,onStatusChange:Ne,onDelete:ye,onOpenCompletion:_e,onSign:ke}),A&&p&&e.jsx("div",{className:"modal-overlay",children:e.jsxs("div",{className:"modal modal-lg",children:[e.jsx("div",{className:"modal-header",children:e.jsxs("h3",{className:"modal-title",children:[e.jsx(CheckCircle,{size:20,style:{color:"var(--color-success)"}})," Mark as Delivered"]})}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("p",{style:{color:"var(--color-text-secondary)",marginBottom:"var(--space-lg)"},children:[p.deliverable_ref," - ",p.name]}),p.deliverable_kpis?.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{padding:"var(--space-md)",backgroundColor:"var(--color-warning-light)",borderLeft:"4px solid var(--color-warning)",borderRadius:"var(--radius)",marginBottom:"var(--space-md)"},children:e.jsx("strong",{style:{color:"#92400e"},children:"KPI Assessment Required"})}),p.deliverable_kpis.map(s=>{const t=o.find(d=>d.id===s.kpi_id);return t?e.jsxs("div",{style:{padding:"var(--space-md)",border:"1px solid var(--color-border)",borderRadius:"var(--radius)",marginBottom:"var(--space-sm)",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsx("span",{className:"badge badge-info",children:t.kpi_ref})," ",e.jsx("strong",{style:{marginLeft:"var(--space-sm)"},children:t.name})]}),e.jsxs("div",{style:{display:"flex",gap:"var(--space-sm)"},children:[e.jsx("button",{onClick:()=>S({..._,[s.kpi_id]:!0}),className:`btn btn-sm ${_[s.kpi_id]===!0?"btn-success":"btn-secondary"}`,children:"✓ Yes"}),e.jsx("button",{onClick:()=>S({..._,[s.kpi_id]:!1}),className:`btn btn-sm ${_[s.kpi_id]===!1?"btn-danger":"btn-secondary"}`,children:"✗ No"})]})]},s.kpi_id):null})]}),p.deliverable_quality_standards?.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{padding:"var(--space-md)",backgroundColor:"var(--color-purple-light)",borderLeft:"4px solid var(--color-purple)",borderRadius:"var(--radius)",marginBottom:"var(--space-md)",marginTop:"var(--space-lg)"},children:e.jsx("strong",{style:{color:"#6b21a8"},children:"Quality Standards Assessment"})}),p.deliverable_quality_standards.map(s=>{const t=y.find(d=>d.id===s.quality_standard_id);return t?e.jsxs("div",{style:{padding:"var(--space-md)",border:"1px solid var(--color-border)",borderRadius:"var(--radius)",marginBottom:"var(--space-sm)",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsx("span",{className:"badge badge-purple",children:t.qs_ref})," ",e.jsx("strong",{style:{marginLeft:"var(--space-sm)"},children:t.name})]}),e.jsxs("div",{style:{display:"flex",gap:"var(--space-sm)"},children:[e.jsx("button",{onClick:()=>X({...O,[s.quality_standard_id]:!0}),className:`btn btn-sm ${O[s.quality_standard_id]===!0?"btn-success":"btn-secondary"}`,children:"✓ Yes"}),e.jsx("button",{onClick:()=>X({...O,[s.quality_standard_id]:!1}),className:`btn btn-sm ${O[s.quality_standard_id]===!1?"btn-danger":"btn-secondary"}`,children:"✗ No"})]})]},s.quality_standard_id):null})]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>q(!1),children:"Cancel"}),e.jsxs("button",{className:"btn btn-success",onClick:Se,children:[e.jsx(CheckCircle,{size:16})," Mark Delivered"]})]})]})})]})}export{js as default};
