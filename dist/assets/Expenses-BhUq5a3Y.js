import{s as U,u as ze,a as Fe,c as Oe,j as e,f as ss,d as as,l as V,L as ts}from"./index-IaXQkjEL.js";import{r as h}from"./vendor-react-BUTV5ZEl.js";import{C as we}from"./ConfirmDialog-CmqcCv3X.js";import{P as rs}from"./PromptDialog-BDVwezse.js";import{o as se,c as W,aA as oe,aB as Ce,aC as ns,T as Ue,S as de,H as cs,g as Ae,e as Z,a4 as _e,ao as ls,w as ke,aD as ue,aE as me,aF as he,y as is,F as os,ak as $e,n as Be,at as Le,aG as Me,U as ds,h as us,ab as ms,b as Pe,p as Ee,i as hs,aj as ps,aq as gs,E as xs,R as js,ai as fs}from"./vendor-icons-C6BNM9_X.js";import"./vendor-supabase-6faYzd5A.js";const bs={uber:"Travel",lyft:"Travel",taxi:"Travel",train:"Travel",rail:"Travel",airlines:"Travel",airways:"Travel",petrol:"Travel","gas station":"Travel",fuel:"Travel",parking:"Travel",hotel:"Accommodation",inn:"Accommodation",motel:"Accommodation",airbnb:"Accommodation","booking.com":"Accommodation",marriott:"Accommodation",hilton:"Accommodation","premier inn":"Accommodation",travelodge:"Accommodation",restaurant:"Sustenance",cafe:"Sustenance",coffee:"Sustenance",costa:"Sustenance",starbucks:"Sustenance",pret:"Sustenance",greggs:"Sustenance",mcdonald:"Sustenance",subway:"Sustenance",nando:"Sustenance",pizza:"Sustenance",pub:"Sustenance",bar:"Sustenance",food:"Sustenance",supermarket:"Sustenance",tesco:"Sustenance",sainsbury:"Sustenance","co-op":"Sustenance",waitrose:"Sustenance",aldi:"Sustenance",lidl:"Sustenance"};class vs{constructor(){this.bucketName="receipt-scans"}async uploadImage(a,l){try{if(!["image/jpeg","image/png","image/webp","image/heic"].includes(a.type))throw new Error("Invalid file type. Please upload a JPEG, PNG, or WebP image.");const n=10*1024*1024;if(a.size>n)throw new Error("File too large. Maximum size is 10MB.");const x=Date.now(),d=a.name.split(".").pop(),f=`${l}/${x}.${d}`,{error:R}=await U.storage.from(this.bucketName).upload(f,a);if(R)throw R;const{data:{publicUrl:o}}=U.storage.from(this.bucketName).getPublicUrl(f);return{path:f,url:o}}catch(r){throw r}}async processReceipt(a,l){const r=Date.now();try{const n=await this.callClaudeVision(a);let x=await this.findClassificationRule(l,n.merchant);x||(x=this.classifyFromPatterns(n.merchant),!x&&n.aiSuggestedCategory&&(x={category:n.aiSuggestedCategory,confidence:n.aiConfidence||.6}));const d=Date.now()-r;return{...n,suggestedCategory:x?.category||null,confidence:x?.confidence||0,ruleBasedClassification:!!x?.ruleId,processingTimeMs:d}}catch(n){throw n}}async fetchImageAsBase64(a){try{const r=await(await fetch(a)).blob();return new Promise((n,x)=>{const d=new FileReader;d.onloadend=()=>{const f=d.result.split(",")[1];n({data:f,mediaType:r.type})},d.onerror=x,d.readAsDataURL(r)})}catch(l){throw l}}async callClaudeVision(a){const l=`Analyze this receipt image and extract the following information in JSON format:
{
  "merchant": "Store/vendor name",
  "amount": 0.00,
  "currency": "GBP",
  "date": "YYYY-MM-DD",
  "items": [{"name": "item name", "quantity": 1, "price": 0.00}],
  "paymentMethod": "card/cash/unknown",
  "category": "Travel/Accommodation/Sustenance",
  "confidence": 0.0 to 1.0,
  "rawText": "All visible text from receipt"
}

If any field cannot be determined, use null. For the category, consider:
- Travel: transport, fuel, parking, flights, trains, taxis
- Accommodation: hotels, lodging, rentals
- Sustenance: food, drinks, restaurants, cafes, supermarkets

Be conservative with confidence - only use high values (>0.8) when very certain.`;try{const r=await fetch("/api/scan-receipt",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({image:a,prompt:l})});if(!r.ok)throw new Error("Failed to process receipt with AI");const n=await r.json();return{merchant:n.merchant,amount:n.amount,currency:n.currency||"GBP",date:n.date,items:n.items||[],paymentMethod:n.paymentMethod,aiSuggestedCategory:n.category,aiConfidence:n.confidence,rawText:n.rawText}}catch(r){return{merchant:null,amount:null,currency:"GBP",date:null,items:[],paymentMethod:null,aiSuggestedCategory:null,aiConfidence:0,rawText:null,error:r.message}}}async findClassificationRule(a,l){if(!l)return null;try{const{data:r,error:n}=await U.rpc("find_classification_rule",{p_project_id:a,p_merchant:l});if(n)throw n;return r&&r.length>0?{ruleId:r[0].rule_id,category:r[0].category,subcategory:r[0].subcategory,defaultChargeable:r[0].default_chargeable,defaultProcurement:r[0].default_procurement,confidence:parseFloat(r[0].confidence)}:null}catch{return null}}classifyFromPatterns(a){if(!a)return null;const l=a.toLowerCase();for(const[r,n]of Object.entries(bs))if(l.includes(r))return{category:n,confidence:.7,source:"pattern"};return null}async learnFromCorrection(a,l,r,n,x=!1){if(!l||!r)return null;try{const{data:d,error:f}=await U.rpc("upsert_classification_rule",{p_project_id:a,p_merchant:l,p_category:r,p_user_id:n,p_was_correction:x});if(f)throw f;return d}catch{return null}}async createScan(a){try{const{data:l,error:r}=await U.from("receipt_scans").insert({project_id:a.projectId,uploaded_by:a.userId,image_url:a.imageUrl,image_path:a.imagePath,raw_ocr_text:a.rawText,extracted_merchant:a.merchant,extracted_amount:a.amount,extracted_date:a.date,extracted_currency:a.currency,extracted_items:a.items,ai_suggested_category:a.suggestedCategory,ai_confidence:a.confidence,status:"completed",processing_time_ms:a.processingTimeMs}).select().single();if(r)throw r;return l}catch(l){throw l}}async updateScanClassification(a,l,r=!1){try{const{data:n,error:x}=await U.from("receipt_scans").update({final_category:l,user_corrected:r}).eq("id",a).select().single();if(x)throw x;return n}catch(n){throw n}}async linkToExpense(a,l){try{const{data:r,error:n}=await U.from("receipt_scans").update({expense_id:l,status:"linked"}).eq("id",a).select().single();if(n)throw n;return r}catch(r){throw r}}async getRecentScans(a,l=10){try{const{data:r,error:n}=await U.from("receipt_scans").select("*").eq("project_id",a).order("created_at",{ascending:!1}).limit(l);if(n)throw n;return r||[]}catch{return[]}}async getUnlinkedScans(a){try{const{data:l,error:r}=await U.from("receipt_scans").select("*").eq("project_id",a).is("expense_id",null).eq("status","completed").order("created_at",{ascending:!1});if(r)throw r;return l||[]}catch{return[]}}async getClassificationRules(a){try{const{data:l,error:r}=await U.from("classification_rules").select("*").eq("project_id",a).order("match_count",{ascending:!1});if(r)throw r;return l||[]}catch{return[]}}async deleteClassificationRule(a){try{const{error:l}=await U.from("classification_rules").delete().eq("id",a);if(l)throw l;return!0}catch{return!1}}}const ne=new vs,ys=[{id:"Travel",label:"Travel",icon:ue,color:"#2563eb",bg:"#dbeafe"},{id:"Accommodation",label:"Accommodation",icon:me,color:"#7c3aed",bg:"#f3e8ff"},{id:"Sustenance",label:"Sustenance",icon:he,color:"#ea580c",bg:"#ffedd5"}],y={PENDING:"pending",PROCESSING:"processing",READY:"ready",SUBMITTED:"submitted",ERROR:"error"},E={UPLOAD:"upload",PROCESSING:"processing",REVIEW:"review"};function _s({onExpenseCreated:t,onCancel:a,resources:l=[],defaultResourceId:r=null}){const{user:n}=ze(),{projectId:x}=Fe(),{showSuccess:d,showError:f,showWarning:R,showInfo:o}=Oe(),[w,T]=h.useState(E.UPLOAD),[u,b]=h.useState([]),[v,$]=h.useState(0),[B,D]=h.useState({current:0,total:0}),N=h.useRef(null),I=h.useRef(null),C=u[v];u.filter(s=>s.status===y.READY).length;const q=u.filter(s=>s.status===y.SUBMITTED).length;u.filter(s=>s.status===y.PENDING||s.status===y.PROCESSING).length;const L=(s,c=1500,j=.8)=>new Promise((A,m)=>{const _=new FileReader;_.onload=M=>{const G=new Image;G.onload=()=>{let{width:k,height:P}=G;(k>c||P>c)&&(k>P?(P=Math.round(P*c/k),k=c):(k=Math.round(k*c/P),P=c));const H=document.createElement("canvas");H.width=k,H.height=P,H.getContext("2d").drawImage(G,0,0,k,P),H.toBlob(le=>{le?A(le):m(new Error("Failed to compress image"))},"image/jpeg",j)},G.onerror=()=>m(new Error("Failed to load image")),G.src=M.target.result},_.onerror=m,_.readAsDataURL(s)}),p=async s=>{const c=await L(s);return new Promise((j,A)=>{const m=new FileReader;m.onload=()=>{j({data:m.result.split(",")[1],mediaType:"image/jpeg",preview:m.result})},m.onerror=A,m.readAsDataURL(c)})},J=(s,c)=>({id:`receipt-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,file:s,preview:c,status:y.PENDING,scanResult:null,scanId:null,imageUrl:null,formData:{merchant:"",amount:"",date:new Date().toISOString().split("T")[0],category:"",resource_id:r||"",reason:"",chargeable:!0,procurement:"supplier",notes:""},wasEdited:!1}),X=h.useCallback(async s=>{const c=Array.from(s.target.files||[]);if(c.length===0)return;const j=["image/jpeg","image/png","image/webp","image/heic"],A=[];for(const _ of c){if(!j.includes(_.type)){R(`Skipped ${_.name} - invalid file type`);continue}if(_.size>10*1024*1024){R(`Skipped ${_.name} - file too large (max 10MB)`);continue}A.push(_)}if(A.length===0)return;const m=await Promise.all(A.map(async _=>{const{preview:M}=await p(_);return J(_,M)}));b(_=>[..._,...m]),o(`Added ${m.length} receipt${m.length>1?"s":""}`)},[R,o,r]),ae=h.useCallback(s=>{s.preventDefault();const c=s.dataTransfer.files;c.length>0&&X({target:{files:c}})},[X]),pe=h.useCallback(s=>{s.preventDefault()},[]),ce=h.useCallback(s=>{b(c=>{const j=c.filter(A=>A.id!==s);return v>=j.length&&j.length>0&&$(j.length-1),j})},[v]),g=h.useCallback(()=>{b([]),$(0),T(E.UPLOAD),N.current&&(N.current.value="")},[]),Q=h.useCallback(async()=>{if(u.length===0||!x||!n?.id){f("No receipts to process");return}T(E.PROCESSING),D({current:0,total:u.length});const s=[...u];for(let m=0;m<s.length;m++){const _=s[m];if(_.status===y.READY||_.status===y.SUBMITTED){D({current:m+1,total:u.length});continue}s[m]={..._,status:y.PROCESSING},b([...s]);try{const M=await p(_.file),{path:G,url:k}=await ne.uploadImage(_.file,n.id),P=await ne.processReceipt(M,x),H=await ne.createScan({projectId:x,userId:n.id,imageUrl:k,imagePath:G,...P});s[m]={...s[m],status:y.READY,scanResult:P,scanId:H.id,imageUrl:k,formData:{...s[m].formData,merchant:P.merchant||"",amount:P.amount?.toString()||"",date:P.date||new Date().toISOString().split("T")[0],category:P.suggestedCategory||"",reason:P.merchant?`Receipt from ${P.merchant}`:""}}}catch(M){s[m]={...s[m],status:y.ERROR,error:M.message}}b([...s]),D({current:m+1,total:u.length})}T(E.REVIEW);const c=s.findIndex(m=>m.status===y.READY);c>=0&&$(c);const j=s.filter(m=>m.status===y.READY).length,A=s.filter(m=>m.status===y.ERROR).length;A>0?R(`Processed ${j} receipts, ${A} failed`):d(`Successfully scanned ${j} receipt${j>1?"s":""}!`)},[u,x,n,f,d,R]),z=h.useCallback((s,c)=>{b(j=>{const A=[...j];return A[v]={...A[v],formData:{...A[v].formData,[s]:c},wasEdited:!0},A})},[v]),ge=h.useCallback(s=>{z("category",s)},[z]),te=h.useCallback(s=>{s>=0&&s<u.length&&$(s)},[u.length]),xe=h.useCallback(()=>{for(let s=v-1;s>=0;s--)if(u[s].status===y.READY){$(s);return}},[v,u]),ee=h.useCallback(()=>{for(let s=v+1;s<u.length;s++)if(u[s].status===y.READY){$(s);return}},[v,u]),je=u.slice(0,v).some(s=>s.status===y.READY),K=u.slice(v+1).some(s=>s.status===y.READY),fe=h.useCallback(async()=>{const s=C;if(!s||s.status!==y.READY)return;const{formData:c}=s;if(!c.resource_id){R("Please select a resource");return}if(!c.amount||parseFloat(c.amount)<=0){R("Please enter a valid amount");return}if(!c.category){R("Please select a category");return}if(!c.reason){R("Please enter a reason/description");return}try{if(c.merchant&&c.category){const m=s.wasEdited&&s.scanResult?.suggestedCategory!==c.category;await ne.learnFromCorrection(x,c.merchant,c.category,n.id,m)}s.scanId&&await ne.updateScanClassification(s.scanId,c.category,s.wasEdited);const j={category:c.category,resource_id:c.resource_id,resource_name:l.find(m=>m.id===c.resource_id)?.name,expense_date:c.date,reason:c.reason,amount:parseFloat(c.amount),notes:c.notes,chargeable_to_customer:c.chargeable,procurement_method:c.procurement,receipt_scan_id:s.scanId,receipt_image_url:s.imageUrl};b(m=>{const _=[...m];return _[v]={..._[v],status:y.SUBMITTED},_}),t&&t(j),d(`Expense created: ${c.merchant||"Receipt"} - £${c.amount}`);const A=u.findIndex((m,_)=>_>v&&m.status===y.READY);A>=0&&$(A)}catch(j){f("Failed to create expense: "+j.message)}},[C,v,u,x,n,l,t,d,f,R]),re=s=>{if(!s)return null;let c,j;return s>=.8?(c="#10b981",j="High"):s>=.5?(c="#f59e0b",j="Medium"):(c="#ef4444",j="Low"),e.jsxs("div",{className:"confidence-badge",style:{color:c,borderColor:c},children:[e.jsx(de,{size:14}),j," confidence (",Math.round(s*100),"%)"]})},be=s=>{switch(s){case y.PENDING:return e.jsx("div",{className:"status-dot pending"});case y.PROCESSING:return e.jsx(Ae,{size:14,className:"spinner"});case y.READY:return e.jsx("div",{className:"status-dot ready"});case y.SUBMITTED:return e.jsx(Z,{size:14,className:"status-check"});case y.ERROR:return e.jsx(_e,{size:14,className:"status-error"});default:return null}};return e.jsxs("div",{className:"receipt-scanner batch-mode",children:[e.jsxs("div",{className:"scanner-header",children:[e.jsxs("div",{className:"scanner-title",children:[e.jsx(se,{size:24}),e.jsxs("div",{children:[e.jsx("h3",{children:"Smart Receipt Scanner"}),e.jsxs("p",{children:[w===E.UPLOAD&&"Upload one or more receipt photos",w===E.PROCESSING&&`Processing ${B.current} of ${B.total}...`,w===E.REVIEW&&`Reviewing ${v+1} of ${u.length} receipts`]})]})]}),a&&e.jsx("button",{className:"btn btn-ghost",onClick:a,children:e.jsx(W,{size:20})})]}),e.jsxs("div",{className:"scanner-steps",children:[e.jsxs("div",{className:`step ${w===E.UPLOAD?"active":w!==E.UPLOAD?"complete":""}`,children:[e.jsx("div",{className:"step-dot",children:"1"}),e.jsx("span",{children:"Upload"})]}),e.jsx("div",{className:"step-line"}),e.jsxs("div",{className:`step ${w===E.PROCESSING?"active":w===E.REVIEW?"complete":""}`,children:[e.jsx("div",{className:"step-dot",children:"2"}),e.jsx("span",{children:"Scan All"})]}),e.jsx("div",{className:"step-line"}),e.jsxs("div",{className:`step ${w===E.REVIEW?"active":""}`,children:[e.jsx("div",{className:"step-dot",children:"3"}),e.jsx("span",{children:"Review"})]})]}),e.jsxs("div",{className:"scanner-content",children:[w===E.UPLOAD&&e.jsxs("div",{className:"upload-section",children:[e.jsxs("div",{className:"drop-zone",onDrop:ae,onDragOver:pe,onClick:()=>N.current?.click(),children:[e.jsx(oe,{size:48,className:"drop-icon"}),e.jsx("p",{className:"drop-text",children:"Drag & drop receipt images"}),e.jsx("p",{className:"drop-subtext",children:"or click to browse (select multiple)"}),e.jsxs("div",{className:"upload-buttons",children:[e.jsxs("button",{className:"btn btn-primary",onClick:s=>{s.stopPropagation(),N.current?.click()},children:[e.jsx(oe,{size:18})," Choose Files"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:s=>{s.stopPropagation(),I.current?.click()},children:[e.jsx(Ce,{size:18})," Take Photo"]})]}),e.jsx("input",{ref:N,type:"file",accept:"image/jpeg,image/png,image/webp,image/heic",multiple:!0,onChange:X,style:{display:"none"}}),e.jsx("input",{ref:I,type:"file",accept:"image/*",capture:"environment",onChange:X,style:{display:"none"}})]}),u.length>0&&e.jsxs("div",{className:"receipt-queue",children:[e.jsxs("div",{className:"queue-header",children:[e.jsxs("h4",{children:[e.jsx(ns,{size:18})," ",u.length," Receipt",u.length>1?"s":""," Ready"]}),e.jsxs("button",{className:"btn btn-ghost btn-sm",onClick:g,children:[e.jsx(Ue,{size:16})," Clear All"]})]}),e.jsxs("div",{className:"queue-grid",children:[u.map((s,c)=>e.jsxs("div",{className:"queue-item",children:[e.jsx("img",{src:s.preview,alt:`Receipt ${c+1}`}),e.jsx("button",{className:"remove-btn",onClick:j=>{j.stopPropagation(),ce(s.id)},children:e.jsx(W,{size:14})}),e.jsx("span",{className:"queue-number",children:c+1})]},s.id)),e.jsxs("div",{className:"queue-item add-more",onClick:()=>N.current?.click(),children:[e.jsx(oe,{size:24}),e.jsx("span",{children:"Add More"})]})]}),e.jsxs("button",{className:"btn btn-primary btn-lg scan-all-btn",onClick:Q,children:[e.jsx(de,{size:20})," Scan All ",u.length," Receipt",u.length>1?"s":""]})]}),e.jsxs("div",{className:"scanner-tips",children:[e.jsxs("h4",{children:[e.jsx(cs,{size:16})," Tips for best results"]}),e.jsxs("ul",{children:[e.jsx("li",{children:"Ensure receipts are flat and well-lit"}),e.jsx("li",{children:"Include the full receipt in frame"}),e.jsx("li",{children:"Avoid shadows and glare"}),e.jsx("li",{children:"You can select multiple files at once"})]})]})]}),w===E.PROCESSING&&e.jsxs("div",{className:"processing-section batch-processing",children:[e.jsxs("div",{className:"processing-progress",children:[e.jsx("div",{className:"progress-bar",children:e.jsx("div",{className:"progress-fill",style:{width:`${B.current/B.total*100}%`}})}),e.jsxs("span",{className:"progress-text",children:["Processing receipt ",B.current," of ",B.total]})]}),e.jsx("div",{className:"processing-grid",children:u.map((s,c)=>e.jsxs("div",{className:`processing-item ${s.status}`,children:[e.jsx("img",{src:s.preview,alt:`Receipt ${c+1}`}),e.jsxs("div",{className:"processing-overlay",children:[s.status===y.PROCESSING&&e.jsx(Ae,{size:24,className:"spinner"}),s.status===y.READY&&e.jsx(Z,{size:24,className:"success-icon"}),s.status===y.ERROR&&e.jsx(_e,{size:24,className:"error-icon"})]}),e.jsx("span",{className:"item-number",children:c+1})]},s.id))})]}),w===E.REVIEW&&C&&e.jsxs("div",{className:"review-section batch-review",children:[e.jsxs("div",{className:"receipt-sidebar",children:[e.jsxs("div",{className:"sidebar-header",children:[e.jsx("h4",{children:"Receipts"}),e.jsxs("span",{className:"sidebar-count",children:[q,"/",u.length," submitted"]})]}),e.jsx("div",{className:"sidebar-list",children:u.map((s,c)=>e.jsxs("div",{className:`sidebar-item ${c===v?"active":""} ${s.status}`,onClick:()=>s.status===y.READY&&te(c),children:[e.jsx("img",{src:s.preview,alt:`Receipt ${c+1}`}),e.jsxs("div",{className:"sidebar-item-info",children:[e.jsx("span",{className:"item-merchant",children:s.formData.merchant||`Receipt ${c+1}`}),e.jsx("span",{className:"item-amount",children:s.formData.amount?`£${s.formData.amount}`:"—"})]}),e.jsx("div",{className:"sidebar-item-status",children:be(s.status)})]},s.id))})]}),e.jsx("div",{className:"review-main",children:C.status===y.READY?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"review-header",children:[e.jsxs("button",{className:"btn btn-ghost",onClick:xe,disabled:!je,children:[e.jsx(ls,{size:20})," Previous"]}),e.jsxs("div",{className:"review-position",children:["Receipt ",v+1," of ",u.length]}),e.jsxs("button",{className:"btn btn-ghost",onClick:ee,disabled:!K,children:["Next ",e.jsx(ke,{size:20})]})]}),e.jsxs("div",{className:"extraction-summary",children:[e.jsxs("div",{className:"summary-header",children:[e.jsx("h4",{children:"Extracted Information"}),re(C.scanResult?.confidence)]}),C.scanResult?.ruleBasedClassification&&e.jsxs("div",{className:"rule-notice",children:[e.jsx(de,{size:14}),"Category auto-selected based on previous receipts"]})]}),e.jsxs("div",{className:"review-form",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Resource *"}),e.jsxs("select",{className:"form-input",value:C.formData.resource_id,onChange:s=>z("resource_id",s.target.value),children:[e.jsx("option",{value:"",children:"Select resource..."}),l.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Category *"}),e.jsx("div",{className:"category-selector",children:ys.map(s=>{const c=s.icon,j=C.formData.category===s.id;return e.jsxs("button",{type:"button",className:`category-btn ${j?"selected":""}`,style:{"--cat-color":s.color,"--cat-bg":s.bg},onClick:()=>ge(s.id),children:[e.jsx(c,{size:20}),s.label,j&&e.jsx(Z,{size:16,className:"check-icon"})]},s.id)})})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Merchant"}),e.jsx("input",{type:"text",className:"form-input",value:C.formData.merchant,onChange:s=>z("merchant",s.target.value),placeholder:"Store/vendor name"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Amount (£) *"}),e.jsx("input",{type:"number",step:"0.01",className:"form-input",value:C.formData.amount,onChange:s=>z("amount",s.target.value),placeholder:"0.00"})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Date *"}),e.jsx("input",{type:"date",className:"form-input",value:C.formData.date,onChange:s=>z("date",s.target.value)})]}),e.jsxs("div",{className:"form-group",style:{flex:2},children:[e.jsx("label",{className:"form-label",children:"Reason/Description *"}),e.jsx("input",{type:"text",className:"form-input",value:C.formData.reason,onChange:s=>z("reason",s.target.value),placeholder:"Brief description of expense"})]})]}),e.jsxs("div",{className:"form-row options-row",children:[e.jsxs("label",{className:"checkbox-label",children:[e.jsx("input",{type:"checkbox",checked:C.formData.chargeable,onChange:s=>z("chargeable",s.target.checked)}),e.jsx("span",{children:"Chargeable to Customer"})]}),e.jsxs("div",{className:"procurement-toggle",children:[e.jsx("span",{children:"Paid by:"}),e.jsxs("select",{className:"form-input-sm",value:C.formData.procurement,onChange:s=>z("procurement",s.target.value),children:[e.jsx("option",{value:"supplier",children:"Supplier (JT)"}),e.jsx("option",{value:"partner",children:"Partner"})]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Additional Notes"}),e.jsx("textarea",{className:"form-input",rows:2,value:C.formData.notes,onChange:s=>z("notes",s.target.value),placeholder:"Any additional information..."})]})]}),e.jsxs("div",{className:"receipt-thumbnail",children:[e.jsx("img",{src:C.preview,alt:"Receipt"}),e.jsx("span",{children:"Receipt attached"})]}),e.jsxs("div",{className:"review-actions",children:[e.jsxs("button",{className:"btn btn-secondary",onClick:()=>T(E.UPLOAD),children:[e.jsx(is,{size:18})," Back to Upload"]}),e.jsxs("button",{className:"btn btn-primary btn-lg",onClick:fe,children:[e.jsx(Z,{size:18})," Submit Expense",K&&" & Next"]})]})]}):C.status===y.SUBMITTED?e.jsxs("div",{className:"submitted-message",children:[e.jsx("div",{className:"success-icon-large",children:e.jsx(Z,{size:48})}),e.jsx("h3",{children:"Expense Submitted"}),e.jsxs("p",{children:[C.formData.merchant," - £",C.formData.amount]}),K&&e.jsxs("button",{className:"btn btn-primary",onClick:ee,children:["Review Next Receipt ",e.jsx(ke,{size:18})]})]}):C.status===y.ERROR?e.jsxs("div",{className:"error-message",children:[e.jsx(_e,{size:48,className:"error-icon"}),e.jsx("h3",{children:"Processing Failed"}),e.jsx("p",{children:C.error||"Unable to process this receipt"})]}):null})]}),w===E.REVIEW&&q===u.length&&u.length>0&&e.jsxs("div",{className:"complete-section",children:[e.jsx("div",{className:"success-icon",children:e.jsx(Z,{size:48})}),e.jsx("h3",{children:"All Receipts Submitted!"}),e.jsxs("p",{children:[q," expense",q>1?"s":""," created successfully."]}),e.jsxs("div",{className:"complete-actions",children:[e.jsxs("button",{className:"btn btn-primary",onClick:g,children:[e.jsx(Ce,{size:18})," Scan More Receipts"]}),a&&e.jsx("button",{className:"btn btn-secondary",onClick:a,children:"Done"})]})]})]})]})}const Ns=["Travel","Accommodation","Sustenance"],Cs=["Draft","Submitted","Approved","Rejected","Paid"],Ss={Draft:"Draft",Submitted:"Submitted",Approved:"Validated",Rejected:"Rejected",Paid:"Paid"};function Rs({filterCategory:t,setFilterCategory:a,filterResource:l,setFilterResource:r,filterStatus:n,setFilterStatus:x,filterChargeable:d,setFilterChargeable:f,filterProcurement:R,setFilterProcurement:o,resourceNames:w,hasRole:T}){const u={padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"};return e.jsx("div",{className:"card",style:{marginBottom:"1.5rem"},children:e.jsxs("div",{style:{display:"flex",gap:"1rem",alignItems:"center",flexWrap:"wrap"},children:[e.jsx("span",{style:{fontWeight:"500"},children:"Filter:"}),e.jsxs("select",{value:t,onChange:b=>a(b.target.value),style:u,children:[e.jsx("option",{value:"all",children:"All Types"}),Ns.map(b=>e.jsx("option",{value:b,children:b},b))]}),e.jsxs("select",{value:l,onChange:b=>r(b.target.value),style:u,children:[e.jsx("option",{value:"all",children:"All Resources"}),w.map(b=>e.jsx("option",{value:b,children:b},b))]}),e.jsxs("select",{value:n,onChange:b=>x(b.target.value),style:u,children:[e.jsx("option",{value:"all",children:"All Statuses"}),Cs.map(b=>e.jsx("option",{value:b,children:Ss[b]||b},b))]}),e.jsxs("select",{value:d,onChange:b=>f(b.target.value),style:u,children:[e.jsx("option",{value:"all",children:"All Expenses"}),e.jsx("option",{value:"chargeable",children:"Chargeable Only"}),e.jsx("option",{value:"non-chargeable",children:"Non-Chargeable Only"})]}),T(["admin","supplier_pm"])&&e.jsxs("select",{value:R,onChange:b=>o(b.target.value),style:u,children:[e.jsx("option",{value:"all",children:"All Procurement"}),e.jsx("option",{value:"supplier",children:"Supplier Procured"}),e.jsx("option",{value:"partner",children:"Partner Procured"})]})]})})}function Ne({category:t,icon:a,bgColor:l,textColor:r,borderColor:n,amount:x,reason:d,chargeable:f,procurement:R,onAmountChange:o,onReasonChange:w,onChargeableChange:T,onProcurementChange:u,hasRole:b}){return e.jsxs("div",{style:{padding:"1rem",backgroundColor:l,borderRadius:"8px",marginBottom:"1rem"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",color:r,marginBottom:"0.75rem"},children:[a,e.jsx("span",{style:{fontWeight:"600",fontSize:"1rem"},children:t})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"150px 1fr",gap:"1rem",marginBottom:"0.75rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Amount (£)"}),e.jsx("input",{type:"number",step:"0.01",className:"form-input",placeholder:"0.00",value:x,onChange:v=>o(v.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Reason / Description"}),e.jsx("input",{type:"text",className:"form-input",placeholder:`e.g., ${t} expense description`,value:d,onChange:v=>w(v.target.value)})]})]}),parseFloat(x)>0&&e.jsxs("div",{style:{display:"flex",gap:"1.5rem",flexWrap:"wrap",paddingTop:"0.75rem",borderTop:`1px solid ${n}`},children:[e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"0.5rem",cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:f,onChange:v=>T(v.target.checked),style:{width:"16px",height:"16px",accentColor:r}}),e.jsx("span",{style:{fontSize:"0.85rem",color:r},children:"Chargeable to Customer"})]}),b(["admin","supplier_pm"])&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.85rem",color:r},children:"Paid by:"}),e.jsxs("select",{value:R,onChange:v=>u(v.target.value),style:{padding:"0.25rem 0.5rem",borderRadius:"4px",border:`1px solid ${n}`,fontSize:"0.85rem",backgroundColor:"#fff"},children:[e.jsx("option",{value:"supplier",children:"Supplier (JT)"}),e.jsx("option",{value:"partner",children:"Partner"})]})]})]})]})}function ws({newExpense:t,setNewExpense:a,availableResources:l,hasRole:r,handleAdd:n,handleFileSelect:x,removeFile:d,uploadingFiles:f,onCancel:R}){return e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem",border:"2px solid var(--primary)"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Add New Expenses"}),e.jsx("p",{style:{color:"#64748b",fontSize:"0.9rem",marginBottom:"1rem"},children:"Enter amounts for any categories that apply. Leave blank to skip a category."}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem",marginBottom:"1.5rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Resource Name *"}),e.jsxs("select",{className:"form-input",value:t.resource_id,onChange:o=>a({...t,resource_id:o.target.value}),children:[e.jsx("option",{value:"",children:"Select Resource"}),l.map(o=>e.jsx("option",{value:o.id,children:o.name},o.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Date *"}),e.jsx("input",{type:"date",className:"form-input",value:t.expense_date,onChange:o=>a({...t,expense_date:o.target.value})})]})]}),e.jsx(Ne,{category:"Travel",icon:e.jsx(ue,{size:20}),bgColor:"#dbeafe",textColor:"#2563eb",borderColor:"#93c5fd",amount:t.travel_amount,reason:t.travel_reason,chargeable:t.travel_chargeable,procurement:t.travel_procurement,onAmountChange:o=>a({...t,travel_amount:o}),onReasonChange:o=>a({...t,travel_reason:o}),onChargeableChange:o=>a({...t,travel_chargeable:o}),onProcurementChange:o=>a({...t,travel_procurement:o}),hasRole:r}),e.jsx(Ne,{category:"Accommodation",icon:e.jsx(me,{size:20}),bgColor:"#f3e8ff",textColor:"#7c3aed",borderColor:"#d8b4fe",amount:t.accommodation_amount,reason:t.accommodation_reason,chargeable:t.accommodation_chargeable,procurement:t.accommodation_procurement,onAmountChange:o=>a({...t,accommodation_amount:o}),onReasonChange:o=>a({...t,accommodation_reason:o}),onChargeableChange:o=>a({...t,accommodation_chargeable:o}),onProcurementChange:o=>a({...t,accommodation_procurement:o}),hasRole:r}),e.jsx(Ne,{category:"Sustenance",icon:e.jsx(he,{size:20}),bgColor:"#ffedd5",textColor:"#ea580c",borderColor:"#fdba74",amount:t.sustenance_amount,reason:t.sustenance_reason,chargeable:t.sustenance_chargeable,procurement:t.sustenance_procurement,onAmountChange:o=>a({...t,sustenance_amount:o}),onReasonChange:o=>a({...t,sustenance_reason:o}),onChargeableChange:o=>a({...t,sustenance_chargeable:o}),onProcurementChange:o=>a({...t,sustenance_procurement:o}),hasRole:r}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{className:"form-label",children:"Additional Notes"}),e.jsx("textarea",{className:"form-input",rows:2,placeholder:"Any additional information...",value:t.notes,onChange:o=>a({...t,notes:o.target.value})})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{className:"form-label",children:"Attach Receipts"}),e.jsxs("div",{style:{border:"2px dashed #d1d5db",borderRadius:"8px",padding:"1.5rem",textAlign:"center",cursor:"pointer",backgroundColor:"#f9fafb"},onClick:()=>document.getElementById("file-upload").click(),children:[e.jsx(oe,{size:24,style:{color:"#9ca3af",marginBottom:"0.5rem"}}),e.jsx("div",{style:{color:"#64748b",fontSize:"0.85rem"},children:"Click to upload receipts"}),e.jsx("input",{id:"file-upload",type:"file",multiple:!0,accept:".pdf,.jpg,.jpeg,.png,.zip",style:{display:"none"},onChange:x})]}),t.files.length>0&&e.jsx("div",{style:{marginTop:"0.5rem"},children:t.files.map((o,w)=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.25rem 0",fontSize:"0.85rem"},children:[e.jsx(os,{size:14}),e.jsx("span",{style:{flex:1},children:o.name}),e.jsx("button",{onClick:()=>d(w),style:{background:"none",border:"none",cursor:"pointer",color:"#ef4444"},children:e.jsx(W,{size:14})})]},w))})]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsxs("button",{className:"btn btn-primary",onClick:n,disabled:f,children:[e.jsx($e,{size:16})," ",f?"Uploading...":"Save Expenses"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:R,children:[e.jsx(W,{size:16})," Cancel"]})]})]})}const As={Draft:"Draft",Submitted:"Submitted",Approved:"Validated",Rejected:"Rejected",Paid:"Paid"};function ks(t){switch(t){case"Travel":return e.jsx(ue,{size:14});case"Accommodation":return e.jsx(me,{size:14});case"Sustenance":return e.jsx(he,{size:14});default:return e.jsx(se,{size:14})}}function Ps(t){switch(t){case"Travel":return"category-travel";case"Accommodation":return"category-accommodation";case"Sustenance":return"category-sustenance";default:return"category-default"}}function Es(t){switch(t){case"Approved":case"Paid":return"status-validated";case"Submitted":return"status-submitted";case"Rejected":return"status-rejected";default:return"status-draft"}}function Is(t){return t==="partner"?"procurement-partner":"procurement-supplier"}function Ts({expense:t,showProcurement:a,setDetailModal:l}){const r=t.chargeable_to_customer!==!1,n=t.expense_files?.length>0;return e.jsxs("tr",{onClick:()=>l({isOpen:!0,expense:t}),children:[e.jsx("td",{className:"cell-ref",children:t.expense_ref||"-"}),e.jsx("td",{children:e.jsxs("span",{className:`category-badge ${Ps(t.category)}`,children:[ks(t.category),e.jsx("span",{children:t.category})]})}),e.jsx("td",{className:"cell-resource",children:t.resource_name}),e.jsx("td",{className:"cell-date",children:new Date(t.expense_date).toLocaleDateString("en-GB")}),e.jsx("td",{className:"cell-reason",children:e.jsx("span",{className:"reason-text",children:t.reason})}),e.jsxs("td",{className:"cell-amount",children:["£",parseFloat(t.amount).toFixed(2)]}),e.jsx("td",{children:e.jsxs("span",{className:`chargeable-badge ${r?"chargeable-yes":"chargeable-no"}`,children:[r?e.jsx(Z,{size:12}):e.jsx(W,{size:12}),e.jsx("span",{children:r?"Yes":"No"})]})}),a&&e.jsx("td",{children:e.jsxs("span",{className:`procurement-badge ${Is(t.procurement_method)}`,children:[(t.procurement_method||"supplier")==="partner"?e.jsx(Be,{size:12}):e.jsx(Le,{size:12}),e.jsx("span",{children:(t.procurement_method||"supplier")==="partner"?"Partner":"Supplier"})]})}),e.jsx("td",{children:e.jsx("span",{className:`status-badge ${Es(t.status)}`,children:As[t.status]||t.status})}),e.jsx("td",{className:"cell-receipts",children:n&&e.jsxs("span",{className:"receipts-indicator",children:[e.jsx(Me,{size:14}),e.jsx("span",{children:t.expense_files.length})]})})]})}function Ds({expenses:t,hasRole:a,setDetailModal:l}){const r=a(["admin","supplier_pm"]);return e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"expense-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Ref"}),e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Resource"}),e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Reason"}),e.jsx("th",{className:"text-right",children:"Amount"}),e.jsx("th",{children:"Chargeable"}),r&&e.jsx("th",{children:"Procured By"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Receipts"})]})}),e.jsx("tbody",{children:t.length===0?e.jsx("tr",{className:"empty-row",children:e.jsx("td",{colSpan:r?10:9,children:e.jsxs("div",{className:"empty-state",children:[e.jsx(se,{size:32}),e.jsx("p",{children:"No expenses found"})]})})}):t.map(n=>e.jsx(Ts,{expense:n,showProcurement:r,setDetailModal:l},n.id))})]})})}const zs=["Travel","Accommodation","Sustenance"],Fs=["Draft","Submitted","Approved","Rejected","Paid"],Ie={Draft:"Draft",Submitted:"Submitted",Approved:"Validated",Rejected:"Rejected",Paid:"Paid"};function Os(t){switch(t){case"Travel":return e.jsx(ue,{size:20});case"Accommodation":return e.jsx(me,{size:20});case"Sustenance":return e.jsx(he,{size:20});default:return e.jsx(se,{size:20})}}function Us(t){switch(t){case"Travel":return"cat-travel";case"Accommodation":return"cat-accommodation";case"Sustenance":return"cat-sustenance";default:return"cat-default"}}function $s(t){switch(t){case"Approved":case"Paid":return"stat-validated";case"Submitted":return"stat-submitted";case"Rejected":return"stat-rejected";default:return"stat-draft"}}function Bs(t){const{data:a}=U.storage.from("receipts").getPublicUrl(t);return a?.publicUrl||null}function Te(t){const a=[".jpg",".jpeg",".png",".gif",".webp",".bmp",".svg"],l=t.toLowerCase().substring(t.lastIndexOf("."));return a.includes(l)}function Ls({files:t,onDownload:a}){const[l,r]=h.useState(null),[n,x]=h.useState({});return h.useEffect(()=>{const d={};t.forEach(f=>{Te(f.file_name)&&(d[f.id||f.file_path]=Bs(f.file_path))}),x(d)},[t]),!t||t.length===0?null:e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"receipts-section",children:[e.jsxs("div",{className:"section-label",children:[e.jsx(Me,{size:16}),e.jsxs("span",{children:["Receipts (",t.length,")"]})]}),e.jsx("div",{className:"receipts-grid",children:t.map((d,f)=>{const R=d.id||d.file_path,o=n[R],w=Te(d.file_name);return e.jsxs("div",{className:"receipt-item",children:[w&&o?e.jsxs("div",{className:"receipt-image-container",onClick:()=>r({url:o,name:d.file_name}),children:[e.jsx("img",{src:o,alt:d.file_name,className:"receipt-thumbnail"}),e.jsx("div",{className:"receipt-overlay",children:e.jsx(gs,{size:20})})]}):e.jsx("div",{className:"receipt-file-icon",onClick:()=>a(d.file_path,d.file_name),children:e.jsx(se,{size:24})}),e.jsxs("div",{className:"receipt-info",children:[e.jsx("span",{className:"receipt-name",title:d.file_name,children:d.file_name.length>20?d.file_name.substring(0,17)+"...":d.file_name}),e.jsx("button",{className:"receipt-download",onClick:T=>{T.stopPropagation(),a(d.file_path,d.file_name)},title:"Download",children:e.jsx(xs,{size:14})})]})]},f)})})]}),l&&e.jsx("div",{className:"image-modal-overlay",onClick:()=>r(null),children:e.jsxs("div",{className:"image-modal-content",onClick:d=>d.stopPropagation(),children:[e.jsx("button",{className:"image-modal-close",onClick:()=>r(null),children:e.jsx(W,{size:24})}),e.jsx("img",{src:l.url,alt:l.name,className:"image-modal-img"}),e.jsx("div",{className:"image-modal-caption",children:l.name})]})})]})}function Ms({isOpen:t,expense:a,resources:l,hasRole:r,canEditChargeable:n,canSubmitExpense:x,canValidateExpense:d,canEditExpense:f,canDeleteExpense:R,onClose:o,onSave:w,onSubmit:T,onValidate:u,onReject:b,onDelete:v,onDownloadFile:$}){const[B,D]=h.useState(!1),[N,I]=h.useState({});if(h.useEffect(()=>{a&&(I({category:a.category,resource_id:a.resource_id,expense_date:a.expense_date,reason:a.reason,amount:a.amount,notes:a.notes||"",status:a.status,chargeable_to_customer:a.chargeable_to_customer!==!1,procurement_method:a.procurement_method||"supplier"}),D(!1))},[a]),!t||!a)return null;const C=a.chargeable_to_customer!==!1;async function q(){await w(a.id,N),D(!1)}function L(){D(!1),o()}return e.jsx("div",{className:"modal-overlay",onClick:L,children:e.jsxs("div",{className:"modal-container",onClick:p=>p.stopPropagation(),children:[e.jsxs("header",{className:"modal-header",children:[e.jsxs("div",{className:"modal-header-left",children:[e.jsx("div",{className:`modal-icon ${Us(a.category)}`,children:Os(a.category)}),e.jsxs("div",{className:"modal-title-group",children:[e.jsx("h2",{children:a.expense_ref||"Expense Details"}),e.jsxs("span",{children:[a.category," Expense"]})]})]}),e.jsxs("div",{className:"modal-header-right",children:[e.jsx("span",{className:`modal-status ${$s(a.status)}`,children:Ie[a.status]||a.status}),e.jsx("button",{className:"modal-close",onClick:L,children:e.jsx(W,{size:20})})]})]}),e.jsx("div",{className:"modal-body",children:B?e.jsxs("div",{className:"edit-form",children:[e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Category"}),e.jsx("select",{value:N.category,onChange:p=>I({...N,category:p.target.value}),children:zs.map(p=>e.jsx("option",{value:p,children:p},p))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Resource"}),e.jsxs("select",{value:N.resource_id||"",onChange:p=>I({...N,resource_id:p.target.value}),children:[e.jsx("option",{value:"",children:"-- Select --"}),l.map(p=>e.jsx("option",{value:p.id,children:p.name},p.id))]})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Date"}),e.jsx("input",{type:"date",value:N.expense_date,onChange:p=>I({...N,expense_date:p.target.value})})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Amount (£)"}),e.jsx("input",{type:"number",step:"0.01",value:N.amount,onChange:p=>I({...N,amount:p.target.value})})]})]}),e.jsxs("div",{className:"form-group full-width",children:[e.jsx("label",{children:"Reason"}),e.jsx("input",{type:"text",value:N.reason,onChange:p=>I({...N,reason:p.target.value})})]}),e.jsxs("div",{className:"form-group full-width",children:[e.jsx("label",{children:"Notes"}),e.jsx("textarea",{rows:3,value:N.notes,onChange:p=>I({...N,notes:p.target.value})})]}),e.jsxs("div",{className:"form-row",children:[n()&&e.jsxs("label",{className:"checkbox-label",children:[e.jsx("input",{type:"checkbox",checked:N.chargeable_to_customer,onChange:p=>I({...N,chargeable_to_customer:p.target.checked})}),e.jsx("span",{children:"Chargeable to Customer"})]}),r(["admin","supplier_pm"])&&e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Procurement"}),e.jsxs("select",{value:N.procurement_method,onChange:p=>I({...N,procurement_method:p.target.value}),children:[e.jsx("option",{value:"supplier",children:"Supplier"}),e.jsx("option",{value:"partner",children:"Partner"})]})]})]}),d(a)&&e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Status"}),e.jsx("select",{value:N.status,onChange:p=>I({...N,status:p.target.value}),children:Fs.map(p=>e.jsx("option",{value:p,children:Ie[p]||p},p))})]})]}):e.jsxs("div",{className:"view-content",children:[e.jsxs("div",{className:"details-grid",children:[e.jsxs("div",{className:"detail-item",children:[e.jsx(ds,{size:18}),e.jsxs("div",{children:[e.jsx("span",{className:"detail-label",children:"Resource"}),e.jsx("span",{className:"detail-value",children:a.resource_name||"Unknown"})]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx(us,{size:18}),e.jsxs("div",{children:[e.jsx("span",{className:"detail-label",children:"Date"}),e.jsx("span",{className:"detail-value",children:new Date(a.expense_date).toLocaleDateString("en-GB")})]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx(ms,{size:18}),e.jsxs("div",{children:[e.jsx("span",{className:"detail-label",children:"Amount"}),e.jsxs("span",{className:"detail-value amount",children:["£",parseFloat(a.amount).toFixed(2)]})]})]}),e.jsxs("div",{className:"detail-item",children:[C?e.jsx(Pe,{size:18,className:"icon-success"}):e.jsx(W,{size:18,className:"icon-warning"}),e.jsxs("div",{children:[e.jsx("span",{className:"detail-label",children:"Chargeable"}),e.jsx("span",{className:`detail-value ${C?"text-success":"text-warning"}`,children:C?"Yes":"No"})]})]})]}),e.jsxs("div",{className:"info-section",children:[e.jsx("span",{className:"section-label",children:"Reason"}),e.jsx("p",{className:"section-content",children:a.reason||"No reason provided"})]}),a.notes&&e.jsxs("div",{className:"info-section",children:[e.jsx("span",{className:"section-label",children:"Notes"}),e.jsx("p",{className:"section-content secondary",children:a.notes})]}),r(["admin","supplier_pm"])&&e.jsxs("div",{className:"info-section inline",children:[(a.procurement_method||"supplier")==="partner"?e.jsx(Be,{size:18,className:"icon-purple"}):e.jsx(Le,{size:18,className:"icon-blue"}),e.jsxs("div",{children:[e.jsx("span",{className:"section-label",children:"Procured By"}),e.jsx("span",{className:"section-content",children:(a.procurement_method||"supplier")==="partner"?"Partner (Reimbursable)":"Supplier (JT Direct)"})]})]}),e.jsx(Ls,{files:a.expense_files||[],onDownload:$}),e.jsxs("div",{className:"timestamps",children:[e.jsxs("span",{children:[e.jsx(Ee,{size:14})," Created: ",a.created_at?new Date(a.created_at).toLocaleString("en-GB"):"Unknown"]}),a.updated_at&&a.updated_at!==a.created_at&&e.jsxs("span",{children:[e.jsx(Ee,{size:14})," Updated: ",new Date(a.updated_at).toLocaleString("en-GB")]})]})]})}),e.jsxs("footer",{className:"modal-footer",children:[e.jsx("div",{className:"footer-left",children:R(a)&&!B&&e.jsxs("button",{onClick:()=>{v(a),L()},className:"btn btn-danger",children:[e.jsx(Ue,{size:16})," Delete"]})}),e.jsx("div",{className:"footer-right",children:B?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>D(!1),className:"btn btn-secondary",children:"Cancel"}),e.jsxs("button",{onClick:q,className:"btn btn-primary",children:[e.jsx($e,{size:16})," Save Changes"]})]}):e.jsxs(e.Fragment,{children:[x(a)&&e.jsxs("button",{onClick:()=>{T(a),L()},className:"btn btn-secondary",children:[e.jsx(hs,{size:16})," Submit"]}),d(a)&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>{b(a.id),L()},className:"btn btn-danger",children:[e.jsx(W,{size:16})," Reject"]}),e.jsxs("button",{onClick:()=>{u(a.id),L()},className:"btn btn-success",children:[e.jsx(Pe,{size:16})," Validate"]})]}),f(a)&&e.jsxs("button",{onClick:()=>D(!0),className:"btn btn-primary",children:[e.jsx(ps,{size:16})," Edit"]})]})})]})]})})}const Gs=20520,De={resource_id:"",expense_date:new Date().toISOString().split("T")[0],travel_amount:"",travel_reason:"",travel_chargeable:!0,travel_procurement:"supplier",accommodation_amount:"",accommodation_reason:"",accommodation_chargeable:!0,accommodation_procurement:"supplier",sustenance_amount:"",sustenance_reason:"",sustenance_chargeable:!0,sustenance_procurement:"supplier",notes:"",files:[]};function Ks(){const{user:t}=ze(),{projectId:a}=Fe(),{showSuccess:l,showError:r,showWarning:n}=Oe(),{showTestUsers:x,testUserIds:d}=ss(),f=t?.id||null,{canAddExpense:R,canSubmitExpense:o,canValidateExpense:w,canEditExpense:T,canDeleteExpense:u,getAvailableResources:b,hasRole:v}=as(),[$,B]=h.useState([]),[D,N]=h.useState([]),[I,C]=h.useState(!0),[q,L]=h.useState(!1),[p,J]=h.useState(!1),[X,ae]=h.useState("form"),[pe,ce]=h.useState(!1),[g,Q]=h.useState(De),[z,ge]=h.useState("all"),[te,xe]=h.useState("all"),[ee,je]=h.useState("all"),[K,fe]=h.useState("all"),[re,be]=h.useState("all"),[s,c]=h.useState({isOpen:!1,expenseId:null,expenseData:null}),[j,A]=h.useState({isOpen:!1,expense:null}),[m,_]=h.useState({isOpen:!1,expenseId:null}),[M,G]=h.useState({isOpen:!1,expense:null}),k=h.useCallback(async()=>{if(a){C(!0);try{const i=await V.getAllFiltered(a,x);B(i);const{data:S}=await U.from("resources").select("id, name, email, user_id, partner_id, partner:partners(id, name)").order("name");let F=S||[];!x&&d?.length>0&&(F=F.filter(O=>!O.user_id||!d.includes(O.user_id))),N(F)}catch{r("Failed to load expenses")}finally{C(!1),L(!1)}}},[a,x,d,r]);h.useEffect(()=>{k()},[k]);async function P(){L(!0),await k()}async function H(){if(!g.resource_id){n("Please select a resource");return}const i=parseFloat(g.travel_amount)>0,S=parseFloat(g.accommodation_amount)>0,F=parseFloat(g.sustenance_amount)>0;if(!i&&!S&&!F){n("Please enter at least one expense amount");return}if(i&&!g.travel_reason){n("Please enter a reason for the travel expense");return}if(S&&!g.accommodation_reason){n("Please enter a reason for the accommodation expense");return}if(F&&!g.sustenance_reason){n("Please enter a reason for the sustenance expense");return}try{const O=D.find(ye=>ye.id===g.resource_id)?.name,Y=[];i&&Y.push({project_id:a,category:"Travel",resource_id:g.resource_id,resource_name:O,expense_date:g.expense_date,reason:g.travel_reason,amount:parseFloat(g.travel_amount),notes:g.notes,created_by:f,chargeable_to_customer:g.travel_chargeable,procurement_method:g.travel_procurement}),S&&Y.push({project_id:a,category:"Accommodation",resource_id:g.resource_id,resource_name:O,expense_date:g.expense_date,reason:g.accommodation_reason,amount:parseFloat(g.accommodation_amount),notes:g.notes,created_by:f,chargeable_to_customer:g.accommodation_chargeable,procurement_method:g.accommodation_procurement}),F&&Y.push({project_id:a,category:"Sustenance",resource_id:g.resource_id,resource_name:O,expense_date:g.expense_date,reason:g.sustenance_reason,amount:parseFloat(g.sustenance_amount),notes:g.notes,created_by:f,chargeable_to_customer:g.sustenance_chargeable,procurement_method:g.sustenance_procurement});const Re=await V.createMany(Y);if(g.files.length>0&&Re){ce(!0);for(const ye of Re)for(const es of g.files)try{await V.uploadReceipt(ye.id,es,f)}catch{}ce(!1)}await k(),J(!1),Q(De),l("Expenses added successfully!")}catch(O){r("Failed to add expenses: "+O.message)}}async function Se(i){try{await V.create({project_id:a,category:i.category,resource_id:i.resource_id,resource_name:i.resource_name,expense_date:i.expense_date,reason:i.reason,amount:i.amount,notes:i.notes,created_by:f,chargeable_to_customer:i.chargeable_to_customer,procurement_method:i.procurement_method}),await k()}catch(S){r("Failed to create expense: "+S.message)}}function le(i){c({isOpen:!0,expenseId:i.id,expenseData:{resourceName:i.resource_name,date:i.expense_date,totalAmount:parseFloat(i.amount||0),category:i.category,chargeable:i.chargeable_to_customer,procurement:i.procurement_method,status:i.status}})}async function Ge(){if(s.expenseId)try{await V.delete(s.expenseId,f),await k(),c({isOpen:!1,expenseId:null,expenseData:null}),l("Expense deleted")}catch(i){r("Failed to delete: "+i.message)}}function Ye(i){A({isOpen:!0,expense:i})}async function Ve(){if(j.expense)try{await V.submit(j.expense.id),A({isOpen:!1,expense:null}),await k(),l("Expense submitted for validation!")}catch(i){r("Failed to submit: "+i.message)}}async function qe(i){try{await V.validate(i),await k(),l("Expense validated!")}catch(S){r("Failed to validate: "+S.message)}}function We(i){_({isOpen:!0,expenseId:i})}async function He(i){if(m.expenseId)try{await V.reject(m.expenseId,i),_({isOpen:!1,expenseId:null}),await k(),n("Expense rejected")}catch(S){r("Failed to reject: "+S.message)}}function Je(i){const S=Array.from(i.target.files);Q({...g,files:[...g.files,...S]})}function Xe(i){Q({...g,files:g.files.filter((S,F)=>F!==i)})}async function Ke(i,S){try{const F=await V.downloadReceipt(i),O=URL.createObjectURL(F),Y=document.createElement("a");Y.href=O,Y.download=S,document.body.appendChild(Y),Y.click(),document.body.removeChild(Y),URL.revokeObjectURL(O)}catch{r("Failed to download file")}}function Ze(){return v(["admin","supplier_pm","customer_pm"])}const ve=$.filter(i=>!(z!=="all"&&i.category!==z||te!=="all"&&i.resource_name!==te||ee!=="all"&&i.status!==ee||K==="chargeable"&&i.chargeable_to_customer===!1||K==="non-chargeable"&&i.chargeable_to_customer!==!1||re!=="all"&&(i.procurement_method||"supplier")!==re)),ie=b(D),Qe=[...new Set($.map(i=>i.resource_name))];return I&&!a?e.jsx(ts,{message:"Loading expenses...",size:"large",fullPage:!0}):e.jsxs("div",{className:"expenses-page",children:[e.jsx("header",{className:"exp-header",children:e.jsxs("div",{className:"exp-header-content",children:[e.jsxs("div",{className:"exp-header-left",children:[e.jsx("div",{className:"exp-header-icon",children:e.jsx(se,{size:24})}),e.jsxs("div",{children:[e.jsx("h1",{children:"Expenses"}),e.jsxs("p",{children:["Track project expenses against £",Gs.toLocaleString()," budget"]})]})]}),e.jsxs("div",{className:"exp-header-actions",children:[e.jsxs("button",{className:"exp-btn exp-btn-secondary",onClick:P,disabled:q,children:[e.jsx(js,{size:16,className:q?"spinning":""})," Refresh"]}),R&&!p&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"exp-btn exp-btn-primary",onClick:()=>{ae("form"),J(!0)},children:[e.jsx(fs,{size:16})," Add Expenses"]}),e.jsxs("button",{className:"exp-btn exp-btn-scanner",onClick:()=>{ae("scanner"),J(!0)},title:"Scan a receipt with AI",children:[e.jsx(Ce,{size:16})," ",e.jsx(de,{size:12})," Scan Receipt"]})]})]})]})}),e.jsxs("div",{className:"exp-content",children:[e.jsx(Rs,{filterCategory:z,setFilterCategory:ge,filterResource:te,setFilterResource:xe,filterStatus:ee,setFilterStatus:je,filterChargeable:K,setFilterChargeable:fe,filterProcurement:re,setFilterProcurement:be,resourceNames:Qe,hasRole:v}),p&&X==="form"&&e.jsx(ws,{newExpense:g,setNewExpense:Q,availableResources:ie,hasRole:v,handleAdd:H,handleFileSelect:Je,removeFile:Xe,uploadingFiles:pe,onCancel:()=>J(!1)}),p&&X==="scanner"&&e.jsx("div",{className:"exp-scanner-wrapper",children:e.jsx(_s,{resources:ie,defaultResourceId:ie.length===1?ie[0].id:null,onExpenseCreated:Se,onCancel:()=>{J(!1),ae("form")}})}),e.jsxs("div",{className:"exp-table-card",children:[e.jsxs("div",{className:"exp-table-header",children:[e.jsx("h2",{className:"exp-table-title",children:"Expense Entries"}),e.jsxs("span",{className:"exp-table-count",children:[ve.length," expense",ve.length!==1?"s":""]})]}),e.jsx(Ds,{expenses:ve,hasRole:v,setDetailModal:G})]})]}),e.jsx(we,{isOpen:s.isOpen,onClose:()=>c({isOpen:!1,expenseId:null,expenseData:null}),onConfirm:Ge,title:"Delete Expense",message:s.expenseData?e.jsxs("div",{children:[e.jsx("p",{children:"Are you sure you want to delete this expense?"}),e.jsxs("div",{style:{backgroundColor:"#fef3c7",border:"1px solid #f59e0b",borderRadius:"8px",padding:"12px",marginTop:"12px"},children:[e.jsx("p",{style:{fontWeight:"600",color:"#92400e",margin:"0 0 8px 0",fontSize:"14px"},children:"Details:"}),e.jsxs("ul",{style:{margin:"0",paddingLeft:"20px",color:"#92400e",fontSize:"13px",lineHeight:"1.6"},children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Resource:"})," ",s.expenseData.resourceName]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Category:"})," ",s.expenseData.category]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Amount:"})," £",s.expenseData.totalAmount?.toFixed(2)]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Status:"})," ",s.expenseData.status]})]})]})]}):"Are you sure you want to delete this expense?",confirmText:"Delete",cancelText:"Cancel",type:"danger"}),e.jsx(we,{isOpen:j.isOpen,onClose:()=>A({isOpen:!1,expense:null}),onConfirm:Ve,title:"Submit for Validation",message:j.expense?e.jsxs(e.Fragment,{children:["Submit this expense for validation?",e.jsx("br",{}),e.jsx("br",{}),e.jsx("strong",{children:j.expense.category})," - £",parseFloat(j.expense.amount||0).toFixed(2),e.jsx("br",{}),j.expense.resource_name]}):"",confirmText:"Submit",cancelText:"Cancel",type:"info"}),e.jsx(Ms,{isOpen:M.isOpen,expense:M.expense,resources:D,hasRole:v,canEditChargeable:Ze,canSubmitExpense:o,canValidateExpense:w,canEditExpense:T,canDeleteExpense:u,onClose:()=>G({isOpen:!1,expense:null}),onSave:async(i,S)=>{const F=D.find(O=>O.id===S.resource_id)?.name||S.resource_name;await V.update(i,{category:S.category,resource_id:S.resource_id,resource_name:F,expense_date:S.expense_date,reason:S.reason,amount:parseFloat(S.amount),notes:S.notes,status:S.status,chargeable_to_customer:S.chargeable_to_customer,procurement_method:S.procurement_method}),await k(),l("Expense updated!")},onSubmit:Ye,onValidate:qe,onReject:We,onDelete:le,onDownloadFile:Ke}),e.jsx(rs,{isOpen:m.isOpen,onClose:()=>_({isOpen:!1,expenseId:null}),onConfirm:He,title:"Reject Expense",message:"Please provide a reason for rejecting this expense.",inputLabel:"Rejection Reason",inputPlaceholder:"Enter reason (optional)",confirmText:"Reject",cancelText:"Cancel",type:"warning"})]})}export{Ks as default};
