import{s as L,u as ze,a as Fe,b as Be,j as e,c as ct,e as W,L as lt,P as it,S as q}from"./index-6Z-Teoc9.js";import{r as j}from"./vendor-react-CaXNtsgv.js";import{u as dt}from"./usePermissions-cl9WcJlf.js";import{C as ut}from"./ConfirmDialog-D5ycXPpB.js";import{g as de,a as Q,ag as ge,ah as Re,ai as mt,T as Oe,S as fe,aj as pt,L as Pe,e as K,v as xe,_ as ht,d as Ie,ak as je,al as be,am as ye,t as gt,U as ft,F as xt,y as $e,l as Ue,N as Le,an as jt,b as bt,C as Me,W as yt,V as vt}from"./vendor-icons--BgpcKrK.js";import"./vendor-supabase-qY1sfceY.js";import"./vendor-charts-_mIYJ_kN.js";const _t={uber:"Travel",lyft:"Travel",taxi:"Travel",train:"Travel",rail:"Travel",airlines:"Travel",airways:"Travel",petrol:"Travel","gas station":"Travel",fuel:"Travel",parking:"Travel",hotel:"Accommodation",inn:"Accommodation",motel:"Accommodation",airbnb:"Accommodation","booking.com":"Accommodation",marriott:"Accommodation",hilton:"Accommodation","premier inn":"Accommodation",travelodge:"Accommodation",restaurant:"Sustenance",cafe:"Sustenance",coffee:"Sustenance",costa:"Sustenance",starbucks:"Sustenance",pret:"Sustenance",greggs:"Sustenance",mcdonald:"Sustenance",subway:"Sustenance",nando:"Sustenance",pizza:"Sustenance",pub:"Sustenance",bar:"Sustenance",food:"Sustenance",supermarket:"Sustenance",tesco:"Sustenance",sainsbury:"Sustenance","co-op":"Sustenance",waitrose:"Sustenance",aldi:"Sustenance",lidl:"Sustenance"};class St{constructor(){this.bucketName="receipt-scans"}async uploadImage(o,s){try{if(!["image/jpeg","image/png","image/webp","image/heic"].includes(o.type))throw new Error("Invalid file type. Please upload a JPEG, PNG, or WebP image.");const c=10*1024*1024;if(o.size>c)throw new Error("File too large. Maximum size is 10MB.");const u=Date.now(),x=o.name.split(".").pop(),S=`${s}/${u}.${x}`,{error:_}=await L.storage.from(this.bucketName).upload(S,o);if(_)throw _;const{data:{publicUrl:i}}=L.storage.from(this.bucketName).getPublicUrl(S);return{path:S,url:i}}catch(n){throw n}}async processReceipt(o,s){const n=Date.now();try{const c=await this.callClaudeVision(o);let u=await this.findClassificationRule(s,c.merchant);u||(u=this.classifyFromPatterns(c.merchant),!u&&c.aiSuggestedCategory&&(u={category:c.aiSuggestedCategory,confidence:c.aiConfidence||.6}));const x=Date.now()-n;return{...c,suggestedCategory:u?.category||null,confidence:u?.confidence||0,ruleBasedClassification:!!u?.ruleId,processingTimeMs:x}}catch(c){throw c}}async fetchImageAsBase64(o){try{const n=await(await fetch(o)).blob();return new Promise((c,u)=>{const x=new FileReader;x.onloadend=()=>{const S=x.result.split(",")[1];c({data:S,mediaType:n.type})},x.onerror=u,x.readAsDataURL(n)})}catch(s){throw s}}async callClaudeVision(o){const s=`Analyze this receipt image and extract the following information in JSON format:
{
  "merchant": "Store/vendor name",
  "amount": 0.00,
  "currency": "GBP",
  "date": "YYYY-MM-DD",
  "items": [{"name": "item name", "quantity": 1, "price": 0.00}],
  "paymentMethod": "card/cash/unknown",
  "category": "Travel/Accommodation/Sustenance",
  "confidence": 0.0 to 1.0,
  "rawText": "All visible text from receipt"
}

If any field cannot be determined, use null. For the category, consider:
- Travel: transport, fuel, parking, flights, trains, taxis
- Accommodation: hotels, lodging, rentals
- Sustenance: food, drinks, restaurants, cafes, supermarkets

Be conservative with confidence - only use high values (>0.8) when very certain.`;try{const n=await fetch("/api/scan-receipt",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({image:o,prompt:s})});if(!n.ok)throw new Error("Failed to process receipt with AI");const c=await n.json();return{merchant:c.merchant,amount:c.amount,currency:c.currency||"GBP",date:c.date,items:c.items||[],paymentMethod:c.paymentMethod,aiSuggestedCategory:c.category,aiConfidence:c.confidence,rawText:c.rawText}}catch(n){return{merchant:null,amount:null,currency:"GBP",date:null,items:[],paymentMethod:null,aiSuggestedCategory:null,aiConfidence:0,rawText:null,error:n.message}}}async findClassificationRule(o,s){if(!s)return null;try{const{data:n,error:c}=await L.rpc("find_classification_rule",{p_project_id:o,p_merchant:s});if(c)throw c;return n&&n.length>0?{ruleId:n[0].rule_id,category:n[0].category,subcategory:n[0].subcategory,defaultChargeable:n[0].default_chargeable,defaultProcurement:n[0].default_procurement,confidence:parseFloat(n[0].confidence)}:null}catch{return null}}classifyFromPatterns(o){if(!o)return null;const s=o.toLowerCase();for(const[n,c]of Object.entries(_t))if(s.includes(n))return{category:c,confidence:.7,source:"pattern"};return null}async learnFromCorrection(o,s,n,c,u=!1){if(!s||!n)return null;try{const{data:x,error:S}=await L.rpc("upsert_classification_rule",{p_project_id:o,p_merchant:s,p_category:n,p_user_id:c,p_was_correction:u});if(S)throw S;return x}catch{return null}}async createScan(o){try{const{data:s,error:n}=await L.from("receipt_scans").insert({project_id:o.projectId,uploaded_by:o.userId,image_url:o.imageUrl,image_path:o.imagePath,raw_ocr_text:o.rawText,extracted_merchant:o.merchant,extracted_amount:o.amount,extracted_date:o.date,extracted_currency:o.currency,extracted_items:o.items,ai_suggested_category:o.suggestedCategory,ai_confidence:o.confidence,status:"completed",processing_time_ms:o.processingTimeMs}).select().single();if(n)throw n;return s}catch(s){throw s}}async updateScanClassification(o,s,n=!1){try{const{data:c,error:u}=await L.from("receipt_scans").update({final_category:s,user_corrected:n}).eq("id",o).select().single();if(u)throw u;return c}catch(c){throw c}}async linkToExpense(o,s){try{const{data:n,error:c}=await L.from("receipt_scans").update({expense_id:s,status:"linked"}).eq("id",o).select().single();if(c)throw c;return n}catch(n){throw n}}async getRecentScans(o,s=10){try{const{data:n,error:c}=await L.from("receipt_scans").select("*").eq("project_id",o).order("created_at",{ascending:!1}).limit(s);if(c)throw c;return n||[]}catch{return[]}}async getUnlinkedScans(o){try{const{data:s,error:n}=await L.from("receipt_scans").select("*").eq("project_id",o).is("expense_id",null).eq("status","completed").order("created_at",{ascending:!1});if(n)throw n;return s||[]}catch{return[]}}async getClassificationRules(o){try{const{data:s,error:n}=await L.from("classification_rules").select("*").eq("project_id",o).order("match_count",{ascending:!1});if(n)throw n;return s||[]}catch{return[]}}async deleteClassificationRule(o){try{const{error:s}=await L.from("classification_rules").delete().eq("id",o);if(s)throw s;return!0}catch{return!1}}}const ie=new St,Ct=[{id:"Travel",label:"Travel",icon:je,color:"#2563eb",bg:"#dbeafe"},{id:"Accommodation",label:"Accommodation",icon:be,color:"#7c3aed",bg:"#f3e8ff"},{id:"Sustenance",label:"Sustenance",icon:ye,color:"#ea580c",bg:"#ffedd5"}],v={PENDING:"pending",PROCESSING:"processing",READY:"ready",SUBMITTED:"submitted",ERROR:"error"},D={UPLOAD:"upload",PROCESSING:"processing",REVIEW:"review"};function Nt({onExpenseCreated:a,onCancel:o,resources:s=[],defaultResourceId:n=null}){const{user:c}=ze(),{projectId:u}=Fe(),{showSuccess:x,showError:S,showWarning:_,showInfo:i}=Be(),[w,B]=j.useState(D.UPLOAD),[d,g]=j.useState([]),[b,k]=j.useState(0),[A,Y]=j.useState({current:0,total:0}),F=j.useRef(null),H=j.useRef(null),C=d[b];d.filter(t=>t.status===v.READY).length;const E=d.filter(t=>t.status===v.SUBMITTED).length;d.filter(t=>t.status===v.PENDING||t.status===v.PROCESSING).length;const P=(t,l=1500,y=.8)=>new Promise((N,p)=>{const R=new FileReader;R.onload=V=>{const I=new Image;I.onload=()=>{let{width:U,height:T}=I;(U>l||T>l)&&(U>T?(T=Math.round(T*l/U),U=l):(U=Math.round(U*l/T),T=l));const X=document.createElement("canvas");X.width=U,X.height=T,X.getContext("2d").drawImage(I,0,0,U,T),X.toBlob(me=>{me?N(me):p(new Error("Failed to compress image"))},"image/jpeg",y)},I.onerror=()=>p(new Error("Failed to load image")),I.src=V.target.result},R.onerror=p,R.readAsDataURL(t)}),h=async t=>{const l=await P(t);return new Promise((y,N)=>{const p=new FileReader;p.onload=()=>{y({data:p.result.split(",")[1],mediaType:"image/jpeg",preview:p.result})},p.onerror=N,p.readAsDataURL(l)})},Z=(t,l)=>({id:`receipt-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,file:t,preview:l,status:v.PENDING,scanResult:null,scanId:null,imageUrl:null,formData:{merchant:"",amount:"",date:new Date().toISOString().split("T")[0],category:"",resource_id:n||"",reason:"",chargeable:!0,procurement:"supplier",notes:""},wasEdited:!1}),J=j.useCallback(async t=>{const l=Array.from(t.target.files||[]);if(l.length===0)return;const y=["image/jpeg","image/png","image/webp","image/heic"],N=[];for(const R of l){if(!y.includes(R.type)){_(`Skipped ${R.name} - invalid file type`);continue}if(R.size>10*1024*1024){_(`Skipped ${R.name} - file too large (max 10MB)`);continue}N.push(R)}if(N.length===0)return;const p=await Promise.all(N.map(async R=>{const{preview:V}=await h(R);return Z(R,V)}));g(R=>[...R,...p]),i(`Added ${p.length} receipt${p.length>1?"s":""}`)},[_,i,n]),ve=j.useCallback(t=>{t.preventDefault();const l=t.dataTransfer.files;l.length>0&&J({target:{files:l}})},[J]),re=j.useCallback(t=>{t.preventDefault()},[]),O=j.useCallback(t=>{g(l=>{const y=l.filter(N=>N.id!==t);return b>=y.length&&y.length>0&&k(y.length-1),y})},[b]),ae=j.useCallback(()=>{g([]),k(0),B(D.UPLOAD),F.current&&(F.current.value="")},[]),_e=j.useCallback(async()=>{if(d.length===0||!u||!c?.id){S("No receipts to process");return}B(D.PROCESSING),Y({current:0,total:d.length});const t=[...d];for(let p=0;p<t.length;p++){const R=t[p];if(R.status===v.READY||R.status===v.SUBMITTED){Y({current:p+1,total:d.length});continue}t[p]={...R,status:v.PROCESSING},g([...t]);try{const V=await h(R.file),{path:I,url:U}=await ie.uploadImage(R.file,c.id),T=await ie.processReceipt(V,u),X=await ie.createScan({projectId:u,userId:c.id,imageUrl:U,imagePath:I,...T});t[p]={...t[p],status:v.READY,scanResult:T,scanId:X.id,imageUrl:U,formData:{...t[p].formData,merchant:T.merchant||"",amount:T.amount?.toString()||"",date:T.date||new Date().toISOString().split("T")[0],category:T.suggestedCategory||"",reason:T.merchant?`Receipt from ${T.merchant}`:""}}}catch(V){t[p]={...t[p],status:v.ERROR,error:V.message}}g([...t]),Y({current:p+1,total:d.length})}B(D.REVIEW);const l=t.findIndex(p=>p.status===v.READY);l>=0&&k(l);const y=t.filter(p=>p.status===v.READY).length,N=t.filter(p=>p.status===v.ERROR).length;N>0?_(`Processed ${y} receipts, ${N} failed`):x(`Successfully scanned ${y} receipt${y>1?"s":""}!`)},[d,u,c,S,x,_]),$=j.useCallback((t,l)=>{g(y=>{const N=[...y];return N[b]={...N[b],formData:{...N[b].formData,[t]:l},wasEdited:!0},N})},[b]),f=j.useCallback(t=>{$("category",t)},[$]),ee=j.useCallback(t=>{t>=0&&t<d.length&&k(t)},[d.length]),se=j.useCallback(()=>{for(let t=b-1;t>=0;t--)if(d[t].status===v.READY){k(t);return}},[b,d]),ue=j.useCallback(()=>{for(let t=b+1;t<d.length;t++)if(d[t].status===v.READY){k(t);return}},[b,d]),ne=d.slice(0,b).some(t=>t.status===v.READY),oe=d.slice(b+1).some(t=>t.status===v.READY),ce=j.useCallback(async()=>{const t=C;if(!t||t.status!==v.READY)return;const{formData:l}=t;if(!l.resource_id){_("Please select a resource");return}if(!l.amount||parseFloat(l.amount)<=0){_("Please enter a valid amount");return}if(!l.category){_("Please select a category");return}if(!l.reason){_("Please enter a reason/description");return}try{if(l.merchant&&l.category){const p=t.wasEdited&&t.scanResult?.suggestedCategory!==l.category;await ie.learnFromCorrection(u,l.merchant,l.category,c.id,p)}t.scanId&&await ie.updateScanClassification(t.scanId,l.category,t.wasEdited);const y={category:l.category,resource_id:l.resource_id,resource_name:s.find(p=>p.id===l.resource_id)?.name,expense_date:l.date,reason:l.reason,amount:parseFloat(l.amount),notes:l.notes,chargeable_to_customer:l.chargeable,procurement_method:l.procurement,receipt_scan_id:t.scanId,receipt_image_url:t.imageUrl};g(p=>{const R=[...p];return R[b]={...R[b],status:v.SUBMITTED},R}),a&&a(y),x(`Expense created: ${l.merchant||"Receipt"} - Â£${l.amount}`);const N=d.findIndex((p,R)=>R>b&&p.status===v.READY);N>=0&&k(N)}catch(y){S("Failed to create expense: "+y.message)}},[C,b,d,u,c,s,a,x,S,_]),Se=t=>{if(!t)return null;let l,y;return t>=.8?(l="#10b981",y="High"):t>=.5?(l="#f59e0b",y="Medium"):(l="#ef4444",y="Low"),e.jsxs("div",{className:"confidence-badge",style:{color:l,borderColor:l},children:[e.jsx(fe,{size:14}),y," confidence (",Math.round(t*100),"%)"]})},le=t=>{switch(t){case v.PENDING:return e.jsx("div",{className:"status-dot pending"});case v.PROCESSING:return e.jsx(Pe,{size:14,className:"spinner"});case v.READY:return e.jsx("div",{className:"status-dot ready"});case v.SUBMITTED:return e.jsx(K,{size:14,className:"status-check"});case v.ERROR:return e.jsx(xe,{size:14,className:"status-error"});default:return null}};return e.jsxs("div",{className:"receipt-scanner batch-mode",children:[e.jsxs("div",{className:"scanner-header",children:[e.jsxs("div",{className:"scanner-title",children:[e.jsx(de,{size:24}),e.jsxs("div",{children:[e.jsx("h3",{children:"Smart Receipt Scanner"}),e.jsxs("p",{children:[w===D.UPLOAD&&"Upload one or more receipt photos",w===D.PROCESSING&&`Processing ${A.current} of ${A.total}...`,w===D.REVIEW&&`Reviewing ${b+1} of ${d.length} receipts`]})]})]}),o&&e.jsx("button",{className:"btn btn-ghost",onClick:o,children:e.jsx(Q,{size:20})})]}),e.jsxs("div",{className:"scanner-steps",children:[e.jsxs("div",{className:`step ${w===D.UPLOAD?"active":w!==D.UPLOAD?"complete":""}`,children:[e.jsx("div",{className:"step-dot",children:"1"}),e.jsx("span",{children:"Upload"})]}),e.jsx("div",{className:"step-line"}),e.jsxs("div",{className:`step ${w===D.PROCESSING?"active":w===D.REVIEW?"complete":""}`,children:[e.jsx("div",{className:"step-dot",children:"2"}),e.jsx("span",{children:"Scan All"})]}),e.jsx("div",{className:"step-line"}),e.jsxs("div",{className:`step ${w===D.REVIEW?"active":""}`,children:[e.jsx("div",{className:"step-dot",children:"3"}),e.jsx("span",{children:"Review"})]})]}),e.jsxs("div",{className:"scanner-content",children:[w===D.UPLOAD&&e.jsxs("div",{className:"upload-section",children:[e.jsxs("div",{className:"drop-zone",onDrop:ve,onDragOver:re,onClick:()=>F.current?.click(),children:[e.jsx(ge,{size:48,className:"drop-icon"}),e.jsx("p",{className:"drop-text",children:"Drag & drop receipt images"}),e.jsx("p",{className:"drop-subtext",children:"or click to browse (select multiple)"}),e.jsxs("div",{className:"upload-buttons",children:[e.jsxs("button",{className:"btn btn-primary",onClick:t=>{t.stopPropagation(),F.current?.click()},children:[e.jsx(ge,{size:18})," Choose Files"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:t=>{t.stopPropagation(),H.current?.click()},children:[e.jsx(Re,{size:18})," Take Photo"]})]}),e.jsx("input",{ref:F,type:"file",accept:"image/jpeg,image/png,image/webp,image/heic",multiple:!0,onChange:J,style:{display:"none"}}),e.jsx("input",{ref:H,type:"file",accept:"image/*",capture:"environment",onChange:J,style:{display:"none"}})]}),d.length>0&&e.jsxs("div",{className:"receipt-queue",children:[e.jsxs("div",{className:"queue-header",children:[e.jsxs("h4",{children:[e.jsx(mt,{size:18})," ",d.length," Receipt",d.length>1?"s":""," Ready"]}),e.jsxs("button",{className:"btn btn-ghost btn-sm",onClick:ae,children:[e.jsx(Oe,{size:16})," Clear All"]})]}),e.jsxs("div",{className:"queue-grid",children:[d.map((t,l)=>e.jsxs("div",{className:"queue-item",children:[e.jsx("img",{src:t.preview,alt:`Receipt ${l+1}`}),e.jsx("button",{className:"remove-btn",onClick:y=>{y.stopPropagation(),O(t.id)},children:e.jsx(Q,{size:14})}),e.jsx("span",{className:"queue-number",children:l+1})]},t.id)),e.jsxs("div",{className:"queue-item add-more",onClick:()=>F.current?.click(),children:[e.jsx(ge,{size:24}),e.jsx("span",{children:"Add More"})]})]}),e.jsxs("button",{className:"btn btn-primary btn-lg scan-all-btn",onClick:_e,children:[e.jsx(fe,{size:20})," Scan All ",d.length," Receipt",d.length>1?"s":""]})]}),e.jsxs("div",{className:"scanner-tips",children:[e.jsxs("h4",{children:[e.jsx(pt,{size:16})," Tips for best results"]}),e.jsxs("ul",{children:[e.jsx("li",{children:"Ensure receipts are flat and well-lit"}),e.jsx("li",{children:"Include the full receipt in frame"}),e.jsx("li",{children:"Avoid shadows and glare"}),e.jsx("li",{children:"You can select multiple files at once"})]})]})]}),w===D.PROCESSING&&e.jsxs("div",{className:"processing-section batch-processing",children:[e.jsxs("div",{className:"processing-progress",children:[e.jsx("div",{className:"progress-bar",children:e.jsx("div",{className:"progress-fill",style:{width:`${A.current/A.total*100}%`}})}),e.jsxs("span",{className:"progress-text",children:["Processing receipt ",A.current," of ",A.total]})]}),e.jsx("div",{className:"processing-grid",children:d.map((t,l)=>e.jsxs("div",{className:`processing-item ${t.status}`,children:[e.jsx("img",{src:t.preview,alt:`Receipt ${l+1}`}),e.jsxs("div",{className:"processing-overlay",children:[t.status===v.PROCESSING&&e.jsx(Pe,{size:24,className:"spinner"}),t.status===v.READY&&e.jsx(K,{size:24,className:"success-icon"}),t.status===v.ERROR&&e.jsx(xe,{size:24,className:"error-icon"})]}),e.jsx("span",{className:"item-number",children:l+1})]},t.id))})]}),w===D.REVIEW&&C&&e.jsxs("div",{className:"review-section batch-review",children:[e.jsxs("div",{className:"receipt-sidebar",children:[e.jsxs("div",{className:"sidebar-header",children:[e.jsx("h4",{children:"Receipts"}),e.jsxs("span",{className:"sidebar-count",children:[E,"/",d.length," submitted"]})]}),e.jsx("div",{className:"sidebar-list",children:d.map((t,l)=>e.jsxs("div",{className:`sidebar-item ${l===b?"active":""} ${t.status}`,onClick:()=>t.status===v.READY&&ee(l),children:[e.jsx("img",{src:t.preview,alt:`Receipt ${l+1}`}),e.jsxs("div",{className:"sidebar-item-info",children:[e.jsx("span",{className:"item-merchant",children:t.formData.merchant||`Receipt ${l+1}`}),e.jsx("span",{className:"item-amount",children:t.formData.amount?`Â£${t.formData.amount}`:"â€”"})]}),e.jsx("div",{className:"sidebar-item-status",children:le(t.status)})]},t.id))})]}),e.jsx("div",{className:"review-main",children:C.status===v.READY?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"review-header",children:[e.jsxs("button",{className:"btn btn-ghost",onClick:se,disabled:!ne,children:[e.jsx(ht,{size:20})," Previous"]}),e.jsxs("div",{className:"review-position",children:["Receipt ",b+1," of ",d.length]}),e.jsxs("button",{className:"btn btn-ghost",onClick:ue,disabled:!oe,children:["Next ",e.jsx(Ie,{size:20})]})]}),e.jsxs("div",{className:"extraction-summary",children:[e.jsxs("div",{className:"summary-header",children:[e.jsx("h4",{children:"Extracted Information"}),Se(C.scanResult?.confidence)]}),C.scanResult?.ruleBasedClassification&&e.jsxs("div",{className:"rule-notice",children:[e.jsx(fe,{size:14}),"Category auto-selected based on previous receipts"]})]}),e.jsxs("div",{className:"review-form",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Resource *"}),e.jsxs("select",{className:"form-input",value:C.formData.resource_id,onChange:t=>$("resource_id",t.target.value),children:[e.jsx("option",{value:"",children:"Select resource..."}),s.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Category *"}),e.jsx("div",{className:"category-selector",children:Ct.map(t=>{const l=t.icon,y=C.formData.category===t.id;return e.jsxs("button",{type:"button",className:`category-btn ${y?"selected":""}`,style:{"--cat-color":t.color,"--cat-bg":t.bg},onClick:()=>f(t.id),children:[e.jsx(l,{size:20}),t.label,y&&e.jsx(K,{size:16,className:"check-icon"})]},t.id)})})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Merchant"}),e.jsx("input",{type:"text",className:"form-input",value:C.formData.merchant,onChange:t=>$("merchant",t.target.value),placeholder:"Store/vendor name"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Amount (Â£) *"}),e.jsx("input",{type:"number",step:"0.01",className:"form-input",value:C.formData.amount,onChange:t=>$("amount",t.target.value),placeholder:"0.00"})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Date *"}),e.jsx("input",{type:"date",className:"form-input",value:C.formData.date,onChange:t=>$("date",t.target.value)})]}),e.jsxs("div",{className:"form-group",style:{flex:2},children:[e.jsx("label",{className:"form-label",children:"Reason/Description *"}),e.jsx("input",{type:"text",className:"form-input",value:C.formData.reason,onChange:t=>$("reason",t.target.value),placeholder:"Brief description of expense"})]})]}),e.jsxs("div",{className:"form-row options-row",children:[e.jsxs("label",{className:"checkbox-label",children:[e.jsx("input",{type:"checkbox",checked:C.formData.chargeable,onChange:t=>$("chargeable",t.target.checked)}),e.jsx("span",{children:"Chargeable to Customer"})]}),e.jsxs("div",{className:"procurement-toggle",children:[e.jsx("span",{children:"Paid by:"}),e.jsxs("select",{className:"form-input-sm",value:C.formData.procurement,onChange:t=>$("procurement",t.target.value),children:[e.jsx("option",{value:"supplier",children:"Supplier (JT)"}),e.jsx("option",{value:"partner",children:"Partner"})]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Additional Notes"}),e.jsx("textarea",{className:"form-input",rows:2,value:C.formData.notes,onChange:t=>$("notes",t.target.value),placeholder:"Any additional information..."})]})]}),e.jsxs("div",{className:"receipt-thumbnail",children:[e.jsx("img",{src:C.preview,alt:"Receipt"}),e.jsx("span",{children:"Receipt attached"})]}),e.jsxs("div",{className:"review-actions",children:[e.jsxs("button",{className:"btn btn-secondary",onClick:()=>B(D.UPLOAD),children:[e.jsx(gt,{size:18})," Back to Upload"]}),e.jsxs("button",{className:"btn btn-primary btn-lg",onClick:ce,children:[e.jsx(K,{size:18})," Submit Expense",oe&&" & Next"]})]})]}):C.status===v.SUBMITTED?e.jsxs("div",{className:"submitted-message",children:[e.jsx("div",{className:"success-icon-large",children:e.jsx(K,{size:48})}),e.jsx("h3",{children:"Expense Submitted"}),e.jsxs("p",{children:[C.formData.merchant," - Â£",C.formData.amount]}),oe&&e.jsxs("button",{className:"btn btn-primary",onClick:ue,children:["Review Next Receipt ",e.jsx(Ie,{size:18})]})]}):C.status===v.ERROR?e.jsxs("div",{className:"error-message",children:[e.jsx(xe,{size:48,className:"error-icon"}),e.jsx("h3",{children:"Processing Failed"}),e.jsx("p",{children:C.error||"Unable to process this receipt"})]}):null})]}),w===D.REVIEW&&E===d.length&&d.length>0&&e.jsxs("div",{className:"complete-section",children:[e.jsx("div",{className:"success-icon",children:e.jsx(K,{size:48})}),e.jsx("h3",{children:"All Receipts Submitted!"}),e.jsxs("p",{children:[E," expense",E>1?"s":""," created successfully."]}),e.jsxs("div",{className:"complete-actions",children:[e.jsxs("button",{className:"btn btn-primary",onClick:ae,children:[e.jsx(Re,{size:18})," Scan More Receipts"]}),o&&e.jsx("button",{className:"btn btn-secondary",onClick:o,children:"Done"})]})]})]})]})}const Rt=["Travel","Accommodation","Sustenance"],wt=["Draft","Submitted","Approved","Rejected","Paid"],At={Draft:"Draft",Submitted:"Submitted",Approved:"Validated",Rejected:"Rejected",Paid:"Paid"};function Tt({filterCategory:a,setFilterCategory:o,filterResource:s,setFilterResource:n,filterStatus:c,setFilterStatus:u,filterChargeable:x,setFilterChargeable:S,filterProcurement:_,setFilterProcurement:i,resourceNames:w,hasRole:B}){const d={padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"};return e.jsx("div",{className:"card",style:{marginBottom:"1.5rem"},children:e.jsxs("div",{style:{display:"flex",gap:"1rem",alignItems:"center",flexWrap:"wrap"},children:[e.jsx("span",{style:{fontWeight:"500"},children:"Filter:"}),e.jsxs("select",{value:a,onChange:g=>o(g.target.value),style:d,children:[e.jsx("option",{value:"all",children:"All Types"}),Rt.map(g=>e.jsx("option",{value:g,children:g},g))]}),e.jsxs("select",{value:s,onChange:g=>n(g.target.value),style:d,children:[e.jsx("option",{value:"all",children:"All Resources"}),w.map(g=>e.jsx("option",{value:g,children:g},g))]}),e.jsxs("select",{value:c,onChange:g=>u(g.target.value),style:d,children:[e.jsx("option",{value:"all",children:"All Statuses"}),wt.map(g=>e.jsx("option",{value:g,children:At[g]||g},g))]}),e.jsxs("select",{value:x,onChange:g=>S(g.target.value),style:d,children:[e.jsx("option",{value:"all",children:"All Expenses"}),e.jsx("option",{value:"chargeable",children:"Chargeable Only"}),e.jsx("option",{value:"non-chargeable",children:"Non-Chargeable Only"})]}),B(["admin","supplier_pm"])&&e.jsxs("select",{value:_,onChange:g=>i(g.target.value),style:d,children:[e.jsx("option",{value:"all",children:"All Procurement"}),e.jsx("option",{value:"supplier",children:"Supplier Procured"}),e.jsx("option",{value:"partner",children:"Partner Procured"})]})]})})}const kt=["Travel","Accommodation","Sustenance"];function Pt(a){switch(a){case"Travel":return e.jsx(je,{size:16});case"Accommodation":return e.jsx(be,{size:16});case"Sustenance":return e.jsx(ye,{size:16});default:return e.jsx(de,{size:16})}}function It(a){switch(a){case"Travel":return{bg:"#dbeafe",color:"#2563eb"};case"Accommodation":return{bg:"#f3e8ff",color:"#7c3aed"};case"Sustenance":return{bg:"#ffedd5",color:"#ea580c"};default:return{bg:"#f1f5f9",color:"#64748b"}}}function Dt({expenses:a,categoryTotals:o}){return e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Breakdown by Type"}),e.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:"1rem"},children:kt.map(s=>{const n=It(s),c=a.filter(x=>x.category===s).length,u=a.filter(x=>x.category===s&&x.chargeable_to_customer!==!1).reduce((x,S)=>x+parseFloat(S.amount||0),0);return e.jsxs("div",{style:{padding:"1rem",backgroundColor:n.bg,borderRadius:"8px"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",color:n.color,marginBottom:"0.5rem"},children:[Pt(s),e.jsx("span",{style:{fontWeight:"600"},children:s})]}),e.jsxs("div",{style:{fontSize:"1.5rem",fontWeight:"700",color:n.color},children:["Â£",o[s].toFixed(2)]}),e.jsxs("div",{style:{fontSize:"0.8rem",color:"#64748b"},children:[c," expense(s)"]}),e.jsxs("div",{style:{fontSize:"0.75rem",color:"#10b981",marginTop:"0.25rem"},children:["Â£",u.toFixed(2)," chargeable"]})]},s)})})]})}function Et({resourceTotals:a}){return Object.keys(a).length===0?null:e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Breakdown by Resource"}),e.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"1rem"},children:Object.entries(a).map(([o,s])=>e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#f1f5f9",borderRadius:"8px",minWidth:"180px"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"0.5rem"},children:[e.jsx(ft,{size:16,style:{color:"#64748b"}}),e.jsx("span",{style:{fontWeight:"600",fontSize:"0.9rem"},children:o})]}),e.jsxs("div",{style:{fontSize:"1.25rem",fontWeight:"700",color:"#3b82f6"},children:["Â£",s.total.toFixed(2)]}),e.jsxs("div",{style:{fontSize:"0.75rem",color:"#10b981"},children:["Â£",s.chargeable.toFixed(2)," chargeable"]}),s.nonChargeable>0&&e.jsxs("div",{style:{fontSize:"0.75rem",color:"#f59e0b"},children:["Â£",s.nonChargeable.toFixed(2)," non-chargeable"]})]},o))})]})}function zt(){return e.jsxs("div",{className:"card",style:{marginTop:"1.5rem",backgroundColor:"#fffbeb",borderLeft:"4px solid #f59e0b"},children:[e.jsx("h4",{style:{marginBottom:"0.5rem",color:"#92400e"},children:"ðŸ“‹ Expense Guidelines"}),e.jsxs("ul",{style:{margin:"0.5rem 0 0 1.5rem",color:"#92400e",fontSize:"0.9rem"},children:[e.jsx("li",{children:"PMO travel/accommodation requires advance approval from Authority Project Manager"}),e.jsx("li",{children:"Attach receipts for all expenses over Â£25"}),e.jsx("li",{children:"Submit expenses within 30 days of incurring them"}),e.jsxs("li",{children:[e.jsx("strong",{children:"Submit:"})," Click the send icon to submit for validation"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Chargeable expenses:"})," Validated by Customer PM"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Non-chargeable expenses:"})," Validated by Supplier PM"]})]})]})}function Ne({category:a,icon:o,bgColor:s,textColor:n,borderColor:c,amount:u,reason:x,chargeable:S,procurement:_,onAmountChange:i,onReasonChange:w,onChargeableChange:B,onProcurementChange:d,hasRole:g}){return e.jsxs("div",{style:{padding:"1rem",backgroundColor:s,borderRadius:"8px",marginBottom:"1rem"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",color:n,marginBottom:"0.75rem"},children:[o,e.jsx("span",{style:{fontWeight:"600",fontSize:"1rem"},children:a})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"150px 1fr",gap:"1rem",marginBottom:"0.75rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Amount (Â£)"}),e.jsx("input",{type:"number",step:"0.01",className:"form-input",placeholder:"0.00",value:u,onChange:b=>i(b.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Reason / Description"}),e.jsx("input",{type:"text",className:"form-input",placeholder:`e.g., ${a} expense description`,value:x,onChange:b=>w(b.target.value)})]})]}),parseFloat(u)>0&&e.jsxs("div",{style:{display:"flex",gap:"1.5rem",flexWrap:"wrap",paddingTop:"0.75rem",borderTop:`1px solid ${c}`},children:[e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"0.5rem",cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:S,onChange:b=>B(b.target.checked),style:{width:"16px",height:"16px",accentColor:n}}),e.jsx("span",{style:{fontSize:"0.85rem",color:n},children:"Chargeable to Customer"})]}),g(["admin","supplier_pm"])&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.85rem",color:n},children:"Paid by:"}),e.jsxs("select",{value:_,onChange:b=>d(b.target.value),style:{padding:"0.25rem 0.5rem",borderRadius:"4px",border:`1px solid ${c}`,fontSize:"0.85rem",backgroundColor:"#fff"},children:[e.jsx("option",{value:"supplier",children:"Supplier (JT)"}),e.jsx("option",{value:"partner",children:"Partner"})]})]})]})]})}function Ft({newExpense:a,setNewExpense:o,availableResources:s,hasRole:n,handleAdd:c,handleFileSelect:u,removeFile:x,uploadingFiles:S,onCancel:_}){return e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem",border:"2px solid var(--primary)"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Add New Expenses"}),e.jsx("p",{style:{color:"#64748b",fontSize:"0.9rem",marginBottom:"1rem"},children:"Enter amounts for any categories that apply. Leave blank to skip a category."}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem",marginBottom:"1.5rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Resource Name *"}),e.jsxs("select",{className:"form-input",value:a.resource_id,onChange:i=>o({...a,resource_id:i.target.value}),children:[e.jsx("option",{value:"",children:"Select Resource"}),s.map(i=>e.jsx("option",{value:i.id,children:i.name},i.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Date *"}),e.jsx("input",{type:"date",className:"form-input",value:a.expense_date,onChange:i=>o({...a,expense_date:i.target.value})})]})]}),e.jsx(Ne,{category:"Travel",icon:e.jsx(je,{size:20}),bgColor:"#dbeafe",textColor:"#2563eb",borderColor:"#93c5fd",amount:a.travel_amount,reason:a.travel_reason,chargeable:a.travel_chargeable,procurement:a.travel_procurement,onAmountChange:i=>o({...a,travel_amount:i}),onReasonChange:i=>o({...a,travel_reason:i}),onChargeableChange:i=>o({...a,travel_chargeable:i}),onProcurementChange:i=>o({...a,travel_procurement:i}),hasRole:n}),e.jsx(Ne,{category:"Accommodation",icon:e.jsx(be,{size:20}),bgColor:"#f3e8ff",textColor:"#7c3aed",borderColor:"#d8b4fe",amount:a.accommodation_amount,reason:a.accommodation_reason,chargeable:a.accommodation_chargeable,procurement:a.accommodation_procurement,onAmountChange:i=>o({...a,accommodation_amount:i}),onReasonChange:i=>o({...a,accommodation_reason:i}),onChargeableChange:i=>o({...a,accommodation_chargeable:i}),onProcurementChange:i=>o({...a,accommodation_procurement:i}),hasRole:n}),e.jsx(Ne,{category:"Sustenance",icon:e.jsx(ye,{size:20}),bgColor:"#ffedd5",textColor:"#ea580c",borderColor:"#fdba74",amount:a.sustenance_amount,reason:a.sustenance_reason,chargeable:a.sustenance_chargeable,procurement:a.sustenance_procurement,onAmountChange:i=>o({...a,sustenance_amount:i}),onReasonChange:i=>o({...a,sustenance_reason:i}),onChargeableChange:i=>o({...a,sustenance_chargeable:i}),onProcurementChange:i=>o({...a,sustenance_procurement:i}),hasRole:n}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{className:"form-label",children:"Additional Notes"}),e.jsx("textarea",{className:"form-input",rows:2,placeholder:"Any additional information...",value:a.notes,onChange:i=>o({...a,notes:i.target.value})})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{className:"form-label",children:"Attach Receipts"}),e.jsxs("div",{style:{border:"2px dashed #d1d5db",borderRadius:"8px",padding:"1.5rem",textAlign:"center",cursor:"pointer",backgroundColor:"#f9fafb"},onClick:()=>document.getElementById("file-upload").click(),children:[e.jsx(ge,{size:24,style:{color:"#9ca3af",marginBottom:"0.5rem"}}),e.jsx("div",{style:{color:"#64748b",fontSize:"0.85rem"},children:"Click to upload receipts"}),e.jsx("input",{id:"file-upload",type:"file",multiple:!0,accept:".pdf,.jpg,.jpeg,.png,.zip",style:{display:"none"},onChange:u})]}),a.files.length>0&&e.jsx("div",{style:{marginTop:"0.5rem"},children:a.files.map((i,w)=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.25rem 0",fontSize:"0.85rem"},children:[e.jsx(xt,{size:14}),e.jsx("span",{style:{flex:1},children:i.name}),e.jsx("button",{onClick:()=>x(w),style:{background:"none",border:"none",cursor:"pointer",color:"#ef4444"},children:e.jsx(Q,{size:14})})]},w))})]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsxs("button",{className:"btn btn-primary",onClick:c,disabled:S,children:[e.jsx($e,{size:16})," ",S?"Uploading...":"Save Expenses"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:_,children:[e.jsx(Q,{size:16})," Cancel"]})]})]})}const Bt=["Draft","Submitted","Approved","Rejected","Paid"],De={Draft:"Draft",Submitted:"Submitted",Approved:"Validated",Rejected:"Rejected",Paid:"Paid"};function Ot(a){switch(a){case"Travel":return e.jsx(je,{size:16});case"Accommodation":return e.jsx(be,{size:16});case"Sustenance":return e.jsx(ye,{size:16});default:return e.jsx(de,{size:16})}}function $t(a){switch(a){case"Travel":return{bg:"#dbeafe",color:"#2563eb"};case"Accommodation":return{bg:"#f3e8ff",color:"#7c3aed"};case"Sustenance":return{bg:"#ffedd5",color:"#ea580c"};default:return{bg:"#f1f5f9",color:"#64748b"}}}function Ut(a){switch(a){case"Approved":case"Paid":return"status-completed";case"Submitted":return"status-in-progress";case"Rejected":return"status-at-risk";default:return"status-not-started"}}function Lt({expense:a,editingId:o,editForm:s,setEditForm:n,resources:c,hasRole:u,canEditChargeable:x,canSubmitExpense:S,canValidateExpense:_,canEditExpense:i,canDeleteExpense:w,handleEdit:B,handleSave:d,handleSubmit:g,handleApprove:b,handleReject:k,handleDeleteClick:A,downloadFile:Y,setEditingId:F,setDetailModal:H}){const C=$t(a.category),E=a.chargeable_to_customer!==!1,P=o===a.id;return e.jsxs("tr",{style:{backgroundColor:E?"inherit":"#fffbeb",cursor:P?"default":"pointer"},onClick:()=>!P&&H({isOpen:!0,expense:a}),children:[e.jsx("td",{style:{fontFamily:"monospace",fontSize:"0.85rem"},children:a.expense_ref||"-"}),e.jsx("td",{children:P?e.jsxs("select",{className:"form-input",value:s.category,onChange:h=>n({...s,category:h.target.value}),children:[e.jsx("option",{value:"Travel",children:"Travel"}),e.jsx("option",{value:"Accommodation",children:"Accommodation"}),e.jsx("option",{value:"Sustenance",children:"Sustenance"})]}):e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.85rem",backgroundColor:C.bg,color:C.color},children:[Ot(a.category),a.category]})}),e.jsx("td",{children:P?e.jsxs("select",{className:"form-input",value:s.resource_id||"",onChange:h=>n({...s,resource_id:h.target.value}),children:[e.jsx("option",{value:"",children:"-- Select --"}),c.map(h=>e.jsx("option",{value:h.id,children:h.name},h.id))]}):a.resource_name}),e.jsx("td",{children:P?e.jsx("input",{type:"date",className:"form-input",value:s.expense_date,onChange:h=>n({...s,expense_date:h.target.value})}):new Date(a.expense_date).toLocaleDateString("en-GB")}),e.jsx("td",{style:{maxWidth:"200px"},children:P?e.jsx("input",{type:"text",className:"form-input",value:s.reason,onChange:h=>n({...s,reason:h.target.value})}):e.jsx("div",{style:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:a.reason})}),e.jsx("td",{style:{textAlign:"right",fontWeight:"600"},children:P?e.jsx("input",{type:"number",step:"0.01",className:"form-input",value:s.amount,onChange:h=>n({...s,amount:h.target.value}),style:{width:"100px",textAlign:"right"}}):`Â£${parseFloat(a.amount).toFixed(2)}`}),e.jsx("td",{children:P&&x()?e.jsx("input",{type:"checkbox",checked:s.chargeable_to_customer,onChange:h=>n({...s,chargeable_to_customer:h.target.checked}),style:{width:"18px",height:"18px"}}):e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.75rem",fontWeight:"500",backgroundColor:E?"#dcfce7":"#fef3c7",color:E?"#166534":"#92400e"},children:[E?e.jsx(K,{size:12}):e.jsx(Q,{size:12}),E?"Yes":"No"]})}),u(["admin","supplier_pm"])&&e.jsx("td",{children:P?e.jsxs("select",{className:"form-input",value:s.procurement_method||"supplier",onChange:h=>n({...s,procurement_method:h.target.value}),style:{fontSize:"0.85rem",padding:"0.25rem"},children:[e.jsx("option",{value:"supplier",children:"Supplier"}),e.jsx("option",{value:"partner",children:"Partner"})]}):e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.75rem",fontWeight:"500",backgroundColor:(a.procurement_method||"supplier")==="partner"?"#f3e8ff":"#e0e7ff",color:(a.procurement_method||"supplier")==="partner"?"#7c3aed":"#4338ca"},children:[(a.procurement_method||"supplier")==="partner"?e.jsx(Ue,{size:12}):e.jsx(Le,{size:12}),(a.procurement_method||"supplier")==="partner"?"Partner":"Supplier"]})}),e.jsx("td",{children:P&&_(a)?e.jsx("select",{className:"form-input",value:s.status,onChange:h=>n({...s,status:h.target.value}),children:Bt.map(h=>e.jsx("option",{value:h,children:De[h]||h},h))}):e.jsx("span",{className:`status-badge ${Ut(a.status)}`,children:De[a.status]||a.status})}),e.jsx("td",{onClick:h=>h.stopPropagation(),children:a.expense_files?.length>0?e.jsx("div",{style:{display:"flex",gap:"0.25rem"},children:a.expense_files.map((h,Z)=>e.jsx("button",{onClick:()=>Y(h.file_path,h.file_name),style:{background:"none",border:"none",cursor:"pointer",color:"#3b82f6"},title:h.file_name,children:e.jsx(jt,{size:16})},Z))}):"-"}),e.jsx("td",{onClick:h=>h.stopPropagation(),children:P?e.jsxs("div",{className:"action-buttons",children:[e.jsx("button",{className:"btn-icon btn-success",onClick:()=>d(a.id),children:e.jsx($e,{size:16})}),e.jsx("button",{className:"btn-icon btn-secondary",onClick:()=>F(null),children:e.jsx(Q,{size:16})})]}):e.jsxs("div",{className:"action-buttons",children:[S(a)&&e.jsx("button",{className:"btn-icon",onClick:()=>g(a.id),title:"Submit for Validation",style:{color:"#3b82f6"},children:e.jsx(bt,{size:16})}),_(a)&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn-icon btn-success",onClick:()=>b(a.id),title:"Validate",children:e.jsx(Me,{size:16})}),e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>k(a.id),title:"Reject",children:e.jsx(Q,{size:16})})]}),i(a)&&e.jsx("button",{className:"btn-icon",onClick:()=>B(a),title:"Edit",children:e.jsx(yt,{size:16})}),w(a)&&e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>A(a),title:"Delete",children:e.jsx(Oe,{size:16})})]})})]})}function Mt({expenses:a,editingId:o,editForm:s,setEditForm:n,resources:c,hasRole:u,canEditChargeable:x,canSubmitExpense:S,canValidateExpense:_,canEditExpense:i,canDeleteExpense:w,handleEdit:B,handleSave:d,handleSubmit:g,handleApprove:b,handleReject:k,handleDeleteClick:A,downloadFile:Y,setEditingId:F,setDetailModal:H}){const C=u(["admin","supplier_pm"]);return e.jsx("div",{className:"card",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Ref"}),e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Resource"}),e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Reason"}),e.jsx("th",{style:{textAlign:"right"},children:"Amount"}),e.jsx("th",{children:"Chargeable"}),C&&e.jsx("th",{children:"Procured By"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Receipts"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:a.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:C?11:10,style:{textAlign:"center",color:"#64748b",padding:"2rem"},children:"No expenses found."})}):a.map(E=>e.jsx(Lt,{expense:E,editingId:o,editForm:s,setEditForm:n,resources:c,hasRole:u,canEditChargeable:x,canSubmitExpense:S,canValidateExpense:_,canEditExpense:i,canDeleteExpense:w,handleEdit:B,handleSave:d,handleSubmit:g,handleApprove:b,handleReject:k,handleDeleteClick:A,downloadFile:Y,setEditingId:F,setDetailModal:H},E.id))})]})})}const he=20520,Ee={resource_id:"",expense_date:new Date().toISOString().split("T")[0],travel_amount:"",travel_reason:"",travel_chargeable:!0,travel_procurement:"supplier",accommodation_amount:"",accommodation_reason:"",accommodation_chargeable:!0,accommodation_procurement:"supplier",sustenance_amount:"",sustenance_reason:"",sustenance_chargeable:!0,sustenance_procurement:"supplier",notes:"",files:[]};function Kt(){const{user:a,role:o}=ze(),{projectId:s}=Fe(),{showSuccess:n,showError:c,showWarning:u}=Be(),{showTestUsers:x,testUserIds:S}=ct(),_=a?.id||null,{canAddExpense:i,canSubmitExpense:w,canValidateExpense:B,canEditExpense:d,canDeleteExpense:g,getAvailableResources:b,hasRole:k}=dt(),[A,Y]=j.useState([]),[F,H]=j.useState([]),[C,E]=j.useState(!0),[P,h]=j.useState(!1),[Z,J]=j.useState("form"),[ve,re]=j.useState(null),[O,ae]=j.useState({}),[_e,$]=j.useState(!1),[f,ee]=j.useState(Ee),[se,ue]=j.useState("all"),[ne,oe]=j.useState("all"),[ce,Se]=j.useState("all"),[le,t]=j.useState("all"),[l,y]=j.useState("all"),[N,p]=j.useState({isOpen:!1,expenseId:null,expenseData:null}),[R,V]=j.useState({isOpen:!1,expense:null,editMode:!1,editData:null}),I=j.useCallback(async()=>{if(s){E(!0);try{const r=await W.getAllFiltered(s,x);Y(r);const{data:m}=await L.from("resources").select("id, name, email, user_id, partner_id, partner:partners(id, name)").order("name");let z=m||[];!x&&S?.length>0&&(z=z.filter(M=>!M.user_id||!S.includes(M.user_id))),H(z)}catch{c("Failed to load expenses")}finally{E(!1)}}},[s,x,S,c]);j.useEffect(()=>{I()},[I]);async function U(){if(!f.resource_id){u("Please select a resource");return}const r=parseFloat(f.travel_amount)>0,m=parseFloat(f.accommodation_amount)>0,z=parseFloat(f.sustenance_amount)>0;if(!r&&!m&&!z){u("Please enter at least one expense amount");return}if(r&&!f.travel_reason){u("Please enter a reason for the travel expense");return}if(m&&!f.accommodation_reason){u("Please enter a reason for the accommodation expense");return}if(z&&!f.sustenance_reason){u("Please enter a reason for the sustenance expense");return}try{const M=F.find(Ce=>Ce.id===f.resource_id)?.name,G=[];r&&G.push({project_id:s,category:"Travel",resource_id:f.resource_id,resource_name:M,expense_date:f.expense_date,reason:f.travel_reason,amount:parseFloat(f.travel_amount),notes:f.notes,created_by:_,chargeable_to_customer:f.travel_chargeable,procurement_method:f.travel_procurement}),m&&G.push({project_id:s,category:"Accommodation",resource_id:f.resource_id,resource_name:M,expense_date:f.expense_date,reason:f.accommodation_reason,amount:parseFloat(f.accommodation_amount),notes:f.notes,created_by:_,chargeable_to_customer:f.accommodation_chargeable,procurement_method:f.accommodation_procurement}),z&&G.push({project_id:s,category:"Sustenance",resource_id:f.resource_id,resource_name:M,expense_date:f.expense_date,reason:f.sustenance_reason,amount:parseFloat(f.sustenance_amount),notes:f.notes,created_by:_,chargeable_to_customer:f.sustenance_chargeable,procurement_method:f.sustenance_procurement});const ke=await W.createMany(G);if(f.files.length>0&&ke){$(!0);for(const Ce of ke)for(const ot of f.files)try{await W.uploadReceipt(Ce.id,ot,_)}catch{}$(!1)}await I(),h(!1),ee(Ee),n("Expenses added successfully!")}catch(M){c("Failed to add expenses: "+M.message)}}async function T(r){try{await W.create({project_id:s,category:r.category,resource_id:r.resource_id,resource_name:r.resource_name,expense_date:r.expense_date,reason:r.reason,amount:r.amount,notes:r.notes,created_by:_,chargeable_to_customer:r.chargeable_to_customer,procurement_method:r.procurement_method}),await I()}catch(m){c("Failed to create expense: "+m.message)}}function X(r){re(r.id),ae({category:r.category,resource_id:r.resource_id,resource_name:r.resource_name,expense_date:r.expense_date,reason:r.reason,amount:r.amount,notes:r.notes,status:r.status,chargeable_to_customer:r.chargeable_to_customer!==!1,procurement_method:r.procurement_method||"supplier"})}async function we(r){try{const m=F.find(z=>z.id===O.resource_id)?.name||O.resource_name;await W.update(r,{category:O.category,resource_id:O.resource_id,resource_name:m,expense_date:O.expense_date,reason:O.reason,amount:parseFloat(O.amount),notes:O.notes,status:O.status,chargeable_to_customer:O.chargeable_to_customer,procurement_method:O.procurement_method}),await I(),re(null),n("Expense updated!")}catch(m){c("Failed to update: "+m.message)}}function me(r){p({isOpen:!0,expenseId:r.id,expenseData:{resourceName:r.resource_name,date:r.expense_date,totalAmount:parseFloat(r.amount||0),category:r.category,chargeable:r.chargeable_to_customer,procurement:r.procurement_method,status:r.status}})}async function Ge(){if(N.expenseId)try{await W.delete(N.expenseId,_),await I(),p({isOpen:!1,expenseId:null,expenseData:null}),n("Expense deleted")}catch(r){c("Failed to delete: "+r.message)}}async function We(r){if(confirm("Submit this expense for validation?"))try{await W.submit(r),await I(),n("Expense submitted for validation!")}catch(m){c("Failed to submit: "+m.message)}}async function Ye(r){try{await W.approve(r),await I(),n("Expense validated!")}catch(m){c("Failed to validate: "+m.message)}}async function Ve(r){const m=prompt("Please provide a reason for rejection (optional):");try{await W.reject(r,m),await I(),u("Expense rejected")}catch(z){c("Failed to reject: "+z.message)}}function qe(r){const m=Array.from(r.target.files);ee({...f,files:[...f.files,...m]})}function He(r){ee({...f,files:f.files.filter((m,z)=>z!==r)})}async function Je(r,m){try{const z=await W.downloadReceipt(r),M=URL.createObjectURL(z),G=document.createElement("a");G.href=M,G.download=m,document.body.appendChild(G),G.click(),document.body.removeChild(G),URL.revokeObjectURL(M)}catch{c("Failed to download file")}}function Xe(){return k(["admin","supplier_pm","customer_pm"])}const Ke=A.filter(r=>!(se!=="all"&&r.category!==se||ne!=="all"&&r.resource_name!==ne||ce!=="all"&&r.status!==ce||le==="chargeable"&&r.chargeable_to_customer===!1||le==="non-chargeable"&&r.chargeable_to_customer!==!1||l!=="all"&&(r.procurement_method||"supplier")!==l)),Qe=A.reduce((r,m)=>r+parseFloat(m.amount||0),0),Ze=A.filter(r=>r.chargeable_to_customer!==!1).reduce((r,m)=>r+parseFloat(m.amount||0),0),et=A.filter(r=>r.chargeable_to_customer===!1).reduce((r,m)=>r+parseFloat(m.amount||0),0),Ae=A.filter(r=>["Approved","Paid"].includes(r.status)).reduce((r,m)=>r+parseFloat(m.amount||0),0),Te=he-Ae,tt=A.filter(r=>r.status==="Submitted").length,rt=A.filter(r=>(r.procurement_method||"supplier")==="supplier").reduce((r,m)=>r+parseFloat(m.amount||0),0),at=A.filter(r=>r.procurement_method==="partner").reduce((r,m)=>r+parseFloat(m.amount||0),0),st={Travel:A.filter(r=>r.category==="Travel").reduce((r,m)=>r+parseFloat(m.amount||0),0),Accommodation:A.filter(r=>r.category==="Accommodation").reduce((r,m)=>r+parseFloat(m.amount||0),0),Sustenance:A.filter(r=>r.category==="Sustenance").reduce((r,m)=>r+parseFloat(m.amount||0),0)},te={};A.forEach(r=>{te[r.resource_name]||(te[r.resource_name]={total:0,chargeable:0,nonChargeable:0});const m=parseFloat(r.amount||0);te[r.resource_name].total+=m,r.chargeable_to_customer!==!1?te[r.resource_name].chargeable+=m:te[r.resource_name].nonChargeable+=m});const pe=b(F),nt=[...new Set(A.map(r=>r.resource_name))];return C&&!s?e.jsx(lt,{message:"Loading expenses...",size:"large",fullPage:!0}):e.jsxs("div",{className:"page-container",children:[e.jsx(it,{icon:de,title:"Expenses",subtitle:`Track project expenses against Â£${he.toLocaleString()} budget`,children:i&&!P&&e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsxs("button",{className:"btn btn-primary",onClick:()=>{J("form"),h(!0)},children:[e.jsx(vt,{size:18})," Add Expenses"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:()=>{J("scanner"),h(!0)},style:{background:"linear-gradient(135deg, #8b5cf6, #6366f1)",color:"white",border:"none"},title:"Scan a receipt with AI",children:[e.jsx(Re,{size:18})," ",e.jsx(fe,{size:14})," Scan Receipt"]})]})}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem"},children:[e.jsx(q,{icon:de,label:"Total Budget",value:`Â£${he.toLocaleString()}`,color:"#3b82f6"}),e.jsx(q,{label:"Total Claimed",value:`Â£${Qe.toLocaleString()}`,color:"#3b82f6"}),e.jsx(q,{icon:Me,label:"Chargeable",value:`Â£${Ze.toLocaleString()}`,color:"#10b981"}),e.jsx(q,{icon:xe,label:"Non-Chargeable",value:`Â£${et.toLocaleString()}`,color:"#f59e0b"})]}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem",gridTemplateColumns:"repeat(3, 1fr)"},children:[e.jsx(q,{label:"Validated/Paid",value:`Â£${Ae.toLocaleString()}`,color:"#10b981"}),e.jsx(q,{label:"Remaining Budget",value:`Â£${Te.toLocaleString()}`,color:Te<he*.2?"#ef4444":"#10b981"}),e.jsx(q,{label:"Pending Validation",value:tt,color:"#f59e0b"})]}),k(["admin","supplier_pm"])&&e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem",gridTemplateColumns:"repeat(2, 1fr)"},children:[e.jsx(q,{icon:Le,label:"Supplier Procured",value:`Â£${rt.toLocaleString()}`,subtext:"Paid directly by JT",color:"#6366f1"}),e.jsx(q,{icon:Ue,label:"Partner Procured",value:`Â£${at.toLocaleString()}`,subtext:"Reimbursable to partners",color:"#8b5cf6"})]}),e.jsx(Dt,{expenses:A,categoryTotals:st}),e.jsx(Et,{resourceTotals:te}),e.jsx(Tt,{filterCategory:se,setFilterCategory:ue,filterResource:ne,setFilterResource:oe,filterStatus:ce,setFilterStatus:Se,filterChargeable:le,setFilterChargeable:t,filterProcurement:l,setFilterProcurement:y,resourceNames:nt,hasRole:k}),P&&Z==="form"&&e.jsx(Ft,{newExpense:f,setNewExpense:ee,availableResources:pe,hasRole:k,handleAdd:U,handleFileSelect:qe,removeFile:He,uploadingFiles:_e,onCancel:()=>h(!1)}),P&&Z==="scanner"&&e.jsx("div",{style:{marginBottom:"1.5rem"},children:e.jsx(Nt,{resources:pe,defaultResourceId:pe.length===1?pe[0].id:null,onExpenseCreated:T,onCancel:()=>{h(!1),J("form")}})}),e.jsx(Mt,{expenses:Ke,editingId:ve,editForm:O,setEditForm:ae,resources:F,hasRole:k,canEditChargeable:Xe,canSubmitExpense:w,canValidateExpense:B,canEditExpense:d,canDeleteExpense:g,handleEdit:X,handleSave:we,handleSubmit:We,handleApprove:Ye,handleReject:Ve,handleDeleteClick:me,downloadFile:Je,setEditingId:re,setDetailModal:V}),e.jsx(zt,{}),e.jsx(ut,{isOpen:N.isOpen,onClose:()=>p({isOpen:!1,expenseId:null,expenseData:null}),onConfirm:Ge,title:"Delete Expense",message:N.expenseData?e.jsxs("div",{children:[e.jsx("p",{children:"Are you sure you want to delete this expense?"}),e.jsxs("div",{style:{backgroundColor:"#fef3c7",border:"1px solid #f59e0b",borderRadius:"6px",padding:"0.75rem",marginTop:"0.75rem"},children:[e.jsx("p",{style:{fontWeight:"600",color:"#92400e",margin:"0 0 0.5rem 0"},children:"Details:"}),e.jsxs("ul",{style:{margin:"0",paddingLeft:"1.25rem",color:"#92400e",fontSize:"0.9rem"},children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Resource:"})," ",N.expenseData.resourceName]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Category:"})," ",N.expenseData.category]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Amount:"})," Â£",N.expenseData.totalAmount?.toFixed(2)]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Status:"})," ",N.expenseData.status]})]})]}),e.jsx("p",{style:{marginTop:"0.75rem",fontSize:"0.85rem",color:"#6b7280"},children:"This expense can be restored from the audit log if needed."})]}):"Are you sure you want to delete this expense?",confirmText:"Delete",cancelText:"Cancel",variant:"danger"})]})}export{Kt as default};
