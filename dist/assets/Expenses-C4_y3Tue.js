import{u as Xe,a as Ze,b as Ke,c as er,s as f,j as e,L as rr,P as tr,S as k}from"./index-BiMCcVir.js";import{r as m}from"./vendor-react-JFEV0ROX.js";import{u as ar}from"./usePermissions-tzByz7f2.js";import{C as sr}from"./ConfirmDialog-Dx_9nxHd.js";import{g as Q,H as nr,C as E,u as or,x as X,k as Z,U as pe,ac as ue,ad as he,ae as ge,af as lr,F as ir,a as F,N as K,e as cr,ag as xe,b as dr,J as fe,T as mr}from"./vendor-icons-CoFrSbed.js";import"./vendor-supabase-DgEUAXvv.js";function jr(){const{user:be,role:ee}=Xe(),{projectId:_}=Ze(),{showSuccess:D,showError:z,showWarning:N}=Ke(),P=be?.id||null,{canAddExpense:je,canSubmitExpense:ye,canValidateExpense:re,canEditExpense:te,canDeleteExpense:_e,getAvailableResources:ve,hasRole:g}=ar(),[p,Ce]=m.useState([]),[w,Se]=m.useState([]),[ke,pr]=m.useState(!0),[ae,L]=m.useState(!1),[b,O]=m.useState(null),[l,C]=m.useState({}),[$,ze]=m.useState("all"),[M,we]=m.useState("all"),[U,Te]=m.useState("all"),[J,Re]=m.useState("all"),[q,Fe]=m.useState("all"),[se,ne]=m.useState(!1),[x,G]=m.useState({isOpen:!1,expenseId:null,expenseData:null}),[u,h]=m.useState({isOpen:!1,expense:null,editMode:!1,editData:null}),{showTestUsers:V,testUserIds:H}=er(),A=20520,[t,c]=m.useState({resource_id:"",expense_date:new Date().toISOString().split("T")[0],travel_amount:"",travel_reason:"",travel_chargeable:!0,travel_procurement:"supplier",accommodation_amount:"",accommodation_reason:"",accommodation_chargeable:!0,accommodation_procurement:"supplier",sustenance_amount:"",sustenance_reason:"",sustenance_chargeable:!0,sustenance_procurement:"supplier",notes:"",files:[]}),oe=["Draft","Submitted","Approved","Rejected","Paid"],I={Draft:"Draft",Submitted:"Submitted",Approved:"Validated",Rejected:"Rejected",Paid:"Paid"};m.useEffect(()=>{_&&S(_)},[_]),m.useEffect(()=>{_&&S(_)},[V]);async function S(r){const a=r||_;if(a)try{let s=f.from("expenses").select("*, expense_files(*)").eq("project_id",a).order("expense_date",{ascending:!1});V||(s=s.or("is_test_content.is.null,is_test_content.eq.false"));const{data:n}=await s;Ce(n||[]);const{data:i}=await f.from("resources").select("id, name, email, user_id, partner_id, partner:partners(id, name)").order("name");let d=i||[];!V&&H&&H.length>0&&(d=d.filter(R=>!R.user_id||!H.includes(R.user_id))),Se(d)}catch{}}async function Ne(){if(!t.resource_id){N("Please select a resource");return}const r=parseFloat(t.travel_amount)>0,a=parseFloat(t.accommodation_amount)>0,s=parseFloat(t.sustenance_amount)>0;if(!r&&!a&&!s){N("Please enter at least one expense amount");return}if(r&&!t.travel_reason){N("Please enter a reason for the travel expense");return}if(a&&!t.accommodation_reason){N("Please enter a reason for the accommodation expense");return}if(s&&!t.sustenance_reason){N("Please enter a reason for the sustenance expense");return}try{const n=[],i=w.find(j=>j.id===t.resource_id)?.name;r&&n.push({project_id:_,category:"Travel",resource_id:t.resource_id,resource_name:i,expense_date:t.expense_date,reason:t.travel_reason,amount:parseFloat(t.travel_amount),notes:t.notes,status:"Draft",created_by:P,chargeable_to_customer:t.travel_chargeable,procurement_method:t.travel_procurement}),a&&n.push({project_id:_,category:"Accommodation",resource_id:t.resource_id,resource_name:i,expense_date:t.expense_date,reason:t.accommodation_reason,amount:parseFloat(t.accommodation_amount),notes:t.notes,status:"Draft",created_by:P,chargeable_to_customer:t.accommodation_chargeable,procurement_method:t.accommodation_procurement}),s&&n.push({project_id:_,category:"Sustenance",resource_id:t.resource_id,resource_name:i,expense_date:t.expense_date,reason:t.sustenance_reason,amount:parseFloat(t.sustenance_amount),notes:t.notes,status:"Draft",created_by:P,chargeable_to_customer:t.sustenance_chargeable,procurement_method:t.sustenance_procurement});const{data:d,error:R}=await f.from("expenses").insert(n).select();if(R)throw R;if(t.files.length>0&&d){ne(!0);for(const j of d)for(const y of t.files){const o=`${j.id}/${Date.now()}-${y.name}`,{error:v}=await f.storage.from("receipts").upload(o,y);v||await f.from("expense_files").insert({expense_id:j.id,file_name:y.name,file_path:o,file_size:y.size,file_type:y.type,uploaded_by:P})}ne(!1)}await S(),L(!1),c({resource_id:"",expense_date:new Date().toISOString().split("T")[0],travel_amount:"",travel_reason:"",travel_chargeable:!0,travel_procurement:"supplier",accommodation_amount:"",accommodation_reason:"",accommodation_chargeable:!0,accommodation_procurement:"supplier",sustenance_amount:"",sustenance_reason:"",sustenance_chargeable:!0,sustenance_procurement:"supplier",notes:"",files:[]}),D("Expenses added successfully!")}catch(n){z("Failed to add expenses: "+n.message)}}function De(r){O(r.id),C({category:r.category,resource_id:r.resource_id,resource_name:r.resource_name,expense_date:r.expense_date,reason:r.reason,amount:r.amount,notes:r.notes,status:r.status,chargeable_to_customer:r.chargeable_to_customer!==!1,procurement_method:r.procurement_method||"supplier"})}async function Pe(r){try{const a=w.find(n=>n.id===l.resource_id)?.name||l.resource_name,{error:s}=await f.from("expenses").update({category:l.category,resource_id:l.resource_id,resource_name:a,expense_date:l.expense_date,reason:l.reason,amount:parseFloat(l.amount),notes:l.notes,status:l.status,chargeable_to_customer:l.chargeable_to_customer,procurement_method:l.procurement_method}).eq("id",r);if(s)throw s;await S(),O(null),D("Expense updated!")}catch(a){z("Failed to update: "+a.message)}}function Ae(r){const a=(parseFloat(r.travel_amount)||0)+(parseFloat(r.accommodation_amount)||0)+(parseFloat(r.sustenance_amount)||0),s=[];r.travel_amount>0&&s.push(`Travel: Â£${r.travel_amount}`),r.accommodation_amount>0&&s.push(`Accommodation: Â£${r.accommodation_amount}`),r.sustenance_amount>0&&s.push(`Sustenance: Â£${r.sustenance_amount}`),G({isOpen:!0,expenseId:r.id,expenseData:{resourceName:r.resource_name,date:r.expense_date,totalAmount:a,categories:s,chargeable:r.chargeable_to_customer,procurement:r.procurement_method,status:r.status}})}async function Ie(){if(x.expenseId)try{const{error:r}=await f.from("expenses").delete().eq("id",x.expenseId);if(r)throw r;await S(),G({isOpen:!1,expenseId:null,expenseData:null})}catch(r){z("Failed to delete: "+r.message)}}async function Be(r){if(confirm("Submit this expense for validation?"))try{const{error:a}=await f.from("expenses").update({status:"Submitted"}).eq("id",r);if(a)throw a;await S(),D("Expense submitted for validation!")}catch(a){z("Failed to submit: "+a.message)}}async function We(r){try{const{error:a}=await f.from("expenses").update({status:"Approved"}).eq("id",r);if(a)throw a;await S(),D("Expense validated!")}catch(a){z("Failed to validate: "+a.message)}}async function Ee(r){const a=prompt("Please provide a reason for rejection (optional):");try{const s={status:"Rejected"};a&&(s.rejection_reason=a);const{error:n}=await f.from("expenses").update(s).eq("id",r);if(n)throw n;await S(),N("Expense rejected")}catch(s){z("Failed to reject: "+s.message)}}function Le(r){const a=Array.from(r.target.files);c({...t,files:[...t.files,...a]})}function Oe(r){c({...t,files:t.files.filter((a,s)=>s!==r)})}async function le(r,a){try{const{data:s,error:n}=await f.storage.from("receipts").download(r);if(n)throw n;const i=URL.createObjectURL(s),d=document.createElement("a");d.href=i,d.download=a,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(i)}catch{z("Failed to download file")}}function Y(r){switch(r){case"Travel":return e.jsx(ue,{size:16});case"Accommodation":return e.jsx(he,{size:16});case"Sustenance":return e.jsx(ge,{size:16});default:return e.jsx(Q,{size:16})}}function B(r){switch(r){case"Travel":return{bg:"#dbeafe",color:"#2563eb"};case"Accommodation":return{bg:"#f3e8ff",color:"#7c3aed"};case"Sustenance":return{bg:"#ffedd5",color:"#ea580c"};default:return{bg:"#f1f5f9",color:"#64748b"}}}function ie(r){switch(r){case"Approved":case"Paid":return"status-completed";case"Submitted":return"status-in-progress";case"Rejected":return"status-at-risk";default:return"status-not-started"}}function $e(){return g(["admin","supplier_pm","customer_pm"])}const ce=p.filter(r=>!($!=="all"&&r.category!==$||M!=="all"&&r.resource_name!==M||U!=="all"&&r.status!==U||J==="chargeable"&&r.chargeable_to_customer===!1||J==="non-chargeable"&&r.chargeable_to_customer!==!1||q!=="all"&&(r.procurement_method||"supplier")!==q)),Me=p.reduce((r,a)=>r+parseFloat(a.amount||0),0),Ue=p.filter(r=>r.chargeable_to_customer!==!1).reduce((r,a)=>r+parseFloat(a.amount||0),0),Je=p.filter(r=>r.chargeable_to_customer===!1).reduce((r,a)=>r+parseFloat(a.amount||0),0),de=p.filter(r=>["Approved","Paid"].includes(r.status)).reduce((r,a)=>r+parseFloat(a.amount||0),0),me=A-de,qe=p.filter(r=>r.status==="Submitted").length,Ge=p.filter(r=>(r.procurement_method||"supplier")==="supplier").reduce((r,a)=>r+parseFloat(a.amount||0),0),Ve=p.filter(r=>r.procurement_method==="partner").reduce((r,a)=>r+parseFloat(a.amount||0),0),He={Travel:p.filter(r=>r.category==="Travel").reduce((r,a)=>r+parseFloat(a.amount||0),0),Accommodation:p.filter(r=>r.category==="Accommodation").reduce((r,a)=>r+parseFloat(a.amount||0),0),Sustenance:p.filter(r=>r.category==="Sustenance").reduce((r,a)=>r+parseFloat(a.amount||0),0)},T={};p.forEach(r=>{T[r.resource_name]||(T[r.resource_name]={total:0,chargeable:0,nonChargeable:0});const a=parseFloat(r.amount||0);T[r.resource_name].total+=a,r.chargeable_to_customer!==!1?T[r.resource_name].chargeable+=a:T[r.resource_name].nonChargeable+=a});const Ye=ve(w);return ke&&!_?e.jsx(rr,{message:"Loading expenses...",size:"large",fullPage:!0}):e.jsxs("div",{className:"page-container",children:[e.jsx(tr,{icon:Q,title:"Expenses",subtitle:`Track project expenses against Â£${A.toLocaleString()} budget`,children:je&&!ae&&e.jsxs("button",{className:"btn btn-primary",onClick:()=>L(!0),children:[e.jsx(nr,{size:18})," Add Expenses"]})}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem"},children:[e.jsx(k,{icon:Q,label:"Total Budget",value:`Â£${A.toLocaleString()}`,color:"#3b82f6"}),e.jsx(k,{label:"Total Claimed",value:`Â£${Me.toLocaleString()}`,color:"#3b82f6"}),e.jsx(k,{icon:E,label:"Chargeable",value:`Â£${Ue.toLocaleString()}`,color:"#10b981"}),e.jsx(k,{icon:or,label:"Non-Chargeable",value:`Â£${Je.toLocaleString()}`,color:"#f59e0b"})]}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem",gridTemplateColumns:"repeat(3, 1fr)"},children:[e.jsx(k,{label:"Validated/Paid",value:`Â£${de.toLocaleString()}`,color:"#10b981"}),e.jsx(k,{label:"Remaining Budget",value:`Â£${me.toLocaleString()}`,color:me<A*.2?"#ef4444":"#10b981"}),e.jsx(k,{label:"Pending Validation",value:qe,color:"#f59e0b"})]}),g(["admin","supplier_pm"])&&e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem",gridTemplateColumns:"repeat(2, 1fr)"},children:[e.jsx(k,{icon:X,label:"Supplier Procured",value:`Â£${Ge.toLocaleString()}`,subtext:"Paid directly by JT",color:"#6366f1"}),e.jsx(k,{icon:Z,label:"Partner Procured",value:`Â£${Ve.toLocaleString()}`,subtext:"Reimbursable to partners",color:"#8b5cf6"})]}),e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Breakdown by Type"}),e.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:"1rem"},children:["Travel","Accommodation","Sustenance"].map(r=>{const a=B(r),s=p.filter(i=>i.category===r).length,n=p.filter(i=>i.category===r&&i.chargeable_to_customer!==!1).reduce((i,d)=>i+parseFloat(d.amount||0),0);return e.jsxs("div",{style:{padding:"1rem",backgroundColor:a.bg,borderRadius:"8px"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",color:a.color,marginBottom:"0.5rem"},children:[Y(r),e.jsx("span",{style:{fontWeight:"600"},children:r})]}),e.jsxs("div",{style:{fontSize:"1.5rem",fontWeight:"700",color:a.color},children:["Â£",He[r].toFixed(2)]}),e.jsxs("div",{style:{fontSize:"0.8rem",color:"#64748b"},children:[s," expense(s)"]}),e.jsxs("div",{style:{fontSize:"0.75rem",color:"#10b981",marginTop:"0.25rem"},children:["Â£",n.toFixed(2)," chargeable"]})]},r)})})]}),Object.keys(T).length>0&&e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Breakdown by Resource"}),e.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"1rem"},children:Object.entries(T).map(([r,a])=>e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#f1f5f9",borderRadius:"8px",minWidth:"180px"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"0.5rem"},children:[e.jsx(pe,{size:16,style:{color:"#64748b"}}),e.jsx("span",{style:{fontWeight:"600",fontSize:"0.9rem"},children:r})]}),e.jsxs("div",{style:{fontSize:"1.25rem",fontWeight:"700",color:"#3b82f6"},children:["Â£",a.total.toFixed(2)]}),e.jsxs("div",{style:{fontSize:"0.75rem",color:"#10b981"},children:["Â£",a.chargeable.toFixed(2)," chargeable"]}),a.nonChargeable>0&&e.jsxs("div",{style:{fontSize:"0.75rem",color:"#f59e0b"},children:["Â£",a.nonChargeable.toFixed(2)," non-chargeable"]})]},r))})]}),e.jsx("div",{className:"card",style:{marginBottom:"1.5rem"},children:e.jsxs("div",{style:{display:"flex",gap:"1rem",alignItems:"center",flexWrap:"wrap"},children:[e.jsx("span",{style:{fontWeight:"500"},children:"Filter:"}),e.jsxs("select",{value:$,onChange:r=>ze(r.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"all",children:"All Types"}),e.jsx("option",{value:"Travel",children:"Travel"}),e.jsx("option",{value:"Accommodation",children:"Accommodation"}),e.jsx("option",{value:"Sustenance",children:"Sustenance"})]}),e.jsxs("select",{value:M,onChange:r=>we(r.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"all",children:"All Resources"}),[...new Set(p.map(r=>r.resource_name))].map(r=>e.jsx("option",{value:r,children:r},r))]}),e.jsxs("select",{value:U,onChange:r=>Te(r.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"all",children:"All Statuses"}),oe.map(r=>e.jsx("option",{value:r,children:I[r]||r},r))]}),e.jsxs("select",{value:J,onChange:r=>Re(r.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"all",children:"All Expenses"}),e.jsx("option",{value:"chargeable",children:"Chargeable Only"}),e.jsx("option",{value:"non-chargeable",children:"Non-Chargeable Only"})]}),g(["admin","supplier_pm"])&&e.jsxs("select",{value:q,onChange:r=>Fe(r.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"all",children:"All Procurement"}),e.jsx("option",{value:"supplier",children:"Supplier Procured"}),e.jsx("option",{value:"partner",children:"Partner Procured"})]})]})}),ae&&e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem",border:"2px solid var(--primary)"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Add New Expenses"}),e.jsx("p",{style:{color:"#64748b",fontSize:"0.9rem",marginBottom:"1rem"},children:"Enter amounts for any categories that apply. Leave blank to skip a category."}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem",marginBottom:"1.5rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Resource Name *"}),e.jsxs("select",{className:"form-input",value:t.resource_id,onChange:r=>c({...t,resource_id:r.target.value}),children:[e.jsx("option",{value:"",children:"Select Resource"}),Ye.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Date *"}),e.jsx("input",{type:"date",className:"form-input",value:t.expense_date,onChange:r=>c({...t,expense_date:r.target.value})})]})]}),e.jsxs("div",{style:{marginBottom:"1.5rem",padding:"1rem",backgroundColor:"#f0fdf4",borderRadius:"8px",border:"1px solid #86efac"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"0.5rem"},children:[e.jsx(E,{size:18,style:{color:"#16a34a"}}),e.jsx("span",{style:{fontWeight:"600",color:"#166534"},children:"Default Settings"})]}),e.jsx("p",{style:{fontSize:"0.85rem",color:"#64748b",marginBottom:"0"},children:"Each expense category below has its own Chargeable and Procurement settings. Adjust them individually as needed."})]}),e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#dbeafe",borderRadius:"8px",marginBottom:"1rem"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",color:"#2563eb",marginBottom:"0.75rem"},children:[e.jsx(ue,{size:20}),e.jsx("span",{style:{fontWeight:"600",fontSize:"1rem"},children:"Travel"})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"150px 1fr",gap:"1rem",marginBottom:"0.75rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Amount (Â£)"}),e.jsx("input",{type:"number",step:"0.01",className:"form-input",placeholder:"0.00",value:t.travel_amount,onChange:r=>c({...t,travel_amount:r.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Reason / Description"}),e.jsx("input",{type:"text",className:"form-input",placeholder:"e.g., Train fare Jersey to London",value:t.travel_reason,onChange:r=>c({...t,travel_reason:r.target.value})})]})]}),parseFloat(t.travel_amount)>0&&e.jsxs("div",{style:{display:"flex",gap:"1.5rem",flexWrap:"wrap",paddingTop:"0.75rem",borderTop:"1px solid #93c5fd"},children:[e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"0.5rem",cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:t.travel_chargeable,onChange:r=>c({...t,travel_chargeable:r.target.checked}),style:{width:"16px",height:"16px",accentColor:"#2563eb"}}),e.jsx("span",{style:{fontSize:"0.85rem",color:"#1e40af"},children:"Chargeable to Customer"})]}),g(["admin","supplier_pm"])&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.85rem",color:"#1e40af"},children:"Paid by:"}),e.jsxs("select",{value:t.travel_procurement,onChange:r=>c({...t,travel_procurement:r.target.value}),style:{padding:"0.25rem 0.5rem",borderRadius:"4px",border:"1px solid #93c5fd",fontSize:"0.85rem",backgroundColor:"#fff"},children:[e.jsx("option",{value:"supplier",children:"Supplier (JT)"}),e.jsx("option",{value:"partner",children:"Partner"})]})]})]})]}),e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#f3e8ff",borderRadius:"8px",marginBottom:"1rem"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",color:"#7c3aed",marginBottom:"0.75rem"},children:[e.jsx(he,{size:20}),e.jsx("span",{style:{fontWeight:"600",fontSize:"1rem"},children:"Accommodation"})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"150px 1fr",gap:"1rem",marginBottom:"0.75rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Amount (Â£)"}),e.jsx("input",{type:"number",step:"0.01",className:"form-input",placeholder:"0.00",value:t.accommodation_amount,onChange:r=>c({...t,accommodation_amount:r.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Reason / Description"}),e.jsx("input",{type:"text",className:"form-input",placeholder:"e.g., Hotel stay 2 nights London",value:t.accommodation_reason,onChange:r=>c({...t,accommodation_reason:r.target.value})})]})]}),parseFloat(t.accommodation_amount)>0&&e.jsxs("div",{style:{display:"flex",gap:"1.5rem",flexWrap:"wrap",paddingTop:"0.75rem",borderTop:"1px solid #d8b4fe"},children:[e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"0.5rem",cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:t.accommodation_chargeable,onChange:r=>c({...t,accommodation_chargeable:r.target.checked}),style:{width:"16px",height:"16px",accentColor:"#7c3aed"}}),e.jsx("span",{style:{fontSize:"0.85rem",color:"#6b21a8"},children:"Chargeable to Customer"})]}),g(["admin","supplier_pm"])&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.85rem",color:"#6b21a8"},children:"Paid by:"}),e.jsxs("select",{value:t.accommodation_procurement,onChange:r=>c({...t,accommodation_procurement:r.target.value}),style:{padding:"0.25rem 0.5rem",borderRadius:"4px",border:"1px solid #d8b4fe",fontSize:"0.85rem",backgroundColor:"#fff"},children:[e.jsx("option",{value:"supplier",children:"Supplier (JT)"}),e.jsx("option",{value:"partner",children:"Partner"})]})]})]})]}),e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#ffedd5",borderRadius:"8px",marginBottom:"1rem"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",color:"#ea580c",marginBottom:"0.75rem"},children:[e.jsx(ge,{size:20}),e.jsx("span",{style:{fontWeight:"600",fontSize:"1rem"},children:"Sustenance"})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"150px 1fr",gap:"1rem",marginBottom:"0.75rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Amount (Â£)"}),e.jsx("input",{type:"number",step:"0.01",className:"form-input",placeholder:"0.00",value:t.sustenance_amount,onChange:r=>c({...t,sustenance_amount:r.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Reason / Description"}),e.jsx("input",{type:"text",className:"form-input",placeholder:"e.g., Lunch during site visit",value:t.sustenance_reason,onChange:r=>c({...t,sustenance_reason:r.target.value})})]})]}),parseFloat(t.sustenance_amount)>0&&e.jsxs("div",{style:{display:"flex",gap:"1.5rem",flexWrap:"wrap",paddingTop:"0.75rem",borderTop:"1px solid #fdba74"},children:[e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"0.5rem",cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:t.sustenance_chargeable,onChange:r=>c({...t,sustenance_chargeable:r.target.checked}),style:{width:"16px",height:"16px",accentColor:"#ea580c"}}),e.jsx("span",{style:{fontSize:"0.85rem",color:"#c2410c"},children:"Chargeable to Customer"})]}),g(["admin","supplier_pm"])&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.85rem",color:"#c2410c"},children:"Paid by:"}),e.jsxs("select",{value:t.sustenance_procurement,onChange:r=>c({...t,sustenance_procurement:r.target.value}),style:{padding:"0.25rem 0.5rem",borderRadius:"4px",border:"1px solid #fdba74",fontSize:"0.85rem",backgroundColor:"#fff"},children:[e.jsx("option",{value:"supplier",children:"Supplier (JT)"}),e.jsx("option",{value:"partner",children:"Partner"})]})]})]})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{className:"form-label",children:"Additional Notes"}),e.jsx("textarea",{className:"form-input",rows:2,placeholder:"Any additional information...",value:t.notes,onChange:r=>c({...t,notes:r.target.value})})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{className:"form-label",children:"Attach Receipts"}),e.jsxs("div",{style:{border:"2px dashed #d1d5db",borderRadius:"8px",padding:"1.5rem",textAlign:"center",cursor:"pointer",backgroundColor:"#f9fafb"},onClick:()=>document.getElementById("file-upload").click(),children:[e.jsx(lr,{size:24,style:{color:"#9ca3af",marginBottom:"0.5rem"}}),e.jsx("div",{style:{color:"#64748b",fontSize:"0.85rem"},children:"Click to upload receipts"}),e.jsx("div",{style:{color:"#9ca3af",fontSize:"0.75rem"},children:"PDF, JPG, PNG, ZIP"}),e.jsx("input",{id:"file-upload",type:"file",multiple:!0,accept:".pdf,.jpg,.jpeg,.png,.zip",style:{display:"none"},onChange:Le})]}),t.files.length>0&&e.jsx("div",{style:{marginTop:"0.5rem"},children:t.files.map((r,a)=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.25rem 0",fontSize:"0.85rem"},children:[e.jsx(ir,{size:14}),e.jsx("span",{style:{flex:1},children:r.name}),e.jsx("button",{onClick:()=>Oe(a),style:{background:"none",border:"none",cursor:"pointer",color:"#ef4444"},children:e.jsx(F,{size:14})})]},a))})]}),(parseFloat(t.travel_amount)>0||parseFloat(t.accommodation_amount)>0||parseFloat(t.sustenance_amount)>0)&&e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#f0fdf4",borderRadius:"8px",marginBottom:"1rem"},children:[e.jsx("div",{style:{fontWeight:"600",color:"#166534",marginBottom:"0.75rem"},children:"Summary"}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"0.5rem"},children:[parseFloat(t.travel_amount)>0&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",flexWrap:"wrap"},children:[e.jsxs("span",{style:{fontWeight:"500",minWidth:"120px"},children:["Travel: Â£",parseFloat(t.travel_amount).toFixed(2)]}),e.jsx("span",{style:{fontSize:"0.8rem",padding:"0.15rem 0.5rem",borderRadius:"4px",backgroundColor:t.travel_chargeable?"#dcfce7":"#fef3c7",color:t.travel_chargeable?"#166534":"#92400e"},children:t.travel_chargeable?"Chargeable":"Non-chargeable"}),g(["admin","supplier_pm"])&&e.jsx("span",{style:{fontSize:"0.8rem",padding:"0.15rem 0.5rem",borderRadius:"4px",backgroundColor:t.travel_procurement==="partner"?"#f3e8ff":"#e0e7ff",color:t.travel_procurement==="partner"?"#7c3aed":"#4338ca"},children:t.travel_procurement==="partner"?"Partner":"Supplier"})]}),parseFloat(t.accommodation_amount)>0&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",flexWrap:"wrap"},children:[e.jsxs("span",{style:{fontWeight:"500",minWidth:"120px"},children:["Accommodation: Â£",parseFloat(t.accommodation_amount).toFixed(2)]}),e.jsx("span",{style:{fontSize:"0.8rem",padding:"0.15rem 0.5rem",borderRadius:"4px",backgroundColor:t.accommodation_chargeable?"#dcfce7":"#fef3c7",color:t.accommodation_chargeable?"#166534":"#92400e"},children:t.accommodation_chargeable?"Chargeable":"Non-chargeable"}),g(["admin","supplier_pm"])&&e.jsx("span",{style:{fontSize:"0.8rem",padding:"0.15rem 0.5rem",borderRadius:"4px",backgroundColor:t.accommodation_procurement==="partner"?"#f3e8ff":"#e0e7ff",color:t.accommodation_procurement==="partner"?"#7c3aed":"#4338ca"},children:t.accommodation_procurement==="partner"?"Partner":"Supplier"})]}),parseFloat(t.sustenance_amount)>0&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",flexWrap:"wrap"},children:[e.jsxs("span",{style:{fontWeight:"500",minWidth:"120px"},children:["Sustenance: Â£",parseFloat(t.sustenance_amount).toFixed(2)]}),e.jsx("span",{style:{fontSize:"0.8rem",padding:"0.15rem 0.5rem",borderRadius:"4px",backgroundColor:t.sustenance_chargeable?"#dcfce7":"#fef3c7",color:t.sustenance_chargeable?"#166534":"#92400e"},children:t.sustenance_chargeable?"Chargeable":"Non-chargeable"}),g(["admin","supplier_pm"])&&e.jsx("span",{style:{fontSize:"0.8rem",padding:"0.15rem 0.5rem",borderRadius:"4px",backgroundColor:t.sustenance_procurement==="partner"?"#f3e8ff":"#e0e7ff",color:t.sustenance_procurement==="partner"?"#7c3aed":"#4338ca"},children:t.sustenance_procurement==="partner"?"Partner":"Supplier"})]}),e.jsxs("div",{style:{fontWeight:"700",color:"#166534",marginTop:"0.5rem",paddingTop:"0.5rem",borderTop:"1px solid #86efac"},children:["Total: Â£",((parseFloat(t.travel_amount)||0)+(parseFloat(t.accommodation_amount)||0)+(parseFloat(t.sustenance_amount)||0)).toFixed(2)]})]})]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsxs("button",{className:"btn btn-primary",onClick:Ne,disabled:se,children:[e.jsx(K,{size:16})," ",se?"Uploading...":"Save Expenses"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:()=>L(!1),children:[e.jsx(F,{size:16})," Cancel"]})]})]}),e.jsx("div",{className:"card",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Ref"}),e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Resource"}),e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Reason"}),e.jsx("th",{style:{textAlign:"right"},children:"Amount"}),e.jsx("th",{children:"Chargeable"}),g(["admin","supplier_pm"])&&e.jsx("th",{children:"Procured By"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Receipts"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:ce.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:g(["admin","supplier_pm"])?11:10,style:{textAlign:"center",color:"#64748b",padding:"2rem"},children:"No expenses found."})}):ce.map(r=>{const a=B(r.category),s=r.chargeable_to_customer!==!1;return e.jsxs("tr",{style:{backgroundColor:s?"inherit":"#fffbeb",cursor:b===r.id?"default":"pointer"},onClick:()=>{b!==r.id&&h({isOpen:!0,expense:r})},children:[e.jsx("td",{style:{fontFamily:"monospace",fontSize:"0.85rem"},children:r.expense_ref||"-"}),e.jsx("td",{children:b===r.id?e.jsxs("select",{className:"form-input",value:l.category,onChange:n=>C({...l,category:n.target.value}),children:[e.jsx("option",{value:"Travel",children:"Travel"}),e.jsx("option",{value:"Accommodation",children:"Accommodation"}),e.jsx("option",{value:"Sustenance",children:"Sustenance"})]}):e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.85rem",backgroundColor:a.bg,color:a.color},children:[Y(r.category),r.category]})}),e.jsx("td",{children:b===r.id?e.jsxs("select",{className:"form-input",value:l.resource_id||"",onChange:n=>C({...l,resource_id:n.target.value}),children:[e.jsx("option",{value:"",children:"-- Select --"}),w.map(n=>e.jsx("option",{value:n.id,children:n.name},n.id))]}):r.resource_name}),e.jsx("td",{children:b===r.id?e.jsx("input",{type:"date",className:"form-input",value:l.expense_date,onChange:n=>C({...l,expense_date:n.target.value})}):new Date(r.expense_date).toLocaleDateString("en-GB")}),e.jsx("td",{style:{maxWidth:"200px"},children:b===r.id?e.jsx("input",{type:"text",className:"form-input",value:l.reason,onChange:n=>C({...l,reason:n.target.value})}):e.jsx("div",{style:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:r.reason})}),e.jsx("td",{style:{textAlign:"right",fontWeight:"600"},children:b===r.id?e.jsx("input",{type:"number",step:"0.01",className:"form-input",value:l.amount,onChange:n=>C({...l,amount:n.target.value}),style:{width:"100px",textAlign:"right"}}):`Â£${parseFloat(r.amount).toFixed(2)}`}),e.jsx("td",{children:b===r.id&&$e()?e.jsx("label",{style:{display:"flex",alignItems:"center",gap:"0.5rem",cursor:"pointer"},children:e.jsx("input",{type:"checkbox",checked:l.chargeable_to_customer,onChange:n=>C({...l,chargeable_to_customer:n.target.checked}),style:{width:"18px",height:"18px"}})}):e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.75rem",fontWeight:"500",backgroundColor:s?"#dcfce7":"#fef3c7",color:s?"#166534":"#92400e"},children:[s?e.jsx(cr,{size:12}):e.jsx(F,{size:12}),s?"Yes":"No"]})}),g(["admin","supplier_pm"])&&e.jsx("td",{children:b===r.id?e.jsxs("select",{className:"form-input",value:l.procurement_method||"supplier",onChange:n=>C({...l,procurement_method:n.target.value}),style:{fontSize:"0.85rem",padding:"0.25rem"},children:[e.jsx("option",{value:"supplier",children:"Supplier"}),e.jsx("option",{value:"partner",children:"Partner"})]}):e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.75rem",fontWeight:"500",backgroundColor:(r.procurement_method||"supplier")==="partner"?"#f3e8ff":"#e0e7ff",color:(r.procurement_method||"supplier")==="partner"?"#7c3aed":"#4338ca"},children:[(r.procurement_method||"supplier")==="partner"?e.jsx(Z,{size:12}):e.jsx(X,{size:12}),(r.procurement_method||"supplier")==="partner"?"Partner":"Supplier"]})}),e.jsx("td",{children:b===r.id&&re(r)?e.jsx("select",{className:"form-input",value:l.status,onChange:n=>C({...l,status:n.target.value}),children:oe.map(n=>e.jsx("option",{value:n,children:I[n]||n},n))}):e.jsx("span",{className:`status-badge ${ie(r.status)}`,children:I[r.status]||r.status})}),e.jsx("td",{onClick:n=>n.stopPropagation(),children:r.expense_files?.length>0?e.jsx("div",{style:{display:"flex",gap:"0.25rem"},children:r.expense_files.map((n,i)=>e.jsx("button",{onClick:()=>le(n.file_path,n.file_name),style:{background:"none",border:"none",cursor:"pointer",color:"#3b82f6"},title:n.file_name,children:e.jsx(xe,{size:16})},i))}):"-"}),e.jsx("td",{onClick:n=>n.stopPropagation(),children:b===r.id?e.jsxs("div",{className:"action-buttons",children:[e.jsx("button",{className:"btn-icon btn-success",onClick:()=>Pe(r.id),children:e.jsx(K,{size:16})}),e.jsx("button",{className:"btn-icon btn-secondary",onClick:()=>O(null),children:e.jsx(F,{size:16})})]}):e.jsxs("div",{className:"action-buttons",children:[ye(r)&&e.jsx("button",{className:"btn-icon",onClick:()=>Be(r.id),title:"Submit for Validation",style:{color:"#3b82f6"},children:e.jsx(dr,{size:16})}),re(r)&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn-icon btn-success",onClick:()=>We(r.id),title:"Validate",children:e.jsx(E,{size:16})}),e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>Ee(r.id),title:"Reject",children:e.jsx(F,{size:16})})]}),te(r)&&e.jsx("button",{className:"btn-icon",onClick:()=>De(r),title:"Edit",children:e.jsx(fe,{size:16})}),_e(r)&&e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>Ae(r),title:"Delete",children:e.jsx(mr,{size:16})})]})})]},r.id)})})]})}),e.jsxs("div",{className:"card",style:{marginTop:"1.5rem",backgroundColor:"#fffbeb",borderLeft:"4px solid #f59e0b"},children:[e.jsx("h4",{style:{marginBottom:"0.5rem",color:"#92400e"},children:"ðŸ“‹ Expense Guidelines"}),e.jsxs("ul",{style:{margin:"0.5rem 0 0 1.5rem",color:"#92400e",fontSize:"0.9rem"},children:[e.jsx("li",{children:"PMO travel/accommodation requires advance approval from Authority Project Manager"}),e.jsx("li",{children:"Attach receipts for all expenses over Â£25"}),e.jsx("li",{children:"Submit expenses within 30 days of incurring them"}),e.jsxs("li",{children:[e.jsx("strong",{children:"Submit:"})," Click the send icon to submit for validation"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Chargeable expenses:"})," Validated by Customer PM"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Non-chargeable expenses:"})," Validated by Supplier PM"]}),ee==="customer_pm"&&e.jsxs("li",{children:[e.jsx("strong",{children:"As Customer PM:"})," You can validate or reject chargeable expenses"]}),ee==="supplier_pm"&&e.jsxs("li",{children:[e.jsx("strong",{children:"As Supplier PM:"})," You can validate or reject non-chargeable expenses"]})]})]}),e.jsx(sr,{isOpen:x.isOpen,onClose:()=>G({isOpen:!1,expenseId:null,expenseData:null}),onConfirm:Ie,title:"Delete Expense",message:x.expenseData?e.jsxs("div",{children:[e.jsx("p",{children:"Are you sure you want to delete this expense?"}),e.jsxs("div",{style:{backgroundColor:"#fef3c7",border:"1px solid #f59e0b",borderRadius:"6px",padding:"0.75rem",marginTop:"0.75rem"},children:[e.jsx("p",{style:{fontWeight:"600",color:"#92400e",margin:"0 0 0.5rem 0"},children:"Impact on Running Totals:"}),e.jsxs("ul",{style:{margin:"0",paddingLeft:"1.25rem",color:"#92400e",fontSize:"0.9rem"},children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Resource:"})," ",x.expenseData.resourceName]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Date:"})," ",x.expenseData.date]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Total Amount:"})," -Â£",x.expenseData.totalAmount?.toLocaleString("en-GB",{minimumFractionDigits:2})]}),x.expenseData.categories?.length>0&&e.jsxs("li",{children:[e.jsx("strong",{children:"Breakdown:"})," ",x.expenseData.categories.join(", ")]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Chargeable:"})," ",x.expenseData.chargeable?"Yes":"No"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Paid by:"})," ",x.expenseData.procurement==="partner"?"Partner":"Supplier (JT)"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Status:"})," ",x.expenseData.status]})]})]}),e.jsx("p",{style:{marginTop:"0.75rem",fontSize:"0.85rem",color:"#6b7280"},children:"This will permanently remove this expense from all reports and partner invoices."})]}):"Are you sure you want to delete this expense?",confirmText:"Delete",cancelText:"Cancel",variant:"danger"}),u.isOpen&&u.expense&&(()=>{const r=u.expense,a=u.editMode,s=u.editData||{},i=w.find(o=>o.id===r.resource_id)?.partner?.name||null,d=o=>w.find(W=>W.id===o)?.partner?.name||null,R=a?s.resource_id:r.resource_id,j=d(R),y=a?s.procurement_method:r.procurement_method||"supplier";return e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},onClick:()=>h({isOpen:!1,expense:null,editMode:!1,editData:null}),children:e.jsxs("div",{style:{backgroundColor:"white",borderRadius:"12px",padding:"1.5rem",width:"90%",maxWidth:"650px",maxHeight:"90vh",overflowY:"auto",boxShadow:"0 20px 25px -5px rgba(0, 0, 0, 0.1)"},onClick:o=>o.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:"1.5rem"},children:[e.jsxs("div",{children:[e.jsx("h2",{style:{margin:0,fontSize:"1.25rem"},children:a?"Edit Expense":"Expense Details"}),e.jsx("span",{style:{fontFamily:"monospace",fontSize:"0.9rem",color:"#6b7280",marginTop:"0.25rem",display:"block"},children:r.expense_ref||"No Reference"})]}),e.jsx("button",{onClick:()=>h({isOpen:!1,expense:null,editMode:!1,editData:null}),style:{background:"none",border:"none",cursor:"pointer",padding:"0.25rem",color:"#6b7280"},children:e.jsx(F,{size:24})})]}),e.jsx("div",{style:{marginBottom:"1.5rem"},children:e.jsx("span",{className:`status-badge ${ie(r.status)}`,style:{fontSize:"0.9rem",padding:"0.35rem 0.75rem"},children:I[r.status]||r.status})}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem",marginBottom:"1.5rem"},children:[e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#f8fafc",borderRadius:"8px"},children:[e.jsx("label",{style:{fontSize:"0.75rem",color:"#6b7280",textTransform:"uppercase",fontWeight:"600"},children:"Category"}),a?e.jsxs("select",{value:s.category,onChange:o=>h({...u,editData:{...s,category:o.target.value}}),style:{width:"100%",marginTop:"0.5rem",padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"Travel",children:"Travel"}),e.jsx("option",{value:"Accommodation",children:"Accommodation"}),e.jsx("option",{value:"Sustenance",children:"Sustenance"})]}):e.jsx("div",{style:{marginTop:"0.5rem",display:"flex",alignItems:"center",gap:"0.5rem"},children:e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.35rem 0.75rem",borderRadius:"6px",fontSize:"0.9rem",backgroundColor:B(r.category).bg,color:B(r.category).color},children:[Y(r.category),r.category]})})]}),e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#f8fafc",borderRadius:"8px"},children:[e.jsx("label",{style:{fontSize:"0.75rem",color:"#6b7280",textTransform:"uppercase",fontWeight:"600"},children:"Amount"}),a?e.jsxs("div",{style:{marginTop:"0.5rem",display:"flex",alignItems:"center"},children:[e.jsx("span",{style:{marginRight:"0.25rem",fontWeight:"600"},children:"Â£"}),e.jsx("input",{type:"number",step:"0.01",value:s.amount,onChange:o=>h({...u,editData:{...s,amount:o.target.value}}),style:{width:"100%",padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db",fontSize:"1.25rem",fontWeight:"600"}})]}):e.jsxs("p",{style:{margin:"0.5rem 0 0 0",fontSize:"1.5rem",fontWeight:"700",color:"#059669"},children:["Â£",parseFloat(r.amount).toLocaleString("en-GB",{minimumFractionDigits:2})]})]}),e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#f8fafc",borderRadius:"8px"},children:[e.jsx("label",{style:{fontSize:"0.75rem",color:"#6b7280",textTransform:"uppercase",fontWeight:"600"},children:"Resource"}),a?e.jsxs("select",{value:s.resource_id,onChange:o=>{const v=o.target.value,Qe=d(v)?s.procurement_method:"supplier";h({...u,editData:{...s,resource_id:v,procurement_method:Qe}})},style:{width:"100%",marginTop:"0.5rem",padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"",children:"-- Select Resource --"}),w.map(o=>e.jsxs("option",{value:o.id,children:[o.name," ",o.partner?.name?`(${o.partner.name})`:""]},o.id))]}):e.jsxs("p",{style:{margin:"0.5rem 0 0 0",fontWeight:"500",display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(pe,{size:16,style:{color:"#6b7280"}}),r.resource_name,i&&e.jsxs("span",{style:{fontSize:"0.75rem",color:"#6b7280",marginLeft:"0.25rem"},children:["(",i,")"]})]})]}),e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#f8fafc",borderRadius:"8px"},children:[e.jsx("label",{style:{fontSize:"0.75rem",color:"#6b7280",textTransform:"uppercase",fontWeight:"600"},children:"Expense Date"}),a?e.jsx("input",{type:"date",value:s.expense_date,onChange:o=>h({...u,editData:{...s,expense_date:o.target.value}}),style:{width:"100%",marginTop:"0.5rem",padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"}}):e.jsx("p",{style:{margin:"0.5rem 0 0 0",fontWeight:"500"},children:new Date(r.expense_date).toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"long",year:"numeric"})})]}),e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#f8fafc",borderRadius:"8px"},children:[e.jsx("label",{style:{fontSize:"0.75rem",color:"#6b7280",textTransform:"uppercase",fontWeight:"600"},children:"Chargeable to Customer"}),a?e.jsx("div",{style:{marginTop:"0.5rem"},children:e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"0.5rem",cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:s.chargeable_to_customer,onChange:o=>h({...u,editData:{...s,chargeable_to_customer:o.target.checked}}),style:{width:"20px",height:"20px"}}),e.jsx("span",{style:{fontWeight:"500"},children:s.chargeable_to_customer?"Yes":"No"})]})}):e.jsx("p",{style:{margin:"0.5rem 0 0 0",fontWeight:"500",display:"flex",alignItems:"center",gap:"0.5rem",color:r.chargeable_to_customer?"#059669":"#dc2626"},children:r.chargeable_to_customer?e.jsxs(e.Fragment,{children:[e.jsx(E,{size:18})," Yes"]}):e.jsxs(e.Fragment,{children:[e.jsx(F,{size:18})," No"]})})]}),e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#f8fafc",borderRadius:"8px"},children:[e.jsx("label",{style:{fontSize:"0.75rem",color:"#6b7280",textTransform:"uppercase",fontWeight:"600"},children:"Procured By"}),a?e.jsxs("div",{children:[e.jsxs("select",{value:s.procurement_method,onChange:o=>h({...u,editData:{...s,procurement_method:o.target.value}}),style:{width:"100%",marginTop:"0.5rem",padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},disabled:!j,children:[e.jsx("option",{value:"supplier",children:"Supplier (JT)"}),j&&e.jsxs("option",{value:"partner",children:["Partner (",j,")"]})]}),!j&&e.jsx("p",{style:{fontSize:"0.75rem",color:"#6b7280",marginTop:"0.25rem",fontStyle:"italic"},children:"Resource has no linked partner"}),j&&s.procurement_method==="partner"&&e.jsxs("p",{style:{fontSize:"0.75rem",color:"#7c3aed",marginTop:"0.25rem"},children:[j," will invoice JT for this expense"]})]}):e.jsxs("div",{style:{margin:"0.5rem 0 0 0"},children:[e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.35rem 0.75rem",borderRadius:"6px",fontSize:"0.85rem",fontWeight:"500",backgroundColor:y==="partner"?"#f3e8ff":"#e0e7ff",color:y==="partner"?"#7c3aed":"#4338ca"},children:[y==="partner"?e.jsx(Z,{size:14}):e.jsx(X,{size:14}),y==="partner"?`Partner (${i||"Unknown"})`:"Supplier (JT)"]}),y==="partner"&&i&&e.jsxs("p",{style:{fontSize:"0.75rem",color:"#7c3aed",marginTop:"0.5rem"},children:[i," will invoice JT for this expense"]})]})]})]}),e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#f8fafc",borderRadius:"8px",marginBottom:"1rem"},children:[e.jsx("label",{style:{fontSize:"0.75rem",color:"#6b7280",textTransform:"uppercase",fontWeight:"600"},children:"Reason / Description"}),a?e.jsx("textarea",{value:s.reason||"",onChange:o=>h({...u,editData:{...s,reason:o.target.value}}),rows:3,style:{width:"100%",marginTop:"0.5rem",padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db",resize:"vertical"},placeholder:"Enter reason for expense..."}):e.jsx("p",{style:{margin:"0.5rem 0 0 0",lineHeight:"1.5"},children:r.reason||e.jsx("span",{style:{color:"#9ca3af",fontStyle:"italic"},children:"No description provided"})})]}),e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#f8fafc",borderRadius:"8px",marginBottom:"1rem"},children:[e.jsx("label",{style:{fontSize:"0.75rem",color:"#6b7280",textTransform:"uppercase",fontWeight:"600"},children:"Additional Notes"}),a?e.jsx("textarea",{value:s.notes||"",onChange:o=>h({...u,editData:{...s,notes:o.target.value}}),rows:2,style:{width:"100%",marginTop:"0.5rem",padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db",resize:"vertical"},placeholder:"Optional notes..."}):e.jsx("p",{style:{margin:"0.5rem 0 0 0",lineHeight:"1.5"},children:r.notes||e.jsx("span",{style:{color:"#9ca3af",fontStyle:"italic"},children:"No notes"})})]}),!a&&r.expense_files?.length>0&&e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#f8fafc",borderRadius:"8px",marginBottom:"1rem"},children:[e.jsx("label",{style:{fontSize:"0.75rem",color:"#6b7280",textTransform:"uppercase",fontWeight:"600"},children:"Receipts"}),e.jsx("div",{style:{marginTop:"0.5rem",display:"flex",flexWrap:"wrap",gap:"0.5rem"},children:r.expense_files.map((o,v)=>e.jsxs("button",{onClick:()=>le(o.file_path,o.file_name),style:{display:"inline-flex",alignItems:"center",gap:"0.5rem",padding:"0.5rem 0.75rem",backgroundColor:"#dbeafe",color:"#1d4ed8",border:"none",borderRadius:"6px",cursor:"pointer",fontSize:"0.85rem"},children:[e.jsx(xe,{size:14}),o.file_name]},v))})]}),e.jsx("div",{style:{display:"flex",justifyContent:"flex-end",gap:"0.75rem",marginTop:"1.5rem",paddingTop:"1rem",borderTop:"1px solid #e5e7eb"},children:a?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>h({...u,editMode:!1,editData:null}),style:{padding:"0.5rem 1rem",backgroundColor:"#f1f5f9",color:"#475569",border:"1px solid #cbd5e1",borderRadius:"6px",cursor:"pointer",fontSize:"0.875rem"},children:"Cancel"}),e.jsxs("button",{onClick:async()=>{try{const o=w.find(W=>W.id===s.resource_id)?.name||r.resource_name,{error:v}=await f.from("expenses").update({category:s.category,resource_id:s.resource_id,resource_name:o,expense_date:s.expense_date,reason:s.reason,amount:parseFloat(s.amount),notes:s.notes,chargeable_to_customer:s.chargeable_to_customer,procurement_method:s.procurement_method}).eq("id",r.id);if(v)throw v;await S(),h({isOpen:!1,expense:null,editMode:!1,editData:null}),D("Expense updated!")}catch(o){z("Failed to update: "+o.message)}},style:{display:"inline-flex",alignItems:"center",gap:"0.5rem",padding:"0.5rem 1rem",backgroundColor:"#10b981",color:"white",border:"none",borderRadius:"6px",cursor:"pointer",fontSize:"0.875rem"},children:[e.jsx(K,{size:16}),"Save Changes"]})]}):e.jsxs(e.Fragment,{children:[te(r)&&e.jsxs("button",{onClick:()=>{h({...u,editMode:!0,editData:{category:r.category,resource_id:r.resource_id,expense_date:r.expense_date,reason:r.reason||"",amount:r.amount,notes:r.notes||"",chargeable_to_customer:r.chargeable_to_customer!==!1,procurement_method:r.procurement_method||"supplier"}})},style:{display:"inline-flex",alignItems:"center",gap:"0.5rem",padding:"0.5rem 1rem",backgroundColor:"#f1f5f9",color:"#475569",border:"1px solid #cbd5e1",borderRadius:"6px",cursor:"pointer",fontSize:"0.875rem"},children:[e.jsx(fe,{size:16}),"Edit"]}),e.jsx("button",{onClick:()=>h({isOpen:!1,expense:null,editMode:!1,editData:null}),style:{padding:"0.5rem 1rem",backgroundColor:"#3b82f6",color:"white",border:"none",borderRadius:"6px",cursor:"pointer",fontSize:"0.875rem"},children:"Close"})]})})]})})})()]})}export{jr as default};
