import{s as $,u as De,a as ze,b as Fe,j as e,e as Je,c as Xe,i as Y,L as Ke}from"./index-CZifL8RL.js";import{r as p}from"./vendor-react-B1g8b4mG.js";import{C as Qe}from"./ConfirmDialog-Db3qVu_t.js";import{k as K,a as H,as as me,at as Ce,au as Ze,T as Ue,S as he,H as es,L as we,c as X,Y as _e,ae as ss,s as Ae,av as pe,aw as ge,ax as xe,Q as as,F as ts,a9 as Oe,j as $e,aj as Be,ay as Le,U as rs,a2 as ns,ak as cs,C as ke,l as Pe,e as ls,a8 as os,ag as is,E as ds,R as us,a7 as ms}from"./vendor-icons-BfsEacNp.js";import"./vendor-supabase-DSZ6Ejbd.js";const hs={uber:"Travel",lyft:"Travel",taxi:"Travel",train:"Travel",rail:"Travel",airlines:"Travel",airways:"Travel",petrol:"Travel","gas station":"Travel",fuel:"Travel",parking:"Travel",hotel:"Accommodation",inn:"Accommodation",motel:"Accommodation",airbnb:"Accommodation","booking.com":"Accommodation",marriott:"Accommodation",hilton:"Accommodation","premier inn":"Accommodation",travelodge:"Accommodation",restaurant:"Sustenance",cafe:"Sustenance",coffee:"Sustenance",costa:"Sustenance",starbucks:"Sustenance",pret:"Sustenance",greggs:"Sustenance",mcdonald:"Sustenance",subway:"Sustenance",nando:"Sustenance",pizza:"Sustenance",pub:"Sustenance",bar:"Sustenance",food:"Sustenance",supermarket:"Sustenance",tesco:"Sustenance",sainsbury:"Sustenance","co-op":"Sustenance",waitrose:"Sustenance",aldi:"Sustenance",lidl:"Sustenance"};class ps{constructor(){this.bucketName="receipt-scans"}async uploadImage(a,l){try{if(!["image/jpeg","image/png","image/webp","image/heic"].includes(a.type))throw new Error("Invalid file type. Please upload a JPEG, PNG, or WebP image.");const c=10*1024*1024;if(a.size>c)throw new Error("File too large. Maximum size is 10MB.");const h=Date.now(),d=a.name.split(".").pop(),v=`${l}/${h}.${d}`,{error:C}=await $.storage.from(this.bucketName).upload(v,a);if(C)throw C;const{data:{publicUrl:o}}=$.storage.from(this.bucketName).getPublicUrl(v);return{path:v,url:o}}catch(r){throw r}}async processReceipt(a,l){const r=Date.now();try{const c=await this.callClaudeVision(a);let h=await this.findClassificationRule(l,c.merchant);h||(h=this.classifyFromPatterns(c.merchant),!h&&c.aiSuggestedCategory&&(h={category:c.aiSuggestedCategory,confidence:c.aiConfidence||.6}));const d=Date.now()-r;return{...c,suggestedCategory:h?.category||null,confidence:h?.confidence||0,ruleBasedClassification:!!h?.ruleId,processingTimeMs:d}}catch(c){throw c}}async fetchImageAsBase64(a){try{const r=await(await fetch(a)).blob();return new Promise((c,h)=>{const d=new FileReader;d.onloadend=()=>{const v=d.result.split(",")[1];c({data:v,mediaType:r.type})},d.onerror=h,d.readAsDataURL(r)})}catch(l){throw l}}async callClaudeVision(a){const l=`Analyze this receipt image and extract the following information in JSON format:
{
  "merchant": "Store/vendor name",
  "amount": 0.00,
  "currency": "GBP",
  "date": "YYYY-MM-DD",
  "items": [{"name": "item name", "quantity": 1, "price": 0.00}],
  "paymentMethod": "card/cash/unknown",
  "category": "Travel/Accommodation/Sustenance",
  "confidence": 0.0 to 1.0,
  "rawText": "All visible text from receipt"
}

If any field cannot be determined, use null. For the category, consider:
- Travel: transport, fuel, parking, flights, trains, taxis
- Accommodation: hotels, lodging, rentals
- Sustenance: food, drinks, restaurants, cafes, supermarkets

Be conservative with confidence - only use high values (>0.8) when very certain.`;try{const r=await fetch("/api/scan-receipt",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({image:a,prompt:l})});if(!r.ok)throw new Error("Failed to process receipt with AI");const c=await r.json();return{merchant:c.merchant,amount:c.amount,currency:c.currency||"GBP",date:c.date,items:c.items||[],paymentMethod:c.paymentMethod,aiSuggestedCategory:c.category,aiConfidence:c.confidence,rawText:c.rawText}}catch(r){return{merchant:null,amount:null,currency:"GBP",date:null,items:[],paymentMethod:null,aiSuggestedCategory:null,aiConfidence:0,rawText:null,error:r.message}}}async findClassificationRule(a,l){if(!l)return null;try{const{data:r,error:c}=await $.rpc("find_classification_rule",{p_project_id:a,p_merchant:l});if(c)throw c;return r&&r.length>0?{ruleId:r[0].rule_id,category:r[0].category,subcategory:r[0].subcategory,defaultChargeable:r[0].default_chargeable,defaultProcurement:r[0].default_procurement,confidence:parseFloat(r[0].confidence)}:null}catch{return null}}classifyFromPatterns(a){if(!a)return null;const l=a.toLowerCase();for(const[r,c]of Object.entries(hs))if(l.includes(r))return{category:c,confidence:.7,source:"pattern"};return null}async learnFromCorrection(a,l,r,c,h=!1){if(!l||!r)return null;try{const{data:d,error:v}=await $.rpc("upsert_classification_rule",{p_project_id:a,p_merchant:l,p_category:r,p_user_id:c,p_was_correction:h});if(v)throw v;return d}catch{return null}}async createScan(a){try{const{data:l,error:r}=await $.from("receipt_scans").insert({project_id:a.projectId,uploaded_by:a.userId,image_url:a.imageUrl,image_path:a.imagePath,raw_ocr_text:a.rawText,extracted_merchant:a.merchant,extracted_amount:a.amount,extracted_date:a.date,extracted_currency:a.currency,extracted_items:a.items,ai_suggested_category:a.suggestedCategory,ai_confidence:a.confidence,status:"completed",processing_time_ms:a.processingTimeMs}).select().single();if(r)throw r;return l}catch(l){throw l}}async updateScanClassification(a,l,r=!1){try{const{data:c,error:h}=await $.from("receipt_scans").update({final_category:l,user_corrected:r}).eq("id",a).select().single();if(h)throw h;return c}catch(c){throw c}}async linkToExpense(a,l){try{const{data:r,error:c}=await $.from("receipt_scans").update({expense_id:l,status:"linked"}).eq("id",a).select().single();if(c)throw c;return r}catch(r){throw r}}async getRecentScans(a,l=10){try{const{data:r,error:c}=await $.from("receipt_scans").select("*").eq("project_id",a).order("created_at",{ascending:!1}).limit(l);if(c)throw c;return r||[]}catch{return[]}}async getUnlinkedScans(a){try{const{data:l,error:r}=await $.from("receipt_scans").select("*").eq("project_id",a).is("expense_id",null).eq("status","completed").order("created_at",{ascending:!1});if(r)throw r;return l||[]}catch{return[]}}async getClassificationRules(a){try{const{data:l,error:r}=await $.from("classification_rules").select("*").eq("project_id",a).order("match_count",{ascending:!1});if(r)throw r;return l||[]}catch{return[]}}async deleteClassificationRule(a){try{const{error:l}=await $.from("classification_rules").delete().eq("id",a);if(l)throw l;return!0}catch{return!1}}}const le=new ps,gs=[{id:"Travel",label:"Travel",icon:pe,color:"#2563eb",bg:"#dbeafe"},{id:"Accommodation",label:"Accommodation",icon:ge,color:"#7c3aed",bg:"#f3e8ff"},{id:"Sustenance",label:"Sustenance",icon:xe,color:"#ea580c",bg:"#ffedd5"}],_={PENDING:"pending",PROCESSING:"processing",READY:"ready",SUBMITTED:"submitted",ERROR:"error"},P={UPLOAD:"upload",PROCESSING:"processing",REVIEW:"review"};function xs({onExpenseCreated:t,onCancel:a,resources:l=[],defaultResourceId:r=null}){const{user:c}=De(),{projectId:h}=ze(),{showSuccess:d,showError:v,showWarning:C,showInfo:o}=Fe(),[w,z]=p.useState(P.UPLOAD),[u,f]=p.useState([]),[y,T]=p.useState(0),[F,B]=p.useState({current:0,total:0}),N=p.useRef(null),I=p.useRef(null),R=u[y];u.filter(s=>s.status===_.READY).length;const V=u.filter(s=>s.status===_.SUBMITTED).length;u.filter(s=>s.status===_.PENDING||s.status===_.PROCESSING).length;const L=(s,n=1500,b=.8)=>new Promise((A,m)=>{const j=new FileReader;j.onload=W=>{const q=new Image;q.onload=()=>{let{width:U,height:k}=q;(U>n||k>n)&&(U>k?(k=Math.round(k*n/U),U=n):(U=Math.round(U*n/k),k=n));const J=document.createElement("canvas");J.width=U,J.height=k,J.getContext("2d").drawImage(q,0,0,U,k),J.toBlob(de=>{de?A(de):m(new Error("Failed to compress image"))},"image/jpeg",b)},q.onerror=()=>m(new Error("Failed to load image")),q.src=W.target.result},j.onerror=m,j.readAsDataURL(s)}),g=async s=>{const n=await L(s);return new Promise((b,A)=>{const m=new FileReader;m.onload=()=>{b({data:m.result.split(",")[1],mediaType:"image/jpeg",preview:m.result})},m.onerror=A,m.readAsDataURL(n)})},Q=(s,n)=>({id:`receipt-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,file:s,preview:n,status:_.PENDING,scanResult:null,scanId:null,imageUrl:null,formData:{merchant:"",amount:"",date:new Date().toISOString().split("T")[0],category:"",resource_id:r||"",reason:"",chargeable:!0,procurement:"supplier",notes:""},wasEdited:!1}),M=p.useCallback(async s=>{const n=Array.from(s.target.files||[]);if(n.length===0)return;const b=["image/jpeg","image/png","image/webp","image/heic"],A=[];for(const j of n){if(!b.includes(j.type)){C(`Skipped ${j.name} - invalid file type`);continue}if(j.size>10*1024*1024){C(`Skipped ${j.name} - file too large (max 10MB)`);continue}A.push(j)}if(A.length===0)return;const m=await Promise.all(A.map(async j=>{const{preview:W}=await g(j);return Q(j,W)}));f(j=>[...j,...m]),o(`Added ${m.length} receipt${m.length>1?"s":""}`)},[C,o,r]),oe=p.useCallback(s=>{s.preventDefault();const n=s.dataTransfer.files;n.length>0&&M({target:{files:n}})},[M]),Z=p.useCallback(s=>{s.preventDefault()},[]),je=p.useCallback(s=>{f(n=>{const b=n.filter(A=>A.id!==s);return y>=b.length&&b.length>0&&T(b.length-1),b})},[y]),ee=p.useCallback(()=>{f([]),T(0),z(P.UPLOAD),N.current&&(N.current.value="")},[]),x=p.useCallback(async()=>{if(u.length===0||!h||!c?.id){v("No receipts to process");return}z(P.PROCESSING),B({current:0,total:u.length});const s=[...u];for(let m=0;m<s.length;m++){const j=s[m];if(j.status===_.READY||j.status===_.SUBMITTED){B({current:m+1,total:u.length});continue}s[m]={...j,status:_.PROCESSING},f([...s]);try{const W=await g(j.file),{path:q,url:U}=await le.uploadImage(j.file,c.id),k=await le.processReceipt(W,h),J=await le.createScan({projectId:h,userId:c.id,imageUrl:U,imagePath:q,...k});s[m]={...s[m],status:_.READY,scanResult:k,scanId:J.id,imageUrl:U,formData:{...s[m].formData,merchant:k.merchant||"",amount:k.amount?.toString()||"",date:k.date||new Date().toISOString().split("T")[0],category:k.suggestedCategory||"",reason:k.merchant?`Receipt from ${k.merchant}`:""}}}catch(W){s[m]={...s[m],status:_.ERROR,error:W.message}}f([...s]),B({current:m+1,total:u.length})}z(P.REVIEW);const n=s.findIndex(m=>m.status===_.READY);n>=0&&T(n);const b=s.filter(m=>m.status===_.READY).length,A=s.filter(m=>m.status===_.ERROR).length;A>0?C(`Processed ${b} receipts, ${A} failed`):d(`Successfully scanned ${b} receipt${b>1?"s":""}!`)},[u,h,c,v,d,C]),D=p.useCallback((s,n)=>{f(b=>{const A=[...b];return A[y]={...A[y],formData:{...A[y].formData,[s]:n},wasEdited:!0},A})},[y]),se=p.useCallback(s=>{D("category",s)},[D]),fe=p.useCallback(s=>{s>=0&&s<u.length&&T(s)},[u.length]),ae=p.useCallback(()=>{for(let s=y-1;s>=0;s--)if(u[s].status===_.READY){T(s);return}},[y,u]),ie=p.useCallback(()=>{for(let s=y+1;s<u.length;s++)if(u[s].status===_.READY){T(s);return}},[y,u]),te=u.slice(0,y).some(s=>s.status===_.READY),re=u.slice(y+1).some(s=>s.status===_.READY),ne=p.useCallback(async()=>{const s=R;if(!s||s.status!==_.READY)return;const{formData:n}=s;if(!n.resource_id){C("Please select a resource");return}if(!n.amount||parseFloat(n.amount)<=0){C("Please enter a valid amount");return}if(!n.category){C("Please select a category");return}if(!n.reason){C("Please enter a reason/description");return}try{if(n.merchant&&n.category){const m=s.wasEdited&&s.scanResult?.suggestedCategory!==n.category;await le.learnFromCorrection(h,n.merchant,n.category,c.id,m)}s.scanId&&await le.updateScanClassification(s.scanId,n.category,s.wasEdited);const b={category:n.category,resource_id:n.resource_id,resource_name:l.find(m=>m.id===n.resource_id)?.name,expense_date:n.date,reason:n.reason,amount:parseFloat(n.amount),notes:n.notes,chargeable_to_customer:n.chargeable,procurement_method:n.procurement,receipt_scan_id:s.scanId,receipt_image_url:s.imageUrl};f(m=>{const j=[...m];return j[y]={...j[y],status:_.SUBMITTED},j}),t&&t(b),d(`Expense created: ${n.merchant||"Receipt"} - £${n.amount}`);const A=u.findIndex((m,j)=>j>y&&m.status===_.READY);A>=0&&T(A)}catch(b){v("Failed to create expense: "+b.message)}},[R,y,u,h,c,l,t,d,v,C]),be=s=>{if(!s)return null;let n,b;return s>=.8?(n="#10b981",b="High"):s>=.5?(n="#f59e0b",b="Medium"):(n="#ef4444",b="Low"),e.jsxs("div",{className:"confidence-badge",style:{color:n,borderColor:n},children:[e.jsx(he,{size:14}),b," confidence (",Math.round(s*100),"%)"]})},ce=s=>{switch(s){case _.PENDING:return e.jsx("div",{className:"status-dot pending"});case _.PROCESSING:return e.jsx(we,{size:14,className:"spinner"});case _.READY:return e.jsx("div",{className:"status-dot ready"});case _.SUBMITTED:return e.jsx(X,{size:14,className:"status-check"});case _.ERROR:return e.jsx(_e,{size:14,className:"status-error"});default:return null}};return e.jsxs("div",{className:"receipt-scanner batch-mode",children:[e.jsxs("div",{className:"scanner-header",children:[e.jsxs("div",{className:"scanner-title",children:[e.jsx(K,{size:24}),e.jsxs("div",{children:[e.jsx("h3",{children:"Smart Receipt Scanner"}),e.jsxs("p",{children:[w===P.UPLOAD&&"Upload one or more receipt photos",w===P.PROCESSING&&`Processing ${F.current} of ${F.total}...`,w===P.REVIEW&&`Reviewing ${y+1} of ${u.length} receipts`]})]})]}),a&&e.jsx("button",{className:"btn btn-ghost",onClick:a,children:e.jsx(H,{size:20})})]}),e.jsxs("div",{className:"scanner-steps",children:[e.jsxs("div",{className:`step ${w===P.UPLOAD?"active":w!==P.UPLOAD?"complete":""}`,children:[e.jsx("div",{className:"step-dot",children:"1"}),e.jsx("span",{children:"Upload"})]}),e.jsx("div",{className:"step-line"}),e.jsxs("div",{className:`step ${w===P.PROCESSING?"active":w===P.REVIEW?"complete":""}`,children:[e.jsx("div",{className:"step-dot",children:"2"}),e.jsx("span",{children:"Scan All"})]}),e.jsx("div",{className:"step-line"}),e.jsxs("div",{className:`step ${w===P.REVIEW?"active":""}`,children:[e.jsx("div",{className:"step-dot",children:"3"}),e.jsx("span",{children:"Review"})]})]}),e.jsxs("div",{className:"scanner-content",children:[w===P.UPLOAD&&e.jsxs("div",{className:"upload-section",children:[e.jsxs("div",{className:"drop-zone",onDrop:oe,onDragOver:Z,onClick:()=>N.current?.click(),children:[e.jsx(me,{size:48,className:"drop-icon"}),e.jsx("p",{className:"drop-text",children:"Drag & drop receipt images"}),e.jsx("p",{className:"drop-subtext",children:"or click to browse (select multiple)"}),e.jsxs("div",{className:"upload-buttons",children:[e.jsxs("button",{className:"btn btn-primary",onClick:s=>{s.stopPropagation(),N.current?.click()},children:[e.jsx(me,{size:18})," Choose Files"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:s=>{s.stopPropagation(),I.current?.click()},children:[e.jsx(Ce,{size:18})," Take Photo"]})]}),e.jsx("input",{ref:N,type:"file",accept:"image/jpeg,image/png,image/webp,image/heic",multiple:!0,onChange:M,style:{display:"none"}}),e.jsx("input",{ref:I,type:"file",accept:"image/*",capture:"environment",onChange:M,style:{display:"none"}})]}),u.length>0&&e.jsxs("div",{className:"receipt-queue",children:[e.jsxs("div",{className:"queue-header",children:[e.jsxs("h4",{children:[e.jsx(Ze,{size:18})," ",u.length," Receipt",u.length>1?"s":""," Ready"]}),e.jsxs("button",{className:"btn btn-ghost btn-sm",onClick:ee,children:[e.jsx(Ue,{size:16})," Clear All"]})]}),e.jsxs("div",{className:"queue-grid",children:[u.map((s,n)=>e.jsxs("div",{className:"queue-item",children:[e.jsx("img",{src:s.preview,alt:`Receipt ${n+1}`}),e.jsx("button",{className:"remove-btn",onClick:b=>{b.stopPropagation(),je(s.id)},children:e.jsx(H,{size:14})}),e.jsx("span",{className:"queue-number",children:n+1})]},s.id)),e.jsxs("div",{className:"queue-item add-more",onClick:()=>N.current?.click(),children:[e.jsx(me,{size:24}),e.jsx("span",{children:"Add More"})]})]}),e.jsxs("button",{className:"btn btn-primary btn-lg scan-all-btn",onClick:x,children:[e.jsx(he,{size:20})," Scan All ",u.length," Receipt",u.length>1?"s":""]})]}),e.jsxs("div",{className:"scanner-tips",children:[e.jsxs("h4",{children:[e.jsx(es,{size:16})," Tips for best results"]}),e.jsxs("ul",{children:[e.jsx("li",{children:"Ensure receipts are flat and well-lit"}),e.jsx("li",{children:"Include the full receipt in frame"}),e.jsx("li",{children:"Avoid shadows and glare"}),e.jsx("li",{children:"You can select multiple files at once"})]})]})]}),w===P.PROCESSING&&e.jsxs("div",{className:"processing-section batch-processing",children:[e.jsxs("div",{className:"processing-progress",children:[e.jsx("div",{className:"progress-bar",children:e.jsx("div",{className:"progress-fill",style:{width:`${F.current/F.total*100}%`}})}),e.jsxs("span",{className:"progress-text",children:["Processing receipt ",F.current," of ",F.total]})]}),e.jsx("div",{className:"processing-grid",children:u.map((s,n)=>e.jsxs("div",{className:`processing-item ${s.status}`,children:[e.jsx("img",{src:s.preview,alt:`Receipt ${n+1}`}),e.jsxs("div",{className:"processing-overlay",children:[s.status===_.PROCESSING&&e.jsx(we,{size:24,className:"spinner"}),s.status===_.READY&&e.jsx(X,{size:24,className:"success-icon"}),s.status===_.ERROR&&e.jsx(_e,{size:24,className:"error-icon"})]}),e.jsx("span",{className:"item-number",children:n+1})]},s.id))})]}),w===P.REVIEW&&R&&e.jsxs("div",{className:"review-section batch-review",children:[e.jsxs("div",{className:"receipt-sidebar",children:[e.jsxs("div",{className:"sidebar-header",children:[e.jsx("h4",{children:"Receipts"}),e.jsxs("span",{className:"sidebar-count",children:[V,"/",u.length," submitted"]})]}),e.jsx("div",{className:"sidebar-list",children:u.map((s,n)=>e.jsxs("div",{className:`sidebar-item ${n===y?"active":""} ${s.status}`,onClick:()=>s.status===_.READY&&fe(n),children:[e.jsx("img",{src:s.preview,alt:`Receipt ${n+1}`}),e.jsxs("div",{className:"sidebar-item-info",children:[e.jsx("span",{className:"item-merchant",children:s.formData.merchant||`Receipt ${n+1}`}),e.jsx("span",{className:"item-amount",children:s.formData.amount?`£${s.formData.amount}`:"—"})]}),e.jsx("div",{className:"sidebar-item-status",children:ce(s.status)})]},s.id))})]}),e.jsx("div",{className:"review-main",children:R.status===_.READY?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"review-header",children:[e.jsxs("button",{className:"btn btn-ghost",onClick:ae,disabled:!te,children:[e.jsx(ss,{size:20})," Previous"]}),e.jsxs("div",{className:"review-position",children:["Receipt ",y+1," of ",u.length]}),e.jsxs("button",{className:"btn btn-ghost",onClick:ie,disabled:!re,children:["Next ",e.jsx(Ae,{size:20})]})]}),e.jsxs("div",{className:"extraction-summary",children:[e.jsxs("div",{className:"summary-header",children:[e.jsx("h4",{children:"Extracted Information"}),be(R.scanResult?.confidence)]}),R.scanResult?.ruleBasedClassification&&e.jsxs("div",{className:"rule-notice",children:[e.jsx(he,{size:14}),"Category auto-selected based on previous receipts"]})]}),e.jsxs("div",{className:"review-form",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Resource *"}),e.jsxs("select",{className:"form-input",value:R.formData.resource_id,onChange:s=>D("resource_id",s.target.value),children:[e.jsx("option",{value:"",children:"Select resource..."}),l.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Category *"}),e.jsx("div",{className:"category-selector",children:gs.map(s=>{const n=s.icon,b=R.formData.category===s.id;return e.jsxs("button",{type:"button",className:`category-btn ${b?"selected":""}`,style:{"--cat-color":s.color,"--cat-bg":s.bg},onClick:()=>se(s.id),children:[e.jsx(n,{size:20}),s.label,b&&e.jsx(X,{size:16,className:"check-icon"})]},s.id)})})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Merchant"}),e.jsx("input",{type:"text",className:"form-input",value:R.formData.merchant,onChange:s=>D("merchant",s.target.value),placeholder:"Store/vendor name"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Amount (£) *"}),e.jsx("input",{type:"number",step:"0.01",className:"form-input",value:R.formData.amount,onChange:s=>D("amount",s.target.value),placeholder:"0.00"})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Date *"}),e.jsx("input",{type:"date",className:"form-input",value:R.formData.date,onChange:s=>D("date",s.target.value)})]}),e.jsxs("div",{className:"form-group",style:{flex:2},children:[e.jsx("label",{className:"form-label",children:"Reason/Description *"}),e.jsx("input",{type:"text",className:"form-input",value:R.formData.reason,onChange:s=>D("reason",s.target.value),placeholder:"Brief description of expense"})]})]}),e.jsxs("div",{className:"form-row options-row",children:[e.jsxs("label",{className:"checkbox-label",children:[e.jsx("input",{type:"checkbox",checked:R.formData.chargeable,onChange:s=>D("chargeable",s.target.checked)}),e.jsx("span",{children:"Chargeable to Customer"})]}),e.jsxs("div",{className:"procurement-toggle",children:[e.jsx("span",{children:"Paid by:"}),e.jsxs("select",{className:"form-input-sm",value:R.formData.procurement,onChange:s=>D("procurement",s.target.value),children:[e.jsx("option",{value:"supplier",children:"Supplier (JT)"}),e.jsx("option",{value:"partner",children:"Partner"})]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Additional Notes"}),e.jsx("textarea",{className:"form-input",rows:2,value:R.formData.notes,onChange:s=>D("notes",s.target.value),placeholder:"Any additional information..."})]})]}),e.jsxs("div",{className:"receipt-thumbnail",children:[e.jsx("img",{src:R.preview,alt:"Receipt"}),e.jsx("span",{children:"Receipt attached"})]}),e.jsxs("div",{className:"review-actions",children:[e.jsxs("button",{className:"btn btn-secondary",onClick:()=>z(P.UPLOAD),children:[e.jsx(as,{size:18})," Back to Upload"]}),e.jsxs("button",{className:"btn btn-primary btn-lg",onClick:ne,children:[e.jsx(X,{size:18})," Submit Expense",re&&" & Next"]})]})]}):R.status===_.SUBMITTED?e.jsxs("div",{className:"submitted-message",children:[e.jsx("div",{className:"success-icon-large",children:e.jsx(X,{size:48})}),e.jsx("h3",{children:"Expense Submitted"}),e.jsxs("p",{children:[R.formData.merchant," - £",R.formData.amount]}),re&&e.jsxs("button",{className:"btn btn-primary",onClick:ie,children:["Review Next Receipt ",e.jsx(Ae,{size:18})]})]}):R.status===_.ERROR?e.jsxs("div",{className:"error-message",children:[e.jsx(_e,{size:48,className:"error-icon"}),e.jsx("h3",{children:"Processing Failed"}),e.jsx("p",{children:R.error||"Unable to process this receipt"})]}):null})]}),w===P.REVIEW&&V===u.length&&u.length>0&&e.jsxs("div",{className:"complete-section",children:[e.jsx("div",{className:"success-icon",children:e.jsx(X,{size:48})}),e.jsx("h3",{children:"All Receipts Submitted!"}),e.jsxs("p",{children:[V," expense",V>1?"s":""," created successfully."]}),e.jsxs("div",{className:"complete-actions",children:[e.jsxs("button",{className:"btn btn-primary",onClick:ee,children:[e.jsx(Ce,{size:18})," Scan More Receipts"]}),a&&e.jsx("button",{className:"btn btn-secondary",onClick:a,children:"Done"})]})]})]})]})}const js=["Travel","Accommodation","Sustenance"],fs=["Draft","Submitted","Approved","Rejected","Paid"],bs={Draft:"Draft",Submitted:"Submitted",Approved:"Validated",Rejected:"Rejected",Paid:"Paid"};function vs({filterCategory:t,setFilterCategory:a,filterResource:l,setFilterResource:r,filterStatus:c,setFilterStatus:h,filterChargeable:d,setFilterChargeable:v,filterProcurement:C,setFilterProcurement:o,resourceNames:w,hasRole:z}){const u={padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"};return e.jsx("div",{className:"card",style:{marginBottom:"1.5rem"},children:e.jsxs("div",{style:{display:"flex",gap:"1rem",alignItems:"center",flexWrap:"wrap"},children:[e.jsx("span",{style:{fontWeight:"500"},children:"Filter:"}),e.jsxs("select",{value:t,onChange:f=>a(f.target.value),style:u,children:[e.jsx("option",{value:"all",children:"All Types"}),js.map(f=>e.jsx("option",{value:f,children:f},f))]}),e.jsxs("select",{value:l,onChange:f=>r(f.target.value),style:u,children:[e.jsx("option",{value:"all",children:"All Resources"}),w.map(f=>e.jsx("option",{value:f,children:f},f))]}),e.jsxs("select",{value:c,onChange:f=>h(f.target.value),style:u,children:[e.jsx("option",{value:"all",children:"All Statuses"}),fs.map(f=>e.jsx("option",{value:f,children:bs[f]||f},f))]}),e.jsxs("select",{value:d,onChange:f=>v(f.target.value),style:u,children:[e.jsx("option",{value:"all",children:"All Expenses"}),e.jsx("option",{value:"chargeable",children:"Chargeable Only"}),e.jsx("option",{value:"non-chargeable",children:"Non-Chargeable Only"})]}),z(["admin","supplier_pm"])&&e.jsxs("select",{value:C,onChange:f=>o(f.target.value),style:u,children:[e.jsx("option",{value:"all",children:"All Procurement"}),e.jsx("option",{value:"supplier",children:"Supplier Procured"}),e.jsx("option",{value:"partner",children:"Partner Procured"})]})]})})}function Ne({category:t,icon:a,bgColor:l,textColor:r,borderColor:c,amount:h,reason:d,chargeable:v,procurement:C,onAmountChange:o,onReasonChange:w,onChargeableChange:z,onProcurementChange:u,hasRole:f}){return e.jsxs("div",{style:{padding:"1rem",backgroundColor:l,borderRadius:"8px",marginBottom:"1rem"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",color:r,marginBottom:"0.75rem"},children:[a,e.jsx("span",{style:{fontWeight:"600",fontSize:"1rem"},children:t})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"150px 1fr",gap:"1rem",marginBottom:"0.75rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Amount (£)"}),e.jsx("input",{type:"number",step:"0.01",className:"form-input",placeholder:"0.00",value:h,onChange:y=>o(y.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Reason / Description"}),e.jsx("input",{type:"text",className:"form-input",placeholder:`e.g., ${t} expense description`,value:d,onChange:y=>w(y.target.value)})]})]}),parseFloat(h)>0&&e.jsxs("div",{style:{display:"flex",gap:"1.5rem",flexWrap:"wrap",paddingTop:"0.75rem",borderTop:`1px solid ${c}`},children:[e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"0.5rem",cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:v,onChange:y=>z(y.target.checked),style:{width:"16px",height:"16px",accentColor:r}}),e.jsx("span",{style:{fontSize:"0.85rem",color:r},children:"Chargeable to Customer"})]}),f(["admin","supplier_pm"])&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.85rem",color:r},children:"Paid by:"}),e.jsxs("select",{value:C,onChange:y=>u(y.target.value),style:{padding:"0.25rem 0.5rem",borderRadius:"4px",border:`1px solid ${c}`,fontSize:"0.85rem",backgroundColor:"#fff"},children:[e.jsx("option",{value:"supplier",children:"Supplier (JT)"}),e.jsx("option",{value:"partner",children:"Partner"})]})]})]})]})}function ys({newExpense:t,setNewExpense:a,availableResources:l,hasRole:r,handleAdd:c,handleFileSelect:h,removeFile:d,uploadingFiles:v,onCancel:C}){return e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem",border:"2px solid var(--primary)"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Add New Expenses"}),e.jsx("p",{style:{color:"#64748b",fontSize:"0.9rem",marginBottom:"1rem"},children:"Enter amounts for any categories that apply. Leave blank to skip a category."}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem",marginBottom:"1.5rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Resource Name *"}),e.jsxs("select",{className:"form-input",value:t.resource_id,onChange:o=>a({...t,resource_id:o.target.value}),children:[e.jsx("option",{value:"",children:"Select Resource"}),l.map(o=>e.jsx("option",{value:o.id,children:o.name},o.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Date *"}),e.jsx("input",{type:"date",className:"form-input",value:t.expense_date,onChange:o=>a({...t,expense_date:o.target.value})})]})]}),e.jsx(Ne,{category:"Travel",icon:e.jsx(pe,{size:20}),bgColor:"#dbeafe",textColor:"#2563eb",borderColor:"#93c5fd",amount:t.travel_amount,reason:t.travel_reason,chargeable:t.travel_chargeable,procurement:t.travel_procurement,onAmountChange:o=>a({...t,travel_amount:o}),onReasonChange:o=>a({...t,travel_reason:o}),onChargeableChange:o=>a({...t,travel_chargeable:o}),onProcurementChange:o=>a({...t,travel_procurement:o}),hasRole:r}),e.jsx(Ne,{category:"Accommodation",icon:e.jsx(ge,{size:20}),bgColor:"#f3e8ff",textColor:"#7c3aed",borderColor:"#d8b4fe",amount:t.accommodation_amount,reason:t.accommodation_reason,chargeable:t.accommodation_chargeable,procurement:t.accommodation_procurement,onAmountChange:o=>a({...t,accommodation_amount:o}),onReasonChange:o=>a({...t,accommodation_reason:o}),onChargeableChange:o=>a({...t,accommodation_chargeable:o}),onProcurementChange:o=>a({...t,accommodation_procurement:o}),hasRole:r}),e.jsx(Ne,{category:"Sustenance",icon:e.jsx(xe,{size:20}),bgColor:"#ffedd5",textColor:"#ea580c",borderColor:"#fdba74",amount:t.sustenance_amount,reason:t.sustenance_reason,chargeable:t.sustenance_chargeable,procurement:t.sustenance_procurement,onAmountChange:o=>a({...t,sustenance_amount:o}),onReasonChange:o=>a({...t,sustenance_reason:o}),onChargeableChange:o=>a({...t,sustenance_chargeable:o}),onProcurementChange:o=>a({...t,sustenance_procurement:o}),hasRole:r}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{className:"form-label",children:"Additional Notes"}),e.jsx("textarea",{className:"form-input",rows:2,placeholder:"Any additional information...",value:t.notes,onChange:o=>a({...t,notes:o.target.value})})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{className:"form-label",children:"Attach Receipts"}),e.jsxs("div",{style:{border:"2px dashed #d1d5db",borderRadius:"8px",padding:"1.5rem",textAlign:"center",cursor:"pointer",backgroundColor:"#f9fafb"},onClick:()=>document.getElementById("file-upload").click(),children:[e.jsx(me,{size:24,style:{color:"#9ca3af",marginBottom:"0.5rem"}}),e.jsx("div",{style:{color:"#64748b",fontSize:"0.85rem"},children:"Click to upload receipts"}),e.jsx("input",{id:"file-upload",type:"file",multiple:!0,accept:".pdf,.jpg,.jpeg,.png,.zip",style:{display:"none"},onChange:h})]}),t.files.length>0&&e.jsx("div",{style:{marginTop:"0.5rem"},children:t.files.map((o,w)=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.25rem 0",fontSize:"0.85rem"},children:[e.jsx(ts,{size:14}),e.jsx("span",{style:{flex:1},children:o.name}),e.jsx("button",{onClick:()=>d(w),style:{background:"none",border:"none",cursor:"pointer",color:"#ef4444"},children:e.jsx(H,{size:14})})]},w))})]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsxs("button",{className:"btn btn-primary",onClick:c,disabled:v,children:[e.jsx(Oe,{size:16})," ",v?"Uploading...":"Save Expenses"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:C,children:[e.jsx(H,{size:16})," Cancel"]})]})]})}const _s={Draft:"Draft",Submitted:"Submitted",Approved:"Validated",Rejected:"Rejected",Paid:"Paid"};function Ns(t){switch(t){case"Travel":return e.jsx(pe,{size:14});case"Accommodation":return e.jsx(ge,{size:14});case"Sustenance":return e.jsx(xe,{size:14});default:return e.jsx(K,{size:14})}}function Cs(t){switch(t){case"Travel":return"category-travel";case"Accommodation":return"category-accommodation";case"Sustenance":return"category-sustenance";default:return"category-default"}}function Ss(t){switch(t){case"Approved":case"Paid":return"status-validated";case"Submitted":return"status-submitted";case"Rejected":return"status-rejected";default:return"status-draft"}}function Rs(t){return t==="partner"?"procurement-partner":"procurement-supplier"}function ws({expense:t,showProcurement:a,setDetailModal:l}){const r=t.chargeable_to_customer!==!1,c=t.expense_files?.length>0;return e.jsxs("tr",{onClick:()=>l({isOpen:!0,expense:t}),children:[e.jsx("td",{className:"cell-ref",children:t.expense_ref||"-"}),e.jsx("td",{children:e.jsxs("span",{className:`category-badge ${Cs(t.category)}`,children:[Ns(t.category),e.jsx("span",{children:t.category})]})}),e.jsx("td",{className:"cell-resource",children:t.resource_name}),e.jsx("td",{className:"cell-date",children:new Date(t.expense_date).toLocaleDateString("en-GB")}),e.jsx("td",{className:"cell-reason",children:e.jsx("span",{className:"reason-text",children:t.reason})}),e.jsxs("td",{className:"cell-amount",children:["£",parseFloat(t.amount).toFixed(2)]}),e.jsx("td",{children:e.jsxs("span",{className:`chargeable-badge ${r?"chargeable-yes":"chargeable-no"}`,children:[r?e.jsx(X,{size:12}):e.jsx(H,{size:12}),e.jsx("span",{children:r?"Yes":"No"})]})}),a&&e.jsx("td",{children:e.jsxs("span",{className:`procurement-badge ${Rs(t.procurement_method)}`,children:[(t.procurement_method||"supplier")==="partner"?e.jsx($e,{size:12}):e.jsx(Be,{size:12}),e.jsx("span",{children:(t.procurement_method||"supplier")==="partner"?"Partner":"Supplier"})]})}),e.jsx("td",{children:e.jsx("span",{className:`status-badge ${Ss(t.status)}`,children:_s[t.status]||t.status})}),e.jsx("td",{className:"cell-receipts",children:c&&e.jsxs("span",{className:"receipts-indicator",children:[e.jsx(Le,{size:14}),e.jsx("span",{children:t.expense_files.length})]})})]})}function As({expenses:t,hasRole:a,setDetailModal:l}){const r=a(["admin","supplier_pm"]);return e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"expense-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Ref"}),e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Resource"}),e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Reason"}),e.jsx("th",{className:"text-right",children:"Amount"}),e.jsx("th",{children:"Chargeable"}),r&&e.jsx("th",{children:"Procured By"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Receipts"})]})}),e.jsx("tbody",{children:t.length===0?e.jsx("tr",{className:"empty-row",children:e.jsx("td",{colSpan:r?10:9,children:e.jsxs("div",{className:"empty-state",children:[e.jsx(K,{size:32}),e.jsx("p",{children:"No expenses found"})]})})}):t.map(c=>e.jsx(ws,{expense:c,showProcurement:r,setDetailModal:l},c.id))})]})})}const ks=["Travel","Accommodation","Sustenance"],Ps=["Draft","Submitted","Approved","Rejected","Paid"],Ee={Draft:"Draft",Submitted:"Submitted",Approved:"Validated",Rejected:"Rejected",Paid:"Paid"};function Es(t){switch(t){case"Travel":return e.jsx(pe,{size:20});case"Accommodation":return e.jsx(ge,{size:20});case"Sustenance":return e.jsx(xe,{size:20});default:return e.jsx(K,{size:20})}}function Ts(t){switch(t){case"Travel":return"cat-travel";case"Accommodation":return"cat-accommodation";case"Sustenance":return"cat-sustenance";default:return"cat-default"}}function Is(t){switch(t){case"Approved":case"Paid":return"stat-validated";case"Submitted":return"stat-submitted";case"Rejected":return"stat-rejected";default:return"stat-draft"}}function Ds(t){const{data:a}=$.storage.from("receipts").getPublicUrl(t);return a?.publicUrl||null}function Te(t){const a=[".jpg",".jpeg",".png",".gif",".webp",".bmp",".svg"],l=t.toLowerCase().substring(t.lastIndexOf("."));return a.includes(l)}function zs({files:t,onDownload:a}){const[l,r]=p.useState(null),[c,h]=p.useState({});return p.useEffect(()=>{const d={};t.forEach(v=>{Te(v.file_name)&&(d[v.id||v.file_path]=Ds(v.file_path))}),h(d)},[t]),!t||t.length===0?null:e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"receipts-section",children:[e.jsxs("div",{className:"section-label",children:[e.jsx(Le,{size:16}),e.jsxs("span",{children:["Receipts (",t.length,")"]})]}),e.jsx("div",{className:"receipts-grid",children:t.map((d,v)=>{const C=d.id||d.file_path,o=c[C],w=Te(d.file_name);return e.jsxs("div",{className:"receipt-item",children:[w&&o?e.jsxs("div",{className:"receipt-image-container",onClick:()=>r({url:o,name:d.file_name}),children:[e.jsx("img",{src:o,alt:d.file_name,className:"receipt-thumbnail"}),e.jsx("div",{className:"receipt-overlay",children:e.jsx(is,{size:20})})]}):e.jsx("div",{className:"receipt-file-icon",onClick:()=>a(d.file_path,d.file_name),children:e.jsx(K,{size:24})}),e.jsxs("div",{className:"receipt-info",children:[e.jsx("span",{className:"receipt-name",title:d.file_name,children:d.file_name.length>20?d.file_name.substring(0,17)+"...":d.file_name}),e.jsx("button",{className:"receipt-download",onClick:z=>{z.stopPropagation(),a(d.file_path,d.file_name)},title:"Download",children:e.jsx(ds,{size:14})})]})]},v)})})]}),l&&e.jsx("div",{className:"image-modal-overlay",onClick:()=>r(null),children:e.jsxs("div",{className:"image-modal-content",onClick:d=>d.stopPropagation(),children:[e.jsx("button",{className:"image-modal-close",onClick:()=>r(null),children:e.jsx(H,{size:24})}),e.jsx("img",{src:l.url,alt:l.name,className:"image-modal-img"}),e.jsx("div",{className:"image-modal-caption",children:l.name})]})})]})}function Fs({isOpen:t,expense:a,resources:l,hasRole:r,canEditChargeable:c,canSubmitExpense:h,canValidateExpense:d,canEditExpense:v,canDeleteExpense:C,onClose:o,onSave:w,onSubmit:z,onValidate:u,onReject:f,onDelete:y,onDownloadFile:T}){const[F,B]=p.useState(!1),[N,I]=p.useState({});if(p.useEffect(()=>{a&&(I({category:a.category,resource_id:a.resource_id,expense_date:a.expense_date,reason:a.reason,amount:a.amount,notes:a.notes||"",status:a.status,chargeable_to_customer:a.chargeable_to_customer!==!1,procurement_method:a.procurement_method||"supplier"}),B(!1))},[a]),!t||!a)return null;const R=a.chargeable_to_customer!==!1;async function V(){await w(a.id,N),B(!1)}function L(){B(!1),o()}return e.jsx("div",{className:"modal-overlay",onClick:L,children:e.jsxs("div",{className:"modal-container",onClick:g=>g.stopPropagation(),children:[e.jsxs("header",{className:"modal-header",children:[e.jsxs("div",{className:"modal-header-left",children:[e.jsx("div",{className:`modal-icon ${Ts(a.category)}`,children:Es(a.category)}),e.jsxs("div",{className:"modal-title-group",children:[e.jsx("h2",{children:a.expense_ref||"Expense Details"}),e.jsxs("span",{children:[a.category," Expense"]})]})]}),e.jsxs("div",{className:"modal-header-right",children:[e.jsx("span",{className:`modal-status ${Is(a.status)}`,children:Ee[a.status]||a.status}),e.jsx("button",{className:"modal-close",onClick:L,children:e.jsx(H,{size:20})})]})]}),e.jsx("div",{className:"modal-body",children:F?e.jsxs("div",{className:"edit-form",children:[e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Category"}),e.jsx("select",{value:N.category,onChange:g=>I({...N,category:g.target.value}),children:ks.map(g=>e.jsx("option",{value:g,children:g},g))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Resource"}),e.jsxs("select",{value:N.resource_id||"",onChange:g=>I({...N,resource_id:g.target.value}),children:[e.jsx("option",{value:"",children:"-- Select --"}),l.map(g=>e.jsx("option",{value:g.id,children:g.name},g.id))]})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Date"}),e.jsx("input",{type:"date",value:N.expense_date,onChange:g=>I({...N,expense_date:g.target.value})})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Amount (£)"}),e.jsx("input",{type:"number",step:"0.01",value:N.amount,onChange:g=>I({...N,amount:g.target.value})})]})]}),e.jsxs("div",{className:"form-group full-width",children:[e.jsx("label",{children:"Reason"}),e.jsx("input",{type:"text",value:N.reason,onChange:g=>I({...N,reason:g.target.value})})]}),e.jsxs("div",{className:"form-group full-width",children:[e.jsx("label",{children:"Notes"}),e.jsx("textarea",{rows:3,value:N.notes,onChange:g=>I({...N,notes:g.target.value})})]}),e.jsxs("div",{className:"form-row",children:[c()&&e.jsxs("label",{className:"checkbox-label",children:[e.jsx("input",{type:"checkbox",checked:N.chargeable_to_customer,onChange:g=>I({...N,chargeable_to_customer:g.target.checked})}),e.jsx("span",{children:"Chargeable to Customer"})]}),r(["admin","supplier_pm"])&&e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Procurement"}),e.jsxs("select",{value:N.procurement_method,onChange:g=>I({...N,procurement_method:g.target.value}),children:[e.jsx("option",{value:"supplier",children:"Supplier"}),e.jsx("option",{value:"partner",children:"Partner"})]})]})]}),d(a)&&e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Status"}),e.jsx("select",{value:N.status,onChange:g=>I({...N,status:g.target.value}),children:Ps.map(g=>e.jsx("option",{value:g,children:Ee[g]||g},g))})]})]}):e.jsxs("div",{className:"view-content",children:[e.jsxs("div",{className:"details-grid",children:[e.jsxs("div",{className:"detail-item",children:[e.jsx(rs,{size:18}),e.jsxs("div",{children:[e.jsx("span",{className:"detail-label",children:"Resource"}),e.jsx("span",{className:"detail-value",children:a.resource_name||"Unknown"})]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx(ns,{size:18}),e.jsxs("div",{children:[e.jsx("span",{className:"detail-label",children:"Date"}),e.jsx("span",{className:"detail-value",children:new Date(a.expense_date).toLocaleDateString("en-GB")})]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx(cs,{size:18}),e.jsxs("div",{children:[e.jsx("span",{className:"detail-label",children:"Amount"}),e.jsxs("span",{className:"detail-value amount",children:["£",parseFloat(a.amount).toFixed(2)]})]})]}),e.jsxs("div",{className:"detail-item",children:[R?e.jsx(ke,{size:18,className:"icon-success"}):e.jsx(H,{size:18,className:"icon-warning"}),e.jsxs("div",{children:[e.jsx("span",{className:"detail-label",children:"Chargeable"}),e.jsx("span",{className:`detail-value ${R?"text-success":"text-warning"}`,children:R?"Yes":"No"})]})]})]}),e.jsxs("div",{className:"info-section",children:[e.jsx("span",{className:"section-label",children:"Reason"}),e.jsx("p",{className:"section-content",children:a.reason||"No reason provided"})]}),a.notes&&e.jsxs("div",{className:"info-section",children:[e.jsx("span",{className:"section-label",children:"Notes"}),e.jsx("p",{className:"section-content secondary",children:a.notes})]}),r(["admin","supplier_pm"])&&e.jsxs("div",{className:"info-section inline",children:[(a.procurement_method||"supplier")==="partner"?e.jsx($e,{size:18,className:"icon-purple"}):e.jsx(Be,{size:18,className:"icon-blue"}),e.jsxs("div",{children:[e.jsx("span",{className:"section-label",children:"Procured By"}),e.jsx("span",{className:"section-content",children:(a.procurement_method||"supplier")==="partner"?"Partner (Reimbursable)":"Supplier (JT Direct)"})]})]}),e.jsx(zs,{files:a.expense_files||[],onDownload:T}),e.jsxs("div",{className:"timestamps",children:[e.jsxs("span",{children:[e.jsx(Pe,{size:14})," Created: ",a.created_at?new Date(a.created_at).toLocaleString("en-GB"):"Unknown"]}),a.updated_at&&a.updated_at!==a.created_at&&e.jsxs("span",{children:[e.jsx(Pe,{size:14})," Updated: ",new Date(a.updated_at).toLocaleString("en-GB")]})]})]})}),e.jsxs("footer",{className:"modal-footer",children:[e.jsx("div",{className:"footer-left",children:C(a)&&!F&&e.jsxs("button",{onClick:()=>{y(a),L()},className:"btn btn-danger",children:[e.jsx(Ue,{size:16})," Delete"]})}),e.jsx("div",{className:"footer-right",children:F?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>B(!1),className:"btn btn-secondary",children:"Cancel"}),e.jsxs("button",{onClick:V,className:"btn btn-primary",children:[e.jsx(Oe,{size:16})," Save Changes"]})]}):e.jsxs(e.Fragment,{children:[h(a)&&e.jsxs("button",{onClick:()=>{z(a.id),L()},className:"btn btn-secondary",children:[e.jsx(ls,{size:16})," Submit"]}),d(a)&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>{f(a.id),L()},className:"btn btn-danger",children:[e.jsx(H,{size:16})," Reject"]}),e.jsxs("button",{onClick:()=>{u(a.id),L()},className:"btn btn-success",children:[e.jsx(ke,{size:16})," Validate"]})]}),v(a)&&e.jsxs("button",{onClick:()=>B(!0),className:"btn btn-primary",children:[e.jsx(os,{size:16})," Edit"]})]})})]})]})})}const Us=20520,Ie={resource_id:"",expense_date:new Date().toISOString().split("T")[0],travel_amount:"",travel_reason:"",travel_chargeable:!0,travel_procurement:"supplier",accommodation_amount:"",accommodation_reason:"",accommodation_chargeable:!0,accommodation_procurement:"supplier",sustenance_amount:"",sustenance_reason:"",sustenance_chargeable:!0,sustenance_procurement:"supplier",notes:"",files:[]};function Ys(){const{user:t,role:a}=De(),{projectId:l}=ze(),{showSuccess:r,showError:c,showWarning:h}=Fe(),{showTestUsers:d,testUserIds:v}=Je(),C=t?.id||null,{canAddExpense:o,canSubmitExpense:w,canValidateExpense:z,canEditExpense:u,canDeleteExpense:f,getAvailableResources:y,hasRole:T}=Xe(),[F,B]=p.useState([]),[N,I]=p.useState([]),[R,V]=p.useState(!0),[L,g]=p.useState(!1),[Q,M]=p.useState(!1),[oe,Z]=p.useState("form"),[je,ee]=p.useState(!1),[x,D]=p.useState(Ie),[se,fe]=p.useState("all"),[ae,ie]=p.useState("all"),[te,re]=p.useState("all"),[ne,be]=p.useState("all"),[ce,s]=p.useState("all"),[n,b]=p.useState({isOpen:!1,expenseId:null,expenseData:null}),[A,m]=p.useState({isOpen:!1,expense:null}),j=p.useCallback(async()=>{if(l){V(!0);try{const i=await Y.getAllFiltered(l,d);B(i);const{data:S}=await $.from("resources").select("id, name, email, user_id, partner_id, partner:partners(id, name)").order("name");let E=S||[];!d&&v?.length>0&&(E=E.filter(O=>!O.user_id||!v.includes(O.user_id))),I(E)}catch{c("Failed to load expenses")}finally{V(!1),g(!1)}}},[l,d,v,c]);p.useEffect(()=>{j()},[j]);async function W(){g(!0),await j()}async function q(){if(!x.resource_id){h("Please select a resource");return}const i=parseFloat(x.travel_amount)>0,S=parseFloat(x.accommodation_amount)>0,E=parseFloat(x.sustenance_amount)>0;if(!i&&!S&&!E){h("Please enter at least one expense amount");return}if(i&&!x.travel_reason){h("Please enter a reason for the travel expense");return}if(S&&!x.accommodation_reason){h("Please enter a reason for the accommodation expense");return}if(E&&!x.sustenance_reason){h("Please enter a reason for the sustenance expense");return}try{const O=N.find(ye=>ye.id===x.resource_id)?.name,G=[];i&&G.push({project_id:l,category:"Travel",resource_id:x.resource_id,resource_name:O,expense_date:x.expense_date,reason:x.travel_reason,amount:parseFloat(x.travel_amount),notes:x.notes,created_by:C,chargeable_to_customer:x.travel_chargeable,procurement_method:x.travel_procurement}),S&&G.push({project_id:l,category:"Accommodation",resource_id:x.resource_id,resource_name:O,expense_date:x.expense_date,reason:x.accommodation_reason,amount:parseFloat(x.accommodation_amount),notes:x.notes,created_by:C,chargeable_to_customer:x.accommodation_chargeable,procurement_method:x.accommodation_procurement}),E&&G.push({project_id:l,category:"Sustenance",resource_id:x.resource_id,resource_name:O,expense_date:x.expense_date,reason:x.sustenance_reason,amount:parseFloat(x.sustenance_amount),notes:x.notes,created_by:C,chargeable_to_customer:x.sustenance_chargeable,procurement_method:x.sustenance_procurement});const Re=await Y.createMany(G);if(x.files.length>0&&Re){ee(!0);for(const ye of Re)for(const He of x.files)try{await Y.uploadReceipt(ye.id,He,C)}catch{}ee(!1)}await j(),M(!1),D(Ie),r("Expenses added successfully!")}catch(O){c("Failed to add expenses: "+O.message)}}async function U(i){try{await Y.create({project_id:l,category:i.category,resource_id:i.resource_id,resource_name:i.resource_name,expense_date:i.expense_date,reason:i.reason,amount:i.amount,notes:i.notes,created_by:C,chargeable_to_customer:i.chargeable_to_customer,procurement_method:i.procurement_method}),await j()}catch(S){c("Failed to create expense: "+S.message)}}function k(i){b({isOpen:!0,expenseId:i.id,expenseData:{resourceName:i.resource_name,date:i.expense_date,totalAmount:parseFloat(i.amount||0),category:i.category,chargeable:i.chargeable_to_customer,procurement:i.procurement_method,status:i.status}})}async function J(){if(n.expenseId)try{await Y.delete(n.expenseId,C),await j(),b({isOpen:!1,expenseId:null,expenseData:null}),r("Expense deleted")}catch(i){c("Failed to delete: "+i.message)}}async function Se(i){if(confirm("Submit this expense for validation?"))try{await Y.submit(i),await j(),r("Expense submitted for validation!")}catch(S){c("Failed to submit: "+S.message)}}async function de(i){try{await Y.validate(i),await j(),r("Expense validated!")}catch(S){c("Failed to validate: "+S.message)}}async function Me(i){const S=prompt("Please provide a reason for rejection (optional):");try{await Y.reject(i,S),await j(),h("Expense rejected")}catch(E){c("Failed to reject: "+E.message)}}function Ge(i){const S=Array.from(i.target.files);D({...x,files:[...x.files,...S]})}function Ye(i){D({...x,files:x.files.filter((S,E)=>E!==i)})}async function Ve(i,S){try{const E=await Y.downloadReceipt(i),O=URL.createObjectURL(E),G=document.createElement("a");G.href=O,G.download=S,document.body.appendChild(G),G.click(),document.body.removeChild(G),URL.revokeObjectURL(O)}catch{c("Failed to download file")}}function We(){return T(["admin","supplier_pm","customer_pm"])}const ve=F.filter(i=>!(se!=="all"&&i.category!==se||ae!=="all"&&i.resource_name!==ae||te!=="all"&&i.status!==te||ne==="chargeable"&&i.chargeable_to_customer===!1||ne==="non-chargeable"&&i.chargeable_to_customer!==!1||ce!=="all"&&(i.procurement_method||"supplier")!==ce)),ue=y(N),qe=[...new Set(F.map(i=>i.resource_name))];return R&&!l?e.jsx(Ke,{message:"Loading expenses...",size:"large",fullPage:!0}):e.jsxs("div",{className:"expenses-page",children:[e.jsx("header",{className:"exp-header",children:e.jsxs("div",{className:"exp-header-content",children:[e.jsxs("div",{className:"exp-header-left",children:[e.jsx("div",{className:"exp-header-icon",children:e.jsx(K,{size:24})}),e.jsxs("div",{children:[e.jsx("h1",{children:"Expenses"}),e.jsxs("p",{children:["Track project expenses against £",Us.toLocaleString()," budget"]})]})]}),e.jsxs("div",{className:"exp-header-actions",children:[e.jsxs("button",{className:"exp-btn exp-btn-secondary",onClick:W,disabled:L,children:[e.jsx(us,{size:16,className:L?"spinning":""})," Refresh"]}),o&&!Q&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"exp-btn exp-btn-primary",onClick:()=>{Z("form"),M(!0)},children:[e.jsx(ms,{size:16})," Add Expenses"]}),e.jsxs("button",{className:"exp-btn exp-btn-scanner",onClick:()=>{Z("scanner"),M(!0)},title:"Scan a receipt with AI",children:[e.jsx(Ce,{size:16})," ",e.jsx(he,{size:12})," Scan Receipt"]})]})]})]})}),e.jsxs("div",{className:"exp-content",children:[e.jsx(vs,{filterCategory:se,setFilterCategory:fe,filterResource:ae,setFilterResource:ie,filterStatus:te,setFilterStatus:re,filterChargeable:ne,setFilterChargeable:be,filterProcurement:ce,setFilterProcurement:s,resourceNames:qe,hasRole:T}),Q&&oe==="form"&&e.jsx(ys,{newExpense:x,setNewExpense:D,availableResources:ue,hasRole:T,handleAdd:q,handleFileSelect:Ge,removeFile:Ye,uploadingFiles:je,onCancel:()=>M(!1)}),Q&&oe==="scanner"&&e.jsx("div",{className:"exp-scanner-wrapper",children:e.jsx(xs,{resources:ue,defaultResourceId:ue.length===1?ue[0].id:null,onExpenseCreated:U,onCancel:()=>{M(!1),Z("form")}})}),e.jsxs("div",{className:"exp-table-card",children:[e.jsxs("div",{className:"exp-table-header",children:[e.jsx("h2",{className:"exp-table-title",children:"Expense Entries"}),e.jsxs("span",{className:"exp-table-count",children:[ve.length," expense",ve.length!==1?"s":""]})]}),e.jsx(As,{expenses:ve,hasRole:T,setDetailModal:m})]})]}),e.jsx(Qe,{isOpen:n.isOpen,onClose:()=>b({isOpen:!1,expenseId:null,expenseData:null}),onConfirm:J,title:"Delete Expense",message:n.expenseData?e.jsxs("div",{children:[e.jsx("p",{children:"Are you sure you want to delete this expense?"}),e.jsxs("div",{style:{backgroundColor:"#fef3c7",border:"1px solid #f59e0b",borderRadius:"8px",padding:"12px",marginTop:"12px"},children:[e.jsx("p",{style:{fontWeight:"600",color:"#92400e",margin:"0 0 8px 0",fontSize:"14px"},children:"Details:"}),e.jsxs("ul",{style:{margin:"0",paddingLeft:"20px",color:"#92400e",fontSize:"13px",lineHeight:"1.6"},children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Resource:"})," ",n.expenseData.resourceName]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Category:"})," ",n.expenseData.category]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Amount:"})," £",n.expenseData.totalAmount?.toFixed(2)]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Status:"})," ",n.expenseData.status]})]})]})]}):"Are you sure you want to delete this expense?",confirmText:"Delete",cancelText:"Cancel",variant:"danger"}),e.jsx(Fs,{isOpen:A.isOpen,expense:A.expense,resources:N,hasRole:T,canEditChargeable:We,canSubmitExpense:w,canValidateExpense:z,canEditExpense:u,canDeleteExpense:f,onClose:()=>m({isOpen:!1,expense:null}),onSave:async(i,S)=>{const E=N.find(O=>O.id===S.resource_id)?.name||S.resource_name;await Y.update(i,{category:S.category,resource_id:S.resource_id,resource_name:E,expense_date:S.expense_date,reason:S.reason,amount:parseFloat(S.amount),notes:S.notes,status:S.status,chargeable_to_customer:S.chargeable_to_customer,procurement_method:S.procurement_method}),await j(),r("Expense updated!")},onSubmit:Se,onValidate:de,onReject:Me,onDelete:k,onDownloadFile:Ve})]})}export{Ys as default};
