import{s as $,u as ze,a as Fe,c as Oe,j as e,f as as,d as ts,l as W,L as rs}from"./index-DBy7juAg.js";import{r as h}from"./vendor-react-BUTV5ZEl.js";import{C as we}from"./ConfirmDialog-C4qxA-j9.js";import{P as ns}from"./PromptDialog-CFqJWDkF.js";import{o as K,c as H,aB as me,aC as Ce,aD as cs,T as Ue,S as he,H as ls,g as Ae,e as X,a5 as _e,ap as os,w as ke,aE as pe,aF as ge,aG as xe,y as is,F as ds,al as $e,n as Be,au as Le,aH as Me,U as us,h as ms,ac as hs,b as Pe,p as Ee,i as ps,ak as gs,ar as xs,E as js,R as fs,aj as bs}from"./vendor-icons-L8EmaAR6.js";import"./vendor-supabase-6faYzd5A.js";const vs={uber:"Travel",lyft:"Travel",taxi:"Travel",train:"Travel",rail:"Travel",airlines:"Travel",airways:"Travel",petrol:"Travel","gas station":"Travel",fuel:"Travel",parking:"Travel",hotel:"Accommodation",inn:"Accommodation",motel:"Accommodation",airbnb:"Accommodation","booking.com":"Accommodation",marriott:"Accommodation",hilton:"Accommodation","premier inn":"Accommodation",travelodge:"Accommodation",restaurant:"Sustenance",cafe:"Sustenance",coffee:"Sustenance",costa:"Sustenance",starbucks:"Sustenance",pret:"Sustenance",greggs:"Sustenance",mcdonald:"Sustenance",subway:"Sustenance",nando:"Sustenance",pizza:"Sustenance",pub:"Sustenance",bar:"Sustenance",food:"Sustenance",supermarket:"Sustenance",tesco:"Sustenance",sainsbury:"Sustenance","co-op":"Sustenance",waitrose:"Sustenance",aldi:"Sustenance",lidl:"Sustenance"};class ys{constructor(){this.bucketName="receipt-scans"}async uploadImage(a,l){try{if(!["image/jpeg","image/png","image/webp","image/heic"].includes(a.type))throw new Error("Invalid file type. Please upload a JPEG, PNG, or WebP image.");const c=10*1024*1024;if(a.size>c)throw new Error("File too large. Maximum size is 10MB.");const p=Date.now(),d=a.name.split(".").pop(),b=`${l}/${p}.${d}`,{error:N}=await $.storage.from(this.bucketName).upload(b,a);if(N)throw N;const{data:{publicUrl:i}}=$.storage.from(this.bucketName).getPublicUrl(b);return{path:b,url:i}}catch(r){throw r}}async processReceipt(a,l){const r=Date.now();try{const c=await this.callClaudeVision(a);let p=await this.findClassificationRule(l,c.merchant);p||(p=this.classifyFromPatterns(c.merchant),!p&&c.aiSuggestedCategory&&(p={category:c.aiSuggestedCategory,confidence:c.aiConfidence||.6}));const d=Date.now()-r;return{...c,suggestedCategory:p?.category||null,confidence:p?.confidence||0,ruleBasedClassification:!!p?.ruleId,processingTimeMs:d}}catch(c){throw c}}async fetchImageAsBase64(a){try{const r=await(await fetch(a)).blob();return new Promise((c,p)=>{const d=new FileReader;d.onloadend=()=>{const b=d.result.split(",")[1];c({data:b,mediaType:r.type})},d.onerror=p,d.readAsDataURL(r)})}catch(l){throw l}}async callClaudeVision(a){const l=`Analyze this receipt image and extract the following information in JSON format:
{
  "merchant": "Store/vendor name",
  "amount": 0.00,
  "currency": "GBP",
  "date": "YYYY-MM-DD",
  "items": [{"name": "item name", "quantity": 1, "price": 0.00}],
  "paymentMethod": "card/cash/unknown",
  "category": "Travel/Accommodation/Sustenance",
  "confidence": 0.0 to 1.0,
  "rawText": "All visible text from receipt"
}

If any field cannot be determined, use null. For the category, consider:
- Travel: transport, fuel, parking, flights, trains, taxis
- Accommodation: hotels, lodging, rentals
- Sustenance: food, drinks, restaurants, cafes, supermarkets

Be conservative with confidence - only use high values (>0.8) when very certain.`;try{const r=await fetch("/api/scan-receipt",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({image:a,prompt:l})});if(!r.ok)throw new Error("Failed to process receipt with AI");const c=await r.json();return{merchant:c.merchant,amount:c.amount,currency:c.currency||"GBP",date:c.date,items:c.items||[],paymentMethod:c.paymentMethod,aiSuggestedCategory:c.category,aiConfidence:c.confidence,rawText:c.rawText}}catch(r){return{merchant:null,amount:null,currency:"GBP",date:null,items:[],paymentMethod:null,aiSuggestedCategory:null,aiConfidence:0,rawText:null,error:r.message}}}async findClassificationRule(a,l){if(!l)return null;try{const{data:r,error:c}=await $.rpc("find_classification_rule",{p_project_id:a,p_merchant:l});if(c)throw c;return r&&r.length>0?{ruleId:r[0].rule_id,category:r[0].category,subcategory:r[0].subcategory,defaultChargeable:r[0].default_chargeable,defaultProcurement:r[0].default_procurement,confidence:parseFloat(r[0].confidence)}:null}catch{return null}}classifyFromPatterns(a){if(!a)return null;const l=a.toLowerCase();for(const[r,c]of Object.entries(vs))if(l.includes(r))return{category:c,confidence:.7,source:"pattern"};return null}async learnFromCorrection(a,l,r,c,p=!1){if(!l||!r)return null;try{const{data:d,error:b}=await $.rpc("upsert_classification_rule",{p_project_id:a,p_merchant:l,p_category:r,p_user_id:c,p_was_correction:p});if(b)throw b;return d}catch{return null}}async createScan(a){try{const{data:l,error:r}=await $.from("receipt_scans").insert({project_id:a.projectId,uploaded_by:a.userId,image_url:a.imageUrl,image_path:a.imagePath,raw_ocr_text:a.rawText,extracted_merchant:a.merchant,extracted_amount:a.amount,extracted_date:a.date,extracted_currency:a.currency,extracted_items:a.items,ai_suggested_category:a.suggestedCategory,ai_confidence:a.confidence,status:"completed",processing_time_ms:a.processingTimeMs}).select().single();if(r)throw r;return l}catch(l){throw l}}async updateScanClassification(a,l,r=!1){try{const{data:c,error:p}=await $.from("receipt_scans").update({final_category:l,user_corrected:r}).eq("id",a).select().single();if(p)throw p;return c}catch(c){throw c}}async linkToExpense(a,l){try{const{data:r,error:c}=await $.from("receipt_scans").update({expense_id:l,status:"linked"}).eq("id",a).select().single();if(c)throw c;return r}catch(r){throw r}}async getRecentScans(a,l=10){try{const{data:r,error:c}=await $.from("receipt_scans").select("*").eq("project_id",a).order("created_at",{ascending:!1}).limit(l);if(c)throw c;return r||[]}catch{return[]}}async getUnlinkedScans(a){try{const{data:l,error:r}=await $.from("receipt_scans").select("*").eq("project_id",a).is("expense_id",null).eq("status","completed").order("created_at",{ascending:!1});if(r)throw r;return l||[]}catch{return[]}}async getClassificationRules(a){try{const{data:l,error:r}=await $.from("classification_rules").select("*").eq("project_id",a).order("match_count",{ascending:!1});if(r)throw r;return l||[]}catch{return[]}}async deleteClassificationRule(a){try{const{error:l}=await $.from("classification_rules").delete().eq("id",a);if(l)throw l;return!0}catch{return!1}}}const le=new ys,_s=[{id:"Travel",label:"Travel",icon:pe,color:"#2563eb",bg:"#dbeafe"},{id:"Accommodation",label:"Accommodation",icon:ge,color:"#7c3aed",bg:"#f3e8ff"},{id:"Sustenance",label:"Sustenance",icon:xe,color:"#ea580c",bg:"#ffedd5"}],y={PENDING:"pending",PROCESSING:"processing",READY:"ready",SUBMITTED:"submitted",ERROR:"error"},P={UPLOAD:"upload",PROCESSING:"processing",REVIEW:"review"};function Ns({onExpenseCreated:t,onCancel:a,resources:l=[],defaultResourceId:r=null}){const{user:c}=ze(),{projectId:p}=Fe(),{showSuccess:d,showError:b,showWarning:N,showInfo:i}=Oe(),[k,D]=h.useState(P.UPLOAD),[u,j]=h.useState([]),[v,E]=h.useState(0),[O,B]=h.useState({current:0,total:0}),_=h.useRef(null),I=h.useRef(null),A=u[v];u.filter(s=>s.status===y.READY).length;const q=u.filter(s=>s.status===y.SUBMITTED).length;u.filter(s=>s.status===y.PENDING||s.status===y.PROCESSING).length;const L=(s,n=1500,f=.8)=>new Promise((S,m)=>{const C=new FileReader;C.onload=M=>{const Y=new Image;Y.onload=()=>{let{width:z,height:R}=Y;(z>n||R>n)&&(z>R?(R=Math.round(R*n/z),z=n):(z=Math.round(z*n/R),R=n));const J=document.createElement("canvas");J.width=z,J.height=R,J.getContext("2d").drawImage(Y,0,0,z,R),J.toBlob(de=>{de?S(de):m(new Error("Failed to compress image"))},"image/jpeg",f)},Y.onerror=()=>m(new Error("Failed to load image")),Y.src=M.target.result},C.onerror=m,C.readAsDataURL(s)}),g=async s=>{const n=await L(s);return new Promise((f,S)=>{const m=new FileReader;m.onload=()=>{f({data:m.result.split(",")[1],mediaType:"image/jpeg",preview:m.result})},m.onerror=S,m.readAsDataURL(n)})},Z=(s,n)=>({id:`receipt-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,file:s,preview:n,status:y.PENDING,scanResult:null,scanId:null,imageUrl:null,formData:{merchant:"",amount:"",date:new Date().toISOString().split("T")[0],category:"",resource_id:r||"",reason:"",chargeable:!0,procurement:"supplier",notes:""},wasEdited:!1}),G=h.useCallback(async s=>{const n=Array.from(s.target.files||[]);if(n.length===0)return;const f=["image/jpeg","image/png","image/webp","image/heic"],S=[];for(const C of n){if(!f.includes(C.type)){N(`Skipped ${C.name} - invalid file type`);continue}if(C.size>10*1024*1024){N(`Skipped ${C.name} - file too large (max 10MB)`);continue}S.push(C)}if(S.length===0)return;const m=await Promise.all(S.map(async C=>{const{preview:M}=await g(C);return Z(C,M)}));j(C=>[...C,...m]),i(`Added ${m.length} receipt${m.length>1?"s":""}`)},[N,i,r]),oe=h.useCallback(s=>{s.preventDefault();const n=s.dataTransfer.files;n.length>0&&G({target:{files:n}})},[G]),Q=h.useCallback(s=>{s.preventDefault()},[]),je=h.useCallback(s=>{j(n=>{const f=n.filter(S=>S.id!==s);return v>=f.length&&f.length>0&&E(f.length-1),f})},[v]),ee=h.useCallback(()=>{j([]),E(0),D(P.UPLOAD),_.current&&(_.current.value="")},[]),x=h.useCallback(async()=>{if(u.length===0||!p||!c?.id){b("No receipts to process");return}D(P.PROCESSING),B({current:0,total:u.length});const s=[...u];for(let m=0;m<s.length;m++){const C=s[m];if(C.status===y.READY||C.status===y.SUBMITTED){B({current:m+1,total:u.length});continue}s[m]={...C,status:y.PROCESSING},j([...s]);try{const M=await g(C.file),{path:Y,url:z}=await le.uploadImage(C.file,c.id),R=await le.processReceipt(M,p),J=await le.createScan({projectId:p,userId:c.id,imageUrl:z,imagePath:Y,...R});s[m]={...s[m],status:y.READY,scanResult:R,scanId:J.id,imageUrl:z,formData:{...s[m].formData,merchant:R.merchant||"",amount:R.amount?.toString()||"",date:R.date||new Date().toISOString().split("T")[0],category:R.suggestedCategory||"",reason:R.merchant?`Receipt from ${R.merchant}`:""}}}catch(M){s[m]={...s[m],status:y.ERROR,error:M.message}}j([...s]),B({current:m+1,total:u.length})}D(P.REVIEW);const n=s.findIndex(m=>m.status===y.READY);n>=0&&E(n);const f=s.filter(m=>m.status===y.READY).length,S=s.filter(m=>m.status===y.ERROR).length;S>0?N(`Processed ${f} receipts, ${S} failed`):d(`Successfully scanned ${f} receipt${f>1?"s":""}!`)},[u,p,c,b,d,N]),T=h.useCallback((s,n)=>{j(f=>{const S=[...f];return S[v]={...S[v],formData:{...S[v].formData,[s]:n},wasEdited:!0},S})},[v]),se=h.useCallback(s=>{T("category",s)},[T]),fe=h.useCallback(s=>{s>=0&&s<u.length&&E(s)},[u.length]),ae=h.useCallback(()=>{for(let s=v-1;s>=0;s--)if(u[s].status===y.READY){E(s);return}},[v,u]),ie=h.useCallback(()=>{for(let s=v+1;s<u.length;s++)if(u[s].status===y.READY){E(s);return}},[v,u]),te=u.slice(0,v).some(s=>s.status===y.READY),re=u.slice(v+1).some(s=>s.status===y.READY),ne=h.useCallback(async()=>{const s=A;if(!s||s.status!==y.READY)return;const{formData:n}=s;if(!n.resource_id){N("Please select a resource");return}if(!n.amount||parseFloat(n.amount)<=0){N("Please enter a valid amount");return}if(!n.category){N("Please select a category");return}if(!n.reason){N("Please enter a reason/description");return}try{if(n.merchant&&n.category){const m=s.wasEdited&&s.scanResult?.suggestedCategory!==n.category;await le.learnFromCorrection(p,n.merchant,n.category,c.id,m)}s.scanId&&await le.updateScanClassification(s.scanId,n.category,s.wasEdited);const f={category:n.category,resource_id:n.resource_id,resource_name:l.find(m=>m.id===n.resource_id)?.name,expense_date:n.date,reason:n.reason,amount:parseFloat(n.amount),notes:n.notes,chargeable_to_customer:n.chargeable,procurement_method:n.procurement,receipt_scan_id:s.scanId,receipt_image_url:s.imageUrl};j(m=>{const C=[...m];return C[v]={...C[v],status:y.SUBMITTED},C}),t&&t(f),d(`Expense created: ${n.merchant||"Receipt"} - £${n.amount}`);const S=u.findIndex((m,C)=>C>v&&m.status===y.READY);S>=0&&E(S)}catch(f){b("Failed to create expense: "+f.message)}},[A,v,u,p,c,l,t,d,b,N]),be=s=>{if(!s)return null;let n,f;return s>=.8?(n="#10b981",f="High"):s>=.5?(n="#f59e0b",f="Medium"):(n="#ef4444",f="Low"),e.jsxs("div",{className:"confidence-badge",style:{color:n,borderColor:n},children:[e.jsx(he,{size:14}),f," confidence (",Math.round(s*100),"%)"]})},ce=s=>{switch(s){case y.PENDING:return e.jsx("div",{className:"status-dot pending"});case y.PROCESSING:return e.jsx(Ae,{size:14,className:"spinner"});case y.READY:return e.jsx("div",{className:"status-dot ready"});case y.SUBMITTED:return e.jsx(X,{size:14,className:"status-check"});case y.ERROR:return e.jsx(_e,{size:14,className:"status-error"});default:return null}};return e.jsxs("div",{className:"receipt-scanner batch-mode",children:[e.jsxs("div",{className:"scanner-header",children:[e.jsxs("div",{className:"scanner-title",children:[e.jsx(K,{size:24}),e.jsxs("div",{children:[e.jsx("h3",{children:"Smart Receipt Scanner"}),e.jsxs("p",{children:[k===P.UPLOAD&&"Upload one or more receipt photos",k===P.PROCESSING&&`Processing ${O.current} of ${O.total}...`,k===P.REVIEW&&`Reviewing ${v+1} of ${u.length} receipts`]})]})]}),a&&e.jsx("button",{className:"btn btn-ghost",onClick:a,children:e.jsx(H,{size:20})})]}),e.jsxs("div",{className:"scanner-steps",children:[e.jsxs("div",{className:`step ${k===P.UPLOAD?"active":k!==P.UPLOAD?"complete":""}`,children:[e.jsx("div",{className:"step-dot",children:"1"}),e.jsx("span",{children:"Upload"})]}),e.jsx("div",{className:"step-line"}),e.jsxs("div",{className:`step ${k===P.PROCESSING?"active":k===P.REVIEW?"complete":""}`,children:[e.jsx("div",{className:"step-dot",children:"2"}),e.jsx("span",{children:"Scan All"})]}),e.jsx("div",{className:"step-line"}),e.jsxs("div",{className:`step ${k===P.REVIEW?"active":""}`,children:[e.jsx("div",{className:"step-dot",children:"3"}),e.jsx("span",{children:"Review"})]})]}),e.jsxs("div",{className:"scanner-content",children:[k===P.UPLOAD&&e.jsxs("div",{className:"upload-section",children:[e.jsxs("div",{className:"drop-zone",onDrop:oe,onDragOver:Q,onClick:()=>_.current?.click(),children:[e.jsx(me,{size:48,className:"drop-icon"}),e.jsx("p",{className:"drop-text",children:"Drag & drop receipt images"}),e.jsx("p",{className:"drop-subtext",children:"or click to browse (select multiple)"}),e.jsxs("div",{className:"upload-buttons",children:[e.jsxs("button",{className:"btn btn-primary",onClick:s=>{s.stopPropagation(),_.current?.click()},children:[e.jsx(me,{size:18})," Choose Files"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:s=>{s.stopPropagation(),I.current?.click()},children:[e.jsx(Ce,{size:18})," Take Photo"]})]}),e.jsx("input",{ref:_,type:"file",accept:"image/jpeg,image/png,image/webp,image/heic",multiple:!0,onChange:G,style:{display:"none"}}),e.jsx("input",{ref:I,type:"file",accept:"image/*",capture:"environment",onChange:G,style:{display:"none"}})]}),u.length>0&&e.jsxs("div",{className:"receipt-queue",children:[e.jsxs("div",{className:"queue-header",children:[e.jsxs("h4",{children:[e.jsx(cs,{size:18})," ",u.length," Receipt",u.length>1?"s":""," Ready"]}),e.jsxs("button",{className:"btn btn-ghost btn-sm",onClick:ee,children:[e.jsx(Ue,{size:16})," Clear All"]})]}),e.jsxs("div",{className:"queue-grid",children:[u.map((s,n)=>e.jsxs("div",{className:"queue-item",children:[e.jsx("img",{src:s.preview,alt:`Receipt ${n+1}`}),e.jsx("button",{className:"remove-btn",onClick:f=>{f.stopPropagation(),je(s.id)},children:e.jsx(H,{size:14})}),e.jsx("span",{className:"queue-number",children:n+1})]},s.id)),e.jsxs("div",{className:"queue-item add-more",onClick:()=>_.current?.click(),children:[e.jsx(me,{size:24}),e.jsx("span",{children:"Add More"})]})]}),e.jsxs("button",{className:"btn btn-primary btn-lg scan-all-btn",onClick:x,children:[e.jsx(he,{size:20})," Scan All ",u.length," Receipt",u.length>1?"s":""]})]}),e.jsxs("div",{className:"scanner-tips",children:[e.jsxs("h4",{children:[e.jsx(ls,{size:16})," Tips for best results"]}),e.jsxs("ul",{children:[e.jsx("li",{children:"Ensure receipts are flat and well-lit"}),e.jsx("li",{children:"Include the full receipt in frame"}),e.jsx("li",{children:"Avoid shadows and glare"}),e.jsx("li",{children:"You can select multiple files at once"})]})]})]}),k===P.PROCESSING&&e.jsxs("div",{className:"processing-section batch-processing",children:[e.jsxs("div",{className:"processing-progress",children:[e.jsx("div",{className:"progress-bar",children:e.jsx("div",{className:"progress-fill",style:{width:`${O.current/O.total*100}%`}})}),e.jsxs("span",{className:"progress-text",children:["Processing receipt ",O.current," of ",O.total]})]}),e.jsx("div",{className:"processing-grid",children:u.map((s,n)=>e.jsxs("div",{className:`processing-item ${s.status}`,children:[e.jsx("img",{src:s.preview,alt:`Receipt ${n+1}`}),e.jsxs("div",{className:"processing-overlay",children:[s.status===y.PROCESSING&&e.jsx(Ae,{size:24,className:"spinner"}),s.status===y.READY&&e.jsx(X,{size:24,className:"success-icon"}),s.status===y.ERROR&&e.jsx(_e,{size:24,className:"error-icon"})]}),e.jsx("span",{className:"item-number",children:n+1})]},s.id))})]}),k===P.REVIEW&&A&&e.jsxs("div",{className:"review-section batch-review",children:[e.jsxs("div",{className:"receipt-sidebar",children:[e.jsxs("div",{className:"sidebar-header",children:[e.jsx("h4",{children:"Receipts"}),e.jsxs("span",{className:"sidebar-count",children:[q,"/",u.length," submitted"]})]}),e.jsx("div",{className:"sidebar-list",children:u.map((s,n)=>e.jsxs("div",{className:`sidebar-item ${n===v?"active":""} ${s.status}`,onClick:()=>s.status===y.READY&&fe(n),children:[e.jsx("img",{src:s.preview,alt:`Receipt ${n+1}`}),e.jsxs("div",{className:"sidebar-item-info",children:[e.jsx("span",{className:"item-merchant",children:s.formData.merchant||`Receipt ${n+1}`}),e.jsx("span",{className:"item-amount",children:s.formData.amount?`£${s.formData.amount}`:"—"})]}),e.jsx("div",{className:"sidebar-item-status",children:ce(s.status)})]},s.id))})]}),e.jsx("div",{className:"review-main",children:A.status===y.READY?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"review-header",children:[e.jsxs("button",{className:"btn btn-ghost",onClick:ae,disabled:!te,children:[e.jsx(os,{size:20})," Previous"]}),e.jsxs("div",{className:"review-position",children:["Receipt ",v+1," of ",u.length]}),e.jsxs("button",{className:"btn btn-ghost",onClick:ie,disabled:!re,children:["Next ",e.jsx(ke,{size:20})]})]}),e.jsxs("div",{className:"extraction-summary",children:[e.jsxs("div",{className:"summary-header",children:[e.jsx("h4",{children:"Extracted Information"}),be(A.scanResult?.confidence)]}),A.scanResult?.ruleBasedClassification&&e.jsxs("div",{className:"rule-notice",children:[e.jsx(he,{size:14}),"Category auto-selected based on previous receipts"]})]}),e.jsxs("div",{className:"review-form",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Resource *"}),e.jsxs("select",{className:"form-input",value:A.formData.resource_id,onChange:s=>T("resource_id",s.target.value),children:[e.jsx("option",{value:"",children:"Select resource..."}),l.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Category *"}),e.jsx("div",{className:"category-selector",children:_s.map(s=>{const n=s.icon,f=A.formData.category===s.id;return e.jsxs("button",{type:"button",className:`category-btn ${f?"selected":""}`,style:{"--cat-color":s.color,"--cat-bg":s.bg},onClick:()=>se(s.id),children:[e.jsx(n,{size:20}),s.label,f&&e.jsx(X,{size:16,className:"check-icon"})]},s.id)})})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Merchant"}),e.jsx("input",{type:"text",className:"form-input",value:A.formData.merchant,onChange:s=>T("merchant",s.target.value),placeholder:"Store/vendor name"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Amount (£) *"}),e.jsx("input",{type:"number",step:"0.01",className:"form-input",value:A.formData.amount,onChange:s=>T("amount",s.target.value),placeholder:"0.00"})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Date *"}),e.jsx("input",{type:"date",className:"form-input",value:A.formData.date,onChange:s=>T("date",s.target.value)})]}),e.jsxs("div",{className:"form-group",style:{flex:2},children:[e.jsx("label",{className:"form-label",children:"Reason/Description *"}),e.jsx("input",{type:"text",className:"form-input",value:A.formData.reason,onChange:s=>T("reason",s.target.value),placeholder:"Brief description of expense"})]})]}),e.jsxs("div",{className:"form-row options-row",children:[e.jsxs("label",{className:"checkbox-label",children:[e.jsx("input",{type:"checkbox",checked:A.formData.chargeable,onChange:s=>T("chargeable",s.target.checked)}),e.jsx("span",{children:"Chargeable to Customer"})]}),e.jsxs("div",{className:"procurement-toggle",children:[e.jsx("span",{children:"Paid by:"}),e.jsxs("select",{className:"form-input-sm",value:A.formData.procurement,onChange:s=>T("procurement",s.target.value),children:[e.jsx("option",{value:"supplier",children:"Supplier (JT)"}),e.jsx("option",{value:"partner",children:"Partner"})]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Additional Notes"}),e.jsx("textarea",{className:"form-input",rows:2,value:A.formData.notes,onChange:s=>T("notes",s.target.value),placeholder:"Any additional information..."})]})]}),e.jsxs("div",{className:"receipt-thumbnail",children:[e.jsx("img",{src:A.preview,alt:"Receipt"}),e.jsx("span",{children:"Receipt attached"})]}),e.jsxs("div",{className:"review-actions",children:[e.jsxs("button",{className:"btn btn-secondary",onClick:()=>D(P.UPLOAD),children:[e.jsx(is,{size:18})," Back to Upload"]}),e.jsxs("button",{className:"btn btn-primary btn-lg",onClick:ne,children:[e.jsx(X,{size:18})," Submit Expense",re&&" & Next"]})]})]}):A.status===y.SUBMITTED?e.jsxs("div",{className:"submitted-message",children:[e.jsx("div",{className:"success-icon-large",children:e.jsx(X,{size:48})}),e.jsx("h3",{children:"Expense Submitted"}),e.jsxs("p",{children:[A.formData.merchant," - £",A.formData.amount]}),re&&e.jsxs("button",{className:"btn btn-primary",onClick:ie,children:["Review Next Receipt ",e.jsx(ke,{size:18})]})]}):A.status===y.ERROR?e.jsxs("div",{className:"error-message",children:[e.jsx(_e,{size:48,className:"error-icon"}),e.jsx("h3",{children:"Processing Failed"}),e.jsx("p",{children:A.error||"Unable to process this receipt"})]}):null})]}),k===P.REVIEW&&q===u.length&&u.length>0&&e.jsxs("div",{className:"complete-section",children:[e.jsx("div",{className:"success-icon",children:e.jsx(X,{size:48})}),e.jsx("h3",{children:"All Receipts Submitted!"}),e.jsxs("p",{children:[q," expense",q>1?"s":""," created successfully."]}),e.jsxs("div",{className:"complete-actions",children:[e.jsxs("button",{className:"btn btn-primary",onClick:ee,children:[e.jsx(Ce,{size:18})," Scan More Receipts"]}),a&&e.jsx("button",{className:"btn btn-secondary",onClick:a,children:"Done"})]})]})]})]})}const Cs=["Travel","Accommodation","Sustenance"],Ss=["Draft","Submitted","Approved","Rejected","Paid"],Rs={Draft:"Draft",Submitted:"Submitted",Approved:"Validated",Rejected:"Rejected",Paid:"Paid"};function ws({filterCategory:t,setFilterCategory:a,filterResource:l,setFilterResource:r,filterStatus:c,setFilterStatus:p,filterChargeable:d,setFilterChargeable:b,filterProcurement:N,setFilterProcurement:i,resourceNames:k,hasRole:D}){const u={padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"};return e.jsx("div",{className:"card",style:{marginBottom:"1.5rem"},children:e.jsxs("div",{style:{display:"flex",gap:"1rem",alignItems:"center",flexWrap:"wrap"},children:[e.jsx("span",{style:{fontWeight:"500"},children:"Filter:"}),e.jsxs("select",{value:t,onChange:j=>a(j.target.value),style:u,children:[e.jsx("option",{value:"all",children:"All Types"}),Cs.map(j=>e.jsx("option",{value:j,children:j},j))]}),e.jsxs("select",{value:l,onChange:j=>r(j.target.value),style:u,children:[e.jsx("option",{value:"all",children:"All Resources"}),k.map(j=>e.jsx("option",{value:j,children:j},j))]}),e.jsxs("select",{value:c,onChange:j=>p(j.target.value),style:u,children:[e.jsx("option",{value:"all",children:"All Statuses"}),Ss.map(j=>e.jsx("option",{value:j,children:Rs[j]||j},j))]}),e.jsxs("select",{value:d,onChange:j=>b(j.target.value),style:u,children:[e.jsx("option",{value:"all",children:"All Expenses"}),e.jsx("option",{value:"chargeable",children:"Chargeable Only"}),e.jsx("option",{value:"non-chargeable",children:"Non-Chargeable Only"})]}),D(["admin","supplier_pm"])&&e.jsxs("select",{value:N,onChange:j=>i(j.target.value),style:u,children:[e.jsx("option",{value:"all",children:"All Procurement"}),e.jsx("option",{value:"supplier",children:"Supplier Procured"}),e.jsx("option",{value:"partner",children:"Partner Procured"})]})]})})}function Ne({category:t,icon:a,bgColor:l,textColor:r,borderColor:c,amount:p,reason:d,chargeable:b,procurement:N,onAmountChange:i,onReasonChange:k,onChargeableChange:D,onProcurementChange:u,hasRole:j}){return e.jsxs("div",{style:{padding:"1rem",backgroundColor:l,borderRadius:"8px",marginBottom:"1rem"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",color:r,marginBottom:"0.75rem"},children:[a,e.jsx("span",{style:{fontWeight:"600",fontSize:"1rem"},children:t})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"150px 1fr",gap:"1rem",marginBottom:"0.75rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Amount (£)"}),e.jsx("input",{type:"number",step:"0.01",className:"form-input",placeholder:"0.00",value:p,onChange:v=>i(v.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Reason / Description"}),e.jsx("input",{type:"text",className:"form-input",placeholder:`e.g., ${t} expense description`,value:d,onChange:v=>k(v.target.value)})]})]}),parseFloat(p)>0&&e.jsxs("div",{style:{display:"flex",gap:"1.5rem",flexWrap:"wrap",paddingTop:"0.75rem",borderTop:`1px solid ${c}`},children:[e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"0.5rem",cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:b,onChange:v=>D(v.target.checked),style:{width:"16px",height:"16px",accentColor:r}}),e.jsx("span",{style:{fontSize:"0.85rem",color:r},children:"Chargeable to Customer"})]}),j(["admin","supplier_pm"])&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.85rem",color:r},children:"Paid by:"}),e.jsxs("select",{value:N,onChange:v=>u(v.target.value),style:{padding:"0.25rem 0.5rem",borderRadius:"4px",border:`1px solid ${c}`,fontSize:"0.85rem",backgroundColor:"#fff"},children:[e.jsx("option",{value:"supplier",children:"Supplier (JT)"}),e.jsx("option",{value:"partner",children:"Partner"})]})]})]})]})}function As({newExpense:t,setNewExpense:a,availableResources:l,hasRole:r,handleAdd:c,handleFileSelect:p,removeFile:d,uploadingFiles:b,onCancel:N}){return e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem",border:"2px solid var(--primary)"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Add New Expenses"}),e.jsx("p",{style:{color:"#64748b",fontSize:"0.9rem",marginBottom:"1rem"},children:"Enter amounts for any categories that apply. Leave blank to skip a category."}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem",marginBottom:"1.5rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Resource Name *"}),e.jsxs("select",{className:"form-input",value:t.resource_id,onChange:i=>a({...t,resource_id:i.target.value}),children:[e.jsx("option",{value:"",children:"Select Resource"}),l.map(i=>e.jsx("option",{value:i.id,children:i.name},i.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Date *"}),e.jsx("input",{type:"date",className:"form-input",value:t.expense_date,onChange:i=>a({...t,expense_date:i.target.value})})]})]}),e.jsx(Ne,{category:"Travel",icon:e.jsx(pe,{size:20}),bgColor:"#dbeafe",textColor:"#2563eb",borderColor:"#93c5fd",amount:t.travel_amount,reason:t.travel_reason,chargeable:t.travel_chargeable,procurement:t.travel_procurement,onAmountChange:i=>a({...t,travel_amount:i}),onReasonChange:i=>a({...t,travel_reason:i}),onChargeableChange:i=>a({...t,travel_chargeable:i}),onProcurementChange:i=>a({...t,travel_procurement:i}),hasRole:r}),e.jsx(Ne,{category:"Accommodation",icon:e.jsx(ge,{size:20}),bgColor:"#f3e8ff",textColor:"#7c3aed",borderColor:"#d8b4fe",amount:t.accommodation_amount,reason:t.accommodation_reason,chargeable:t.accommodation_chargeable,procurement:t.accommodation_procurement,onAmountChange:i=>a({...t,accommodation_amount:i}),onReasonChange:i=>a({...t,accommodation_reason:i}),onChargeableChange:i=>a({...t,accommodation_chargeable:i}),onProcurementChange:i=>a({...t,accommodation_procurement:i}),hasRole:r}),e.jsx(Ne,{category:"Sustenance",icon:e.jsx(xe,{size:20}),bgColor:"#ffedd5",textColor:"#ea580c",borderColor:"#fdba74",amount:t.sustenance_amount,reason:t.sustenance_reason,chargeable:t.sustenance_chargeable,procurement:t.sustenance_procurement,onAmountChange:i=>a({...t,sustenance_amount:i}),onReasonChange:i=>a({...t,sustenance_reason:i}),onChargeableChange:i=>a({...t,sustenance_chargeable:i}),onProcurementChange:i=>a({...t,sustenance_procurement:i}),hasRole:r}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{className:"form-label",children:"Additional Notes"}),e.jsx("textarea",{className:"form-input",rows:2,placeholder:"Any additional information...",value:t.notes,onChange:i=>a({...t,notes:i.target.value})})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{className:"form-label",children:"Attach Receipts"}),e.jsxs("div",{style:{border:"2px dashed #d1d5db",borderRadius:"8px",padding:"1.5rem",textAlign:"center",cursor:"pointer",backgroundColor:"#f9fafb"},onClick:()=>document.getElementById("file-upload").click(),children:[e.jsx(me,{size:24,style:{color:"#9ca3af",marginBottom:"0.5rem"}}),e.jsx("div",{style:{color:"#64748b",fontSize:"0.85rem"},children:"Click to upload receipts"}),e.jsx("input",{id:"file-upload",type:"file",multiple:!0,accept:".pdf,.jpg,.jpeg,.png,.zip",style:{display:"none"},onChange:p})]}),t.files.length>0&&e.jsx("div",{style:{marginTop:"0.5rem"},children:t.files.map((i,k)=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.25rem 0",fontSize:"0.85rem"},children:[e.jsx(ds,{size:14}),e.jsx("span",{style:{flex:1},children:i.name}),e.jsx("button",{onClick:()=>d(k),style:{background:"none",border:"none",cursor:"pointer",color:"#ef4444"},children:e.jsx(H,{size:14})})]},k))})]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsxs("button",{className:"btn btn-primary",onClick:c,disabled:b,children:[e.jsx($e,{size:16})," ",b?"Uploading...":"Save Expenses"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:N,children:[e.jsx(H,{size:16})," Cancel"]})]})]})}const ks={Draft:"Draft",Submitted:"Submitted",Approved:"Validated",Rejected:"Rejected",Paid:"Paid"};function Ps(t){switch(t){case"Travel":return e.jsx(pe,{size:14});case"Accommodation":return e.jsx(ge,{size:14});case"Sustenance":return e.jsx(xe,{size:14});default:return e.jsx(K,{size:14})}}function Es(t){switch(t){case"Travel":return"category-travel";case"Accommodation":return"category-accommodation";case"Sustenance":return"category-sustenance";default:return"category-default"}}function Is(t){switch(t){case"Approved":case"Paid":return"status-validated";case"Submitted":return"status-submitted";case"Rejected":return"status-rejected";default:return"status-draft"}}function Ts(t){return t==="partner"?"procurement-partner":"procurement-supplier"}function Ds({expense:t,showProcurement:a,setDetailModal:l}){const r=t.chargeable_to_customer!==!1,c=t.expense_files?.length>0;return e.jsxs("tr",{onClick:()=>l({isOpen:!0,expense:t}),children:[e.jsx("td",{className:"cell-ref",children:t.expense_ref||"-"}),e.jsx("td",{children:e.jsxs("span",{className:`category-badge ${Es(t.category)}`,children:[Ps(t.category),e.jsx("span",{children:t.category})]})}),e.jsx("td",{className:"cell-resource",children:t.resource_name}),e.jsx("td",{className:"cell-date",children:new Date(t.expense_date).toLocaleDateString("en-GB")}),e.jsx("td",{className:"cell-reason",children:e.jsx("span",{className:"reason-text",children:t.reason})}),e.jsxs("td",{className:"cell-amount",children:["£",parseFloat(t.amount).toFixed(2)]}),e.jsx("td",{children:e.jsxs("span",{className:`chargeable-badge ${r?"chargeable-yes":"chargeable-no"}`,children:[r?e.jsx(X,{size:12}):e.jsx(H,{size:12}),e.jsx("span",{children:r?"Yes":"No"})]})}),a&&e.jsx("td",{children:e.jsxs("span",{className:`procurement-badge ${Ts(t.procurement_method)}`,children:[(t.procurement_method||"supplier")==="partner"?e.jsx(Be,{size:12}):e.jsx(Le,{size:12}),e.jsx("span",{children:(t.procurement_method||"supplier")==="partner"?"Partner":"Supplier"})]})}),e.jsx("td",{children:e.jsx("span",{className:`status-badge ${Is(t.status)}`,children:ks[t.status]||t.status})}),e.jsx("td",{className:"cell-receipts",children:c&&e.jsxs("span",{className:"receipts-indicator",children:[e.jsx(Me,{size:14}),e.jsx("span",{children:t.expense_files.length})]})})]})}function zs({expenses:t,hasRole:a,setDetailModal:l}){const r=a(["admin","supplier_pm"]);return e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"expense-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Ref"}),e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Resource"}),e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Reason"}),e.jsx("th",{className:"text-right",children:"Amount"}),e.jsx("th",{children:"Chargeable"}),r&&e.jsx("th",{children:"Procured By"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Receipts"})]})}),e.jsx("tbody",{children:t.length===0?e.jsx("tr",{className:"empty-row",children:e.jsx("td",{colSpan:r?10:9,children:e.jsxs("div",{className:"empty-state",children:[e.jsx(K,{size:32}),e.jsx("p",{children:"No expenses found"})]})})}):t.map(c=>e.jsx(Ds,{expense:c,showProcurement:r,setDetailModal:l},c.id))})]})})}const Fs=["Travel","Accommodation","Sustenance"],Os=["Draft","Submitted","Approved","Rejected","Paid"],Ie={Draft:"Draft",Submitted:"Submitted",Approved:"Validated",Rejected:"Rejected",Paid:"Paid"};function Us(t){switch(t){case"Travel":return e.jsx(pe,{size:20});case"Accommodation":return e.jsx(ge,{size:20});case"Sustenance":return e.jsx(xe,{size:20});default:return e.jsx(K,{size:20})}}function $s(t){switch(t){case"Travel":return"cat-travel";case"Accommodation":return"cat-accommodation";case"Sustenance":return"cat-sustenance";default:return"cat-default"}}function Bs(t){switch(t){case"Approved":case"Paid":return"stat-validated";case"Submitted":return"stat-submitted";case"Rejected":return"stat-rejected";default:return"stat-draft"}}function Ls(t){const{data:a}=$.storage.from("receipts").getPublicUrl(t);return a?.publicUrl||null}function Te(t){const a=[".jpg",".jpeg",".png",".gif",".webp",".bmp",".svg"],l=t.toLowerCase().substring(t.lastIndexOf("."));return a.includes(l)}function Ms({files:t,onDownload:a}){const[l,r]=h.useState(null),[c,p]=h.useState({});return h.useEffect(()=>{const d={};t.forEach(b=>{Te(b.file_name)&&(d[b.id||b.file_path]=Ls(b.file_path))}),p(d)},[t]),!t||t.length===0?null:e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"receipts-section",children:[e.jsxs("div",{className:"section-label",children:[e.jsx(Me,{size:16}),e.jsxs("span",{children:["Receipts (",t.length,")"]})]}),e.jsx("div",{className:"receipts-grid",children:t.map((d,b)=>{const N=d.id||d.file_path,i=c[N],k=Te(d.file_name);return e.jsxs("div",{className:"receipt-item",children:[k&&i?e.jsxs("div",{className:"receipt-image-container",onClick:()=>r({url:i,name:d.file_name}),children:[e.jsx("img",{src:i,alt:d.file_name,className:"receipt-thumbnail"}),e.jsx("div",{className:"receipt-overlay",children:e.jsx(xs,{size:20})})]}):e.jsx("div",{className:"receipt-file-icon",onClick:()=>a(d.file_path,d.file_name),children:e.jsx(K,{size:24})}),e.jsxs("div",{className:"receipt-info",children:[e.jsx("span",{className:"receipt-name",title:d.file_name,children:d.file_name.length>20?d.file_name.substring(0,17)+"...":d.file_name}),e.jsx("button",{className:"receipt-download",onClick:D=>{D.stopPropagation(),a(d.file_path,d.file_name)},title:"Download",children:e.jsx(js,{size:14})})]})]},b)})})]}),l&&e.jsx("div",{className:"image-modal-overlay",onClick:()=>r(null),children:e.jsxs("div",{className:"image-modal-content",onClick:d=>d.stopPropagation(),children:[e.jsx("button",{className:"image-modal-close",onClick:()=>r(null),children:e.jsx(H,{size:24})}),e.jsx("img",{src:l.url,alt:l.name,className:"image-modal-img"}),e.jsx("div",{className:"image-modal-caption",children:l.name})]})})]})}function Gs({isOpen:t,expense:a,resources:l,hasRole:r,canEditChargeable:c,canSubmitExpense:p,canValidateExpense:d,canEditExpense:b,canDeleteExpense:N,onClose:i,onSave:k,onSubmit:D,onValidate:u,onReject:j,onDelete:v,onDownloadFile:E}){const[O,B]=h.useState(!1),[_,I]=h.useState({});if(h.useEffect(()=>{a&&(I({category:a.category,resource_id:a.resource_id,expense_date:a.expense_date,reason:a.reason,amount:a.amount,notes:a.notes||"",status:a.status,chargeable_to_customer:a.chargeable_to_customer!==!1,procurement_method:a.procurement_method||"supplier"}),B(!1))},[a]),!t||!a)return null;const A=a.chargeable_to_customer!==!1;async function q(){await k(a.id,_),B(!1)}function L(){B(!1),i()}return e.jsx("div",{className:"modal-overlay",onClick:L,children:e.jsxs("div",{className:"modal-container",onClick:g=>g.stopPropagation(),children:[e.jsxs("header",{className:"modal-header",children:[e.jsxs("div",{className:"modal-header-left",children:[e.jsx("div",{className:`modal-icon ${$s(a.category)}`,children:Us(a.category)}),e.jsxs("div",{className:"modal-title-group",children:[e.jsx("h2",{children:a.expense_ref||"Expense Details"}),e.jsxs("span",{children:[a.category," Expense"]})]})]}),e.jsxs("div",{className:"modal-header-right",children:[e.jsx("span",{className:`modal-status ${Bs(a.status)}`,children:Ie[a.status]||a.status}),e.jsx("button",{className:"modal-close",onClick:L,children:e.jsx(H,{size:20})})]})]}),e.jsx("div",{className:"modal-body",children:O?e.jsxs("div",{className:"edit-form",children:[e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Category"}),e.jsx("select",{value:_.category,onChange:g=>I({..._,category:g.target.value}),children:Fs.map(g=>e.jsx("option",{value:g,children:g},g))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Resource"}),e.jsxs("select",{value:_.resource_id||"",onChange:g=>I({..._,resource_id:g.target.value}),children:[e.jsx("option",{value:"",children:"-- Select --"}),l.map(g=>e.jsx("option",{value:g.id,children:g.name},g.id))]})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Date"}),e.jsx("input",{type:"date",value:_.expense_date,onChange:g=>I({..._,expense_date:g.target.value})})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Amount (£)"}),e.jsx("input",{type:"number",step:"0.01",value:_.amount,onChange:g=>I({..._,amount:g.target.value})})]})]}),e.jsxs("div",{className:"form-group full-width",children:[e.jsx("label",{children:"Reason"}),e.jsx("input",{type:"text",value:_.reason,onChange:g=>I({..._,reason:g.target.value})})]}),e.jsxs("div",{className:"form-group full-width",children:[e.jsx("label",{children:"Notes"}),e.jsx("textarea",{rows:3,value:_.notes,onChange:g=>I({..._,notes:g.target.value})})]}),e.jsxs("div",{className:"form-row",children:[c()&&e.jsxs("label",{className:"checkbox-label",children:[e.jsx("input",{type:"checkbox",checked:_.chargeable_to_customer,onChange:g=>I({..._,chargeable_to_customer:g.target.checked})}),e.jsx("span",{children:"Chargeable to Customer"})]}),r(["admin","supplier_pm"])&&e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Procurement"}),e.jsxs("select",{value:_.procurement_method,onChange:g=>I({..._,procurement_method:g.target.value}),children:[e.jsx("option",{value:"supplier",children:"Supplier"}),e.jsx("option",{value:"partner",children:"Partner"})]})]})]}),d(a)&&e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Status"}),e.jsx("select",{value:_.status,onChange:g=>I({..._,status:g.target.value}),children:Os.map(g=>e.jsx("option",{value:g,children:Ie[g]||g},g))})]})]}):e.jsxs("div",{className:"view-content",children:[e.jsxs("div",{className:"details-grid",children:[e.jsxs("div",{className:"detail-item",children:[e.jsx(us,{size:18}),e.jsxs("div",{children:[e.jsx("span",{className:"detail-label",children:"Resource"}),e.jsx("span",{className:"detail-value",children:a.resource_name||"Unknown"})]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx(ms,{size:18}),e.jsxs("div",{children:[e.jsx("span",{className:"detail-label",children:"Date"}),e.jsx("span",{className:"detail-value",children:new Date(a.expense_date).toLocaleDateString("en-GB")})]})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx(hs,{size:18}),e.jsxs("div",{children:[e.jsx("span",{className:"detail-label",children:"Amount"}),e.jsxs("span",{className:"detail-value amount",children:["£",parseFloat(a.amount).toFixed(2)]})]})]}),e.jsxs("div",{className:"detail-item",children:[A?e.jsx(Pe,{size:18,className:"icon-success"}):e.jsx(H,{size:18,className:"icon-warning"}),e.jsxs("div",{children:[e.jsx("span",{className:"detail-label",children:"Chargeable"}),e.jsx("span",{className:`detail-value ${A?"text-success":"text-warning"}`,children:A?"Yes":"No"})]})]})]}),e.jsxs("div",{className:"info-section",children:[e.jsx("span",{className:"section-label",children:"Reason"}),e.jsx("p",{className:"section-content",children:a.reason||"No reason provided"})]}),a.notes&&e.jsxs("div",{className:"info-section",children:[e.jsx("span",{className:"section-label",children:"Notes"}),e.jsx("p",{className:"section-content secondary",children:a.notes})]}),r(["admin","supplier_pm"])&&e.jsxs("div",{className:"info-section inline",children:[(a.procurement_method||"supplier")==="partner"?e.jsx(Be,{size:18,className:"icon-purple"}):e.jsx(Le,{size:18,className:"icon-blue"}),e.jsxs("div",{children:[e.jsx("span",{className:"section-label",children:"Procured By"}),e.jsx("span",{className:"section-content",children:(a.procurement_method||"supplier")==="partner"?"Partner (Reimbursable)":"Supplier (JT Direct)"})]})]}),e.jsx(Ms,{files:a.expense_files||[],onDownload:E}),e.jsxs("div",{className:"timestamps",children:[e.jsxs("span",{children:[e.jsx(Ee,{size:14})," Created: ",a.created_at?new Date(a.created_at).toLocaleString("en-GB"):"Unknown"]}),a.updated_at&&a.updated_at!==a.created_at&&e.jsxs("span",{children:[e.jsx(Ee,{size:14})," Updated: ",new Date(a.updated_at).toLocaleString("en-GB")]})]})]})}),e.jsxs("footer",{className:"modal-footer",children:[e.jsx("div",{className:"footer-left",children:N(a)&&!O&&e.jsxs("button",{onClick:()=>{v(a),L()},className:"btn btn-danger",children:[e.jsx(Ue,{size:16})," Delete"]})}),e.jsx("div",{className:"footer-right",children:O?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>B(!1),className:"btn btn-secondary",children:"Cancel"}),e.jsxs("button",{onClick:q,className:"btn btn-primary",children:[e.jsx($e,{size:16})," Save Changes"]})]}):e.jsxs(e.Fragment,{children:[p(a)&&e.jsxs("button",{onClick:()=>{D(a),L()},className:"btn btn-secondary",children:[e.jsx(ps,{size:16})," Submit"]}),d(a)&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>{j(a.id),L()},className:"btn btn-danger",children:[e.jsx(H,{size:16})," Reject"]}),e.jsxs("button",{onClick:()=>{u(a.id),L()},className:"btn btn-success",children:[e.jsx(Pe,{size:16})," Validate"]})]}),b(a)&&e.jsxs("button",{onClick:()=>B(!0),className:"btn btn-primary",children:[e.jsx(gs,{size:16})," Edit"]})]})})]})]})})}const Ys=20520,De={resource_id:"",expense_date:new Date().toISOString().split("T")[0],travel_amount:"",travel_reason:"",travel_chargeable:!0,travel_procurement:"supplier",accommodation_amount:"",accommodation_reason:"",accommodation_chargeable:!0,accommodation_procurement:"supplier",sustenance_amount:"",sustenance_reason:"",sustenance_chargeable:!0,sustenance_procurement:"supplier",notes:"",files:[]};function Zs(){const{user:t,role:a}=ze(),{projectId:l}=Fe(),{showSuccess:r,showError:c,showWarning:p}=Oe(),{showTestUsers:d,testUserIds:b}=as(),N=t?.id||null,{canAddExpense:i,canSubmitExpense:k,canValidateExpense:D,canEditExpense:u,canDeleteExpense:j,getAvailableResources:v,hasRole:E}=ts(),[O,B]=h.useState([]),[_,I]=h.useState([]),[A,q]=h.useState(!0),[L,g]=h.useState(!1),[Z,G]=h.useState(!1),[oe,Q]=h.useState("form"),[je,ee]=h.useState(!1),[x,T]=h.useState(De),[se,fe]=h.useState("all"),[ae,ie]=h.useState("all"),[te,re]=h.useState("all"),[ne,be]=h.useState("all"),[ce,s]=h.useState("all"),[n,f]=h.useState({isOpen:!1,expenseId:null,expenseData:null}),[S,m]=h.useState({isOpen:!1,expense:null}),[C,M]=h.useState({isOpen:!1,expenseId:null}),[Y,z]=h.useState({isOpen:!1,expense:null}),R=h.useCallback(async()=>{if(l){q(!0);try{const o=await W.getAllFiltered(l,d);B(o);const{data:w}=await $.from("resources").select("id, name, email, user_id, partner_id, partner:partners(id, name)").order("name");let F=w||[];!d&&b?.length>0&&(F=F.filter(U=>!U.user_id||!b.includes(U.user_id))),I(F)}catch{c("Failed to load expenses")}finally{q(!1),g(!1)}}},[l,d,b,c]);h.useEffect(()=>{R()},[R]);async function J(){g(!0),await R()}async function Se(){if(!x.resource_id){p("Please select a resource");return}const o=parseFloat(x.travel_amount)>0,w=parseFloat(x.accommodation_amount)>0,F=parseFloat(x.sustenance_amount)>0;if(!o&&!w&&!F){p("Please enter at least one expense amount");return}if(o&&!x.travel_reason){p("Please enter a reason for the travel expense");return}if(w&&!x.accommodation_reason){p("Please enter a reason for the accommodation expense");return}if(F&&!x.sustenance_reason){p("Please enter a reason for the sustenance expense");return}try{const U=_.find(ye=>ye.id===x.resource_id)?.name,V=[];o&&V.push({project_id:l,category:"Travel",resource_id:x.resource_id,resource_name:U,expense_date:x.expense_date,reason:x.travel_reason,amount:parseFloat(x.travel_amount),notes:x.notes,created_by:N,chargeable_to_customer:x.travel_chargeable,procurement_method:x.travel_procurement}),w&&V.push({project_id:l,category:"Accommodation",resource_id:x.resource_id,resource_name:U,expense_date:x.expense_date,reason:x.accommodation_reason,amount:parseFloat(x.accommodation_amount),notes:x.notes,created_by:N,chargeable_to_customer:x.accommodation_chargeable,procurement_method:x.accommodation_procurement}),F&&V.push({project_id:l,category:"Sustenance",resource_id:x.resource_id,resource_name:U,expense_date:x.expense_date,reason:x.sustenance_reason,amount:parseFloat(x.sustenance_amount),notes:x.notes,created_by:N,chargeable_to_customer:x.sustenance_chargeable,procurement_method:x.sustenance_procurement});const Re=await W.createMany(V);if(x.files.length>0&&Re){ee(!0);for(const ye of Re)for(const ss of x.files)try{await W.uploadReceipt(ye.id,ss,N)}catch{}ee(!1)}await R(),G(!1),T(De),r("Expenses added successfully!")}catch(U){c("Failed to add expenses: "+U.message)}}async function de(o){try{await W.create({project_id:l,category:o.category,resource_id:o.resource_id,resource_name:o.resource_name,expense_date:o.expense_date,reason:o.reason,amount:o.amount,notes:o.notes,created_by:N,chargeable_to_customer:o.chargeable_to_customer,procurement_method:o.procurement_method}),await R()}catch(w){c("Failed to create expense: "+w.message)}}function Ge(o){f({isOpen:!0,expenseId:o.id,expenseData:{resourceName:o.resource_name,date:o.expense_date,totalAmount:parseFloat(o.amount||0),category:o.category,chargeable:o.chargeable_to_customer,procurement:o.procurement_method,status:o.status}})}async function Ye(){if(n.expenseId)try{await W.delete(n.expenseId,N),await R(),f({isOpen:!1,expenseId:null,expenseData:null}),r("Expense deleted")}catch(o){c("Failed to delete: "+o.message)}}function Ve(o){m({isOpen:!0,expense:o})}async function We(){if(S.expense)try{await W.submit(S.expense.id),m({isOpen:!1,expense:null}),await R(),r("Expense submitted for validation!")}catch(o){c("Failed to submit: "+o.message)}}async function qe(o){try{await W.validate(o),await R(),r("Expense validated!")}catch(w){c("Failed to validate: "+w.message)}}function He(o){M({isOpen:!0,expenseId:o})}async function Je(o){if(C.expenseId)try{await W.reject(C.expenseId,o),M({isOpen:!1,expenseId:null}),await R(),p("Expense rejected")}catch(w){c("Failed to reject: "+w.message)}}function Xe(o){const w=Array.from(o.target.files);T({...x,files:[...x.files,...w]})}function Ke(o){T({...x,files:x.files.filter((w,F)=>F!==o)})}async function Ze(o,w){try{const F=await W.downloadReceipt(o),U=URL.createObjectURL(F),V=document.createElement("a");V.href=U,V.download=w,document.body.appendChild(V),V.click(),document.body.removeChild(V),URL.revokeObjectURL(U)}catch{c("Failed to download file")}}function Qe(){return E(["admin","supplier_pm","customer_pm"])}const ve=O.filter(o=>!(se!=="all"&&o.category!==se||ae!=="all"&&o.resource_name!==ae||te!=="all"&&o.status!==te||ne==="chargeable"&&o.chargeable_to_customer===!1||ne==="non-chargeable"&&o.chargeable_to_customer!==!1||ce!=="all"&&(o.procurement_method||"supplier")!==ce)),ue=v(_),es=[...new Set(O.map(o=>o.resource_name))];return A&&!l?e.jsx(rs,{message:"Loading expenses...",size:"large",fullPage:!0}):e.jsxs("div",{className:"expenses-page",children:[e.jsx("header",{className:"exp-header",children:e.jsxs("div",{className:"exp-header-content",children:[e.jsxs("div",{className:"exp-header-left",children:[e.jsx("div",{className:"exp-header-icon",children:e.jsx(K,{size:24})}),e.jsxs("div",{children:[e.jsx("h1",{children:"Expenses"}),e.jsxs("p",{children:["Track project expenses against £",Ys.toLocaleString()," budget"]})]})]}),e.jsxs("div",{className:"exp-header-actions",children:[e.jsxs("button",{className:"exp-btn exp-btn-secondary",onClick:J,disabled:L,children:[e.jsx(fs,{size:16,className:L?"spinning":""})," Refresh"]}),i&&!Z&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"exp-btn exp-btn-primary",onClick:()=>{Q("form"),G(!0)},children:[e.jsx(bs,{size:16})," Add Expenses"]}),e.jsxs("button",{className:"exp-btn exp-btn-scanner",onClick:()=>{Q("scanner"),G(!0)},title:"Scan a receipt with AI",children:[e.jsx(Ce,{size:16})," ",e.jsx(he,{size:12})," Scan Receipt"]})]})]})]})}),e.jsxs("div",{className:"exp-content",children:[e.jsx(ws,{filterCategory:se,setFilterCategory:fe,filterResource:ae,setFilterResource:ie,filterStatus:te,setFilterStatus:re,filterChargeable:ne,setFilterChargeable:be,filterProcurement:ce,setFilterProcurement:s,resourceNames:es,hasRole:E}),Z&&oe==="form"&&e.jsx(As,{newExpense:x,setNewExpense:T,availableResources:ue,hasRole:E,handleAdd:Se,handleFileSelect:Xe,removeFile:Ke,uploadingFiles:je,onCancel:()=>G(!1)}),Z&&oe==="scanner"&&e.jsx("div",{className:"exp-scanner-wrapper",children:e.jsx(Ns,{resources:ue,defaultResourceId:ue.length===1?ue[0].id:null,onExpenseCreated:de,onCancel:()=>{G(!1),Q("form")}})}),e.jsxs("div",{className:"exp-table-card",children:[e.jsxs("div",{className:"exp-table-header",children:[e.jsx("h2",{className:"exp-table-title",children:"Expense Entries"}),e.jsxs("span",{className:"exp-table-count",children:[ve.length," expense",ve.length!==1?"s":""]})]}),e.jsx(zs,{expenses:ve,hasRole:E,setDetailModal:z})]})]}),e.jsx(we,{isOpen:n.isOpen,onClose:()=>f({isOpen:!1,expenseId:null,expenseData:null}),onConfirm:Ye,title:"Delete Expense",message:n.expenseData?e.jsxs("div",{children:[e.jsx("p",{children:"Are you sure you want to delete this expense?"}),e.jsxs("div",{style:{backgroundColor:"#fef3c7",border:"1px solid #f59e0b",borderRadius:"8px",padding:"12px",marginTop:"12px"},children:[e.jsx("p",{style:{fontWeight:"600",color:"#92400e",margin:"0 0 8px 0",fontSize:"14px"},children:"Details:"}),e.jsxs("ul",{style:{margin:"0",paddingLeft:"20px",color:"#92400e",fontSize:"13px",lineHeight:"1.6"},children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Resource:"})," ",n.expenseData.resourceName]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Category:"})," ",n.expenseData.category]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Amount:"})," £",n.expenseData.totalAmount?.toFixed(2)]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Status:"})," ",n.expenseData.status]})]})]})]}):"Are you sure you want to delete this expense?",confirmText:"Delete",cancelText:"Cancel",type:"danger"}),e.jsx(we,{isOpen:S.isOpen,onClose:()=>m({isOpen:!1,expense:null}),onConfirm:We,title:"Submit for Validation",message:S.expense?e.jsxs(e.Fragment,{children:["Submit this expense for validation?",e.jsx("br",{}),e.jsx("br",{}),e.jsx("strong",{children:S.expense.category})," - £",parseFloat(S.expense.amount||0).toFixed(2),e.jsx("br",{}),S.expense.resource_name]}):"",confirmText:"Submit",cancelText:"Cancel",type:"info"}),e.jsx(Gs,{isOpen:Y.isOpen,expense:Y.expense,resources:_,hasRole:E,canEditChargeable:Qe,canSubmitExpense:k,canValidateExpense:D,canEditExpense:u,canDeleteExpense:j,onClose:()=>z({isOpen:!1,expense:null}),onSave:async(o,w)=>{const F=_.find(U=>U.id===w.resource_id)?.name||w.resource_name;await W.update(o,{category:w.category,resource_id:w.resource_id,resource_name:F,expense_date:w.expense_date,reason:w.reason,amount:parseFloat(w.amount),notes:w.notes,status:w.status,chargeable_to_customer:w.chargeable_to_customer,procurement_method:w.procurement_method}),await R(),r("Expense updated!")},onSubmit:Ve,onValidate:qe,onReject:He,onDelete:Ge,onDownloadFile:Ze}),e.jsx(ns,{isOpen:C.isOpen,onClose:()=>M({isOpen:!1,expenseId:null}),onConfirm:Je,title:"Reject Expense",message:"Please provide a reason for rejecting this expense.",inputLabel:"Rejection Reason",inputPlaceholder:"Enter reason (optional)",confirmText:"Reject",cancelText:"Cancel",type:"warning"})]})}export{Zs as default};
