import{u as Je,a as Xe,b as Ye,c as qe,e as C,s as Qe,j as e,L as Ke,P as Ze,S}from"./index-0iKYvAjY.js";import{r as p}from"./vendor-react-JFEV0ROX.js";import{u as Ee}from"./usePermissions-Y7hRSoBg.js";import{C as ea}from"./ConfirmDialog-Cc-bj3UD.js";import{g as Z,N as aa,C as ce,v as ta,y as de,l as ue,U as ra,ae as me,af as pe,ag as he,ah as sa,F as oa,a as I,Q as ge,e as na,ai as la,b as ia,O as ca,T as da}from"./vendor-icons-C_cLyTyv.js";import"./vendor-supabase-DgEUAXvv.js";const M=20520,le=["Travel","Accommodation","Sustenance"],fe=["Draft","Submitted","Approved","Rejected","Paid"],ee={Draft:"Draft",Submitted:"Submitted",Approved:"Validated",Rejected:"Rejected",Paid:"Paid"},ie={resource_id:"",expense_date:new Date().toISOString().split("T")[0],travel_amount:"",travel_reason:"",travel_chargeable:!0,travel_procurement:"supplier",accommodation_amount:"",accommodation_reason:"",accommodation_chargeable:!0,accommodation_procurement:"supplier",sustenance_amount:"",sustenance_reason:"",sustenance_chargeable:!0,sustenance_procurement:"supplier",notes:"",files:[]};function _a(){const{user:t,role:c}=Je(),{projectId:l}=Xe(),{showSuccess:i,showError:h,showWarning:f}=Ye(),{showTestUsers:_,testUserIds:y}=qe(),b=t?.id||null,{canAddExpense:o,canSubmitExpense:A,canValidateExpense:D,canEditExpense:F,canDeleteExpense:B,getAvailableResources:j,hasRole:v}=Ee(),[u,w]=p.useState([]),[P,V]=p.useState([]),[G,L]=p.useState(!0),[O,N]=p.useState(!1),[k,g]=p.useState(null),[s,U]=p.useState({}),[xe,ae]=p.useState(!1),[n,W]=p.useState(ie),[H,be]=p.useState("all"),[J,je]=p.useState("all"),[X,ye]=p.useState("all"),[Y,_e]=p.useState("all"),[q,ve]=p.useState("all"),[T,Q]=p.useState({isOpen:!1,expenseId:null,expenseData:null}),[pa,Ce]=p.useState({isOpen:!1,expense:null,editMode:!1,editData:null}),R=p.useCallback(async()=>{if(l){L(!0);try{const a=await C.getAllFiltered(l,_);w(a);const{data:r}=await Qe.from("resources").select("id, name, email, user_id, partner_id, partner:partners(id, name)").order("name");let d=r||[];!_&&y?.length>0&&(d=d.filter(x=>!x.user_id||!y.includes(x.user_id))),V(d)}catch{h("Failed to load expenses")}finally{L(!1)}}},[l,_,y,h]);p.useEffect(()=>{R()},[R]);async function Se(){if(!n.resource_id){f("Please select a resource");return}const a=parseFloat(n.travel_amount)>0,r=parseFloat(n.accommodation_amount)>0,d=parseFloat(n.sustenance_amount)>0;if(!a&&!r&&!d){f("Please enter at least one expense amount");return}if(a&&!n.travel_reason){f("Please enter a reason for the travel expense");return}if(r&&!n.accommodation_reason){f("Please enter a reason for the accommodation expense");return}if(d&&!n.sustenance_reason){f("Please enter a reason for the sustenance expense");return}try{const x=P.find(K=>K.id===n.resource_id)?.name,m=[];a&&m.push({project_id:l,category:"Travel",resource_id:n.resource_id,resource_name:x,expense_date:n.expense_date,reason:n.travel_reason,amount:parseFloat(n.travel_amount),notes:n.notes,created_by:b,chargeable_to_customer:n.travel_chargeable,procurement_method:n.travel_procurement}),r&&m.push({project_id:l,category:"Accommodation",resource_id:n.resource_id,resource_name:x,expense_date:n.expense_date,reason:n.accommodation_reason,amount:parseFloat(n.accommodation_amount),notes:n.notes,created_by:b,chargeable_to_customer:n.accommodation_chargeable,procurement_method:n.accommodation_procurement}),d&&m.push({project_id:l,category:"Sustenance",resource_id:n.resource_id,resource_name:x,expense_date:n.expense_date,reason:n.sustenance_reason,amount:parseFloat(n.sustenance_amount),notes:n.notes,created_by:b,chargeable_to_customer:n.sustenance_chargeable,procurement_method:n.sustenance_procurement});const $=await C.createMany(m);if(n.files.length>0&&$){ae(!0);for(const K of $)for(const He of n.files)try{await C.uploadReceipt(K.id,He,b)}catch{}ae(!1)}await R(),N(!1),W(ie),i("Expenses added successfully!")}catch(x){h("Failed to add expenses: "+x.message)}}function Ae(a){g(a.id),U({category:a.category,resource_id:a.resource_id,resource_name:a.resource_name,expense_date:a.expense_date,reason:a.reason,amount:a.amount,notes:a.notes,status:a.status,chargeable_to_customer:a.chargeable_to_customer!==!1,procurement_method:a.procurement_method||"supplier"})}async function Te(a){try{const r=P.find(d=>d.id===s.resource_id)?.name||s.resource_name;await C.update(a,{category:s.category,resource_id:s.resource_id,resource_name:r,expense_date:s.expense_date,reason:s.reason,amount:parseFloat(s.amount),notes:s.notes,status:s.status,chargeable_to_customer:s.chargeable_to_customer,procurement_method:s.procurement_method}),await R(),g(null),i("Expense updated!")}catch(r){h("Failed to update: "+r.message)}}function Re(a){Q({isOpen:!0,expenseId:a.id,expenseData:{resourceName:a.resource_name,date:a.expense_date,totalAmount:parseFloat(a.amount||0),category:a.category,chargeable:a.chargeable_to_customer,procurement:a.procurement_method,status:a.status}})}async function ke(){if(T.expenseId)try{await C.delete(T.expenseId,b),await R(),Q({isOpen:!1,expenseId:null,expenseData:null}),i("Expense deleted")}catch(a){h("Failed to delete: "+a.message)}}async function ze(a){if(confirm("Submit this expense for validation?"))try{await C.submit(a),await R(),i("Expense submitted for validation!")}catch(r){h("Failed to submit: "+r.message)}}async function Pe(a){try{await C.approve(a),await R(),i("Expense validated!")}catch(r){h("Failed to validate: "+r.message)}}async function Ne(a){const r=prompt("Please provide a reason for rejection (optional):");try{await C.reject(a,r),await R(),f("Expense rejected")}catch(d){h("Failed to reject: "+d.message)}}function De(a){const r=Array.from(a.target.files);W({...n,files:[...n.files,...r]})}function Fe(a){W({...n,files:n.files.filter((r,d)=>d!==a)})}async function Be(a,r){try{const d=await C.downloadReceipt(a),x=URL.createObjectURL(d),m=document.createElement("a");m.href=x,m.download=r,document.body.appendChild(m),m.click(),document.body.removeChild(m),URL.revokeObjectURL(x)}catch{h("Failed to download file")}}function te(a){switch(a){case"Travel":return e.jsx(he,{size:16});case"Accommodation":return e.jsx(pe,{size:16});case"Sustenance":return e.jsx(me,{size:16});default:return e.jsx(Z,{size:16})}}function re(a){switch(a){case"Travel":return{bg:"#dbeafe",color:"#2563eb"};case"Accommodation":return{bg:"#f3e8ff",color:"#7c3aed"};case"Sustenance":return{bg:"#ffedd5",color:"#ea580c"};default:return{bg:"#f1f5f9",color:"#64748b"}}}function Ie(a){switch(a){case"Approved":case"Paid":return"status-completed";case"Submitted":return"status-in-progress";case"Rejected":return"status-at-risk";default:return"status-not-started"}}function Le(){return v(["admin","supplier_pm","customer_pm"])}const se=u.filter(a=>!(H!=="all"&&a.category!==H||J!=="all"&&a.resource_name!==J||X!=="all"&&a.status!==X||Y==="chargeable"&&a.chargeable_to_customer===!1||Y==="non-chargeable"&&a.chargeable_to_customer!==!1||q!=="all"&&(a.procurement_method||"supplier")!==q)),Oe=u.reduce((a,r)=>a+parseFloat(r.amount||0),0),Ue=u.filter(a=>a.chargeable_to_customer!==!1).reduce((a,r)=>a+parseFloat(r.amount||0),0),We=u.filter(a=>a.chargeable_to_customer===!1).reduce((a,r)=>a+parseFloat(r.amount||0),0),oe=u.filter(a=>["Approved","Paid"].includes(a.status)).reduce((a,r)=>a+parseFloat(r.amount||0),0),ne=M-oe,$e=u.filter(a=>a.status==="Submitted").length,Me=u.filter(a=>(a.procurement_method||"supplier")==="supplier").reduce((a,r)=>a+parseFloat(r.amount||0),0),we=u.filter(a=>a.procurement_method==="partner").reduce((a,r)=>a+parseFloat(r.amount||0),0),Ve={Travel:u.filter(a=>a.category==="Travel").reduce((a,r)=>a+parseFloat(r.amount||0),0),Accommodation:u.filter(a=>a.category==="Accommodation").reduce((a,r)=>a+parseFloat(r.amount||0),0),Sustenance:u.filter(a=>a.category==="Sustenance").reduce((a,r)=>a+parseFloat(r.amount||0),0)},z={};u.forEach(a=>{z[a.resource_name]||(z[a.resource_name]={total:0,chargeable:0,nonChargeable:0});const r=parseFloat(a.amount||0);z[a.resource_name].total+=r,a.chargeable_to_customer!==!1?z[a.resource_name].chargeable+=r:z[a.resource_name].nonChargeable+=r});const Ge=j(P);return G&&!l?e.jsx(Ke,{message:"Loading expenses...",size:"large",fullPage:!0}):e.jsxs("div",{className:"page-container",children:[e.jsx(Ze,{icon:Z,title:"Expenses",subtitle:`Track project expenses against Â£${M.toLocaleString()} budget`,children:o&&!O&&e.jsxs("button",{className:"btn btn-primary",onClick:()=>N(!0),children:[e.jsx(aa,{size:18})," Add Expenses"]})}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem"},children:[e.jsx(S,{icon:Z,label:"Total Budget",value:`Â£${M.toLocaleString()}`,color:"#3b82f6"}),e.jsx(S,{label:"Total Claimed",value:`Â£${Oe.toLocaleString()}`,color:"#3b82f6"}),e.jsx(S,{icon:ce,label:"Chargeable",value:`Â£${Ue.toLocaleString()}`,color:"#10b981"}),e.jsx(S,{icon:ta,label:"Non-Chargeable",value:`Â£${We.toLocaleString()}`,color:"#f59e0b"})]}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem",gridTemplateColumns:"repeat(3, 1fr)"},children:[e.jsx(S,{label:"Validated/Paid",value:`Â£${oe.toLocaleString()}`,color:"#10b981"}),e.jsx(S,{label:"Remaining Budget",value:`Â£${ne.toLocaleString()}`,color:ne<M*.2?"#ef4444":"#10b981"}),e.jsx(S,{label:"Pending Validation",value:$e,color:"#f59e0b"})]}),v(["admin","supplier_pm"])&&e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem",gridTemplateColumns:"repeat(2, 1fr)"},children:[e.jsx(S,{icon:de,label:"Supplier Procured",value:`Â£${Me.toLocaleString()}`,subtext:"Paid directly by JT",color:"#6366f1"}),e.jsx(S,{icon:ue,label:"Partner Procured",value:`Â£${we.toLocaleString()}`,subtext:"Reimbursable to partners",color:"#8b5cf6"})]}),e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Breakdown by Type"}),e.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:"1rem"},children:le.map(a=>{const r=re(a),d=u.filter(m=>m.category===a).length,x=u.filter(m=>m.category===a&&m.chargeable_to_customer!==!1).reduce((m,$)=>m+parseFloat($.amount||0),0);return e.jsxs("div",{style:{padding:"1rem",backgroundColor:r.bg,borderRadius:"8px"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",color:r.color,marginBottom:"0.5rem"},children:[te(a),e.jsx("span",{style:{fontWeight:"600"},children:a})]}),e.jsxs("div",{style:{fontSize:"1.5rem",fontWeight:"700",color:r.color},children:["Â£",Ve[a].toFixed(2)]}),e.jsxs("div",{style:{fontSize:"0.8rem",color:"#64748b"},children:[d," expense(s)"]}),e.jsxs("div",{style:{fontSize:"0.75rem",color:"#10b981",marginTop:"0.25rem"},children:["Â£",x.toFixed(2)," chargeable"]})]},a)})})]}),Object.keys(z).length>0&&e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Breakdown by Resource"}),e.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"1rem"},children:Object.entries(z).map(([a,r])=>e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#f1f5f9",borderRadius:"8px",minWidth:"180px"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"0.5rem"},children:[e.jsx(ra,{size:16,style:{color:"#64748b"}}),e.jsx("span",{style:{fontWeight:"600",fontSize:"0.9rem"},children:a})]}),e.jsxs("div",{style:{fontSize:"1.25rem",fontWeight:"700",color:"#3b82f6"},children:["Â£",r.total.toFixed(2)]}),e.jsxs("div",{style:{fontSize:"0.75rem",color:"#10b981"},children:["Â£",r.chargeable.toFixed(2)," chargeable"]}),r.nonChargeable>0&&e.jsxs("div",{style:{fontSize:"0.75rem",color:"#f59e0b"},children:["Â£",r.nonChargeable.toFixed(2)," non-chargeable"]})]},a))})]}),e.jsx("div",{className:"card",style:{marginBottom:"1.5rem"},children:e.jsxs("div",{style:{display:"flex",gap:"1rem",alignItems:"center",flexWrap:"wrap"},children:[e.jsx("span",{style:{fontWeight:"500"},children:"Filter:"}),e.jsxs("select",{value:H,onChange:a=>be(a.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"all",children:"All Types"}),le.map(a=>e.jsx("option",{value:a,children:a},a))]}),e.jsxs("select",{value:J,onChange:a=>je(a.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"all",children:"All Resources"}),[...new Set(u.map(a=>a.resource_name))].map(a=>e.jsx("option",{value:a,children:a},a))]}),e.jsxs("select",{value:X,onChange:a=>ye(a.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"all",children:"All Statuses"}),fe.map(a=>e.jsx("option",{value:a,children:ee[a]||a},a))]}),e.jsxs("select",{value:Y,onChange:a=>_e(a.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"all",children:"All Expenses"}),e.jsx("option",{value:"chargeable",children:"Chargeable Only"}),e.jsx("option",{value:"non-chargeable",children:"Non-Chargeable Only"})]}),v(["admin","supplier_pm"])&&e.jsxs("select",{value:q,onChange:a=>ve(a.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"all",children:"All Procurement"}),e.jsx("option",{value:"supplier",children:"Supplier Procured"}),e.jsx("option",{value:"partner",children:"Partner Procured"})]})]})}),O&&e.jsx(ua,{newExpense:n,setNewExpense:W,availableResources:Ge,hasRole:v,handleAdd:Se,handleFileSelect:De,removeFile:Fe,uploadingFiles:xe,onCancel:()=>N(!1)}),e.jsx("div",{className:"card",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Ref"}),e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Resource"}),e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Reason"}),e.jsx("th",{style:{textAlign:"right"},children:"Amount"}),e.jsx("th",{children:"Chargeable"}),v(["admin","supplier_pm"])&&e.jsx("th",{children:"Procured By"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Receipts"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:se.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:v(["admin","supplier_pm"])?11:10,style:{textAlign:"center",color:"#64748b",padding:"2rem"},children:"No expenses found."})}):se.map(a=>e.jsx(ma,{expense:a,editingId:k,editForm:s,setEditForm:U,resources:P,hasRole:v,canEditChargeable:Le,canSubmitExpense:A,canValidateExpense:D,canEditExpense:F,canDeleteExpense:B,getCategoryIcon:te,getCategoryColor:re,getStatusColor:Ie,handleEdit:Ae,handleSave:Te,handleSubmit:ze,handleApprove:Pe,handleReject:Ne,handleDeleteClick:Re,downloadFile:Be,setEditingId:g,setDetailModal:Ce},a.id))})]})}),e.jsxs("div",{className:"card",style:{marginTop:"1.5rem",backgroundColor:"#fffbeb",borderLeft:"4px solid #f59e0b"},children:[e.jsx("h4",{style:{marginBottom:"0.5rem",color:"#92400e"},children:"ðŸ“‹ Expense Guidelines"}),e.jsxs("ul",{style:{margin:"0.5rem 0 0 1.5rem",color:"#92400e",fontSize:"0.9rem"},children:[e.jsx("li",{children:"PMO travel/accommodation requires advance approval from Authority Project Manager"}),e.jsx("li",{children:"Attach receipts for all expenses over Â£25"}),e.jsx("li",{children:"Submit expenses within 30 days of incurring them"}),e.jsxs("li",{children:[e.jsx("strong",{children:"Submit:"})," Click the send icon to submit for validation"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Chargeable expenses:"})," Validated by Customer PM"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Non-chargeable expenses:"})," Validated by Supplier PM"]})]})]}),e.jsx(ea,{isOpen:T.isOpen,onClose:()=>Q({isOpen:!1,expenseId:null,expenseData:null}),onConfirm:ke,title:"Delete Expense",message:T.expenseData?e.jsxs("div",{children:[e.jsx("p",{children:"Are you sure you want to delete this expense?"}),e.jsxs("div",{style:{backgroundColor:"#fef3c7",border:"1px solid #f59e0b",borderRadius:"6px",padding:"0.75rem",marginTop:"0.75rem"},children:[e.jsx("p",{style:{fontWeight:"600",color:"#92400e",margin:"0 0 0.5rem 0"},children:"Details:"}),e.jsxs("ul",{style:{margin:"0",paddingLeft:"1.25rem",color:"#92400e",fontSize:"0.9rem"},children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Resource:"})," ",T.expenseData.resourceName]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Category:"})," ",T.expenseData.category]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Amount:"})," Â£",T.expenseData.totalAmount?.toFixed(2)]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Status:"})," ",T.expenseData.status]})]})]}),e.jsx("p",{style:{marginTop:"0.75rem",fontSize:"0.85rem",color:"#6b7280"},children:"This expense can be restored from the audit log if needed."})]}):"Are you sure you want to delete this expense?",confirmText:"Delete",cancelText:"Cancel",variant:"danger"})]})}function ua({newExpense:t,setNewExpense:c,availableResources:l,hasRole:i,handleAdd:h,handleFileSelect:f,removeFile:_,uploadingFiles:y,onCancel:b}){return e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem",border:"2px solid var(--primary)"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Add New Expenses"}),e.jsx("p",{style:{color:"#64748b",fontSize:"0.9rem",marginBottom:"1rem"},children:"Enter amounts for any categories that apply. Leave blank to skip a category."}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem",marginBottom:"1.5rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Resource Name *"}),e.jsxs("select",{className:"form-input",value:t.resource_id,onChange:o=>c({...t,resource_id:o.target.value}),children:[e.jsx("option",{value:"",children:"Select Resource"}),l.map(o=>e.jsx("option",{value:o.id,children:o.name},o.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Date *"}),e.jsx("input",{type:"date",className:"form-input",value:t.expense_date,onChange:o=>c({...t,expense_date:o.target.value})})]})]}),e.jsx(E,{category:"Travel",icon:e.jsx(he,{size:20}),bgColor:"#dbeafe",textColor:"#2563eb",borderColor:"#93c5fd",amount:t.travel_amount,reason:t.travel_reason,chargeable:t.travel_chargeable,procurement:t.travel_procurement,onAmountChange:o=>c({...t,travel_amount:o}),onReasonChange:o=>c({...t,travel_reason:o}),onChargeableChange:o=>c({...t,travel_chargeable:o}),onProcurementChange:o=>c({...t,travel_procurement:o}),hasRole:i}),e.jsx(E,{category:"Accommodation",icon:e.jsx(pe,{size:20}),bgColor:"#f3e8ff",textColor:"#7c3aed",borderColor:"#d8b4fe",amount:t.accommodation_amount,reason:t.accommodation_reason,chargeable:t.accommodation_chargeable,procurement:t.accommodation_procurement,onAmountChange:o=>c({...t,accommodation_amount:o}),onReasonChange:o=>c({...t,accommodation_reason:o}),onChargeableChange:o=>c({...t,accommodation_chargeable:o}),onProcurementChange:o=>c({...t,accommodation_procurement:o}),hasRole:i}),e.jsx(E,{category:"Sustenance",icon:e.jsx(me,{size:20}),bgColor:"#ffedd5",textColor:"#ea580c",borderColor:"#fdba74",amount:t.sustenance_amount,reason:t.sustenance_reason,chargeable:t.sustenance_chargeable,procurement:t.sustenance_procurement,onAmountChange:o=>c({...t,sustenance_amount:o}),onReasonChange:o=>c({...t,sustenance_reason:o}),onChargeableChange:o=>c({...t,sustenance_chargeable:o}),onProcurementChange:o=>c({...t,sustenance_procurement:o}),hasRole:i}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{className:"form-label",children:"Additional Notes"}),e.jsx("textarea",{className:"form-input",rows:2,placeholder:"Any additional information...",value:t.notes,onChange:o=>c({...t,notes:o.target.value})})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{className:"form-label",children:"Attach Receipts"}),e.jsxs("div",{style:{border:"2px dashed #d1d5db",borderRadius:"8px",padding:"1.5rem",textAlign:"center",cursor:"pointer",backgroundColor:"#f9fafb"},onClick:()=>document.getElementById("file-upload").click(),children:[e.jsx(sa,{size:24,style:{color:"#9ca3af",marginBottom:"0.5rem"}}),e.jsx("div",{style:{color:"#64748b",fontSize:"0.85rem"},children:"Click to upload receipts"}),e.jsx("input",{id:"file-upload",type:"file",multiple:!0,accept:".pdf,.jpg,.jpeg,.png,.zip",style:{display:"none"},onChange:f})]}),t.files.length>0&&e.jsx("div",{style:{marginTop:"0.5rem"},children:t.files.map((o,A)=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.25rem 0",fontSize:"0.85rem"},children:[e.jsx(oa,{size:14}),e.jsx("span",{style:{flex:1},children:o.name}),e.jsx("button",{onClick:()=>_(A),style:{background:"none",border:"none",cursor:"pointer",color:"#ef4444"},children:e.jsx(I,{size:14})})]},A))})]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsxs("button",{className:"btn btn-primary",onClick:h,disabled:y,children:[e.jsx(ge,{size:16})," ",y?"Uploading...":"Save Expenses"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:b,children:[e.jsx(I,{size:16})," Cancel"]})]})]})}function E({category:t,icon:c,bgColor:l,textColor:i,borderColor:h,amount:f,reason:_,chargeable:y,procurement:b,onAmountChange:o,onReasonChange:A,onChargeableChange:D,onProcurementChange:F,hasRole:B}){return e.jsxs("div",{style:{padding:"1rem",backgroundColor:l,borderRadius:"8px",marginBottom:"1rem"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",color:i,marginBottom:"0.75rem"},children:[c,e.jsx("span",{style:{fontWeight:"600",fontSize:"1rem"},children:t})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"150px 1fr",gap:"1rem",marginBottom:"0.75rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Amount (Â£)"}),e.jsx("input",{type:"number",step:"0.01",className:"form-input",placeholder:"0.00",value:f,onChange:j=>o(j.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Reason / Description"}),e.jsx("input",{type:"text",className:"form-input",placeholder:`e.g., ${t} expense description`,value:_,onChange:j=>A(j.target.value)})]})]}),parseFloat(f)>0&&e.jsxs("div",{style:{display:"flex",gap:"1.5rem",flexWrap:"wrap",paddingTop:"0.75rem",borderTop:`1px solid ${h}`},children:[e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"0.5rem",cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:y,onChange:j=>D(j.target.checked),style:{width:"16px",height:"16px",accentColor:i}}),e.jsx("span",{style:{fontSize:"0.85rem",color:i},children:"Chargeable to Customer"})]}),B(["admin","supplier_pm"])&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.85rem",color:i},children:"Paid by:"}),e.jsxs("select",{value:b,onChange:j=>F(j.target.value),style:{padding:"0.25rem 0.5rem",borderRadius:"4px",border:`1px solid ${h}`,fontSize:"0.85rem",backgroundColor:"#fff"},children:[e.jsx("option",{value:"supplier",children:"Supplier (JT)"}),e.jsx("option",{value:"partner",children:"Partner"})]})]})]})]})}function ma({expense:t,editingId:c,editForm:l,setEditForm:i,resources:h,hasRole:f,canEditChargeable:_,canSubmitExpense:y,canValidateExpense:b,canEditExpense:o,canDeleteExpense:A,getCategoryIcon:D,getCategoryColor:F,getStatusColor:B,handleEdit:j,handleSave:v,handleSubmit:u,handleApprove:w,handleReject:P,handleDeleteClick:V,downloadFile:G,setEditingId:L,setDetailModal:O}){const N=F(t.category),k=t.chargeable_to_customer!==!1,g=c===t.id;return e.jsxs("tr",{style:{backgroundColor:k?"inherit":"#fffbeb",cursor:g?"default":"pointer"},onClick:()=>!g&&O({isOpen:!0,expense:t}),children:[e.jsx("td",{style:{fontFamily:"monospace",fontSize:"0.85rem"},children:t.expense_ref||"-"}),e.jsx("td",{children:g?e.jsxs("select",{className:"form-input",value:l.category,onChange:s=>i({...l,category:s.target.value}),children:[e.jsx("option",{value:"Travel",children:"Travel"}),e.jsx("option",{value:"Accommodation",children:"Accommodation"}),e.jsx("option",{value:"Sustenance",children:"Sustenance"})]}):e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.85rem",backgroundColor:N.bg,color:N.color},children:[D(t.category),t.category]})}),e.jsx("td",{children:g?e.jsxs("select",{className:"form-input",value:l.resource_id||"",onChange:s=>i({...l,resource_id:s.target.value}),children:[e.jsx("option",{value:"",children:"-- Select --"}),h.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]}):t.resource_name}),e.jsx("td",{children:g?e.jsx("input",{type:"date",className:"form-input",value:l.expense_date,onChange:s=>i({...l,expense_date:s.target.value})}):new Date(t.expense_date).toLocaleDateString("en-GB")}),e.jsx("td",{style:{maxWidth:"200px"},children:g?e.jsx("input",{type:"text",className:"form-input",value:l.reason,onChange:s=>i({...l,reason:s.target.value})}):e.jsx("div",{style:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:t.reason})}),e.jsx("td",{style:{textAlign:"right",fontWeight:"600"},children:g?e.jsx("input",{type:"number",step:"0.01",className:"form-input",value:l.amount,onChange:s=>i({...l,amount:s.target.value}),style:{width:"100px",textAlign:"right"}}):`Â£${parseFloat(t.amount).toFixed(2)}`}),e.jsx("td",{children:g&&_()?e.jsx("input",{type:"checkbox",checked:l.chargeable_to_customer,onChange:s=>i({...l,chargeable_to_customer:s.target.checked}),style:{width:"18px",height:"18px"}}):e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.75rem",fontWeight:"500",backgroundColor:k?"#dcfce7":"#fef3c7",color:k?"#166534":"#92400e"},children:[k?e.jsx(na,{size:12}):e.jsx(I,{size:12}),k?"Yes":"No"]})}),f(["admin","supplier_pm"])&&e.jsx("td",{children:g?e.jsxs("select",{className:"form-input",value:l.procurement_method||"supplier",onChange:s=>i({...l,procurement_method:s.target.value}),style:{fontSize:"0.85rem",padding:"0.25rem"},children:[e.jsx("option",{value:"supplier",children:"Supplier"}),e.jsx("option",{value:"partner",children:"Partner"})]}):e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.75rem",fontWeight:"500",backgroundColor:(t.procurement_method||"supplier")==="partner"?"#f3e8ff":"#e0e7ff",color:(t.procurement_method||"supplier")==="partner"?"#7c3aed":"#4338ca"},children:[(t.procurement_method||"supplier")==="partner"?e.jsx(ue,{size:12}):e.jsx(de,{size:12}),(t.procurement_method||"supplier")==="partner"?"Partner":"Supplier"]})}),e.jsx("td",{children:g&&b(t)?e.jsx("select",{className:"form-input",value:l.status,onChange:s=>i({...l,status:s.target.value}),children:fe.map(s=>e.jsx("option",{value:s,children:ee[s]||s},s))}):e.jsx("span",{className:`status-badge ${B(t.status)}`,children:ee[t.status]||t.status})}),e.jsx("td",{onClick:s=>s.stopPropagation(),children:t.expense_files?.length>0?e.jsx("div",{style:{display:"flex",gap:"0.25rem"},children:t.expense_files.map((s,U)=>e.jsx("button",{onClick:()=>G(s.file_path,s.file_name),style:{background:"none",border:"none",cursor:"pointer",color:"#3b82f6"},title:s.file_name,children:e.jsx(la,{size:16})},U))}):"-"}),e.jsx("td",{onClick:s=>s.stopPropagation(),children:g?e.jsxs("div",{className:"action-buttons",children:[e.jsx("button",{className:"btn-icon btn-success",onClick:()=>v(t.id),children:e.jsx(ge,{size:16})}),e.jsx("button",{className:"btn-icon btn-secondary",onClick:()=>L(null),children:e.jsx(I,{size:16})})]}):e.jsxs("div",{className:"action-buttons",children:[y(t)&&e.jsx("button",{className:"btn-icon",onClick:()=>u(t.id),title:"Submit for Validation",style:{color:"#3b82f6"},children:e.jsx(ia,{size:16})}),b(t)&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn-icon btn-success",onClick:()=>w(t.id),title:"Validate",children:e.jsx(ce,{size:16})}),e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>P(t.id),title:"Reject",children:e.jsx(I,{size:16})})]}),o(t)&&e.jsx("button",{className:"btn-icon",onClick:()=>j(t),title:"Edit",children:e.jsx(ca,{size:16})}),A(t)&&e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>V(t),title:"Delete",children:e.jsx(da,{size:16})})]})})]})}export{_a as default};
