import{s as I,u as Pe,a as Ae,b as ze,j as e,c as or,e as D,L as lr,P as cr,S as $}from"./index-BAeOFH35.js";import{r as m}from"./vendor-react-CaXNtsgv.js";import{u as ir}from"./usePermissions-SdW04b9_.js";import{C as dr}from"./ConfirmDialog-CLo-gYP-.js";import{g as ce,a as J,ae as xe,af as be,S as ie,ag as ur,L as mr,ah as ye,ai as ve,aj as _e,e as de,t as pr,O as hr,C as Ie,v as gr,J as Fe,l as Ee,U as fr,F as xr,y as De,ak as br,b as jr,Q as yr,T as vr}from"./vendor-icons-BB9jpMgd.js";import"./vendor-supabase-qY1sfceY.js";import"./vendor-charts-_mIYJ_kN.js";const _r={uber:"Travel",lyft:"Travel",taxi:"Travel",train:"Travel",rail:"Travel",airlines:"Travel",airways:"Travel",petrol:"Travel","gas station":"Travel",fuel:"Travel",parking:"Travel",hotel:"Accommodation",inn:"Accommodation",motel:"Accommodation",airbnb:"Accommodation","booking.com":"Accommodation",marriott:"Accommodation",hilton:"Accommodation","premier inn":"Accommodation",travelodge:"Accommodation",restaurant:"Sustenance",cafe:"Sustenance",coffee:"Sustenance",costa:"Sustenance",starbucks:"Sustenance",pret:"Sustenance",greggs:"Sustenance",mcdonald:"Sustenance",subway:"Sustenance",nando:"Sustenance",pizza:"Sustenance",pub:"Sustenance",bar:"Sustenance",food:"Sustenance",supermarket:"Sustenance",tesco:"Sustenance",sainsbury:"Sustenance","co-op":"Sustenance",waitrose:"Sustenance",aldi:"Sustenance",lidl:"Sustenance"};class Cr{constructor(){this.bucketName="receipt-scans"}async uploadImage(n,s){try{if(!["image/jpeg","image/png","image/webp","image/heic"].includes(n.type))throw new Error("Invalid file type. Please upload a JPEG, PNG, or WebP image.");const o=10*1024*1024;if(n.size>o)throw new Error("File too large. Maximum size is 10MB.");const p=Date.now(),f=n.name.split(".").pop(),x=`${s}/${p}.${f}`,{error:b}=await I.storage.from(this.bucketName).upload(x,n);if(b)throw b;const{data:{publicUrl:c}}=I.storage.from(this.bucketName).getPublicUrl(x);return{path:x,url:c}}catch(t){throw t}}async processReceipt(n,s){const t=Date.now();try{const o=await this.fetchImageAsBase64(n),p=await this.callClaudeVision(o);let f=await this.findClassificationRule(s,p.merchant);f||(f=this.classifyFromPatterns(p.merchant),!f&&p.aiSuggestedCategory&&(f={category:p.aiSuggestedCategory,confidence:p.aiConfidence||.6}));const x=Date.now()-t;return{...p,suggestedCategory:f?.category||null,confidence:f?.confidence||0,ruleBasedClassification:!!f?.ruleId,processingTimeMs:x}}catch(o){throw o}}async fetchImageAsBase64(n){try{const t=await(await fetch(n)).blob();return new Promise((o,p)=>{const f=new FileReader;f.onloadend=()=>{const x=f.result.split(",")[1];o({data:x,mediaType:t.type})},f.onerror=p,f.readAsDataURL(t)})}catch(s){throw s}}async callClaudeVision(n){const s=`Analyze this receipt image and extract the following information in JSON format:
{
  "merchant": "Store/vendor name",
  "amount": 0.00,
  "currency": "GBP",
  "date": "YYYY-MM-DD",
  "items": [{"name": "item name", "quantity": 1, "price": 0.00}],
  "paymentMethod": "card/cash/unknown",
  "category": "Travel/Accommodation/Sustenance",
  "confidence": 0.0 to 1.0,
  "rawText": "All visible text from receipt"
}

If any field cannot be determined, use null. For the category, consider:
- Travel: transport, fuel, parking, flights, trains, taxis
- Accommodation: hotels, lodging, rentals
- Sustenance: food, drinks, restaurants, cafes, supermarkets

Be conservative with confidence - only use high values (>0.8) when very certain.`;try{const t=await fetch("/api/scan-receipt",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({image:n,prompt:s})});if(!t.ok)throw new Error("Failed to process receipt with AI");const o=await t.json();return{merchant:o.merchant,amount:o.amount,currency:o.currency||"GBP",date:o.date,items:o.items||[],paymentMethod:o.paymentMethod,aiSuggestedCategory:o.category,aiConfidence:o.confidence,rawText:o.rawText}}catch(t){return{merchant:null,amount:null,currency:"GBP",date:null,items:[],paymentMethod:null,aiSuggestedCategory:null,aiConfidence:0,rawText:null,error:t.message}}}async findClassificationRule(n,s){if(!s)return null;try{const{data:t,error:o}=await I.rpc("find_classification_rule",{p_project_id:n,p_merchant:s});if(o)throw o;return t&&t.length>0?{ruleId:t[0].rule_id,category:t[0].category,subcategory:t[0].subcategory,defaultChargeable:t[0].default_chargeable,defaultProcurement:t[0].default_procurement,confidence:parseFloat(t[0].confidence)}:null}catch{return null}}classifyFromPatterns(n){if(!n)return null;const s=n.toLowerCase();for(const[t,o]of Object.entries(_r))if(s.includes(t))return{category:o,confidence:.7,source:"pattern"};return null}async learnFromCorrection(n,s,t,o,p=!1){if(!s||!t)return null;try{const{data:f,error:x}=await I.rpc("upsert_classification_rule",{p_project_id:n,p_merchant:s,p_category:t,p_user_id:o,p_was_correction:p});if(x)throw x;return f}catch{return null}}async createScan(n){try{const{data:s,error:t}=await I.from("receipt_scans").insert({project_id:n.projectId,uploaded_by:n.userId,image_url:n.imageUrl,image_path:n.imagePath,raw_ocr_text:n.rawText,extracted_merchant:n.merchant,extracted_amount:n.amount,extracted_date:n.date,extracted_currency:n.currency,extracted_items:n.items,ai_suggested_category:n.suggestedCategory,ai_confidence:n.confidence,status:"completed",processing_time_ms:n.processingTimeMs}).select().single();if(t)throw t;return s}catch(s){throw s}}async updateScanClassification(n,s,t=!1){try{const{data:o,error:p}=await I.from("receipt_scans").update({final_category:s,user_corrected:t}).eq("id",n).select().single();if(p)throw p;return o}catch(o){throw o}}async linkToExpense(n,s){try{const{data:t,error:o}=await I.from("receipt_scans").update({expense_id:s,status:"linked"}).eq("id",n).select().single();if(o)throw o;return t}catch(t){throw t}}async getRecentScans(n,s=10){try{const{data:t,error:o}=await I.from("receipt_scans").select("*").eq("project_id",n).order("created_at",{ascending:!1}).limit(s);if(o)throw o;return t||[]}catch{return[]}}async getUnlinkedScans(n){try{const{data:s,error:t}=await I.from("receipt_scans").select("*").eq("project_id",n).is("expense_id",null).eq("status","completed").order("created_at",{ascending:!1});if(t)throw t;return s||[]}catch{return[]}}async getClassificationRules(n){try{const{data:s,error:t}=await I.from("classification_rules").select("*").eq("project_id",n).order("match_count",{ascending:!1});if(t)throw t;return s||[]}catch{return[]}}async deleteClassificationRule(n){try{const{error:s}=await I.from("classification_rules").delete().eq("id",n);if(s)throw s;return!0}catch{return!1}}}const ae=new Cr,Sr=[{id:"Travel",label:"Travel",icon:ye,color:"#2563eb",bg:"#dbeafe"},{id:"Accommodation",label:"Accommodation",icon:ve,color:"#7c3aed",bg:"#f3e8ff"},{id:"Sustenance",label:"Sustenance",icon:_e,color:"#ea580c",bg:"#ffedd5"}],C={UPLOAD:"upload",PROCESSING:"processing",REVIEW:"review",COMPLETE:"complete"};function Nr({onExpenseCreated:a,onCancel:n,resources:s=[],defaultResourceId:t=null}){const{user:o}=Pe(),{projectId:p}=Ae(),{showSuccess:f,showError:x,showWarning:b}=ze(),[c,k]=m.useState(C.UPLOAD),[O,B]=m.useState(null),[P,N]=m.useState(null),[E,y]=m.useState(!1),[X,F]=m.useState(""),[A,Y]=m.useState(null),[L,G]=m.useState(null),[u,z]=m.useState({merchant:"",amount:"",date:new Date().toISOString().split("T")[0],category:"",resource_id:t||"",reason:"",chargeable:!0,procurement:"supplier",notes:""}),[S,h]=m.useState(!1),[M,w]=m.useState(!1),[ue,te]=m.useState(!1),V=m.useRef(null),d=m.useRef(null),U=m.useCallback(l=>{const g=l.target.files?.[0];if(!g)return;if(!["image/jpeg","image/png","image/webp","image/heic"].includes(g.type)){x("Please upload a JPEG, PNG, or WebP image");return}if(g.size>10*1024*1024){x("Image too large. Maximum size is 10MB");return}B(g);const ee=new FileReader;ee.onload=re=>{N(re.target.result)},ee.readAsDataURL(g)},[x]),Q=m.useCallback(l=>{l.preventDefault();const g=l.dataTransfer.files?.[0];g&&U({target:{files:[g]}})},[U]),me=m.useCallback(l=>{l.preventDefault()},[]),H=m.useCallback(()=>{B(null),N(null),V.current&&(V.current.value=""),d.current&&(d.current.value="")},[]),pe=m.useCallback(async()=>{if(!O||!p||!o?.id){x("Missing required data for processing");return}k(C.PROCESSING),y(!0),F("Uploading image...");try{const{path:l,url:g}=await ae.uploadImage(O,o.id);F("Analyzing receipt with AI...");const j=await ae.processReceipt(g,p);F("Extracting data...");const ee=await ae.createScan({projectId:p,userId:o.id,imageUrl:g,imagePath:l,...j});G(ee.id),Y(j),z(re=>({...re,merchant:j.merchant||"",amount:j.amount?.toString()||"",date:j.date||new Date().toISOString().split("T")[0],category:j.suggestedCategory||"",reason:j.merchant?`Receipt from ${j.merchant}`:""})),k(C.REVIEW),j.confidence>=.8?f("Receipt scanned successfully!"):j.confidence>=.5?b("Receipt scanned - please verify the details"):b("Could not extract all data - please fill in missing fields")}catch(l){x("Failed to process receipt: "+l.message),k(C.UPLOAD)}finally{y(!1),F("")}},[O,p,o,x,f,b]),T=m.useCallback((l,g)=>{z(j=>({...j,[l]:g})),te(!0),l==="category"&&g!==A?.suggestedCategory&&w(!0)},[A]),he=m.useCallback(l=>{T("category",l),h(!1)},[T]),K=m.useCallback(async()=>{if(!u.resource_id){b("Please select a resource");return}if(!u.amount||parseFloat(u.amount)<=0){b("Please enter a valid amount");return}if(!u.category){b("Please select a category");return}if(!u.reason){b("Please enter a reason/description");return}try{if(u.merchant&&u.category){const g=M&&A?.suggestedCategory!==u.category;await ae.learnFromCorrection(p,u.merchant,u.category,o.id,g)}L&&await ae.updateScanClassification(L,u.category,M);const l={category:u.category,resource_id:u.resource_id,resource_name:s.find(g=>g.id===u.resource_id)?.name,expense_date:u.date,reason:u.reason,amount:parseFloat(u.amount),notes:u.notes,chargeable_to_customer:u.chargeable,procurement_method:u.procurement,receipt_scan_id:L,receipt_image_url:A?.imageUrl};k(C.COMPLETE),a&&a(l),f("Expense created from receipt!")}catch(l){x("Failed to create expense: "+l.message)}},[u,L,A,p,o,s,M,a,f,x,b]),se=m.useCallback(()=>{k(C.UPLOAD),B(null),N(null),Y(null),G(null),z({merchant:"",amount:"",date:new Date().toISOString().split("T")[0],category:"",resource_id:t||"",reason:"",chargeable:!0,procurement:"supplier",notes:""}),te(!1),w(!1)},[t]),Z=()=>{if(!A?.confidence)return null;const l=A.confidence;let g,j;return l>=.8?(g="#10b981",j="High confidence"):l>=.5?(g="#f59e0b",j="Medium confidence"):(g="#ef4444",j="Low confidence"),e.jsxs("div",{className:"confidence-badge",style:{color:g,borderColor:g},children:[e.jsx(ie,{size:14}),j," (",Math.round(l*100),"%)"]})};return e.jsxs("div",{className:"receipt-scanner",children:[e.jsxs("div",{className:"scanner-header",children:[e.jsxs("div",{className:"scanner-title",children:[e.jsx(ce,{size:24}),e.jsxs("div",{children:[e.jsx("h3",{children:"Smart Receipt Scanner"}),e.jsx("p",{children:"Upload a receipt photo to auto-fill expense details"})]})]}),n&&e.jsx("button",{className:"btn btn-ghost",onClick:n,children:e.jsx(J,{size:20})})]}),e.jsxs("div",{className:"scanner-steps",children:[e.jsxs("div",{className:`step ${c===C.UPLOAD?"active":c!==C.UPLOAD?"complete":""}`,children:[e.jsx("div",{className:"step-dot",children:"1"}),e.jsx("span",{children:"Upload"})]}),e.jsx("div",{className:"step-line"}),e.jsxs("div",{className:`step ${c===C.PROCESSING?"active":[C.REVIEW,C.COMPLETE].includes(c)?"complete":""}`,children:[e.jsx("div",{className:"step-dot",children:"2"}),e.jsx("span",{children:"Scan"})]}),e.jsx("div",{className:"step-line"}),e.jsxs("div",{className:`step ${c===C.REVIEW?"active":c===C.COMPLETE?"complete":""}`,children:[e.jsx("div",{className:"step-dot",children:"3"}),e.jsx("span",{children:"Review"})]})]}),e.jsxs("div",{className:"scanner-content",children:[c===C.UPLOAD&&e.jsxs("div",{className:"upload-section",children:[P?e.jsxs("div",{className:"image-preview-section",children:[e.jsxs("div",{className:"image-preview-container",children:[e.jsx("img",{src:P,alt:"Receipt preview",className:"image-preview"}),e.jsx("button",{className:"clear-image-btn",onClick:H,title:"Remove image",children:e.jsx(J,{size:20})})]}),e.jsxs("div",{className:"preview-actions",children:[e.jsxs("button",{className:"btn btn-primary btn-lg",onClick:pe,children:[e.jsx(ie,{size:20})," Scan Receipt"]}),e.jsx("button",{className:"btn btn-ghost",onClick:H,children:"Choose Different Image"})]})]}):e.jsxs("div",{className:"drop-zone",onDrop:Q,onDragOver:me,onClick:()=>V.current?.click(),children:[e.jsx(xe,{size:48,className:"drop-icon"}),e.jsx("p",{className:"drop-text",children:"Drag & drop a receipt image"}),e.jsx("p",{className:"drop-subtext",children:"or click to browse"}),e.jsxs("div",{className:"upload-buttons",children:[e.jsxs("button",{className:"btn btn-primary",onClick:l=>{l.stopPropagation(),V.current?.click()},children:[e.jsx(xe,{size:18})," Choose File"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:l=>{l.stopPropagation(),d.current?.click()},children:[e.jsx(be,{size:18})," Take Photo"]})]}),e.jsx("input",{ref:V,type:"file",accept:"image/jpeg,image/png,image/webp,image/heic",onChange:U,style:{display:"none"}}),e.jsx("input",{ref:d,type:"file",accept:"image/*",capture:"environment",onChange:U,style:{display:"none"}})]}),e.jsxs("div",{className:"scanner-tips",children:[e.jsxs("h4",{children:[e.jsx(ur,{size:16})," Tips for best results"]}),e.jsxs("ul",{children:[e.jsx("li",{children:"Ensure the receipt is flat and well-lit"}),e.jsx("li",{children:"Include the full receipt in frame"}),e.jsx("li",{children:"Avoid shadows and glare"}),e.jsx("li",{children:"Text should be clearly readable"})]})]})]}),c===C.PROCESSING&&e.jsxs("div",{className:"processing-section",children:[e.jsx("div",{className:"processing-animation",children:e.jsx(mr,{size:48,className:"spinner"})}),e.jsx("p",{className:"processing-message",children:X}),e.jsx("p",{className:"processing-subtext",children:"This usually takes a few seconds..."}),P&&e.jsxs("div",{className:"processing-preview",children:[e.jsx("img",{src:P,alt:"Processing"}),e.jsx("div",{className:"scan-overlay"})]})]}),c===C.REVIEW&&e.jsxs("div",{className:"review-section",children:[e.jsxs("div",{className:"extraction-summary",children:[e.jsxs("div",{className:"summary-header",children:[e.jsx("h4",{children:"Extracted Information"}),Z()]}),A?.ruleBasedClassification&&e.jsxs("div",{className:"rule-notice",children:[e.jsx(ie,{size:14}),"Category auto-selected based on previous ",u.merchant," receipts"]})]}),e.jsxs("div",{className:"review-form",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Resource *"}),e.jsxs("select",{className:"form-input",value:u.resource_id,onChange:l=>T("resource_id",l.target.value),children:[e.jsx("option",{value:"",children:"Select resource..."}),s.map(l=>e.jsx("option",{value:l.id,children:l.name},l.id))]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Category *"}),e.jsx("div",{className:"category-selector",children:Sr.map(l=>{const g=l.icon,j=u.category===l.id;return e.jsxs("button",{type:"button",className:`category-btn ${j?"selected":""}`,style:{"--cat-color":l.color,"--cat-bg":l.bg},onClick:()=>he(l.id),children:[e.jsx(g,{size:20}),l.label,j&&e.jsx(de,{size:16,className:"check-icon"})]},l.id)})})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Merchant"}),e.jsx("input",{type:"text",className:"form-input",value:u.merchant,onChange:l=>T("merchant",l.target.value),placeholder:"Store/vendor name"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Amount (Â£) *"}),e.jsx("input",{type:"number",step:"0.01",className:"form-input",value:u.amount,onChange:l=>T("amount",l.target.value),placeholder:"0.00"})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Date *"}),e.jsx("input",{type:"date",className:"form-input",value:u.date,onChange:l=>T("date",l.target.value)})]}),e.jsxs("div",{className:"form-group",style:{flex:2},children:[e.jsx("label",{className:"form-label",children:"Reason/Description *"}),e.jsx("input",{type:"text",className:"form-input",value:u.reason,onChange:l=>T("reason",l.target.value),placeholder:"Brief description of expense"})]})]}),e.jsxs("div",{className:"form-row options-row",children:[e.jsxs("label",{className:"checkbox-label",children:[e.jsx("input",{type:"checkbox",checked:u.chargeable,onChange:l=>T("chargeable",l.target.checked)}),e.jsx("span",{children:"Chargeable to Customer"})]}),e.jsxs("div",{className:"procurement-toggle",children:[e.jsx("span",{children:"Paid by:"}),e.jsxs("select",{className:"form-input-sm",value:u.procurement,onChange:l=>T("procurement",l.target.value),children:[e.jsx("option",{value:"supplier",children:"Supplier (JT)"}),e.jsx("option",{value:"partner",children:"Partner"})]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Additional Notes"}),e.jsx("textarea",{className:"form-input",rows:2,value:u.notes,onChange:l=>T("notes",l.target.value),placeholder:"Any additional information..."})]})]}),P&&e.jsxs("div",{className:"receipt-thumbnail",children:[e.jsx("img",{src:P,alt:"Receipt"}),e.jsx("span",{children:"Receipt attached"})]}),e.jsxs("div",{className:"review-actions",children:[e.jsxs("button",{className:"btn btn-secondary",onClick:se,children:[e.jsx(pr,{size:18})," Start Over"]}),e.jsxs("button",{className:"btn btn-primary btn-lg",onClick:K,children:[e.jsx(de,{size:18})," Create Expense"]})]})]}),c===C.COMPLETE&&e.jsxs("div",{className:"complete-section",children:[e.jsx("div",{className:"success-icon",children:e.jsx(de,{size:48})}),e.jsx("h3",{children:"Expense Created!"}),e.jsx("p",{children:"Your expense has been saved successfully."}),e.jsxs("div",{className:"complete-actions",children:[e.jsxs("button",{className:"btn btn-primary",onClick:se,children:[e.jsx(be,{size:18})," Scan Another Receipt"]}),n&&e.jsx("button",{className:"btn btn-secondary",onClick:n,children:"Done"})]})]})]})]})}const le=20520,Te=["Travel","Accommodation","Sustenance"],Oe=["Draft","Submitted","Approved","Rejected","Paid"],je={Draft:"Draft",Submitted:"Submitted",Approved:"Validated",Rejected:"Rejected",Paid:"Paid"},Re={resource_id:"",expense_date:new Date().toISOString().split("T")[0],travel_amount:"",travel_reason:"",travel_chargeable:!0,travel_procurement:"supplier",accommodation_amount:"",accommodation_reason:"",accommodation_chargeable:!0,accommodation_procurement:"supplier",sustenance_amount:"",sustenance_reason:"",sustenance_chargeable:!0,sustenance_procurement:"supplier",notes:"",files:[]};function Dr(){const{user:a,role:n}=Pe(),{projectId:s}=Ae(),{showSuccess:t,showError:o,showWarning:p}=ze(),{showTestUsers:f,testUserIds:x}=or(),b=a?.id||null,{canAddExpense:c,canSubmitExpense:k,canValidateExpense:O,canEditExpense:B,canDeleteExpense:P,getAvailableResources:N,hasRole:E}=ir(),[y,X]=m.useState([]),[F,A]=m.useState([]),[Y,L]=m.useState(!0),[G,u]=m.useState(!1),[z,S]=m.useState("form"),[h,M]=m.useState(null),[w,ue]=m.useState({}),[te,V]=m.useState(!1),[d,U]=m.useState(Re),[Q,me]=m.useState("all"),[H,pe]=m.useState("all"),[T,he]=m.useState("all"),[K,se]=m.useState("all"),[Z,l]=m.useState("all"),[g,j]=m.useState({isOpen:!1,expenseId:null,expenseData:null}),[ee,re]=m.useState({isOpen:!1,expense:null,editMode:!1,editData:null}),W=m.useCallback(async()=>{if(s){L(!0);try{const r=await D.getAllFiltered(s,f);X(r);const{data:i}=await I.from("resources").select("id, name, email, user_id, partner_id, partner:partners(id, name)").order("name");let v=i||[];!f&&x?.length>0&&(v=v.filter(R=>!R.user_id||!x.includes(R.user_id))),A(v)}catch{o("Failed to load expenses")}finally{L(!1)}}},[s,f,x,o]);m.useEffect(()=>{W()},[W]);async function Be(){if(!d.resource_id){p("Please select a resource");return}const r=parseFloat(d.travel_amount)>0,i=parseFloat(d.accommodation_amount)>0,v=parseFloat(d.sustenance_amount)>0;if(!r&&!i&&!v){p("Please enter at least one expense amount");return}if(r&&!d.travel_reason){p("Please enter a reason for the travel expense");return}if(i&&!d.accommodation_reason){p("Please enter a reason for the accommodation expense");return}if(v&&!d.sustenance_reason){p("Please enter a reason for the sustenance expense");return}try{const R=F.find(ge=>ge.id===d.resource_id)?.name,_=[];r&&_.push({project_id:s,category:"Travel",resource_id:d.resource_id,resource_name:R,expense_date:d.expense_date,reason:d.travel_reason,amount:parseFloat(d.travel_amount),notes:d.notes,created_by:b,chargeable_to_customer:d.travel_chargeable,procurement_method:d.travel_procurement}),i&&_.push({project_id:s,category:"Accommodation",resource_id:d.resource_id,resource_name:R,expense_date:d.expense_date,reason:d.accommodation_reason,amount:parseFloat(d.accommodation_amount),notes:d.notes,created_by:b,chargeable_to_customer:d.accommodation_chargeable,procurement_method:d.accommodation_procurement}),v&&_.push({project_id:s,category:"Sustenance",resource_id:d.resource_id,resource_name:R,expense_date:d.expense_date,reason:d.sustenance_reason,amount:parseFloat(d.sustenance_amount),notes:d.notes,created_by:b,chargeable_to_customer:d.sustenance_chargeable,procurement_method:d.sustenance_procurement});const oe=await D.createMany(_);if(d.files.length>0&&oe){V(!0);for(const ge of oe)for(const nr of d.files)try{await D.uploadReceipt(ge.id,nr,b)}catch{}V(!1)}await W(),u(!1),U(Re),t("Expenses added successfully!")}catch(R){o("Failed to add expenses: "+R.message)}}async function Le(r){try{const i=await D.create({project_id:s,category:r.category,resource_id:r.resource_id,resource_name:r.resource_name,expense_date:r.expense_date,reason:r.reason,amount:r.amount,notes:r.notes,created_by:b,chargeable_to_customer:r.chargeable_to_customer,procurement_method:r.procurement_method});await W()}catch(i){o("Failed to create expense: "+i.message)}}function Me(r){M(r.id),ue({category:r.category,resource_id:r.resource_id,resource_name:r.resource_name,expense_date:r.expense_date,reason:r.reason,amount:r.amount,notes:r.notes,status:r.status,chargeable_to_customer:r.chargeable_to_customer!==!1,procurement_method:r.procurement_method||"supplier"})}async function Ue(r){try{const i=F.find(v=>v.id===w.resource_id)?.name||w.resource_name;await D.update(r,{category:w.category,resource_id:w.resource_id,resource_name:i,expense_date:w.expense_date,reason:w.reason,amount:parseFloat(w.amount),notes:w.notes,status:w.status,chargeable_to_customer:w.chargeable_to_customer,procurement_method:w.procurement_method}),await W(),M(null),t("Expense updated!")}catch(i){o("Failed to update: "+i.message)}}function We(r){j({isOpen:!0,expenseId:r.id,expenseData:{resourceName:r.resource_name,date:r.expense_date,totalAmount:parseFloat(r.amount||0),category:r.category,chargeable:r.chargeable_to_customer,procurement:r.procurement_method,status:r.status}})}async function $e(){if(g.expenseId)try{await D.delete(g.expenseId,b),await W(),j({isOpen:!1,expenseId:null,expenseData:null}),t("Expense deleted")}catch(r){o("Failed to delete: "+r.message)}}async function Ge(r){if(confirm("Submit this expense for validation?"))try{await D.submit(r),await W(),t("Expense submitted for validation!")}catch(i){o("Failed to submit: "+i.message)}}async function Ve(r){try{await D.approve(r),await W(),t("Expense validated!")}catch(i){o("Failed to validate: "+i.message)}}async function qe(r){const i=prompt("Please provide a reason for rejection (optional):");try{await D.reject(r,i),await W(),p("Expense rejected")}catch(v){o("Failed to reject: "+v.message)}}function Je(r){const i=Array.from(r.target.files);U({...d,files:[...d.files,...i]})}function Ye(r){U({...d,files:d.files.filter((i,v)=>v!==r)})}async function He(r,i){try{const v=await D.downloadReceipt(r),R=URL.createObjectURL(v),_=document.createElement("a");_.href=R,_.download=i,document.body.appendChild(_),_.click(),document.body.removeChild(_),URL.revokeObjectURL(R)}catch{o("Failed to download file")}}function Ce(r){switch(r){case"Travel":return e.jsx(ye,{size:16});case"Accommodation":return e.jsx(ve,{size:16});case"Sustenance":return e.jsx(_e,{size:16});default:return e.jsx(ce,{size:16})}}function Se(r){switch(r){case"Travel":return{bg:"#dbeafe",color:"#2563eb"};case"Accommodation":return{bg:"#f3e8ff",color:"#7c3aed"};case"Sustenance":return{bg:"#ffedd5",color:"#ea580c"};default:return{bg:"#f1f5f9",color:"#64748b"}}}function Xe(r){switch(r){case"Approved":case"Paid":return"status-completed";case"Submitted":return"status-in-progress";case"Rejected":return"status-at-risk";default:return"status-not-started"}}function Qe(){return E(["admin","supplier_pm","customer_pm"])}const Ne=y.filter(r=>!(Q!=="all"&&r.category!==Q||H!=="all"&&r.resource_name!==H||T!=="all"&&r.status!==T||K==="chargeable"&&r.chargeable_to_customer===!1||K==="non-chargeable"&&r.chargeable_to_customer!==!1||Z!=="all"&&(r.procurement_method||"supplier")!==Z)),Ke=y.reduce((r,i)=>r+parseFloat(i.amount||0),0),Ze=y.filter(r=>r.chargeable_to_customer!==!1).reduce((r,i)=>r+parseFloat(i.amount||0),0),er=y.filter(r=>r.chargeable_to_customer===!1).reduce((r,i)=>r+parseFloat(i.amount||0),0),we=y.filter(r=>["Approved","Paid"].includes(r.status)).reduce((r,i)=>r+parseFloat(i.amount||0),0),ke=le-we,rr=y.filter(r=>r.status==="Submitted").length,ar=y.filter(r=>(r.procurement_method||"supplier")==="supplier").reduce((r,i)=>r+parseFloat(i.amount||0),0),tr=y.filter(r=>r.procurement_method==="partner").reduce((r,i)=>r+parseFloat(i.amount||0),0),sr={Travel:y.filter(r=>r.category==="Travel").reduce((r,i)=>r+parseFloat(i.amount||0),0),Accommodation:y.filter(r=>r.category==="Accommodation").reduce((r,i)=>r+parseFloat(i.amount||0),0),Sustenance:y.filter(r=>r.category==="Sustenance").reduce((r,i)=>r+parseFloat(i.amount||0),0)},q={};y.forEach(r=>{q[r.resource_name]||(q[r.resource_name]={total:0,chargeable:0,nonChargeable:0});const i=parseFloat(r.amount||0);q[r.resource_name].total+=i,r.chargeable_to_customer!==!1?q[r.resource_name].chargeable+=i:q[r.resource_name].nonChargeable+=i});const ne=N(F);return Y&&!s?e.jsx(lr,{message:"Loading expenses...",size:"large",fullPage:!0}):e.jsxs("div",{className:"page-container",children:[e.jsx(cr,{icon:ce,title:"Expenses",subtitle:`Track project expenses against Â£${le.toLocaleString()} budget`,children:c&&!G&&e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsxs("button",{className:"btn btn-primary",onClick:()=>{S("form"),u(!0)},children:[e.jsx(hr,{size:18})," Add Expenses"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:()=>{S("scanner"),u(!0)},style:{background:"linear-gradient(135deg, #8b5cf6, #6366f1)",color:"white",border:"none"},title:"Scan a receipt with AI",children:[e.jsx(be,{size:18})," ",e.jsx(ie,{size:14})," Scan Receipt"]})]})}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem"},children:[e.jsx($,{icon:ce,label:"Total Budget",value:`Â£${le.toLocaleString()}`,color:"#3b82f6"}),e.jsx($,{label:"Total Claimed",value:`Â£${Ke.toLocaleString()}`,color:"#3b82f6"}),e.jsx($,{icon:Ie,label:"Chargeable",value:`Â£${Ze.toLocaleString()}`,color:"#10b981"}),e.jsx($,{icon:gr,label:"Non-Chargeable",value:`Â£${er.toLocaleString()}`,color:"#f59e0b"})]}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem",gridTemplateColumns:"repeat(3, 1fr)"},children:[e.jsx($,{label:"Validated/Paid",value:`Â£${we.toLocaleString()}`,color:"#10b981"}),e.jsx($,{label:"Remaining Budget",value:`Â£${ke.toLocaleString()}`,color:ke<le*.2?"#ef4444":"#10b981"}),e.jsx($,{label:"Pending Validation",value:rr,color:"#f59e0b"})]}),E(["admin","supplier_pm"])&&e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem",gridTemplateColumns:"repeat(2, 1fr)"},children:[e.jsx($,{icon:Fe,label:"Supplier Procured",value:`Â£${ar.toLocaleString()}`,subtext:"Paid directly by JT",color:"#6366f1"}),e.jsx($,{icon:Ee,label:"Partner Procured",value:`Â£${tr.toLocaleString()}`,subtext:"Reimbursable to partners",color:"#8b5cf6"})]}),e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Breakdown by Type"}),e.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:"1rem"},children:Te.map(r=>{const i=Se(r),v=y.filter(_=>_.category===r).length,R=y.filter(_=>_.category===r&&_.chargeable_to_customer!==!1).reduce((_,oe)=>_+parseFloat(oe.amount||0),0);return e.jsxs("div",{style:{padding:"1rem",backgroundColor:i.bg,borderRadius:"8px"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",color:i.color,marginBottom:"0.5rem"},children:[Ce(r),e.jsx("span",{style:{fontWeight:"600"},children:r})]}),e.jsxs("div",{style:{fontSize:"1.5rem",fontWeight:"700",color:i.color},children:["Â£",sr[r].toFixed(2)]}),e.jsxs("div",{style:{fontSize:"0.8rem",color:"#64748b"},children:[v," expense(s)"]}),e.jsxs("div",{style:{fontSize:"0.75rem",color:"#10b981",marginTop:"0.25rem"},children:["Â£",R.toFixed(2)," chargeable"]})]},r)})})]}),Object.keys(q).length>0&&e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Breakdown by Resource"}),e.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"1rem"},children:Object.entries(q).map(([r,i])=>e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#f1f5f9",borderRadius:"8px",minWidth:"180px"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"0.5rem"},children:[e.jsx(fr,{size:16,style:{color:"#64748b"}}),e.jsx("span",{style:{fontWeight:"600",fontSize:"0.9rem"},children:r})]}),e.jsxs("div",{style:{fontSize:"1.25rem",fontWeight:"700",color:"#3b82f6"},children:["Â£",i.total.toFixed(2)]}),e.jsxs("div",{style:{fontSize:"0.75rem",color:"#10b981"},children:["Â£",i.chargeable.toFixed(2)," chargeable"]}),i.nonChargeable>0&&e.jsxs("div",{style:{fontSize:"0.75rem",color:"#f59e0b"},children:["Â£",i.nonChargeable.toFixed(2)," non-chargeable"]})]},r))})]}),e.jsx("div",{className:"card",style:{marginBottom:"1.5rem"},children:e.jsxs("div",{style:{display:"flex",gap:"1rem",alignItems:"center",flexWrap:"wrap"},children:[e.jsx("span",{style:{fontWeight:"500"},children:"Filter:"}),e.jsxs("select",{value:Q,onChange:r=>me(r.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"all",children:"All Types"}),Te.map(r=>e.jsx("option",{value:r,children:r},r))]}),e.jsxs("select",{value:H,onChange:r=>pe(r.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"all",children:"All Resources"}),[...new Set(y.map(r=>r.resource_name))].map(r=>e.jsx("option",{value:r,children:r},r))]}),e.jsxs("select",{value:T,onChange:r=>he(r.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"all",children:"All Statuses"}),Oe.map(r=>e.jsx("option",{value:r,children:je[r]||r},r))]}),e.jsxs("select",{value:K,onChange:r=>se(r.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"all",children:"All Expenses"}),e.jsx("option",{value:"chargeable",children:"Chargeable Only"}),e.jsx("option",{value:"non-chargeable",children:"Non-Chargeable Only"})]}),E(["admin","supplier_pm"])&&e.jsxs("select",{value:Z,onChange:r=>l(r.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"all",children:"All Procurement"}),e.jsx("option",{value:"supplier",children:"Supplier Procured"}),e.jsx("option",{value:"partner",children:"Partner Procured"})]})]})}),G&&z==="form"&&e.jsx(wr,{newExpense:d,setNewExpense:U,availableResources:ne,hasRole:E,handleAdd:Be,handleFileSelect:Je,removeFile:Ye,uploadingFiles:te,onCancel:()=>u(!1)}),G&&z==="scanner"&&e.jsx("div",{style:{marginBottom:"1.5rem"},children:e.jsx(Nr,{resources:ne,defaultResourceId:ne.length===1?ne[0].id:null,onExpenseCreated:Le,onCancel:()=>{u(!1),S("form")}})}),e.jsx("div",{className:"card",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Ref"}),e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Resource"}),e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Reason"}),e.jsx("th",{style:{textAlign:"right"},children:"Amount"}),e.jsx("th",{children:"Chargeable"}),E(["admin","supplier_pm"])&&e.jsx("th",{children:"Procured By"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Receipts"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:Ne.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:E(["admin","supplier_pm"])?11:10,style:{textAlign:"center",color:"#64748b",padding:"2rem"},children:"No expenses found."})}):Ne.map(r=>e.jsx(kr,{expense:r,editingId:h,editForm:w,setEditForm:ue,resources:F,hasRole:E,canEditChargeable:Qe,canSubmitExpense:k,canValidateExpense:O,canEditExpense:B,canDeleteExpense:P,getCategoryIcon:Ce,getCategoryColor:Se,getStatusColor:Xe,handleEdit:Me,handleSave:Ue,handleSubmit:Ge,handleApprove:Ve,handleReject:qe,handleDeleteClick:We,downloadFile:He,setEditingId:M,setDetailModal:re},r.id))})]})}),e.jsxs("div",{className:"card",style:{marginTop:"1.5rem",backgroundColor:"#fffbeb",borderLeft:"4px solid #f59e0b"},children:[e.jsx("h4",{style:{marginBottom:"0.5rem",color:"#92400e"},children:"ðŸ“‹ Expense Guidelines"}),e.jsxs("ul",{style:{margin:"0.5rem 0 0 1.5rem",color:"#92400e",fontSize:"0.9rem"},children:[e.jsx("li",{children:"PMO travel/accommodation requires advance approval from Authority Project Manager"}),e.jsx("li",{children:"Attach receipts for all expenses over Â£25"}),e.jsx("li",{children:"Submit expenses within 30 days of incurring them"}),e.jsxs("li",{children:[e.jsx("strong",{children:"Submit:"})," Click the send icon to submit for validation"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Chargeable expenses:"})," Validated by Customer PM"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Non-chargeable expenses:"})," Validated by Supplier PM"]})]})]}),e.jsx(dr,{isOpen:g.isOpen,onClose:()=>j({isOpen:!1,expenseId:null,expenseData:null}),onConfirm:$e,title:"Delete Expense",message:g.expenseData?e.jsxs("div",{children:[e.jsx("p",{children:"Are you sure you want to delete this expense?"}),e.jsxs("div",{style:{backgroundColor:"#fef3c7",border:"1px solid #f59e0b",borderRadius:"6px",padding:"0.75rem",marginTop:"0.75rem"},children:[e.jsx("p",{style:{fontWeight:"600",color:"#92400e",margin:"0 0 0.5rem 0"},children:"Details:"}),e.jsxs("ul",{style:{margin:"0",paddingLeft:"1.25rem",color:"#92400e",fontSize:"0.9rem"},children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Resource:"})," ",g.expenseData.resourceName]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Category:"})," ",g.expenseData.category]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Amount:"})," Â£",g.expenseData.totalAmount?.toFixed(2)]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Status:"})," ",g.expenseData.status]})]})]}),e.jsx("p",{style:{marginTop:"0.75rem",fontSize:"0.85rem",color:"#6b7280"},children:"This expense can be restored from the audit log if needed."})]}):"Are you sure you want to delete this expense?",confirmText:"Delete",cancelText:"Cancel",variant:"danger"})]})}function wr({newExpense:a,setNewExpense:n,availableResources:s,hasRole:t,handleAdd:o,handleFileSelect:p,removeFile:f,uploadingFiles:x,onCancel:b}){return e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem",border:"2px solid var(--primary)"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Add New Expenses"}),e.jsx("p",{style:{color:"#64748b",fontSize:"0.9rem",marginBottom:"1rem"},children:"Enter amounts for any categories that apply. Leave blank to skip a category."}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem",marginBottom:"1.5rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Resource Name *"}),e.jsxs("select",{className:"form-input",value:a.resource_id,onChange:c=>n({...a,resource_id:c.target.value}),children:[e.jsx("option",{value:"",children:"Select Resource"}),s.map(c=>e.jsx("option",{value:c.id,children:c.name},c.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Date *"}),e.jsx("input",{type:"date",className:"form-input",value:a.expense_date,onChange:c=>n({...a,expense_date:c.target.value})})]})]}),e.jsx(fe,{category:"Travel",icon:e.jsx(ye,{size:20}),bgColor:"#dbeafe",textColor:"#2563eb",borderColor:"#93c5fd",amount:a.travel_amount,reason:a.travel_reason,chargeable:a.travel_chargeable,procurement:a.travel_procurement,onAmountChange:c=>n({...a,travel_amount:c}),onReasonChange:c=>n({...a,travel_reason:c}),onChargeableChange:c=>n({...a,travel_chargeable:c}),onProcurementChange:c=>n({...a,travel_procurement:c}),hasRole:t}),e.jsx(fe,{category:"Accommodation",icon:e.jsx(ve,{size:20}),bgColor:"#f3e8ff",textColor:"#7c3aed",borderColor:"#d8b4fe",amount:a.accommodation_amount,reason:a.accommodation_reason,chargeable:a.accommodation_chargeable,procurement:a.accommodation_procurement,onAmountChange:c=>n({...a,accommodation_amount:c}),onReasonChange:c=>n({...a,accommodation_reason:c}),onChargeableChange:c=>n({...a,accommodation_chargeable:c}),onProcurementChange:c=>n({...a,accommodation_procurement:c}),hasRole:t}),e.jsx(fe,{category:"Sustenance",icon:e.jsx(_e,{size:20}),bgColor:"#ffedd5",textColor:"#ea580c",borderColor:"#fdba74",amount:a.sustenance_amount,reason:a.sustenance_reason,chargeable:a.sustenance_chargeable,procurement:a.sustenance_procurement,onAmountChange:c=>n({...a,sustenance_amount:c}),onReasonChange:c=>n({...a,sustenance_reason:c}),onChargeableChange:c=>n({...a,sustenance_chargeable:c}),onProcurementChange:c=>n({...a,sustenance_procurement:c}),hasRole:t}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{className:"form-label",children:"Additional Notes"}),e.jsx("textarea",{className:"form-input",rows:2,placeholder:"Any additional information...",value:a.notes,onChange:c=>n({...a,notes:c.target.value})})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{className:"form-label",children:"Attach Receipts"}),e.jsxs("div",{style:{border:"2px dashed #d1d5db",borderRadius:"8px",padding:"1.5rem",textAlign:"center",cursor:"pointer",backgroundColor:"#f9fafb"},onClick:()=>document.getElementById("file-upload").click(),children:[e.jsx(xe,{size:24,style:{color:"#9ca3af",marginBottom:"0.5rem"}}),e.jsx("div",{style:{color:"#64748b",fontSize:"0.85rem"},children:"Click to upload receipts"}),e.jsx("input",{id:"file-upload",type:"file",multiple:!0,accept:".pdf,.jpg,.jpeg,.png,.zip",style:{display:"none"},onChange:p})]}),a.files.length>0&&e.jsx("div",{style:{marginTop:"0.5rem"},children:a.files.map((c,k)=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.25rem 0",fontSize:"0.85rem"},children:[e.jsx(xr,{size:14}),e.jsx("span",{style:{flex:1},children:c.name}),e.jsx("button",{onClick:()=>f(k),style:{background:"none",border:"none",cursor:"pointer",color:"#ef4444"},children:e.jsx(J,{size:14})})]},k))})]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsxs("button",{className:"btn btn-primary",onClick:o,disabled:x,children:[e.jsx(De,{size:16})," ",x?"Uploading...":"Save Expenses"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:b,children:[e.jsx(J,{size:16})," Cancel"]})]})]})}function fe({category:a,icon:n,bgColor:s,textColor:t,borderColor:o,amount:p,reason:f,chargeable:x,procurement:b,onAmountChange:c,onReasonChange:k,onChargeableChange:O,onProcurementChange:B,hasRole:P}){return e.jsxs("div",{style:{padding:"1rem",backgroundColor:s,borderRadius:"8px",marginBottom:"1rem"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",color:t,marginBottom:"0.75rem"},children:[n,e.jsx("span",{style:{fontWeight:"600",fontSize:"1rem"},children:a})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"150px 1fr",gap:"1rem",marginBottom:"0.75rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Amount (Â£)"}),e.jsx("input",{type:"number",step:"0.01",className:"form-input",placeholder:"0.00",value:p,onChange:N=>c(N.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Reason / Description"}),e.jsx("input",{type:"text",className:"form-input",placeholder:`e.g., ${a} expense description`,value:f,onChange:N=>k(N.target.value)})]})]}),parseFloat(p)>0&&e.jsxs("div",{style:{display:"flex",gap:"1.5rem",flexWrap:"wrap",paddingTop:"0.75rem",borderTop:`1px solid ${o}`},children:[e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"0.5rem",cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:x,onChange:N=>O(N.target.checked),style:{width:"16px",height:"16px",accentColor:t}}),e.jsx("span",{style:{fontSize:"0.85rem",color:t},children:"Chargeable to Customer"})]}),P(["admin","supplier_pm"])&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.85rem",color:t},children:"Paid by:"}),e.jsxs("select",{value:b,onChange:N=>B(N.target.value),style:{padding:"0.25rem 0.5rem",borderRadius:"4px",border:`1px solid ${o}`,fontSize:"0.85rem",backgroundColor:"#fff"},children:[e.jsx("option",{value:"supplier",children:"Supplier (JT)"}),e.jsx("option",{value:"partner",children:"Partner"})]})]})]})]})}function kr({expense:a,editingId:n,editForm:s,setEditForm:t,resources:o,hasRole:p,canEditChargeable:f,canSubmitExpense:x,canValidateExpense:b,canEditExpense:c,canDeleteExpense:k,getCategoryIcon:O,getCategoryColor:B,getStatusColor:P,handleEdit:N,handleSave:E,handleSubmit:y,handleApprove:X,handleReject:F,handleDeleteClick:A,downloadFile:Y,setEditingId:L,setDetailModal:G}){const u=B(a.category),z=a.chargeable_to_customer!==!1,S=n===a.id;return e.jsxs("tr",{style:{backgroundColor:z?"inherit":"#fffbeb",cursor:S?"default":"pointer"},onClick:()=>!S&&G({isOpen:!0,expense:a}),children:[e.jsx("td",{style:{fontFamily:"monospace",fontSize:"0.85rem"},children:a.expense_ref||"-"}),e.jsx("td",{children:S?e.jsxs("select",{className:"form-input",value:s.category,onChange:h=>t({...s,category:h.target.value}),children:[e.jsx("option",{value:"Travel",children:"Travel"}),e.jsx("option",{value:"Accommodation",children:"Accommodation"}),e.jsx("option",{value:"Sustenance",children:"Sustenance"})]}):e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.85rem",backgroundColor:u.bg,color:u.color},children:[O(a.category),a.category]})}),e.jsx("td",{children:S?e.jsxs("select",{className:"form-input",value:s.resource_id||"",onChange:h=>t({...s,resource_id:h.target.value}),children:[e.jsx("option",{value:"",children:"-- Select --"}),o.map(h=>e.jsx("option",{value:h.id,children:h.name},h.id))]}):a.resource_name}),e.jsx("td",{children:S?e.jsx("input",{type:"date",className:"form-input",value:s.expense_date,onChange:h=>t({...s,expense_date:h.target.value})}):new Date(a.expense_date).toLocaleDateString("en-GB")}),e.jsx("td",{style:{maxWidth:"200px"},children:S?e.jsx("input",{type:"text",className:"form-input",value:s.reason,onChange:h=>t({...s,reason:h.target.value})}):e.jsx("div",{style:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:a.reason})}),e.jsx("td",{style:{textAlign:"right",fontWeight:"600"},children:S?e.jsx("input",{type:"number",step:"0.01",className:"form-input",value:s.amount,onChange:h=>t({...s,amount:h.target.value}),style:{width:"100px",textAlign:"right"}}):`Â£${parseFloat(a.amount).toFixed(2)}`}),e.jsx("td",{children:S&&f()?e.jsx("input",{type:"checkbox",checked:s.chargeable_to_customer,onChange:h=>t({...s,chargeable_to_customer:h.target.checked}),style:{width:"18px",height:"18px"}}):e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.75rem",fontWeight:"500",backgroundColor:z?"#dcfce7":"#fef3c7",color:z?"#166534":"#92400e"},children:[z?e.jsx(de,{size:12}):e.jsx(J,{size:12}),z?"Yes":"No"]})}),p(["admin","supplier_pm"])&&e.jsx("td",{children:S?e.jsxs("select",{className:"form-input",value:s.procurement_method||"supplier",onChange:h=>t({...s,procurement_method:h.target.value}),style:{fontSize:"0.85rem",padding:"0.25rem"},children:[e.jsx("option",{value:"supplier",children:"Supplier"}),e.jsx("option",{value:"partner",children:"Partner"})]}):e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.75rem",fontWeight:"500",backgroundColor:(a.procurement_method||"supplier")==="partner"?"#f3e8ff":"#e0e7ff",color:(a.procurement_method||"supplier")==="partner"?"#7c3aed":"#4338ca"},children:[(a.procurement_method||"supplier")==="partner"?e.jsx(Ee,{size:12}):e.jsx(Fe,{size:12}),(a.procurement_method||"supplier")==="partner"?"Partner":"Supplier"]})}),e.jsx("td",{children:S&&b(a)?e.jsx("select",{className:"form-input",value:s.status,onChange:h=>t({...s,status:h.target.value}),children:Oe.map(h=>e.jsx("option",{value:h,children:je[h]||h},h))}):e.jsx("span",{className:`status-badge ${P(a.status)}`,children:je[a.status]||a.status})}),e.jsx("td",{onClick:h=>h.stopPropagation(),children:a.expense_files?.length>0?e.jsx("div",{style:{display:"flex",gap:"0.25rem"},children:a.expense_files.map((h,M)=>e.jsx("button",{onClick:()=>Y(h.file_path,h.file_name),style:{background:"none",border:"none",cursor:"pointer",color:"#3b82f6"},title:h.file_name,children:e.jsx(br,{size:16})},M))}):"-"}),e.jsx("td",{onClick:h=>h.stopPropagation(),children:S?e.jsxs("div",{className:"action-buttons",children:[e.jsx("button",{className:"btn-icon btn-success",onClick:()=>E(a.id),children:e.jsx(De,{size:16})}),e.jsx("button",{className:"btn-icon btn-secondary",onClick:()=>L(null),children:e.jsx(J,{size:16})})]}):e.jsxs("div",{className:"action-buttons",children:[x(a)&&e.jsx("button",{className:"btn-icon",onClick:()=>y(a.id),title:"Submit for Validation",style:{color:"#3b82f6"},children:e.jsx(jr,{size:16})}),b(a)&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn-icon btn-success",onClick:()=>X(a.id),title:"Validate",children:e.jsx(Ie,{size:16})}),e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>F(a.id),title:"Reject",children:e.jsx(J,{size:16})})]}),c(a)&&e.jsx("button",{className:"btn-icon",onClick:()=>N(a),title:"Edit",children:e.jsx(yr,{size:16})}),k(a)&&e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>A(a),title:"Delete",children:e.jsx(vr,{size:16})})]})})]})}export{Dr as default};
