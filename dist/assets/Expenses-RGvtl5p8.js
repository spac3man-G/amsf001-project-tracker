import{s as V,u as qe,a as He,b as Je,j as e,c as pt,e as q,L as ht}from"./index-W5mp41Hd.js";import{r as j}from"./vendor-react-JFEV0ROX.js";import{u as gt}from"./usePermissions-DRVPEetW.js";import{S as Z}from"./StatCard-DiIMvrIF.js";import{P as ft}from"./PageHeader-DRRD03nL.js";import{C as xt}from"./ConfirmDialog-xqx5tMGc.js";import{j as re,a as X,al as be,am as we,an as jt,T as ke,S as ye,ao as bt,L as Le,c as Q,y as ve,a2 as yt,h as We,ap as pe,aq as he,ar as ge,w as vt,U as Xe,F as _t,_ as Te,o as Ae,ad as ze,D as Ze,e as Ke,C as _e,Z as Qe,a0 as St,a1 as Ct,k as Me,Y as Nt}from"./vendor-icons-CMdlt-Xc.js";import"./vendor-supabase-DgEUAXvv.js";const Rt={uber:"Travel",lyft:"Travel",taxi:"Travel",train:"Travel",rail:"Travel",airlines:"Travel",airways:"Travel",petrol:"Travel","gas station":"Travel",fuel:"Travel",parking:"Travel",hotel:"Accommodation",inn:"Accommodation",motel:"Accommodation",airbnb:"Accommodation","booking.com":"Accommodation",marriott:"Accommodation",hilton:"Accommodation","premier inn":"Accommodation",travelodge:"Accommodation",restaurant:"Sustenance",cafe:"Sustenance",coffee:"Sustenance",costa:"Sustenance",starbucks:"Sustenance",pret:"Sustenance",greggs:"Sustenance",mcdonald:"Sustenance",subway:"Sustenance",nando:"Sustenance",pizza:"Sustenance",pub:"Sustenance",bar:"Sustenance",food:"Sustenance",supermarket:"Sustenance",tesco:"Sustenance",sainsbury:"Sustenance","co-op":"Sustenance",waitrose:"Sustenance",aldi:"Sustenance",lidl:"Sustenance"};class wt{constructor(){this.bucketName="receipt-scans"}async uploadImage(r,n){try{if(!["image/jpeg","image/png","image/webp","image/heic"].includes(r.type))throw new Error("Invalid file type. Please upload a JPEG, PNG, or WebP image.");const l=10*1024*1024;if(r.size>l)throw new Error("File too large. Maximum size is 10MB.");const m=Date.now(),x=r.name.split(".").pop(),S=`${n}/${m}.${x}`,{error:_}=await V.storage.from(this.bucketName).upload(S,r);if(_)throw _;const{data:{publicUrl:d}}=V.storage.from(this.bucketName).getPublicUrl(S);return{path:S,url:d}}catch(o){throw o}}async processReceipt(r,n){const o=Date.now();try{const l=await this.callClaudeVision(r);let m=await this.findClassificationRule(n,l.merchant);m||(m=this.classifyFromPatterns(l.merchant),!m&&l.aiSuggestedCategory&&(m={category:l.aiSuggestedCategory,confidence:l.aiConfidence||.6}));const x=Date.now()-o;return{...l,suggestedCategory:m?.category||null,confidence:m?.confidence||0,ruleBasedClassification:!!m?.ruleId,processingTimeMs:x}}catch(l){throw l}}async fetchImageAsBase64(r){try{const o=await(await fetch(r)).blob();return new Promise((l,m)=>{const x=new FileReader;x.onloadend=()=>{const S=x.result.split(",")[1];l({data:S,mediaType:o.type})},x.onerror=m,x.readAsDataURL(o)})}catch(n){throw n}}async callClaudeVision(r){const n=`Analyze this receipt image and extract the following information in JSON format:
{
  "merchant": "Store/vendor name",
  "amount": 0.00,
  "currency": "GBP",
  "date": "YYYY-MM-DD",
  "items": [{"name": "item name", "quantity": 1, "price": 0.00}],
  "paymentMethod": "card/cash/unknown",
  "category": "Travel/Accommodation/Sustenance",
  "confidence": 0.0 to 1.0,
  "rawText": "All visible text from receipt"
}

If any field cannot be determined, use null. For the category, consider:
- Travel: transport, fuel, parking, flights, trains, taxis
- Accommodation: hotels, lodging, rentals
- Sustenance: food, drinks, restaurants, cafes, supermarkets

Be conservative with confidence - only use high values (>0.8) when very certain.`;try{const o=await fetch("/api/scan-receipt",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({image:r,prompt:n})});if(!o.ok)throw new Error("Failed to process receipt with AI");const l=await o.json();return{merchant:l.merchant,amount:l.amount,currency:l.currency||"GBP",date:l.date,items:l.items||[],paymentMethod:l.paymentMethod,aiSuggestedCategory:l.category,aiConfidence:l.confidence,rawText:l.rawText}}catch(o){return{merchant:null,amount:null,currency:"GBP",date:null,items:[],paymentMethod:null,aiSuggestedCategory:null,aiConfidence:0,rawText:null,error:o.message}}}async findClassificationRule(r,n){if(!n)return null;try{const{data:o,error:l}=await V.rpc("find_classification_rule",{p_project_id:r,p_merchant:n});if(l)throw l;return o&&o.length>0?{ruleId:o[0].rule_id,category:o[0].category,subcategory:o[0].subcategory,defaultChargeable:o[0].default_chargeable,defaultProcurement:o[0].default_procurement,confidence:parseFloat(o[0].confidence)}:null}catch{return null}}classifyFromPatterns(r){if(!r)return null;const n=r.toLowerCase();for(const[o,l]of Object.entries(Rt))if(n.includes(o))return{category:l,confidence:.7,source:"pattern"};return null}async learnFromCorrection(r,n,o,l,m=!1){if(!n||!o)return null;try{const{data:x,error:S}=await V.rpc("upsert_classification_rule",{p_project_id:r,p_merchant:n,p_category:o,p_user_id:l,p_was_correction:m});if(S)throw S;return x}catch{return null}}async createScan(r){try{const{data:n,error:o}=await V.from("receipt_scans").insert({project_id:r.projectId,uploaded_by:r.userId,image_url:r.imageUrl,image_path:r.imagePath,raw_ocr_text:r.rawText,extracted_merchant:r.merchant,extracted_amount:r.amount,extracted_date:r.date,extracted_currency:r.currency,extracted_items:r.items,ai_suggested_category:r.suggestedCategory,ai_confidence:r.confidence,status:"completed",processing_time_ms:r.processingTimeMs}).select().single();if(o)throw o;return n}catch(n){throw n}}async updateScanClassification(r,n,o=!1){try{const{data:l,error:m}=await V.from("receipt_scans").update({final_category:n,user_corrected:o}).eq("id",r).select().single();if(m)throw m;return l}catch(l){throw l}}async linkToExpense(r,n){try{const{data:o,error:l}=await V.from("receipt_scans").update({expense_id:n,status:"linked"}).eq("id",r).select().single();if(l)throw l;return o}catch(o){throw o}}async getRecentScans(r,n=10){try{const{data:o,error:l}=await V.from("receipt_scans").select("*").eq("project_id",r).order("created_at",{ascending:!1}).limit(n);if(l)throw l;return o||[]}catch{return[]}}async getUnlinkedScans(r){try{const{data:n,error:o}=await V.from("receipt_scans").select("*").eq("project_id",r).is("expense_id",null).eq("status","completed").order("created_at",{ascending:!1});if(o)throw o;return n||[]}catch{return[]}}async getClassificationRules(r){try{const{data:n,error:o}=await V.from("classification_rules").select("*").eq("project_id",r).order("match_count",{ascending:!1});if(o)throw o;return n||[]}catch{return[]}}async deleteClassificationRule(r){try{const{error:n}=await V.from("classification_rules").delete().eq("id",r);if(n)throw n;return!0}catch{return!1}}}const me=new wt,kt=[{id:"Travel",label:"Travel",icon:pe,color:"#2563eb",bg:"#dbeafe"},{id:"Accommodation",label:"Accommodation",icon:he,color:"#7c3aed",bg:"#f3e8ff"},{id:"Sustenance",label:"Sustenance",icon:ge,color:"#ea580c",bg:"#ffedd5"}],R={PENDING:"pending",PROCESSING:"processing",READY:"ready",SUBMITTED:"submitted",ERROR:"error"},O={UPLOAD:"upload",PROCESSING:"processing",REVIEW:"review"};function Tt({onExpenseCreated:a,onCancel:r,resources:n=[],defaultResourceId:o=null}){const{user:l}=qe(),{projectId:m}=He(),{showSuccess:x,showError:S,showWarning:_,showInfo:d}=Je(),[A,$]=j.useState(O.UPLOAD),[u,f]=j.useState([]),[v,I]=j.useState(0),[w,U]=j.useState({current:0,total:0}),y=j.useRef(null),P=j.useRef(null),C=u[v];u.filter(t=>t.status===R.READY).length;const D=u.filter(t=>t.status===R.SUBMITTED).length;u.filter(t=>t.status===R.PENDING||t.status===R.PROCESSING).length;const z=(t,i=1500,N=.8)=>new Promise((k,g)=>{const T=new FileReader;T.onload=H=>{const B=new Image;B.onload=()=>{let{width:G,height:E}=B;(G>i||E>i)&&(G>E?(E=Math.round(E*i/G),G=i):(G=Math.round(G*i/E),E=i));const K=document.createElement("canvas");K.width=G,K.height=E,K.getContext("2d").drawImage(B,0,0,G,E),K.toBlob(ue=>{ue?k(ue):g(new Error("Failed to compress image"))},"image/jpeg",N)},B.onerror=()=>g(new Error("Failed to load image")),B.src=H.target.result},T.onerror=g,T.readAsDataURL(t)}),h=async t=>{const i=await z(t);return new Promise((N,k)=>{const g=new FileReader;g.onload=()=>{N({data:g.result.split(",")[1],mediaType:"image/jpeg",preview:g.result})},g.onerror=k,g.readAsDataURL(i)})},W=(t,i)=>({id:`receipt-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,file:t,preview:i,status:R.PENDING,scanResult:null,scanId:null,imageUrl:null,formData:{merchant:"",amount:"",date:new Date().toISOString().split("T")[0],category:"",resource_id:o||"",reason:"",chargeable:!0,procurement:"supplier",notes:""},wasEdited:!1}),p=j.useCallback(async t=>{const i=Array.from(t.target.files||[]);if(i.length===0)return;const N=["image/jpeg","image/png","image/webp","image/heic"],k=[];for(const T of i){if(!N.includes(T.type)){_(`Skipped ${T.name} - invalid file type`);continue}if(T.size>10*1024*1024){_(`Skipped ${T.name} - file too large (max 10MB)`);continue}k.push(T)}if(k.length===0)return;const g=await Promise.all(k.map(async T=>{const{preview:H}=await h(T);return W(T,H)}));f(T=>[...T,...g]),d(`Added ${g.length} receipt${g.length>1?"s":""}`)},[_,d,o]),se=j.useCallback(t=>{t.preventDefault();const i=t.dataTransfer.files;i.length>0&&p({target:{files:i}})},[p]),ae=j.useCallback(t=>{t.preventDefault()},[]),L=j.useCallback(t=>{f(i=>{const N=i.filter(k=>k.id!==t);return v>=N.length&&N.length>0&&I(N.length-1),N})},[v]),ne=j.useCallback(()=>{f([]),I(0),$(O.UPLOAD),y.current&&(y.current.value="")},[]),Se=j.useCallback(async()=>{if(u.length===0||!m||!l?.id){S("No receipts to process");return}$(O.PROCESSING),U({current:0,total:u.length});const t=[...u];for(let g=0;g<t.length;g++){const T=t[g];if(T.status===R.READY||T.status===R.SUBMITTED){U({current:g+1,total:u.length});continue}t[g]={...T,status:R.PROCESSING},f([...t]);try{const H=await h(T.file),{path:B,url:G}=await me.uploadImage(T.file,l.id),E=await me.processReceipt(H,m),K=await me.createScan({projectId:m,userId:l.id,imageUrl:G,imagePath:B,...E});t[g]={...t[g],status:R.READY,scanResult:E,scanId:K.id,imageUrl:G,formData:{...t[g].formData,merchant:E.merchant||"",amount:E.amount?.toString()||"",date:E.date||new Date().toISOString().split("T")[0],category:E.suggestedCategory||"",reason:E.merchant?`Receipt from ${E.merchant}`:""}}}catch(H){t[g]={...t[g],status:R.ERROR,error:H.message}}f([...t]),U({current:g+1,total:u.length})}$(O.REVIEW);const i=t.findIndex(g=>g.status===R.READY);i>=0&&I(i);const N=t.filter(g=>g.status===R.READY).length,k=t.filter(g=>g.status===R.ERROR).length;k>0?_(`Processed ${N} receipts, ${k} failed`):x(`Successfully scanned ${N} receipt${N>1?"s":""}!`)},[u,m,l,S,x,_]),M=j.useCallback((t,i)=>{f(N=>{const k=[...N];return k[v]={...k[v],formData:{...k[v].formData,[t]:i},wasEdited:!0},k})},[v]),b=j.useCallback(t=>{M("category",t)},[M]),ee=j.useCallback(t=>{t>=0&&t<u.length&&I(t)},[u.length]),oe=j.useCallback(()=>{for(let t=v-1;t>=0;t--)if(u[t].status===R.READY){I(t);return}},[v,u]),fe=j.useCallback(()=>{for(let t=v+1;t<u.length;t++)if(u[t].status===R.READY){I(t);return}},[v,u]),le=u.slice(0,v).some(t=>t.status===R.READY),ie=u.slice(v+1).some(t=>t.status===R.READY),ce=j.useCallback(async()=>{const t=C;if(!t||t.status!==R.READY)return;const{formData:i}=t;if(!i.resource_id){_("Please select a resource");return}if(!i.amount||parseFloat(i.amount)<=0){_("Please enter a valid amount");return}if(!i.category){_("Please select a category");return}if(!i.reason){_("Please enter a reason/description");return}try{if(i.merchant&&i.category){const g=t.wasEdited&&t.scanResult?.suggestedCategory!==i.category;await me.learnFromCorrection(m,i.merchant,i.category,l.id,g)}t.scanId&&await me.updateScanClassification(t.scanId,i.category,t.wasEdited);const N={category:i.category,resource_id:i.resource_id,resource_name:n.find(g=>g.id===i.resource_id)?.name,expense_date:i.date,reason:i.reason,amount:parseFloat(i.amount),notes:i.notes,chargeable_to_customer:i.chargeable,procurement_method:i.procurement,receipt_scan_id:t.scanId,receipt_image_url:t.imageUrl};f(g=>{const T=[...g];return T[v]={...T[v],status:R.SUBMITTED},T}),a&&a(N),x(`Expense created: ${i.merchant||"Receipt"} - Â£${i.amount}`);const k=u.findIndex((g,T)=>T>v&&g.status===R.READY);k>=0&&I(k)}catch(N){S("Failed to create expense: "+N.message)}},[C,v,u,m,l,n,a,x,S,_]),Ce=t=>{if(!t)return null;let i,N;return t>=.8?(i="#10b981",N="High"):t>=.5?(i="#f59e0b",N="Medium"):(i="#ef4444",N="Low"),e.jsxs("div",{className:"confidence-badge",style:{color:i,borderColor:i},children:[e.jsx(ye,{size:14}),N," confidence (",Math.round(t*100),"%)"]})},de=t=>{switch(t){case R.PENDING:return e.jsx("div",{className:"status-dot pending"});case R.PROCESSING:return e.jsx(Le,{size:14,className:"spinner"});case R.READY:return e.jsx("div",{className:"status-dot ready"});case R.SUBMITTED:return e.jsx(Q,{size:14,className:"status-check"});case R.ERROR:return e.jsx(ve,{size:14,className:"status-error"});default:return null}};return e.jsxs("div",{className:"receipt-scanner batch-mode",children:[e.jsxs("div",{className:"scanner-header",children:[e.jsxs("div",{className:"scanner-title",children:[e.jsx(re,{size:24}),e.jsxs("div",{children:[e.jsx("h3",{children:"Smart Receipt Scanner"}),e.jsxs("p",{children:[A===O.UPLOAD&&"Upload one or more receipt photos",A===O.PROCESSING&&`Processing ${w.current} of ${w.total}...`,A===O.REVIEW&&`Reviewing ${v+1} of ${u.length} receipts`]})]})]}),r&&e.jsx("button",{className:"btn btn-ghost",onClick:r,children:e.jsx(X,{size:20})})]}),e.jsxs("div",{className:"scanner-steps",children:[e.jsxs("div",{className:`step ${A===O.UPLOAD?"active":A!==O.UPLOAD?"complete":""}`,children:[e.jsx("div",{className:"step-dot",children:"1"}),e.jsx("span",{children:"Upload"})]}),e.jsx("div",{className:"step-line"}),e.jsxs("div",{className:`step ${A===O.PROCESSING?"active":A===O.REVIEW?"complete":""}`,children:[e.jsx("div",{className:"step-dot",children:"2"}),e.jsx("span",{children:"Scan All"})]}),e.jsx("div",{className:"step-line"}),e.jsxs("div",{className:`step ${A===O.REVIEW?"active":""}`,children:[e.jsx("div",{className:"step-dot",children:"3"}),e.jsx("span",{children:"Review"})]})]}),e.jsxs("div",{className:"scanner-content",children:[A===O.UPLOAD&&e.jsxs("div",{className:"upload-section",children:[e.jsxs("div",{className:"drop-zone",onDrop:se,onDragOver:ae,onClick:()=>y.current?.click(),children:[e.jsx(be,{size:48,className:"drop-icon"}),e.jsx("p",{className:"drop-text",children:"Drag & drop receipt images"}),e.jsx("p",{className:"drop-subtext",children:"or click to browse (select multiple)"}),e.jsxs("div",{className:"upload-buttons",children:[e.jsxs("button",{className:"btn btn-primary",onClick:t=>{t.stopPropagation(),y.current?.click()},children:[e.jsx(be,{size:18})," Choose Files"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:t=>{t.stopPropagation(),P.current?.click()},children:[e.jsx(we,{size:18})," Take Photo"]})]}),e.jsx("input",{ref:y,type:"file",accept:"image/jpeg,image/png,image/webp,image/heic",multiple:!0,onChange:p,style:{display:"none"}}),e.jsx("input",{ref:P,type:"file",accept:"image/*",capture:"environment",onChange:p,style:{display:"none"}})]}),u.length>0&&e.jsxs("div",{className:"receipt-queue",children:[e.jsxs("div",{className:"queue-header",children:[e.jsxs("h4",{children:[e.jsx(jt,{size:18})," ",u.length," Receipt",u.length>1?"s":""," Ready"]}),e.jsxs("button",{className:"btn btn-ghost btn-sm",onClick:ne,children:[e.jsx(ke,{size:16})," Clear All"]})]}),e.jsxs("div",{className:"queue-grid",children:[u.map((t,i)=>e.jsxs("div",{className:"queue-item",children:[e.jsx("img",{src:t.preview,alt:`Receipt ${i+1}`}),e.jsx("button",{className:"remove-btn",onClick:N=>{N.stopPropagation(),L(t.id)},children:e.jsx(X,{size:14})}),e.jsx("span",{className:"queue-number",children:i+1})]},t.id)),e.jsxs("div",{className:"queue-item add-more",onClick:()=>y.current?.click(),children:[e.jsx(be,{size:24}),e.jsx("span",{children:"Add More"})]})]}),e.jsxs("button",{className:"btn btn-primary btn-lg scan-all-btn",onClick:Se,children:[e.jsx(ye,{size:20})," Scan All ",u.length," Receipt",u.length>1?"s":""]})]}),e.jsxs("div",{className:"scanner-tips",children:[e.jsxs("h4",{children:[e.jsx(bt,{size:16})," Tips for best results"]}),e.jsxs("ul",{children:[e.jsx("li",{children:"Ensure receipts are flat and well-lit"}),e.jsx("li",{children:"Include the full receipt in frame"}),e.jsx("li",{children:"Avoid shadows and glare"}),e.jsx("li",{children:"You can select multiple files at once"})]})]})]}),A===O.PROCESSING&&e.jsxs("div",{className:"processing-section batch-processing",children:[e.jsxs("div",{className:"processing-progress",children:[e.jsx("div",{className:"progress-bar",children:e.jsx("div",{className:"progress-fill",style:{width:`${w.current/w.total*100}%`}})}),e.jsxs("span",{className:"progress-text",children:["Processing receipt ",w.current," of ",w.total]})]}),e.jsx("div",{className:"processing-grid",children:u.map((t,i)=>e.jsxs("div",{className:`processing-item ${t.status}`,children:[e.jsx("img",{src:t.preview,alt:`Receipt ${i+1}`}),e.jsxs("div",{className:"processing-overlay",children:[t.status===R.PROCESSING&&e.jsx(Le,{size:24,className:"spinner"}),t.status===R.READY&&e.jsx(Q,{size:24,className:"success-icon"}),t.status===R.ERROR&&e.jsx(ve,{size:24,className:"error-icon"})]}),e.jsx("span",{className:"item-number",children:i+1})]},t.id))})]}),A===O.REVIEW&&C&&e.jsxs("div",{className:"review-section batch-review",children:[e.jsxs("div",{className:"receipt-sidebar",children:[e.jsxs("div",{className:"sidebar-header",children:[e.jsx("h4",{children:"Receipts"}),e.jsxs("span",{className:"sidebar-count",children:[D,"/",u.length," submitted"]})]}),e.jsx("div",{className:"sidebar-list",children:u.map((t,i)=>e.jsxs("div",{className:`sidebar-item ${i===v?"active":""} ${t.status}`,onClick:()=>t.status===R.READY&&ee(i),children:[e.jsx("img",{src:t.preview,alt:`Receipt ${i+1}`}),e.jsxs("div",{className:"sidebar-item-info",children:[e.jsx("span",{className:"item-merchant",children:t.formData.merchant||`Receipt ${i+1}`}),e.jsx("span",{className:"item-amount",children:t.formData.amount?`Â£${t.formData.amount}`:"â€”"})]}),e.jsx("div",{className:"sidebar-item-status",children:de(t.status)})]},t.id))})]}),e.jsx("div",{className:"review-main",children:C.status===R.READY?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"review-header",children:[e.jsxs("button",{className:"btn btn-ghost",onClick:oe,disabled:!le,children:[e.jsx(yt,{size:20})," Previous"]}),e.jsxs("div",{className:"review-position",children:["Receipt ",v+1," of ",u.length]}),e.jsxs("button",{className:"btn btn-ghost",onClick:fe,disabled:!ie,children:["Next ",e.jsx(We,{size:20})]})]}),e.jsxs("div",{className:"extraction-summary",children:[e.jsxs("div",{className:"summary-header",children:[e.jsx("h4",{children:"Extracted Information"}),Ce(C.scanResult?.confidence)]}),C.scanResult?.ruleBasedClassification&&e.jsxs("div",{className:"rule-notice",children:[e.jsx(ye,{size:14}),"Category auto-selected based on previous receipts"]})]}),e.jsxs("div",{className:"review-form",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Resource *"}),e.jsxs("select",{className:"form-input",value:C.formData.resource_id,onChange:t=>M("resource_id",t.target.value),children:[e.jsx("option",{value:"",children:"Select resource..."}),n.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Category *"}),e.jsx("div",{className:"category-selector",children:kt.map(t=>{const i=t.icon,N=C.formData.category===t.id;return e.jsxs("button",{type:"button",className:`category-btn ${N?"selected":""}`,style:{"--cat-color":t.color,"--cat-bg":t.bg},onClick:()=>b(t.id),children:[e.jsx(i,{size:20}),t.label,N&&e.jsx(Q,{size:16,className:"check-icon"})]},t.id)})})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Merchant"}),e.jsx("input",{type:"text",className:"form-input",value:C.formData.merchant,onChange:t=>M("merchant",t.target.value),placeholder:"Store/vendor name"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Amount (Â£) *"}),e.jsx("input",{type:"number",step:"0.01",className:"form-input",value:C.formData.amount,onChange:t=>M("amount",t.target.value),placeholder:"0.00"})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Date *"}),e.jsx("input",{type:"date",className:"form-input",value:C.formData.date,onChange:t=>M("date",t.target.value)})]}),e.jsxs("div",{className:"form-group",style:{flex:2},children:[e.jsx("label",{className:"form-label",children:"Reason/Description *"}),e.jsx("input",{type:"text",className:"form-input",value:C.formData.reason,onChange:t=>M("reason",t.target.value),placeholder:"Brief description of expense"})]})]}),e.jsxs("div",{className:"form-row options-row",children:[e.jsxs("label",{className:"checkbox-label",children:[e.jsx("input",{type:"checkbox",checked:C.formData.chargeable,onChange:t=>M("chargeable",t.target.checked)}),e.jsx("span",{children:"Chargeable to Customer"})]}),e.jsxs("div",{className:"procurement-toggle",children:[e.jsx("span",{children:"Paid by:"}),e.jsxs("select",{className:"form-input-sm",value:C.formData.procurement,onChange:t=>M("procurement",t.target.value),children:[e.jsx("option",{value:"supplier",children:"Supplier (JT)"}),e.jsx("option",{value:"partner",children:"Partner"})]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Additional Notes"}),e.jsx("textarea",{className:"form-input",rows:2,value:C.formData.notes,onChange:t=>M("notes",t.target.value),placeholder:"Any additional information..."})]})]}),e.jsxs("div",{className:"receipt-thumbnail",children:[e.jsx("img",{src:C.preview,alt:"Receipt"}),e.jsx("span",{children:"Receipt attached"})]}),e.jsxs("div",{className:"review-actions",children:[e.jsxs("button",{className:"btn btn-secondary",onClick:()=>$(O.UPLOAD),children:[e.jsx(vt,{size:18})," Back to Upload"]}),e.jsxs("button",{className:"btn btn-primary btn-lg",onClick:ce,children:[e.jsx(Q,{size:18})," Submit Expense",ie&&" & Next"]})]})]}):C.status===R.SUBMITTED?e.jsxs("div",{className:"submitted-message",children:[e.jsx("div",{className:"success-icon-large",children:e.jsx(Q,{size:48})}),e.jsx("h3",{children:"Expense Submitted"}),e.jsxs("p",{children:[C.formData.merchant," - Â£",C.formData.amount]}),ie&&e.jsxs("button",{className:"btn btn-primary",onClick:fe,children:["Review Next Receipt ",e.jsx(We,{size:18})]})]}):C.status===R.ERROR?e.jsxs("div",{className:"error-message",children:[e.jsx(ve,{size:48,className:"error-icon"}),e.jsx("h3",{children:"Processing Failed"}),e.jsx("p",{children:C.error||"Unable to process this receipt"})]}):null})]}),A===O.REVIEW&&D===u.length&&u.length>0&&e.jsxs("div",{className:"complete-section",children:[e.jsx("div",{className:"success-icon",children:e.jsx(Q,{size:48})}),e.jsx("h3",{children:"All Receipts Submitted!"}),e.jsxs("p",{children:[D," expense",D>1?"s":""," created successfully."]}),e.jsxs("div",{className:"complete-actions",children:[e.jsxs("button",{className:"btn btn-primary",onClick:ne,children:[e.jsx(we,{size:18})," Scan More Receipts"]}),r&&e.jsx("button",{className:"btn btn-secondary",onClick:r,children:"Done"})]})]})]})]})}const At=["Travel","Accommodation","Sustenance"],zt=["Draft","Submitted","Approved","Rejected","Paid"],It={Draft:"Draft",Submitted:"Submitted",Approved:"Validated",Rejected:"Rejected",Paid:"Paid"};function Pt({filterCategory:a,setFilterCategory:r,filterResource:n,setFilterResource:o,filterStatus:l,setFilterStatus:m,filterChargeable:x,setFilterChargeable:S,filterProcurement:_,setFilterProcurement:d,resourceNames:A,hasRole:$}){const u={padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"};return e.jsx("div",{className:"card",style:{marginBottom:"1.5rem"},children:e.jsxs("div",{style:{display:"flex",gap:"1rem",alignItems:"center",flexWrap:"wrap"},children:[e.jsx("span",{style:{fontWeight:"500"},children:"Filter:"}),e.jsxs("select",{value:a,onChange:f=>r(f.target.value),style:u,children:[e.jsx("option",{value:"all",children:"All Types"}),At.map(f=>e.jsx("option",{value:f,children:f},f))]}),e.jsxs("select",{value:n,onChange:f=>o(f.target.value),style:u,children:[e.jsx("option",{value:"all",children:"All Resources"}),A.map(f=>e.jsx("option",{value:f,children:f},f))]}),e.jsxs("select",{value:l,onChange:f=>m(f.target.value),style:u,children:[e.jsx("option",{value:"all",children:"All Statuses"}),zt.map(f=>e.jsx("option",{value:f,children:It[f]||f},f))]}),e.jsxs("select",{value:x,onChange:f=>S(f.target.value),style:u,children:[e.jsx("option",{value:"all",children:"All Expenses"}),e.jsx("option",{value:"chargeable",children:"Chargeable Only"}),e.jsx("option",{value:"non-chargeable",children:"Non-Chargeable Only"})]}),$(["admin","supplier_pm"])&&e.jsxs("select",{value:_,onChange:f=>d(f.target.value),style:u,children:[e.jsx("option",{value:"all",children:"All Procurement"}),e.jsx("option",{value:"supplier",children:"Supplier Procured"}),e.jsx("option",{value:"partner",children:"Partner Procured"})]})]})})}const Dt=["Travel","Accommodation","Sustenance"];function Et(a){switch(a){case"Travel":return e.jsx(pe,{size:16});case"Accommodation":return e.jsx(he,{size:16});case"Sustenance":return e.jsx(ge,{size:16});default:return e.jsx(re,{size:16})}}function Bt(a){switch(a){case"Travel":return{bg:"#dbeafe",color:"#2563eb"};case"Accommodation":return{bg:"#f3e8ff",color:"#7c3aed"};case"Sustenance":return{bg:"#ffedd5",color:"#ea580c"};default:return{bg:"#f1f5f9",color:"#64748b"}}}function Ft({expenses:a,categoryTotals:r}){return e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Breakdown by Type"}),e.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:"1rem"},children:Dt.map(n=>{const o=Bt(n),l=a.filter(x=>x.category===n).length,m=a.filter(x=>x.category===n&&x.chargeable_to_customer!==!1).reduce((x,S)=>x+parseFloat(S.amount||0),0);return e.jsxs("div",{style:{padding:"1rem",backgroundColor:o.bg,borderRadius:"8px"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",color:o.color,marginBottom:"0.5rem"},children:[Et(n),e.jsx("span",{style:{fontWeight:"600"},children:n})]}),e.jsxs("div",{style:{fontSize:"1.5rem",fontWeight:"700",color:o.color},children:["Â£",r[n].toFixed(2)]}),e.jsxs("div",{style:{fontSize:"0.8rem",color:"#64748b"},children:[l," expense(s)"]}),e.jsxs("div",{style:{fontSize:"0.75rem",color:"#10b981",marginTop:"0.25rem"},children:["Â£",m.toFixed(2)," chargeable"]})]},n)})})]})}function $t({resourceTotals:a}){return Object.keys(a).length===0?null:e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Breakdown by Resource"}),e.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"1rem"},children:Object.entries(a).map(([r,n])=>e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#f1f5f9",borderRadius:"8px",minWidth:"180px"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"0.5rem"},children:[e.jsx(Xe,{size:16,style:{color:"#64748b"}}),e.jsx("span",{style:{fontWeight:"600",fontSize:"0.9rem"},children:r})]}),e.jsxs("div",{style:{fontSize:"1.25rem",fontWeight:"700",color:"#3b82f6"},children:["Â£",n.total.toFixed(2)]}),e.jsxs("div",{style:{fontSize:"0.75rem",color:"#10b981"},children:["Â£",n.chargeable.toFixed(2)," chargeable"]}),n.nonChargeable>0&&e.jsxs("div",{style:{fontSize:"0.75rem",color:"#f59e0b"},children:["Â£",n.nonChargeable.toFixed(2)," non-chargeable"]})]},r))})]})}function Ot(){return e.jsxs("div",{className:"card",style:{marginTop:"1.5rem",backgroundColor:"#fffbeb",borderLeft:"4px solid #f59e0b"},children:[e.jsx("h4",{style:{marginBottom:"0.5rem",color:"#92400e"},children:"ðŸ“‹ Expense Guidelines"}),e.jsxs("ul",{style:{margin:"0.5rem 0 0 1.5rem",color:"#92400e",fontSize:"0.9rem"},children:[e.jsx("li",{children:"PMO travel/accommodation requires advance approval from Authority Project Manager"}),e.jsx("li",{children:"Attach receipts for all expenses over Â£25"}),e.jsx("li",{children:"Submit expenses within 30 days of incurring them"}),e.jsxs("li",{children:[e.jsx("strong",{children:"Submit:"})," Click the send icon to submit for validation"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Chargeable expenses:"})," Validated by Customer PM"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Non-chargeable expenses:"})," Validated by Supplier PM"]})]})]})}function Re({category:a,icon:r,bgColor:n,textColor:o,borderColor:l,amount:m,reason:x,chargeable:S,procurement:_,onAmountChange:d,onReasonChange:A,onChargeableChange:$,onProcurementChange:u,hasRole:f}){return e.jsxs("div",{style:{padding:"1rem",backgroundColor:n,borderRadius:"8px",marginBottom:"1rem"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",color:o,marginBottom:"0.75rem"},children:[r,e.jsx("span",{style:{fontWeight:"600",fontSize:"1rem"},children:a})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"150px 1fr",gap:"1rem",marginBottom:"0.75rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Amount (Â£)"}),e.jsx("input",{type:"number",step:"0.01",className:"form-input",placeholder:"0.00",value:m,onChange:v=>d(v.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Reason / Description"}),e.jsx("input",{type:"text",className:"form-input",placeholder:`e.g., ${a} expense description`,value:x,onChange:v=>A(v.target.value)})]})]}),parseFloat(m)>0&&e.jsxs("div",{style:{display:"flex",gap:"1.5rem",flexWrap:"wrap",paddingTop:"0.75rem",borderTop:`1px solid ${l}`},children:[e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"0.5rem",cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:S,onChange:v=>$(v.target.checked),style:{width:"16px",height:"16px",accentColor:o}}),e.jsx("span",{style:{fontSize:"0.85rem",color:o},children:"Chargeable to Customer"})]}),f(["admin","supplier_pm"])&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.85rem",color:o},children:"Paid by:"}),e.jsxs("select",{value:_,onChange:v=>u(v.target.value),style:{padding:"0.25rem 0.5rem",borderRadius:"4px",border:`1px solid ${l}`,fontSize:"0.85rem",backgroundColor:"#fff"},children:[e.jsx("option",{value:"supplier",children:"Supplier (JT)"}),e.jsx("option",{value:"partner",children:"Partner"})]})]})]})]})}function Ut({newExpense:a,setNewExpense:r,availableResources:n,hasRole:o,handleAdd:l,handleFileSelect:m,removeFile:x,uploadingFiles:S,onCancel:_}){return e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem",border:"2px solid var(--primary)"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Add New Expenses"}),e.jsx("p",{style:{color:"#64748b",fontSize:"0.9rem",marginBottom:"1rem"},children:"Enter amounts for any categories that apply. Leave blank to skip a category."}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem",marginBottom:"1.5rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Resource Name *"}),e.jsxs("select",{className:"form-input",value:a.resource_id,onChange:d=>r({...a,resource_id:d.target.value}),children:[e.jsx("option",{value:"",children:"Select Resource"}),n.map(d=>e.jsx("option",{value:d.id,children:d.name},d.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Date *"}),e.jsx("input",{type:"date",className:"form-input",value:a.expense_date,onChange:d=>r({...a,expense_date:d.target.value})})]})]}),e.jsx(Re,{category:"Travel",icon:e.jsx(pe,{size:20}),bgColor:"#dbeafe",textColor:"#2563eb",borderColor:"#93c5fd",amount:a.travel_amount,reason:a.travel_reason,chargeable:a.travel_chargeable,procurement:a.travel_procurement,onAmountChange:d=>r({...a,travel_amount:d}),onReasonChange:d=>r({...a,travel_reason:d}),onChargeableChange:d=>r({...a,travel_chargeable:d}),onProcurementChange:d=>r({...a,travel_procurement:d}),hasRole:o}),e.jsx(Re,{category:"Accommodation",icon:e.jsx(he,{size:20}),bgColor:"#f3e8ff",textColor:"#7c3aed",borderColor:"#d8b4fe",amount:a.accommodation_amount,reason:a.accommodation_reason,chargeable:a.accommodation_chargeable,procurement:a.accommodation_procurement,onAmountChange:d=>r({...a,accommodation_amount:d}),onReasonChange:d=>r({...a,accommodation_reason:d}),onChargeableChange:d=>r({...a,accommodation_chargeable:d}),onProcurementChange:d=>r({...a,accommodation_procurement:d}),hasRole:o}),e.jsx(Re,{category:"Sustenance",icon:e.jsx(ge,{size:20}),bgColor:"#ffedd5",textColor:"#ea580c",borderColor:"#fdba74",amount:a.sustenance_amount,reason:a.sustenance_reason,chargeable:a.sustenance_chargeable,procurement:a.sustenance_procurement,onAmountChange:d=>r({...a,sustenance_amount:d}),onReasonChange:d=>r({...a,sustenance_reason:d}),onChargeableChange:d=>r({...a,sustenance_chargeable:d}),onProcurementChange:d=>r({...a,sustenance_procurement:d}),hasRole:o}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{className:"form-label",children:"Additional Notes"}),e.jsx("textarea",{className:"form-input",rows:2,placeholder:"Any additional information...",value:a.notes,onChange:d=>r({...a,notes:d.target.value})})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{className:"form-label",children:"Attach Receipts"}),e.jsxs("div",{style:{border:"2px dashed #d1d5db",borderRadius:"8px",padding:"1.5rem",textAlign:"center",cursor:"pointer",backgroundColor:"#f9fafb"},onClick:()=>document.getElementById("file-upload").click(),children:[e.jsx(be,{size:24,style:{color:"#9ca3af",marginBottom:"0.5rem"}}),e.jsx("div",{style:{color:"#64748b",fontSize:"0.85rem"},children:"Click to upload receipts"}),e.jsx("input",{id:"file-upload",type:"file",multiple:!0,accept:".pdf,.jpg,.jpeg,.png,.zip",style:{display:"none"},onChange:m})]}),a.files.length>0&&e.jsx("div",{style:{marginTop:"0.5rem"},children:a.files.map((d,A)=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.25rem 0",fontSize:"0.85rem"},children:[e.jsx(_t,{size:14}),e.jsx("span",{style:{flex:1},children:d.name}),e.jsx("button",{onClick:()=>x(A),style:{background:"none",border:"none",cursor:"pointer",color:"#ef4444"},children:e.jsx(X,{size:14})})]},A))})]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsxs("button",{className:"btn btn-primary",onClick:l,disabled:S,children:[e.jsx(Te,{size:16})," ",S?"Uploading...":"Save Expenses"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:_,children:[e.jsx(X,{size:16})," Cancel"]})]})]})}const Lt=["Draft","Submitted","Approved","Rejected","Paid"],Ge={Draft:"Draft",Submitted:"Submitted",Approved:"Validated",Rejected:"Rejected",Paid:"Paid"};function Wt(a){switch(a){case"Travel":return e.jsx(pe,{size:16});case"Accommodation":return e.jsx(he,{size:16});case"Sustenance":return e.jsx(ge,{size:16});default:return e.jsx(re,{size:16})}}function Mt(a){switch(a){case"Travel":return{bg:"#dbeafe",color:"#2563eb"};case"Accommodation":return{bg:"#f3e8ff",color:"#7c3aed"};case"Sustenance":return{bg:"#ffedd5",color:"#ea580c"};default:return{bg:"#f1f5f9",color:"#64748b"}}}function Gt(a){switch(a){case"Approved":case"Paid":return"status-completed";case"Submitted":return"status-in-progress";case"Rejected":return"status-at-risk";default:return"status-not-started"}}function Yt({expense:a,editingId:r,editForm:n,setEditForm:o,resources:l,hasRole:m,canEditChargeable:x,canSubmitExpense:S,canValidateExpense:_,canEditExpense:d,canDeleteExpense:A,handleEdit:$,handleSave:u,handleSubmit:f,handleValidate:v,handleReject:I,handleDeleteClick:w,downloadFile:U,setEditingId:y,setDetailModal:P}){const C=Mt(a.category),D=a.chargeable_to_customer!==!1,z=r===a.id;return e.jsxs("tr",{style:{backgroundColor:D?"inherit":"#fffbeb",cursor:z?"default":"pointer"},onClick:()=>!z&&P({isOpen:!0,expense:a}),children:[e.jsx("td",{style:{fontFamily:"monospace",fontSize:"0.85rem"},children:a.expense_ref||"-"}),e.jsx("td",{children:z?e.jsxs("select",{className:"form-input",value:n.category,onChange:h=>o({...n,category:h.target.value}),children:[e.jsx("option",{value:"Travel",children:"Travel"}),e.jsx("option",{value:"Accommodation",children:"Accommodation"}),e.jsx("option",{value:"Sustenance",children:"Sustenance"})]}):e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.85rem",backgroundColor:C.bg,color:C.color},children:[Wt(a.category),a.category]})}),e.jsx("td",{children:z?e.jsxs("select",{className:"form-input",value:n.resource_id||"",onChange:h=>o({...n,resource_id:h.target.value}),children:[e.jsx("option",{value:"",children:"-- Select --"}),l.map(h=>e.jsx("option",{value:h.id,children:h.name},h.id))]}):a.resource_name}),e.jsx("td",{children:z?e.jsx("input",{type:"date",className:"form-input",value:n.expense_date,onChange:h=>o({...n,expense_date:h.target.value})}):new Date(a.expense_date).toLocaleDateString("en-GB")}),e.jsx("td",{style:{maxWidth:"200px"},children:z?e.jsx("input",{type:"text",className:"form-input",value:n.reason,onChange:h=>o({...n,reason:h.target.value})}):e.jsx("div",{style:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:a.reason})}),e.jsx("td",{style:{textAlign:"right",fontWeight:"600"},children:z?e.jsx("input",{type:"number",step:"0.01",className:"form-input",value:n.amount,onChange:h=>o({...n,amount:h.target.value}),style:{width:"100px",textAlign:"right"}}):`Â£${parseFloat(a.amount).toFixed(2)}`}),e.jsx("td",{children:z&&x()?e.jsx("input",{type:"checkbox",checked:n.chargeable_to_customer,onChange:h=>o({...n,chargeable_to_customer:h.target.checked}),style:{width:"18px",height:"18px"}}):e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.75rem",fontWeight:"500",backgroundColor:D?"#dcfce7":"#fef3c7",color:D?"#166534":"#92400e"},children:[D?e.jsx(Q,{size:12}):e.jsx(X,{size:12}),D?"Yes":"No"]})}),m(["admin","supplier_pm"])&&e.jsx("td",{children:z?e.jsxs("select",{className:"form-input",value:n.procurement_method||"supplier",onChange:h=>o({...n,procurement_method:h.target.value}),style:{fontSize:"0.85rem",padding:"0.25rem"},children:[e.jsx("option",{value:"supplier",children:"Supplier"}),e.jsx("option",{value:"partner",children:"Partner"})]}):e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.75rem",fontWeight:"500",backgroundColor:(a.procurement_method||"supplier")==="partner"?"#f3e8ff":"#e0e7ff",color:(a.procurement_method||"supplier")==="partner"?"#7c3aed":"#4338ca"},children:[(a.procurement_method||"supplier")==="partner"?e.jsx(Ae,{size:12}):e.jsx(ze,{size:12}),(a.procurement_method||"supplier")==="partner"?"Partner":"Supplier"]})}),e.jsx("td",{children:z&&_(a)?e.jsx("select",{className:"form-input",value:n.status,onChange:h=>o({...n,status:h.target.value}),children:Lt.map(h=>e.jsx("option",{value:h,children:Ge[h]||h},h))}):e.jsx("span",{className:`status-badge ${Gt(a.status)}`,children:Ge[a.status]||a.status})}),e.jsx("td",{onClick:h=>h.stopPropagation(),children:a.expense_files?.length>0?e.jsx("div",{style:{display:"flex",gap:"0.25rem"},children:a.expense_files.map((h,W)=>e.jsx("button",{onClick:()=>U(h.file_path,h.file_name),style:{background:"none",border:"none",cursor:"pointer",color:"#3b82f6"},title:h.file_name,children:e.jsx(Ze,{size:16})},W))}):"-"}),e.jsx("td",{onClick:h=>h.stopPropagation(),children:z?e.jsxs("div",{className:"action-buttons",children:[e.jsx("button",{className:"btn-icon btn-success",onClick:()=>u(a.id),children:e.jsx(Te,{size:16})}),e.jsx("button",{className:"btn-icon btn-secondary",onClick:()=>y(null),children:e.jsx(X,{size:16})})]}):e.jsxs("div",{className:"action-buttons",children:[S(a)&&e.jsx("button",{className:"btn-icon",onClick:()=>f(a.id),title:"Submit for Validation",style:{color:"#3b82f6"},children:e.jsx(Ke,{size:16})}),_(a)&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn-icon btn-success",onClick:()=>v(a.id),title:"Validate",children:e.jsx(_e,{size:16})}),e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>I(a.id),title:"Reject",children:e.jsx(X,{size:16})})]}),d(a)&&e.jsx("button",{className:"btn-icon",onClick:()=>$(a),title:"Edit",children:e.jsx(Qe,{size:16})}),A(a)&&e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>w(a),title:"Delete",children:e.jsx(ke,{size:16})})]})})]})}function Vt({expenses:a,editingId:r,editForm:n,setEditForm:o,resources:l,hasRole:m,canEditChargeable:x,canSubmitExpense:S,canValidateExpense:_,canEditExpense:d,canDeleteExpense:A,handleEdit:$,handleSave:u,handleSubmit:f,handleValidate:v,handleReject:I,handleDeleteClick:w,downloadFile:U,setEditingId:y,setDetailModal:P}){const C=m(["admin","supplier_pm"]);return e.jsx("div",{className:"card",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Ref"}),e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Resource"}),e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Reason"}),e.jsx("th",{style:{textAlign:"right"},children:"Amount"}),e.jsx("th",{children:"Chargeable"}),C&&e.jsx("th",{children:"Procured By"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Receipts"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:a.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:C?11:10,style:{textAlign:"center",color:"#64748b",padding:"2rem"},children:"No expenses found."})}):a.map(D=>e.jsx(Yt,{expense:D,editingId:r,editForm:n,setEditForm:o,resources:l,hasRole:m,canEditChargeable:x,canSubmitExpense:S,canValidateExpense:_,canEditExpense:d,canDeleteExpense:A,handleEdit:$,handleSave:u,handleSubmit:f,handleValidate:v,handleReject:I,handleDeleteClick:w,downloadFile:U,setEditingId:y,setDetailModal:P},D.id))})]})})}const qt=["Travel","Accommodation","Sustenance"],Ht=["Draft","Submitted","Approved","Rejected","Paid"],Ye={Draft:"Draft",Submitted:"Submitted",Approved:"Validated",Rejected:"Rejected",Paid:"Paid"};function Jt(a){switch(a){case"Travel":return e.jsx(pe,{size:20});case"Accommodation":return e.jsx(he,{size:20});case"Sustenance":return e.jsx(ge,{size:20});default:return e.jsx(re,{size:20})}}function Xt(a){switch(a){case"Travel":return{bg:"#dbeafe",color:"#2563eb"};case"Accommodation":return{bg:"#f3e8ff",color:"#7c3aed"};case"Sustenance":return{bg:"#ffedd5",color:"#ea580c"};default:return{bg:"#f1f5f9",color:"#64748b"}}}function Zt(a){switch(a){case"Approved":case"Paid":return{bg:"#dcfce7",color:"#166534"};case"Submitted":return{bg:"#dbeafe",color:"#1e40af"};case"Rejected":return{bg:"#fee2e2",color:"#991b1b"};default:return{bg:"#f1f5f9",color:"#64748b"}}}function Kt({isOpen:a,expense:r,resources:n,hasRole:o,canEditChargeable:l,canSubmitExpense:m,canValidateExpense:x,canEditExpense:S,canDeleteExpense:_,onClose:d,onSave:A,onSubmit:$,onValidate:u,onReject:f,onDelete:v,onDownloadFile:I}){const[w,U]=j.useState(!1),[y,P]=j.useState({});if(j.useEffect(()=>{r&&(P({category:r.category,resource_id:r.resource_id,expense_date:r.expense_date,reason:r.reason,amount:r.amount,notes:r.notes||"",status:r.status,chargeable_to_customer:r.chargeable_to_customer!==!1,procurement_method:r.procurement_method||"supplier"}),U(!1))},[r]),!a||!r)return null;const C=Xt(r.category),D=Zt(r.status),z=r.chargeable_to_customer!==!1;async function h(){await A(r.id,y),U(!1)}function W(){U(!1),d()}return e.jsx("div",{style:{position:"fixed",inset:0,backgroundColor:"rgba(0, 0, 0, 0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3,padding:"1rem"},onClick:W,children:e.jsxs("div",{style:{backgroundColor:"white",borderRadius:"12px",width:"100%",maxWidth:"700px",maxHeight:"90vh",overflow:"auto",boxShadow:"0 25px 50px -12px rgba(0, 0, 0, 0.25)"},onClick:p=>p.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"1.25rem 1.5rem",borderBottom:"1px solid #e2e8f0",backgroundColor:"#f8fafc"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem"},children:[e.jsx("div",{style:{padding:"0.5rem",borderRadius:"8px",backgroundColor:C.bg,color:C.color},children:Jt(r.category)}),e.jsxs("div",{children:[e.jsx("h2",{style:{margin:0,fontSize:"1.25rem",fontWeight:"600"},children:r.expense_ref||"Expense Details"}),e.jsxs("span",{style:{fontSize:"0.875rem",color:"#64748b"},children:[r.category," Expense"]})]})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("span",{style:{padding:"0.375rem 0.75rem",borderRadius:"6px",fontSize:"0.875rem",fontWeight:"500",backgroundColor:D.bg,color:D.color},children:Ye[r.status]||r.status}),e.jsx("button",{onClick:W,style:{background:"none",border:"none",cursor:"pointer",padding:"0.5rem",color:"#64748b"},children:e.jsx(X,{size:24})})]})]}),e.jsx("div",{style:{padding:"1.5rem"},children:w?e.jsxs("div",{style:{display:"grid",gap:"1rem"},children:[e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",marginBottom:"0.375rem",fontWeight:"500",fontSize:"0.875rem"},children:"Category"}),e.jsx("select",{className:"form-input",value:y.category,onChange:p=>P({...y,category:p.target.value}),children:qt.map(p=>e.jsx("option",{value:p,children:p},p))})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",marginBottom:"0.375rem",fontWeight:"500",fontSize:"0.875rem"},children:"Resource"}),e.jsxs("select",{className:"form-input",value:y.resource_id||"",onChange:p=>P({...y,resource_id:p.target.value}),children:[e.jsx("option",{value:"",children:"-- Select --"}),n.map(p=>e.jsx("option",{value:p.id,children:p.name},p.id))]})]})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",marginBottom:"0.375rem",fontWeight:"500",fontSize:"0.875rem"},children:"Date"}),e.jsx("input",{type:"date",className:"form-input",value:y.expense_date,onChange:p=>P({...y,expense_date:p.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",marginBottom:"0.375rem",fontWeight:"500",fontSize:"0.875rem"},children:"Amount (Â£)"}),e.jsx("input",{type:"number",step:"0.01",className:"form-input",value:y.amount,onChange:p=>P({...y,amount:p.target.value})})]})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",marginBottom:"0.375rem",fontWeight:"500",fontSize:"0.875rem"},children:"Reason"}),e.jsx("input",{type:"text",className:"form-input",value:y.reason,onChange:p=>P({...y,reason:p.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",marginBottom:"0.375rem",fontWeight:"500",fontSize:"0.875rem"},children:"Notes"}),e.jsx("textarea",{className:"form-input",rows:3,value:y.notes,onChange:p=>P({...y,notes:p.target.value})})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[l()&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("input",{type:"checkbox",id:"chargeable",checked:y.chargeable_to_customer,onChange:p=>P({...y,chargeable_to_customer:p.target.checked}),style:{width:"18px",height:"18px"}}),e.jsx("label",{htmlFor:"chargeable",style:{fontWeight:"500",fontSize:"0.875rem"},children:"Chargeable to Customer"})]}),o(["admin","supplier_pm"])&&e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",marginBottom:"0.375rem",fontWeight:"500",fontSize:"0.875rem"},children:"Procurement Method"}),e.jsxs("select",{className:"form-input",value:y.procurement_method,onChange:p=>P({...y,procurement_method:p.target.value}),children:[e.jsx("option",{value:"supplier",children:"Supplier"}),e.jsx("option",{value:"partner",children:"Partner"})]})]})]}),x(r)&&e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",marginBottom:"0.375rem",fontWeight:"500",fontSize:"0.875rem"},children:"Status"}),e.jsx("select",{className:"form-input",value:y.status,onChange:p=>P({...y,status:p.target.value}),children:Ht.map(p=>e.jsx("option",{value:p,children:Ye[p]||p},p))})]})]}):e.jsxs("div",{style:{display:"grid",gap:"1.25rem"},children:[e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:"1rem",padding:"1rem",backgroundColor:"#f8fafc",borderRadius:"8px"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem"},children:[e.jsx(Xe,{size:18,style:{color:"#64748b"}}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"0.75rem",color:"#64748b",textTransform:"uppercase"},children:"Resource"}),e.jsx("div",{style:{fontWeight:"500"},children:r.resource_name||"Unknown"})]})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem"},children:[e.jsx(St,{size:18,style:{color:"#64748b"}}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"0.75rem",color:"#64748b",textTransform:"uppercase"},children:"Date"}),e.jsx("div",{style:{fontWeight:"500"},children:new Date(r.expense_date).toLocaleDateString("en-GB")})]})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem"},children:[e.jsx(Ct,{size:18,style:{color:"#64748b"}}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"0.75rem",color:"#64748b",textTransform:"uppercase"},children:"Amount"}),e.jsxs("div",{style:{fontWeight:"600",fontSize:"1.125rem",color:"#0f172a"},children:["Â£",parseFloat(r.amount).toFixed(2)]})]})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem"},children:[z?e.jsx(_e,{size:18,style:{color:"#10b981"}}):e.jsx(X,{size:18,style:{color:"#f59e0b"}}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"0.75rem",color:"#64748b",textTransform:"uppercase"},children:"Chargeable"}),e.jsx("div",{style:{fontWeight:"500",color:z?"#10b981":"#f59e0b"},children:z?"Yes":"No"})]})]})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"0.75rem",color:"#64748b",textTransform:"uppercase",marginBottom:"0.375rem"},children:"Reason"}),e.jsx("div",{style:{fontSize:"0.9375rem"},children:r.reason||"No reason provided"})]}),r.notes&&e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"0.75rem",color:"#64748b",textTransform:"uppercase",marginBottom:"0.375rem"},children:"Notes"}),e.jsx("div",{style:{fontSize:"0.9375rem",color:"#475569"},children:r.notes})]}),o(["admin","supplier_pm"])&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem"},children:[(r.procurement_method||"supplier")==="partner"?e.jsx(Ae,{size:18,style:{color:"#7c3aed"}}):e.jsx(ze,{size:18,style:{color:"#4338ca"}}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"0.75rem",color:"#64748b",textTransform:"uppercase"},children:"Procured By"}),e.jsx("div",{style:{fontWeight:"500"},children:(r.procurement_method||"supplier")==="partner"?"Partner (Reimbursable)":"Supplier (JT Direct)"})]})]}),r.expense_files?.length>0&&e.jsxs("div",{children:[e.jsxs("div",{style:{fontSize:"0.75rem",color:"#64748b",textTransform:"uppercase",marginBottom:"0.5rem"},children:["Receipts (",r.expense_files.length,")"]}),e.jsx("div",{style:{display:"flex",gap:"0.5rem",flexWrap:"wrap"},children:r.expense_files.map((p,se)=>e.jsxs("button",{onClick:()=>I(p.file_path,p.file_name),style:{display:"flex",alignItems:"center",gap:"0.375rem",padding:"0.5rem 0.75rem",backgroundColor:"#f1f5f9",border:"1px solid #e2e8f0",borderRadius:"6px",cursor:"pointer",fontSize:"0.875rem"},children:[e.jsx(Ze,{size:16,style:{color:"#3b82f6"}}),p.file_name]},se))})]}),e.jsxs("div",{style:{display:"flex",gap:"1.5rem",fontSize:"0.8125rem",color:"#64748b",paddingTop:"0.75rem",borderTop:"1px solid #e2e8f0"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.375rem"},children:[e.jsx(Me,{size:14}),"Created: ",r.created_at?new Date(r.created_at).toLocaleString("en-GB"):"Unknown"]}),r.updated_at&&r.updated_at!==r.created_at&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.375rem"},children:[e.jsx(Me,{size:14}),"Updated: ",new Date(r.updated_at).toLocaleString("en-GB")]})]})]})}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"1rem 1.5rem",borderTop:"1px solid #e2e8f0",backgroundColor:"#f8fafc"},children:[e.jsx("div",{children:_(r)&&!w&&e.jsxs("button",{onClick:()=>{v(r),W()},className:"btn btn-danger",style:{display:"flex",alignItems:"center",gap:"0.375rem"},children:[e.jsx(ke,{size:16})," Delete"]})}),e.jsx("div",{style:{display:"flex",gap:"0.5rem"},children:w?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>U(!1),className:"btn btn-secondary",children:"Cancel"}),e.jsxs("button",{onClick:h,className:"btn btn-primary",style:{display:"flex",alignItems:"center",gap:"0.375rem"},children:[e.jsx(Te,{size:16})," Save Changes"]})]}):e.jsxs(e.Fragment,{children:[m(r)&&e.jsxs("button",{onClick:()=>{$(r.id),W()},className:"btn btn-secondary",style:{display:"flex",alignItems:"center",gap:"0.375rem"},children:[e.jsx(Ke,{size:16})," Submit for Validation"]}),x(r)&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>{f(r.id),W()},className:"btn btn-danger",style:{display:"flex",alignItems:"center",gap:"0.375rem"},children:[e.jsx(X,{size:16})," Reject"]}),e.jsxs("button",{onClick:()=>{u(r.id),W()},className:"btn btn-success",style:{display:"flex",alignItems:"center",gap:"0.375rem"},children:[e.jsx(_e,{size:16})," Validate"]})]}),S(r)&&e.jsxs("button",{onClick:()=>U(!0),className:"btn btn-primary",style:{display:"flex",alignItems:"center",gap:"0.375rem"},children:[e.jsx(Qe,{size:16})," Edit"]})]})})]})]})})}const je=20520,Ve={resource_id:"",expense_date:new Date().toISOString().split("T")[0],travel_amount:"",travel_reason:"",travel_chargeable:!0,travel_procurement:"supplier",accommodation_amount:"",accommodation_reason:"",accommodation_chargeable:!0,accommodation_procurement:"supplier",sustenance_amount:"",sustenance_reason:"",sustenance_chargeable:!0,sustenance_procurement:"supplier",notes:"",files:[]};function ir(){const{user:a,role:r}=qe(),{projectId:n}=He(),{showSuccess:o,showError:l,showWarning:m}=Je(),{showTestUsers:x,testUserIds:S}=pt(),_=a?.id||null,{canAddExpense:d,canSubmitExpense:A,canValidateExpense:$,canEditExpense:u,canDeleteExpense:f,getAvailableResources:v,hasRole:I}=gt(),[w,U]=j.useState([]),[y,P]=j.useState([]),[C,D]=j.useState(!0),[z,h]=j.useState(!1),[W,p]=j.useState("form"),[se,ae]=j.useState(null),[L,ne]=j.useState({}),[Se,M]=j.useState(!1),[b,ee]=j.useState(Ve),[oe,fe]=j.useState("all"),[le,ie]=j.useState("all"),[ce,Ce]=j.useState("all"),[de,t]=j.useState("all"),[i,N]=j.useState("all"),[k,g]=j.useState({isOpen:!1,expenseId:null,expenseData:null}),[T,H]=j.useState({isOpen:!1,expense:null,editMode:!1,editData:null}),B=j.useCallback(async()=>{if(n){D(!0);try{const s=await q.getAllFiltered(n,x);U(s);const{data:c}=await V.from("resources").select("id, name, email, user_id, partner_id, partner:partners(id, name)").order("name");let F=c||[];!x&&S?.length>0&&(F=F.filter(Y=>!Y.user_id||!S.includes(Y.user_id))),P(F)}catch{l("Failed to load expenses")}finally{D(!1)}}},[n,x,S,l]);j.useEffect(()=>{B()},[B]);async function G(){if(!b.resource_id){m("Please select a resource");return}const s=parseFloat(b.travel_amount)>0,c=parseFloat(b.accommodation_amount)>0,F=parseFloat(b.sustenance_amount)>0;if(!s&&!c&&!F){m("Please enter at least one expense amount");return}if(s&&!b.travel_reason){m("Please enter a reason for the travel expense");return}if(c&&!b.accommodation_reason){m("Please enter a reason for the accommodation expense");return}if(F&&!b.sustenance_reason){m("Please enter a reason for the sustenance expense");return}try{const Y=y.find(Ne=>Ne.id===b.resource_id)?.name,J=[];s&&J.push({project_id:n,category:"Travel",resource_id:b.resource_id,resource_name:Y,expense_date:b.expense_date,reason:b.travel_reason,amount:parseFloat(b.travel_amount),notes:b.notes,created_by:_,chargeable_to_customer:b.travel_chargeable,procurement_method:b.travel_procurement}),c&&J.push({project_id:n,category:"Accommodation",resource_id:b.resource_id,resource_name:Y,expense_date:b.expense_date,reason:b.accommodation_reason,amount:parseFloat(b.accommodation_amount),notes:b.notes,created_by:_,chargeable_to_customer:b.accommodation_chargeable,procurement_method:b.accommodation_procurement}),F&&J.push({project_id:n,category:"Sustenance",resource_id:b.resource_id,resource_name:Y,expense_date:b.expense_date,reason:b.sustenance_reason,amount:parseFloat(b.sustenance_amount),notes:b.notes,created_by:_,chargeable_to_customer:b.sustenance_chargeable,procurement_method:b.sustenance_procurement});const Ue=await q.createMany(J);if(b.files.length>0&&Ue){M(!0);for(const Ne of Ue)for(const mt of b.files)try{await q.uploadReceipt(Ne.id,mt,_)}catch{}M(!1)}await B(),h(!1),ee(Ve),o("Expenses added successfully!")}catch(Y){l("Failed to add expenses: "+Y.message)}}async function E(s){try{await q.create({project_id:n,category:s.category,resource_id:s.resource_id,resource_name:s.resource_name,expense_date:s.expense_date,reason:s.reason,amount:s.amount,notes:s.notes,created_by:_,chargeable_to_customer:s.chargeable_to_customer,procurement_method:s.procurement_method}),await B()}catch(c){l("Failed to create expense: "+c.message)}}function K(s){ae(s.id),ne({category:s.category,resource_id:s.resource_id,resource_name:s.resource_name,expense_date:s.expense_date,reason:s.reason,amount:s.amount,notes:s.notes,status:s.status,chargeable_to_customer:s.chargeable_to_customer!==!1,procurement_method:s.procurement_method||"supplier"})}async function Ie(s){try{const c=y.find(F=>F.id===L.resource_id)?.name||L.resource_name;await q.update(s,{category:L.category,resource_id:L.resource_id,resource_name:c,expense_date:L.expense_date,reason:L.reason,amount:parseFloat(L.amount),notes:L.notes,status:L.status,chargeable_to_customer:L.chargeable_to_customer,procurement_method:L.procurement_method}),await B(),ae(null),o("Expense updated!")}catch(c){l("Failed to update: "+c.message)}}function ue(s){g({isOpen:!0,expenseId:s.id,expenseData:{resourceName:s.resource_name,date:s.expense_date,totalAmount:parseFloat(s.amount||0),category:s.category,chargeable:s.chargeable_to_customer,procurement:s.procurement_method,status:s.status}})}async function et(){if(k.expenseId)try{await q.delete(k.expenseId,_),await B(),g({isOpen:!1,expenseId:null,expenseData:null}),o("Expense deleted")}catch(s){l("Failed to delete: "+s.message)}}async function Pe(s){if(confirm("Submit this expense for validation?"))try{await q.submit(s),await B(),o("Expense submitted for validation!")}catch(c){l("Failed to submit: "+c.message)}}async function De(s){try{await q.validate(s),await B(),o("Expense validated!")}catch(c){l("Failed to validate: "+c.message)}}async function Ee(s){const c=prompt("Please provide a reason for rejection (optional):");try{await q.reject(s,c),await B(),m("Expense rejected")}catch(F){l("Failed to reject: "+F.message)}}function tt(s){const c=Array.from(s.target.files);ee({...b,files:[...b.files,...c]})}function rt(s){ee({...b,files:b.files.filter((c,F)=>F!==s)})}async function Be(s,c){try{const F=await q.downloadReceipt(s),Y=URL.createObjectURL(F),J=document.createElement("a");J.href=Y,J.download=c,document.body.appendChild(J),J.click(),document.body.removeChild(J),URL.revokeObjectURL(Y)}catch{l("Failed to download file")}}function Fe(){return I(["admin","supplier_pm","customer_pm"])}const st=w.filter(s=>!(oe!=="all"&&s.category!==oe||le!=="all"&&s.resource_name!==le||ce!=="all"&&s.status!==ce||de==="chargeable"&&s.chargeable_to_customer===!1||de==="non-chargeable"&&s.chargeable_to_customer!==!1||i!=="all"&&(s.procurement_method||"supplier")!==i)),at=w.reduce((s,c)=>s+parseFloat(c.amount||0),0),nt=w.filter(s=>s.chargeable_to_customer!==!1).reduce((s,c)=>s+parseFloat(c.amount||0),0),ot=w.filter(s=>s.chargeable_to_customer===!1).reduce((s,c)=>s+parseFloat(c.amount||0),0),$e=w.filter(s=>["Approved","Paid"].includes(s.status)).reduce((s,c)=>s+parseFloat(c.amount||0),0),Oe=je-$e,lt=w.filter(s=>s.status==="Submitted").length,it=w.filter(s=>(s.procurement_method||"supplier")==="supplier").reduce((s,c)=>s+parseFloat(c.amount||0),0),ct=w.filter(s=>s.procurement_method==="partner").reduce((s,c)=>s+parseFloat(c.amount||0),0),dt={Travel:w.filter(s=>s.category==="Travel").reduce((s,c)=>s+parseFloat(c.amount||0),0),Accommodation:w.filter(s=>s.category==="Accommodation").reduce((s,c)=>s+parseFloat(c.amount||0),0),Sustenance:w.filter(s=>s.category==="Sustenance").reduce((s,c)=>s+parseFloat(c.amount||0),0)},te={};w.forEach(s=>{te[s.resource_name]||(te[s.resource_name]={total:0,chargeable:0,nonChargeable:0});const c=parseFloat(s.amount||0);te[s.resource_name].total+=c,s.chargeable_to_customer!==!1?te[s.resource_name].chargeable+=c:te[s.resource_name].nonChargeable+=c});const xe=v(y),ut=[...new Set(w.map(s=>s.resource_name))];return C&&!n?e.jsx(ht,{message:"Loading expenses...",size:"large",fullPage:!0}):e.jsxs("div",{className:"page-container",children:[e.jsx(ft,{icon:re,title:"Expenses",subtitle:`Track project expenses against Â£${je.toLocaleString()} budget`,children:d&&!z&&e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsxs("button",{className:"btn btn-primary",onClick:()=>{p("form"),h(!0)},children:[e.jsx(Nt,{size:18})," Add Expenses"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:()=>{p("scanner"),h(!0)},style:{background:"linear-gradient(135deg, #8b5cf6, #6366f1)",color:"white",border:"none"},title:"Scan a receipt with AI",children:[e.jsx(we,{size:18})," ",e.jsx(ye,{size:14})," Scan Receipt"]})]})}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem"},children:[e.jsx(Z,{icon:re,label:"Total Budget",value:`Â£${je.toLocaleString()}`,color:"#3b82f6"}),e.jsx(Z,{label:"Total Claimed",value:`Â£${at.toLocaleString()}`,color:"#3b82f6"}),e.jsx(Z,{icon:_e,label:"Chargeable",value:`Â£${nt.toLocaleString()}`,color:"#10b981"}),e.jsx(Z,{icon:ve,label:"Non-Chargeable",value:`Â£${ot.toLocaleString()}`,color:"#f59e0b"})]}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem",gridTemplateColumns:"repeat(3, 1fr)"},children:[e.jsx(Z,{label:"Validated / Paid",value:`Â£${$e.toLocaleString()}`,color:"#10b981"}),e.jsx(Z,{label:"Remaining Budget",value:`Â£${Oe.toLocaleString()}`,color:Oe<je*.2?"#ef4444":"#10b981"}),e.jsx(Z,{label:"Pending Validation",value:lt,color:"#f59e0b"})]}),I(["admin","supplier_pm"])&&e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem",gridTemplateColumns:"repeat(2, 1fr)"},children:[e.jsx(Z,{icon:ze,label:"Supplier Procured",value:`Â£${it.toLocaleString()}`,subtext:"Paid directly by JT",color:"#6366f1"}),e.jsx(Z,{icon:Ae,label:"Partner Procured",value:`Â£${ct.toLocaleString()}`,subtext:"Reimbursable to partners",color:"#8b5cf6"})]}),e.jsx(Ft,{expenses:w,categoryTotals:dt}),e.jsx($t,{resourceTotals:te}),e.jsx(Pt,{filterCategory:oe,setFilterCategory:fe,filterResource:le,setFilterResource:ie,filterStatus:ce,setFilterStatus:Ce,filterChargeable:de,setFilterChargeable:t,filterProcurement:i,setFilterProcurement:N,resourceNames:ut,hasRole:I}),z&&W==="form"&&e.jsx(Ut,{newExpense:b,setNewExpense:ee,availableResources:xe,hasRole:I,handleAdd:G,handleFileSelect:tt,removeFile:rt,uploadingFiles:Se,onCancel:()=>h(!1)}),z&&W==="scanner"&&e.jsx("div",{style:{marginBottom:"1.5rem"},children:e.jsx(Tt,{resources:xe,defaultResourceId:xe.length===1?xe[0].id:null,onExpenseCreated:E,onCancel:()=>{h(!1),p("form")}})}),e.jsx(Vt,{expenses:st,editingId:se,editForm:L,setEditForm:ne,resources:y,hasRole:I,canEditChargeable:Fe,canSubmitExpense:A,canValidateExpense:$,canEditExpense:u,canDeleteExpense:f,handleEdit:K,handleSave:Ie,handleSubmit:Pe,handleValidate:De,handleReject:Ee,handleDeleteClick:ue,downloadFile:Be,setEditingId:ae,setDetailModal:H}),e.jsx(Ot,{}),e.jsx(xt,{isOpen:k.isOpen,onClose:()=>g({isOpen:!1,expenseId:null,expenseData:null}),onConfirm:et,title:"Delete Expense",message:k.expenseData?e.jsxs("div",{children:[e.jsx("p",{children:"Are you sure you want to delete this expense?"}),e.jsxs("div",{style:{backgroundColor:"#fef3c7",border:"1px solid #f59e0b",borderRadius:"6px",padding:"0.75rem",marginTop:"0.75rem"},children:[e.jsx("p",{style:{fontWeight:"600",color:"#92400e",margin:"0 0 0.5rem 0"},children:"Details:"}),e.jsxs("ul",{style:{margin:"0",paddingLeft:"1.25rem",color:"#92400e",fontSize:"0.9rem"},children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Resource:"})," ",k.expenseData.resourceName]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Category:"})," ",k.expenseData.category]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Amount:"})," Â£",k.expenseData.totalAmount?.toFixed(2)]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Status:"})," ",k.expenseData.status]})]})]}),e.jsx("p",{style:{marginTop:"0.75rem",fontSize:"0.85rem",color:"#6b7280"},children:"This expense can be restored from the audit log if needed."})]}):"Are you sure you want to delete this expense?",confirmText:"Delete",cancelText:"Cancel",variant:"danger"}),e.jsx(Kt,{isOpen:T.isOpen,expense:T.expense,resources:y,hasRole:I,canEditChargeable:Fe,canSubmitExpense:A,canValidateExpense:$,canEditExpense:u,canDeleteExpense:f,onClose:()=>H({isOpen:!1,expense:null}),onSave:async(s,c)=>{const F=y.find(Y=>Y.id===c.resource_id)?.name||c.resource_name;await q.update(s,{category:c.category,resource_id:c.resource_id,resource_name:F,expense_date:c.expense_date,reason:c.reason,amount:parseFloat(c.amount),notes:c.notes,status:c.status,chargeable_to_customer:c.chargeable_to_customer,procurement_method:c.procurement_method}),await B(),o("Expense updated!")},onSubmit:Pe,onValidate:De,onReject:Ee,onDelete:ue,onDownloadFile:Be})]})}export{ir as default};
