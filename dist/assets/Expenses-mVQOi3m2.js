import{c as $,a as tr,b as ar,d as sr,r as m,n as nr,s as b,j as e,L as or,P as lr,w as re,S as k,C as M,A as ir,t as te,B as ae,U as je,v as cr,X as N,x as dr,o as mr,T as pr}from"./index-CspTly-R.js";import{u as ur}from"./usePermissions-dxQSMTTA.js";import{C as hr}from"./ConfirmDialog-BqHNHPx3.js";import{P as gr}from"./plus-DwqEgAX3.js";import{S as se}from"./save-CA5ETuwq.js";import{D as ye}from"./download-BRXKA3YQ.js";import{P as _e}from"./pen-opG0b6Iw.js";/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ve=$("Car",[["path",{d:"M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2",key:"5owen"}],["circle",{cx:"7",cy:"17",r:"2",key:"u2ysq9"}],["path",{d:"M9 17h6",key:"r8uit2"}],["circle",{cx:"17",cy:"17",r:"2",key:"axvx0g"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ce=$("Home",[["path",{d:"m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z",key:"y5dka4"}],["polyline",{points:"9 22 9 12 15 12 15 22",key:"e2us08"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xr=$("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=$("Utensils",[["path",{d:"M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2",key:"cjf0a3"}],["path",{d:"M7 2v20",key:"1473qp"}],["path",{d:"M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7",key:"1ogz0v"}]]);function kr(){var fe,be;const{user:U,role:ne}=tr(),{projectId:y}=ar(),{showSuccess:A,showError:z,showWarning:D}=sr(),B=(U==null?void 0:U.id)||null,{canAddExpense:ke,canSubmitExpense:ze,canValidateExpense:oe,canEditExpense:le,canDeleteExpense:we,getAvailableResources:Te,hasRole:x}=ur(),[u,Re]=m.useState([]),[w,Fe]=m.useState([]),[Ne,fr]=m.useState(!0),[ie,q]=m.useState(!1),[j,J]=m.useState(null),[l,v]=m.useState({}),[H,De]=m.useState("all"),[V,Pe]=m.useState("all"),[G,Ae]=m.useState("all"),[Y,Ee]=m.useState("all"),[Z,Ie]=m.useState("all"),[ce,de]=m.useState(!1),[f,Q]=m.useState({isOpen:!1,expenseId:null,expenseData:null}),[h,g]=m.useState({isOpen:!1,expense:null,editMode:!1,editData:null}),{showTestUsers:X,testUserIds:K}=nr(),W=20520,[t,d]=m.useState({resource_id:"",expense_date:new Date().toISOString().split("T")[0],travel_amount:"",travel_reason:"",travel_chargeable:!0,travel_procurement:"supplier",accommodation_amount:"",accommodation_reason:"",accommodation_chargeable:!0,accommodation_procurement:"supplier",sustenance_amount:"",sustenance_reason:"",sustenance_chargeable:!0,sustenance_procurement:"supplier",notes:"",files:[]}),me=["Draft","Submitted","Approved","Rejected","Paid"],L={Draft:"Draft",Submitted:"Submitted",Approved:"Validated",Rejected:"Rejected",Paid:"Paid"};m.useEffect(()=>{y&&C(y)},[y]),m.useEffect(()=>{y&&C(y)},[X]);async function C(r){const a=r||y;if(a)try{let s=b.from("expenses").select("*, expense_files(*)").eq("project_id",a).order("expense_date",{ascending:!1});X||(s=s.or("is_test_content.is.null,is_test_content.eq.false"));const{data:i}=await s;Re(i||[]);const{data:n}=await b.from("resources").select("id, name, email, user_id, partner_id, partner:partners(id, name)").order("name");let c=n||[];!X&&K&&K.length>0&&(c=c.filter(F=>!F.user_id||!K.includes(F.user_id))),Fe(c)}catch(s){console.error("Error fetching data:",s)}}async function Be(){var i;if(!t.resource_id){D("Please select a resource");return}const r=parseFloat(t.travel_amount)>0,a=parseFloat(t.accommodation_amount)>0,s=parseFloat(t.sustenance_amount)>0;if(!r&&!a&&!s){D("Please enter at least one expense amount");return}if(r&&!t.travel_reason){D("Please enter a reason for the travel expense");return}if(a&&!t.accommodation_reason){D("Please enter a reason for the accommodation expense");return}if(s&&!t.sustenance_reason){D("Please enter a reason for the sustenance expense");return}try{const n=[],c=(i=w.find(_=>_.id===t.resource_id))==null?void 0:i.name;r&&n.push({project_id:y,category:"Travel",resource_id:t.resource_id,resource_name:c,expense_date:t.expense_date,reason:t.travel_reason,amount:parseFloat(t.travel_amount),notes:t.notes,status:"Draft",created_by:B,chargeable_to_customer:t.travel_chargeable,procurement_method:t.travel_procurement}),a&&n.push({project_id:y,category:"Accommodation",resource_id:t.resource_id,resource_name:c,expense_date:t.expense_date,reason:t.accommodation_reason,amount:parseFloat(t.accommodation_amount),notes:t.notes,status:"Draft",created_by:B,chargeable_to_customer:t.accommodation_chargeable,procurement_method:t.accommodation_procurement}),s&&n.push({project_id:y,category:"Sustenance",resource_id:t.resource_id,resource_name:c,expense_date:t.expense_date,reason:t.sustenance_reason,amount:parseFloat(t.sustenance_amount),notes:t.notes,status:"Draft",created_by:B,chargeable_to_customer:t.sustenance_chargeable,procurement_method:t.sustenance_procurement});const{data:F,error:S}=await b.from("expenses").insert(n).select();if(S)throw S;if(t.files.length>0&&F){de(!0);for(const _ of F)for(const T of t.files){const E=`${_.id}/${Date.now()}-${T.name}`,{error:o}=await b.storage.from("receipts").upload(E,T);o||await b.from("expense_files").insert({expense_id:_.id,file_name:T.name,file_path:E,file_size:T.size,file_type:T.type,uploaded_by:B})}de(!1)}await C(),q(!1),d({resource_id:"",expense_date:new Date().toISOString().split("T")[0],travel_amount:"",travel_reason:"",travel_chargeable:!0,travel_procurement:"supplier",accommodation_amount:"",accommodation_reason:"",accommodation_chargeable:!0,accommodation_procurement:"supplier",sustenance_amount:"",sustenance_reason:"",sustenance_chargeable:!0,sustenance_procurement:"supplier",notes:"",files:[]}),A("Expenses added successfully!")}catch(n){console.error("Error adding expense:",n),z("Failed to add expenses: "+n.message)}}function We(r){J(r.id),v({category:r.category,resource_id:r.resource_id,resource_name:r.resource_name,expense_date:r.expense_date,reason:r.reason,amount:r.amount,notes:r.notes,status:r.status,chargeable_to_customer:r.chargeable_to_customer!==!1,procurement_method:r.procurement_method||"supplier"})}async function Le(r){var a;try{const s=((a=w.find(n=>n.id===l.resource_id))==null?void 0:a.name)||l.resource_name,{error:i}=await b.from("expenses").update({category:l.category,resource_id:l.resource_id,resource_name:s,expense_date:l.expense_date,reason:l.reason,amount:parseFloat(l.amount),notes:l.notes,status:l.status,chargeable_to_customer:l.chargeable_to_customer,procurement_method:l.procurement_method}).eq("id",r);if(i)throw i;await C(),J(null),A("Expense updated!")}catch(s){console.error("Error updating expense:",s),z("Failed to update: "+s.message)}}function Oe(r){const a=(parseFloat(r.travel_amount)||0)+(parseFloat(r.accommodation_amount)||0)+(parseFloat(r.sustenance_amount)||0),s=[];r.travel_amount>0&&s.push(`Travel: Â£${r.travel_amount}`),r.accommodation_amount>0&&s.push(`Accommodation: Â£${r.accommodation_amount}`),r.sustenance_amount>0&&s.push(`Sustenance: Â£${r.sustenance_amount}`),Q({isOpen:!0,expenseId:r.id,expenseData:{resourceName:r.resource_name,date:r.expense_date,totalAmount:a,categories:s,chargeable:r.chargeable_to_customer,procurement:r.procurement_method,status:r.status}})}async function Me(){if(f.expenseId)try{const{error:r}=await b.from("expenses").delete().eq("id",f.expenseId);if(r)throw r;await C(),Q({isOpen:!1,expenseId:null,expenseData:null})}catch(r){console.error("Error deleting expense:",r),z("Failed to delete: "+r.message)}}async function $e(r){if(confirm("Submit this expense for validation?"))try{const{error:a}=await b.from("expenses").update({status:"Submitted"}).eq("id",r);if(a)throw a;await C(),A("Expense submitted for validation!")}catch(a){console.error("Error submitting expense:",a),z("Failed to submit: "+a.message)}}async function Ue(r){try{const{error:a}=await b.from("expenses").update({status:"Approved"}).eq("id",r);if(a)throw a;await C(),A("Expense validated!")}catch(a){console.error("Error validating expense:",a),z("Failed to validate: "+a.message)}}async function qe(r){const a=prompt("Please provide a reason for rejection (optional):");try{const s={status:"Rejected"};a&&(s.rejection_reason=a);const{error:i}=await b.from("expenses").update(s).eq("id",r);if(i)throw i;await C(),D("Expense rejected")}catch(s){console.error("Error rejecting expense:",s),z("Failed to reject: "+s.message)}}function Je(r){const a=Array.from(r.target.files);d({...t,files:[...t.files,...a]})}function He(r){d({...t,files:t.files.filter((a,s)=>s!==r)})}async function pe(r,a){try{const{data:s,error:i}=await b.storage.from("receipts").download(r);if(i)throw i;const n=URL.createObjectURL(s),c=document.createElement("a");c.href=n,c.download=a,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(n)}catch(s){console.error("Error downloading file:",s),z("Failed to download file")}}function ee(r){switch(r){case"Travel":return e.jsx(ve,{size:16});case"Accommodation":return e.jsx(Ce,{size:16});case"Sustenance":return e.jsx(Se,{size:16});default:return e.jsx(re,{size:16})}}function O(r){switch(r){case"Travel":return{bg:"#dbeafe",color:"#2563eb"};case"Accommodation":return{bg:"#f3e8ff",color:"#7c3aed"};case"Sustenance":return{bg:"#ffedd5",color:"#ea580c"};default:return{bg:"#f1f5f9",color:"#64748b"}}}function ue(r){switch(r){case"Approved":case"Paid":return"status-completed";case"Submitted":return"status-in-progress";case"Rejected":return"status-at-risk";default:return"status-not-started"}}function Ve(){return x(["admin","supplier_pm","customer_pm"])}const he=u.filter(r=>!(H!=="all"&&r.category!==H||V!=="all"&&r.resource_name!==V||G!=="all"&&r.status!==G||Y==="chargeable"&&r.chargeable_to_customer===!1||Y==="non-chargeable"&&r.chargeable_to_customer!==!1||Z!=="all"&&(r.procurement_method||"supplier")!==Z)),Ge=u.reduce((r,a)=>r+parseFloat(a.amount||0),0),Ye=u.filter(r=>r.chargeable_to_customer!==!1).reduce((r,a)=>r+parseFloat(a.amount||0),0),Ze=u.filter(r=>r.chargeable_to_customer===!1).reduce((r,a)=>r+parseFloat(a.amount||0),0),ge=u.filter(r=>["Approved","Paid"].includes(r.status)).reduce((r,a)=>r+parseFloat(a.amount||0),0),xe=W-ge,Qe=u.filter(r=>r.status==="Submitted").length,Xe=u.filter(r=>(r.procurement_method||"supplier")==="supplier").reduce((r,a)=>r+parseFloat(a.amount||0),0),Ke=u.filter(r=>r.procurement_method==="partner").reduce((r,a)=>r+parseFloat(a.amount||0),0),er={Travel:u.filter(r=>r.category==="Travel").reduce((r,a)=>r+parseFloat(a.amount||0),0),Accommodation:u.filter(r=>r.category==="Accommodation").reduce((r,a)=>r+parseFloat(a.amount||0),0),Sustenance:u.filter(r=>r.category==="Sustenance").reduce((r,a)=>r+parseFloat(a.amount||0),0)},R={};u.forEach(r=>{R[r.resource_name]||(R[r.resource_name]={total:0,chargeable:0,nonChargeable:0});const a=parseFloat(r.amount||0);R[r.resource_name].total+=a,r.chargeable_to_customer!==!1?R[r.resource_name].chargeable+=a:R[r.resource_name].nonChargeable+=a});const rr=Te(w);return Ne&&!y?e.jsx(or,{message:"Loading expenses...",size:"large",fullPage:!0}):e.jsxs("div",{className:"page-container",children:[e.jsx(lr,{icon:re,title:"Expenses",subtitle:`Track project expenses against Â£${W.toLocaleString()} budget`,children:ke&&!ie&&e.jsxs("button",{className:"btn btn-primary",onClick:()=>q(!0),children:[e.jsx(gr,{size:18})," Add Expenses"]})}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem"},children:[e.jsx(k,{icon:re,label:"Total Budget",value:`Â£${W.toLocaleString()}`,color:"#3b82f6"}),e.jsx(k,{label:"Total Claimed",value:`Â£${Ge.toLocaleString()}`,color:"#3b82f6"}),e.jsx(k,{icon:M,label:"Chargeable",value:`Â£${Ye.toLocaleString()}`,color:"#10b981"}),e.jsx(k,{icon:ir,label:"Non-Chargeable",value:`Â£${Ze.toLocaleString()}`,color:"#f59e0b"})]}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem",gridTemplateColumns:"repeat(3, 1fr)"},children:[e.jsx(k,{label:"Validated/Paid",value:`Â£${ge.toLocaleString()}`,color:"#10b981"}),e.jsx(k,{label:"Remaining Budget",value:`Â£${xe.toLocaleString()}`,color:xe<W*.2?"#ef4444":"#10b981"}),e.jsx(k,{label:"Pending Validation",value:Qe,color:"#f59e0b"})]}),x(["admin","supplier_pm"])&&e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem",gridTemplateColumns:"repeat(2, 1fr)"},children:[e.jsx(k,{icon:te,label:"Supplier Procured",value:`Â£${Xe.toLocaleString()}`,subtext:"Paid directly by JT",color:"#6366f1"}),e.jsx(k,{icon:ae,label:"Partner Procured",value:`Â£${Ke.toLocaleString()}`,subtext:"Reimbursable to partners",color:"#8b5cf6"})]}),e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Breakdown by Type"}),e.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:"1rem"},children:["Travel","Accommodation","Sustenance"].map(r=>{const a=O(r),s=u.filter(n=>n.category===r).length,i=u.filter(n=>n.category===r&&n.chargeable_to_customer!==!1).reduce((n,c)=>n+parseFloat(c.amount||0),0);return e.jsxs("div",{style:{padding:"1rem",backgroundColor:a.bg,borderRadius:"8px"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",color:a.color,marginBottom:"0.5rem"},children:[ee(r),e.jsx("span",{style:{fontWeight:"600"},children:r})]}),e.jsxs("div",{style:{fontSize:"1.5rem",fontWeight:"700",color:a.color},children:["Â£",er[r].toFixed(2)]}),e.jsxs("div",{style:{fontSize:"0.8rem",color:"#64748b"},children:[s," expense(s)"]}),e.jsxs("div",{style:{fontSize:"0.75rem",color:"#10b981",marginTop:"0.25rem"},children:["Â£",i.toFixed(2)," chargeable"]})]},r)})})]}),Object.keys(R).length>0&&e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Breakdown by Resource"}),e.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"1rem"},children:Object.entries(R).map(([r,a])=>e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#f1f5f9",borderRadius:"8px",minWidth:"180px"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"0.5rem"},children:[e.jsx(je,{size:16,style:{color:"#64748b"}}),e.jsx("span",{style:{fontWeight:"600",fontSize:"0.9rem"},children:r})]}),e.jsxs("div",{style:{fontSize:"1.25rem",fontWeight:"700",color:"#3b82f6"},children:["Â£",a.total.toFixed(2)]}),e.jsxs("div",{style:{fontSize:"0.75rem",color:"#10b981"},children:["Â£",a.chargeable.toFixed(2)," chargeable"]}),a.nonChargeable>0&&e.jsxs("div",{style:{fontSize:"0.75rem",color:"#f59e0b"},children:["Â£",a.nonChargeable.toFixed(2)," non-chargeable"]})]},r))})]}),e.jsx("div",{className:"card",style:{marginBottom:"1.5rem"},children:e.jsxs("div",{style:{display:"flex",gap:"1rem",alignItems:"center",flexWrap:"wrap"},children:[e.jsx("span",{style:{fontWeight:"500"},children:"Filter:"}),e.jsxs("select",{value:H,onChange:r=>De(r.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"all",children:"All Types"}),e.jsx("option",{value:"Travel",children:"Travel"}),e.jsx("option",{value:"Accommodation",children:"Accommodation"}),e.jsx("option",{value:"Sustenance",children:"Sustenance"})]}),e.jsxs("select",{value:V,onChange:r=>Pe(r.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"all",children:"All Resources"}),[...new Set(u.map(r=>r.resource_name))].map(r=>e.jsx("option",{value:r,children:r},r))]}),e.jsxs("select",{value:G,onChange:r=>Ae(r.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"all",children:"All Statuses"}),me.map(r=>e.jsx("option",{value:r,children:L[r]||r},r))]}),e.jsxs("select",{value:Y,onChange:r=>Ee(r.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"all",children:"All Expenses"}),e.jsx("option",{value:"chargeable",children:"Chargeable Only"}),e.jsx("option",{value:"non-chargeable",children:"Non-Chargeable Only"})]}),x(["admin","supplier_pm"])&&e.jsxs("select",{value:Z,onChange:r=>Ie(r.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"all",children:"All Procurement"}),e.jsx("option",{value:"supplier",children:"Supplier Procured"}),e.jsx("option",{value:"partner",children:"Partner Procured"})]})]})}),ie&&e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem",border:"2px solid var(--primary)"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Add New Expenses"}),e.jsx("p",{style:{color:"#64748b",fontSize:"0.9rem",marginBottom:"1rem"},children:"Enter amounts for any categories that apply. Leave blank to skip a category."}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem",marginBottom:"1.5rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Resource Name *"}),e.jsxs("select",{className:"form-input",value:t.resource_id,onChange:r=>d({...t,resource_id:r.target.value}),children:[e.jsx("option",{value:"",children:"Select Resource"}),rr.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Date *"}),e.jsx("input",{type:"date",className:"form-input",value:t.expense_date,onChange:r=>d({...t,expense_date:r.target.value})})]})]}),e.jsxs("div",{style:{marginBottom:"1.5rem",padding:"1rem",backgroundColor:"#f0fdf4",borderRadius:"8px",border:"1px solid #86efac"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"0.5rem"},children:[e.jsx(M,{size:18,style:{color:"#16a34a"}}),e.jsx("span",{style:{fontWeight:"600",color:"#166534"},children:"Default Settings"})]}),e.jsx("p",{style:{fontSize:"0.85rem",color:"#64748b",marginBottom:"0"},children:"Each expense category below has its own Chargeable and Procurement settings. Adjust them individually as needed."})]}),e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#dbeafe",borderRadius:"8px",marginBottom:"1rem"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",color:"#2563eb",marginBottom:"0.75rem"},children:[e.jsx(ve,{size:20}),e.jsx("span",{style:{fontWeight:"600",fontSize:"1rem"},children:"Travel"})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"150px 1fr",gap:"1rem",marginBottom:"0.75rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Amount (Â£)"}),e.jsx("input",{type:"number",step:"0.01",className:"form-input",placeholder:"0.00",value:t.travel_amount,onChange:r=>d({...t,travel_amount:r.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Reason / Description"}),e.jsx("input",{type:"text",className:"form-input",placeholder:"e.g., Train fare Jersey to London",value:t.travel_reason,onChange:r=>d({...t,travel_reason:r.target.value})})]})]}),parseFloat(t.travel_amount)>0&&e.jsxs("div",{style:{display:"flex",gap:"1.5rem",flexWrap:"wrap",paddingTop:"0.75rem",borderTop:"1px solid #93c5fd"},children:[e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"0.5rem",cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:t.travel_chargeable,onChange:r=>d({...t,travel_chargeable:r.target.checked}),style:{width:"16px",height:"16px",accentColor:"#2563eb"}}),e.jsx("span",{style:{fontSize:"0.85rem",color:"#1e40af"},children:"Chargeable to Customer"})]}),x(["admin","supplier_pm"])&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.85rem",color:"#1e40af"},children:"Paid by:"}),e.jsxs("select",{value:t.travel_procurement,onChange:r=>d({...t,travel_procurement:r.target.value}),style:{padding:"0.25rem 0.5rem",borderRadius:"4px",border:"1px solid #93c5fd",fontSize:"0.85rem",backgroundColor:"#fff"},children:[e.jsx("option",{value:"supplier",children:"Supplier (JT)"}),e.jsx("option",{value:"partner",children:"Partner"})]})]})]})]}),e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#f3e8ff",borderRadius:"8px",marginBottom:"1rem"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",color:"#7c3aed",marginBottom:"0.75rem"},children:[e.jsx(Ce,{size:20}),e.jsx("span",{style:{fontWeight:"600",fontSize:"1rem"},children:"Accommodation"})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"150px 1fr",gap:"1rem",marginBottom:"0.75rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Amount (Â£)"}),e.jsx("input",{type:"number",step:"0.01",className:"form-input",placeholder:"0.00",value:t.accommodation_amount,onChange:r=>d({...t,accommodation_amount:r.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Reason / Description"}),e.jsx("input",{type:"text",className:"form-input",placeholder:"e.g., Hotel stay 2 nights London",value:t.accommodation_reason,onChange:r=>d({...t,accommodation_reason:r.target.value})})]})]}),parseFloat(t.accommodation_amount)>0&&e.jsxs("div",{style:{display:"flex",gap:"1.5rem",flexWrap:"wrap",paddingTop:"0.75rem",borderTop:"1px solid #d8b4fe"},children:[e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"0.5rem",cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:t.accommodation_chargeable,onChange:r=>d({...t,accommodation_chargeable:r.target.checked}),style:{width:"16px",height:"16px",accentColor:"#7c3aed"}}),e.jsx("span",{style:{fontSize:"0.85rem",color:"#6b21a8"},children:"Chargeable to Customer"})]}),x(["admin","supplier_pm"])&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.85rem",color:"#6b21a8"},children:"Paid by:"}),e.jsxs("select",{value:t.accommodation_procurement,onChange:r=>d({...t,accommodation_procurement:r.target.value}),style:{padding:"0.25rem 0.5rem",borderRadius:"4px",border:"1px solid #d8b4fe",fontSize:"0.85rem",backgroundColor:"#fff"},children:[e.jsx("option",{value:"supplier",children:"Supplier (JT)"}),e.jsx("option",{value:"partner",children:"Partner"})]})]})]})]}),e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#ffedd5",borderRadius:"8px",marginBottom:"1rem"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",color:"#ea580c",marginBottom:"0.75rem"},children:[e.jsx(Se,{size:20}),e.jsx("span",{style:{fontWeight:"600",fontSize:"1rem"},children:"Sustenance"})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"150px 1fr",gap:"1rem",marginBottom:"0.75rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Amount (Â£)"}),e.jsx("input",{type:"number",step:"0.01",className:"form-input",placeholder:"0.00",value:t.sustenance_amount,onChange:r=>d({...t,sustenance_amount:r.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Reason / Description"}),e.jsx("input",{type:"text",className:"form-input",placeholder:"e.g., Lunch during site visit",value:t.sustenance_reason,onChange:r=>d({...t,sustenance_reason:r.target.value})})]})]}),parseFloat(t.sustenance_amount)>0&&e.jsxs("div",{style:{display:"flex",gap:"1.5rem",flexWrap:"wrap",paddingTop:"0.75rem",borderTop:"1px solid #fdba74"},children:[e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"0.5rem",cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:t.sustenance_chargeable,onChange:r=>d({...t,sustenance_chargeable:r.target.checked}),style:{width:"16px",height:"16px",accentColor:"#ea580c"}}),e.jsx("span",{style:{fontSize:"0.85rem",color:"#c2410c"},children:"Chargeable to Customer"})]}),x(["admin","supplier_pm"])&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.85rem",color:"#c2410c"},children:"Paid by:"}),e.jsxs("select",{value:t.sustenance_procurement,onChange:r=>d({...t,sustenance_procurement:r.target.value}),style:{padding:"0.25rem 0.5rem",borderRadius:"4px",border:"1px solid #fdba74",fontSize:"0.85rem",backgroundColor:"#fff"},children:[e.jsx("option",{value:"supplier",children:"Supplier (JT)"}),e.jsx("option",{value:"partner",children:"Partner"})]})]})]})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{className:"form-label",children:"Additional Notes"}),e.jsx("textarea",{className:"form-input",rows:2,placeholder:"Any additional information...",value:t.notes,onChange:r=>d({...t,notes:r.target.value})})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{className:"form-label",children:"Attach Receipts"}),e.jsxs("div",{style:{border:"2px dashed #d1d5db",borderRadius:"8px",padding:"1.5rem",textAlign:"center",cursor:"pointer",backgroundColor:"#f9fafb"},onClick:()=>document.getElementById("file-upload").click(),children:[e.jsx(xr,{size:24,style:{color:"#9ca3af",marginBottom:"0.5rem"}}),e.jsx("div",{style:{color:"#64748b",fontSize:"0.85rem"},children:"Click to upload receipts"}),e.jsx("div",{style:{color:"#9ca3af",fontSize:"0.75rem"},children:"PDF, JPG, PNG, ZIP"}),e.jsx("input",{id:"file-upload",type:"file",multiple:!0,accept:".pdf,.jpg,.jpeg,.png,.zip",style:{display:"none"},onChange:Je})]}),t.files.length>0&&e.jsx("div",{style:{marginTop:"0.5rem"},children:t.files.map((r,a)=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.25rem 0",fontSize:"0.85rem"},children:[e.jsx(cr,{size:14}),e.jsx("span",{style:{flex:1},children:r.name}),e.jsx("button",{onClick:()=>He(a),style:{background:"none",border:"none",cursor:"pointer",color:"#ef4444"},children:e.jsx(N,{size:14})})]},a))})]}),(parseFloat(t.travel_amount)>0||parseFloat(t.accommodation_amount)>0||parseFloat(t.sustenance_amount)>0)&&e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#f0fdf4",borderRadius:"8px",marginBottom:"1rem"},children:[e.jsx("div",{style:{fontWeight:"600",color:"#166534",marginBottom:"0.75rem"},children:"Summary"}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"0.5rem"},children:[parseFloat(t.travel_amount)>0&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",flexWrap:"wrap"},children:[e.jsxs("span",{style:{fontWeight:"500",minWidth:"120px"},children:["Travel: Â£",parseFloat(t.travel_amount).toFixed(2)]}),e.jsx("span",{style:{fontSize:"0.8rem",padding:"0.15rem 0.5rem",borderRadius:"4px",backgroundColor:t.travel_chargeable?"#dcfce7":"#fef3c7",color:t.travel_chargeable?"#166534":"#92400e"},children:t.travel_chargeable?"Chargeable":"Non-chargeable"}),x(["admin","supplier_pm"])&&e.jsx("span",{style:{fontSize:"0.8rem",padding:"0.15rem 0.5rem",borderRadius:"4px",backgroundColor:t.travel_procurement==="partner"?"#f3e8ff":"#e0e7ff",color:t.travel_procurement==="partner"?"#7c3aed":"#4338ca"},children:t.travel_procurement==="partner"?"Partner":"Supplier"})]}),parseFloat(t.accommodation_amount)>0&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",flexWrap:"wrap"},children:[e.jsxs("span",{style:{fontWeight:"500",minWidth:"120px"},children:["Accommodation: Â£",parseFloat(t.accommodation_amount).toFixed(2)]}),e.jsx("span",{style:{fontSize:"0.8rem",padding:"0.15rem 0.5rem",borderRadius:"4px",backgroundColor:t.accommodation_chargeable?"#dcfce7":"#fef3c7",color:t.accommodation_chargeable?"#166534":"#92400e"},children:t.accommodation_chargeable?"Chargeable":"Non-chargeable"}),x(["admin","supplier_pm"])&&e.jsx("span",{style:{fontSize:"0.8rem",padding:"0.15rem 0.5rem",borderRadius:"4px",backgroundColor:t.accommodation_procurement==="partner"?"#f3e8ff":"#e0e7ff",color:t.accommodation_procurement==="partner"?"#7c3aed":"#4338ca"},children:t.accommodation_procurement==="partner"?"Partner":"Supplier"})]}),parseFloat(t.sustenance_amount)>0&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",flexWrap:"wrap"},children:[e.jsxs("span",{style:{fontWeight:"500",minWidth:"120px"},children:["Sustenance: Â£",parseFloat(t.sustenance_amount).toFixed(2)]}),e.jsx("span",{style:{fontSize:"0.8rem",padding:"0.15rem 0.5rem",borderRadius:"4px",backgroundColor:t.sustenance_chargeable?"#dcfce7":"#fef3c7",color:t.sustenance_chargeable?"#166534":"#92400e"},children:t.sustenance_chargeable?"Chargeable":"Non-chargeable"}),x(["admin","supplier_pm"])&&e.jsx("span",{style:{fontSize:"0.8rem",padding:"0.15rem 0.5rem",borderRadius:"4px",backgroundColor:t.sustenance_procurement==="partner"?"#f3e8ff":"#e0e7ff",color:t.sustenance_procurement==="partner"?"#7c3aed":"#4338ca"},children:t.sustenance_procurement==="partner"?"Partner":"Supplier"})]}),e.jsxs("div",{style:{fontWeight:"700",color:"#166534",marginTop:"0.5rem",paddingTop:"0.5rem",borderTop:"1px solid #86efac"},children:["Total: Â£",((parseFloat(t.travel_amount)||0)+(parseFloat(t.accommodation_amount)||0)+(parseFloat(t.sustenance_amount)||0)).toFixed(2)]})]})]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsxs("button",{className:"btn btn-primary",onClick:Be,disabled:ce,children:[e.jsx(se,{size:16})," ",ce?"Uploading...":"Save Expenses"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:()=>q(!1),children:[e.jsx(N,{size:16})," Cancel"]})]})]}),e.jsx("div",{className:"card",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Ref"}),e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Resource"}),e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Reason"}),e.jsx("th",{style:{textAlign:"right"},children:"Amount"}),e.jsx("th",{children:"Chargeable"}),x(["admin","supplier_pm"])&&e.jsx("th",{children:"Procured By"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Receipts"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:he.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:x(["admin","supplier_pm"])?11:10,style:{textAlign:"center",color:"#64748b",padding:"2rem"},children:"No expenses found."})}):he.map(r=>{var i;const a=O(r.category),s=r.chargeable_to_customer!==!1;return e.jsxs("tr",{style:{backgroundColor:s?"inherit":"#fffbeb",cursor:j===r.id?"default":"pointer"},onClick:()=>{j!==r.id&&g({isOpen:!0,expense:r})},children:[e.jsx("td",{style:{fontFamily:"monospace",fontSize:"0.85rem"},children:r.expense_ref||"-"}),e.jsx("td",{children:j===r.id?e.jsxs("select",{className:"form-input",value:l.category,onChange:n=>v({...l,category:n.target.value}),children:[e.jsx("option",{value:"Travel",children:"Travel"}),e.jsx("option",{value:"Accommodation",children:"Accommodation"}),e.jsx("option",{value:"Sustenance",children:"Sustenance"})]}):e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.85rem",backgroundColor:a.bg,color:a.color},children:[ee(r.category),r.category]})}),e.jsx("td",{children:j===r.id?e.jsxs("select",{className:"form-input",value:l.resource_id||"",onChange:n=>v({...l,resource_id:n.target.value}),children:[e.jsx("option",{value:"",children:"-- Select --"}),w.map(n=>e.jsx("option",{value:n.id,children:n.name},n.id))]}):r.resource_name}),e.jsx("td",{children:j===r.id?e.jsx("input",{type:"date",className:"form-input",value:l.expense_date,onChange:n=>v({...l,expense_date:n.target.value})}):new Date(r.expense_date).toLocaleDateString("en-GB")}),e.jsx("td",{style:{maxWidth:"200px"},children:j===r.id?e.jsx("input",{type:"text",className:"form-input",value:l.reason,onChange:n=>v({...l,reason:n.target.value})}):e.jsx("div",{style:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:r.reason})}),e.jsx("td",{style:{textAlign:"right",fontWeight:"600"},children:j===r.id?e.jsx("input",{type:"number",step:"0.01",className:"form-input",value:l.amount,onChange:n=>v({...l,amount:n.target.value}),style:{width:"100px",textAlign:"right"}}):`Â£${parseFloat(r.amount).toFixed(2)}`}),e.jsx("td",{children:j===r.id&&Ve()?e.jsx("label",{style:{display:"flex",alignItems:"center",gap:"0.5rem",cursor:"pointer"},children:e.jsx("input",{type:"checkbox",checked:l.chargeable_to_customer,onChange:n=>v({...l,chargeable_to_customer:n.target.checked}),style:{width:"18px",height:"18px"}})}):e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.75rem",fontWeight:"500",backgroundColor:s?"#dcfce7":"#fef3c7",color:s?"#166534":"#92400e"},children:[s?e.jsx(dr,{size:12}):e.jsx(N,{size:12}),s?"Yes":"No"]})}),x(["admin","supplier_pm"])&&e.jsx("td",{children:j===r.id?e.jsxs("select",{className:"form-input",value:l.procurement_method||"supplier",onChange:n=>v({...l,procurement_method:n.target.value}),style:{fontSize:"0.85rem",padding:"0.25rem"},children:[e.jsx("option",{value:"supplier",children:"Supplier"}),e.jsx("option",{value:"partner",children:"Partner"})]}):e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.75rem",fontWeight:"500",backgroundColor:(r.procurement_method||"supplier")==="partner"?"#f3e8ff":"#e0e7ff",color:(r.procurement_method||"supplier")==="partner"?"#7c3aed":"#4338ca"},children:[(r.procurement_method||"supplier")==="partner"?e.jsx(ae,{size:12}):e.jsx(te,{size:12}),(r.procurement_method||"supplier")==="partner"?"Partner":"Supplier"]})}),e.jsx("td",{children:j===r.id&&oe(r)?e.jsx("select",{className:"form-input",value:l.status,onChange:n=>v({...l,status:n.target.value}),children:me.map(n=>e.jsx("option",{value:n,children:L[n]||n},n))}):e.jsx("span",{className:`status-badge ${ue(r.status)}`,children:L[r.status]||r.status})}),e.jsx("td",{onClick:n=>n.stopPropagation(),children:((i=r.expense_files)==null?void 0:i.length)>0?e.jsx("div",{style:{display:"flex",gap:"0.25rem"},children:r.expense_files.map((n,c)=>e.jsx("button",{onClick:()=>pe(n.file_path,n.file_name),style:{background:"none",border:"none",cursor:"pointer",color:"#3b82f6"},title:n.file_name,children:e.jsx(ye,{size:16})},c))}):"-"}),e.jsx("td",{onClick:n=>n.stopPropagation(),children:j===r.id?e.jsxs("div",{className:"action-buttons",children:[e.jsx("button",{className:"btn-icon btn-success",onClick:()=>Le(r.id),children:e.jsx(se,{size:16})}),e.jsx("button",{className:"btn-icon btn-secondary",onClick:()=>J(null),children:e.jsx(N,{size:16})})]}):e.jsxs("div",{className:"action-buttons",children:[ze(r)&&e.jsx("button",{className:"btn-icon",onClick:()=>$e(r.id),title:"Submit for Validation",style:{color:"#3b82f6"},children:e.jsx(mr,{size:16})}),oe(r)&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn-icon btn-success",onClick:()=>Ue(r.id),title:"Validate",children:e.jsx(M,{size:16})}),e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>qe(r.id),title:"Reject",children:e.jsx(N,{size:16})})]}),le(r)&&e.jsx("button",{className:"btn-icon",onClick:()=>We(r),title:"Edit",children:e.jsx(_e,{size:16})}),we(r)&&e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>Oe(r),title:"Delete",children:e.jsx(pr,{size:16})})]})})]},r.id)})})]})}),e.jsxs("div",{className:"card",style:{marginTop:"1.5rem",backgroundColor:"#fffbeb",borderLeft:"4px solid #f59e0b"},children:[e.jsx("h4",{style:{marginBottom:"0.5rem",color:"#92400e"},children:"ðŸ“‹ Expense Guidelines"}),e.jsxs("ul",{style:{margin:"0.5rem 0 0 1.5rem",color:"#92400e",fontSize:"0.9rem"},children:[e.jsx("li",{children:"PMO travel/accommodation requires advance approval from Authority Project Manager"}),e.jsx("li",{children:"Attach receipts for all expenses over Â£25"}),e.jsx("li",{children:"Submit expenses within 30 days of incurring them"}),e.jsxs("li",{children:[e.jsx("strong",{children:"Submit:"})," Click the send icon to submit for validation"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Chargeable expenses:"})," Validated by Customer PM"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Non-chargeable expenses:"})," Validated by Supplier PM"]}),ne==="customer_pm"&&e.jsxs("li",{children:[e.jsx("strong",{children:"As Customer PM:"})," You can validate or reject chargeable expenses"]}),ne==="supplier_pm"&&e.jsxs("li",{children:[e.jsx("strong",{children:"As Supplier PM:"})," You can validate or reject non-chargeable expenses"]})]})]}),e.jsx(hr,{isOpen:f.isOpen,onClose:()=>Q({isOpen:!1,expenseId:null,expenseData:null}),onConfirm:Me,title:"Delete Expense",message:f.expenseData?e.jsxs("div",{children:[e.jsx("p",{children:"Are you sure you want to delete this expense?"}),e.jsxs("div",{style:{backgroundColor:"#fef3c7",border:"1px solid #f59e0b",borderRadius:"6px",padding:"0.75rem",marginTop:"0.75rem"},children:[e.jsx("p",{style:{fontWeight:"600",color:"#92400e",margin:"0 0 0.5rem 0"},children:"Impact on Running Totals:"}),e.jsxs("ul",{style:{margin:"0",paddingLeft:"1.25rem",color:"#92400e",fontSize:"0.9rem"},children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Resource:"})," ",f.expenseData.resourceName]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Date:"})," ",f.expenseData.date]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Total Amount:"})," -Â£",(fe=f.expenseData.totalAmount)==null?void 0:fe.toLocaleString("en-GB",{minimumFractionDigits:2})]}),((be=f.expenseData.categories)==null?void 0:be.length)>0&&e.jsxs("li",{children:[e.jsx("strong",{children:"Breakdown:"})," ",f.expenseData.categories.join(", ")]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Chargeable:"})," ",f.expenseData.chargeable?"Yes":"No"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Paid by:"})," ",f.expenseData.procurement==="partner"?"Partner":"Supplier (JT)"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Status:"})," ",f.expenseData.status]})]})]}),e.jsx("p",{style:{marginTop:"0.75rem",fontSize:"0.85rem",color:"#6b7280"},children:"This will permanently remove this expense from all reports and partner invoices."})]}):"Are you sure you want to delete this expense?",confirmText:"Delete",cancelText:"Cancel",variant:"danger"}),h.isOpen&&h.expense&&(()=>{var T,E;const r=h.expense,a=h.editMode,s=h.editData||{},i=w.find(o=>o.id===r.resource_id),n=((T=i==null?void 0:i.partner)==null?void 0:T.name)||null,c=o=>{var P;const p=w.find(I=>I.id===o);return((P=p==null?void 0:p.partner)==null?void 0:P.name)||null},F=a?s.resource_id:r.resource_id,S=c(F),_=a?s.procurement_method:r.procurement_method||"supplier";return e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},onClick:()=>g({isOpen:!1,expense:null,editMode:!1,editData:null}),children:e.jsxs("div",{style:{backgroundColor:"white",borderRadius:"12px",padding:"1.5rem",width:"90%",maxWidth:"650px",maxHeight:"90vh",overflowY:"auto",boxShadow:"0 20px 25px -5px rgba(0, 0, 0, 0.1)"},onClick:o=>o.stopPropagation(),children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:"1.5rem"},children:[e.jsxs("div",{children:[e.jsx("h2",{style:{margin:0,fontSize:"1.25rem"},children:a?"Edit Expense":"Expense Details"}),e.jsx("span",{style:{fontFamily:"monospace",fontSize:"0.9rem",color:"#6b7280",marginTop:"0.25rem",display:"block"},children:r.expense_ref||"No Reference"})]}),e.jsx("button",{onClick:()=>g({isOpen:!1,expense:null,editMode:!1,editData:null}),style:{background:"none",border:"none",cursor:"pointer",padding:"0.25rem",color:"#6b7280"},children:e.jsx(N,{size:24})})]}),e.jsx("div",{style:{marginBottom:"1.5rem"},children:e.jsx("span",{className:`status-badge ${ue(r.status)}`,style:{fontSize:"0.9rem",padding:"0.35rem 0.75rem"},children:L[r.status]||r.status})}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem",marginBottom:"1.5rem"},children:[e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#f8fafc",borderRadius:"8px"},children:[e.jsx("label",{style:{fontSize:"0.75rem",color:"#6b7280",textTransform:"uppercase",fontWeight:"600"},children:"Category"}),a?e.jsxs("select",{value:s.category,onChange:o=>g({...h,editData:{...s,category:o.target.value}}),style:{width:"100%",marginTop:"0.5rem",padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"Travel",children:"Travel"}),e.jsx("option",{value:"Accommodation",children:"Accommodation"}),e.jsx("option",{value:"Sustenance",children:"Sustenance"})]}):e.jsx("div",{style:{marginTop:"0.5rem",display:"flex",alignItems:"center",gap:"0.5rem"},children:e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.35rem 0.75rem",borderRadius:"6px",fontSize:"0.9rem",backgroundColor:O(r.category).bg,color:O(r.category).color},children:[ee(r.category),r.category]})})]}),e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#f8fafc",borderRadius:"8px"},children:[e.jsx("label",{style:{fontSize:"0.75rem",color:"#6b7280",textTransform:"uppercase",fontWeight:"600"},children:"Amount"}),a?e.jsxs("div",{style:{marginTop:"0.5rem",display:"flex",alignItems:"center"},children:[e.jsx("span",{style:{marginRight:"0.25rem",fontWeight:"600"},children:"Â£"}),e.jsx("input",{type:"number",step:"0.01",value:s.amount,onChange:o=>g({...h,editData:{...s,amount:o.target.value}}),style:{width:"100%",padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db",fontSize:"1.25rem",fontWeight:"600"}})]}):e.jsxs("p",{style:{margin:"0.5rem 0 0 0",fontSize:"1.5rem",fontWeight:"700",color:"#059669"},children:["Â£",parseFloat(r.amount).toLocaleString("en-GB",{minimumFractionDigits:2})]})]}),e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#f8fafc",borderRadius:"8px"},children:[e.jsx("label",{style:{fontSize:"0.75rem",color:"#6b7280",textTransform:"uppercase",fontWeight:"600"},children:"Resource"}),a?e.jsxs("select",{value:s.resource_id,onChange:o=>{const p=o.target.value,I=c(p)?s.procurement_method:"supplier";g({...h,editData:{...s,resource_id:p,procurement_method:I}})},style:{width:"100%",marginTop:"0.5rem",padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"",children:"-- Select Resource --"}),w.map(o=>{var p;return e.jsxs("option",{value:o.id,children:[o.name," ",(p=o.partner)!=null&&p.name?`(${o.partner.name})`:""]},o.id)})]}):e.jsxs("p",{style:{margin:"0.5rem 0 0 0",fontWeight:"500",display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(je,{size:16,style:{color:"#6b7280"}}),r.resource_name,n&&e.jsxs("span",{style:{fontSize:"0.75rem",color:"#6b7280",marginLeft:"0.25rem"},children:["(",n,")"]})]})]}),e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#f8fafc",borderRadius:"8px"},children:[e.jsx("label",{style:{fontSize:"0.75rem",color:"#6b7280",textTransform:"uppercase",fontWeight:"600"},children:"Expense Date"}),a?e.jsx("input",{type:"date",value:s.expense_date,onChange:o=>g({...h,editData:{...s,expense_date:o.target.value}}),style:{width:"100%",marginTop:"0.5rem",padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"}}):e.jsx("p",{style:{margin:"0.5rem 0 0 0",fontWeight:"500"},children:new Date(r.expense_date).toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"long",year:"numeric"})})]}),e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#f8fafc",borderRadius:"8px"},children:[e.jsx("label",{style:{fontSize:"0.75rem",color:"#6b7280",textTransform:"uppercase",fontWeight:"600"},children:"Chargeable to Customer"}),a?e.jsx("div",{style:{marginTop:"0.5rem"},children:e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"0.5rem",cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:s.chargeable_to_customer,onChange:o=>g({...h,editData:{...s,chargeable_to_customer:o.target.checked}}),style:{width:"20px",height:"20px"}}),e.jsx("span",{style:{fontWeight:"500"},children:s.chargeable_to_customer?"Yes":"No"})]})}):e.jsx("p",{style:{margin:"0.5rem 0 0 0",fontWeight:"500",display:"flex",alignItems:"center",gap:"0.5rem",color:r.chargeable_to_customer?"#059669":"#dc2626"},children:r.chargeable_to_customer?e.jsxs(e.Fragment,{children:[e.jsx(M,{size:18})," Yes"]}):e.jsxs(e.Fragment,{children:[e.jsx(N,{size:18})," No"]})})]}),e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#f8fafc",borderRadius:"8px"},children:[e.jsx("label",{style:{fontSize:"0.75rem",color:"#6b7280",textTransform:"uppercase",fontWeight:"600"},children:"Procured By"}),a?e.jsxs("div",{children:[e.jsxs("select",{value:s.procurement_method,onChange:o=>g({...h,editData:{...s,procurement_method:o.target.value}}),style:{width:"100%",marginTop:"0.5rem",padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},disabled:!S,children:[e.jsx("option",{value:"supplier",children:"Supplier (JT)"}),S&&e.jsxs("option",{value:"partner",children:["Partner (",S,")"]})]}),!S&&e.jsx("p",{style:{fontSize:"0.75rem",color:"#6b7280",marginTop:"0.25rem",fontStyle:"italic"},children:"Resource has no linked partner"}),S&&s.procurement_method==="partner"&&e.jsxs("p",{style:{fontSize:"0.75rem",color:"#7c3aed",marginTop:"0.25rem"},children:[S," will invoice JT for this expense"]})]}):e.jsxs("div",{style:{margin:"0.5rem 0 0 0"},children:[e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.35rem 0.75rem",borderRadius:"6px",fontSize:"0.85rem",fontWeight:"500",backgroundColor:_==="partner"?"#f3e8ff":"#e0e7ff",color:_==="partner"?"#7c3aed":"#4338ca"},children:[_==="partner"?e.jsx(ae,{size:14}):e.jsx(te,{size:14}),_==="partner"?`Partner (${n||"Unknown"})`:"Supplier (JT)"]}),_==="partner"&&n&&e.jsxs("p",{style:{fontSize:"0.75rem",color:"#7c3aed",marginTop:"0.5rem"},children:[n," will invoice JT for this expense"]})]})]})]}),e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#f8fafc",borderRadius:"8px",marginBottom:"1rem"},children:[e.jsx("label",{style:{fontSize:"0.75rem",color:"#6b7280",textTransform:"uppercase",fontWeight:"600"},children:"Reason / Description"}),a?e.jsx("textarea",{value:s.reason||"",onChange:o=>g({...h,editData:{...s,reason:o.target.value}}),rows:3,style:{width:"100%",marginTop:"0.5rem",padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db",resize:"vertical"},placeholder:"Enter reason for expense..."}):e.jsx("p",{style:{margin:"0.5rem 0 0 0",lineHeight:"1.5"},children:r.reason||e.jsx("span",{style:{color:"#9ca3af",fontStyle:"italic"},children:"No description provided"})})]}),e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#f8fafc",borderRadius:"8px",marginBottom:"1rem"},children:[e.jsx("label",{style:{fontSize:"0.75rem",color:"#6b7280",textTransform:"uppercase",fontWeight:"600"},children:"Additional Notes"}),a?e.jsx("textarea",{value:s.notes||"",onChange:o=>g({...h,editData:{...s,notes:o.target.value}}),rows:2,style:{width:"100%",marginTop:"0.5rem",padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db",resize:"vertical"},placeholder:"Optional notes..."}):e.jsx("p",{style:{margin:"0.5rem 0 0 0",lineHeight:"1.5"},children:r.notes||e.jsx("span",{style:{color:"#9ca3af",fontStyle:"italic"},children:"No notes"})})]}),!a&&((E=r.expense_files)==null?void 0:E.length)>0&&e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#f8fafc",borderRadius:"8px",marginBottom:"1rem"},children:[e.jsx("label",{style:{fontSize:"0.75rem",color:"#6b7280",textTransform:"uppercase",fontWeight:"600"},children:"Receipts"}),e.jsx("div",{style:{marginTop:"0.5rem",display:"flex",flexWrap:"wrap",gap:"0.5rem"},children:r.expense_files.map((o,p)=>e.jsxs("button",{onClick:()=>pe(o.file_path,o.file_name),style:{display:"inline-flex",alignItems:"center",gap:"0.5rem",padding:"0.5rem 0.75rem",backgroundColor:"#dbeafe",color:"#1d4ed8",border:"none",borderRadius:"6px",cursor:"pointer",fontSize:"0.85rem"},children:[e.jsx(ye,{size:14}),o.file_name]},p))})]}),e.jsx("div",{style:{display:"flex",justifyContent:"flex-end",gap:"0.75rem",marginTop:"1.5rem",paddingTop:"1rem",borderTop:"1px solid #e5e7eb"},children:a?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>g({...h,editMode:!1,editData:null}),style:{padding:"0.5rem 1rem",backgroundColor:"#f1f5f9",color:"#475569",border:"1px solid #cbd5e1",borderRadius:"6px",cursor:"pointer",fontSize:"0.875rem"},children:"Cancel"}),e.jsxs("button",{onClick:async()=>{var o;try{const p=((o=w.find(I=>I.id===s.resource_id))==null?void 0:o.name)||r.resource_name,{error:P}=await b.from("expenses").update({category:s.category,resource_id:s.resource_id,resource_name:p,expense_date:s.expense_date,reason:s.reason,amount:parseFloat(s.amount),notes:s.notes,chargeable_to_customer:s.chargeable_to_customer,procurement_method:s.procurement_method}).eq("id",r.id);if(P)throw P;await C(),g({isOpen:!1,expense:null,editMode:!1,editData:null}),A("Expense updated!")}catch(p){console.error("Error updating expense:",p),z("Failed to update: "+p.message)}},style:{display:"inline-flex",alignItems:"center",gap:"0.5rem",padding:"0.5rem 1rem",backgroundColor:"#10b981",color:"white",border:"none",borderRadius:"6px",cursor:"pointer",fontSize:"0.875rem"},children:[e.jsx(se,{size:16}),"Save Changes"]})]}):e.jsxs(e.Fragment,{children:[le(r)&&e.jsxs("button",{onClick:()=>{g({...h,editMode:!0,editData:{category:r.category,resource_id:r.resource_id,expense_date:r.expense_date,reason:r.reason||"",amount:r.amount,notes:r.notes||"",chargeable_to_customer:r.chargeable_to_customer!==!1,procurement_method:r.procurement_method||"supplier"}})},style:{display:"inline-flex",alignItems:"center",gap:"0.5rem",padding:"0.5rem 1rem",backgroundColor:"#f1f5f9",color:"#475569",border:"1px solid #cbd5e1",borderRadius:"6px",cursor:"pointer",fontSize:"0.875rem"},children:[e.jsx(_e,{size:16}),"Edit"]}),e.jsx("button",{onClick:()=>g({isOpen:!1,expense:null,editMode:!1,editData:null}),style:{padding:"0.5rem 1rem",backgroundColor:"#3b82f6",color:"white",border:"none",borderRadius:"6px",cursor:"pointer",fontSize:"0.875rem"},children:"Close"})]})})]})})})()]})}export{kr as default};
