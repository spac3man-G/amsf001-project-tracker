import{s as L,u as $e,a as Ue,b as Le,j as e,c as ut,e as Y,L as mt,P as pt,S as H}from"./index-C6UUkHga.js";import{r as f}from"./vendor-react-CaXNtsgv.js";import{u as ht}from"./usePermissions-Bty26PMP.js";import{C as gt}from"./ConfirmDialog-lhwBZBSC.js";import{g as fe,a as te,ag as xe,ah as Se,ai as ft,T as Me,S as je,aj as xt,L as ze,e as ee,v as be,_ as jt,d as Fe,ak as Re,al as we,am as Ae,t as bt,V as yt,C as We,N as Ge,l as Ye,U as vt,F as _t,y as Ve,an as Ct,b as St,W as Nt}from"./vendor-icons--BgpcKrK.js";import"./vendor-supabase-qY1sfceY.js";import"./vendor-charts-_mIYJ_kN.js";const Rt={uber:"Travel",lyft:"Travel",taxi:"Travel",train:"Travel",rail:"Travel",airlines:"Travel",airways:"Travel",petrol:"Travel","gas station":"Travel",fuel:"Travel",parking:"Travel",hotel:"Accommodation",inn:"Accommodation",motel:"Accommodation",airbnb:"Accommodation","booking.com":"Accommodation",marriott:"Accommodation",hilton:"Accommodation","premier inn":"Accommodation",travelodge:"Accommodation",restaurant:"Sustenance",cafe:"Sustenance",coffee:"Sustenance",costa:"Sustenance",starbucks:"Sustenance",pret:"Sustenance",greggs:"Sustenance",mcdonald:"Sustenance",subway:"Sustenance",nando:"Sustenance",pizza:"Sustenance",pub:"Sustenance",bar:"Sustenance",food:"Sustenance",supermarket:"Sustenance",tesco:"Sustenance",sainsbury:"Sustenance","co-op":"Sustenance",waitrose:"Sustenance",aldi:"Sustenance",lidl:"Sustenance"};class wt{constructor(){this.bucketName="receipt-scans"}async uploadImage(o,n){try{if(!["image/jpeg","image/png","image/webp","image/heic"].includes(o.type))throw new Error("Invalid file type. Please upload a JPEG, PNG, or WebP image.");const l=10*1024*1024;if(o.size>l)throw new Error("File too large. Maximum size is 10MB.");const h=Date.now(),C=o.name.split(".").pop(),N=`${n}/${h}.${C}`,{error:v}=await L.storage.from(this.bucketName).upload(N,o);if(v)throw v;const{data:{publicUrl:d}}=L.storage.from(this.bucketName).getPublicUrl(N);return{path:N,url:d}}catch(s){throw s}}async processReceipt(o,n){const s=Date.now();try{const l=await this.callClaudeVision(o);let h=await this.findClassificationRule(n,l.merchant);h||(h=this.classifyFromPatterns(l.merchant),!h&&l.aiSuggestedCategory&&(h={category:l.aiSuggestedCategory,confidence:l.aiConfidence||.6}));const C=Date.now()-s;return{...l,suggestedCategory:h?.category||null,confidence:h?.confidence||0,ruleBasedClassification:!!h?.ruleId,processingTimeMs:C}}catch(l){throw l}}async fetchImageAsBase64(o){try{const s=await(await fetch(o)).blob();return new Promise((l,h)=>{const C=new FileReader;C.onloadend=()=>{const N=C.result.split(",")[1];l({data:N,mediaType:s.type})},C.onerror=h,C.readAsDataURL(s)})}catch(n){throw n}}async callClaudeVision(o){const n=`Analyze this receipt image and extract the following information in JSON format:
{
  "merchant": "Store/vendor name",
  "amount": 0.00,
  "currency": "GBP",
  "date": "YYYY-MM-DD",
  "items": [{"name": "item name", "quantity": 1, "price": 0.00}],
  "paymentMethod": "card/cash/unknown",
  "category": "Travel/Accommodation/Sustenance",
  "confidence": 0.0 to 1.0,
  "rawText": "All visible text from receipt"
}

If any field cannot be determined, use null. For the category, consider:
- Travel: transport, fuel, parking, flights, trains, taxis
- Accommodation: hotels, lodging, rentals
- Sustenance: food, drinks, restaurants, cafes, supermarkets

Be conservative with confidence - only use high values (>0.8) when very certain.`;try{const s=await fetch("/api/scan-receipt",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({image:o,prompt:n})});if(!s.ok)throw new Error("Failed to process receipt with AI");const l=await s.json();return{merchant:l.merchant,amount:l.amount,currency:l.currency||"GBP",date:l.date,items:l.items||[],paymentMethod:l.paymentMethod,aiSuggestedCategory:l.category,aiConfidence:l.confidence,rawText:l.rawText}}catch(s){return{merchant:null,amount:null,currency:"GBP",date:null,items:[],paymentMethod:null,aiSuggestedCategory:null,aiConfidence:0,rawText:null,error:s.message}}}async findClassificationRule(o,n){if(!n)return null;try{const{data:s,error:l}=await L.rpc("find_classification_rule",{p_project_id:o,p_merchant:n});if(l)throw l;return s&&s.length>0?{ruleId:s[0].rule_id,category:s[0].category,subcategory:s[0].subcategory,defaultChargeable:s[0].default_chargeable,defaultProcurement:s[0].default_procurement,confidence:parseFloat(s[0].confidence)}:null}catch{return null}}classifyFromPatterns(o){if(!o)return null;const n=o.toLowerCase();for(const[s,l]of Object.entries(Rt))if(n.includes(s))return{category:l,confidence:.7,source:"pattern"};return null}async learnFromCorrection(o,n,s,l,h=!1){if(!n||!s)return null;try{const{data:C,error:N}=await L.rpc("upsert_classification_rule",{p_project_id:o,p_merchant:n,p_category:s,p_user_id:l,p_was_correction:h});if(N)throw N;return C}catch{return null}}async createScan(o){try{const{data:n,error:s}=await L.from("receipt_scans").insert({project_id:o.projectId,uploaded_by:o.userId,image_url:o.imageUrl,image_path:o.imagePath,raw_ocr_text:o.rawText,extracted_merchant:o.merchant,extracted_amount:o.amount,extracted_date:o.date,extracted_currency:o.currency,extracted_items:o.items,ai_suggested_category:o.suggestedCategory,ai_confidence:o.confidence,status:"completed",processing_time_ms:o.processingTimeMs}).select().single();if(s)throw s;return n}catch(n){throw n}}async updateScanClassification(o,n,s=!1){try{const{data:l,error:h}=await L.from("receipt_scans").update({final_category:n,user_corrected:s}).eq("id",o).select().single();if(h)throw h;return l}catch(l){throw l}}async linkToExpense(o,n){try{const{data:s,error:l}=await L.from("receipt_scans").update({expense_id:n,status:"linked"}).eq("id",o).select().single();if(l)throw l;return s}catch(s){throw s}}async getRecentScans(o,n=10){try{const{data:s,error:l}=await L.from("receipt_scans").select("*").eq("project_id",o).order("created_at",{ascending:!1}).limit(n);if(l)throw l;return s||[]}catch{return[]}}async getUnlinkedScans(o){try{const{data:n,error:s}=await L.from("receipt_scans").select("*").eq("project_id",o).is("expense_id",null).eq("status","completed").order("created_at",{ascending:!1});if(s)throw s;return n||[]}catch{return[]}}async getClassificationRules(o){try{const{data:n,error:s}=await L.from("classification_rules").select("*").eq("project_id",o).order("match_count",{ascending:!1});if(s)throw s;return n||[]}catch{return[]}}async deleteClassificationRule(o){try{const{error:n}=await L.from("classification_rules").delete().eq("id",o);if(n)throw n;return!0}catch{return!1}}}const de=new wt,At=[{id:"Travel",label:"Travel",icon:Re,color:"#2563eb",bg:"#dbeafe"},{id:"Accommodation",label:"Accommodation",icon:we,color:"#7c3aed",bg:"#f3e8ff"},{id:"Sustenance",label:"Sustenance",icon:Ae,color:"#ea580c",bg:"#ffedd5"}],b={PENDING:"pending",PROCESSING:"processing",READY:"ready",SUBMITTED:"submitted",ERROR:"error"},E={UPLOAD:"upload",PROCESSING:"processing",REVIEW:"review"};function kt({onExpenseCreated:a,onCancel:o,resources:n=[],defaultResourceId:s=null}){const{user:l}=$e(),{projectId:h}=Ue(),{showSuccess:C,showError:N,showWarning:v,showInfo:d}=Le(),[w,W]=f.useState(E.UPLOAD),[m,F]=f.useState([]),[x,P]=f.useState(0),[R,X]=f.useState({current:0,total:0}),B=f.useRef(null),re=f.useRef(null),S=m[x];m.filter(r=>r.status===b.READY).length;const V=m.filter(r=>r.status===b.SUBMITTED).length;m.filter(r=>r.status===b.PENDING||r.status===b.PROCESSING).length;const K=(r,c=1500,j=.8)=>new Promise((y,u)=>{const _=new FileReader;_.onload=q=>{const I=new Image;I.onload=()=>{let{width:$,height:k}=I;($>c||k>c)&&($>k?(k=Math.round(k*c/$),$=c):($=Math.round($*c/k),k=c));const J=document.createElement("canvas");J.width=$,J.height=k,J.getContext("2d").drawImage(I,0,0,$,k),J.toBlob(me=>{me?y(me):u(new Error("Failed to compress image"))},"image/jpeg",j)},I.onerror=()=>u(new Error("Failed to load image")),I.src=q.target.result},_.onerror=u,_.readAsDataURL(r)}),M=async r=>{const c=await K(r);return new Promise((j,y)=>{const u=new FileReader;u.onload=()=>{j({data:u.result.split(",")[1],mediaType:"image/jpeg",preview:u.result})},u.onerror=y,u.readAsDataURL(c)})},G=(r,c)=>({id:`receipt-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,file:r,preview:c,status:b.PENDING,scanResult:null,scanId:null,imageUrl:null,formData:{merchant:"",amount:"",date:new Date().toISOString().split("T")[0],category:"",resource_id:s||"",reason:"",chargeable:!0,procurement:"supplier",notes:""},wasEdited:!1}),A=f.useCallback(async r=>{const c=Array.from(r.target.files||[]);if(c.length===0)return;const j=["image/jpeg","image/png","image/webp","image/heic"],y=[];for(const _ of c){if(!j.includes(_.type)){v(`Skipped ${_.name} - invalid file type`);continue}if(_.size>10*1024*1024){v(`Skipped ${_.name} - file too large (max 10MB)`);continue}y.push(_)}if(y.length===0)return;const u=await Promise.all(y.map(async _=>{const{preview:q}=await M(_);return G(_,q)}));F(_=>[..._,...u]),d(`Added ${u.length} receipt${u.length>1?"s":""}`)},[v,d,s]),g=f.useCallback(r=>{r.preventDefault();const c=r.dataTransfer.files;c.length>0&&A({target:{files:c}})},[A]),Q=f.useCallback(r=>{r.preventDefault()},[]),z=f.useCallback(r=>{F(c=>{const j=c.filter(y=>y.id!==r);return x>=j.length&&j.length>0&&P(j.length-1),j})},[x]),se=f.useCallback(()=>{F([]),P(0),W(E.UPLOAD),B.current&&(B.current.value="")},[]),ye=f.useCallback(async()=>{if(m.length===0||!h||!l?.id){N("No receipts to process");return}W(E.PROCESSING),X({current:0,total:m.length});const r=[...m];for(let u=0;u<r.length;u++){const _=r[u];if(_.status===b.READY||_.status===b.SUBMITTED){X({current:u+1,total:m.length});continue}r[u]={..._,status:b.PROCESSING},F([...r]);try{const q=await M(_.file),{path:I,url:$}=await de.uploadImage(_.file,l.id),k=await de.processReceipt(q,h),J=await de.createScan({projectId:h,userId:l.id,imageUrl:$,imagePath:I,...k});r[u]={...r[u],status:b.READY,scanResult:k,scanId:J.id,imageUrl:$,formData:{...r[u].formData,merchant:k.merchant||"",amount:k.amount?.toString()||"",date:k.date||new Date().toISOString().split("T")[0],category:k.suggestedCategory||"",reason:k.merchant?`Receipt from ${k.merchant}`:""}}}catch(q){r[u]={...r[u],status:b.ERROR,error:q.message}}F([...r]),X({current:u+1,total:m.length})}W(E.REVIEW);const c=r.findIndex(u=>u.status===b.READY);c>=0&&P(c);const j=r.filter(u=>u.status===b.READY).length,y=r.filter(u=>u.status===b.ERROR).length;y>0?v(`Processed ${j} receipts, ${y} failed`):C(`Successfully scanned ${j} receipt${j>1?"s":""}!`)},[m,h,l,N,C,v]),O=f.useCallback((r,c)=>{F(j=>{const y=[...j];return y[x]={...y[x],formData:{...y[x].formData,[r]:c},wasEdited:!0},y})},[x]),p=f.useCallback(r=>{O("category",r)},[O]),ae=f.useCallback(r=>{r>=0&&r<m.length&&P(r)},[m.length]),ne=f.useCallback(()=>{for(let r=x-1;r>=0;r--)if(m[r].status===b.READY){P(r);return}},[x,m]),ue=f.useCallback(()=>{for(let r=x+1;r<m.length;r++)if(m[r].status===b.READY){P(r);return}},[x,m]),oe=m.slice(0,x).some(r=>r.status===b.READY),ce=m.slice(x+1).some(r=>r.status===b.READY),le=f.useCallback(async()=>{const r=S;if(!r||r.status!==b.READY)return;const{formData:c}=r;if(!c.resource_id){v("Please select a resource");return}if(!c.amount||parseFloat(c.amount)<=0){v("Please enter a valid amount");return}if(!c.category){v("Please select a category");return}if(!c.reason){v("Please enter a reason/description");return}try{if(c.merchant&&c.category){const u=r.wasEdited&&r.scanResult?.suggestedCategory!==c.category;await de.learnFromCorrection(h,c.merchant,c.category,l.id,u)}r.scanId&&await de.updateScanClassification(r.scanId,c.category,r.wasEdited);const j={category:c.category,resource_id:c.resource_id,resource_name:n.find(u=>u.id===c.resource_id)?.name,expense_date:c.date,reason:c.reason,amount:parseFloat(c.amount),notes:c.notes,chargeable_to_customer:c.chargeable,procurement_method:c.procurement,receipt_scan_id:r.scanId,receipt_image_url:r.imageUrl};F(u=>{const _=[...u];return _[x]={..._[x],status:b.SUBMITTED},_}),a&&a(j),C(`Expense created: ${c.merchant||"Receipt"} - Â£${c.amount}`);const y=m.findIndex((u,_)=>_>x&&u.status===b.READY);y>=0&&P(y)}catch(j){N("Failed to create expense: "+j.message)}},[S,x,m,h,l,n,a,C,N,v]),ve=r=>{if(!r)return null;let c,j;return r>=.8?(c="#10b981",j="High"):r>=.5?(c="#f59e0b",j="Medium"):(c="#ef4444",j="Low"),e.jsxs("div",{className:"confidence-badge",style:{color:c,borderColor:c},children:[e.jsx(je,{size:14}),j," confidence (",Math.round(r*100),"%)"]})},ie=r=>{switch(r){case b.PENDING:return e.jsx("div",{className:"status-dot pending"});case b.PROCESSING:return e.jsx(ze,{size:14,className:"spinner"});case b.READY:return e.jsx("div",{className:"status-dot ready"});case b.SUBMITTED:return e.jsx(ee,{size:14,className:"status-check"});case b.ERROR:return e.jsx(be,{size:14,className:"status-error"});default:return null}};return e.jsxs("div",{className:"receipt-scanner batch-mode",children:[e.jsxs("div",{className:"scanner-header",children:[e.jsxs("div",{className:"scanner-title",children:[e.jsx(fe,{size:24}),e.jsxs("div",{children:[e.jsx("h3",{children:"Smart Receipt Scanner"}),e.jsxs("p",{children:[w===E.UPLOAD&&"Upload one or more receipt photos",w===E.PROCESSING&&`Processing ${R.current} of ${R.total}...`,w===E.REVIEW&&`Reviewing ${x+1} of ${m.length} receipts`]})]})]}),o&&e.jsx("button",{className:"btn btn-ghost",onClick:o,children:e.jsx(te,{size:20})})]}),e.jsxs("div",{className:"scanner-steps",children:[e.jsxs("div",{className:`step ${w===E.UPLOAD?"active":w!==E.UPLOAD?"complete":""}`,children:[e.jsx("div",{className:"step-dot",children:"1"}),e.jsx("span",{children:"Upload"})]}),e.jsx("div",{className:"step-line"}),e.jsxs("div",{className:`step ${w===E.PROCESSING?"active":w===E.REVIEW?"complete":""}`,children:[e.jsx("div",{className:"step-dot",children:"2"}),e.jsx("span",{children:"Scan All"})]}),e.jsx("div",{className:"step-line"}),e.jsxs("div",{className:`step ${w===E.REVIEW?"active":""}`,children:[e.jsx("div",{className:"step-dot",children:"3"}),e.jsx("span",{children:"Review"})]})]}),e.jsxs("div",{className:"scanner-content",children:[w===E.UPLOAD&&e.jsxs("div",{className:"upload-section",children:[e.jsxs("div",{className:"drop-zone",onDrop:g,onDragOver:Q,onClick:()=>B.current?.click(),children:[e.jsx(xe,{size:48,className:"drop-icon"}),e.jsx("p",{className:"drop-text",children:"Drag & drop receipt images"}),e.jsx("p",{className:"drop-subtext",children:"or click to browse (select multiple)"}),e.jsxs("div",{className:"upload-buttons",children:[e.jsxs("button",{className:"btn btn-primary",onClick:r=>{r.stopPropagation(),B.current?.click()},children:[e.jsx(xe,{size:18})," Choose Files"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:r=>{r.stopPropagation(),re.current?.click()},children:[e.jsx(Se,{size:18})," Take Photo"]})]}),e.jsx("input",{ref:B,type:"file",accept:"image/jpeg,image/png,image/webp,image/heic",multiple:!0,onChange:A,style:{display:"none"}}),e.jsx("input",{ref:re,type:"file",accept:"image/*",capture:"environment",onChange:A,style:{display:"none"}})]}),m.length>0&&e.jsxs("div",{className:"receipt-queue",children:[e.jsxs("div",{className:"queue-header",children:[e.jsxs("h4",{children:[e.jsx(ft,{size:18})," ",m.length," Receipt",m.length>1?"s":""," Ready"]}),e.jsxs("button",{className:"btn btn-ghost btn-sm",onClick:se,children:[e.jsx(Me,{size:16})," Clear All"]})]}),e.jsxs("div",{className:"queue-grid",children:[m.map((r,c)=>e.jsxs("div",{className:"queue-item",children:[e.jsx("img",{src:r.preview,alt:`Receipt ${c+1}`}),e.jsx("button",{className:"remove-btn",onClick:j=>{j.stopPropagation(),z(r.id)},children:e.jsx(te,{size:14})}),e.jsx("span",{className:"queue-number",children:c+1})]},r.id)),e.jsxs("div",{className:"queue-item add-more",onClick:()=>B.current?.click(),children:[e.jsx(xe,{size:24}),e.jsx("span",{children:"Add More"})]})]}),e.jsxs("button",{className:"btn btn-primary btn-lg scan-all-btn",onClick:ye,children:[e.jsx(je,{size:20})," Scan All ",m.length," Receipt",m.length>1?"s":""]})]}),e.jsxs("div",{className:"scanner-tips",children:[e.jsxs("h4",{children:[e.jsx(xt,{size:16})," Tips for best results"]}),e.jsxs("ul",{children:[e.jsx("li",{children:"Ensure receipts are flat and well-lit"}),e.jsx("li",{children:"Include the full receipt in frame"}),e.jsx("li",{children:"Avoid shadows and glare"}),e.jsx("li",{children:"You can select multiple files at once"})]})]})]}),w===E.PROCESSING&&e.jsxs("div",{className:"processing-section batch-processing",children:[e.jsxs("div",{className:"processing-progress",children:[e.jsx("div",{className:"progress-bar",children:e.jsx("div",{className:"progress-fill",style:{width:`${R.current/R.total*100}%`}})}),e.jsxs("span",{className:"progress-text",children:["Processing receipt ",R.current," of ",R.total]})]}),e.jsx("div",{className:"processing-grid",children:m.map((r,c)=>e.jsxs("div",{className:`processing-item ${r.status}`,children:[e.jsx("img",{src:r.preview,alt:`Receipt ${c+1}`}),e.jsxs("div",{className:"processing-overlay",children:[r.status===b.PROCESSING&&e.jsx(ze,{size:24,className:"spinner"}),r.status===b.READY&&e.jsx(ee,{size:24,className:"success-icon"}),r.status===b.ERROR&&e.jsx(be,{size:24,className:"error-icon"})]}),e.jsx("span",{className:"item-number",children:c+1})]},r.id))})]}),w===E.REVIEW&&S&&e.jsxs("div",{className:"review-section batch-review",children:[e.jsxs("div",{className:"receipt-sidebar",children:[e.jsxs("div",{className:"sidebar-header",children:[e.jsx("h4",{children:"Receipts"}),e.jsxs("span",{className:"sidebar-count",children:[V,"/",m.length," submitted"]})]}),e.jsx("div",{className:"sidebar-list",children:m.map((r,c)=>e.jsxs("div",{className:`sidebar-item ${c===x?"active":""} ${r.status}`,onClick:()=>r.status===b.READY&&ae(c),children:[e.jsx("img",{src:r.preview,alt:`Receipt ${c+1}`}),e.jsxs("div",{className:"sidebar-item-info",children:[e.jsx("span",{className:"item-merchant",children:r.formData.merchant||`Receipt ${c+1}`}),e.jsx("span",{className:"item-amount",children:r.formData.amount?`Â£${r.formData.amount}`:"â€”"})]}),e.jsx("div",{className:"sidebar-item-status",children:ie(r.status)})]},r.id))})]}),e.jsx("div",{className:"review-main",children:S.status===b.READY?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"review-header",children:[e.jsxs("button",{className:"btn btn-ghost",onClick:ne,disabled:!oe,children:[e.jsx(jt,{size:20})," Previous"]}),e.jsxs("div",{className:"review-position",children:["Receipt ",x+1," of ",m.length]}),e.jsxs("button",{className:"btn btn-ghost",onClick:ue,disabled:!ce,children:["Next ",e.jsx(Fe,{size:20})]})]}),e.jsxs("div",{className:"extraction-summary",children:[e.jsxs("div",{className:"summary-header",children:[e.jsx("h4",{children:"Extracted Information"}),ve(S.scanResult?.confidence)]}),S.scanResult?.ruleBasedClassification&&e.jsxs("div",{className:"rule-notice",children:[e.jsx(je,{size:14}),"Category auto-selected based on previous receipts"]})]}),e.jsxs("div",{className:"review-form",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Resource *"}),e.jsxs("select",{className:"form-input",value:S.formData.resource_id,onChange:r=>O("resource_id",r.target.value),children:[e.jsx("option",{value:"",children:"Select resource..."}),n.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Category *"}),e.jsx("div",{className:"category-selector",children:At.map(r=>{const c=r.icon,j=S.formData.category===r.id;return e.jsxs("button",{type:"button",className:`category-btn ${j?"selected":""}`,style:{"--cat-color":r.color,"--cat-bg":r.bg},onClick:()=>p(r.id),children:[e.jsx(c,{size:20}),r.label,j&&e.jsx(ee,{size:16,className:"check-icon"})]},r.id)})})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Merchant"}),e.jsx("input",{type:"text",className:"form-input",value:S.formData.merchant,onChange:r=>O("merchant",r.target.value),placeholder:"Store/vendor name"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Amount (Â£) *"}),e.jsx("input",{type:"number",step:"0.01",className:"form-input",value:S.formData.amount,onChange:r=>O("amount",r.target.value),placeholder:"0.00"})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Date *"}),e.jsx("input",{type:"date",className:"form-input",value:S.formData.date,onChange:r=>O("date",r.target.value)})]}),e.jsxs("div",{className:"form-group",style:{flex:2},children:[e.jsx("label",{className:"form-label",children:"Reason/Description *"}),e.jsx("input",{type:"text",className:"form-input",value:S.formData.reason,onChange:r=>O("reason",r.target.value),placeholder:"Brief description of expense"})]})]}),e.jsxs("div",{className:"form-row options-row",children:[e.jsxs("label",{className:"checkbox-label",children:[e.jsx("input",{type:"checkbox",checked:S.formData.chargeable,onChange:r=>O("chargeable",r.target.checked)}),e.jsx("span",{children:"Chargeable to Customer"})]}),e.jsxs("div",{className:"procurement-toggle",children:[e.jsx("span",{children:"Paid by:"}),e.jsxs("select",{className:"form-input-sm",value:S.formData.procurement,onChange:r=>O("procurement",r.target.value),children:[e.jsx("option",{value:"supplier",children:"Supplier (JT)"}),e.jsx("option",{value:"partner",children:"Partner"})]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Additional Notes"}),e.jsx("textarea",{className:"form-input",rows:2,value:S.formData.notes,onChange:r=>O("notes",r.target.value),placeholder:"Any additional information..."})]})]}),e.jsxs("div",{className:"receipt-thumbnail",children:[e.jsx("img",{src:S.preview,alt:"Receipt"}),e.jsx("span",{children:"Receipt attached"})]}),e.jsxs("div",{className:"review-actions",children:[e.jsxs("button",{className:"btn btn-secondary",onClick:()=>W(E.UPLOAD),children:[e.jsx(bt,{size:18})," Back to Upload"]}),e.jsxs("button",{className:"btn btn-primary btn-lg",onClick:le,children:[e.jsx(ee,{size:18})," Submit Expense",ce&&" & Next"]})]})]}):S.status===b.SUBMITTED?e.jsxs("div",{className:"submitted-message",children:[e.jsx("div",{className:"success-icon-large",children:e.jsx(ee,{size:48})}),e.jsx("h3",{children:"Expense Submitted"}),e.jsxs("p",{children:[S.formData.merchant," - Â£",S.formData.amount]}),ce&&e.jsxs("button",{className:"btn btn-primary",onClick:ue,children:["Review Next Receipt ",e.jsx(Fe,{size:18})]})]}):S.status===b.ERROR?e.jsxs("div",{className:"error-message",children:[e.jsx(be,{size:48,className:"error-icon"}),e.jsx("h3",{children:"Processing Failed"}),e.jsx("p",{children:S.error||"Unable to process this receipt"})]}):null})]}),w===E.REVIEW&&V===m.length&&m.length>0&&e.jsxs("div",{className:"complete-section",children:[e.jsx("div",{className:"success-icon",children:e.jsx(ee,{size:48})}),e.jsx("h3",{children:"All Receipts Submitted!"}),e.jsxs("p",{children:[V," expense",V>1?"s":""," created successfully."]}),e.jsxs("div",{className:"complete-actions",children:[e.jsxs("button",{className:"btn btn-primary",onClick:se,children:[e.jsx(Se,{size:18})," Scan More Receipts"]}),o&&e.jsx("button",{className:"btn btn-secondary",onClick:o,children:"Done"})]})]})]})]})}const ge=20520,Be=["Travel","Accommodation","Sustenance"],qe=["Draft","Submitted","Approved","Rejected","Paid"],Ne={Draft:"Draft",Submitted:"Submitted",Approved:"Validated",Rejected:"Rejected",Paid:"Paid"},Oe={resource_id:"",expense_date:new Date().toISOString().split("T")[0],travel_amount:"",travel_reason:"",travel_chargeable:!0,travel_procurement:"supplier",accommodation_amount:"",accommodation_reason:"",accommodation_chargeable:!0,accommodation_procurement:"supplier",sustenance_amount:"",sustenance_reason:"",sustenance_chargeable:!0,sustenance_procurement:"supplier",notes:"",files:[]};function Ut(){const{user:a,role:o}=$e(),{projectId:n}=Ue(),{showSuccess:s,showError:l,showWarning:h}=Le(),{showTestUsers:C,testUserIds:N}=ut(),v=a?.id||null,{canAddExpense:d,canSubmitExpense:w,canValidateExpense:W,canEditExpense:m,canDeleteExpense:F,getAvailableResources:x,hasRole:P}=ht(),[R,X]=f.useState([]),[B,re]=f.useState([]),[S,V]=f.useState(!0),[K,M]=f.useState(!1),[G,A]=f.useState("form"),[g,Q]=f.useState(null),[z,se]=f.useState({}),[ye,O]=f.useState(!1),[p,ae]=f.useState(Oe),[ne,ue]=f.useState("all"),[oe,ce]=f.useState("all"),[le,ve]=f.useState("all"),[ie,r]=f.useState("all"),[c,j]=f.useState("all"),[y,u]=f.useState({isOpen:!1,expenseId:null,expenseData:null}),[_,q]=f.useState({isOpen:!1,expense:null,editMode:!1,editData:null}),I=f.useCallback(async()=>{if(n){V(!0);try{const t=await Y.getAllFiltered(n,C);X(t);const{data:i}=await L.from("resources").select("id, name, email, user_id, partner_id, partner:partners(id, name)").order("name");let T=i||[];!C&&N?.length>0&&(T=T.filter(U=>!U.user_id||!N.includes(U.user_id))),re(T)}catch{l("Failed to load expenses")}finally{V(!1)}}},[n,C,N,l]);f.useEffect(()=>{I()},[I]);async function $(){if(!p.resource_id){h("Please select a resource");return}const t=parseFloat(p.travel_amount)>0,i=parseFloat(p.accommodation_amount)>0,T=parseFloat(p.sustenance_amount)>0;if(!t&&!i&&!T){h("Please enter at least one expense amount");return}if(t&&!p.travel_reason){h("Please enter a reason for the travel expense");return}if(i&&!p.accommodation_reason){h("Please enter a reason for the accommodation expense");return}if(T&&!p.sustenance_reason){h("Please enter a reason for the sustenance expense");return}try{const U=B.find(_e=>_e.id===p.resource_id)?.name,D=[];t&&D.push({project_id:n,category:"Travel",resource_id:p.resource_id,resource_name:U,expense_date:p.expense_date,reason:p.travel_reason,amount:parseFloat(p.travel_amount),notes:p.notes,created_by:v,chargeable_to_customer:p.travel_chargeable,procurement_method:p.travel_procurement}),i&&D.push({project_id:n,category:"Accommodation",resource_id:p.resource_id,resource_name:U,expense_date:p.expense_date,reason:p.accommodation_reason,amount:parseFloat(p.accommodation_amount),notes:p.notes,created_by:v,chargeable_to_customer:p.accommodation_chargeable,procurement_method:p.accommodation_procurement}),T&&D.push({project_id:n,category:"Sustenance",resource_id:p.resource_id,resource_name:U,expense_date:p.expense_date,reason:p.sustenance_reason,amount:parseFloat(p.sustenance_amount),notes:p.notes,created_by:v,chargeable_to_customer:p.sustenance_chargeable,procurement_method:p.sustenance_procurement});const he=await Y.createMany(D);if(p.files.length>0&&he){O(!0);for(const _e of he)for(const dt of p.files)try{await Y.uploadReceipt(_e.id,dt,v)}catch{}O(!1)}await I(),M(!1),ae(Oe),s("Expenses added successfully!")}catch(U){l("Failed to add expenses: "+U.message)}}async function k(t){try{const i=await Y.create({project_id:n,category:t.category,resource_id:t.resource_id,resource_name:t.resource_name,expense_date:t.expense_date,reason:t.reason,amount:t.amount,notes:t.notes,created_by:v,chargeable_to_customer:t.chargeable_to_customer,procurement_method:t.procurement_method});await I()}catch(i){l("Failed to create expense: "+i.message)}}function J(t){Q(t.id),se({category:t.category,resource_id:t.resource_id,resource_name:t.resource_name,expense_date:t.expense_date,reason:t.reason,amount:t.amount,notes:t.notes,status:t.status,chargeable_to_customer:t.chargeable_to_customer!==!1,procurement_method:t.procurement_method||"supplier"})}async function ke(t){try{const i=B.find(T=>T.id===z.resource_id)?.name||z.resource_name;await Y.update(t,{category:z.category,resource_id:z.resource_id,resource_name:i,expense_date:z.expense_date,reason:z.reason,amount:parseFloat(z.amount),notes:z.notes,status:z.status,chargeable_to_customer:z.chargeable_to_customer,procurement_method:z.procurement_method}),await I(),Q(null),s("Expense updated!")}catch(i){l("Failed to update: "+i.message)}}function me(t){u({isOpen:!0,expenseId:t.id,expenseData:{resourceName:t.resource_name,date:t.expense_date,totalAmount:parseFloat(t.amount||0),category:t.category,chargeable:t.chargeable_to_customer,procurement:t.procurement_method,status:t.status}})}async function He(){if(y.expenseId)try{await Y.delete(y.expenseId,v),await I(),u({isOpen:!1,expenseId:null,expenseData:null}),s("Expense deleted")}catch(t){l("Failed to delete: "+t.message)}}async function Je(t){if(confirm("Submit this expense for validation?"))try{await Y.submit(t),await I(),s("Expense submitted for validation!")}catch(i){l("Failed to submit: "+i.message)}}async function Xe(t){try{await Y.approve(t),await I(),s("Expense validated!")}catch(i){l("Failed to validate: "+i.message)}}async function Ke(t){const i=prompt("Please provide a reason for rejection (optional):");try{await Y.reject(t,i),await I(),h("Expense rejected")}catch(T){l("Failed to reject: "+T.message)}}function Qe(t){const i=Array.from(t.target.files);ae({...p,files:[...p.files,...i]})}function Ze(t){ae({...p,files:p.files.filter((i,T)=>T!==t)})}async function et(t,i){try{const T=await Y.downloadReceipt(t),U=URL.createObjectURL(T),D=document.createElement("a");D.href=U,D.download=i,document.body.appendChild(D),D.click(),document.body.removeChild(D),URL.revokeObjectURL(U)}catch{l("Failed to download file")}}function Te(t){switch(t){case"Travel":return e.jsx(Re,{size:16});case"Accommodation":return e.jsx(we,{size:16});case"Sustenance":return e.jsx(Ae,{size:16});default:return e.jsx(fe,{size:16})}}function Pe(t){switch(t){case"Travel":return{bg:"#dbeafe",color:"#2563eb"};case"Accommodation":return{bg:"#f3e8ff",color:"#7c3aed"};case"Sustenance":return{bg:"#ffedd5",color:"#ea580c"};default:return{bg:"#f1f5f9",color:"#64748b"}}}function tt(t){switch(t){case"Approved":case"Paid":return"status-completed";case"Submitted":return"status-in-progress";case"Rejected":return"status-at-risk";default:return"status-not-started"}}function rt(){return P(["admin","supplier_pm","customer_pm"])}const Ie=R.filter(t=>!(ne!=="all"&&t.category!==ne||oe!=="all"&&t.resource_name!==oe||le!=="all"&&t.status!==le||ie==="chargeable"&&t.chargeable_to_customer===!1||ie==="non-chargeable"&&t.chargeable_to_customer!==!1||c!=="all"&&(t.procurement_method||"supplier")!==c)),at=R.reduce((t,i)=>t+parseFloat(i.amount||0),0),st=R.filter(t=>t.chargeable_to_customer!==!1).reduce((t,i)=>t+parseFloat(i.amount||0),0),nt=R.filter(t=>t.chargeable_to_customer===!1).reduce((t,i)=>t+parseFloat(i.amount||0),0),De=R.filter(t=>["Approved","Paid"].includes(t.status)).reduce((t,i)=>t+parseFloat(i.amount||0),0),Ee=ge-De,ot=R.filter(t=>t.status==="Submitted").length,ct=R.filter(t=>(t.procurement_method||"supplier")==="supplier").reduce((t,i)=>t+parseFloat(i.amount||0),0),lt=R.filter(t=>t.procurement_method==="partner").reduce((t,i)=>t+parseFloat(i.amount||0),0),it={Travel:R.filter(t=>t.category==="Travel").reduce((t,i)=>t+parseFloat(i.amount||0),0),Accommodation:R.filter(t=>t.category==="Accommodation").reduce((t,i)=>t+parseFloat(i.amount||0),0),Sustenance:R.filter(t=>t.category==="Sustenance").reduce((t,i)=>t+parseFloat(i.amount||0),0)},Z={};R.forEach(t=>{Z[t.resource_name]||(Z[t.resource_name]={total:0,chargeable:0,nonChargeable:0});const i=parseFloat(t.amount||0);Z[t.resource_name].total+=i,t.chargeable_to_customer!==!1?Z[t.resource_name].chargeable+=i:Z[t.resource_name].nonChargeable+=i});const pe=x(B);return S&&!n?e.jsx(mt,{message:"Loading expenses...",size:"large",fullPage:!0}):e.jsxs("div",{className:"page-container",children:[e.jsx(pt,{icon:fe,title:"Expenses",subtitle:`Track project expenses against Â£${ge.toLocaleString()} budget`,children:d&&!K&&e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsxs("button",{className:"btn btn-primary",onClick:()=>{A("form"),M(!0)},children:[e.jsx(yt,{size:18})," Add Expenses"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:()=>{A("scanner"),M(!0)},style:{background:"linear-gradient(135deg, #8b5cf6, #6366f1)",color:"white",border:"none"},title:"Scan a receipt with AI",children:[e.jsx(Se,{size:18})," ",e.jsx(je,{size:14})," Scan Receipt"]})]})}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem"},children:[e.jsx(H,{icon:fe,label:"Total Budget",value:`Â£${ge.toLocaleString()}`,color:"#3b82f6"}),e.jsx(H,{label:"Total Claimed",value:`Â£${at.toLocaleString()}`,color:"#3b82f6"}),e.jsx(H,{icon:We,label:"Chargeable",value:`Â£${st.toLocaleString()}`,color:"#10b981"}),e.jsx(H,{icon:be,label:"Non-Chargeable",value:`Â£${nt.toLocaleString()}`,color:"#f59e0b"})]}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem",gridTemplateColumns:"repeat(3, 1fr)"},children:[e.jsx(H,{label:"Validated/Paid",value:`Â£${De.toLocaleString()}`,color:"#10b981"}),e.jsx(H,{label:"Remaining Budget",value:`Â£${Ee.toLocaleString()}`,color:Ee<ge*.2?"#ef4444":"#10b981"}),e.jsx(H,{label:"Pending Validation",value:ot,color:"#f59e0b"})]}),P(["admin","supplier_pm"])&&e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem",gridTemplateColumns:"repeat(2, 1fr)"},children:[e.jsx(H,{icon:Ge,label:"Supplier Procured",value:`Â£${ct.toLocaleString()}`,subtext:"Paid directly by JT",color:"#6366f1"}),e.jsx(H,{icon:Ye,label:"Partner Procured",value:`Â£${lt.toLocaleString()}`,subtext:"Reimbursable to partners",color:"#8b5cf6"})]}),e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Breakdown by Type"}),e.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:"1rem"},children:Be.map(t=>{const i=Pe(t),T=R.filter(D=>D.category===t).length,U=R.filter(D=>D.category===t&&D.chargeable_to_customer!==!1).reduce((D,he)=>D+parseFloat(he.amount||0),0);return e.jsxs("div",{style:{padding:"1rem",backgroundColor:i.bg,borderRadius:"8px"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",color:i.color,marginBottom:"0.5rem"},children:[Te(t),e.jsx("span",{style:{fontWeight:"600"},children:t})]}),e.jsxs("div",{style:{fontSize:"1.5rem",fontWeight:"700",color:i.color},children:["Â£",it[t].toFixed(2)]}),e.jsxs("div",{style:{fontSize:"0.8rem",color:"#64748b"},children:[T," expense(s)"]}),e.jsxs("div",{style:{fontSize:"0.75rem",color:"#10b981",marginTop:"0.25rem"},children:["Â£",U.toFixed(2)," chargeable"]})]},t)})})]}),Object.keys(Z).length>0&&e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Breakdown by Resource"}),e.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"1rem"},children:Object.entries(Z).map(([t,i])=>e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#f1f5f9",borderRadius:"8px",minWidth:"180px"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"0.5rem"},children:[e.jsx(vt,{size:16,style:{color:"#64748b"}}),e.jsx("span",{style:{fontWeight:"600",fontSize:"0.9rem"},children:t})]}),e.jsxs("div",{style:{fontSize:"1.25rem",fontWeight:"700",color:"#3b82f6"},children:["Â£",i.total.toFixed(2)]}),e.jsxs("div",{style:{fontSize:"0.75rem",color:"#10b981"},children:["Â£",i.chargeable.toFixed(2)," chargeable"]}),i.nonChargeable>0&&e.jsxs("div",{style:{fontSize:"0.75rem",color:"#f59e0b"},children:["Â£",i.nonChargeable.toFixed(2)," non-chargeable"]})]},t))})]}),e.jsx("div",{className:"card",style:{marginBottom:"1.5rem"},children:e.jsxs("div",{style:{display:"flex",gap:"1rem",alignItems:"center",flexWrap:"wrap"},children:[e.jsx("span",{style:{fontWeight:"500"},children:"Filter:"}),e.jsxs("select",{value:ne,onChange:t=>ue(t.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"all",children:"All Types"}),Be.map(t=>e.jsx("option",{value:t,children:t},t))]}),e.jsxs("select",{value:oe,onChange:t=>ce(t.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"all",children:"All Resources"}),[...new Set(R.map(t=>t.resource_name))].map(t=>e.jsx("option",{value:t,children:t},t))]}),e.jsxs("select",{value:le,onChange:t=>ve(t.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"all",children:"All Statuses"}),qe.map(t=>e.jsx("option",{value:t,children:Ne[t]||t},t))]}),e.jsxs("select",{value:ie,onChange:t=>r(t.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"all",children:"All Expenses"}),e.jsx("option",{value:"chargeable",children:"Chargeable Only"}),e.jsx("option",{value:"non-chargeable",children:"Non-Chargeable Only"})]}),P(["admin","supplier_pm"])&&e.jsxs("select",{value:c,onChange:t=>j(t.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"all",children:"All Procurement"}),e.jsx("option",{value:"supplier",children:"Supplier Procured"}),e.jsx("option",{value:"partner",children:"Partner Procured"})]})]})}),K&&G==="form"&&e.jsx(Tt,{newExpense:p,setNewExpense:ae,availableResources:pe,hasRole:P,handleAdd:$,handleFileSelect:Qe,removeFile:Ze,uploadingFiles:ye,onCancel:()=>M(!1)}),K&&G==="scanner"&&e.jsx("div",{style:{marginBottom:"1.5rem"},children:e.jsx(kt,{resources:pe,defaultResourceId:pe.length===1?pe[0].id:null,onExpenseCreated:k,onCancel:()=>{M(!1),A("form")}})}),e.jsx("div",{className:"card",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Ref"}),e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Resource"}),e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Reason"}),e.jsx("th",{style:{textAlign:"right"},children:"Amount"}),e.jsx("th",{children:"Chargeable"}),P(["admin","supplier_pm"])&&e.jsx("th",{children:"Procured By"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Receipts"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:Ie.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:P(["admin","supplier_pm"])?11:10,style:{textAlign:"center",color:"#64748b",padding:"2rem"},children:"No expenses found."})}):Ie.map(t=>e.jsx(Pt,{expense:t,editingId:g,editForm:z,setEditForm:se,resources:B,hasRole:P,canEditChargeable:rt,canSubmitExpense:w,canValidateExpense:W,canEditExpense:m,canDeleteExpense:F,getCategoryIcon:Te,getCategoryColor:Pe,getStatusColor:tt,handleEdit:J,handleSave:ke,handleSubmit:Je,handleApprove:Xe,handleReject:Ke,handleDeleteClick:me,downloadFile:et,setEditingId:Q,setDetailModal:q},t.id))})]})}),e.jsxs("div",{className:"card",style:{marginTop:"1.5rem",backgroundColor:"#fffbeb",borderLeft:"4px solid #f59e0b"},children:[e.jsx("h4",{style:{marginBottom:"0.5rem",color:"#92400e"},children:"ðŸ“‹ Expense Guidelines"}),e.jsxs("ul",{style:{margin:"0.5rem 0 0 1.5rem",color:"#92400e",fontSize:"0.9rem"},children:[e.jsx("li",{children:"PMO travel/accommodation requires advance approval from Authority Project Manager"}),e.jsx("li",{children:"Attach receipts for all expenses over Â£25"}),e.jsx("li",{children:"Submit expenses within 30 days of incurring them"}),e.jsxs("li",{children:[e.jsx("strong",{children:"Submit:"})," Click the send icon to submit for validation"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Chargeable expenses:"})," Validated by Customer PM"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Non-chargeable expenses:"})," Validated by Supplier PM"]})]})]}),e.jsx(gt,{isOpen:y.isOpen,onClose:()=>u({isOpen:!1,expenseId:null,expenseData:null}),onConfirm:He,title:"Delete Expense",message:y.expenseData?e.jsxs("div",{children:[e.jsx("p",{children:"Are you sure you want to delete this expense?"}),e.jsxs("div",{style:{backgroundColor:"#fef3c7",border:"1px solid #f59e0b",borderRadius:"6px",padding:"0.75rem",marginTop:"0.75rem"},children:[e.jsx("p",{style:{fontWeight:"600",color:"#92400e",margin:"0 0 0.5rem 0"},children:"Details:"}),e.jsxs("ul",{style:{margin:"0",paddingLeft:"1.25rem",color:"#92400e",fontSize:"0.9rem"},children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Resource:"})," ",y.expenseData.resourceName]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Category:"})," ",y.expenseData.category]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Amount:"})," Â£",y.expenseData.totalAmount?.toFixed(2)]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Status:"})," ",y.expenseData.status]})]})]}),e.jsx("p",{style:{marginTop:"0.75rem",fontSize:"0.85rem",color:"#6b7280"},children:"This expense can be restored from the audit log if needed."})]}):"Are you sure you want to delete this expense?",confirmText:"Delete",cancelText:"Cancel",variant:"danger"})]})}function Tt({newExpense:a,setNewExpense:o,availableResources:n,hasRole:s,handleAdd:l,handleFileSelect:h,removeFile:C,uploadingFiles:N,onCancel:v}){return e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem",border:"2px solid var(--primary)"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Add New Expenses"}),e.jsx("p",{style:{color:"#64748b",fontSize:"0.9rem",marginBottom:"1rem"},children:"Enter amounts for any categories that apply. Leave blank to skip a category."}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem",marginBottom:"1.5rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Resource Name *"}),e.jsxs("select",{className:"form-input",value:a.resource_id,onChange:d=>o({...a,resource_id:d.target.value}),children:[e.jsx("option",{value:"",children:"Select Resource"}),n.map(d=>e.jsx("option",{value:d.id,children:d.name},d.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Date *"}),e.jsx("input",{type:"date",className:"form-input",value:a.expense_date,onChange:d=>o({...a,expense_date:d.target.value})})]})]}),e.jsx(Ce,{category:"Travel",icon:e.jsx(Re,{size:20}),bgColor:"#dbeafe",textColor:"#2563eb",borderColor:"#93c5fd",amount:a.travel_amount,reason:a.travel_reason,chargeable:a.travel_chargeable,procurement:a.travel_procurement,onAmountChange:d=>o({...a,travel_amount:d}),onReasonChange:d=>o({...a,travel_reason:d}),onChargeableChange:d=>o({...a,travel_chargeable:d}),onProcurementChange:d=>o({...a,travel_procurement:d}),hasRole:s}),e.jsx(Ce,{category:"Accommodation",icon:e.jsx(we,{size:20}),bgColor:"#f3e8ff",textColor:"#7c3aed",borderColor:"#d8b4fe",amount:a.accommodation_amount,reason:a.accommodation_reason,chargeable:a.accommodation_chargeable,procurement:a.accommodation_procurement,onAmountChange:d=>o({...a,accommodation_amount:d}),onReasonChange:d=>o({...a,accommodation_reason:d}),onChargeableChange:d=>o({...a,accommodation_chargeable:d}),onProcurementChange:d=>o({...a,accommodation_procurement:d}),hasRole:s}),e.jsx(Ce,{category:"Sustenance",icon:e.jsx(Ae,{size:20}),bgColor:"#ffedd5",textColor:"#ea580c",borderColor:"#fdba74",amount:a.sustenance_amount,reason:a.sustenance_reason,chargeable:a.sustenance_chargeable,procurement:a.sustenance_procurement,onAmountChange:d=>o({...a,sustenance_amount:d}),onReasonChange:d=>o({...a,sustenance_reason:d}),onChargeableChange:d=>o({...a,sustenance_chargeable:d}),onProcurementChange:d=>o({...a,sustenance_procurement:d}),hasRole:s}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{className:"form-label",children:"Additional Notes"}),e.jsx("textarea",{className:"form-input",rows:2,placeholder:"Any additional information...",value:a.notes,onChange:d=>o({...a,notes:d.target.value})})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{className:"form-label",children:"Attach Receipts"}),e.jsxs("div",{style:{border:"2px dashed #d1d5db",borderRadius:"8px",padding:"1.5rem",textAlign:"center",cursor:"pointer",backgroundColor:"#f9fafb"},onClick:()=>document.getElementById("file-upload").click(),children:[e.jsx(xe,{size:24,style:{color:"#9ca3af",marginBottom:"0.5rem"}}),e.jsx("div",{style:{color:"#64748b",fontSize:"0.85rem"},children:"Click to upload receipts"}),e.jsx("input",{id:"file-upload",type:"file",multiple:!0,accept:".pdf,.jpg,.jpeg,.png,.zip",style:{display:"none"},onChange:h})]}),a.files.length>0&&e.jsx("div",{style:{marginTop:"0.5rem"},children:a.files.map((d,w)=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.25rem 0",fontSize:"0.85rem"},children:[e.jsx(_t,{size:14}),e.jsx("span",{style:{flex:1},children:d.name}),e.jsx("button",{onClick:()=>C(w),style:{background:"none",border:"none",cursor:"pointer",color:"#ef4444"},children:e.jsx(te,{size:14})})]},w))})]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsxs("button",{className:"btn btn-primary",onClick:l,disabled:N,children:[e.jsx(Ve,{size:16})," ",N?"Uploading...":"Save Expenses"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:v,children:[e.jsx(te,{size:16})," Cancel"]})]})]})}function Ce({category:a,icon:o,bgColor:n,textColor:s,borderColor:l,amount:h,reason:C,chargeable:N,procurement:v,onAmountChange:d,onReasonChange:w,onChargeableChange:W,onProcurementChange:m,hasRole:F}){return e.jsxs("div",{style:{padding:"1rem",backgroundColor:n,borderRadius:"8px",marginBottom:"1rem"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",color:s,marginBottom:"0.75rem"},children:[o,e.jsx("span",{style:{fontWeight:"600",fontSize:"1rem"},children:a})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"150px 1fr",gap:"1rem",marginBottom:"0.75rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Amount (Â£)"}),e.jsx("input",{type:"number",step:"0.01",className:"form-input",placeholder:"0.00",value:h,onChange:x=>d(x.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Reason / Description"}),e.jsx("input",{type:"text",className:"form-input",placeholder:`e.g., ${a} expense description`,value:C,onChange:x=>w(x.target.value)})]})]}),parseFloat(h)>0&&e.jsxs("div",{style:{display:"flex",gap:"1.5rem",flexWrap:"wrap",paddingTop:"0.75rem",borderTop:`1px solid ${l}`},children:[e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"0.5rem",cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:N,onChange:x=>W(x.target.checked),style:{width:"16px",height:"16px",accentColor:s}}),e.jsx("span",{style:{fontSize:"0.85rem",color:s},children:"Chargeable to Customer"})]}),F(["admin","supplier_pm"])&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.85rem",color:s},children:"Paid by:"}),e.jsxs("select",{value:v,onChange:x=>m(x.target.value),style:{padding:"0.25rem 0.5rem",borderRadius:"4px",border:`1px solid ${l}`,fontSize:"0.85rem",backgroundColor:"#fff"},children:[e.jsx("option",{value:"supplier",children:"Supplier (JT)"}),e.jsx("option",{value:"partner",children:"Partner"})]})]})]})]})}function Pt({expense:a,editingId:o,editForm:n,setEditForm:s,resources:l,hasRole:h,canEditChargeable:C,canSubmitExpense:N,canValidateExpense:v,canEditExpense:d,canDeleteExpense:w,getCategoryIcon:W,getCategoryColor:m,getStatusColor:F,handleEdit:x,handleSave:P,handleSubmit:R,handleApprove:X,handleReject:B,handleDeleteClick:re,downloadFile:S,setEditingId:V,setDetailModal:K}){const M=m(a.category),G=a.chargeable_to_customer!==!1,A=o===a.id;return e.jsxs("tr",{style:{backgroundColor:G?"inherit":"#fffbeb",cursor:A?"default":"pointer"},onClick:()=>!A&&K({isOpen:!0,expense:a}),children:[e.jsx("td",{style:{fontFamily:"monospace",fontSize:"0.85rem"},children:a.expense_ref||"-"}),e.jsx("td",{children:A?e.jsxs("select",{className:"form-input",value:n.category,onChange:g=>s({...n,category:g.target.value}),children:[e.jsx("option",{value:"Travel",children:"Travel"}),e.jsx("option",{value:"Accommodation",children:"Accommodation"}),e.jsx("option",{value:"Sustenance",children:"Sustenance"})]}):e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.85rem",backgroundColor:M.bg,color:M.color},children:[W(a.category),a.category]})}),e.jsx("td",{children:A?e.jsxs("select",{className:"form-input",value:n.resource_id||"",onChange:g=>s({...n,resource_id:g.target.value}),children:[e.jsx("option",{value:"",children:"-- Select --"}),l.map(g=>e.jsx("option",{value:g.id,children:g.name},g.id))]}):a.resource_name}),e.jsx("td",{children:A?e.jsx("input",{type:"date",className:"form-input",value:n.expense_date,onChange:g=>s({...n,expense_date:g.target.value})}):new Date(a.expense_date).toLocaleDateString("en-GB")}),e.jsx("td",{style:{maxWidth:"200px"},children:A?e.jsx("input",{type:"text",className:"form-input",value:n.reason,onChange:g=>s({...n,reason:g.target.value})}):e.jsx("div",{style:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:a.reason})}),e.jsx("td",{style:{textAlign:"right",fontWeight:"600"},children:A?e.jsx("input",{type:"number",step:"0.01",className:"form-input",value:n.amount,onChange:g=>s({...n,amount:g.target.value}),style:{width:"100px",textAlign:"right"}}):`Â£${parseFloat(a.amount).toFixed(2)}`}),e.jsx("td",{children:A&&C()?e.jsx("input",{type:"checkbox",checked:n.chargeable_to_customer,onChange:g=>s({...n,chargeable_to_customer:g.target.checked}),style:{width:"18px",height:"18px"}}):e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.75rem",fontWeight:"500",backgroundColor:G?"#dcfce7":"#fef3c7",color:G?"#166534":"#92400e"},children:[G?e.jsx(ee,{size:12}):e.jsx(te,{size:12}),G?"Yes":"No"]})}),h(["admin","supplier_pm"])&&e.jsx("td",{children:A?e.jsxs("select",{className:"form-input",value:n.procurement_method||"supplier",onChange:g=>s({...n,procurement_method:g.target.value}),style:{fontSize:"0.85rem",padding:"0.25rem"},children:[e.jsx("option",{value:"supplier",children:"Supplier"}),e.jsx("option",{value:"partner",children:"Partner"})]}):e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.75rem",fontWeight:"500",backgroundColor:(a.procurement_method||"supplier")==="partner"?"#f3e8ff":"#e0e7ff",color:(a.procurement_method||"supplier")==="partner"?"#7c3aed":"#4338ca"},children:[(a.procurement_method||"supplier")==="partner"?e.jsx(Ye,{size:12}):e.jsx(Ge,{size:12}),(a.procurement_method||"supplier")==="partner"?"Partner":"Supplier"]})}),e.jsx("td",{children:A&&v(a)?e.jsx("select",{className:"form-input",value:n.status,onChange:g=>s({...n,status:g.target.value}),children:qe.map(g=>e.jsx("option",{value:g,children:Ne[g]||g},g))}):e.jsx("span",{className:`status-badge ${F(a.status)}`,children:Ne[a.status]||a.status})}),e.jsx("td",{onClick:g=>g.stopPropagation(),children:a.expense_files?.length>0?e.jsx("div",{style:{display:"flex",gap:"0.25rem"},children:a.expense_files.map((g,Q)=>e.jsx("button",{onClick:()=>S(g.file_path,g.file_name),style:{background:"none",border:"none",cursor:"pointer",color:"#3b82f6"},title:g.file_name,children:e.jsx(Ct,{size:16})},Q))}):"-"}),e.jsx("td",{onClick:g=>g.stopPropagation(),children:A?e.jsxs("div",{className:"action-buttons",children:[e.jsx("button",{className:"btn-icon btn-success",onClick:()=>P(a.id),children:e.jsx(Ve,{size:16})}),e.jsx("button",{className:"btn-icon btn-secondary",onClick:()=>V(null),children:e.jsx(te,{size:16})})]}):e.jsxs("div",{className:"action-buttons",children:[N(a)&&e.jsx("button",{className:"btn-icon",onClick:()=>R(a.id),title:"Submit for Validation",style:{color:"#3b82f6"},children:e.jsx(St,{size:16})}),v(a)&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn-icon btn-success",onClick:()=>X(a.id),title:"Validate",children:e.jsx(We,{size:16})}),e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>B(a.id),title:"Reject",children:e.jsx(te,{size:16})})]}),d(a)&&e.jsx("button",{className:"btn-icon",onClick:()=>x(a),title:"Edit",children:e.jsx(Nt,{size:16})}),w(a)&&e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>re(a),title:"Delete",children:e.jsx(Me,{size:16})})]})})]})}export{Ut as default};
