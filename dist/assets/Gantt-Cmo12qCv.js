import{u as Y,d as J,s as _,j as e,L as K}from"./index-B2BIVY61.js";import{r as d,L as w}from"./vendor-react-BUTV5ZEl.js";import{h as Q,aj as ee,w as te,ak as se,al as ae,ah as $,am as ne,an as ie,x as re,I as oe}from"./vendor-icons-CtZxSxcO.js";import"./vendor-supabase-6faYzd5A.js";function xe(){const[u,v]=d.useState([]),[N,W]=d.useState(!0),[P,X]=d.useState(null),[h,D]=d.useState(null),[p,S]=d.useState(null),[y,A]=d.useState(.1),[c,I]=d.useState(null),[F,G]=d.useState(0),[f,T]=d.useState({}),V=d.useRef(null),{role:de}=Y(),{canUseGantt:O}=J(),g=O;d.useEffect(()=>{Z()},[]),d.useEffect(()=>{u.length>0&&q()},[u]);async function Z(){try{const{data:t}=await _.from("projects").select("id").eq("reference","AMSF001").single();t&&(X(t.id),await z(t.id))}catch{}finally{W(!1)}}async function z(t){const s=t||P;try{const{data:a,error:n}=await _.from("milestones").select("*").eq("project_id",s).order("milestone_ref");if(n)throw n;v(a||[])}catch{}}function q(){let t=new Date,s=new Date;u.forEach(a=>{[a.baseline_start_date,a.baseline_end_date,a.actual_start_date,a.forecast_end_date,a.start_date,a.end_date].filter(Boolean).map(r=>new Date(r)).forEach(r=>{r<t&&(t=r),r>s&&(s=r)})}),t.setDate(t.getDate()-14),s.setDate(s.getDate()+14),D(t),S(s)}function m(t){return!h||!t?0:(new Date(t)-h)/(1e3*60*60*24)/y}function o(t){return t?new Date(t).toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"2-digit"}):"-"}function j(t){return t.toISOString().split("T")[0]}function b(t,s,a){g&&(t.preventDefault(),I({milestoneId:s.id,type:a}),G(t.clientX),T({actual_start_date:s.actual_start_date,forecast_end_date:s.forecast_end_date}),document.addEventListener("mousemove",C),document.addEventListener("mouseup",M))}function C(t){if(!c)return;const s=t.clientX-F,a=Math.round(s*y);v(n=>n.map(r=>{if(r.id!==c.milestoneId)return r;const x={...r};if(c.type==="move"){if(f.actual_start_date){const i=new Date(f.actual_start_date);i.setDate(i.getDate()+a),x.actual_start_date=j(i)}if(f.forecast_end_date){const i=new Date(f.forecast_end_date);i.setDate(i.getDate()+a),x.forecast_end_date=j(i)}}else if(c.type==="start"){if(f.actual_start_date){const i=new Date(f.actual_start_date);i.setDate(i.getDate()+a),x.actual_start_date=j(i)}}else if(c.type==="end"&&f.forecast_end_date){const i=new Date(f.forecast_end_date);i.setDate(i.getDate()+a),x.forecast_end_date=j(i)}return x}))}async function M(){if(document.removeEventListener("mousemove",C),document.removeEventListener("mouseup",M),!c)return;const t=u.find(s=>s.id===c.milestoneId);if(t)try{const{error:s}=await _.from("milestones").update({actual_start_date:t.actual_start_date,forecast_end_date:t.forecast_end_date}).eq("id",t.id);if(s)throw s}catch{alert("Failed to update milestone dates"),await z()}I(null)}function H(){if(!h||!p)return[];const t=[],s=new Date(h);for(;s<=p;)t.push({date:new Date(s),x:m(s),isMonthStart:s.getDate()===1,isWeekStart:s.getDay()===1}),s.setDate(s.getDate()+7);return t}function E(t){A(s=>t==="in"?Math.max(.02,s*.8):Math.min(.5,s*1.25))}function k(t){const s=t==="left"?-30:30;D(a=>{const n=new Date(a);return n.setDate(n.getDate()+s),n}),S(a=>{const n=new Date(a);return n.setDate(n.getDate()+s),n})}const U=H(),L=h&&p?(p-h)/(1e3*60*60*24)/y:1e3;return N?e.jsx(K,{message:"Loading Gantt chart...",size:"large",fullPage:!0}):e.jsxs("div",{className:"page-container",children:[e.jsxs("div",{className:"page-header",children:[e.jsxs("div",{className:"page-title",children:[e.jsx(Q,{size:28}),e.jsxs("div",{children:[e.jsx("h1",{children:"Project Gantt Chart"}),e.jsx("p",{children:"Visual timeline of milestone schedules"})]})]}),e.jsx(w,{to:"/milestones",className:"btn btn-secondary",children:"â† Back to Milestones"})]}),e.jsxs("div",{className:"card",style:{marginBottom:"1rem",display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap",gap:"1rem"},children:[e.jsxs("div",{style:{display:"flex",gap:"0.5rem",alignItems:"center"},children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>k("left"),style:{padding:"0.5rem"},children:e.jsx(ee,{size:20})}),e.jsx("button",{className:"btn btn-secondary",onClick:()=>k("right"),style:{padding:"0.5rem"},children:e.jsx(te,{size:20})}),e.jsxs("span",{style:{marginLeft:"0.5rem",fontSize:"0.9rem",color:"#64748b"},children:[h&&o(h)," - ",p&&o(p)]})]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem",alignItems:"center"},children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>E("out"),style:{padding:"0.5rem"},title:"Zoom Out",children:e.jsx(se,{size:20})}),e.jsx("button",{className:"btn btn-secondary",onClick:()=>E("in"),style:{padding:"0.5rem"},title:"Zoom In",children:e.jsx(ae,{size:20})})]})]}),e.jsx("div",{className:"card",style:{marginBottom:"1rem",padding:"0.75rem 1rem"},children:e.jsxs("div",{style:{display:"flex",gap:"2rem",flexWrap:"wrap",alignItems:"center"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("div",{style:{width:"24px",height:"12px",backgroundColor:"#94a3b8",borderRadius:"2px",opacity:.6}}),e.jsx("span",{style:{fontSize:"0.85rem"},children:"Baseline (fixed)"}),e.jsx($,{size:14,style:{color:"#64748b"}})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("div",{style:{width:"24px",height:"12px",backgroundColor:"#3b82f6",borderRadius:"2px"}}),e.jsx("span",{style:{fontSize:"0.85rem"},children:"Actual/Forecast"}),g&&e.jsx(ne,{size:14,style:{color:"#3b82f6"}})]}),g?e.jsxs("div",{style:{marginLeft:"auto",fontSize:"0.85rem",color:"#16a34a",display:"flex",alignItems:"center",gap:"0.25rem"},children:[e.jsx(ie,{size:14}),"Drag blue bars to adjust dates"]}):e.jsxs("div",{style:{marginLeft:"auto",fontSize:"0.85rem",color:"#64748b",display:"flex",alignItems:"center",gap:"0.5rem",backgroundColor:"#f1f5f9",padding:"0.375rem 0.75rem",borderRadius:"6px"},children:[e.jsx(re,{size:14}),"View only mode"]})]})}),e.jsx("div",{className:"card",style:{overflow:"hidden"},children:e.jsxs("div",{style:{display:"flex"},children:[e.jsxs("div",{style:{minWidth:"200px",borderRight:"1px solid #e2e8f0",backgroundColor:"#f8fafc",flexShrink:0},children:[e.jsx("div",{style:{padding:"0.75rem",fontWeight:"600",borderBottom:"1px solid #e2e8f0",height:"40px",display:"flex",alignItems:"center"},children:"Milestone"}),u.map(t=>e.jsxs("div",{style:{padding:"0.5rem 0.75rem",borderBottom:"1px solid #f1f5f9",height:"80px",display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(w,{to:`/milestones/${t.id}`,style:{fontWeight:"600",color:"#3b82f6",textDecoration:"none",fontSize:"0.9rem"},children:t.milestone_ref}),e.jsxs("div",{style:{fontSize:"0.8rem",color:"#64748b",marginTop:"0.25rem"},children:[t.name?.substring(0,25),t.name?.length>25?"...":""]})]},t.id))]}),e.jsx("div",{ref:V,style:{flex:1,overflowX:"auto",overflowY:"hidden"},children:e.jsxs("div",{style:{minWidth:`${L}px`,position:"relative"},children:[e.jsx("div",{style:{height:"40px",borderBottom:"1px solid #e2e8f0",position:"relative",backgroundColor:"#f8fafc"},children:U.map((t,s)=>e.jsx("div",{style:{position:"absolute",left:`${t.x}px`,top:0,height:"100%",borderLeft:t.isMonthStart?"2px solid #cbd5e1":"1px solid #e2e8f0",paddingLeft:"4px",fontSize:"0.75rem",color:"#64748b",display:"flex",alignItems:"center"},children:t.date.toLocaleDateString("en-GB",{day:"2-digit",month:"short"})},s))}),u.map(t=>{const s=t.baseline_start_date||t.start_date,a=t.baseline_end_date||t.end_date,n=t.actual_start_date||t.start_date,r=t.forecast_end_date||t.end_date,x=m(s),i=Math.max(20,m(a)-x),B=m(n),R=Math.max(20,m(r)-B);return e.jsxs("div",{style:{height:"80px",borderBottom:"1px solid #f1f5f9",position:"relative"},children:[s&&a&&e.jsxs("div",{style:{position:"absolute",left:`${x}px`,top:"12px",width:`${i}px`,height:"20px",backgroundColor:"#94a3b8",opacity:.5,borderRadius:"4px",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"0.7rem",color:"white",overflow:"hidden",whiteSpace:"nowrap"},title:`Baseline: ${o(s)} - ${o(a)}`,children:[e.jsx($,{size:10,style:{marginRight:"2px"}}),"Baseline"]}),n&&r&&e.jsxs("div",{style:{position:"absolute",left:`${B}px`,top:"40px",width:`${R}px`,height:"24px",backgroundColor:c?.milestoneId===t.id?"#2563eb":"#3b82f6",borderRadius:"4px",display:"flex",alignItems:"center",cursor:g?"move":"default",boxShadow:c?.milestoneId===t.id?"0 4px 12px rgba(59, 130, 246, 0.4)":"none",transition:c?"none":"box-shadow 0.2s"},title:`Actual/Forecast: ${o(n)} - ${o(r)}`,onMouseDown:l=>b(l,t,"move"),children:[g&&e.jsx("div",{style:{position:"absolute",left:0,top:0,width:"8px",height:"100%",cursor:"ew-resize",backgroundColor:"rgba(255,255,255,0.3)",borderRadius:"4px 0 0 4px"},onMouseDown:l=>{l.stopPropagation(),b(l,t,"start")}}),e.jsx("div",{style:{flex:1,textAlign:"center",fontSize:"0.75rem",color:"white",fontWeight:"500",overflow:"hidden",whiteSpace:"nowrap",padding:"0 10px"},children:R>100?`${o(n)} - ${o(r)}`:""}),g&&e.jsx("div",{style:{position:"absolute",right:0,top:0,width:"8px",height:"100%",cursor:"ew-resize",backgroundColor:"rgba(255,255,255,0.3)",borderRadius:"0 4px 4px 0"},onMouseDown:l=>{l.stopPropagation(),b(l,t,"end")}})]}),(()=>{const l=m(new Date);return l>0&&l<L?e.jsx("div",{style:{position:"absolute",left:`${l}px`,top:0,bottom:0,width:"2px",backgroundColor:"#ef4444",opacity:.6,zIndex:5}}):null})()]},t.id)})]})})]})}),e.jsxs("div",{className:"card",style:{marginTop:"1.5rem"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Milestone Date Summary"}),e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Ref"}),e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Baseline Start"}),e.jsx("th",{children:"Baseline End"}),e.jsx("th",{children:"Actual Start"}),e.jsx("th",{children:"Forecast End"}),e.jsx("th",{children:"Variance (days)"})]})}),e.jsx("tbody",{children:u.map(t=>{const s=t.baseline_end_date||t.end_date,a=t.forecast_end_date||t.end_date;let n=0;return s&&a&&(n=Math.round((new Date(a)-new Date(s))/(1e3*60*60*24))),e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx(w,{to:`/milestones/${t.id}`,style:{fontFamily:"monospace",fontWeight:"600",color:"#3b82f6"},children:t.milestone_ref})}),e.jsx("td",{children:t.name}),e.jsx("td",{children:o(t.baseline_start_date||t.start_date)}),e.jsx("td",{children:o(t.baseline_end_date||t.end_date)}),e.jsx("td",{children:o(t.actual_start_date||t.start_date)}),e.jsx("td",{children:o(t.forecast_end_date||t.end_date)}),e.jsxs("td",{style:{fontWeight:"600",color:n>0?"#dc2626":n<0?"#16a34a":"#64748b"},children:[n>0?`+${n}`:n," days"]})]},t.id)})})]})]}),e.jsx("div",{className:"card",style:{marginTop:"1.5rem",backgroundColor:"#eff6ff",borderLeft:"4px solid #3b82f6"},children:e.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:"0.75rem"},children:[e.jsx(oe,{size:20,style:{color:"#3b82f6",marginTop:"2px"}}),e.jsxs("div",{children:[e.jsx("h4",{style:{margin:"0 0 0.5rem 0",color:"#1e40af"},children:"Using the Gantt Chart"}),e.jsxs("ul",{style:{margin:0,paddingLeft:"1.25rem",color:"#1e40af",fontSize:"0.9rem"},children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Baseline bars (grey):"})," Fixed dates representing the original plan - cannot be moved"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Actual/Forecast bars (blue):"})," Current schedule - drag to adjust dates"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Drag the whole bar:"})," Move both start and end dates together"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Drag the edges:"})," Adjust start or end date independently"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Red line:"})," Today's date"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Variance:"})," Positive = behind schedule, Negative = ahead of schedule"]}),e.jsx("li",{children:"Changes are saved automatically when you release the mouse"})]})]})]})})]})}export{xe as default};
