import{g as z,u as B,a as K,r as o,s as j,j as e,L as q,y as v,i as w,R as T,X as A,I as b,h as F,v as E}from"./index-CspTly-R.js";import{u as R}from"./usePermissions-dxQSMTTA.js";import{A as N}from"./arrow-left-C-pJy5nj.js";import{P as W}from"./pen-opG0b6Iw.js";import{S as D}from"./save-CA5ETuwq.js";function V(){const{id:d}=z(),h=B(),{role:L}=K(),{canManageKPIs:C}=R(),[r,P]=o.useState(null),[_,g]=o.useState(!0),[c,f]=o.useState(!1),[s,m]=o.useState(!1),[a,l]=o.useState({});o.useEffect(()=>{p()},[d]);async function p(){try{g(!0);const{data:t,error:n}=await j.from("kpis").select("*").eq("id",d).single();if(n)throw n;P(t),l({name:t.name||"",category:t.category||"",target:t.target||"",current_value:t.current_value||"",description:t.description||"",measurement_method:t.measurement_method||"",frequency:t.frequency||"",data_source:t.data_source||"",calculation:t.calculation||"",remediation:t.remediation||"",notes:t.notes||""})}catch(t){console.error("Error fetching KPI:",t)}finally{g(!1)}}async function I(){f(!0);try{const{data:t,error:n}=await j.from("kpis").update({name:a.name,category:a.category,target:parseFloat(a.target)||null,current_value:parseFloat(a.current_value)||null,description:a.description,measurement_method:a.measurement_method,frequency:a.frequency,data_source:a.data_source,calculation:a.calculation,remediation:a.remediation,notes:a.notes}).eq("id",d).select();if(n)throw n;if(!t||t.length===0)throw new Error("Update failed - you may not have permission to edit this KPI.");await p(),m(!1),alert("KPI updated successfully!")}catch(t){console.error("Error updating KPI:",t),alert("Failed to update KPI: "+t.message)}finally{f(!1)}}function S(t,n){const y=parseFloat(t)||0,k=parseFloat(n)||100,u=y/k*100;return y===0?{status:"Not Started",color:"#64748b",bg:"#f1f5f9"}:u>=100?{status:"Achieved",color:"#10b981",bg:"#f0fdf4"}:u>=80?{status:"On Track",color:"#3b82f6",bg:"#eff6ff"}:u>=60?{status:"At Risk",color:"#f59e0b",bg:"#fffbeb"}:{status:"Critical",color:"#ef4444",bg:"#fef2f2"}}if(_)return e.jsx(q,{message:"Loading KPI details...",size:"large",fullPage:!0});if(!r)return e.jsx("div",{className:"page-container",children:e.jsxs("div",{className:"card",style:{textAlign:"center",padding:"3rem"},children:[e.jsx(v,{size:48,style:{color:"#f59e0b",marginBottom:"1rem"}}),e.jsx("h2",{children:"KPI Not Found"}),e.jsx("p",{style:{color:"#64748b"},children:"The requested KPI could not be found."}),e.jsxs("button",{className:"btn btn-primary",onClick:()=>h("/kpis"),style:{marginTop:"1rem"},children:[e.jsx(N,{size:16})," Back to KPIs"]})]})});const i=S(r.current_value,r.target),x=C;return e.jsxs("div",{className:"page-container",children:[e.jsxs("div",{className:"page-header",children:[e.jsxs("div",{className:"page-title",children:[e.jsx("button",{onClick:()=>h("/kpis"),style:{background:"none",border:"none",cursor:"pointer",marginRight:"0.5rem"},children:e.jsx(N,{size:24})}),e.jsx(w,{size:28}),e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem"},children:[e.jsx("h1",{children:r.kpi_ref}),e.jsx("span",{style:{padding:"0.25rem 0.75rem",borderRadius:"9999px",fontSize:"0.85rem",fontWeight:"500",backgroundColor:i.bg,color:i.color},children:i.status})]}),e.jsx("p",{children:r.name})]})]}),x&&!s&&e.jsxs("button",{className:"btn btn-primary",onClick:()=>m(!0),children:[e.jsx(W,{size:18})," Edit KPI Details"]}),s&&e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsxs("button",{className:"btn btn-primary",onClick:I,disabled:c,children:[c?e.jsx(T,{size:18,className:"spin"}):e.jsx(D,{size:18}),c?"Saving...":"Save Changes"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:()=>{m(!1),l({name:r.name||"",category:r.category||"",target:r.target||"",current_value:r.current_value||"",description:r.description||"",measurement_method:r.measurement_method||"",frequency:r.frequency||"",data_source:r.data_source||"",calculation:r.calculation||"",remediation:r.remediation||"",notes:r.notes||""})},disabled:c,children:[e.jsx(A,{size:18})," Cancel"]})]})]}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem"},children:[e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-label",children:"Target"}),e.jsxs("div",{className:"stat-value",style:{color:"#3b82f6"},children:[r.target||"-","%"]})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-label",children:"Current"}),e.jsxs("div",{className:"stat-value",style:{color:i.color},children:[r.current_value||"0","%"]})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-label",children:"Category"}),e.jsx("div",{className:"stat-value",style:{fontSize:"1rem"},children:r.category})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-label",children:"Status"}),e.jsx("div",{className:"stat-value",style:{color:i.color,fontSize:"1rem"},children:i.status})]})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"2fr 1fr",gap:"1.5rem"},children:[e.jsxs("div",{children:[e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsxs("h3",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"1rem"},children:[e.jsx(b,{size:20})," Description"]}),s?e.jsx("textarea",{className:"form-input",rows:4,value:a.description,onChange:t=>l({...a,description:t.target.value}),placeholder:"Enter KPI description..."}):e.jsx("p",{style:{color:"#374151",lineHeight:"1.6"},children:r.description||"No description available."})]}),e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsxs("h3",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"1rem"},children:[e.jsx(F,{size:20})," Measurement Method"]}),s?e.jsx("textarea",{className:"form-input",rows:3,value:a.measurement_method,onChange:t=>l({...a,measurement_method:t.target.value}),placeholder:"How is this KPI measured?"}):e.jsx("p",{style:{color:"#374151",lineHeight:"1.6"},children:r.measurement_method||"Not specified."})]}),e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsxs("h3",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"1rem"},children:[e.jsx(E,{size:20})," Calculation Formula"]}),s?e.jsx("textarea",{className:"form-input",rows:2,value:a.calculation,onChange:t=>l({...a,calculation:t.target.value}),placeholder:"Formula or method for calculating this KPI..."}):e.jsx("p",{style:{color:"#374151",fontFamily:"monospace",backgroundColor:"#f1f5f9",padding:"0.75rem",borderRadius:"4px"},children:r.calculation||"Not specified."})]}),e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem",backgroundColor:"#fffbeb",borderLeft:"4px solid #f59e0b"},children:[e.jsxs("h3",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"1rem",color:"#92400e"},children:[e.jsx(v,{size:20})," Remediation Actions"]}),s?e.jsx("textarea",{className:"form-input",rows:3,value:a.remediation,onChange:t=>l({...a,remediation:t.target.value}),placeholder:"What actions are required if target is not met?"}):e.jsx("p",{style:{color:"#92400e",lineHeight:"1.6"},children:r.remediation||"Not specified."})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"KPI Details"}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{style:{fontSize:"0.85rem",color:"#64748b",display:"block",marginBottom:"0.25rem"},children:"Category"}),s?e.jsxs("select",{className:"form-input",value:a.category,onChange:t=>l({...a,category:t.target.value}),children:[e.jsx("option",{value:"",children:"Select category"}),e.jsx("option",{value:"Time Performance",children:"Time Performance"}),e.jsx("option",{value:"Quality of Collaboration",children:"Quality of Collaboration"}),e.jsx("option",{value:"Delivery Performance",children:"Delivery Performance"})]}):e.jsx("div",{style:{fontWeight:"500"},children:r.category||"Not specified"})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{style:{fontSize:"0.85rem",color:"#64748b",display:"block",marginBottom:"0.25rem"},children:"Frequency"}),s?e.jsxs("select",{className:"form-input",value:a.frequency,onChange:t=>l({...a,frequency:t.target.value}),children:[e.jsx("option",{value:"",children:"Select frequency"}),e.jsx("option",{value:"Weekly",children:"Weekly"}),e.jsx("option",{value:"Monthly",children:"Monthly"}),e.jsx("option",{value:"Quarterly",children:"Quarterly"}),e.jsx("option",{value:"Per Deliverable",children:"Per Deliverable"}),e.jsx("option",{value:"Annually",children:"Annually"})]}):e.jsx("div",{style:{fontWeight:"500"},children:r.frequency||"Not specified"})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{style:{fontSize:"0.85rem",color:"#64748b",display:"block",marginBottom:"0.25rem"},children:"Data Source"}),s?e.jsx("input",{type:"text",className:"form-input",value:a.data_source,onChange:t=>l({...a,data_source:t.target.value}),placeholder:"Where does the data come from?"}):e.jsx("div",{style:{fontWeight:"500"},children:r.data_source||"Not specified"})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{style:{fontSize:"0.85rem",color:"#64748b",display:"block",marginBottom:"0.25rem"},children:"Target Value"}),s?e.jsx("input",{type:"number",className:"form-input",value:a.target,onChange:t=>l({...a,target:t.target.value}),placeholder:"Target %",min:"0",max:"100"}):e.jsxs("div",{style:{fontWeight:"500"},children:[r.target||"-","%"]})]}),e.jsxs("div",{children:[e.jsx("label",{style:{fontSize:"0.85rem",color:"#64748b",display:"block",marginBottom:"0.25rem"},children:"Current Value"}),s?e.jsx("input",{type:"number",className:"form-input",value:a.current_value,onChange:t=>l({...a,current_value:t.target.value}),placeholder:"Current %",min:"0",max:"100"}):e.jsxs("div",{style:{fontWeight:"500",color:i.color},children:[r.current_value||"0","%"]})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Notes"}),s?e.jsx("textarea",{className:"form-input",rows:4,value:a.notes,onChange:t=>l({...a,notes:t.target.value}),placeholder:"Additional notes about this KPI..."}):e.jsx("p",{style:{color:r.notes?"#374151":"#9ca3af",lineHeight:"1.6"},children:r.notes||"No additional notes."})]}),!x&&e.jsx("div",{className:"card",style:{marginTop:"1rem",backgroundColor:"#f1f5f9",borderLeft:"4px solid #64748b"},children:e.jsxs("p",{style:{fontSize:"0.85rem",color:"#64748b",margin:0},children:[e.jsx(b,{size:14,style:{display:"inline",marginRight:"0.5rem",verticalAlign:"middle"}}),"Only Supplier PM and Admin can edit KPIs."]})})]})]})]})}export{V as default};
