import{a as J,b as Y,r as m,s as f,j as e,L as Z,P as ee,i as C,R as te,S as k,C as R,z as B,k as A,X as re,e as S,T as se,A as ie}from"./index-DmdW0Ek6.js";import{u as oe}from"./usePermissions-Dm-BUkcZ.js";import{C as ne}from"./ConfirmDialog-CvSoEcpj.js";import{P as _}from"./plus-Bo2LM58J.js";import{S as ae}from"./save-xaP9uWX7.js";import{P as le}from"./pen-BB0ob8lO.js";function pe(){const{user:P,role:de}=J(),{projectId:h}=Y(),T=(P==null?void 0:P.id)||null,{canManageKPIs:N}=oe(),[c,W]=m.useState([]),[g,D]=m.useState({}),[M,E]=m.useState(!0),[u,p]=m.useState(!1),[b,y]=m.useState(!1),[I,w]=m.useState({isOpen:!1,kpi:null}),[s,d]=m.useState({kpi_ref:"",name:"",category:"Time Performance",target:90,description:"",measurement_method:"",frequency:"Monthly",data_source:"",calculation:"",remediation:""}),q=["Time Performance","Quality of Collaboration","Delivery Performance"],L=["Monthly","Quarterly","Annually"];m.useEffect(()=>{h&&j(h)},[h]),m.useEffect(()=>{if(u&&c.length>0){const t=c.reduce((o,i)=>{var n;const a=parseInt(((n=i.kpi_ref)==null?void 0:n.replace("KPI",""))||"0");return a>o?a:o},0),r=`KPI${String(t+1).padStart(2,"0")}`;d(o=>({...o,kpi_ref:r}))}else u&&d(t=>({...t,kpi_ref:"KPI01"}))},[u,c]);async function j(t){const r=t||h;if(r)try{const{data:o,error:i}=await f.from("kpis").select("*").eq("project_id",r).order("kpi_ref");if(i)throw i;W(o||[]);const{data:a}=await f.from("deliverable_kpi_assessments").select("kpi_id, criteria_met"),n={};a&&a.forEach(l=>{n[l.kpi_id]||(n[l.kpi_id]={total:0,met:0,notMet:0}),n[l.kpi_id].total++,l.criteria_met===!0&&n[l.kpi_id].met++,l.criteria_met===!1&&n[l.kpi_id].notMet++}),D(n)}catch(o){console.error("Error fetching KPIs:",o)}finally{E(!1)}}async function O(){if(!s.kpi_ref||!s.name){alert("Please fill in at least KPI Reference and Name");return}if(c.some(r=>r.kpi_ref.toLowerCase()===s.kpi_ref.toLowerCase())){alert(`KPI with reference "${s.kpi_ref}" already exists. Please use a different reference.`);return}y(!0);try{const{error:r}=await f.from("kpis").insert({project_id:h,kpi_ref:s.kpi_ref.toUpperCase(),name:s.name,category:s.category,target:parseInt(s.target)||90,unit:"%",description:s.description||null,measurement_method:s.measurement_method||null,frequency:s.frequency||"Monthly",data_source:s.data_source||null,calculation:s.calculation||null,remediation:s.remediation||null,current_value:0,created_by:T});if(r)throw r;await j(),p(!1),d({kpi_ref:"",name:"",category:"Time Performance",target:90,description:"",measurement_method:"",frequency:"Monthly",data_source:"",calculation:"",remediation:""}),alert("KPI added successfully!")}catch(r){console.error("Error adding KPI:",r),alert("Failed to add KPI: "+r.message)}finally{y(!1)}}function F(t){w({isOpen:!0,kpi:t})}async function $(){const t=I.kpi;if(t){y(!0);try{const r=g[t.id],o=r&&r.total>0,{data:i}=await f.from("deliverable_kpis").select("id").eq("kpi_id",t.id),a=i&&i.length>0;if(o){const{error:l}=await f.from("deliverable_kpi_assessments").delete().eq("kpi_id",t.id);if(l)throw l}if(a){const{error:l}=await f.from("deliverable_kpis").delete().eq("kpi_id",t.id);if(l)throw l}const{error:n}=await f.from("kpis").delete().eq("id",t.id);if(n)throw n;await j(),w({isOpen:!1,kpi:null})}catch(r){console.error("Error deleting KPI:",r),alert("Failed to delete KPI: "+r.message)}finally{y(!1)}}}function U(t){if(!t)return"";const r=g[t.id],o=r&&r.total>0;let i=`This will permanently delete KPI "${t.kpi_ref}: ${t.name}".`;return o&&(i+=` This KPI has ${r.total} assessment(s) that will also be deleted.`),i+=" This action cannot be undone.",i}function x(t){const r=g[t.id],o=t.target||90;if(!r||r.total===0)return{label:"Not Started",color:"#64748b",bg:"#f1f5f9",icon:A};const i=r.total>0?Math.round(r.met/r.total*100):0;return i>=o?{label:"Achieved",color:"#10b981",bg:"#f0fdf4",icon:R}:i>=o*.8?{label:"On Track",color:"#3b82f6",bg:"#eff6ff",icon:C}:i>=o*.6?{label:"At Risk",color:"#f59e0b",bg:"#fffbeb",icon:B}:{label:"Critical",color:"#ef4444",bg:"#fef2f2",icon:ie}}function K(t){switch(t){case"Time Performance":return{bg:"#dbeafe",color:"#2563eb"};case"Quality of Collaboration":return{bg:"#f3e8ff",color:"#7c3aed"};case"Delivery Performance":return{bg:"#dcfce7",color:"#16a34a"};default:return{bg:"#f1f5f9",color:"#64748b"}}}const H=c.reduce((t,r)=>{const o=r.category||"Other";return t[o]||(t[o]=[]),t[o].push(r),t},{}),Q=c.length,V=c.filter(t=>x(t).label==="Achieved").length,X=c.filter(t=>{const r=x(t);return r.label==="At Risk"||r.label==="Critical"}).length,G=c.filter(t=>x(t).label==="Not Started").length,v=N;return M&&!h?e.jsx(Z,{message:"Loading KPIs...",size:"large",fullPage:!0}):e.jsxs("div",{className:"page-container",children:[e.jsxs(ee,{icon:C,title:"Key Performance Indicators",subtitle:"Track project performance against SOW targets",children:[e.jsxs("button",{className:"btn btn-secondary",onClick:()=>j(),children:[e.jsx(te,{size:18})," Refresh"]}),v&&!u&&e.jsxs("button",{className:"btn btn-primary",onClick:()=>p(!0),children:[e.jsx(_,{size:18})," Add KPI"]})]}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem"},children:[e.jsx(k,{icon:C,label:"Total KPIs",value:Q,color:"#3b82f6"}),e.jsx(k,{icon:R,label:"Achieved",value:V,color:"#10b981"}),e.jsx(k,{icon:B,label:"At Risk / Critical",value:X,color:"#ef4444"}),e.jsx(k,{icon:A,label:"Not Started",value:G,color:"#64748b"})]}),u&&v&&e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem",border:"2px solid #10b981"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"1rem"},children:[e.jsxs("h3",{style:{margin:0,display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(_,{size:20,style:{color:"#10b981"}}),"Add New KPI"]}),e.jsx("button",{onClick:()=>p(!1),style:{padding:"0.5rem",backgroundColor:"#f1f5f9",color:"#64748b",border:"none",borderRadius:"4px",cursor:"pointer"},children:e.jsx(re,{size:18})})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"120px 1fr 200px",gap:"1rem",marginBottom:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem",fontSize:"0.9rem"},children:"KPI Reference *"}),e.jsx("input",{type:"text",value:s.kpi_ref,onChange:t=>d({...s,kpi_ref:t.target.value.toUpperCase()}),placeholder:"KPI12",style:{width:"100%",padding:"0.5rem",border:"1px solid #d1d5db",borderRadius:"6px",fontFamily:"monospace",fontWeight:"600"}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem",fontSize:"0.9rem"},children:"Name *"}),e.jsx("input",{type:"text",value:s.name,onChange:t=>d({...s,name:t.target.value}),placeholder:"KPI name",style:{width:"100%",padding:"0.5rem",border:"1px solid #d1d5db",borderRadius:"6px"}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem",fontSize:"0.9rem"},children:"Category *"}),e.jsx("select",{value:s.category,onChange:t=>d({...s,category:t.target.value}),style:{width:"100%",padding:"0.5rem",border:"1px solid #d1d5db",borderRadius:"6px",backgroundColor:"white"},children:q.map(t=>e.jsx("option",{value:t,children:t},t))})]})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"120px 150px 1fr",gap:"1rem",marginBottom:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem",fontSize:"0.9rem"},children:"Target (%)"}),e.jsx("input",{type:"number",value:s.target,onChange:t=>d({...s,target:t.target.value}),min:"0",max:"100",style:{width:"100%",padding:"0.5rem",border:"1px solid #d1d5db",borderRadius:"6px"}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem",fontSize:"0.9rem"},children:"Frequency"}),e.jsx("select",{value:s.frequency,onChange:t=>d({...s,frequency:t.target.value}),style:{width:"100%",padding:"0.5rem",border:"1px solid #d1d5db",borderRadius:"6px",backgroundColor:"white"},children:L.map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem",fontSize:"0.9rem"},children:"Data Source"}),e.jsx("input",{type:"text",value:s.data_source,onChange:t=>d({...s,data_source:t.target.value}),placeholder:"e.g., Project Plan and Resource Availability Records",style:{width:"100%",padding:"0.5rem",border:"1px solid #d1d5db",borderRadius:"6px"}})]})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem",fontSize:"0.9rem"},children:"Description"}),e.jsx("textarea",{value:s.description,onChange:t=>d({...s,description:t.target.value}),placeholder:"Describe what this KPI measures and why it's important",rows:2,style:{width:"100%",padding:"0.5rem",border:"1px solid #d1d5db",borderRadius:"6px",resize:"vertical"}})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem",fontSize:"0.9rem"},children:"Measurement Method"}),e.jsx("textarea",{value:s.measurement_method,onChange:t=>d({...s,measurement_method:t.target.value}),placeholder:"How is this KPI measured?",rows:2,style:{width:"100%",padding:"0.5rem",border:"1px solid #d1d5db",borderRadius:"6px",resize:"vertical"}})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem",fontSize:"0.9rem"},children:"Calculation Formula"}),e.jsx("input",{type:"text",value:s.calculation,onChange:t=>d({...s,calculation:t.target.value}),placeholder:"e.g., Number of deliverables approved Ã· total deliverables reviewed",style:{width:"100%",padding:"0.5rem",border:"1px solid #d1d5db",borderRadius:"6px"}})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem",fontSize:"0.9rem"},children:"Remediation Plan"}),e.jsx("textarea",{value:s.remediation,onChange:t=>d({...s,remediation:t.target.value}),placeholder:"What actions should be taken if this KPI target is not met?",rows:2,style:{width:"100%",padding:"0.5rem",border:"1px solid #d1d5db",borderRadius:"6px",resize:"vertical"}})]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem",justifyContent:"flex-end"},children:[e.jsx("button",{onClick:()=>p(!1),className:"btn btn-secondary",disabled:b,children:"Cancel"}),e.jsxs("button",{onClick:O,className:"btn btn-primary",disabled:b||!s.kpi_ref||!s.name,style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(ae,{size:16}),b?"Saving...":"Save KPI"]})]})]}),e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Key Performance Indicators"}),c.length===0?e.jsxs("div",{style:{textAlign:"center",padding:"2rem",color:"#64748b"},children:[e.jsx(C,{size:48,style:{opacity:.3,marginBottom:"1rem"}}),e.jsx("p",{children:"No KPIs defined yet."}),v&&e.jsxs("button",{onClick:()=>p(!0),className:"btn btn-primary",style:{marginTop:"1rem"},children:[e.jsx(_,{size:18})," Add First KPI"]})]}):e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"KPI ID"}),e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Category"}),e.jsx("th",{children:"Target"}),e.jsx("th",{children:"Current"}),e.jsx("th",{children:"Assessments"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:c.map(t=>{const r=x(t),o=K(t.category),i=g[t.id],a=r.icon;return e.jsxs("tr",{children:[e.jsx("td",{style:{fontFamily:"monospace",fontWeight:"600"},children:t.kpi_ref}),e.jsx("td",{children:e.jsx(S,{to:`/kpis/${t.id}`,style:{color:"#3b82f6",textDecoration:"none",fontWeight:"500"},children:t.name})}),e.jsx("td",{children:e.jsx("span",{style:{padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.8rem",backgroundColor:o.bg,color:o.color},children:t.category})}),e.jsxs("td",{style:{textAlign:"center"},children:[t.target,"%"]}),e.jsxs("td",{style:{textAlign:"center",fontWeight:"600",color:r.color},children:[i?Math.round(i.met/i.total*100):0,"%"]}),e.jsx("td",{style:{textAlign:"center"},children:i?e.jsxs("span",{style:{fontSize:"0.85rem",color:"#64748b"},children:[i.met,"/",i.total,e.jsxs("span",{style:{marginLeft:"0.25rem",color:i.notMet>0?"#ef4444":"#10b981"},children:["(",i.notMet>0?`${i.notMet} failed`:"all passed",")"]})]}):e.jsx("span",{style:{fontSize:"0.85rem",color:"#9ca3af"},children:"None yet"})}),e.jsx("td",{children:e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.85rem",backgroundColor:r.bg,color:r.color},children:[e.jsx(a,{size:14}),r.label]})}),e.jsx("td",{children:e.jsxs("div",{style:{display:"flex",gap:"0.25rem"},children:[e.jsx(S,{to:`/kpis/${t.id}`,style:{padding:"0.5rem",backgroundColor:"#f1f5f9",color:"#374151",border:"none",borderRadius:"4px",cursor:"pointer",display:"inline-flex",alignItems:"center"},title:"View/Edit",children:e.jsx(le,{size:16})}),v&&e.jsx("button",{onClick:()=>F(t),style:{padding:"0.5rem",backgroundColor:"#fef2f2",color:"#ef4444",border:"none",borderRadius:"4px",cursor:"pointer",display:"inline-flex",alignItems:"center"},title:"Delete KPI",children:e.jsx(se,{size:16})})]})})]},t.id)})})]})]}),Object.entries(H).map(([t,r])=>{const o=K(t);return e.jsxs("div",{style:{marginBottom:"1.5rem"},children:[e.jsxs("h3",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"1rem"},children:[e.jsx("span",{style:{width:"12px",height:"12px",borderRadius:"50%",backgroundColor:o.color}}),t]}),e.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(280px, 1fr))",gap:"1rem"},children:r.map(i=>{const a=x(i),n=g[i.id],l=a.icon,z=n?Math.round(n.met/n.total*100):0;return e.jsx(S,{to:`/kpis/${i.id}`,style:{textDecoration:"none"},children:e.jsxs("div",{className:"card",style:{cursor:"pointer",transition:"all 0.2s",border:"1px solid #e2e8f0"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:"0.75rem"},children:[e.jsx("span",{style:{fontFamily:"monospace",fontWeight:"600",color:"#64748b"},children:i.kpi_ref}),e.jsx("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.125rem 0.375rem",borderRadius:"9999px",fontSize:"0.75rem",backgroundColor:a.bg,color:a.color},children:e.jsx(l,{size:12})})]}),e.jsxs("div",{style:{fontSize:"1.75rem",fontWeight:"700",color:a.color,marginBottom:"0.25rem"},children:[z,"%"]}),e.jsxs("div",{style:{fontSize:"0.85rem",color:"#64748b",marginBottom:"0.5rem"},children:["Target: ",i.target,"%"]}),e.jsx("div",{style:{width:"100%",height:"6px",backgroundColor:"#e2e8f0",borderRadius:"3px",overflow:"hidden",marginBottom:"0.75rem"},children:e.jsx("div",{style:{width:`${Math.min(z/i.target*100,100)}%`,height:"100%",backgroundColor:a.color,borderRadius:"3px"}})}),e.jsx("div",{style:{fontSize:"0.9rem",fontWeight:"500",color:"#374151"},children:i.name}),n&&n.total>0?e.jsxs("div",{style:{fontSize:"0.8rem",color:"#64748b",marginTop:"0.5rem"},children:[n.met," of ",n.total," assessments passed"]}):e.jsx("div",{style:{fontSize:"0.8rem",color:"#9ca3af",marginTop:"0.5rem"},children:"No assessments yet"})]})},i.id)})})]},t)}),e.jsxs("div",{className:"card",style:{backgroundColor:"#eff6ff",borderLeft:"4px solid #3b82f6"},children:[e.jsx("h4",{style:{marginBottom:"0.5rem",color:"#1e40af"},children:"ðŸ“Š How KPI Scores Work"}),e.jsxs("ul",{style:{margin:"0.5rem 0 0 1.5rem",color:"#1e40af",fontSize:"0.9rem"},children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Not Started"})," - No deliverables with this KPI have been completed yet"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Achieved"})," - Current score meets or exceeds target"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"On Track"})," - Within 80% of target"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"At Risk"})," - Between 60-80% of target"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Critical"})," - Below 60% of target (only for KPIs that have been assessed)"]})]})]}),e.jsx(ne,{isOpen:I.isOpen,onClose:()=>w({isOpen:!1,kpi:null}),onConfirm:$,title:"Delete KPI?",message:U(I.kpi),confirmText:"Delete KPI",cancelText:"Cancel",type:"danger",isLoading:b})]})}export{pe as default};
