import{u as G,a as Y,s as f,j as e,L as Z,P as ee,S as C}from"./index-CNWknIc0.js";import{r as m,L as w}from"./vendor-react-JFEV0ROX.js";import{u as te}from"./usePermissions-DbI6_xNh.js";import{C as re}from"./ConfirmDialog-BH1PnIh_.js";import{m as k,R as se,H as _,C as z,A as R,h as B,a as ie,N as ne,J as oe,T as ae,u as le}from"./vendor-icons-Bd7vp13O.js";import"./vendor-supabase-DgEUAXvv.js";function pe(){const{user:A,role:de}=G(),{projectId:h}=Y(),N=A?.id||null,{canManageKPIs:T}=te(),[c,W]=m.useState([]),[u,D]=m.useState({}),[M,L]=m.useState(!0),[g,p]=m.useState(!1),[b,y]=m.useState(!1),[P,I]=m.useState({isOpen:!1,kpi:null}),[s,d]=m.useState({kpi_ref:"",name:"",category:"Time Performance",target:90,description:"",measurement_method:"",frequency:"Monthly",data_source:"",calculation:"",remediation:""}),q=["Time Performance","Quality of Collaboration","Delivery Performance"],O=["Monthly","Quarterly","Annually"];m.useEffect(()=>{h&&j(h)},[h]),m.useEffect(()=>{if(g&&c.length>0){const t=c.reduce((n,i)=>{const a=parseInt(i.kpi_ref?.replace("KPI","")||"0");return a>n?a:n},0),r=`KPI${String(t+1).padStart(2,"0")}`;d(n=>({...n,kpi_ref:r}))}else g&&d(t=>({...t,kpi_ref:"KPI01"}))},[g,c]);async function j(t){const r=t||h;if(r)try{const{data:n,error:i}=await f.from("kpis").select("*").eq("project_id",r).order("kpi_ref");if(i)throw i;W(n||[]);const{data:a}=await f.from("deliverable_kpi_assessments").select("kpi_id, criteria_met"),o={};a&&a.forEach(l=>{o[l.kpi_id]||(o[l.kpi_id]={total:0,met:0,notMet:0}),o[l.kpi_id].total++,l.criteria_met===!0&&o[l.kpi_id].met++,l.criteria_met===!1&&o[l.kpi_id].notMet++}),D(o)}catch{}finally{L(!1)}}async function F(){if(!s.kpi_ref||!s.name){alert("Please fill in at least KPI Reference and Name");return}if(c.some(r=>r.kpi_ref.toLowerCase()===s.kpi_ref.toLowerCase())){alert(`KPI with reference "${s.kpi_ref}" already exists. Please use a different reference.`);return}y(!0);try{const{error:r}=await f.from("kpis").insert({project_id:h,kpi_ref:s.kpi_ref.toUpperCase(),name:s.name,category:s.category,target:parseInt(s.target)||90,unit:"%",description:s.description||null,measurement_method:s.measurement_method||null,frequency:s.frequency||"Monthly",data_source:s.data_source||null,calculation:s.calculation||null,remediation:s.remediation||null,current_value:0,created_by:N});if(r)throw r;await j(),p(!1),d({kpi_ref:"",name:"",category:"Time Performance",target:90,description:"",measurement_method:"",frequency:"Monthly",data_source:"",calculation:"",remediation:""}),alert("KPI added successfully!")}catch(r){alert("Failed to add KPI: "+r.message)}finally{y(!1)}}function $(t){I({isOpen:!0,kpi:t})}async function E(){const t=P.kpi;if(t){y(!0);try{const r=u[t.id],n=r&&r.total>0,{data:i}=await f.from("deliverable_kpis").select("id").eq("kpi_id",t.id),a=i&&i.length>0;if(n){const{error:l}=await f.from("deliverable_kpi_assessments").delete().eq("kpi_id",t.id);if(l)throw l}if(a){const{error:l}=await f.from("deliverable_kpis").delete().eq("kpi_id",t.id);if(l)throw l}const{error:o}=await f.from("kpis").delete().eq("id",t.id);if(o)throw o;await j(),I({isOpen:!1,kpi:null})}catch(r){alert("Failed to delete KPI: "+r.message)}finally{y(!1)}}}function H(t){if(!t)return"";const r=u[t.id],n=r&&r.total>0;let i=`This will permanently delete KPI "${t.kpi_ref}: ${t.name}".`;return n&&(i+=` This KPI has ${r.total} assessment(s) that will also be deleted.`),i+=" This action cannot be undone.",i}function x(t){const r=u[t.id],n=t.target||90;if(!r||r.total===0)return{label:"Not Started",color:"#64748b",bg:"#f1f5f9",icon:B};const i=r.total>0?Math.round(r.met/r.total*100):0;return i>=n?{label:"Achieved",color:"#10b981",bg:"#f0fdf4",icon:z}:i>=n*.8?{label:"On Track",color:"#3b82f6",bg:"#eff6ff",icon:k}:i>=n*.6?{label:"At Risk",color:"#f59e0b",bg:"#fffbeb",icon:R}:{label:"Critical",color:"#ef4444",bg:"#fef2f2",icon:le}}function S(t){switch(t){case"Time Performance":return{bg:"#dbeafe",color:"#2563eb"};case"Quality of Collaboration":return{bg:"#f3e8ff",color:"#7c3aed"};case"Delivery Performance":return{bg:"#dcfce7",color:"#16a34a"};default:return{bg:"#f1f5f9",color:"#64748b"}}}const U=c.reduce((t,r)=>{const n=r.category||"Other";return t[n]||(t[n]=[]),t[n].push(r),t},{}),Q=c.length,J=c.filter(t=>x(t).label==="Achieved").length,V=c.filter(t=>{const r=x(t);return r.label==="At Risk"||r.label==="Critical"}).length,X=c.filter(t=>x(t).label==="Not Started").length,v=T;return M&&!h?e.jsx(Z,{message:"Loading KPIs...",size:"large",fullPage:!0}):e.jsxs("div",{className:"page-container",children:[e.jsxs(ee,{icon:k,title:"Key Performance Indicators",subtitle:"Track project performance against SOW targets",children:[e.jsxs("button",{className:"btn btn-secondary",onClick:()=>j(),children:[e.jsx(se,{size:18})," Refresh"]}),v&&!g&&e.jsxs("button",{className:"btn btn-primary",onClick:()=>p(!0),children:[e.jsx(_,{size:18})," Add KPI"]})]}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem"},children:[e.jsx(C,{icon:k,label:"Total KPIs",value:Q,color:"#3b82f6"}),e.jsx(C,{icon:z,label:"Achieved",value:J,color:"#10b981"}),e.jsx(C,{icon:R,label:"At Risk / Critical",value:V,color:"#ef4444"}),e.jsx(C,{icon:B,label:"Not Started",value:X,color:"#64748b"})]}),g&&v&&e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem",border:"2px solid #10b981"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"1rem"},children:[e.jsxs("h3",{style:{margin:0,display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(_,{size:20,style:{color:"#10b981"}}),"Add New KPI"]}),e.jsx("button",{onClick:()=>p(!1),style:{padding:"0.5rem",backgroundColor:"#f1f5f9",color:"#64748b",border:"none",borderRadius:"4px",cursor:"pointer"},children:e.jsx(ie,{size:18})})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"120px 1fr 200px",gap:"1rem",marginBottom:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem",fontSize:"0.9rem"},children:"KPI Reference *"}),e.jsx("input",{type:"text",value:s.kpi_ref,onChange:t=>d({...s,kpi_ref:t.target.value.toUpperCase()}),placeholder:"KPI12",style:{width:"100%",padding:"0.5rem",border:"1px solid #d1d5db",borderRadius:"6px",fontFamily:"monospace",fontWeight:"600"}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem",fontSize:"0.9rem"},children:"Name *"}),e.jsx("input",{type:"text",value:s.name,onChange:t=>d({...s,name:t.target.value}),placeholder:"KPI name",style:{width:"100%",padding:"0.5rem",border:"1px solid #d1d5db",borderRadius:"6px"}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem",fontSize:"0.9rem"},children:"Category *"}),e.jsx("select",{value:s.category,onChange:t=>d({...s,category:t.target.value}),style:{width:"100%",padding:"0.5rem",border:"1px solid #d1d5db",borderRadius:"6px",backgroundColor:"white"},children:q.map(t=>e.jsx("option",{value:t,children:t},t))})]})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"120px 150px 1fr",gap:"1rem",marginBottom:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem",fontSize:"0.9rem"},children:"Target (%)"}),e.jsx("input",{type:"number",value:s.target,onChange:t=>d({...s,target:t.target.value}),min:"0",max:"100",style:{width:"100%",padding:"0.5rem",border:"1px solid #d1d5db",borderRadius:"6px"}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem",fontSize:"0.9rem"},children:"Frequency"}),e.jsx("select",{value:s.frequency,onChange:t=>d({...s,frequency:t.target.value}),style:{width:"100%",padding:"0.5rem",border:"1px solid #d1d5db",borderRadius:"6px",backgroundColor:"white"},children:O.map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem",fontSize:"0.9rem"},children:"Data Source"}),e.jsx("input",{type:"text",value:s.data_source,onChange:t=>d({...s,data_source:t.target.value}),placeholder:"e.g., Project Plan and Resource Availability Records",style:{width:"100%",padding:"0.5rem",border:"1px solid #d1d5db",borderRadius:"6px"}})]})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem",fontSize:"0.9rem"},children:"Description"}),e.jsx("textarea",{value:s.description,onChange:t=>d({...s,description:t.target.value}),placeholder:"Describe what this KPI measures and why it's important",rows:2,style:{width:"100%",padding:"0.5rem",border:"1px solid #d1d5db",borderRadius:"6px",resize:"vertical"}})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem",fontSize:"0.9rem"},children:"Measurement Method"}),e.jsx("textarea",{value:s.measurement_method,onChange:t=>d({...s,measurement_method:t.target.value}),placeholder:"How is this KPI measured?",rows:2,style:{width:"100%",padding:"0.5rem",border:"1px solid #d1d5db",borderRadius:"6px",resize:"vertical"}})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem",fontSize:"0.9rem"},children:"Calculation Formula"}),e.jsx("input",{type:"text",value:s.calculation,onChange:t=>d({...s,calculation:t.target.value}),placeholder:"e.g., Number of deliverables approved Ã· total deliverables reviewed",style:{width:"100%",padding:"0.5rem",border:"1px solid #d1d5db",borderRadius:"6px"}})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem",fontSize:"0.9rem"},children:"Remediation Plan"}),e.jsx("textarea",{value:s.remediation,onChange:t=>d({...s,remediation:t.target.value}),placeholder:"What actions should be taken if this KPI target is not met?",rows:2,style:{width:"100%",padding:"0.5rem",border:"1px solid #d1d5db",borderRadius:"6px",resize:"vertical"}})]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem",justifyContent:"flex-end"},children:[e.jsx("button",{onClick:()=>p(!1),className:"btn btn-secondary",disabled:b,children:"Cancel"}),e.jsxs("button",{onClick:F,className:"btn btn-primary",disabled:b||!s.kpi_ref||!s.name,style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(ne,{size:16}),b?"Saving...":"Save KPI"]})]})]}),e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Key Performance Indicators"}),c.length===0?e.jsxs("div",{style:{textAlign:"center",padding:"2rem",color:"#64748b"},children:[e.jsx(k,{size:48,style:{opacity:.3,marginBottom:"1rem"}}),e.jsx("p",{children:"No KPIs defined yet."}),v&&e.jsxs("button",{onClick:()=>p(!0),className:"btn btn-primary",style:{marginTop:"1rem"},children:[e.jsx(_,{size:18})," Add First KPI"]})]}):e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"KPI ID"}),e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Category"}),e.jsx("th",{children:"Target"}),e.jsx("th",{children:"Current"}),e.jsx("th",{children:"Assessments"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:c.map(t=>{const r=x(t),n=S(t.category),i=u[t.id],a=r.icon;return e.jsxs("tr",{children:[e.jsx("td",{style:{fontFamily:"monospace",fontWeight:"600"},children:t.kpi_ref}),e.jsx("td",{children:e.jsx(w,{to:`/kpis/${t.id}`,style:{color:"#3b82f6",textDecoration:"none",fontWeight:"500"},children:t.name})}),e.jsx("td",{children:e.jsx("span",{style:{padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.8rem",backgroundColor:n.bg,color:n.color},children:t.category})}),e.jsxs("td",{style:{textAlign:"center"},children:[t.target,"%"]}),e.jsxs("td",{style:{textAlign:"center",fontWeight:"600",color:r.color},children:[i?Math.round(i.met/i.total*100):0,"%"]}),e.jsx("td",{style:{textAlign:"center"},children:i?e.jsxs("span",{style:{fontSize:"0.85rem",color:"#64748b"},children:[i.met,"/",i.total,e.jsxs("span",{style:{marginLeft:"0.25rem",color:i.notMet>0?"#ef4444":"#10b981"},children:["(",i.notMet>0?`${i.notMet} failed`:"all passed",")"]})]}):e.jsx("span",{style:{fontSize:"0.85rem",color:"#9ca3af"},children:"None yet"})}),e.jsx("td",{children:e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.85rem",backgroundColor:r.bg,color:r.color},children:[e.jsx(a,{size:14}),r.label]})}),e.jsx("td",{children:e.jsxs("div",{style:{display:"flex",gap:"0.25rem"},children:[e.jsx(w,{to:`/kpis/${t.id}`,style:{padding:"0.5rem",backgroundColor:"#f1f5f9",color:"#374151",border:"none",borderRadius:"4px",cursor:"pointer",display:"inline-flex",alignItems:"center"},title:"View/Edit",children:e.jsx(oe,{size:16})}),v&&e.jsx("button",{onClick:()=>$(t),style:{padding:"0.5rem",backgroundColor:"#fef2f2",color:"#ef4444",border:"none",borderRadius:"4px",cursor:"pointer",display:"inline-flex",alignItems:"center"},title:"Delete KPI",children:e.jsx(ae,{size:16})})]})})]},t.id)})})]})]}),Object.entries(U).map(([t,r])=>{const n=S(t);return e.jsxs("div",{style:{marginBottom:"1.5rem"},children:[e.jsxs("h3",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"1rem"},children:[e.jsx("span",{style:{width:"12px",height:"12px",borderRadius:"50%",backgroundColor:n.color}}),t]}),e.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(280px, 1fr))",gap:"1rem"},children:r.map(i=>{const a=x(i),o=u[i.id],l=a.icon,K=o?Math.round(o.met/o.total*100):0;return e.jsx(w,{to:`/kpis/${i.id}`,style:{textDecoration:"none"},children:e.jsxs("div",{className:"card",style:{cursor:"pointer",transition:"all 0.2s",border:"1px solid #e2e8f0"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:"0.75rem"},children:[e.jsx("span",{style:{fontFamily:"monospace",fontWeight:"600",color:"#64748b"},children:i.kpi_ref}),e.jsx("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.125rem 0.375rem",borderRadius:"9999px",fontSize:"0.75rem",backgroundColor:a.bg,color:a.color},children:e.jsx(l,{size:12})})]}),e.jsxs("div",{style:{fontSize:"1.75rem",fontWeight:"700",color:a.color,marginBottom:"0.25rem"},children:[K,"%"]}),e.jsxs("div",{style:{fontSize:"0.85rem",color:"#64748b",marginBottom:"0.5rem"},children:["Target: ",i.target,"%"]}),e.jsx("div",{style:{width:"100%",height:"6px",backgroundColor:"#e2e8f0",borderRadius:"3px",overflow:"hidden",marginBottom:"0.75rem"},children:e.jsx("div",{style:{width:`${Math.min(K/i.target*100,100)}%`,height:"100%",backgroundColor:a.color,borderRadius:"3px"}})}),e.jsx("div",{style:{fontSize:"0.9rem",fontWeight:"500",color:"#374151"},children:i.name}),o&&o.total>0?e.jsxs("div",{style:{fontSize:"0.8rem",color:"#64748b",marginTop:"0.5rem"},children:[o.met," of ",o.total," assessments passed"]}):e.jsx("div",{style:{fontSize:"0.8rem",color:"#9ca3af",marginTop:"0.5rem"},children:"No assessments yet"})]})},i.id)})})]},t)}),e.jsxs("div",{className:"card",style:{backgroundColor:"#eff6ff",borderLeft:"4px solid #3b82f6"},children:[e.jsx("h4",{style:{marginBottom:"0.5rem",color:"#1e40af"},children:"ðŸ“Š How KPI Scores Work"}),e.jsxs("ul",{style:{margin:"0.5rem 0 0 1.5rem",color:"#1e40af",fontSize:"0.9rem"},children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Not Started"})," - No deliverables with this KPI have been completed yet"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Achieved"})," - Current score meets or exceeds target"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"On Track"})," - Within 80% of target"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"At Risk"})," - Between 60-80% of target"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Critical"})," - Below 60% of target (only for KPIs that have been assessed)"]})]})]}),e.jsx(re,{isOpen:P.isOpen,onClose:()=>I({isOpen:!1,kpi:null}),onConfirm:E,title:"Delete KPI?",message:H(P.kpi),confirmText:"Delete KPI",cancelText:"Cancel",type:"danger",isLoading:b})]})}export{pe as default};
