import{u as G,a as J,k as j,j as e,L as ee,s as I}from"./index-OeZ_v13H.js";import{u as te,r as c,L as re}from"./vendor-react-JFEV0ROX.js";import{u as se}from"./usePermissions-R5xloTk0.js";import{S as v}from"./StatCard-tq6sJKiO.js";import{P as ie}from"./PageHeader-M8U7kzer.js";import{C as ne}from"./ConfirmDialog-fKyY4CL7.js";import{q as C,R as ae,Y as w,C as z,A as R,k as B,a as oe,_ as le,Z as de,T as ce,y as me}from"./vendor-icons-BZZethZ5.js";import"./vendor-supabase-DgEUAXvv.js";function ve(){const S=te(),{user:A,role:fe}=G(),{projectId:m}=J(),N=A?.id||null,{canManageKPIs:T}=se(),[d,W]=c.useState([]),[f,D]=c.useState({}),[M,L]=c.useState(!0),[h,u]=c.useState(!1),[p,x]=c.useState(!1),[k,P]=c.useState({isOpen:!1,kpi:null}),[s,l]=c.useState({kpi_ref:"",name:"",category:"Time Performance",target:90,description:"",measurement_method:"",frequency:"Monthly",data_source:"",calculation:"",remediation:""}),O=["Time Performance","Quality of Collaboration","Delivery Performance"],q=["Monthly","Quarterly","Annually"];c.useEffect(()=>{m&&b(m)},[m]),c.useEffect(()=>{if(h&&d.length>0){const t=d.reduce((n,i)=>{const o=parseInt(i.kpi_ref?.replace("KPI","")||"0");return o>n?o:n},0),r=`KPI${String(t+1).padStart(2,"0")}`;l(n=>({...n,kpi_ref:r}))}else h&&l(t=>({...t,kpi_ref:"KPI01"}))},[h,d]);async function b(t){const r=t||m;if(r)try{const n=await j.getAll(r,{orderBy:{column:"kpi_ref",ascending:!0}});W(n||[]);const i=await j.getAssessments(r),o={};i&&i.forEach(a=>{o[a.kpi_id]||(o[a.kpi_id]={total:0,met:0,notMet:0}),o[a.kpi_id].total++,a.criteria_met===!0&&o[a.kpi_id].met++,a.criteria_met===!1&&o[a.kpi_id].notMet++}),D(o)}catch{}finally{L(!1)}}async function F(){if(!s.kpi_ref||!s.name){alert("Please fill in at least KPI Reference and Name");return}if(d.some(r=>r.kpi_ref.toLowerCase()===s.kpi_ref.toLowerCase())){alert(`KPI with reference "${s.kpi_ref}" already exists. Please use a different reference.`);return}x(!0);try{await j.create({project_id:m,kpi_ref:s.kpi_ref.toUpperCase(),name:s.name,category:s.category,target:parseInt(s.target)||90,unit:"%",description:s.description||null,measurement_method:s.measurement_method||null,frequency:s.frequency||"Monthly",data_source:s.data_source||null,calculation:s.calculation||null,remediation:s.remediation||null,current_value:0,created_by:N}),await b(),u(!1),l({kpi_ref:"",name:"",category:"Time Performance",target:90,description:"",measurement_method:"",frequency:"Monthly",data_source:"",calculation:"",remediation:""}),alert("KPI added successfully!")}catch(r){alert("Failed to add KPI: "+r.message)}finally{x(!1)}}function $(t){P({isOpen:!0,kpi:t})}async function E(){const t=k.kpi;if(t){x(!0);try{const r=f[t.id],n=r&&r.total>0,{data:i}=await I.from("deliverable_kpis").select("id").eq("kpi_id",t.id),o=i&&i.length>0;if(n){const{error:a}=await I.from("deliverable_kpi_assessments").delete().eq("kpi_id",t.id);if(a)throw a}if(o){const{error:a}=await I.from("deliverable_kpis").delete().eq("kpi_id",t.id);if(a)throw a}await j.delete(t.id),await b(),P({isOpen:!1,kpi:null})}catch(r){alert("Failed to delete KPI: "+r.message)}finally{x(!1)}}}function U(t){if(!t)return"";const r=f[t.id],n=r&&r.total>0;let i=`This will permanently delete KPI "${t.kpi_ref}: ${t.name}".`;return n&&(i+=` This KPI has ${r.total} assessment(s) that will also be deleted.`),i+=" This action cannot be undone.",i}function g(t){const r=f[t.id],n=t.target||90;if(!r||r.total===0)return{label:"Not Started",color:"#64748b",bg:"#f1f5f9",icon:B};const i=r.total>0?Math.round(r.met/r.total*100):0;return i>=n?{label:"Achieved",color:"#10b981",bg:"#f0fdf4",icon:z}:i>=n*.8?{label:"On Track",color:"#3b82f6",bg:"#eff6ff",icon:C}:i>=n*.6?{label:"At Risk",color:"#f59e0b",bg:"#fffbeb",icon:R}:{label:"Critical",color:"#ef4444",bg:"#fef2f2",icon:me}}function _(t){switch(t){case"Time Performance":return{bg:"#dbeafe",color:"#2563eb"};case"Quality of Collaboration":return{bg:"#f3e8ff",color:"#7c3aed"};case"Delivery Performance":return{bg:"#dcfce7",color:"#16a34a"};default:return{bg:"#f1f5f9",color:"#64748b"}}}const H=d.reduce((t,r)=>{const n=r.category||"Other";return t[n]||(t[n]=[]),t[n].push(r),t},{}),Q=d.length,V=d.filter(t=>g(t).label==="Achieved").length,X=d.filter(t=>{const r=g(t);return r.label==="At Risk"||r.label==="Critical"}).length,Y=d.filter(t=>g(t).label==="Not Started").length,y=T;return M&&!m?e.jsx(ee,{message:"Loading KPIs...",size:"large",fullPage:!0}):e.jsxs("div",{className:"page-container",children:[e.jsxs(ie,{icon:C,title:"Key Performance Indicators",subtitle:"Track project performance against SOW targets",children:[e.jsxs("button",{className:"btn btn-secondary",onClick:()=>b(),children:[e.jsx(ae,{size:18})," Refresh"]}),y&&!h&&e.jsxs("button",{className:"btn btn-primary",onClick:()=>u(!0),children:[e.jsx(w,{size:18})," Add KPI"]})]}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem"},children:[e.jsx(v,{icon:C,label:"Total KPIs",value:Q,color:"#3b82f6"}),e.jsx(v,{icon:z,label:"Achieved",value:V,color:"#10b981"}),e.jsx(v,{icon:R,label:"At Risk / Critical",value:X,color:"#ef4444"}),e.jsx(v,{icon:B,label:"Not Started",value:Y,color:"#64748b"})]}),h&&y&&e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem",border:"2px solid #10b981"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"1rem"},children:[e.jsxs("h3",{style:{margin:0,display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(w,{size:20,style:{color:"#10b981"}}),"Add New KPI"]}),e.jsx("button",{onClick:()=>u(!1),style:{padding:"0.5rem",backgroundColor:"#f1f5f9",color:"#64748b",border:"none",borderRadius:"4px",cursor:"pointer"},children:e.jsx(oe,{size:18})})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"120px 1fr 200px",gap:"1rem",marginBottom:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem",fontSize:"0.9rem"},children:"KPI Reference *"}),e.jsx("input",{type:"text",value:s.kpi_ref,onChange:t=>l({...s,kpi_ref:t.target.value.toUpperCase()}),placeholder:"KPI12",style:{width:"100%",padding:"0.5rem",border:"1px solid #d1d5db",borderRadius:"6px",fontFamily:"monospace",fontWeight:"600"}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem",fontSize:"0.9rem"},children:"Name *"}),e.jsx("input",{type:"text",value:s.name,onChange:t=>l({...s,name:t.target.value}),placeholder:"KPI name",style:{width:"100%",padding:"0.5rem",border:"1px solid #d1d5db",borderRadius:"6px"}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem",fontSize:"0.9rem"},children:"Category *"}),e.jsx("select",{value:s.category,onChange:t=>l({...s,category:t.target.value}),style:{width:"100%",padding:"0.5rem",border:"1px solid #d1d5db",borderRadius:"6px",backgroundColor:"white"},children:O.map(t=>e.jsx("option",{value:t,children:t},t))})]})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"120px 150px 1fr",gap:"1rem",marginBottom:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem",fontSize:"0.9rem"},children:"Target (%)"}),e.jsx("input",{type:"number",value:s.target,onChange:t=>l({...s,target:t.target.value}),min:"0",max:"100",style:{width:"100%",padding:"0.5rem",border:"1px solid #d1d5db",borderRadius:"6px"}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem",fontSize:"0.9rem"},children:"Frequency"}),e.jsx("select",{value:s.frequency,onChange:t=>l({...s,frequency:t.target.value}),style:{width:"100%",padding:"0.5rem",border:"1px solid #d1d5db",borderRadius:"6px",backgroundColor:"white"},children:q.map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem",fontSize:"0.9rem"},children:"Data Source"}),e.jsx("input",{type:"text",value:s.data_source,onChange:t=>l({...s,data_source:t.target.value}),placeholder:"e.g., Project Plan and Resource Availability Records",style:{width:"100%",padding:"0.5rem",border:"1px solid #d1d5db",borderRadius:"6px"}})]})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem",fontSize:"0.9rem"},children:"Description"}),e.jsx("textarea",{value:s.description,onChange:t=>l({...s,description:t.target.value}),placeholder:"Describe what this KPI measures and why it's important",rows:2,style:{width:"100%",padding:"0.5rem",border:"1px solid #d1d5db",borderRadius:"6px",resize:"vertical"}})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem",fontSize:"0.9rem"},children:"Measurement Method"}),e.jsx("textarea",{value:s.measurement_method,onChange:t=>l({...s,measurement_method:t.target.value}),placeholder:"How is this KPI measured?",rows:2,style:{width:"100%",padding:"0.5rem",border:"1px solid #d1d5db",borderRadius:"6px",resize:"vertical"}})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem",fontSize:"0.9rem"},children:"Calculation Formula"}),e.jsx("input",{type:"text",value:s.calculation,onChange:t=>l({...s,calculation:t.target.value}),placeholder:"e.g., Number of deliverables approved Ã· total deliverables reviewed",style:{width:"100%",padding:"0.5rem",border:"1px solid #d1d5db",borderRadius:"6px"}})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem",fontSize:"0.9rem"},children:"Remediation Plan"}),e.jsx("textarea",{value:s.remediation,onChange:t=>l({...s,remediation:t.target.value}),placeholder:"What actions should be taken if this KPI target is not met?",rows:2,style:{width:"100%",padding:"0.5rem",border:"1px solid #d1d5db",borderRadius:"6px",resize:"vertical"}})]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem",justifyContent:"flex-end"},children:[e.jsx("button",{onClick:()=>u(!1),className:"btn btn-secondary",disabled:p,children:"Cancel"}),e.jsxs("button",{onClick:F,className:"btn btn-primary",disabled:p||!s.kpi_ref||!s.name,style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(le,{size:16}),p?"Saving...":"Save KPI"]})]})]}),e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Key Performance Indicators"}),d.length===0?e.jsxs("div",{style:{textAlign:"center",padding:"2rem",color:"#64748b"},children:[e.jsx(C,{size:48,style:{opacity:.3,marginBottom:"1rem"}}),e.jsx("p",{children:"No KPIs defined yet."}),y&&e.jsxs("button",{onClick:()=>u(!0),className:"btn btn-primary",style:{marginTop:"1rem"},children:[e.jsx(w,{size:18})," Add First KPI"]})]}):e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"KPI ID"}),e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Category"}),e.jsx("th",{children:"Target"}),e.jsx("th",{children:"Current"}),e.jsx("th",{children:"Assessments"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:d.map(t=>{const r=g(t),n=_(t.category),i=f[t.id],o=r.icon;return e.jsxs("tr",{onClick:()=>S(`/kpis/${t.id}`),style:{cursor:"pointer"},className:"table-row-clickable",children:[e.jsx("td",{style:{fontFamily:"monospace",fontWeight:"600",color:"#3b82f6"},children:t.kpi_ref}),e.jsx("td",{style:{fontWeight:"500"},children:t.name}),e.jsx("td",{children:e.jsx("span",{style:{padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.8rem",backgroundColor:n.bg,color:n.color},children:t.category})}),e.jsxs("td",{style:{textAlign:"center"},children:[t.target,"%"]}),e.jsxs("td",{style:{textAlign:"center",fontWeight:"600",color:r.color},children:[i?Math.round(i.met/i.total*100):0,"%"]}),e.jsx("td",{style:{textAlign:"center"},children:i?e.jsxs("span",{style:{fontSize:"0.85rem",color:"#64748b"},children:[i.met,"/",i.total,e.jsxs("span",{style:{marginLeft:"0.25rem",color:i.notMet>0?"#ef4444":"#10b981"},children:["(",i.notMet>0?`${i.notMet} failed`:"all passed",")"]})]}):e.jsx("span",{style:{fontSize:"0.85rem",color:"#9ca3af"},children:"None yet"})}),e.jsx("td",{children:e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.85rem",backgroundColor:r.bg,color:r.color},children:[e.jsx(o,{size:14}),r.label]})}),e.jsx("td",{onClick:a=>a.stopPropagation(),children:e.jsxs("div",{style:{display:"flex",gap:"0.25rem"},children:[e.jsx("button",{onClick:()=>S(`/kpis/${t.id}`),style:{padding:"0.5rem",backgroundColor:"#f1f5f9",color:"#374151",border:"none",borderRadius:"4px",cursor:"pointer",display:"inline-flex",alignItems:"center"},title:"View/Edit",children:e.jsx(de,{size:16})}),y&&e.jsx("button",{onClick:()=>$(t),style:{padding:"0.5rem",backgroundColor:"#fef2f2",color:"#ef4444",border:"none",borderRadius:"4px",cursor:"pointer",display:"inline-flex",alignItems:"center"},title:"Delete KPI",children:e.jsx(ce,{size:16})})]})})]},t.id)})})]})]}),Object.entries(H).map(([t,r])=>{const n=_(t);return e.jsxs("div",{style:{marginBottom:"1.5rem"},children:[e.jsxs("h3",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"1rem"},children:[e.jsx("span",{style:{width:"12px",height:"12px",borderRadius:"50%",backgroundColor:n.color}}),t]}),e.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(280px, 1fr))",gap:"1rem"},children:r.map(i=>{const o=g(i),a=f[i.id],Z=o.icon,K=a?Math.round(a.met/a.total*100):0;return e.jsx(re,{to:`/kpis/${i.id}`,style:{textDecoration:"none"},children:e.jsxs("div",{className:"card",style:{cursor:"pointer",transition:"all 0.2s",border:"1px solid #e2e8f0"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:"0.75rem"},children:[e.jsx("span",{style:{fontFamily:"monospace",fontWeight:"600",color:"#64748b"},children:i.kpi_ref}),e.jsx("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.125rem 0.375rem",borderRadius:"9999px",fontSize:"0.75rem",backgroundColor:o.bg,color:o.color},children:e.jsx(Z,{size:12})})]}),e.jsxs("div",{style:{fontSize:"1.75rem",fontWeight:"700",color:o.color,marginBottom:"0.25rem"},children:[K,"%"]}),e.jsxs("div",{style:{fontSize:"0.85rem",color:"#64748b",marginBottom:"0.5rem"},children:["Target: ",i.target,"%"]}),e.jsx("div",{style:{width:"100%",height:"6px",backgroundColor:"#e2e8f0",borderRadius:"3px",overflow:"hidden",marginBottom:"0.75rem"},children:e.jsx("div",{style:{width:`${Math.min(K/i.target*100,100)}%`,height:"100%",backgroundColor:o.color,borderRadius:"3px"}})}),e.jsx("div",{style:{fontSize:"0.9rem",fontWeight:"500",color:"#374151"},children:i.name}),a&&a.total>0?e.jsxs("div",{style:{fontSize:"0.8rem",color:"#64748b",marginTop:"0.5rem"},children:[a.met," of ",a.total," assessments passed"]}):e.jsx("div",{style:{fontSize:"0.8rem",color:"#9ca3af",marginTop:"0.5rem"},children:"No assessments yet"})]})},i.id)})})]},t)}),e.jsxs("div",{className:"card",style:{backgroundColor:"#eff6ff",borderLeft:"4px solid #3b82f6"},children:[e.jsx("h4",{style:{marginBottom:"0.5rem",color:"#1e40af"},children:"ðŸ“Š How KPI Scores Work"}),e.jsxs("ul",{style:{margin:"0.5rem 0 0 1.5rem",color:"#1e40af",fontSize:"0.9rem"},children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Not Started"})," - No deliverables with this KPI have been completed yet"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Achieved"})," - Current score meets or exceeds target"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"On Track"})," - Within 80% of target"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"At Risk"})," - Between 60-80% of target"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Critical"})," - Below 60% of target (only for KPIs that have been assessed)"]})]})]}),e.jsx(ne,{isOpen:k.isOpen,onClose:()=>P({isOpen:!1,kpi:null}),onConfirm:E,title:"Delete KPI?",message:U(k.kpi),confirmText:"Delete KPI",cancelText:"Cancel",type:"danger",isLoading:p})]})}export{ve as default};
