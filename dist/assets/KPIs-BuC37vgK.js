import{u as F,a as W,d as B,k as g,j as e,L as U,s as y}from"./index-Y3jZQyWZ.js";import{d as Q,r as l}from"./vendor-react-BUTV5ZEl.js";import{C as H}from"./ConfirmDialog-BsLqU0qP.js";import{R as X,af as _,c as G,ah as J,W as C,I as V,p as Y,b as Z,A as ee,a5 as se}from"./vendor-icons-Hb5rh3SC.js";import"./vendor-supabase-6faYzd5A.js";function le(){const I=Q(),{user:K}=F(),{projectId:d}=W(),w=K?.id||null,{canManageKPIs:S}=B(),[c,A]=l.useState([]),[k,D]=l.useState({}),[T,R]=l.useState(!0),[v,N]=l.useState(!1),[p,u]=l.useState(!1),[f,x]=l.useState(!1),[h,b]=l.useState({isOpen:!1,kpi:null}),[a,n]=l.useState({kpi_ref:"",name:"",category:"Time Performance",target:90,description:"",measurement_method:"",frequency:"Monthly",data_source:"",calculation:"",remediation:""}),q=["Time Performance","Quality of Collaboration","Delivery Performance"],M=["Monthly","Quarterly","Annually"];l.useEffect(()=>{d&&j(d)},[d]),l.useEffect(()=>{if(p&&c.length>0){const s=c.reduce((t,i)=>{const r=parseInt(i.kpi_ref?.replace("KPI","")||"0");return r>t?r:t},0);n(t=>({...t,kpi_ref:`KPI${String(s+1).padStart(2,"0")}`}))}else p&&n(s=>({...s,kpi_ref:"KPI01"}))},[p,c]);async function j(s){const t=s||d;if(t)try{const i=await g.getAll(t,{orderBy:{column:"kpi_ref",ascending:!0}});A(i||[]);const r=await g.getAssessments(t),m={};r&&r.forEach(o=>{m[o.kpi_id]||(m[o.kpi_id]={total:0,met:0,notMet:0}),m[o.kpi_id].total++,o.criteria_met===!0&&m[o.kpi_id].met++,o.criteria_met===!1&&m[o.kpi_id].notMet++}),D(m)}catch{}finally{R(!1),N(!1)}}async function z(){N(!0),await j()}async function O(){if(!a.kpi_ref||!a.name){alert("Please fill in KPI Reference and Name");return}if(c.some(s=>s.kpi_ref.toLowerCase()===a.kpi_ref.toLowerCase())){alert(`KPI "${a.kpi_ref}" already exists.`);return}x(!0);try{await g.create({project_id:d,kpi_ref:a.kpi_ref.toUpperCase(),name:a.name,category:a.category,target:parseInt(a.target)||90,unit:"%",description:a.description||null,measurement_method:a.measurement_method||null,frequency:a.frequency||"Monthly",data_source:a.data_source||null,calculation:a.calculation||null,remediation:a.remediation||null,current_value:0,created_by:w}),await j(),u(!1),n({kpi_ref:"",name:"",category:"Time Performance",target:90,description:"",measurement_method:"",frequency:"Monthly",data_source:"",calculation:"",remediation:""})}catch(s){alert("Failed to add KPI: "+s.message)}finally{x(!1)}}async function L(){const s=h.kpi;if(s){x(!0);try{const t=k[s.id];t&&t.total>0&&await y.from("deliverable_kpi_assessments").delete().eq("kpi_id",s.id);const{data:i}=await y.from("deliverable_kpis").select("id").eq("kpi_id",s.id);i&&i.length>0&&await y.from("deliverable_kpis").delete().eq("kpi_id",s.id),await g.delete(s.id),await j(),b({isOpen:!1,kpi:null})}catch(t){alert("Failed to delete KPI: "+t.message)}finally{x(!1)}}}function $(s){const t=k[s.id],i=s.target||90;if(!t||t.total===0)return{label:"Not Started",class:"not-started",icon:Y};const r=Math.round(t.met/t.total*100);return r>=i?{label:"Achieved",class:"achieved",icon:Z}:r>=i*.8?{label:"On Track",class:"on-track",icon:C}:r>=i*.6?{label:"At Risk",class:"at-risk",icon:ee}:{label:"Critical",class:"critical",icon:se}}function E(s){switch(s){case"Time Performance":return"time";case"Quality of Collaboration":return"quality";case"Delivery Performance":return"delivery";default:return""}}const P=S;return T&&!d?e.jsx(U,{message:"Loading KPIs...",size:"large",fullPage:!0}):e.jsxs("div",{className:"kpis-page",children:[e.jsx("header",{className:"kpi-header",children:e.jsxs("div",{className:"kpi-header-content",children:[e.jsxs("div",{className:"kpi-header-left",children:[e.jsx("h1",{children:"Key Performance Indicators"}),e.jsx("p",{children:"Track project performance against SOW targets"})]}),e.jsxs("div",{className:"kpi-header-actions",children:[e.jsxs("button",{className:"kpi-btn kpi-btn-secondary",onClick:z,disabled:v,children:[e.jsx(X,{size:18,className:v?"spinning":""})," Refresh"]}),P&&!p&&e.jsxs("button",{className:"kpi-btn kpi-btn-primary",onClick:()=>u(!0),children:[e.jsx(_,{size:18})," Add KPI"]})]})]})}),e.jsxs("div",{className:"kpi-content",children:[p&&P&&e.jsxs("div",{className:"kpi-add-form",children:[e.jsxs("div",{className:"kpi-add-form-header",children:[e.jsxs("h3",{className:"kpi-add-form-title",children:[e.jsx(_,{size:20,style:{color:"var(--ds-teal)"}})," Add New KPI"]}),e.jsx("button",{className:"kpi-add-form-close",onClick:()=>u(!1),children:e.jsx(G,{size:18})})]}),e.jsxs("div",{className:"kpi-form-row three-col",children:[e.jsxs("div",{className:"kpi-form-group",children:[e.jsx("label",{children:"KPI Reference *"}),e.jsx("input",{type:"text",value:a.kpi_ref,onChange:s=>n({...a,kpi_ref:s.target.value.toUpperCase()}),placeholder:"KPI12",style:{fontFamily:"var(--ds-font-mono)",fontWeight:600}})]}),e.jsxs("div",{className:"kpi-form-group",children:[e.jsx("label",{children:"Name *"}),e.jsx("input",{type:"text",value:a.name,onChange:s=>n({...a,name:s.target.value}),placeholder:"KPI name"})]}),e.jsxs("div",{className:"kpi-form-group",children:[e.jsx("label",{children:"Category *"}),e.jsx("select",{value:a.category,onChange:s=>n({...a,category:s.target.value}),children:q.map(s=>e.jsx("option",{value:s,children:s},s))})]})]}),e.jsxs("div",{className:"kpi-form-row three-col",children:[e.jsxs("div",{className:"kpi-form-group",children:[e.jsx("label",{children:"Target (%)"}),e.jsx("input",{type:"number",value:a.target,onChange:s=>n({...a,target:s.target.value}),min:"0",max:"100"})]}),e.jsxs("div",{className:"kpi-form-group",children:[e.jsx("label",{children:"Frequency"}),e.jsx("select",{value:a.frequency,onChange:s=>n({...a,frequency:s.target.value}),children:M.map(s=>e.jsx("option",{value:s,children:s},s))})]}),e.jsxs("div",{className:"kpi-form-group",children:[e.jsx("label",{children:"Data Source"}),e.jsx("input",{type:"text",value:a.data_source,onChange:s=>n({...a,data_source:s.target.value}),placeholder:"e.g., Project Plan Records"})]})]}),e.jsxs("div",{className:"kpi-form-group",style:{marginBottom:16},children:[e.jsx("label",{children:"Description"}),e.jsx("textarea",{value:a.description,onChange:s=>n({...a,description:s.target.value}),placeholder:"Describe what this KPI measures",rows:2})]}),e.jsxs("div",{className:"kpi-form-actions",children:[e.jsx("button",{className:"kpi-btn kpi-btn-secondary",onClick:()=>u(!1),disabled:f,children:"Cancel"}),e.jsxs("button",{className:"kpi-btn kpi-btn-primary",onClick:O,disabled:f||!a.kpi_ref||!a.name,children:[e.jsx(J,{size:16})," ",f?"Saving...":"Save KPI"]})]})]}),e.jsxs("div",{className:"kpi-table-card",children:[e.jsxs("div",{className:"kpi-table-header",children:[e.jsx("h2",{className:"kpi-table-title",children:"Key Performance Indicators"}),e.jsxs("span",{className:"kpi-table-count",children:[c.length," KPI",c.length!==1?"s":""]})]}),c.length===0?e.jsxs("div",{className:"kpi-empty",children:[e.jsx("div",{className:"kpi-empty-icon",children:e.jsx(C,{size:32})}),e.jsx("div",{className:"kpi-empty-title",children:"No KPIs defined yet"}),e.jsx("div",{className:"kpi-empty-text",children:'Click "Add KPI" to create your first KPI.'})]}):e.jsxs("table",{className:"kpi-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"KPI ID"}),e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Category"}),e.jsx("th",{children:"Target"}),e.jsx("th",{children:"Current"}),e.jsx("th",{children:"Assessments"})]})}),e.jsx("tbody",{children:c.map(s=>{const t=$(s),i=k[s.id],r=i?Math.round(i.met/i.total*100):0;return e.jsxs("tr",{onClick:()=>I(`/kpis/${s.id}`),children:[e.jsx("td",{children:e.jsx("span",{className:"kpi-ref",children:s.kpi_ref})}),e.jsx("td",{children:e.jsx("span",{className:"kpi-name",children:s.name})}),e.jsx("td",{children:e.jsx("span",{className:`kpi-category-badge ${E(s.category)}`,children:s.category})}),e.jsx("td",{children:e.jsxs("span",{className:"kpi-target",children:[s.target,"%"]})}),e.jsx("td",{children:e.jsxs("span",{className:`kpi-current ${t.class}`,children:[r,"%"]})}),e.jsx("td",{children:i?e.jsxs("span",{className:"kpi-assessments",children:[i.met,"/",i.total," passed"]}):e.jsx("span",{className:"kpi-assessments-none",children:"None yet"})})]},s.id)})})]})]}),e.jsxs("div",{className:"kpi-info-box",children:[e.jsxs("div",{className:"kpi-info-header",children:[e.jsx(V,{size:18})," How KPI Scores Work"]}),e.jsxs("ul",{className:"kpi-info-list",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Not Started"})," — No deliverables with this KPI have been assessed yet"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Achieved"})," — Current score meets or exceeds target"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"On Track"})," — Within 80% of target"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"At Risk"})," — Between 60-80% of target"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Critical"})," — Below 60% of target"]}),e.jsx("li",{children:"Click any row to view details and manage assessments"})]})]})]}),e.jsx(H,{isOpen:h.isOpen,onClose:()=>b({isOpen:!1,kpi:null}),onConfirm:L,title:"Delete KPI?",message:h.kpi?`This will permanently delete "${h.kpi.kpi_ref}: ${h.kpi.name}".`:"",confirmText:"Delete KPI",cancelText:"Cancel",type:"danger",isLoading:f})]})}export{le as default};
