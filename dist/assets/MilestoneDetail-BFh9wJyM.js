import{j as e,u as ye,c as Be,b as we,m as j,d as ke,L as Ae,s as Me}from"./index-Dn18I8kp.js";import{f as De,u as Pe,r as p,L as H}from"./vendor-react-JFEV0ROX.js";import{C as ze}from"./ConfirmDialog-D41ykVDo.js";import{f as x,i as Ee,a as Fe,c as Le,e as Re,B as Te,h as Ge,b as $e,j as Oe,g as J,d as _,k as Ie}from"./milestoneCalculations-DDt_Nnih.js";import{C as D,$ as Q,E as Ue,a4 as X,a1 as qe,R as We,s as U,P as Ve,V as Ke,h as Y,k as He,a5 as Z,a6 as ee,i as q,a3 as Je}from"./vendor-icons-yzeFIsqS.js";import"./vendor-supabase-DgEUAXvv.js";function se({role:i,signedBy:c,signedAt:n,canSign:d=!1,onSign:k,saving:a=!1,variant:f="default",buttonText:o="Sign to Commit"}){const C=!!n;return e.jsxs("div",{className:`signature-box ${C?"signed":""} ${f}`,children:[e.jsxs("div",{className:"signature-header",children:[e.jsx("span",{className:"signature-role",children:i}),C&&e.jsx(D,{size:16,className:"signed-icon"})]}),C?e.jsxs("div",{className:"signature-info",children:[e.jsxs("div",{className:"signature-name-row",children:[e.jsx(Q,{size:14}),e.jsx("span",{className:"signer-name",children:c})]}),e.jsx("span",{className:"signed-date",children:x(n)})]}):d?e.jsxs("button",{className:`sign-button ${f}`,onClick:k,disabled:a,children:[e.jsx(Q,{size:14}),a?"Signing...":o]}):e.jsx("span",{className:"awaiting-text",children:"Awaiting signature"})]})}function Qe({children:i}){return e.jsx("div",{className:"signature-grid",children:i})}function ae({supplier:i,customer:c,saving:n=!1,supplierButtonText:d="Sign as Supplier PM",customerButtonText:k="Sign as Customer PM"}){return e.jsxs(Qe,{children:[e.jsx(se,{role:"Supplier PM",signedBy:i.signedBy,signedAt:i.signedAt,canSign:i.canSign,onSign:i.onSign,saving:n,buttonText:d}),e.jsx(se,{role:"Customer PM",signedBy:c.signedBy,signedAt:c.signedAt,canSign:c.canSign,onSign:c.onSign,saving:n,variant:"customer",buttonText:k})]})}function Xe({message:i="Both signatures complete",variant:c="success"}){return e.jsxs("div",{className:`signature-complete ${c}`,children:[e.jsx(D,{size:18}),e.jsx("span",{children:i})]})}function Ye(i=null){const{user:c,role:n,profile:d}=ye(),{canEditMilestone:k,canDeleteMilestone:a,canSignAsSupplier:f,canSignAsCustomer:o,canCreateCertificate:C}=Be(),t=n==="admin",P=n==="supplier_pm",L=n==="customer_pm",M=c?.id||null,z=d?.full_name||c?.email||"Unknown",g=i?Ee(i):!1,h=!0,r=k,R=a,S=t||P&&!g,l=!(!f||g||i?.baseline_supplier_pm_signed_at),m=!(!o||g||i?.baseline_customer_pm_signed_at);return{currentUserId:M,currentUserName:z,userRole:n,isAdmin:t,isSupplierPM:P,isCustomerPM:L,canView:h,canEdit:r,canDelete:R,canEditBaseline:S,canSignBaselineAsSupplier:l,canSignBaselineAsCustomer:m,canResetBaseline:t&&g,isBaselineLocked:g,canGenerateCertificate:C,canSignCertificateAsSupplier:u=>!(!f||!u||u.status==="Signed"||u.supplier_pm_signed_at),canSignCertificateAsCustomer:u=>!(!o||!u||u.status==="Signed"||u.customer_pm_signed_at),canSignAsSupplier:f,canSignAsCustomer:o}}function ts(){const{id:i}=De(),c=Pe(),{showSuccess:n,showError:d,showWarning:k}=we(),[a,f]=p.useState(null),[o,C]=p.useState([]),[t,P]=p.useState(null),[L,M]=p.useState(!0),[z,g]=p.useState(!1),[h,r]=p.useState(!1),[R,S]=p.useState(!1),[l,m]=p.useState({}),[y,B]=p.useState({isOpen:!1,type:null}),W=Ye(a),{currentUserId:A,currentUserName:u,canEdit:le,canEditBaseline:E,canSignBaselineAsSupplier:ie,canSignBaselineAsCustomer:te,canResetBaseline:ne,canGenerateCertificate:re,canSignCertificateAsSupplier:ce,canSignCertificateAsCustomer:de}=W,b=p.useCallback(async(s=!1)=>{if(!i){M(!1);return}s&&g(!0);try{const N=await j.getById(i);if(!N){f(null),M(!1),g(!1);return}f(N);const Ce=await ke.getAll(N.project_id,{filters:[{column:"milestone_id",operator:"eq",value:i}],orderBy:{column:"deliverable_ref",ascending:!0}});C(Ce||[]);const Se=await j.getCertificateByMilestoneId(i);P(Se)}catch{d("Failed to load milestone data")}finally{M(!1),g(!1)}},[i,d]);p.useEffect(()=>{b()},[b]);function oe(){m({name:a.name||"",description:a.description||"",baseline_start_date:a.baseline_start_date||"",baseline_end_date:a.baseline_end_date||"",baseline_billable:a.baseline_billable||a.billable||0,start_date:a.start_date||"",forecast_end_date:a.forecast_end_date||"",forecast_billable:a.forecast_billable||a.billable||0,actual_start_date:a.actual_start_date||"",billable:a.billable||0}),S(!0)}async function me(){try{r(!0);const s={name:l.name,description:l.description,start_date:l.start_date||null,forecast_end_date:l.forecast_end_date||null,forecast_billable:parseFloat(l.forecast_billable)||0,actual_start_date:l.actual_start_date||null,billable:parseFloat(l.billable)||0};E&&(s.baseline_start_date=l.baseline_start_date||null,s.baseline_end_date=l.baseline_end_date||null,s.baseline_billable=parseFloat(l.baseline_billable)||0),await j.update(i,s),await b(),S(!1),n("Milestone updated successfully")}catch(s){d("Failed to update milestone: "+s.message)}finally{r(!1)}}async function ue(){try{r(!0),await j.signBaseline(i,"supplier",A,u),await b(),n("Baseline signed as Supplier PM")}catch(s){d("Failed to sign baseline: "+s.message)}finally{r(!1)}}async function he(){try{r(!0),await j.signBaseline(i,"customer",A,u),await b(),n("Baseline signed as Customer PM")}catch(s){d("Failed to sign baseline: "+s.message)}finally{r(!1)}}function pe(){B({isOpen:!0,type:"reset-baseline",title:"Reset Baseline Lock?",message:"This will clear all baseline signatures and unlock the baseline for editing. This action cannot be undone."})}async function be(){try{r(!0),await j.resetBaseline(i),await b(),n("Baseline lock has been reset")}catch(s){d("Failed to reset baseline: "+s.message)}finally{r(!1),B({isOpen:!1,type:null})}}function xe(){B({isOpen:!0,type:"generate-certificate",title:"Generate Acceptance Certificate?",message:`This will create an acceptance certificate for milestone "${a.milestone_ref}" with a billable value of ${_(a.billable)}. The certificate will require dual signatures before billing.`})}async function fe(){try{r(!0);const{data:s}=await Me.from("deliverables").select("deliverable_ref, name, status, progress").eq("milestone_id",i).eq("status","Delivered"),N=`CERT-${a.milestone_ref}-${Date.now().toString(36).toUpperCase()}`;await j.createCertificate({project_id:a.project_id,milestone_id:i,certificate_number:N,milestone_ref:a.milestone_ref,milestone_name:a.name,payment_milestone_value:a.billable||0,status:"Draft",deliverables_snapshot:s||[],generated_by:A,generated_at:new Date().toISOString()}),await b(),n("Certificate generated successfully!")}catch(s){d("Failed to generate certificate: "+s.message)}finally{r(!1),B({isOpen:!1,type:null})}}async function ge(){if(t)try{r(!0),await j.signCertificate(t.id,"supplier",A,u),await b(),n("Certificate signed as Supplier PM")}catch(s){d("Failed to sign certificate: "+s.message)}finally{r(!1)}}async function je(){if(t)try{r(!0),await j.signCertificate(t.id,"customer",A,u),await b(),n("Certificate signed as Customer PM")}catch(s){d("Failed to sign certificate: "+s.message)}finally{r(!1)}}function ve(){switch(y.type){case"reset-baseline":be();break;case"generate-certificate":fe();break;default:B({isOpen:!1,type:null})}}if(L)return e.jsx(Ae,{message:"Loading milestone...",size:"large",fullPage:!0});if(!a)return e.jsx("div",{className:"milestone-detail-page",children:e.jsxs("div",{className:"milestone-not-found",children:[e.jsx(Ue,{size:48}),e.jsx("h2",{children:"Milestone Not Found"}),e.jsxs("button",{onClick:()=>c("/milestones"),children:[e.jsx(X,{size:16})," Back to Milestones"]})]})});const F=Fe(o),V=Le(o),T=o.length,K=o.filter(s=>s.status==="Delivered").length,G=Re(a),$=G===Te.LOCKED,v=a.baseline_billable??a.billable??0,w=a.forecast_billable??a.billable??0,Ne=a.billable??0,_e=Ge(a,o,t)&&re,O=t?$e(t.status):null,I=Oe(t);return e.jsxs("div",{className:"milestone-detail-page",children:[e.jsxs("header",{className:"milestone-header",children:[e.jsx("button",{className:"back-button",onClick:()=>c("/milestones"),children:e.jsx(X,{size:20})}),e.jsxs("div",{className:"milestone-title-block",children:[e.jsxs("div",{className:"milestone-ref-row",children:[e.jsx("span",{className:"milestone-ref",children:a.milestone_ref}),e.jsx("span",{className:`milestone-status ${J(F)}`,children:F})]}),e.jsx("h1",{className:"milestone-name",children:a.name})]}),e.jsxs("div",{className:"header-actions",children:[le&&e.jsxs("button",{className:"edit-button",onClick:oe,children:[e.jsx(qe,{size:18}),"Edit"]}),e.jsx("button",{className:"refresh-button",onClick:()=>b(!0),disabled:z,children:e.jsx(We,{size:18,className:z?"spinning":""})})]})]}),e.jsxs("div",{className:"milestone-content",children:[e.jsxs("div",{className:"metrics-grid",children:[e.jsxs("div",{className:"metric-card",children:[e.jsxs("div",{className:"metric-header",children:[e.jsx(U,{size:18}),e.jsx("span",{children:"Progress"})]}),e.jsxs("div",{className:"metric-value progress-value",children:[e.jsxs("span",{className:"progress-percent",children:[V,"%"]}),e.jsxs("span",{className:"progress-detail",children:[K," of ",T," deliverables"]})]}),e.jsx("div",{className:"progress-bar",children:e.jsx("div",{className:"progress-fill",style:{width:`${V}%`}})})]}),e.jsxs("div",{className:"metric-card",children:[e.jsxs("div",{className:"metric-header",children:[e.jsx(Ve,{size:18}),e.jsx("span",{children:"Forecast Billable"})]}),e.jsx("div",{className:"metric-value currency-value",children:_(w)}),e.jsxs("div",{className:"metric-subtitle",children:[w!==v&&v>0&&e.jsxs("span",{className:w>v?"variance-positive":"variance-negative",children:[w>v?"+":"",_(w-v)," vs baseline"]}),w===v&&"On baseline"]})]})]}),e.jsxs("div",{className:"section-card",children:[e.jsxs("h3",{className:"section-title",children:[e.jsx(Ke,{size:18}),"Schedule"]}),e.jsxs("div",{className:"dates-grid",children:[e.jsxs("div",{className:"date-group",children:[e.jsx("h4",{className:"date-group-title",children:"Baseline"}),e.jsxs("div",{className:"date-row",children:[e.jsx("span",{className:"date-label",children:"Start"}),e.jsx("span",{className:"date-value",children:x(a.baseline_start_date)})]}),e.jsxs("div",{className:"date-row",children:[e.jsx("span",{className:"date-label",children:"End"}),e.jsx("span",{className:"date-value",children:x(a.baseline_end_date)})]}),e.jsxs("div",{className:"date-row",children:[e.jsx("span",{className:"date-label",children:"Billable"}),e.jsx("span",{className:"date-value",children:_(v)})]})]}),e.jsxs("div",{className:"date-group",children:[e.jsx("h4",{className:"date-group-title",children:"Forecast"}),e.jsxs("div",{className:"date-row",children:[e.jsx("span",{className:"date-label",children:"Start"}),e.jsx("span",{className:"date-value",children:x(a.start_date)})]}),e.jsxs("div",{className:"date-row",children:[e.jsx("span",{className:"date-label",children:"End"}),e.jsx("span",{className:"date-value",children:x(a.forecast_end_date)})]}),e.jsxs("div",{className:"date-row",children:[e.jsx("span",{className:"date-label",children:"Billable"}),e.jsx("span",{className:"date-value",children:_(w)})]})]}),e.jsxs("div",{className:"date-group",children:[e.jsx("h4",{className:"date-group-title",children:"Actual"}),e.jsxs("div",{className:"date-row",children:[e.jsx("span",{className:"date-label",children:"Start"}),e.jsx("span",{className:"date-value",children:x(a.actual_start_date)})]}),e.jsxs("div",{className:"date-row",children:[e.jsx("span",{className:"date-label",children:"End"}),e.jsx("span",{className:"date-value",children:F==="Completed"?x(new Date):"—"})]}),e.jsxs("div",{className:"date-row",children:[e.jsx("span",{className:"date-label",children:"Billable"}),e.jsx("span",{className:"date-value",children:_(Ne)})]})]})]})]}),e.jsxs("div",{className:"section-card",children:[e.jsxs("div",{className:"section-header",children:[e.jsxs("h3",{className:"section-title",children:[e.jsx(U,{size:18}),"Deliverables (",T,")"]}),e.jsxs(H,{to:"/deliverables",className:"section-action",children:["Manage Deliverables",e.jsx(Y,{size:16})]})]}),o.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx(U,{size:40,strokeWidth:1.5}),e.jsx("p",{children:"No deliverables assigned to this milestone."}),e.jsx(H,{to:"/deliverables",className:"empty-action",children:"Add Deliverable"})]}):e.jsx("div",{className:"deliverables-list",children:o.map(s=>e.jsxs("div",{className:"deliverable-item",onClick:()=>c(`/deliverables/${s.id}`),children:[e.jsxs("div",{className:"deliverable-main",children:[e.jsx("span",{className:"deliverable-ref",children:s.deliverable_ref}),e.jsx("span",{className:"deliverable-name",children:s.name})]}),e.jsxs("div",{className:"deliverable-meta",children:[e.jsxs("span",{className:"deliverable-progress",children:[s.progress||0,"%"]}),e.jsxs("span",{className:`deliverable-status ${J(s.status)}`,children:[s.status==="Delivered"&&e.jsx(D,{size:12}),s.status==="In Progress"&&e.jsx(He,{size:12}),s.status||"Not Started"]}),e.jsx(Y,{size:16,className:"deliverable-chevron"})]})]},s.id))})]}),e.jsxs("div",{className:"section-card baseline-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsxs("h3",{className:"section-title",children:[$?e.jsx(Z,{size:18}):e.jsx(ee,{size:18}),"Baseline Commitment"]}),e.jsx("span",{className:`baseline-status-badge ${Ie(G)}`,children:G})]}),e.jsxs("div",{className:"baseline-values",children:[e.jsxs("div",{className:"baseline-item",children:[e.jsx("span",{className:"baseline-label",children:"Start Date"}),e.jsx("span",{className:"baseline-value",children:x(a.baseline_start_date)})]}),e.jsxs("div",{className:"baseline-item",children:[e.jsx("span",{className:"baseline-label",children:"End Date"}),e.jsx("span",{className:"baseline-value",children:x(a.baseline_end_date)})]}),e.jsxs("div",{className:"baseline-item",children:[e.jsx("span",{className:"baseline-label",children:"Billable Amount"}),e.jsx("span",{className:"baseline-value",children:_(v)})]})]}),e.jsx(ae,{supplier:{signedBy:a.baseline_supplier_pm_name,signedAt:a.baseline_supplier_pm_signed_at,canSign:ie,onSign:ue},customer:{signedBy:a.baseline_customer_pm_name,signedAt:a.baseline_customer_pm_signed_at,canSign:te,onSign:he},saving:h,supplierButtonText:"Sign to Commit",customerButtonText:"Sign to Commit"}),ne&&e.jsx("div",{className:"admin-actions",children:e.jsxs("button",{className:"reset-button",onClick:pe,disabled:h,children:[e.jsx(ee,{size:16}),h?"Resetting...":"Reset Baseline Lock"]})}),!$&&e.jsx("p",{className:"baseline-info",children:"Both Supplier PM and Customer PM must sign to lock the baseline. Once locked, baseline values can only be changed by an Admin."})]}),e.jsxs("div",{className:"section-card certificate-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsxs("h3",{className:"section-title",children:[e.jsx(q,{size:18}),"Acceptance Certificate"]}),t&&O&&e.jsxs("span",{className:`cert-status-badge ${O.cssClass}`,children:[I&&e.jsx(D,{size:14}),O.label]})]}),!t&&e.jsx("div",{className:"cert-empty",children:F!=="Completed"?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cert-empty-icon",children:e.jsx(Je,{size:40,strokeWidth:1.5})}),e.jsx("p",{className:"cert-empty-text",children:"Certificate can be generated once all deliverables are delivered."}),e.jsxs("div",{className:"cert-progress-hint",children:[e.jsxs("span",{className:"cert-progress-count",children:[K," of ",T]})," deliverables delivered"]})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cert-empty-icon ready",children:e.jsx(q,{size:40,strokeWidth:1.5})}),e.jsx("p",{className:"cert-empty-text",children:"All deliverables have been delivered. Ready to generate certificate."}),_e&&e.jsxs("button",{className:"generate-cert-button",onClick:xe,disabled:h,children:[e.jsx(q,{size:18}),h?"Generating...":"Generate Certificate"]})]})}),t&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cert-info-grid",children:[e.jsxs("div",{className:"cert-info-item",children:[e.jsx("span",{className:"cert-info-label",children:"Certificate Number"}),e.jsx("span",{className:"cert-info-value mono",children:t.certificate_number})]}),e.jsxs("div",{className:"cert-info-item",children:[e.jsx("span",{className:"cert-info-label",children:"Payment Value"}),e.jsx("span",{className:"cert-info-value currency",children:_(t.payment_milestone_value)})]}),e.jsxs("div",{className:"cert-info-item",children:[e.jsx("span",{className:"cert-info-label",children:"Generated"}),e.jsx("span",{className:"cert-info-value",children:x(t.generated_at)})]})]}),t.deliverables_snapshot&&t.deliverables_snapshot.length>0&&e.jsxs("div",{className:"cert-deliverables",children:[e.jsx("h4",{className:"cert-deliverables-title",children:"Deliverables Accepted"}),e.jsx("div",{className:"cert-deliverables-list",children:t.deliverables_snapshot.map((s,N)=>e.jsxs("div",{className:"cert-deliverable-item",children:[e.jsx("span",{className:"cert-del-ref",children:s.deliverable_ref}),e.jsx("span",{className:"cert-del-name",children:s.name}),e.jsx(D,{size:14,className:"cert-del-check"})]},N))})]}),e.jsx(ae,{supplier:{signedBy:t.supplier_pm_name,signedAt:t.supplier_pm_signed_at,canSign:ce(t),onSign:ge},customer:{signedBy:t.customer_pm_name,signedAt:t.customer_pm_signed_at,canSign:de(t),onSign:je},saving:h,supplierButtonText:"Sign as Supplier PM",customerButtonText:"Sign as Customer PM"}),I&&e.jsx(Xe,{message:"Certificate fully signed — Ready to bill",variant:"success"}),!I&&e.jsx("p",{className:"baseline-info",children:"Both Supplier PM and Customer PM must sign to complete the acceptance certificate. Once signed, the milestone payment value can be invoiced."})]})]})]}),R&&e.jsx("div",{className:"modal-overlay",onClick:()=>S(!1),children:e.jsxs("div",{className:"modal-content edit-modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:"Edit Milestone"}),e.jsx("button",{className:"modal-close",onClick:()=>S(!1),children:"×"})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Name"}),e.jsx("input",{type:"text",value:l.name,onChange:s=>m({...l,name:s.target.value})})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Description"}),e.jsx("textarea",{value:l.description,onChange:s=>m({...l,description:s.target.value}),rows:3})]}),e.jsxs("h3",{className:"form-section-title",children:["Baseline",$&&e.jsxs("span",{className:"locked-badge",children:[e.jsx(Z,{size:12})," Locked"]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Baseline Start"}),e.jsx("input",{type:"date",value:l.baseline_start_date,onChange:s=>m({...l,baseline_start_date:s.target.value}),disabled:!E})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Baseline End"}),e.jsx("input",{type:"date",value:l.baseline_end_date,onChange:s=>m({...l,baseline_end_date:s.target.value}),disabled:!E})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Baseline Billable (£)"}),e.jsx("input",{type:"number",step:"0.01",value:l.baseline_billable,onChange:s=>m({...l,baseline_billable:s.target.value}),disabled:!E})]}),e.jsx("h3",{className:"form-section-title",children:"Forecast"}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Forecast Start"}),e.jsx("input",{type:"date",value:l.start_date,onChange:s=>m({...l,start_date:s.target.value})})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Forecast End"}),e.jsx("input",{type:"date",value:l.forecast_end_date,onChange:s=>m({...l,forecast_end_date:s.target.value})})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Forecast Billable (£)"}),e.jsx("input",{type:"number",step:"0.01",value:l.forecast_billable,onChange:s=>m({...l,forecast_billable:s.target.value})})]}),e.jsx("h3",{className:"form-section-title",children:"Actual"}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Actual Start"}),e.jsx("input",{type:"date",value:l.actual_start_date,onChange:s=>m({...l,actual_start_date:s.target.value})})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Current Billable (£)"}),e.jsx("input",{type:"number",step:"0.01",value:l.billable,onChange:s=>m({...l,billable:s.target.value})}),e.jsx("span",{className:"form-hint",children:"The billable amount to be invoiced"})]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn-secondary",onClick:()=>S(!1),children:"Cancel"}),e.jsx("button",{className:"btn-primary",onClick:me,disabled:h,children:h?"Saving...":"Save Changes"})]})]})}),e.jsx(ze,{isOpen:y.isOpen,onClose:()=>B({isOpen:!1,type:null}),onConfirm:ve,title:y.title||"Confirm Action",message:y.message||"",confirmText:y.type==="reset-baseline"?"Reset Baseline":"Generate Certificate",cancelText:"Cancel",type:y.type==="reset-baseline"?"danger":"info",isLoading:h})]})}export{ts as default};
