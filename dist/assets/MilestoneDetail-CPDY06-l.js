import{g as $,u as H,r as f,s as v,j as e,L as q,A as G,h as O,I as K,D as J,i as Q,U as V,k as D,e as S,l as R,C as X}from"./index-BQkRTEk6.js";import{A as B}from"./arrow-left-rwV6fwmv.js";import{C as _}from"./calendar-GZc4aDit.js";function se(){const{id:u}=$(),k=H(),[o,I]=f.useState(null),[c,W]=f.useState([]),[C,L]=f.useState([]),[M,P]=f.useState(!0);f.useEffect(()=>{T()},[u]);function A(s){if(!s||s.length===0)return"Not Started";const i=s.every(t=>t.status==="Not Started"||!t.status);return s.every(t=>t.status==="Delivered")?"Completed":i?"Not Started":"In Progress"}async function T(){try{const{data:s,error:i}=await v.from("milestones").select("*").eq("id",u).single();if(i)throw i;I(s);const{data:d,error:t}=await v.from("deliverables").select("*, deliverable_kpis(kpi_id, kpis(kpi_ref, name))").eq("milestone_id",u).order("deliverable_ref");if(t)throw t;W(d||[]);const{data:a,error:n}=await v.from("timesheets").select("*, resources(id, name, daily_rate, discount_percent)").eq("milestone_id",u).order("date",{ascending:!1});n||L(a||[])}catch(s){console.error("Error fetching milestone data:",s)}finally{P(!1)}}function N(s){switch(s){case"Delivered":case"Complete":case"Completed":return{bg:"#dcfce7",color:"#16a34a"};case"In Progress":return{bg:"#dbeafe",color:"#2563eb"};case"Submitted for Review":return{bg:"#fef3c7",color:"#d97706"};case"Returned for More Work":return{bg:"#fee2e2",color:"#dc2626"};case"Review Complete":return{bg:"#f3e8ff",color:"#7c3aed"};case"Not Started":default:return{bg:"#f1f5f9",color:"#64748b"}}}function E(s){switch(s){case"Delivered":case"Complete":case"Completed":return e.jsx(X,{size:12,style:{marginRight:"0.25rem"}});case"In Progress":case"Submitted for Review":case"Review Complete":return e.jsx(D,{size:12,style:{marginRight:"0.25rem"}});default:return null}}if(M)return e.jsx(q,{message:"Loading milestone...",size:"large",fullPage:!0});if(!o)return e.jsx("div",{className:"page-container",children:e.jsxs("div",{className:"card",style:{textAlign:"center",padding:"3rem"},children:[e.jsx(G,{size:48,style:{color:"#f59e0b",marginBottom:"1rem"}}),e.jsx("h2",{children:"Milestone Not Found"}),e.jsxs("button",{className:"btn btn-primary",onClick:()=>k("/milestones"),style:{marginTop:"1rem"},children:[e.jsx(B,{size:16})," Back to Milestones"]})]})});const p=c.length,F=c.filter(s=>s.status==="Delivered").length,y=c.filter(s=>s.status==="In Progress"||s.status==="Submitted for Review"||s.status==="Returned for More Work"||s.status==="Review Complete").length,m=p>0?Math.round(c.reduce((s,i)=>s+(i.progress||0),0)/p):0,h=A(c),w=N(h);return e.jsxs("div",{className:"page-container",children:[e.jsx("div",{className:"page-header",children:e.jsxs("div",{className:"page-title",children:[e.jsx("button",{onClick:()=>k("/milestones"),style:{background:"none",border:"none",cursor:"pointer",marginRight:"0.5rem"},children:e.jsx(B,{size:24})}),e.jsx(O,{size:28}),e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem"},children:[e.jsx("h1",{children:o.milestone_ref}),e.jsx("span",{style:{padding:"0.25rem 0.75rem",borderRadius:"9999px",fontSize:"0.85rem",fontWeight:"500",backgroundColor:w.bg,color:w.color},children:h})]}),e.jsx("p",{children:o.name})]})]})}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem"},children:[e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-label",children:"Total Deliverables"}),e.jsx("div",{className:"stat-value",children:p})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-label",children:"Completed"}),e.jsx("div",{className:"stat-value",style:{color:"#10b981"},children:F})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-label",children:"In Progress"}),e.jsx("div",{className:"stat-value",style:{color:"#3b82f6"},children:y})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-label",children:"Progress"}),e.jsxs("div",{className:"stat-value",style:{color:m>=100?"#10b981":"#3b82f6"},children:[m,"%"]})]})]}),e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"0.5rem"},children:[e.jsx("span",{style:{fontWeight:"500"},children:"Milestone Progress"}),e.jsxs("span",{style:{fontWeight:"600",color:m>=100?"#10b981":"#3b82f6"},children:[m,"%"]})]}),e.jsx("div",{style:{width:"100%",height:"12px",backgroundColor:"#e2e8f0",borderRadius:"6px",overflow:"hidden"},children:e.jsx("div",{style:{width:`${m}%`,height:"100%",backgroundColor:m>=100?"#10b981":"#3b82f6",borderRadius:"6px",transition:"width 0.3s ease"}})})]}),e.jsx("div",{className:"card",style:{marginBottom:"1.5rem",backgroundColor:"#f0f9ff",borderLeft:"4px solid #3b82f6"},children:e.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:"0.75rem"},children:[e.jsx(K,{size:20,style:{color:"#3b82f6",marginTop:"2px"}}),e.jsxs("div",{children:[e.jsxs("h4",{style:{margin:"0 0 0.5rem 0",color:"#1e40af"},children:["Milestone Status: ",h]}),e.jsxs("p",{style:{margin:0,color:"#1e40af",fontSize:"0.9rem"},children:[h==="Not Started"&&'No deliverables have begun. Status will change to "In Progress" when any deliverable starts.',h==="In Progress"&&`${y} deliverable${y!==1?"s are":" is"} currently being worked on. Status will change to "Completed" when all deliverables are delivered.`,h==="Completed"&&"All deliverables have been delivered! ðŸŽ‰"]})]})]})}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"2fr 1fr",gap:"1.5rem",marginBottom:"1.5rem"},children:[e.jsxs("div",{className:"card",children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Description"}),e.jsx("p",{style:{color:"#374151",lineHeight:"1.6"},children:o.description||"No description provided."})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Details"}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"0.75rem"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(_,{size:16,style:{color:"#64748b"}}),e.jsx("span",{style:{color:"#64748b"},children:"Start:"}),e.jsx("span",{style:{fontWeight:"500"},children:o.start_date?new Date(o.start_date).toLocaleDateString("en-GB"):"-"})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(_,{size:16,style:{color:"#64748b"}}),e.jsx("span",{style:{color:"#64748b"},children:"End:"}),e.jsx("span",{style:{fontWeight:"500"},children:o.end_date?new Date(o.end_date).toLocaleDateString("en-GB"):"-"})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(J,{size:16,style:{color:"#64748b"}}),e.jsx("span",{style:{color:"#64748b"},children:"Budget:"}),e.jsxs("span",{style:{fontWeight:"500"},children:["Â£",(o.budget||0).toLocaleString()]})]})]})]})]}),(()=>{const s=C.filter(r=>r.status==="Approved"||r.status==="Submitted"&&!r.was_rejected),i=s.reduce((r,l)=>r+parseFloat(l.hours_worked||l.hours||0),0),d=s.reduce((r,l)=>{const j=parseFloat(l.hours_worked||l.hours||0),x=l.resources;if(x){const b=x.daily_rate||0;return r+j/8*b}return r},0),t=o.budget||0,a=t>0?Math.round(d/t*100):0,n=a>100,g={};return s.forEach(r=>{var z;const l=((z=r.resources)==null?void 0:z.name)||"Unknown",j=parseFloat(r.hours_worked||r.hours||0),x=r.resources;let b=0;if(x){const U=x.daily_rate||0;b=j/8*U}g[l]||(g[l]={hours:0,cost:0}),g[l].hours+=j,g[l].cost+=b}),e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsxs("h3",{style:{marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(Q,{size:20})," Budget & Spend Tracking"]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:"1rem",marginBottom:"1.5rem"},children:[e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#f1f5f9",borderRadius:"8px"},children:[e.jsx("div",{style:{fontSize:"0.85rem",color:"#64748b"},children:"Budget"}),e.jsxs("div",{style:{fontSize:"1.5rem",fontWeight:"700",color:"#3b82f6"},children:["Â£",t.toLocaleString()]})]}),e.jsxs("div",{style:{padding:"1rem",backgroundColor:n?"#fef2f2":"#f0fdf4",borderRadius:"8px"},children:[e.jsx("div",{style:{fontSize:"0.85rem",color:"#64748b"},children:"Spend to Date"}),e.jsxs("div",{style:{fontSize:"1.5rem",fontWeight:"700",color:n?"#dc2626":"#10b981"},children:["Â£",Math.round(d).toLocaleString()]})]}),e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#f1f5f9",borderRadius:"8px"},children:[e.jsx("div",{style:{fontSize:"0.85rem",color:"#64748b"},children:"Hours Logged"}),e.jsxs("div",{style:{fontSize:"1.5rem",fontWeight:"700",color:"#64748b"},children:[i.toFixed(1),"h"]}),e.jsxs("div",{style:{fontSize:"0.75rem",color:"#9ca3af"},children:["(",(i/8).toFixed(1)," days)"]})]}),e.jsxs("div",{style:{padding:"1rem",backgroundColor:a>80?"#fef3c7":"#f1f5f9",borderRadius:"8px"},children:[e.jsx("div",{style:{fontSize:"0.85rem",color:"#64748b"},children:"% of Budget"}),e.jsxs("div",{style:{fontSize:"1.5rem",fontWeight:"700",color:n?"#dc2626":a>80?"#d97706":"#64748b"},children:[a,"%"]})]})]}),e.jsxs("div",{style:{marginBottom:"1.5rem"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.85rem",color:"#64748b"},children:"Budget Utilization"}),e.jsxs("span",{style:{fontSize:"0.85rem",fontWeight:"600",color:n?"#dc2626":"#10b981"},children:["Â£",Math.round(d).toLocaleString()," / Â£",t.toLocaleString()]})]}),e.jsx("div",{style:{width:"100%",height:"10px",backgroundColor:"#e2e8f0",borderRadius:"5px",overflow:"hidden"},children:e.jsx("div",{style:{width:`${Math.min(a,100)}%`,height:"100%",backgroundColor:n?"#dc2626":a>80?"#f59e0b":"#10b981",borderRadius:"5px"}})})]}),Object.keys(g).length>0&&e.jsxs("div",{children:[e.jsx("h4",{style:{marginBottom:"0.75rem",fontSize:"0.9rem",color:"#374151"},children:"Spend by Resource"}),e.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"0.75rem"},children:Object.entries(g).map(([r,l])=>e.jsxs("div",{style:{padding:"0.75rem 1rem",backgroundColor:"#f8fafc",borderRadius:"8px",border:"1px solid #e2e8f0",minWidth:"150px"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"0.25rem"},children:[e.jsx(V,{size:14,style:{color:"#64748b"}}),e.jsx("span",{style:{fontWeight:"600",fontSize:"0.9rem"},children:r})]}),e.jsxs("div",{style:{color:"#10b981",fontWeight:"700"},children:["Â£",Math.round(l.cost).toLocaleString()]}),e.jsxs("div",{style:{fontSize:"0.75rem",color:"#64748b"},children:[l.hours.toFixed(1),"h logged"]})]},r))})]}),C.length===0&&e.jsxs("div",{style:{textAlign:"center",padding:"1.5rem",color:"#64748b",backgroundColor:"#f8fafc",borderRadius:"8px"},children:[e.jsx(D,{size:32,style:{marginBottom:"0.5rem",opacity:.5}}),e.jsx("p",{style:{margin:0},children:"No timesheets logged against this milestone yet."}),e.jsx(S,{to:"/timesheets",style:{color:"#3b82f6",fontSize:"0.9rem"},children:"Log time â†’"})]})]})})(),e.jsxs("div",{className:"card",children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"1rem"},children:[e.jsxs("h3",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(R,{size:20})," Deliverables (",p,")"]}),e.jsx(S,{to:"/deliverables",className:"btn btn-secondary",style:{textDecoration:"none"},children:"Manage Deliverables"})]}),c.length===0?e.jsxs("div",{style:{textAlign:"center",padding:"2rem",color:"#64748b"},children:[e.jsx(R,{size:48,style:{marginBottom:"1rem",opacity:.5}}),e.jsx("p",{children:"No deliverables assigned to this milestone yet."}),e.jsx("p",{style:{fontSize:"0.9rem",marginTop:"0.5rem"},children:"Add deliverables to this milestone to track progress automatically."}),e.jsx(S,{to:"/deliverables",className:"btn btn-primary",style:{marginTop:"1rem",textDecoration:"none"},children:"Add Deliverable"})]}):e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Ref"}),e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Progress"}),e.jsx("th",{children:"Linked KPIs"}),e.jsx("th",{children:"Due Date"})]})}),e.jsx("tbody",{children:c.map(s=>{var d;const i=N(s.status);return e.jsxs("tr",{children:[e.jsx("td",{style:{fontFamily:"monospace",fontWeight:"600"},children:s.deliverable_ref}),e.jsx("td",{style:{fontWeight:"500"},children:s.name}),e.jsx("td",{children:e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.85rem",backgroundColor:i.bg,color:i.color},children:[E(s.status),s.status||"Not Started"]})}),e.jsx("td",{children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("div",{style:{width:"60px",height:"6px",backgroundColor:"#e2e8f0",borderRadius:"3px",overflow:"hidden"},children:e.jsx("div",{style:{width:`${s.progress||0}%`,height:"100%",backgroundColor:s.status==="Delivered"?"#10b981":"#3b82f6",borderRadius:"3px"}})}),e.jsxs("span",{style:{fontSize:"0.85rem",color:"#64748b"},children:[s.progress||0,"%"]})]})}),e.jsx("td",{children:e.jsxs("div",{style:{display:"flex",flexWrap:"wrap",gap:"0.25rem"},children:[(d=s.deliverable_kpis)==null?void 0:d.map((t,a)=>{var n;return e.jsx("span",{style:{padding:"0.125rem 0.375rem",backgroundColor:"#dbeafe",color:"#2563eb",borderRadius:"4px",fontSize:"0.75rem",fontWeight:"500"},children:(n=t.kpis)==null?void 0:n.kpi_ref},a)}),(!s.deliverable_kpis||s.deliverable_kpis.length===0)&&e.jsx("span",{style:{color:"#9ca3af",fontSize:"0.85rem"},children:"None"})]})}),e.jsx("td",{children:s.due_date?new Date(s.due_date).toLocaleDateString("en-GB"):"-"})]},s.id)})})]})]}),e.jsxs("div",{className:"card",style:{marginTop:"1.5rem",backgroundColor:"#eff6ff",borderLeft:"4px solid #3b82f6"},children:[e.jsx("h4",{style:{marginBottom:"0.5rem",color:"#1e40af"},children:"ðŸ’¡ How Milestone Status Works"}),e.jsxs("ul",{style:{margin:"0.5rem 0 0 1.5rem",color:"#1e40af",fontSize:"0.9rem"},children:[e.jsxs("li",{children:["Milestone status is ",e.jsx("strong",{children:"automatically calculated"})," from deliverable statuses"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Not Started:"}),' All deliverables are "Not Started"']}),e.jsxs("li",{children:[e.jsx("strong",{children:"In Progress:"})," At least one deliverable has begun (In Progress, Submitted, In Review, etc.)"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Completed:"}),' All deliverables have been "Delivered"']}),e.jsx("li",{children:"Progress % = average of all deliverable progress percentages"})]})]})]})}export{se as default};
