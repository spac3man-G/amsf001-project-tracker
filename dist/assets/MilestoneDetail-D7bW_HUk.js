import{u as Ce,d as Se,c as ye,m as f,e as Be,j as e,L as we,s as ke}from"./index-DqlHcnpH.js";import{i as Ae,d as De,r as h,L as H}from"./vendor-react-BUTV5ZEl.js";import{C as Me}from"./ConfirmDialog-C_Ra4rmW.js";import{D as J,S as Ee}from"./SignatureBox-CGT9vKWI.js";import{i as Fe,a as Pe,c as ze,d as Le,B as Re,e as Oe,b as Te,f as Ge,g as Q,h as $e}from"./milestoneCalculations-CYOH0VJA.js";import{a as v,f as x}from"./deliverableCalculations-CNrutC6L.js";import{a3 as Ie,aa as X,ae as Ue,R as qe,P as $,O as We,h as Ve,w as Y,b as I,p as Ke,ah as Z,ai as ee,l as U,ag as He}from"./vendor-icons-CtZxSxcO.js";import"./vendor-supabase-6faYzd5A.js";function Je(i=null){const{user:y,role:c,profile:o}=Ce(),{canEditMilestone:q,canDeleteMilestone:a,canSignAsSupplier:B,canSignAsCustomer:m,canCreateCertificate:F}=Se(),t=c==="admin",A=c==="supplier_pm",P=c==="customer_pm",k=y?.id||null,D=o?.full_name||y?.email||"Unknown",b=i?Fe(i):!1,u=!0,n=q,z=a,N=t||A&&!b,l=!(!B||b||i?.baseline_supplier_pm_signed_at),r=!(!m||b||i?.baseline_customer_pm_signed_at);return{currentUserId:k,currentUserName:D,userRole:c,isAdmin:t,isSupplierPM:A,isCustomerPM:P,canView:u,canEdit:n,canDelete:z,canEditBaseline:N,canSignBaselineAsSupplier:l,canSignBaselineAsCustomer:r,canResetBaseline:t&&b,isBaselineLocked:b,canGenerateCertificate:F,canSignCertificateAsSupplier:d=>!(!B||!d||d.status==="Signed"||d.supplier_pm_signed_at),canSignCertificateAsCustomer:d=>!(!m||!d||d.status==="Signed"||d.customer_pm_signed_at),canSignAsSupplier:B,canSignAsCustomer:m}}function ts(){const{id:i}=Ae(),y=De(),{showSuccess:c,showError:o,showWarning:q}=ye(),[a,B]=h.useState(null),[m,F]=h.useState([]),[t,A]=h.useState(null),[P,k]=h.useState(!0),[D,b]=h.useState(!1),[u,n]=h.useState(!1),[z,N]=h.useState(!1),[l,r]=h.useState({}),[_,C]=h.useState({isOpen:!1,type:null}),W=Je(a),{currentUserId:w,currentUserName:d,canEdit:se,canEditBaseline:M,canSignBaselineAsSupplier:ae,canSignBaselineAsCustomer:le,canResetBaseline:te,canGenerateCertificate:ie,canSignCertificateAsSupplier:ne,canSignCertificateAsCustomer:re}=W,p=h.useCallback(async(s=!1)=>{if(!i){k(!1);return}s&&b(!0);try{const g=await f.getById(i);if(!g){B(null),k(!1),b(!1);return}B(g);const Ne=await Be.getAll(g.project_id,{filters:[{column:"milestone_id",operator:"eq",value:i}],orderBy:{column:"deliverable_ref",ascending:!0}});F(Ne||[]);const _e=await f.getCertificateByMilestoneId(i);A(_e)}catch{o("Failed to load milestone data")}finally{k(!1),b(!1)}},[i,o]);h.useEffect(()=>{p()},[p]);function ce(){r({name:a.name||"",description:a.description||"",baseline_start_date:a.baseline_start_date||"",baseline_end_date:a.baseline_end_date||"",baseline_billable:a.baseline_billable||a.billable||0,start_date:a.start_date||"",forecast_end_date:a.forecast_end_date||"",forecast_billable:a.forecast_billable||a.billable||0,actual_start_date:a.actual_start_date||"",billable:a.billable||0}),N(!0)}async function de(){try{n(!0);const s={name:l.name,description:l.description,start_date:l.start_date||null,forecast_end_date:l.forecast_end_date||null,forecast_billable:parseFloat(l.forecast_billable)||0,actual_start_date:l.actual_start_date||null,billable:parseFloat(l.billable)||0};M&&(s.baseline_start_date=l.baseline_start_date||null,s.baseline_end_date=l.baseline_end_date||null,s.baseline_billable=parseFloat(l.baseline_billable)||0),await f.update(i,s),await p(),N(!1),c("Milestone updated successfully")}catch(s){o("Failed to update milestone: "+s.message)}finally{n(!1)}}async function oe(){try{n(!0),await f.signBaseline(i,"supplier",w,d),await p(),c("Baseline signed as Supplier PM")}catch(s){o("Failed to sign baseline: "+s.message)}finally{n(!1)}}async function me(){try{n(!0),await f.signBaseline(i,"customer",w,d),await p(),c("Baseline signed as Customer PM")}catch(s){o("Failed to sign baseline: "+s.message)}finally{n(!1)}}function ue(){C({isOpen:!0,type:"reset-baseline",title:"Reset Baseline Lock?",message:"This will clear all baseline signatures and unlock the baseline for editing. This action cannot be undone."})}async function he(){try{n(!0),await f.resetBaseline(i),await p(),c("Baseline lock has been reset")}catch(s){o("Failed to reset baseline: "+s.message)}finally{n(!1),C({isOpen:!1,type:null})}}function pe(){C({isOpen:!0,type:"generate-certificate",title:"Generate Acceptance Certificate?",message:`This will create an acceptance certificate for milestone "${a.milestone_ref}" with a billable value of ${v(a.billable)}. The certificate will require dual signatures before billing.`})}async function be(){try{n(!0);const{data:s}=await ke.from("deliverables").select("deliverable_ref, name, status, progress").eq("milestone_id",i).eq("status","Delivered"),g=`CERT-${a.milestone_ref}-${Date.now().toString(36).toUpperCase()}`;await f.createCertificate({project_id:a.project_id,milestone_id:i,certificate_number:g,milestone_ref:a.milestone_ref,milestone_name:a.name,payment_milestone_value:a.billable||0,status:"Draft",deliverables_snapshot:s||[],generated_by:w,generated_at:new Date().toISOString()}),await p(),c("Certificate generated successfully!")}catch(s){o("Failed to generate certificate: "+s.message)}finally{n(!1),C({isOpen:!1,type:null})}}async function fe(){if(t)try{n(!0),await f.signCertificate(t.id,"supplier",w,d),await p(),c("Certificate signed as Supplier PM")}catch(s){o("Failed to sign certificate: "+s.message)}finally{n(!1)}}async function xe(){if(t)try{n(!0),await f.signCertificate(t.id,"customer",w,d),await p(),c("Certificate signed as Customer PM")}catch(s){o("Failed to sign certificate: "+s.message)}finally{n(!1)}}function je(){switch(_.type){case"reset-baseline":he();break;case"generate-certificate":be();break;default:C({isOpen:!1,type:null})}}if(P)return e.jsx(we,{message:"Loading milestone...",size:"large",fullPage:!0});if(!a)return e.jsx("div",{className:"milestone-detail-page",children:e.jsxs("div",{className:"milestone-not-found",children:[e.jsx(Ie,{size:48}),e.jsx("h2",{children:"Milestone Not Found"}),e.jsxs("button",{onClick:()=>y("/milestones"),children:[e.jsx(X,{size:16})," Back to Milestones"]})]})});const E=Pe(m),V=ze(m),L=m.length,K=m.filter(s=>s.status==="Delivered").length,R=Le(a),O=R===Re.LOCKED,j=a.baseline_billable??a.billable??0,S=a.forecast_billable??a.billable??0,ge=a.billable??0,ve=Oe(a,m,t)&&ie,T=t?Te(t.status):null,G=Ge(t);return e.jsxs("div",{className:"milestone-detail-page",children:[e.jsxs("header",{className:"milestone-header",children:[e.jsx("button",{className:"back-button",onClick:()=>y("/milestones"),children:e.jsx(X,{size:20})}),e.jsxs("div",{className:"milestone-title-block",children:[e.jsxs("div",{className:"milestone-ref-row",children:[e.jsx("span",{className:"milestone-ref",children:a.milestone_ref}),e.jsx("span",{className:`milestone-status ${Q(E)}`,children:E})]}),e.jsx("h1",{className:"milestone-name",children:a.name})]}),e.jsxs("div",{className:"header-actions",children:[se&&e.jsxs("button",{className:"edit-button",onClick:ce,children:[e.jsx(Ue,{size:18}),"Edit"]}),e.jsx("button",{className:"refresh-button",onClick:()=>p(!0),disabled:D,children:e.jsx(qe,{size:18,className:D?"spinning":""})})]})]}),e.jsxs("div",{className:"milestone-content",children:[e.jsxs("div",{className:"metrics-grid",children:[e.jsxs("div",{className:"metric-card",children:[e.jsxs("div",{className:"metric-header",children:[e.jsx($,{size:18}),e.jsx("span",{children:"Progress"})]}),e.jsxs("div",{className:"metric-value progress-value",children:[e.jsxs("span",{className:"progress-percent",children:[V,"%"]}),e.jsxs("span",{className:"progress-detail",children:[K," of ",L," deliverables"]})]}),e.jsx("div",{className:"progress-bar",children:e.jsx("div",{className:"progress-fill",style:{width:`${V}%`}})})]}),e.jsxs("div",{className:"metric-card",children:[e.jsxs("div",{className:"metric-header",children:[e.jsx(We,{size:18}),e.jsx("span",{children:"Forecast Billable"})]}),e.jsx("div",{className:"metric-value currency-value",children:v(S)}),e.jsxs("div",{className:"metric-subtitle",children:[S!==j&&j>0&&e.jsxs("span",{className:S>j?"variance-positive":"variance-negative",children:[S>j?"+":"",v(S-j)," vs baseline"]}),S===j&&"On baseline"]})]})]}),e.jsxs("div",{className:"section-card",children:[e.jsxs("h3",{className:"section-title",children:[e.jsx(Ve,{size:18}),"Schedule"]}),e.jsxs("div",{className:"dates-grid",children:[e.jsxs("div",{className:"date-group",children:[e.jsx("h4",{className:"date-group-title",children:"Baseline"}),e.jsxs("div",{className:"date-row",children:[e.jsx("span",{className:"date-label",children:"Start"}),e.jsx("span",{className:"date-value",children:x(a.baseline_start_date)})]}),e.jsxs("div",{className:"date-row",children:[e.jsx("span",{className:"date-label",children:"End"}),e.jsx("span",{className:"date-value",children:x(a.baseline_end_date)})]}),e.jsxs("div",{className:"date-row",children:[e.jsx("span",{className:"date-label",children:"Billable"}),e.jsx("span",{className:"date-value",children:v(j)})]})]}),e.jsxs("div",{className:"date-group",children:[e.jsx("h4",{className:"date-group-title",children:"Forecast"}),e.jsxs("div",{className:"date-row",children:[e.jsx("span",{className:"date-label",children:"Start"}),e.jsx("span",{className:"date-value",children:x(a.start_date)})]}),e.jsxs("div",{className:"date-row",children:[e.jsx("span",{className:"date-label",children:"End"}),e.jsx("span",{className:"date-value",children:x(a.forecast_end_date)})]}),e.jsxs("div",{className:"date-row",children:[e.jsx("span",{className:"date-label",children:"Billable"}),e.jsx("span",{className:"date-value",children:v(S)})]})]}),e.jsxs("div",{className:"date-group",children:[e.jsx("h4",{className:"date-group-title",children:"Actual"}),e.jsxs("div",{className:"date-row",children:[e.jsx("span",{className:"date-label",children:"Start"}),e.jsx("span",{className:"date-value",children:x(a.actual_start_date)})]}),e.jsxs("div",{className:"date-row",children:[e.jsx("span",{className:"date-label",children:"End"}),e.jsx("span",{className:"date-value",children:E==="Completed"?x(new Date):"—"})]}),e.jsxs("div",{className:"date-row",children:[e.jsx("span",{className:"date-label",children:"Billable"}),e.jsx("span",{className:"date-value",children:v(ge)})]})]})]})]}),e.jsxs("div",{className:"section-card",children:[e.jsxs("div",{className:"section-header",children:[e.jsxs("h3",{className:"section-title",children:[e.jsx($,{size:18}),"Deliverables (",L,")"]}),e.jsxs(H,{to:"/deliverables",className:"section-action",children:["Manage Deliverables",e.jsx(Y,{size:16})]})]}),m.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx($,{size:40,strokeWidth:1.5}),e.jsx("p",{children:"No deliverables assigned to this milestone."}),e.jsx(H,{to:"/deliverables",className:"empty-action",children:"Add Deliverable"})]}):e.jsx("div",{className:"deliverables-list",children:m.map(s=>e.jsxs("div",{className:"deliverable-item",onClick:()=>y(`/deliverables/${s.id}`),children:[e.jsxs("div",{className:"deliverable-main",children:[e.jsx("span",{className:"deliverable-ref",children:s.deliverable_ref}),e.jsx("span",{className:"deliverable-name",children:s.name})]}),e.jsxs("div",{className:"deliverable-meta",children:[e.jsxs("span",{className:"deliverable-progress",children:[s.progress||0,"%"]}),e.jsxs("span",{className:`deliverable-status ${Q(s.status)}`,children:[s.status==="Delivered"&&e.jsx(I,{size:12}),s.status==="In Progress"&&e.jsx(Ke,{size:12}),s.status||"Not Started"]}),e.jsx(Y,{size:16,className:"deliverable-chevron"})]})]},s.id))})]}),e.jsxs("div",{className:"section-card baseline-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsxs("h3",{className:"section-title",children:[O?e.jsx(Z,{size:18}):e.jsx(ee,{size:18}),"Baseline Commitment"]}),e.jsx("span",{className:`baseline-status-badge ${$e(R)}`,children:R})]}),e.jsxs("div",{className:"baseline-values",children:[e.jsxs("div",{className:"baseline-item",children:[e.jsx("span",{className:"baseline-label",children:"Start Date"}),e.jsx("span",{className:"baseline-value",children:x(a.baseline_start_date)})]}),e.jsxs("div",{className:"baseline-item",children:[e.jsx("span",{className:"baseline-label",children:"End Date"}),e.jsx("span",{className:"baseline-value",children:x(a.baseline_end_date)})]}),e.jsxs("div",{className:"baseline-item",children:[e.jsx("span",{className:"baseline-label",children:"Billable Amount"}),e.jsx("span",{className:"baseline-value",children:v(j)})]})]}),e.jsx(J,{supplier:{signedBy:a.baseline_supplier_pm_name,signedAt:a.baseline_supplier_pm_signed_at,canSign:ae,onSign:oe},customer:{signedBy:a.baseline_customer_pm_name,signedAt:a.baseline_customer_pm_signed_at,canSign:le,onSign:me},saving:u,supplierButtonText:"Sign to Commit",customerButtonText:"Sign to Commit"}),te&&e.jsx("div",{className:"admin-actions",children:e.jsxs("button",{className:"reset-button",onClick:ue,disabled:u,children:[e.jsx(ee,{size:16}),u?"Resetting...":"Reset Baseline Lock"]})}),!O&&e.jsx("p",{className:"baseline-info",children:"Both Supplier PM and Customer PM must sign to lock the baseline. Once locked, baseline values can only be changed by an Admin."})]}),e.jsxs("div",{className:"section-card certificate-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsxs("h3",{className:"section-title",children:[e.jsx(U,{size:18}),"Acceptance Certificate"]}),t&&T&&e.jsxs("span",{className:`cert-status-badge ${T.cssClass}`,children:[G&&e.jsx(I,{size:14}),T.label]})]}),!t&&e.jsx("div",{className:"cert-empty",children:E!=="Completed"?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cert-empty-icon",children:e.jsx(He,{size:40,strokeWidth:1.5})}),e.jsx("p",{className:"cert-empty-text",children:"Certificate can be generated once all deliverables are delivered."}),e.jsxs("div",{className:"cert-progress-hint",children:[e.jsxs("span",{className:"cert-progress-count",children:[K," of ",L]})," deliverables delivered"]})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"cert-empty-icon ready",children:e.jsx(U,{size:40,strokeWidth:1.5})}),e.jsx("p",{className:"cert-empty-text",children:"All deliverables have been delivered. Ready to generate certificate."}),ve&&e.jsxs("button",{className:"generate-cert-button",onClick:pe,disabled:u,children:[e.jsx(U,{size:18}),u?"Generating...":"Generate Certificate"]})]})}),t&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"cert-info-grid",children:[e.jsxs("div",{className:"cert-info-item",children:[e.jsx("span",{className:"cert-info-label",children:"Certificate Number"}),e.jsx("span",{className:"cert-info-value mono",children:t.certificate_number})]}),e.jsxs("div",{className:"cert-info-item",children:[e.jsx("span",{className:"cert-info-label",children:"Payment Value"}),e.jsx("span",{className:"cert-info-value currency",children:v(t.payment_milestone_value)})]}),e.jsxs("div",{className:"cert-info-item",children:[e.jsx("span",{className:"cert-info-label",children:"Generated"}),e.jsx("span",{className:"cert-info-value",children:x(t.generated_at)})]})]}),t.deliverables_snapshot&&t.deliverables_snapshot.length>0&&e.jsxs("div",{className:"cert-deliverables",children:[e.jsx("h4",{className:"cert-deliverables-title",children:"Deliverables Accepted"}),e.jsx("div",{className:"cert-deliverables-list",children:t.deliverables_snapshot.map((s,g)=>e.jsxs("div",{className:"cert-deliverable-item",children:[e.jsx("span",{className:"cert-del-ref",children:s.deliverable_ref}),e.jsx("span",{className:"cert-del-name",children:s.name}),e.jsx(I,{size:14,className:"cert-del-check"})]},g))})]}),e.jsx(J,{supplier:{signedBy:t.supplier_pm_name,signedAt:t.supplier_pm_signed_at,canSign:ne(t),onSign:fe},customer:{signedBy:t.customer_pm_name,signedAt:t.customer_pm_signed_at,canSign:re(t),onSign:xe},saving:u,supplierButtonText:"Sign as Supplier PM",customerButtonText:"Sign as Customer PM"}),G&&e.jsx(Ee,{message:"Certificate fully signed — Ready to bill",variant:"success"}),!G&&e.jsx("p",{className:"baseline-info",children:"Both Supplier PM and Customer PM must sign to complete the acceptance certificate. Once signed, the milestone payment value can be invoiced."})]})]})]}),z&&e.jsx("div",{className:"modal-overlay",onClick:()=>N(!1),children:e.jsxs("div",{className:"modal-content edit-modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:"Edit Milestone"}),e.jsx("button",{className:"modal-close",onClick:()=>N(!1),children:"×"})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Name"}),e.jsx("input",{type:"text",value:l.name,onChange:s=>r({...l,name:s.target.value})})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Description"}),e.jsx("textarea",{value:l.description,onChange:s=>r({...l,description:s.target.value}),rows:3})]}),e.jsxs("h3",{className:"form-section-title",children:["Baseline",O&&e.jsxs("span",{className:"locked-badge",children:[e.jsx(Z,{size:12})," Locked"]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Baseline Start"}),e.jsx("input",{type:"date",value:l.baseline_start_date,onChange:s=>r({...l,baseline_start_date:s.target.value}),disabled:!M})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Baseline End"}),e.jsx("input",{type:"date",value:l.baseline_end_date,onChange:s=>r({...l,baseline_end_date:s.target.value}),disabled:!M})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Baseline Billable (£)"}),e.jsx("input",{type:"number",step:"0.01",value:l.baseline_billable,onChange:s=>r({...l,baseline_billable:s.target.value}),disabled:!M})]}),e.jsx("h3",{className:"form-section-title",children:"Forecast"}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Forecast Start"}),e.jsx("input",{type:"date",value:l.start_date,onChange:s=>r({...l,start_date:s.target.value})})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Forecast End"}),e.jsx("input",{type:"date",value:l.forecast_end_date,onChange:s=>r({...l,forecast_end_date:s.target.value})})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Forecast Billable (£)"}),e.jsx("input",{type:"number",step:"0.01",value:l.forecast_billable,onChange:s=>r({...l,forecast_billable:s.target.value})})]}),e.jsx("h3",{className:"form-section-title",children:"Actual"}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Actual Start"}),e.jsx("input",{type:"date",value:l.actual_start_date,onChange:s=>r({...l,actual_start_date:s.target.value})})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Current Billable (£)"}),e.jsx("input",{type:"number",step:"0.01",value:l.billable,onChange:s=>r({...l,billable:s.target.value})}),e.jsx("span",{className:"form-hint",children:"The billable amount to be invoiced"})]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn-secondary",onClick:()=>N(!1),children:"Cancel"}),e.jsx("button",{className:"btn-primary",onClick:de,disabled:u,children:u?"Saving...":"Save Changes"})]})]})}),e.jsx(Me,{isOpen:_.isOpen,onClose:()=>C({isOpen:!1,type:null}),onConfirm:je,title:_.title||"Confirm Action",message:_.message||"",confirmText:_.type==="reset-baseline"?"Reset Baseline":"Generate Certificate",cancelText:"Cancel",type:_.type==="reset-baseline"?"danger":"info",isLoading:u})]})}export{ts as default};
