import{c as ke,a as ze,b as Be,d as Ne,r as c,s as u,j as e,L as Me,P as Pe,M as J,R as Ae,S as M,C as K,e as Q,f as F,F as De,T as Re,X as We}from"./index-BcgMsB79.js";import{u as Ie}from"./usePermissions-utoNxF_l.js";import{C as Ee}from"./ConfirmDialog-Ca5wY-Fp.js";import{P as Y}from"./plus-D1ijkXGv.js";import{P as Z}from"./pen-C5qRXid0.js";import{S as Te}from"./save-BEtYqOhB.js";/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const P=ke("PenTool",[["path",{d:"m12 19 7-7 3 3-7 7-3-3z",key:"rklqx2"}],["path",{d:"m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z",key:"1et58u"}],["path",{d:"m2 2 7.586 7.586",key:"etlp93"}],["circle",{cx:"11",cy:"11",r:"2",key:"xmgehs"}]]);function He(){const{user:p,role:O,profile:A}=ze(),{projectId:f}=Be(),{showSuccess:k,showError:y,showWarning:v}=Ne(),z=(p==null?void 0:p.id)||null,q=(A==null?void 0:A.full_name)||(p==null?void 0:p.email)||"Unknown",{canEditMilestone:ee,canSignAsSupplier:te,canSignAsCustomer:re}=Ie(),[h,se]=c.useState([]),[S,ie]=c.useState({}),[x,ne]=c.useState({}),[ae,le]=c.useState(!0),[G,D]=c.useState(!1),[oe,R]=c.useState(!1),[de,$]=c.useState(!1),[a,H]=c.useState(null),[C,W]=c.useState({isOpen:!1,milestone:null}),[ce,U]=c.useState(!1),[r,m]=c.useState({milestone_ref:"",name:"",description:"",baseline_start_date:"",baseline_end_date:"",actual_start_date:"",forecast_end_date:"",start_date:"",end_date:"",budget:""}),[i,g]=c.useState({id:"",milestone_ref:"",name:"",description:"",baseline_start_date:"",baseline_end_date:"",actual_start_date:"",forecast_end_date:"",start_date:"",end_date:"",budget:""});c.useEffect(()=>{f&&(w(f),I(f))},[f]);function me(t){if(!t||t.length===0)return"Not Started";const n=t.every(s=>s.status==="Not Started"||!s.status);return t.every(s=>s.status==="Delivered")?"Completed":n?"Not Started":"In Progress"}function ge(t){if(!t||t.length===0)return 0;const n=t.reduce((l,s)=>l+(s.progress||0),0);return Math.round(n/t.length)}async function I(t){const n=t||f;try{const{data:l,error:s}=await u.from("milestone_certificates").select("*").eq("project_id",n);if(!s&&l){const o={};l.forEach(d=>{o[d.milestone_id]=d}),ne(o)}}catch(l){console.error("Error fetching certificates:",l)}}async function w(t){const n=t||f;try{const{data:l,error:s}=await u.from("milestones").select("*").eq("project_id",n).order("milestone_ref");if(s)throw s;if(se(l||[]),l&&l.length>0){const o=l.map(_=>_.id),{data:d,error:j}=await u.from("deliverables").select("id, milestone_id, status, progress").in("milestone_id",o);if(!j&&d){const _={};d.forEach(N=>{_[N.milestone_id]||(_[N.milestone_id]=[]),_[N.milestone_id].push(N)}),ie(_)}}}catch(l){console.error("Error fetching milestones:",l)}finally{le(!1)}}async function ue(){if(!r.milestone_ref||!r.name){v("Please fill in at least Milestone Reference and Name");return}try{const{error:t}=await u.from("milestones").insert({project_id:f,milestone_ref:r.milestone_ref,name:r.name,description:r.description,start_date:r.start_date||r.baseline_start_date||null,end_date:r.end_date||r.baseline_end_date||null,baseline_start_date:r.baseline_start_date||r.start_date||null,baseline_end_date:r.baseline_end_date||r.end_date||null,actual_start_date:r.actual_start_date||r.start_date||null,forecast_end_date:r.forecast_end_date||r.end_date||null,budget:parseFloat(r.budget)||0,progress:0,status:"Not Started",created_by:z});if(t)throw t;await w(),D(!1),m({milestone_ref:"",name:"",description:"",baseline_start_date:"",baseline_end_date:"",actual_start_date:"",forecast_end_date:"",start_date:"",end_date:"",budget:""}),k("Milestone added successfully!")}catch(t){console.error("Error adding milestone:",t),y("Failed to add milestone: "+t.message)}}function fe(t){W({isOpen:!0,milestone:t})}async function pe(){const t=C.milestone;if(t){U(!0);try{const{error:n}=await u.from("milestones").delete().eq("id",t.id);if(n)throw n;await w(),W({isOpen:!1,milestone:null})}catch(n){console.error("Error deleting milestone:",n),y("Failed to delete milestone: "+n.message)}finally{U(!1)}}}function he(t){g({id:t.id,milestone_ref:t.milestone_ref||"",name:t.name||"",description:t.description||"",baseline_start_date:t.baseline_start_date||t.start_date||"",baseline_end_date:t.baseline_end_date||t.end_date||"",actual_start_date:t.actual_start_date||t.start_date||"",forecast_end_date:t.forecast_end_date||t.end_date||"",start_date:t.start_date||"",end_date:t.end_date||"",budget:t.budget||""}),R(!0)}async function xe(){if(!i.milestone_ref||!i.name){v("Please fill in at least Milestone Reference and Name");return}try{const{error:t}=await u.from("milestones").update({milestone_ref:i.milestone_ref,name:i.name,description:i.description,start_date:i.start_date||i.baseline_start_date||null,end_date:i.end_date||i.baseline_end_date||null,baseline_start_date:i.baseline_start_date||null,baseline_end_date:i.baseline_end_date||null,actual_start_date:i.actual_start_date||null,forecast_end_date:i.forecast_end_date||null,budget:parseFloat(i.budget)||0}).eq("id",i.id);if(t)throw t;await w(),R(!1),k("Milestone updated successfully!")}catch(t){console.error("Error updating milestone:",t),y("Failed to update milestone: "+t.message)}}function be(t){switch(t){case"Completed":return{bg:"#dcfce7",color:"#16a34a"};case"In Progress":return{bg:"#dbeafe",color:"#2563eb"};default:return{bg:"#f1f5f9",color:"#64748b"}}}function B(t){switch(t){case"Signed":return{bg:"#dcfce7",color:"#16a34a"};case"Pending Supplier Signature":return{bg:"#fef3c7",color:"#d97706"};case"Pending Customer Signature":return{bg:"#dbeafe",color:"#2563eb"};case"Draft":return{bg:"#f1f5f9",color:"#64748b"};default:return{bg:"#f1f5f9",color:"#64748b"}}}async function je(t){const n=S[t.id]||[];if(!(n.length>0&&n.every(s=>s.status==="Delivered"))){v("Cannot generate certificate: All deliverables must be delivered first.");return}if(x[t.id]){E(t);return}try{const{data:s}=await u.from("deliverables").select("deliverable_ref, name, status, progress").eq("milestone_id",t.id).eq("status","Delivered"),o=`CERT-${t.milestone_ref}-${Date.now().toString(36).toUpperCase()}`,{data:d,error:j}=await u.from("milestone_certificates").insert({project_id:f,milestone_id:t.id,certificate_number:o,milestone_ref:t.milestone_ref,milestone_name:t.name,payment_milestone_value:t.budget||0,status:"Draft",deliverables_snapshot:s||[],generated_by:z}).select().single();if(j)throw j;await I(),E(t),k("Certificate generated successfully!")}catch(s){console.error("Error generating certificate:",s),y("Failed to generate certificate: "+s.message)}}function E(t){const n=x[t.id];H({...n,milestone:t,deliverables:S[t.id]||[]}),$(!0)}async function V(t){if(!a)return;const n=t==="supplier",l=t==="customer";if(n&&!["admin","supplier_pm"].includes(O)){v("Only Admin or Supplier PM can sign as supplier.");return}if(l&&O!=="customer_pm"){v("Only Customer PM can sign as customer.");return}try{const s={};let o=a.status;n&&(s.supplier_pm_id=z,s.supplier_pm_name=q,s.supplier_pm_signed_at=new Date().toISOString(),a.customer_pm_signed_at?o="Signed":o="Pending Customer Signature"),l&&(s.customer_pm_id=z,s.customer_pm_name=q,s.customer_pm_signed_at=new Date().toISOString(),a.supplier_pm_signed_at?o="Signed":o="Pending Supplier Signature"),s.status=o;const{error:d}=await u.from("milestone_certificates").update(s).eq("id",a.id);if(d)throw d;await I();const j={...a,...s};H(j),k("Certificate signed successfully!")}catch(s){console.error("Error signing certificate:",s),y("Failed to sign certificate: "+s.message)}}const b=ee,_e=te,ye=re;if(ae)return e.jsx(Me,{message:"Loading milestones...",size:"large",fullPage:!0});const ve=h.reduce((t,n)=>t+(n.budget||0),0),T=h.map(t=>({...t,computedStatus:me(S[t.id]),computedProgress:ge(S[t.id])})),Se=h.length>0?Math.round(T.reduce((t,n)=>t+n.computedProgress,0)/h.length):0,X=T.filter(t=>t.computedStatus==="Completed").length,Ce=Object.values(x).filter(t=>t.status==="Signed").length,we=Object.values(x).filter(t=>t.status==="Pending Customer Signature"||t.status==="Pending Supplier Signature").length,L=X-Object.keys(x).length;return e.jsxs("div",{className:"page-container",children:[e.jsxs(Pe,{icon:J,title:"Milestones",subtitle:"Track project milestones and deliverables",children:[e.jsxs("button",{className:"btn btn-secondary",onClick:()=>w(),children:[e.jsx(Ae,{size:18})," Refresh"]}),b&&!G&&e.jsxs("button",{className:"btn btn-primary",onClick:()=>D(!0),children:[e.jsx(Y,{size:18})," Add Milestone"]})]}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem"},children:[e.jsx(M,{icon:J,label:"Total Milestones",value:h.length,color:"#3b82f6"}),e.jsx(M,{icon:K,label:"Completed",value:X,color:"#10b981"}),e.jsx(M,{label:"Average Progress",value:`${Se}%`,color:"#3b82f6"}),e.jsx(M,{label:"Total Billable",value:`Â£${ve.toLocaleString()}`,subtext:"on completion",color:"#10b981"})]}),e.jsx("div",{style:{display:"flex",gap:"0.5rem",marginBottom:"1.5rem"},children:e.jsx(Q,{to:"/gantt",className:"btn btn-secondary",style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:"ðŸ“Š View Gantt Chart"})}),e.jsx("div",{className:"card",style:{marginBottom:"1.5rem",backgroundColor:"#fefce8",borderLeft:"4px solid #eab308"},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"1rem",flexWrap:"wrap"},children:[e.jsx(F,{size:24,style:{color:"#ca8a04"}}),e.jsx("h4",{style:{margin:0,color:"#854d0e"},children:"Milestone Acceptance Certificates"}),e.jsxs("div",{style:{display:"flex",gap:"1.5rem",marginLeft:"auto"},children:[e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{fontSize:"1.5rem",fontWeight:"700",color:"#16a34a"},children:Ce}),e.jsx("div",{style:{fontSize:"0.8rem",color:"#166534"},children:"Signed"})]}),e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{fontSize:"1.5rem",fontWeight:"700",color:"#d97706"},children:we}),e.jsx("div",{style:{fontSize:"0.8rem",color:"#92400e"},children:"Pending"})]}),e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{fontSize:"1.5rem",fontWeight:"700",color:L>0?"#dc2626":"#64748b"},children:L>0?L:0}),e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b"},children:"Awaiting Generation"})]})]})]})}),G&&b&&e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem",border:"2px solid #10b981"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Add New Milestone"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 2fr",gap:"1rem",marginBottom:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Milestone Reference *"}),e.jsx("input",{type:"text",className:"form-input",placeholder:"M01",value:r.milestone_ref,onChange:t=>m({...r,milestone_ref:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Name *"}),e.jsx("input",{type:"text",className:"form-input",placeholder:"Milestone name",value:r.name,onChange:t=>m({...r,name:t.target.value})})]})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{className:"form-label",children:"Description"}),e.jsx("textarea",{className:"form-input",rows:2,placeholder:"Description",value:r.description,onChange:t=>m({...r,description:t.target.value})})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("h4",{style:{margin:"0 0 0.5rem 0",fontSize:"0.9rem",color:"#64748b"},children:"Baseline Schedule (Original Plan)"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Baseline Start Date"}),e.jsx("input",{type:"date",className:"form-input",value:r.baseline_start_date||r.start_date,onChange:t=>m({...r,baseline_start_date:t.target.value,start_date:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Baseline End Date"}),e.jsx("input",{type:"date",className:"form-input",value:r.baseline_end_date||r.end_date,onChange:t=>m({...r,baseline_end_date:t.target.value,end_date:t.target.value})})]})]})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("h4",{style:{margin:"0 0 0.5rem 0",fontSize:"0.9rem",color:"#64748b"},children:"Current Schedule"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Actual Start Date"}),e.jsx("input",{type:"date",className:"form-input",value:r.actual_start_date||r.start_date,onChange:t=>m({...r,actual_start_date:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Forecast End Date"}),e.jsx("input",{type:"date",className:"form-input",value:r.forecast_end_date||r.end_date,onChange:t=>m({...r,forecast_end_date:t.target.value})})]})]})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{className:"form-label",children:"Billable Amount (Â£)"}),e.jsx("input",{type:"number",className:"form-input",placeholder:"0",style:{maxWidth:"200px"},value:r.budget,onChange:t=>m({...r,budget:t.target.value})}),e.jsx("p",{style:{fontSize:"0.8rem",color:"#64748b",margin:"0.25rem 0 0 0"},children:"The amount that can be invoiced when this milestone is completed (not a budget for doing the work)"})]}),e.jsxs("div",{style:{padding:"0.75rem",backgroundColor:"#eff6ff",borderRadius:"6px",marginBottom:"1rem",fontSize:"0.9rem",color:"#1e40af"},children:[e.jsx("strong",{children:"Note:"})," Milestone status and progress will be automatically calculated from associated deliverables."]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsxs("button",{className:"btn btn-primary",onClick:ue,children:[e.jsx(Y,{size:16})," Add Milestone"]}),e.jsx("button",{className:"btn btn-secondary",onClick:()=>D(!1),children:"Cancel"})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Project Milestones"}),e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Ref"}),e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Progress"}),e.jsx("th",{children:"Actual Start"}),e.jsx("th",{children:"Forecast End"}),e.jsx("th",{title:"Amount invoiced on completion",children:"Billable"}),e.jsx("th",{children:"Certificate"}),b&&e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:h.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:b?9:8,style:{textAlign:"center",padding:"2rem",color:"#64748b"},children:'No milestones found. Click "Add Milestone" to create one.'})}):T.map(t=>{var o;const n=be(t.computedStatus),l=x[t.id],s=((o=S[t.id])==null?void 0:o.length)||0;return e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx(Q,{to:`/milestones/${t.id}`,style:{fontFamily:"monospace",fontWeight:"600",color:"#3b82f6",textDecoration:"none"},onMouseEnter:d=>d.target.style.textDecoration="underline",onMouseLeave:d=>d.target.style.textDecoration="none",children:t.milestone_ref})}),e.jsx("td",{style:{fontWeight:"500"},children:t.name}),e.jsxs("td",{children:[e.jsx("span",{style:{padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.85rem",backgroundColor:n.bg,color:n.color,fontWeight:"500"},children:t.computedStatus}),s>0&&e.jsxs("span",{style:{marginLeft:"0.5rem",fontSize:"0.75rem",color:"#64748b"},children:["(",s," deliverable",s!==1?"s":"",")"]})]}),e.jsx("td",{children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("div",{style:{width:"80px",height:"8px",backgroundColor:"#e2e8f0",borderRadius:"4px",overflow:"hidden"},children:e.jsx("div",{style:{width:`${t.computedProgress}%`,height:"100%",backgroundColor:t.computedStatus==="Completed"?"#10b981":"#3b82f6",transition:"width 0.3s"}})}),e.jsxs("span",{style:{fontSize:"0.85rem",fontWeight:"600",minWidth:"40px"},children:[t.computedProgress,"%"]}),e.jsx("span",{style:{fontSize:"0.75rem",color:"#64748b",fontStyle:"italic"},children:"(auto)"})]})}),e.jsx("td",{children:t.actual_start_date||t.start_date?new Date(t.actual_start_date||t.start_date).toLocaleDateString("en-GB"):"-"}),e.jsx("td",{children:t.forecast_end_date||t.end_date?new Date(t.forecast_end_date||t.end_date).toLocaleDateString("en-GB"):"-"}),e.jsxs("td",{title:"Invoiced on completion",children:["Â£",(t.budget||0).toLocaleString()]}),e.jsx("td",{children:t.computedStatus==="Completed"?l?e.jsxs("button",{onClick:()=>E(t),style:{display:"flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",backgroundColor:B(l.status).bg,color:B(l.status).color,border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"0.8rem",fontWeight:"500"},children:[e.jsx(De,{size:14}),l.status==="Signed"?"Signed":l.status==="Pending Customer Signature"?"Awaiting Customer":l.status==="Pending Supplier Signature"?"Awaiting Supplier":"View"]}):b&&e.jsxs("button",{onClick:()=>je(t),style:{display:"flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",backgroundColor:"#fef3c7",color:"#d97706",border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"0.8rem",fontWeight:"500"},children:[e.jsx(F,{size:14}),"Generate"]}):e.jsx("span",{style:{fontSize:"0.8rem",color:"#94a3b8",fontStyle:"italic"},children:"Not ready"})}),b&&e.jsx("td",{children:e.jsxs("div",{style:{display:"flex",gap:"0.25rem"},children:[e.jsx("button",{onClick:()=>he(t),style:{padding:"0.5rem",backgroundColor:"#eff6ff",color:"#3b82f6",border:"none",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center"},title:"Edit",children:e.jsx(Z,{size:16})}),e.jsx("button",{onClick:()=>fe(t),style:{padding:"0.5rem",backgroundColor:"#fef2f2",color:"#ef4444",border:"none",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center"},title:"Delete",children:e.jsx(Re,{size:16})})]})})]},t.id)})})]})]}),oe&&e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:e.jsxs("div",{style:{backgroundColor:"white",padding:"1.5rem",borderRadius:"12px",maxWidth:"600px",width:"90%",maxHeight:"90vh",overflow:"auto"},children:[e.jsxs("h3",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginTop:0},children:[e.jsx(Z,{size:20}),"Edit Milestone - ",i.milestone_ref]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 2fr",gap:"1rem",marginBottom:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Reference *"}),e.jsx("input",{type:"text",value:i.milestone_ref,onChange:t=>g({...i,milestone_ref:t.target.value}),style:{width:"100%",padding:"0.5rem",border:"1px solid #e2e8f0",borderRadius:"6px"}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Name *"}),e.jsx("input",{type:"text",value:i.name,onChange:t=>g({...i,name:t.target.value}),style:{width:"100%",padding:"0.5rem",border:"1px solid #e2e8f0",borderRadius:"6px"}})]})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Description"}),e.jsx("textarea",{value:i.description,onChange:t=>g({...i,description:t.target.value}),rows:3,style:{width:"100%",padding:"0.5rem",border:"1px solid #e2e8f0",borderRadius:"6px"}})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("h4",{style:{margin:"0 0 0.5rem 0",fontSize:"0.85rem",color:"#64748b"},children:"Baseline Schedule (Original Plan)"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Baseline Start"}),e.jsx("input",{type:"date",value:i.baseline_start_date,onChange:t=>g({...i,baseline_start_date:t.target.value}),style:{width:"100%",padding:"0.5rem",border:"1px solid #e2e8f0",borderRadius:"6px"}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Baseline End"}),e.jsx("input",{type:"date",value:i.baseline_end_date,onChange:t=>g({...i,baseline_end_date:t.target.value}),style:{width:"100%",padding:"0.5rem",border:"1px solid #e2e8f0",borderRadius:"6px"}})]})]})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("h4",{style:{margin:"0 0 0.5rem 0",fontSize:"0.85rem",color:"#64748b"},children:"Current Schedule"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Actual Start"}),e.jsx("input",{type:"date",value:i.actual_start_date,onChange:t=>g({...i,actual_start_date:t.target.value}),style:{width:"100%",padding:"0.5rem",border:"1px solid #e2e8f0",borderRadius:"6px"}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Forecast End"}),e.jsx("input",{type:"date",value:i.forecast_end_date,onChange:t=>g({...i,forecast_end_date:t.target.value}),style:{width:"100%",padding:"0.5rem",border:"1px solid #e2e8f0",borderRadius:"6px"}})]})]})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Billable Amount (Â£)"}),e.jsx("input",{type:"number",value:i.budget,onChange:t=>g({...i,budget:t.target.value}),style:{width:"200px",padding:"0.5rem",border:"1px solid #e2e8f0",borderRadius:"6px"}}),e.jsx("p",{style:{fontSize:"0.8rem",color:"#64748b",margin:"0.25rem 0 0 0"},children:"Amount invoiced when milestone is completed (not a budget for doing the work)"})]}),e.jsxs("div",{style:{padding:"0.75rem",backgroundColor:"#eff6ff",borderRadius:"6px",marginBottom:"1rem",fontSize:"0.9rem",color:"#1e40af"},children:[e.jsx("strong",{children:"ðŸ’¡ Note:"})," Status and progress are ",e.jsx("strong",{children:"automatically calculated"})," from associated deliverables and cannot be manually edited.",e.jsxs("ul",{style:{margin:"0.5rem 0 0 1rem",paddingLeft:"0.5rem"},children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Not Started"})," â€” No deliverables have begun"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"In Progress"})," â€” At least one deliverable is in progress"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Completed"})," â€” All deliverables are delivered"]})]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:"0.5rem"},children:[e.jsxs("button",{onClick:()=>R(!1),style:{padding:"0.5rem 1rem",backgroundColor:"#f1f5f9",color:"#64748b",border:"none",borderRadius:"6px",cursor:"pointer",display:"flex",alignItems:"center",gap:"0.25rem"},children:[e.jsx(We,{size:16})," Cancel"]}),e.jsxs("button",{onClick:xe,style:{padding:"0.5rem 1rem",backgroundColor:"#10b981",color:"white",border:"none",borderRadius:"6px",cursor:"pointer",display:"flex",alignItems:"center",gap:"0.25rem"},children:[e.jsx(Te,{size:16})," Save Changes"]})]})]})}),de&&a&&e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:e.jsxs("div",{style:{backgroundColor:"white",padding:"2rem",borderRadius:"12px",maxWidth:"700px",width:"90%",maxHeight:"90vh",overflow:"auto"},children:[e.jsxs("div",{style:{textAlign:"center",borderBottom:"2px solid #10b981",paddingBottom:"1rem",marginBottom:"1.5rem"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",gap:"0.5rem",marginBottom:"0.5rem"},children:[e.jsx(F,{size:32,style:{color:"#10b981"}}),e.jsx("h2",{style:{margin:0,color:"#166534"},children:"Milestone Acceptance Certificate"})]}),e.jsxs("div",{style:{fontSize:"0.9rem",color:"#64748b"},children:["Certificate No: ",e.jsx("strong",{children:a.certificate_number})]}),e.jsx("div",{style:{display:"inline-block",marginTop:"0.5rem",padding:"0.25rem 0.75rem",borderRadius:"999px",fontSize:"0.85rem",fontWeight:"600",backgroundColor:B(a.status).bg,color:B(a.status).color},children:a.status})]}),e.jsxs("div",{style:{marginBottom:"1.5rem"},children:[e.jsx("h4",{style:{margin:"0 0 0.75rem 0",color:"#1e293b"},children:"Milestone Details"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"0.75rem",backgroundColor:"#f8fafc",padding:"1rem",borderRadius:"8px"},children:[e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b"},children:"Reference"}),e.jsx("div",{style:{fontWeight:"600"},children:a.milestone_ref})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b"},children:"Name"}),e.jsx("div",{style:{fontWeight:"600"},children:a.milestone_name})]}),e.jsxs("div",{style:{gridColumn:"1 / -1"},children:[e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b"},children:"Payment Milestone Associated"}),e.jsxs("div",{style:{fontWeight:"700",fontSize:"1.25rem",color:"#10b981"},children:["Â£",(a.payment_milestone_value||0).toLocaleString()]})]})]})]}),e.jsxs("div",{style:{marginBottom:"1.5rem"},children:[e.jsx("h4",{style:{margin:"0 0 0.75rem 0",color:"#1e293b"},children:"Deliverables Accepted"}),e.jsx("div",{style:{border:"1px solid #e2e8f0",borderRadius:"8px",overflow:"hidden"},children:e.jsxs("table",{style:{width:"100%",fontSize:"0.9rem"},children:[e.jsx("thead",{children:e.jsxs("tr",{style:{backgroundColor:"#f1f5f9"},children:[e.jsx("th",{style:{padding:"0.5rem",textAlign:"left"},children:"Ref"}),e.jsx("th",{style:{padding:"0.5rem",textAlign:"left"},children:"Name"}),e.jsx("th",{style:{padding:"0.5rem",textAlign:"center"},children:"Status"})]})}),e.jsx("tbody",{children:(a.deliverables_snapshot||[]).map((t,n)=>e.jsxs("tr",{style:{borderTop:"1px solid #e2e8f0"},children:[e.jsx("td",{style:{padding:"0.5rem",fontFamily:"monospace",fontWeight:"600"},children:t.deliverable_ref}),e.jsx("td",{style:{padding:"0.5rem"},children:t.name}),e.jsx("td",{style:{padding:"0.5rem",textAlign:"center"},children:e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",color:"#16a34a"},children:[e.jsx(K,{size:14})," Accepted"]})})]},n))})]})})]}),e.jsxs("div",{style:{marginBottom:"1.5rem"},children:[e.jsx("h4",{style:{margin:"0 0 0.75rem 0",color:"#1e293b"},children:"Signatures"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsxs("div",{style:{padding:"1rem",border:"2px solid",borderColor:a.supplier_pm_signed_at?"#10b981":"#e2e8f0",borderRadius:"8px",backgroundColor:a.supplier_pm_signed_at?"#f0fdf4":"#f8fafc"},children:[e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b",marginBottom:"0.5rem"},children:"Supplier PM"}),a.supplier_pm_signed_at?e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",fontWeight:"600",color:"#166534"},children:[e.jsx(P,{size:16}),a.supplier_pm_name]}),e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b",marginTop:"0.25rem"},children:new Date(a.supplier_pm_signed_at).toLocaleString("en-GB")})]}):_e&&a.status!=="Signed"?e.jsxs("button",{onClick:()=>V("supplier"),style:{width:"100%",padding:"0.5rem",backgroundColor:"#10b981",color:"white",border:"none",borderRadius:"6px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"0.5rem",fontWeight:"500"},children:[e.jsx(P,{size:16})," Sign as Supplier PM"]}):e.jsx("div",{style:{color:"#94a3b8",fontStyle:"italic"},children:"Awaiting signature"})]}),e.jsxs("div",{style:{padding:"1rem",border:"2px solid",borderColor:a.customer_pm_signed_at?"#10b981":"#e2e8f0",borderRadius:"8px",backgroundColor:a.customer_pm_signed_at?"#f0fdf4":"#f8fafc"},children:[e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b",marginBottom:"0.5rem"},children:"Customer PM"}),a.customer_pm_signed_at?e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",fontWeight:"600",color:"#166534"},children:[e.jsx(P,{size:16}),a.customer_pm_name]}),e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b",marginTop:"0.25rem"},children:new Date(a.customer_pm_signed_at).toLocaleString("en-GB")})]}):ye&&a.status!=="Signed"?e.jsxs("button",{onClick:()=>V("customer"),style:{width:"100%",padding:"0.5rem",backgroundColor:"#3b82f6",color:"white",border:"none",borderRadius:"6px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"0.5rem",fontWeight:"500"},children:[e.jsx(P,{size:16})," Sign as Customer PM"]}):e.jsx("div",{style:{color:"#94a3b8",fontStyle:"italic"},children:"Awaiting signature"})]})]})]}),e.jsxs("div",{style:{fontSize:"0.8rem",color:"#64748b",textAlign:"center",marginBottom:"1rem"},children:["Generated: ",new Date(a.generated_at).toLocaleString("en-GB")]}),e.jsx("div",{style:{display:"flex",justifyContent:"center"},children:e.jsx("button",{onClick:()=>$(!1),style:{padding:"0.75rem 2rem",backgroundColor:"#f1f5f9",color:"#64748b",border:"none",borderRadius:"6px",cursor:"pointer",fontWeight:"500"},children:"Close"})})]})}),e.jsxs("div",{className:"card",style:{marginTop:"1.5rem",backgroundColor:"#eff6ff",borderLeft:"4px solid #3b82f6"},children:[e.jsx("h4",{style:{marginBottom:"0.5rem",color:"#1e40af"},children:"ðŸ’¡ How Milestone Status & Progress Work"}),e.jsxs("ul",{style:{margin:"0.5rem 0 0 1.5rem",color:"#1e40af",fontSize:"0.9rem"},children:[e.jsxs("li",{children:["Milestone ",e.jsx("strong",{children:"status"})," and ",e.jsx("strong",{children:"progress"})," are automatically calculated from deliverables"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Not Started:"}),' All deliverables are "Not Started" (or no deliverables exist)']}),e.jsxs("li",{children:[e.jsx("strong",{children:"In Progress:"})," At least one deliverable has begun work"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Completed:"})," All deliverables have been delivered"]}),e.jsx("li",{children:"Click milestone reference to view and manage deliverables"}),e.jsx("li",{children:"Progress = average of all deliverable progress percentages"}),e.jsx("li",{children:"Timesheets continue to be logged against milestones (not individual deliverables)"}),e.jsx("li",{children:"Payment aligned to milestone completion per SOW requirements"})]})]}),e.jsx(Ee,{isOpen:C.isOpen,onClose:()=>W({isOpen:!1,milestone:null}),onConfirm:pe,title:"Delete Milestone?",message:C.milestone?`This will permanently delete "${C.milestone.milestone_ref}: ${C.milestone.name}" and all associated deliverables. This action cannot be undone.`:"",confirmText:"Delete Milestone",cancelText:"Cancel",type:"danger",isLoading:ce})]})}export{He as default};
