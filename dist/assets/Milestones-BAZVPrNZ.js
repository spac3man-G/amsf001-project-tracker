import{u as ke,a as ze,b as Ne,s as g,j as e,L as Be,P as Me,S as B}from"./index-DjXTtB8m.js";import{r as o,L as J}from"./vendor-react-JFEV0ROX.js";import{u as Ae}from"./usePermissions-BN-cu4kW.js";import{C as Pe}from"./ConfirmDialog-V9NTp2PV.js";import{n as X,R as De,H as K,C as Q,f as E,y as Re,J as Y,T as We,a as Ie,N as Te,O as M}from"./vendor-icons-Bd7vp13O.js";import"./vendor-supabase-DgEUAXvv.js";function $e(){const{user:L,role:F,profile:Z}=ke(),{projectId:f}=ze(),{showSuccess:w,showError:_,showWarning:y}=Ne(),k=L?.id||null,O=Z?.full_name||L?.email||"Unknown",{canEditMilestone:ee,canSignAsSupplier:te,canSignAsCustomer:re}=Ae(),[p,se]=o.useState([]),[v,ie]=o.useState({}),[h,ne]=o.useState({}),[ae,le]=o.useState(!0),[G,A]=o.useState(!1),[de,P]=o.useState(!1),[oe,q]=o.useState(!1),[a,$]=o.useState(null),[S,D]=o.useState({isOpen:!1,milestone:null}),[ce,H]=o.useState(!1),[r,c]=o.useState({milestone_ref:"",name:"",description:"",baseline_start_date:"",baseline_end_date:"",actual_start_date:"",forecast_end_date:"",start_date:"",end_date:"",budget:""}),[i,m]=o.useState({id:"",milestone_ref:"",name:"",description:"",baseline_start_date:"",baseline_end_date:"",actual_start_date:"",forecast_end_date:"",start_date:"",end_date:"",budget:""});o.useEffect(()=>{f&&(C(f),R(f))},[f]);function me(t){if(!t||t.length===0)return"Not Started";const n=t.every(s=>s.status==="Not Started"||!s.status);return t.every(s=>s.status==="Delivered")?"Completed":n?"Not Started":"In Progress"}function ue(t){if(!t||t.length===0)return 0;const n=t.reduce((l,s)=>l+(s.progress||0),0);return Math.round(n/t.length)}async function R(t){const n=t||f;try{const{data:l,error:s}=await g.from("milestone_certificates").select("*").eq("project_id",n);if(!s&&l){const d={};l.forEach(u=>{d[u.milestone_id]=u}),ne(d)}}catch{}}async function C(t){const n=t||f;try{const{data:l,error:s}=await g.from("milestones").select("*").eq("project_id",n).order("milestone_ref");if(s)throw s;if(se(l||[]),l&&l.length>0){const d=l.map(j=>j.id),{data:u,error:b}=await g.from("deliverables").select("id, milestone_id, status, progress").in("milestone_id",d);if(!b&&u){const j={};u.forEach(N=>{j[N.milestone_id]||(j[N.milestone_id]=[]),j[N.milestone_id].push(N)}),ie(j)}}}catch{}finally{le(!1)}}async function ge(){if(!r.milestone_ref||!r.name){y("Please fill in at least Milestone Reference and Name");return}try{const{error:t}=await g.from("milestones").insert({project_id:f,milestone_ref:r.milestone_ref,name:r.name,description:r.description,start_date:r.start_date||r.baseline_start_date||null,end_date:r.end_date||r.baseline_end_date||null,baseline_start_date:r.baseline_start_date||r.start_date||null,baseline_end_date:r.baseline_end_date||r.end_date||null,actual_start_date:r.actual_start_date||r.start_date||null,forecast_end_date:r.forecast_end_date||r.end_date||null,budget:parseFloat(r.budget)||0,progress:0,status:"Not Started",created_by:k});if(t)throw t;await C(),A(!1),c({milestone_ref:"",name:"",description:"",baseline_start_date:"",baseline_end_date:"",actual_start_date:"",forecast_end_date:"",start_date:"",end_date:"",budget:""}),w("Milestone added successfully!")}catch(t){_("Failed to add milestone: "+t.message)}}function fe(t){D({isOpen:!0,milestone:t})}async function pe(){const t=S.milestone;if(t){H(!0);try{const{error:n}=await g.from("milestones").delete().eq("id",t.id);if(n)throw n;await C(),D({isOpen:!1,milestone:null})}catch(n){_("Failed to delete milestone: "+n.message)}finally{H(!1)}}}function he(t){m({id:t.id,milestone_ref:t.milestone_ref||"",name:t.name||"",description:t.description||"",baseline_start_date:t.baseline_start_date||t.start_date||"",baseline_end_date:t.baseline_end_date||t.end_date||"",actual_start_date:t.actual_start_date||t.start_date||"",forecast_end_date:t.forecast_end_date||t.end_date||"",start_date:t.start_date||"",end_date:t.end_date||"",budget:t.budget||""}),P(!0)}async function xe(){if(!i.milestone_ref||!i.name){y("Please fill in at least Milestone Reference and Name");return}try{const{error:t}=await g.from("milestones").update({milestone_ref:i.milestone_ref,name:i.name,description:i.description,start_date:i.start_date||i.baseline_start_date||null,end_date:i.end_date||i.baseline_end_date||null,baseline_start_date:i.baseline_start_date||null,baseline_end_date:i.baseline_end_date||null,actual_start_date:i.actual_start_date||null,forecast_end_date:i.forecast_end_date||null,budget:parseFloat(i.budget)||0}).eq("id",i.id);if(t)throw t;await C(),P(!1),w("Milestone updated successfully!")}catch(t){_("Failed to update milestone: "+t.message)}}function be(t){switch(t){case"Completed":return{bg:"#dcfce7",color:"#16a34a"};case"In Progress":return{bg:"#dbeafe",color:"#2563eb"};default:return{bg:"#f1f5f9",color:"#64748b"}}}function z(t){switch(t){case"Signed":return{bg:"#dcfce7",color:"#16a34a"};case"Pending Supplier Signature":return{bg:"#fef3c7",color:"#d97706"};case"Pending Customer Signature":return{bg:"#dbeafe",color:"#2563eb"};case"Draft":return{bg:"#f1f5f9",color:"#64748b"};default:return{bg:"#f1f5f9",color:"#64748b"}}}async function je(t){const n=v[t.id]||[];if(!(n.length>0&&n.every(s=>s.status==="Delivered"))){y("Cannot generate certificate: All deliverables must be delivered first.");return}if(h[t.id]){W(t);return}try{const{data:s}=await g.from("deliverables").select("deliverable_ref, name, status, progress").eq("milestone_id",t.id).eq("status","Delivered"),d=`CERT-${t.milestone_ref}-${Date.now().toString(36).toUpperCase()}`,{data:u,error:b}=await g.from("milestone_certificates").insert({project_id:f,milestone_id:t.id,certificate_number:d,milestone_ref:t.milestone_ref,milestone_name:t.name,payment_milestone_value:t.budget||0,status:"Draft",deliverables_snapshot:s||[],generated_by:k}).select().single();if(b)throw b;await R(),W(t),w("Certificate generated successfully!")}catch(s){_("Failed to generate certificate: "+s.message)}}function W(t){const n=h[t.id];$({...n,milestone:t,deliverables:v[t.id]||[]}),q(!0)}async function U(t){if(!a)return;const n=t==="supplier",l=t==="customer";if(n&&!["admin","supplier_pm"].includes(F)){y("Only Admin or Supplier PM can sign as supplier.");return}if(l&&F!=="customer_pm"){y("Only Customer PM can sign as customer.");return}try{const s={};let d=a.status;n&&(s.supplier_pm_id=k,s.supplier_pm_name=O,s.supplier_pm_signed_at=new Date().toISOString(),a.customer_pm_signed_at?d="Signed":d="Pending Customer Signature"),l&&(s.customer_pm_id=k,s.customer_pm_name=O,s.customer_pm_signed_at=new Date().toISOString(),a.supplier_pm_signed_at?d="Signed":d="Pending Supplier Signature"),s.status=d;const{error:u}=await g.from("milestone_certificates").update(s).eq("id",a.id);if(u)throw u;await R();const b={...a,...s};$(b),w("Certificate signed successfully!")}catch(s){_("Failed to sign certificate: "+s.message)}}const x=ee,_e=te,ye=re;if(ae)return e.jsx(Be,{message:"Loading milestones...",size:"large",fullPage:!0});const ve=p.reduce((t,n)=>t+(n.budget||0),0),I=p.map(t=>({...t,computedStatus:me(v[t.id]),computedProgress:ue(v[t.id])})),Se=p.length>0?Math.round(I.reduce((t,n)=>t+n.computedProgress,0)/p.length):0,V=I.filter(t=>t.computedStatus==="Completed").length,Ce=Object.values(h).filter(t=>t.status==="Signed").length,we=Object.values(h).filter(t=>t.status==="Pending Customer Signature"||t.status==="Pending Supplier Signature").length,T=V-Object.keys(h).length;return e.jsxs("div",{className:"page-container",children:[e.jsxs(Me,{icon:X,title:"Milestones",subtitle:"Track project milestones and deliverables",children:[e.jsxs("button",{className:"btn btn-secondary",onClick:()=>C(),children:[e.jsx(De,{size:18})," Refresh"]}),x&&!G&&e.jsxs("button",{className:"btn btn-primary",onClick:()=>A(!0),children:[e.jsx(K,{size:18})," Add Milestone"]})]}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem"},children:[e.jsx(B,{icon:X,label:"Total Milestones",value:p.length,color:"#3b82f6"}),e.jsx(B,{icon:Q,label:"Completed",value:V,color:"#10b981"}),e.jsx(B,{label:"Average Progress",value:`${Se}%`,color:"#3b82f6"}),e.jsx(B,{label:"Total Billable",value:`Â£${ve.toLocaleString()}`,subtext:"on completion",color:"#10b981"})]}),e.jsx("div",{style:{display:"flex",gap:"0.5rem",marginBottom:"1.5rem"},children:e.jsx(J,{to:"/gantt",className:"btn btn-secondary",style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:"ðŸ“Š View Gantt Chart"})}),e.jsx("div",{className:"card",style:{marginBottom:"1.5rem",backgroundColor:"#fefce8",borderLeft:"4px solid #eab308"},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"1rem",flexWrap:"wrap"},children:[e.jsx(E,{size:24,style:{color:"#ca8a04"}}),e.jsx("h4",{style:{margin:0,color:"#854d0e"},children:"Milestone Acceptance Certificates"}),e.jsxs("div",{style:{display:"flex",gap:"1.5rem",marginLeft:"auto"},children:[e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{fontSize:"1.5rem",fontWeight:"700",color:"#16a34a"},children:Ce}),e.jsx("div",{style:{fontSize:"0.8rem",color:"#166534"},children:"Signed"})]}),e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{fontSize:"1.5rem",fontWeight:"700",color:"#d97706"},children:we}),e.jsx("div",{style:{fontSize:"0.8rem",color:"#92400e"},children:"Pending"})]}),e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{fontSize:"1.5rem",fontWeight:"700",color:T>0?"#dc2626":"#64748b"},children:T>0?T:0}),e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b"},children:"Awaiting Generation"})]})]})]})}),G&&x&&e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem",border:"2px solid #10b981"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Add New Milestone"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 2fr",gap:"1rem",marginBottom:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Milestone Reference *"}),e.jsx("input",{type:"text",className:"form-input",placeholder:"M01",value:r.milestone_ref,onChange:t=>c({...r,milestone_ref:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Name *"}),e.jsx("input",{type:"text",className:"form-input",placeholder:"Milestone name",value:r.name,onChange:t=>c({...r,name:t.target.value})})]})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{className:"form-label",children:"Description"}),e.jsx("textarea",{className:"form-input",rows:2,placeholder:"Description",value:r.description,onChange:t=>c({...r,description:t.target.value})})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("h4",{style:{margin:"0 0 0.5rem 0",fontSize:"0.9rem",color:"#64748b"},children:"Baseline Schedule (Original Plan)"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Baseline Start Date"}),e.jsx("input",{type:"date",className:"form-input",value:r.baseline_start_date||r.start_date,onChange:t=>c({...r,baseline_start_date:t.target.value,start_date:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Baseline End Date"}),e.jsx("input",{type:"date",className:"form-input",value:r.baseline_end_date||r.end_date,onChange:t=>c({...r,baseline_end_date:t.target.value,end_date:t.target.value})})]})]})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("h4",{style:{margin:"0 0 0.5rem 0",fontSize:"0.9rem",color:"#64748b"},children:"Current Schedule"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Actual Start Date"}),e.jsx("input",{type:"date",className:"form-input",value:r.actual_start_date||r.start_date,onChange:t=>c({...r,actual_start_date:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Forecast End Date"}),e.jsx("input",{type:"date",className:"form-input",value:r.forecast_end_date||r.end_date,onChange:t=>c({...r,forecast_end_date:t.target.value})})]})]})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{className:"form-label",children:"Billable Amount (Â£)"}),e.jsx("input",{type:"number",className:"form-input",placeholder:"0",style:{maxWidth:"200px"},value:r.budget,onChange:t=>c({...r,budget:t.target.value})}),e.jsx("p",{style:{fontSize:"0.8rem",color:"#64748b",margin:"0.25rem 0 0 0"},children:"The amount that can be invoiced when this milestone is completed (not a budget for doing the work)"})]}),e.jsxs("div",{style:{padding:"0.75rem",backgroundColor:"#eff6ff",borderRadius:"6px",marginBottom:"1rem",fontSize:"0.9rem",color:"#1e40af"},children:[e.jsx("strong",{children:"Note:"})," Milestone status and progress will be automatically calculated from associated deliverables."]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsxs("button",{className:"btn btn-primary",onClick:ge,children:[e.jsx(K,{size:16})," Add Milestone"]}),e.jsx("button",{className:"btn btn-secondary",onClick:()=>A(!1),children:"Cancel"})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Project Milestones"}),e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Ref"}),e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Progress"}),e.jsx("th",{children:"Actual Start"}),e.jsx("th",{children:"Forecast End"}),e.jsx("th",{title:"Amount invoiced on completion",children:"Billable"}),e.jsx("th",{children:"Certificate"}),x&&e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:p.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:x?9:8,style:{textAlign:"center",padding:"2rem",color:"#64748b"},children:'No milestones found. Click "Add Milestone" to create one.'})}):I.map(t=>{const n=be(t.computedStatus),l=h[t.id],s=v[t.id]?.length||0;return e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx(J,{to:`/milestones/${t.id}`,style:{fontFamily:"monospace",fontWeight:"600",color:"#3b82f6",textDecoration:"none"},onMouseEnter:d=>d.target.style.textDecoration="underline",onMouseLeave:d=>d.target.style.textDecoration="none",children:t.milestone_ref})}),e.jsx("td",{style:{fontWeight:"500"},children:t.name}),e.jsxs("td",{children:[e.jsx("span",{style:{padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.85rem",backgroundColor:n.bg,color:n.color,fontWeight:"500"},children:t.computedStatus}),s>0&&e.jsxs("span",{style:{marginLeft:"0.5rem",fontSize:"0.75rem",color:"#64748b"},children:["(",s," deliverable",s!==1?"s":"",")"]})]}),e.jsx("td",{children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("div",{style:{width:"80px",height:"8px",backgroundColor:"#e2e8f0",borderRadius:"4px",overflow:"hidden"},children:e.jsx("div",{style:{width:`${t.computedProgress}%`,height:"100%",backgroundColor:t.computedStatus==="Completed"?"#10b981":"#3b82f6",transition:"width 0.3s"}})}),e.jsxs("span",{style:{fontSize:"0.85rem",fontWeight:"600",minWidth:"40px"},children:[t.computedProgress,"%"]}),e.jsx("span",{style:{fontSize:"0.75rem",color:"#64748b",fontStyle:"italic"},children:"(auto)"})]})}),e.jsx("td",{children:t.actual_start_date||t.start_date?new Date(t.actual_start_date||t.start_date).toLocaleDateString("en-GB"):"-"}),e.jsx("td",{children:t.forecast_end_date||t.end_date?new Date(t.forecast_end_date||t.end_date).toLocaleDateString("en-GB"):"-"}),e.jsxs("td",{title:"Invoiced on completion",children:["Â£",(t.budget||0).toLocaleString()]}),e.jsx("td",{children:t.computedStatus==="Completed"?l?e.jsxs("button",{onClick:()=>W(t),style:{display:"flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",backgroundColor:z(l.status).bg,color:z(l.status).color,border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"0.8rem",fontWeight:"500"},children:[e.jsx(Re,{size:14}),l.status==="Signed"?"Signed":l.status==="Pending Customer Signature"?"Awaiting Customer":l.status==="Pending Supplier Signature"?"Awaiting Supplier":"View"]}):x&&e.jsxs("button",{onClick:()=>je(t),style:{display:"flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",backgroundColor:"#fef3c7",color:"#d97706",border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"0.8rem",fontWeight:"500"},children:[e.jsx(E,{size:14}),"Generate"]}):e.jsx("span",{style:{fontSize:"0.8rem",color:"#94a3b8",fontStyle:"italic"},children:"Not ready"})}),x&&e.jsx("td",{children:e.jsxs("div",{style:{display:"flex",gap:"0.25rem"},children:[e.jsx("button",{onClick:()=>he(t),style:{padding:"0.5rem",backgroundColor:"#eff6ff",color:"#3b82f6",border:"none",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center"},title:"Edit",children:e.jsx(Y,{size:16})}),e.jsx("button",{onClick:()=>fe(t),style:{padding:"0.5rem",backgroundColor:"#fef2f2",color:"#ef4444",border:"none",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center"},title:"Delete",children:e.jsx(We,{size:16})})]})})]},t.id)})})]})]}),de&&e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:e.jsxs("div",{style:{backgroundColor:"white",padding:"1.5rem",borderRadius:"12px",maxWidth:"600px",width:"90%",maxHeight:"90vh",overflow:"auto"},children:[e.jsxs("h3",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginTop:0},children:[e.jsx(Y,{size:20}),"Edit Milestone - ",i.milestone_ref]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 2fr",gap:"1rem",marginBottom:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Reference *"}),e.jsx("input",{type:"text",value:i.milestone_ref,onChange:t=>m({...i,milestone_ref:t.target.value}),style:{width:"100%",padding:"0.5rem",border:"1px solid #e2e8f0",borderRadius:"6px"}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Name *"}),e.jsx("input",{type:"text",value:i.name,onChange:t=>m({...i,name:t.target.value}),style:{width:"100%",padding:"0.5rem",border:"1px solid #e2e8f0",borderRadius:"6px"}})]})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Description"}),e.jsx("textarea",{value:i.description,onChange:t=>m({...i,description:t.target.value}),rows:3,style:{width:"100%",padding:"0.5rem",border:"1px solid #e2e8f0",borderRadius:"6px"}})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("h4",{style:{margin:"0 0 0.5rem 0",fontSize:"0.85rem",color:"#64748b"},children:"Baseline Schedule (Original Plan)"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Baseline Start"}),e.jsx("input",{type:"date",value:i.baseline_start_date,onChange:t=>m({...i,baseline_start_date:t.target.value}),style:{width:"100%",padding:"0.5rem",border:"1px solid #e2e8f0",borderRadius:"6px"}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Baseline End"}),e.jsx("input",{type:"date",value:i.baseline_end_date,onChange:t=>m({...i,baseline_end_date:t.target.value}),style:{width:"100%",padding:"0.5rem",border:"1px solid #e2e8f0",borderRadius:"6px"}})]})]})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("h4",{style:{margin:"0 0 0.5rem 0",fontSize:"0.85rem",color:"#64748b"},children:"Current Schedule"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Actual Start"}),e.jsx("input",{type:"date",value:i.actual_start_date,onChange:t=>m({...i,actual_start_date:t.target.value}),style:{width:"100%",padding:"0.5rem",border:"1px solid #e2e8f0",borderRadius:"6px"}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Forecast End"}),e.jsx("input",{type:"date",value:i.forecast_end_date,onChange:t=>m({...i,forecast_end_date:t.target.value}),style:{width:"100%",padding:"0.5rem",border:"1px solid #e2e8f0",borderRadius:"6px"}})]})]})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Billable Amount (Â£)"}),e.jsx("input",{type:"number",value:i.budget,onChange:t=>m({...i,budget:t.target.value}),style:{width:"200px",padding:"0.5rem",border:"1px solid #e2e8f0",borderRadius:"6px"}}),e.jsx("p",{style:{fontSize:"0.8rem",color:"#64748b",margin:"0.25rem 0 0 0"},children:"Amount invoiced when milestone is completed (not a budget for doing the work)"})]}),e.jsxs("div",{style:{padding:"0.75rem",backgroundColor:"#eff6ff",borderRadius:"6px",marginBottom:"1rem",fontSize:"0.9rem",color:"#1e40af"},children:[e.jsx("strong",{children:"ðŸ’¡ Note:"})," Status and progress are ",e.jsx("strong",{children:"automatically calculated"})," from associated deliverables and cannot be manually edited.",e.jsxs("ul",{style:{margin:"0.5rem 0 0 1rem",paddingLeft:"0.5rem"},children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Not Started"})," â€” No deliverables have begun"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"In Progress"})," â€” At least one deliverable is in progress"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Completed"})," â€” All deliverables are delivered"]})]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:"0.5rem"},children:[e.jsxs("button",{onClick:()=>P(!1),style:{padding:"0.5rem 1rem",backgroundColor:"#f1f5f9",color:"#64748b",border:"none",borderRadius:"6px",cursor:"pointer",display:"flex",alignItems:"center",gap:"0.25rem"},children:[e.jsx(Ie,{size:16})," Cancel"]}),e.jsxs("button",{onClick:xe,style:{padding:"0.5rem 1rem",backgroundColor:"#10b981",color:"white",border:"none",borderRadius:"6px",cursor:"pointer",display:"flex",alignItems:"center",gap:"0.25rem"},children:[e.jsx(Te,{size:16})," Save Changes"]})]})]})}),oe&&a&&e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:e.jsxs("div",{style:{backgroundColor:"white",padding:"2rem",borderRadius:"12px",maxWidth:"700px",width:"90%",maxHeight:"90vh",overflow:"auto"},children:[e.jsxs("div",{style:{textAlign:"center",borderBottom:"2px solid #10b981",paddingBottom:"1rem",marginBottom:"1.5rem"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",gap:"0.5rem",marginBottom:"0.5rem"},children:[e.jsx(E,{size:32,style:{color:"#10b981"}}),e.jsx("h2",{style:{margin:0,color:"#166534"},children:"Milestone Acceptance Certificate"})]}),e.jsxs("div",{style:{fontSize:"0.9rem",color:"#64748b"},children:["Certificate No: ",e.jsx("strong",{children:a.certificate_number})]}),e.jsx("div",{style:{display:"inline-block",marginTop:"0.5rem",padding:"0.25rem 0.75rem",borderRadius:"999px",fontSize:"0.85rem",fontWeight:"600",backgroundColor:z(a.status).bg,color:z(a.status).color},children:a.status})]}),e.jsxs("div",{style:{marginBottom:"1.5rem"},children:[e.jsx("h4",{style:{margin:"0 0 0.75rem 0",color:"#1e293b"},children:"Milestone Details"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"0.75rem",backgroundColor:"#f8fafc",padding:"1rem",borderRadius:"8px"},children:[e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b"},children:"Reference"}),e.jsx("div",{style:{fontWeight:"600"},children:a.milestone_ref})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b"},children:"Name"}),e.jsx("div",{style:{fontWeight:"600"},children:a.milestone_name})]}),e.jsxs("div",{style:{gridColumn:"1 / -1"},children:[e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b"},children:"Payment Milestone Associated"}),e.jsxs("div",{style:{fontWeight:"700",fontSize:"1.25rem",color:"#10b981"},children:["Â£",(a.payment_milestone_value||0).toLocaleString()]})]})]})]}),e.jsxs("div",{style:{marginBottom:"1.5rem"},children:[e.jsx("h4",{style:{margin:"0 0 0.75rem 0",color:"#1e293b"},children:"Deliverables Accepted"}),e.jsx("div",{style:{border:"1px solid #e2e8f0",borderRadius:"8px",overflow:"hidden"},children:e.jsxs("table",{style:{width:"100%",fontSize:"0.9rem"},children:[e.jsx("thead",{children:e.jsxs("tr",{style:{backgroundColor:"#f1f5f9"},children:[e.jsx("th",{style:{padding:"0.5rem",textAlign:"left"},children:"Ref"}),e.jsx("th",{style:{padding:"0.5rem",textAlign:"left"},children:"Name"}),e.jsx("th",{style:{padding:"0.5rem",textAlign:"center"},children:"Status"})]})}),e.jsx("tbody",{children:(a.deliverables_snapshot||[]).map((t,n)=>e.jsxs("tr",{style:{borderTop:"1px solid #e2e8f0"},children:[e.jsx("td",{style:{padding:"0.5rem",fontFamily:"monospace",fontWeight:"600"},children:t.deliverable_ref}),e.jsx("td",{style:{padding:"0.5rem"},children:t.name}),e.jsx("td",{style:{padding:"0.5rem",textAlign:"center"},children:e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",color:"#16a34a"},children:[e.jsx(Q,{size:14})," Accepted"]})})]},n))})]})})]}),e.jsxs("div",{style:{marginBottom:"1.5rem"},children:[e.jsx("h4",{style:{margin:"0 0 0.75rem 0",color:"#1e293b"},children:"Signatures"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsxs("div",{style:{padding:"1rem",border:"2px solid",borderColor:a.supplier_pm_signed_at?"#10b981":"#e2e8f0",borderRadius:"8px",backgroundColor:a.supplier_pm_signed_at?"#f0fdf4":"#f8fafc"},children:[e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b",marginBottom:"0.5rem"},children:"Supplier PM"}),a.supplier_pm_signed_at?e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",fontWeight:"600",color:"#166534"},children:[e.jsx(M,{size:16}),a.supplier_pm_name]}),e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b",marginTop:"0.25rem"},children:new Date(a.supplier_pm_signed_at).toLocaleString("en-GB")})]}):_e&&a.status!=="Signed"?e.jsxs("button",{onClick:()=>U("supplier"),style:{width:"100%",padding:"0.5rem",backgroundColor:"#10b981",color:"white",border:"none",borderRadius:"6px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"0.5rem",fontWeight:"500"},children:[e.jsx(M,{size:16})," Sign as Supplier PM"]}):e.jsx("div",{style:{color:"#94a3b8",fontStyle:"italic"},children:"Awaiting signature"})]}),e.jsxs("div",{style:{padding:"1rem",border:"2px solid",borderColor:a.customer_pm_signed_at?"#10b981":"#e2e8f0",borderRadius:"8px",backgroundColor:a.customer_pm_signed_at?"#f0fdf4":"#f8fafc"},children:[e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b",marginBottom:"0.5rem"},children:"Customer PM"}),a.customer_pm_signed_at?e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",fontWeight:"600",color:"#166534"},children:[e.jsx(M,{size:16}),a.customer_pm_name]}),e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b",marginTop:"0.25rem"},children:new Date(a.customer_pm_signed_at).toLocaleString("en-GB")})]}):ye&&a.status!=="Signed"?e.jsxs("button",{onClick:()=>U("customer"),style:{width:"100%",padding:"0.5rem",backgroundColor:"#3b82f6",color:"white",border:"none",borderRadius:"6px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"0.5rem",fontWeight:"500"},children:[e.jsx(M,{size:16})," Sign as Customer PM"]}):e.jsx("div",{style:{color:"#94a3b8",fontStyle:"italic"},children:"Awaiting signature"})]})]})]}),e.jsxs("div",{style:{fontSize:"0.8rem",color:"#64748b",textAlign:"center",marginBottom:"1rem"},children:["Generated: ",new Date(a.generated_at).toLocaleString("en-GB")]}),e.jsx("div",{style:{display:"flex",justifyContent:"center"},children:e.jsx("button",{onClick:()=>q(!1),style:{padding:"0.75rem 2rem",backgroundColor:"#f1f5f9",color:"#64748b",border:"none",borderRadius:"6px",cursor:"pointer",fontWeight:"500"},children:"Close"})})]})}),e.jsxs("div",{className:"card",style:{marginTop:"1.5rem",backgroundColor:"#eff6ff",borderLeft:"4px solid #3b82f6"},children:[e.jsx("h4",{style:{marginBottom:"0.5rem",color:"#1e40af"},children:"ðŸ’¡ How Milestone Status & Progress Work"}),e.jsxs("ul",{style:{margin:"0.5rem 0 0 1.5rem",color:"#1e40af",fontSize:"0.9rem"},children:[e.jsxs("li",{children:["Milestone ",e.jsx("strong",{children:"status"})," and ",e.jsx("strong",{children:"progress"})," are automatically calculated from deliverables"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Not Started:"}),' All deliverables are "Not Started" (or no deliverables exist)']}),e.jsxs("li",{children:[e.jsx("strong",{children:"In Progress:"})," At least one deliverable has begun work"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Completed:"})," All deliverables have been delivered"]}),e.jsx("li",{children:"Click milestone reference to view and manage deliverables"}),e.jsx("li",{children:"Progress = average of all deliverable progress percentages"}),e.jsx("li",{children:"Timesheets continue to be logged against milestones (not individual deliverables)"}),e.jsx("li",{children:"Payment aligned to milestone completion per SOW requirements"})]})]}),e.jsx(Pe,{isOpen:S.isOpen,onClose:()=>D({isOpen:!1,milestone:null}),onConfirm:pe,title:"Delete Milestone?",message:S.milestone?`This will permanently delete "${S.milestone.milestone_ref}: ${S.milestone.name}" and all associated deliverables. This action cannot be undone.`:"",confirmText:"Delete Milestone",cancelText:"Cancel",type:"danger",isLoading:ce})]})}export{$e as default};
