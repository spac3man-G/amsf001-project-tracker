import{j as e,u as ve,a as Se,b as Ce,m as y,d as we,L as Me,s as ke}from"./index-BMtyVBlm.js";import{L as Z,r as f}from"./vendor-react-JFEV0ROX.js";import{u as Be}from"./usePermissions-CZ2C7f4E.js";import{S as N}from"./StatCard-DIPDv0dz.js";import{P as Ne}from"./PageHeader-DAEOWEM6.js";import{C as ze}from"./ConfirmDialog-CECw1whS.js";import{i as L,C as J,W as q,Y as K,Z as Q,a as Ae,_ as Pe,T as De,N as We,r as X,R as Re}from"./vendor-icons-CMdlt-Xc.js";import"./vendor-supabase-DgEUAXvv.js";function Ie(t){switch(t){case"Signed":return{bg:"#dcfce7",color:"#16a34a"};case"Pending Supplier Signature":return{bg:"#fef3c7",color:"#d97706"};case"Pending Customer Signature":return{bg:"#dbeafe",color:"#2563eb"};case"Draft":return{bg:"#f1f5f9",color:"#64748b"};default:return{bg:"#f1f5f9",color:"#64748b"}}}function Te({certificate:t,onClose:n,onSign:c,canSignSupplier:o,canSignCustomer:r}){if(!t)return null;const l=Ie(t.status);return e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:e.jsxs("div",{style:{backgroundColor:"white",padding:"2rem",borderRadius:"12px",maxWidth:"700px",width:"90%",maxHeight:"90vh",overflow:"auto"},children:[e.jsxs("div",{style:{textAlign:"center",borderBottom:"2px solid #10b981",paddingBottom:"1rem",marginBottom:"1.5rem"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",gap:"0.5rem",marginBottom:"0.5rem"},children:[e.jsx(L,{size:32,style:{color:"#10b981"}}),e.jsx("h2",{style:{margin:0,color:"#166534"},children:"Milestone Acceptance Certificate"})]}),e.jsxs("div",{style:{fontSize:"0.9rem",color:"#64748b"},children:["Certificate No: ",e.jsx("strong",{children:t.certificate_number})]}),e.jsx("div",{style:{display:"inline-block",marginTop:"0.5rem",padding:"0.25rem 0.75rem",borderRadius:"999px",fontSize:"0.85rem",fontWeight:"600",backgroundColor:l.bg,color:l.color},children:t.status})]}),e.jsxs("div",{style:{marginBottom:"1.5rem"},children:[e.jsx("h4",{style:{margin:"0 0 0.75rem 0",color:"#1e293b"},children:"Milestone Details"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"0.75rem",backgroundColor:"#f8fafc",padding:"1rem",borderRadius:"8px"},children:[e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b"},children:"Reference"}),e.jsx("div",{style:{fontWeight:"600"},children:t.milestone_ref})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b"},children:"Name"}),e.jsx("div",{style:{fontWeight:"600"},children:t.milestone_name})]}),e.jsxs("div",{style:{gridColumn:"1 / -1"},children:[e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b"},children:"Payment Milestone Associated"}),e.jsxs("div",{style:{fontWeight:"700",fontSize:"1.25rem",color:"#10b981"},children:["Â£",(t.payment_milestone_value||0).toLocaleString()]})]})]})]}),e.jsxs("div",{style:{marginBottom:"1.5rem"},children:[e.jsx("h4",{style:{margin:"0 0 0.75rem 0",color:"#1e293b"},children:"Deliverables Accepted"}),e.jsx("div",{style:{border:"1px solid #e2e8f0",borderRadius:"8px",overflow:"hidden"},children:e.jsxs("table",{style:{width:"100%",fontSize:"0.9rem"},children:[e.jsx("thead",{children:e.jsxs("tr",{style:{backgroundColor:"#f1f5f9"},children:[e.jsx("th",{style:{padding:"0.5rem",textAlign:"left"},children:"Ref"}),e.jsx("th",{style:{padding:"0.5rem",textAlign:"left"},children:"Name"}),e.jsx("th",{style:{padding:"0.5rem",textAlign:"center"},children:"Status"})]})}),e.jsx("tbody",{children:(t.deliverables_snapshot||[]).map((p,h)=>e.jsxs("tr",{style:{borderTop:"1px solid #e2e8f0"},children:[e.jsx("td",{style:{padding:"0.5rem",fontFamily:"monospace",fontWeight:"600"},children:p.deliverable_ref}),e.jsx("td",{style:{padding:"0.5rem"},children:p.name}),e.jsx("td",{style:{padding:"0.5rem",textAlign:"center"},children:e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",color:"#16a34a"},children:[e.jsx(J,{size:14})," Accepted"]})})]},h))})]})})]}),e.jsxs("div",{style:{marginBottom:"1.5rem"},children:[e.jsx("h4",{style:{margin:"0 0 0.75rem 0",color:"#1e293b"},children:"Signatures"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsx(Y,{label:"Supplier PM",signedBy:t.supplier_pm_name,signedAt:t.supplier_pm_signed_at,canSign:o&&t.status!=="Signed",onSign:()=>c("supplier"),buttonText:"Sign as Supplier PM",buttonColor:"#10b981"}),e.jsx(Y,{label:"Customer PM",signedBy:t.customer_pm_name,signedAt:t.customer_pm_signed_at,canSign:r&&t.status!=="Signed",onSign:()=>c("customer"),buttonText:"Sign as Customer PM",buttonColor:"#3b82f6"})]})]}),e.jsxs("div",{style:{fontSize:"0.8rem",color:"#64748b",textAlign:"center",marginBottom:"1rem"},children:["Generated: ",new Date(t.generated_at).toLocaleString("en-GB")]}),e.jsx("div",{style:{display:"flex",justifyContent:"center"},children:e.jsx("button",{onClick:n,style:{padding:"0.75rem 2rem",backgroundColor:"#f1f5f9",color:"#64748b",border:"none",borderRadius:"6px",cursor:"pointer",fontWeight:"500"},children:"Close"})})]})})}function Y({label:t,signedBy:n,signedAt:c,canSign:o,onSign:r,buttonText:l,buttonColor:p}){const h=!!c;return e.jsxs("div",{style:{padding:"1rem",border:"2px solid",borderColor:h?"#10b981":"#e2e8f0",borderRadius:"8px",backgroundColor:h?"#f0fdf4":"#f8fafc"},children:[e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b",marginBottom:"0.5rem"},children:t}),h?e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",fontWeight:"600",color:"#166534"},children:[e.jsx(q,{size:16}),n]}),e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b",marginTop:"0.25rem"},children:new Date(c).toLocaleString("en-GB")})]}):o?e.jsxs("button",{onClick:r,style:{width:"100%",padding:"0.5rem",backgroundColor:p,color:"white",border:"none",borderRadius:"6px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"0.5rem",fontWeight:"500"},children:[e.jsx(q,{size:16})," ",l]}):e.jsx("div",{style:{color:"#94a3b8",fontStyle:"italic"},children:"Awaiting signature"})]})}function Ee({form:t,onFormChange:n,onSubmit:c,onCancel:o}){return e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem",border:"2px solid #10b981"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Add New Milestone"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 2fr",gap:"1rem",marginBottom:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Milestone Reference *"}),e.jsx("input",{type:"text",className:"form-input",placeholder:"M01",value:t.milestone_ref,onChange:r=>n({...t,milestone_ref:r.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Name *"}),e.jsx("input",{type:"text",className:"form-input",placeholder:"Milestone name",value:t.name,onChange:r=>n({...t,name:r.target.value})})]})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{className:"form-label",children:"Description"}),e.jsx("textarea",{className:"form-input",rows:2,placeholder:"Description",value:t.description,onChange:r=>n({...t,description:r.target.value})})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("h4",{style:{margin:"0 0 0.5rem 0",fontSize:"0.9rem",color:"#64748b"},children:"Baseline Schedule (Original Plan)"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Baseline Start Date"}),e.jsx("input",{type:"date",className:"form-input",value:t.baseline_start_date||t.start_date,onChange:r=>n({...t,baseline_start_date:r.target.value,start_date:r.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Baseline End Date"}),e.jsx("input",{type:"date",className:"form-input",value:t.baseline_end_date||t.end_date,onChange:r=>n({...t,baseline_end_date:r.target.value,end_date:r.target.value})})]})]})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("h4",{style:{margin:"0 0 0.5rem 0",fontSize:"0.9rem",color:"#64748b"},children:"Current Schedule"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Actual Start Date"}),e.jsx("input",{type:"date",className:"form-input",value:t.actual_start_date||t.start_date,onChange:r=>n({...t,actual_start_date:r.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Forecast End Date"}),e.jsx("input",{type:"date",className:"form-input",value:t.forecast_end_date||t.end_date,onChange:r=>n({...t,forecast_end_date:r.target.value})})]})]})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{className:"form-label",children:"Billable Amount (Â£)"}),e.jsx("input",{type:"number",className:"form-input",placeholder:"0",style:{maxWidth:"200px"},value:t.budget,onChange:r=>n({...t,budget:r.target.value})}),e.jsx("p",{style:{fontSize:"0.8rem",color:"#64748b",margin:"0.25rem 0 0 0"},children:"The amount that can be invoiced when this milestone is completed (not a budget for doing the work)"})]}),e.jsxs("div",{style:{padding:"0.75rem",backgroundColor:"#eff6ff",borderRadius:"6px",marginBottom:"1rem",fontSize:"0.9rem",color:"#1e40af"},children:[e.jsx("strong",{children:"Note:"})," Milestone status and progress will be automatically calculated from associated deliverables."]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsxs("button",{className:"btn btn-primary",onClick:c,children:[e.jsx(K,{size:16})," Add Milestone"]}),e.jsx("button",{className:"btn btn-secondary",onClick:o,children:"Cancel"})]})]})}function Le({form:t,onFormChange:n,onSave:c,onClose:o}){const r={width:"100%",padding:"0.5rem",border:"1px solid #e2e8f0",borderRadius:"6px"};return e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:e.jsxs("div",{style:{backgroundColor:"white",padding:"1.5rem",borderRadius:"12px",maxWidth:"600px",width:"90%",maxHeight:"90vh",overflow:"auto"},children:[e.jsxs("h3",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginTop:0},children:[e.jsx(Q,{size:20}),"Edit Milestone - ",t.milestone_ref]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 2fr",gap:"1rem",marginBottom:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Reference *"}),e.jsx("input",{type:"text",value:t.milestone_ref,onChange:l=>n({...t,milestone_ref:l.target.value}),style:r})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Name *"}),e.jsx("input",{type:"text",value:t.name,onChange:l=>n({...t,name:l.target.value}),style:r})]})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Description"}),e.jsx("textarea",{value:t.description,onChange:l=>n({...t,description:l.target.value}),rows:3,style:r})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("h4",{style:{margin:"0 0 0.5rem 0",fontSize:"0.85rem",color:"#64748b"},children:"Baseline Schedule (Original Plan)"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Baseline Start"}),e.jsx("input",{type:"date",value:t.baseline_start_date,onChange:l=>n({...t,baseline_start_date:l.target.value}),style:r})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Baseline End"}),e.jsx("input",{type:"date",value:t.baseline_end_date,onChange:l=>n({...t,baseline_end_date:l.target.value}),style:r})]})]})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("h4",{style:{margin:"0 0 0.5rem 0",fontSize:"0.85rem",color:"#64748b"},children:"Current Schedule"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Actual Start"}),e.jsx("input",{type:"date",value:t.actual_start_date,onChange:l=>n({...t,actual_start_date:l.target.value}),style:r})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Forecast End"}),e.jsx("input",{type:"date",value:t.forecast_end_date,onChange:l=>n({...t,forecast_end_date:l.target.value}),style:r})]})]})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Billable Amount (Â£)"}),e.jsx("input",{type:"number",value:t.budget,onChange:l=>n({...t,budget:l.target.value}),style:{...r,width:"200px"}}),e.jsx("p",{style:{fontSize:"0.8rem",color:"#64748b",margin:"0.25rem 0 0 0"},children:"Amount invoiced when milestone is completed (not a budget for doing the work)"})]}),e.jsxs("div",{style:{padding:"0.75rem",backgroundColor:"#eff6ff",borderRadius:"6px",marginBottom:"1rem",fontSize:"0.9rem",color:"#1e40af"},children:[e.jsx("strong",{children:"ðŸ’¡ Note:"})," Status and progress are ",e.jsx("strong",{children:"automatically calculated"})," from associated deliverables and cannot be manually edited.",e.jsxs("ul",{style:{margin:"0.5rem 0 0 1rem",paddingLeft:"0.5rem"},children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Not Started"})," â€” No deliverables have begun"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"In Progress"})," â€” At least one deliverable is in progress"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Completed"})," â€” All deliverables are delivered"]})]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:"0.5rem"},children:[e.jsxs("button",{onClick:o,style:{padding:"0.5rem 1rem",backgroundColor:"#f1f5f9",color:"#64748b",border:"none",borderRadius:"6px",cursor:"pointer",display:"flex",alignItems:"center",gap:"0.25rem"},children:[e.jsx(Ae,{size:16})," Cancel"]}),e.jsxs("button",{onClick:c,style:{padding:"0.5rem 1rem",backgroundColor:"#10b981",color:"white",border:"none",borderRadius:"6px",cursor:"pointer",display:"flex",alignItems:"center",gap:"0.25rem"},children:[e.jsx(Pe,{size:16})," Save Changes"]})]})]})})}function Oe(t){switch(t){case"Completed":return{bg:"#dcfce7",color:"#16a34a"};case"In Progress":return{bg:"#dbeafe",color:"#2563eb"};default:return{bg:"#f1f5f9",color:"#64748b"}}}function Ge(t){switch(t){case"Signed":return{bg:"#dcfce7",color:"#16a34a"};case"Pending Supplier Signature":return{bg:"#fef3c7",color:"#d97706"};case"Pending Customer Signature":return{bg:"#dbeafe",color:"#2563eb"};case"Draft":return{bg:"#f1f5f9",color:"#64748b"};default:return{bg:"#f1f5f9",color:"#64748b"}}}function $e({milestones:t,milestoneDeliverables:n,certificates:c,canEdit:o,onEdit:r,onDelete:l,onGenerateCertificate:p,onViewCertificate:h}){return e.jsxs("div",{className:"card",children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Project Milestones"}),e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Ref"}),e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Progress"}),e.jsx("th",{children:"Actual Start"}),e.jsx("th",{children:"Forecast End"}),e.jsx("th",{title:"Amount invoiced on completion",children:"Billable"}),e.jsx("th",{children:"Certificate"}),o&&e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:t.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:o?9:8,style:{textAlign:"center",padding:"2rem",color:"#64748b"},children:'No milestones found. Click "Add Milestone" to create one.'})}):t.map(a=>{const k=Oe(a.computedStatus),z=c[a.id],S=n[a.id]?.length||0;return e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx(Z,{to:`/milestones/${a.id}`,style:{fontFamily:"monospace",fontWeight:"600",color:"#3b82f6",textDecoration:"none"},onMouseEnter:x=>x.target.style.textDecoration="underline",onMouseLeave:x=>x.target.style.textDecoration="none",children:a.milestone_ref})}),e.jsx("td",{style:{fontWeight:"500"},children:a.name}),e.jsxs("td",{children:[e.jsx("span",{style:{padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.85rem",backgroundColor:k.bg,color:k.color,fontWeight:"500"},children:a.computedStatus}),S>0&&e.jsxs("span",{style:{marginLeft:"0.5rem",fontSize:"0.75rem",color:"#64748b"},children:["(",S," deliverable",S!==1?"s":"",")"]})]}),e.jsx("td",{children:e.jsx(Fe,{progress:a.computedProgress,isCompleted:a.computedStatus==="Completed"})}),e.jsx("td",{children:a.actual_start_date||a.start_date?new Date(a.actual_start_date||a.start_date).toLocaleDateString("en-GB"):"-"}),e.jsx("td",{children:a.forecast_end_date||a.end_date?new Date(a.forecast_end_date||a.end_date).toLocaleDateString("en-GB"):"-"}),e.jsxs("td",{title:"Invoiced on completion",children:["Â£",(a.budget||0).toLocaleString()]}),e.jsx("td",{children:e.jsx(He,{milestone:a,certificate:z,canEdit:o,onGenerate:()=>p(a),onView:()=>h(a)})}),o&&e.jsx("td",{children:e.jsxs("div",{style:{display:"flex",gap:"0.25rem"},children:[e.jsx("button",{onClick:()=>r(a),style:{padding:"0.5rem",backgroundColor:"#eff6ff",color:"#3b82f6",border:"none",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center"},title:"Edit",children:e.jsx(Q,{size:16})}),e.jsx("button",{onClick:()=>l(a),style:{padding:"0.5rem",backgroundColor:"#fef2f2",color:"#ef4444",border:"none",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center"},title:"Delete",children:e.jsx(De,{size:16})})]})})]},a.id)})})]})]})}function Fe({progress:t,isCompleted:n}){return e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("div",{style:{width:"80px",height:"8px",backgroundColor:"#e2e8f0",borderRadius:"4px",overflow:"hidden"},children:e.jsx("div",{style:{width:`${t}%`,height:"100%",backgroundColor:n?"#10b981":"#3b82f6",transition:"width 0.3s"}})}),e.jsxs("span",{style:{fontSize:"0.85rem",fontWeight:"600",minWidth:"40px"},children:[t,"%"]}),e.jsx("span",{style:{fontSize:"0.75rem",color:"#64748b",fontStyle:"italic"},children:"(auto)"})]})}function He({milestone:t,certificate:n,canEdit:c,onGenerate:o,onView:r}){if(t.computedStatus!=="Completed")return e.jsx("span",{style:{fontSize:"0.8rem",color:"#94a3b8",fontStyle:"italic"},children:"Not ready"});if(n){const l=Ge(n.status),p=n.status==="Signed"?"Signed":n.status==="Pending Customer Signature"?"Awaiting Customer":n.status==="Pending Supplier Signature"?"Awaiting Supplier":"View";return e.jsxs("button",{onClick:r,style:{display:"flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",backgroundColor:l.bg,color:l.color,border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"0.8rem",fontWeight:"500"},children:[e.jsx(We,{size:14}),p]})}return c?e.jsxs("button",{onClick:o,style:{display:"flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",backgroundColor:"#fef3c7",color:"#d97706",border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"0.8rem",fontWeight:"500"},children:[e.jsx(L,{size:14}),"Generate"]}):null}function Ue({signedCount:t,pendingCount:n,awaitingCount:c}){return e.jsx("div",{className:"card",style:{marginBottom:"1.5rem",backgroundColor:"#fefce8",borderLeft:"4px solid #eab308"},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"1rem",flexWrap:"wrap"},children:[e.jsx(L,{size:24,style:{color:"#ca8a04"}}),e.jsx("h4",{style:{margin:0,color:"#854d0e"},children:"Milestone Acceptance Certificates"}),e.jsxs("div",{style:{display:"flex",gap:"1.5rem",marginLeft:"auto"},children:[e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{fontSize:"1.5rem",fontWeight:"700",color:"#16a34a"},children:t}),e.jsx("div",{style:{fontSize:"0.8rem",color:"#166534"},children:"Signed"})]}),e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{fontSize:"1.5rem",fontWeight:"700",color:"#d97706"},children:n}),e.jsx("div",{style:{fontSize:"0.8rem",color:"#92400e"},children:"Pending"})]}),e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{fontSize:"1.5rem",fontWeight:"700",color:c>0?"#dc2626":"#64748b"},children:c>0?c:0}),e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b"},children:"Awaiting Generation"})]})]})]})})}function Ve(){return e.jsxs("div",{className:"card",style:{marginTop:"1.5rem",backgroundColor:"#eff6ff",borderLeft:"4px solid #3b82f6"},children:[e.jsx("h4",{style:{marginBottom:"0.5rem",color:"#1e40af"},children:"ðŸ’¡ How Milestone Status & Progress Work"}),e.jsxs("ul",{style:{margin:"0.5rem 0 0 1.5rem",color:"#1e40af",fontSize:"0.9rem"},children:[e.jsxs("li",{children:["Milestone ",e.jsx("strong",{children:"status"})," and ",e.jsx("strong",{children:"progress"})," are automatically calculated from deliverables"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Not Started:"}),' All deliverables are "Not Started" (or no deliverables exist)']}),e.jsxs("li",{children:[e.jsx("strong",{children:"In Progress:"})," At least one deliverable has begun work"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Completed:"})," All deliverables have been delivered"]}),e.jsx("li",{children:"Click milestone reference to view and manage deliverables"}),e.jsx("li",{children:"Progress = average of all deliverable progress percentages"}),e.jsx("li",{children:"Timesheets continue to be logged against milestones (not individual deliverables)"}),e.jsx("li",{children:"Payment aligned to milestone completion per SOW requirements"})]})]})}function tt(){const{user:t,role:n,profile:c}=ve(),{projectId:o}=Se(),{showSuccess:r,showError:l,showWarning:p}=Ce(),h=t?.id||null,a=c?.full_name||t?.email||"Unknown",{canEditMilestone:k,canSignAsSupplier:z,canSignAsCustomer:S}=Be(),[x,ee]=f.useState([]),[C,te]=f.useState({}),[_,se]=f.useState({}),[re,ne]=f.useState(!0),[O,A]=f.useState(!1),[le,P]=f.useState(!1),[ie,G]=f.useState(!1),[b,$]=f.useState(null),[w,D]=f.useState({isOpen:!1,milestone:null}),[ae,F]=f.useState(!1),W={milestone_ref:"",name:"",description:"",baseline_start_date:"",baseline_end_date:"",actual_start_date:"",forecast_end_date:"",start_date:"",end_date:"",budget:""},[u,H]=f.useState(W),[m,U]=f.useState({id:"",...W});f.useEffect(()=>{o&&(M(o),R(o))},[o]);function oe(s){if(!s||s.length===0)return"Not Started";const d=s.every(i=>i.status==="Not Started"||!i.status);return s.every(i=>i.status==="Delivered")?"Completed":d?"Not Started":"In Progress"}function de(s){if(!s||s.length===0)return 0;const d=s.reduce((g,i)=>g+(i.progress||0),0);return Math.round(d/s.length)}async function R(s){try{const d=await y.getCertificates(s||o),g={};d.forEach(i=>{g[i.milestone_id]=i}),se(g)}catch{}}async function M(s){const d=s||o;try{const g=await y.getAll(d,{orderBy:{column:"milestone_ref",ascending:!0}});if(ee(g||[]),g&&g.length>0){const i=g.map(v=>v.id),j=await we.getAll(d,{filters:[{column:"milestone_id",operator:"in",value:i}],select:"id, milestone_id, status, progress"});if(j){const v={};j.forEach(B=>{v[B.milestone_id]||(v[B.milestone_id]=[]),v[B.milestone_id].push(B)}),te(v)}}}catch{l("Failed to load milestones")}finally{ne(!1)}}async function ce(){if(!u.milestone_ref||!u.name){p("Please fill in at least Milestone Reference and Name");return}try{await y.create({project_id:o,milestone_ref:u.milestone_ref,name:u.name,description:u.description,start_date:u.start_date||u.baseline_start_date||null,end_date:u.end_date||u.baseline_end_date||null,baseline_start_date:u.baseline_start_date||u.start_date||null,baseline_end_date:u.baseline_end_date||u.end_date||null,actual_start_date:u.actual_start_date||u.start_date||null,forecast_end_date:u.forecast_end_date||u.end_date||null,budget:parseFloat(u.budget)||0,progress:0,status:"Not Started",created_by:h}),await M(),A(!1),H(W),r("Milestone added successfully!")}catch(s){l("Failed to add milestone: "+s.message)}}function ue(s){D({isOpen:!0,milestone:s})}async function me(){const s=w.milestone;if(s){F(!0);try{await y.delete(s.id),await M(),D({isOpen:!1,milestone:null}),r("Milestone deleted successfully!")}catch(d){l("Failed to delete milestone: "+d.message)}finally{F(!1)}}}function ge(s){U({id:s.id,milestone_ref:s.milestone_ref||"",name:s.name||"",description:s.description||"",baseline_start_date:s.baseline_start_date||s.start_date||"",baseline_end_date:s.baseline_end_date||s.end_date||"",actual_start_date:s.actual_start_date||s.start_date||"",forecast_end_date:s.forecast_end_date||s.end_date||"",start_date:s.start_date||"",end_date:s.end_date||"",budget:s.budget||""}),P(!0)}async function pe(){if(!m.milestone_ref||!m.name){p("Please fill in at least Milestone Reference and Name");return}try{await y.update(m.id,{milestone_ref:m.milestone_ref,name:m.name,description:m.description,start_date:m.start_date||m.baseline_start_date||null,end_date:m.end_date||m.baseline_end_date||null,baseline_start_date:m.baseline_start_date||null,baseline_end_date:m.baseline_end_date||null,actual_start_date:m.actual_start_date||null,forecast_end_date:m.forecast_end_date||null,budget:parseFloat(m.budget)||0}),await M(),P(!1),r("Milestone updated successfully!")}catch(s){l("Failed to update milestone: "+s.message)}}async function fe(s){const d=C[s.id]||[];if(!(d.length>0&&d.every(i=>i.status==="Delivered"))){p("Cannot generate certificate: All deliverables must be delivered first.");return}if(_[s.id]){I(s);return}try{const{data:i}=await ke.from("deliverables").select("deliverable_ref, name, status, progress").eq("milestone_id",s.id).eq("status","Delivered"),j=`CERT-${s.milestone_ref}-${Date.now().toString(36).toUpperCase()}`;await y.createCertificate({project_id:o,milestone_id:s.id,certificate_number:j,milestone_ref:s.milestone_ref,milestone_name:s.name,payment_milestone_value:s.budget||0,status:"Draft",deliverables_snapshot:i||[],generated_by:h}),await R(),I(s),r("Certificate generated successfully!")}catch(i){l("Failed to generate certificate: "+i.message)}}function I(s){const d=_[s.id];$({...d,milestone:s,deliverables:C[s.id]||[]}),G(!0)}async function he(s){if(!b)return;const d=s==="supplier",g=s==="customer";if(d&&!["admin","supplier_pm"].includes(n)){p("Only Admin or Supplier PM can sign as supplier.");return}if(g&&n!=="customer_pm"){p("Only Customer PM can sign as customer.");return}try{const i={};let j=b.status;d&&(i.supplier_pm_id=h,i.supplier_pm_name=a,i.supplier_pm_signed_at=new Date().toISOString(),j=b.customer_pm_signed_at?"Signed":"Pending Customer Signature"),g&&(i.customer_pm_id=h,i.customer_pm_name=a,i.customer_pm_signed_at=new Date().toISOString(),j=b.supplier_pm_signed_at?"Signed":"Pending Supplier Signature"),i.status=j,await y.updateCertificate(b.id,i),await R(),$({...b,...i}),r("Certificate signed successfully!")}catch(i){l("Failed to sign certificate: "+i.message)}}const T=k;if(re)return e.jsx(Me,{message:"Loading milestones...",size:"large",fullPage:!0});const xe=x.reduce((s,d)=>s+(d.budget||0),0),E=x.map(s=>({...s,computedStatus:oe(C[s.id]),computedProgress:de(C[s.id])})),be=x.length>0?Math.round(E.reduce((s,d)=>s+d.computedProgress,0)/x.length):0,V=E.filter(s=>s.computedStatus==="Completed").length,je=Object.values(_).filter(s=>s.status==="Signed").length,ye=Object.values(_).filter(s=>s.status==="Pending Customer Signature"||s.status==="Pending Supplier Signature").length,_e=V-Object.keys(_).length;return e.jsxs("div",{className:"page-container",children:[e.jsxs(Ne,{icon:X,title:"Milestones",subtitle:"Track project milestones and deliverables",children:[e.jsxs("button",{className:"btn btn-secondary",onClick:()=>M(),children:[e.jsx(Re,{size:18})," Refresh"]}),T&&!O&&e.jsxs("button",{className:"btn btn-primary",onClick:()=>A(!0),children:[e.jsx(K,{size:18})," Add Milestone"]})]}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem"},children:[e.jsx(N,{icon:X,label:"Total Milestones",value:x.length,color:"#3b82f6"}),e.jsx(N,{icon:J,label:"Completed",value:V,color:"#10b981"}),e.jsx(N,{label:"Average Progress",value:`${be}%`,color:"#3b82f6"}),e.jsx(N,{label:"Total Billable",value:`Â£${xe.toLocaleString()}`,subtext:"on completion",color:"#10b981"})]}),e.jsx("div",{style:{display:"flex",gap:"0.5rem",marginBottom:"1.5rem"},children:e.jsx(Z,{to:"/gantt",className:"btn btn-secondary",style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:"ðŸ“Š View Gantt Chart"})}),e.jsx(Ue,{signedCount:je,pendingCount:ye,awaitingCount:_e}),O&&T&&e.jsx(Ee,{form:u,onFormChange:H,onSubmit:ce,onCancel:()=>A(!1)}),e.jsx($e,{milestones:E,milestoneDeliverables:C,certificates:_,canEdit:T,onEdit:ge,onDelete:ue,onGenerateCertificate:fe,onViewCertificate:I}),le&&e.jsx(Le,{form:m,onFormChange:U,onSave:pe,onClose:()=>P(!1)}),ie&&b&&e.jsx(Te,{certificate:b,onClose:()=>G(!1),onSign:he,canSignSupplier:z,canSignCustomer:S}),e.jsx(Ve,{}),e.jsx(ze,{isOpen:w.isOpen,onClose:()=>D({isOpen:!1,milestone:null}),onConfirm:me,title:"Delete Milestone?",message:w.milestone?`This will permanently delete "${w.milestone.milestone_ref}: ${w.milestone.name}" and all associated deliverables. This action cannot be undone.`:"",confirmText:"Delete Milestone",cancelText:"Cancel",type:"danger",isLoading:ae})]})}export{tt as default};
