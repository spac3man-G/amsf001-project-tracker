import{u as Ce,a as we,b as ke,m as p,d as ze,j as e,L as Be,P as Ne,S as z,s as Me}from"./index-BAeOFH35.js";import{r as o,L as q}from"./vendor-react-CaXNtsgv.js";import{u as Ae}from"./usePermissions-SdW04b9_.js";import{C as Pe}from"./ConfirmDialog-CLo-gYP-.js";import{o as V,R as De,O as Q,C as X,f as I,D as Re,Q as J,T as We,a as Ie,y as Te,V as B}from"./vendor-icons-BB9jpMgd.js";import"./vendor-supabase-qY1sfceY.js";import"./vendor-charts-_mIYJ_kN.js";function Ue(){const{user:T,role:E,profile:K}=Ce(),{projectId:g}=we(),{showSuccess:j,showError:f,showWarning:_}=ke(),C=T?.id||null,L=K?.full_name||T?.email||"Unknown",{canEditMilestone:Y,canSignAsSupplier:Z,canSignAsCustomer:ee}=Ae(),[h,te]=o.useState([]),[y,re]=o.useState({}),[x,se]=o.useState({}),[ie,ae]=o.useState(!0),[F,N]=o.useState(!1),[ne,M]=o.useState(!1),[le,O]=o.useState(!1),[a,G]=o.useState(null),[v,A]=o.useState({isOpen:!1,milestone:null}),[de,$]=o.useState(!1),[r,c]=o.useState({milestone_ref:"",name:"",description:"",baseline_start_date:"",baseline_end_date:"",actual_start_date:"",forecast_end_date:"",start_date:"",end_date:"",budget:""}),[i,m]=o.useState({id:"",milestone_ref:"",name:"",description:"",baseline_start_date:"",baseline_end_date:"",actual_start_date:"",forecast_end_date:"",start_date:"",end_date:"",budget:""});o.useEffect(()=>{g&&(S(g),P(g))},[g]);function oe(t){if(!t||t.length===0)return"Not Started";const n=t.every(s=>s.status==="Not Started"||!s.status);return t.every(s=>s.status==="Delivered")?"Completed":n?"Not Started":"In Progress"}function ce(t){if(!t||t.length===0)return 0;const n=t.reduce((l,s)=>l+(s.progress||0),0);return Math.round(n/t.length)}async function P(t){const n=t||g;try{const l=await p.getCertificates(n),s={};l.forEach(d=>{s[d.milestone_id]=d}),se(s)}catch{}}async function S(t){const n=t||g;try{const l=await p.getAll(n,{orderBy:{column:"milestone_ref",ascending:!0}});if(te(l||[]),l&&l.length>0){const s=l.map(u=>u.id),d=await ze.getAll(n,{filters:[{column:"milestone_id",operator:"in",value:s}],select:"id, milestone_id, status, progress"});if(d){const u={};d.forEach(k=>{u[k.milestone_id]||(u[k.milestone_id]=[]),u[k.milestone_id].push(k)}),re(u)}}}catch{f("Failed to load milestones")}finally{ae(!1)}}async function me(){if(!r.milestone_ref||!r.name){_("Please fill in at least Milestone Reference and Name");return}try{await p.create({project_id:g,milestone_ref:r.milestone_ref,name:r.name,description:r.description,start_date:r.start_date||r.baseline_start_date||null,end_date:r.end_date||r.baseline_end_date||null,baseline_start_date:r.baseline_start_date||r.start_date||null,baseline_end_date:r.baseline_end_date||r.end_date||null,actual_start_date:r.actual_start_date||r.start_date||null,forecast_end_date:r.forecast_end_date||r.end_date||null,budget:parseFloat(r.budget)||0,progress:0,status:"Not Started",created_by:C}),await S(),N(!1),c({milestone_ref:"",name:"",description:"",baseline_start_date:"",baseline_end_date:"",actual_start_date:"",forecast_end_date:"",start_date:"",end_date:"",budget:""}),j("Milestone added successfully!")}catch(t){f("Failed to add milestone: "+t.message)}}function ue(t){A({isOpen:!0,milestone:t})}async function ge(){const t=v.milestone;if(t){$(!0);try{await p.delete(t.id),await S(),A({isOpen:!1,milestone:null}),j("Milestone deleted successfully!")}catch(n){f("Failed to delete milestone: "+n.message)}finally{$(!1)}}}function pe(t){m({id:t.id,milestone_ref:t.milestone_ref||"",name:t.name||"",description:t.description||"",baseline_start_date:t.baseline_start_date||t.start_date||"",baseline_end_date:t.baseline_end_date||t.end_date||"",actual_start_date:t.actual_start_date||t.start_date||"",forecast_end_date:t.forecast_end_date||t.end_date||"",start_date:t.start_date||"",end_date:t.end_date||"",budget:t.budget||""}),M(!0)}async function fe(){if(!i.milestone_ref||!i.name){_("Please fill in at least Milestone Reference and Name");return}try{await p.update(i.id,{milestone_ref:i.milestone_ref,name:i.name,description:i.description,start_date:i.start_date||i.baseline_start_date||null,end_date:i.end_date||i.baseline_end_date||null,baseline_start_date:i.baseline_start_date||null,baseline_end_date:i.baseline_end_date||null,actual_start_date:i.actual_start_date||null,forecast_end_date:i.forecast_end_date||null,budget:parseFloat(i.budget)||0}),await S(),M(!1),j("Milestone updated successfully!")}catch(t){f("Failed to update milestone: "+t.message)}}function he(t){switch(t){case"Completed":return{bg:"#dcfce7",color:"#16a34a"};case"In Progress":return{bg:"#dbeafe",color:"#2563eb"};default:return{bg:"#f1f5f9",color:"#64748b"}}}function w(t){switch(t){case"Signed":return{bg:"#dcfce7",color:"#16a34a"};case"Pending Supplier Signature":return{bg:"#fef3c7",color:"#d97706"};case"Pending Customer Signature":return{bg:"#dbeafe",color:"#2563eb"};case"Draft":return{bg:"#f1f5f9",color:"#64748b"};default:return{bg:"#f1f5f9",color:"#64748b"}}}async function xe(t){const n=y[t.id]||[];if(!(n.length>0&&n.every(s=>s.status==="Delivered"))){_("Cannot generate certificate: All deliverables must be delivered first.");return}if(x[t.id]){D(t);return}try{const{data:s}=await Me.from("deliverables").select("deliverable_ref, name, status, progress").eq("milestone_id",t.id).eq("status","Delivered"),d=`CERT-${t.milestone_ref}-${Date.now().toString(36).toUpperCase()}`,u=await p.createCertificate({project_id:g,milestone_id:t.id,certificate_number:d,milestone_ref:t.milestone_ref,milestone_name:t.name,payment_milestone_value:t.budget||0,status:"Draft",deliverables_snapshot:s||[],generated_by:C});await P(),D(t),j("Certificate generated successfully!")}catch(s){f("Failed to generate certificate: "+s.message)}}function D(t){const n=x[t.id];G({...n,milestone:t,deliverables:y[t.id]||[]}),O(!0)}async function H(t){if(!a)return;const n=t==="supplier",l=t==="customer";if(n&&!["admin","supplier_pm"].includes(E)){_("Only Admin or Supplier PM can sign as supplier.");return}if(l&&E!=="customer_pm"){_("Only Customer PM can sign as customer.");return}try{const s={};let d=a.status;n&&(s.supplier_pm_id=C,s.supplier_pm_name=L,s.supplier_pm_signed_at=new Date().toISOString(),a.customer_pm_signed_at?d="Signed":d="Pending Customer Signature"),l&&(s.customer_pm_id=C,s.customer_pm_name=L,s.customer_pm_signed_at=new Date().toISOString(),a.supplier_pm_signed_at?d="Signed":d="Pending Supplier Signature"),s.status=d,await p.updateCertificate(a.id,s),await P();const u={...a,...s};G(u),j("Certificate signed successfully!")}catch(s){f("Failed to sign certificate: "+s.message)}}const b=Y,be=Z,je=ee;if(ie)return e.jsx(Be,{message:"Loading milestones...",size:"large",fullPage:!0});const _e=h.reduce((t,n)=>t+(n.budget||0),0),R=h.map(t=>({...t,computedStatus:oe(y[t.id]),computedProgress:ce(y[t.id])})),ye=h.length>0?Math.round(R.reduce((t,n)=>t+n.computedProgress,0)/h.length):0,U=R.filter(t=>t.computedStatus==="Completed").length,ve=Object.values(x).filter(t=>t.status==="Signed").length,Se=Object.values(x).filter(t=>t.status==="Pending Customer Signature"||t.status==="Pending Supplier Signature").length,W=U-Object.keys(x).length;return e.jsxs("div",{className:"page-container",children:[e.jsxs(Ne,{icon:V,title:"Milestones",subtitle:"Track project milestones and deliverables",children:[e.jsxs("button",{className:"btn btn-secondary",onClick:()=>S(),children:[e.jsx(De,{size:18})," Refresh"]}),b&&!F&&e.jsxs("button",{className:"btn btn-primary",onClick:()=>N(!0),children:[e.jsx(Q,{size:18})," Add Milestone"]})]}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem"},children:[e.jsx(z,{icon:V,label:"Total Milestones",value:h.length,color:"#3b82f6"}),e.jsx(z,{icon:X,label:"Completed",value:U,color:"#10b981"}),e.jsx(z,{label:"Average Progress",value:`${ye}%`,color:"#3b82f6"}),e.jsx(z,{label:"Total Billable",value:`Â£${_e.toLocaleString()}`,subtext:"on completion",color:"#10b981"})]}),e.jsx("div",{style:{display:"flex",gap:"0.5rem",marginBottom:"1.5rem"},children:e.jsx(q,{to:"/gantt",className:"btn btn-secondary",style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:"ðŸ“Š View Gantt Chart"})}),e.jsx("div",{className:"card",style:{marginBottom:"1.5rem",backgroundColor:"#fefce8",borderLeft:"4px solid #eab308"},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"1rem",flexWrap:"wrap"},children:[e.jsx(I,{size:24,style:{color:"#ca8a04"}}),e.jsx("h4",{style:{margin:0,color:"#854d0e"},children:"Milestone Acceptance Certificates"}),e.jsxs("div",{style:{display:"flex",gap:"1.5rem",marginLeft:"auto"},children:[e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{fontSize:"1.5rem",fontWeight:"700",color:"#16a34a"},children:ve}),e.jsx("div",{style:{fontSize:"0.8rem",color:"#166534"},children:"Signed"})]}),e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{fontSize:"1.5rem",fontWeight:"700",color:"#d97706"},children:Se}),e.jsx("div",{style:{fontSize:"0.8rem",color:"#92400e"},children:"Pending"})]}),e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{fontSize:"1.5rem",fontWeight:"700",color:W>0?"#dc2626":"#64748b"},children:W>0?W:0}),e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b"},children:"Awaiting Generation"})]})]})]})}),F&&b&&e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem",border:"2px solid #10b981"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Add New Milestone"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 2fr",gap:"1rem",marginBottom:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Milestone Reference *"}),e.jsx("input",{type:"text",className:"form-input",placeholder:"M01",value:r.milestone_ref,onChange:t=>c({...r,milestone_ref:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Name *"}),e.jsx("input",{type:"text",className:"form-input",placeholder:"Milestone name",value:r.name,onChange:t=>c({...r,name:t.target.value})})]})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{className:"form-label",children:"Description"}),e.jsx("textarea",{className:"form-input",rows:2,placeholder:"Description",value:r.description,onChange:t=>c({...r,description:t.target.value})})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("h4",{style:{margin:"0 0 0.5rem 0",fontSize:"0.9rem",color:"#64748b"},children:"Baseline Schedule (Original Plan)"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Baseline Start Date"}),e.jsx("input",{type:"date",className:"form-input",value:r.baseline_start_date||r.start_date,onChange:t=>c({...r,baseline_start_date:t.target.value,start_date:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Baseline End Date"}),e.jsx("input",{type:"date",className:"form-input",value:r.baseline_end_date||r.end_date,onChange:t=>c({...r,baseline_end_date:t.target.value,end_date:t.target.value})})]})]})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("h4",{style:{margin:"0 0 0.5rem 0",fontSize:"0.9rem",color:"#64748b"},children:"Current Schedule"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Actual Start Date"}),e.jsx("input",{type:"date",className:"form-input",value:r.actual_start_date||r.start_date,onChange:t=>c({...r,actual_start_date:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Forecast End Date"}),e.jsx("input",{type:"date",className:"form-input",value:r.forecast_end_date||r.end_date,onChange:t=>c({...r,forecast_end_date:t.target.value})})]})]})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{className:"form-label",children:"Billable Amount (Â£)"}),e.jsx("input",{type:"number",className:"form-input",placeholder:"0",style:{maxWidth:"200px"},value:r.budget,onChange:t=>c({...r,budget:t.target.value})}),e.jsx("p",{style:{fontSize:"0.8rem",color:"#64748b",margin:"0.25rem 0 0 0"},children:"The amount that can be invoiced when this milestone is completed (not a budget for doing the work)"})]}),e.jsxs("div",{style:{padding:"0.75rem",backgroundColor:"#eff6ff",borderRadius:"6px",marginBottom:"1rem",fontSize:"0.9rem",color:"#1e40af"},children:[e.jsx("strong",{children:"Note:"})," Milestone status and progress will be automatically calculated from associated deliverables."]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsxs("button",{className:"btn btn-primary",onClick:me,children:[e.jsx(Q,{size:16})," Add Milestone"]}),e.jsx("button",{className:"btn btn-secondary",onClick:()=>N(!1),children:"Cancel"})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Project Milestones"}),e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Ref"}),e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Progress"}),e.jsx("th",{children:"Actual Start"}),e.jsx("th",{children:"Forecast End"}),e.jsx("th",{title:"Amount invoiced on completion",children:"Billable"}),e.jsx("th",{children:"Certificate"}),b&&e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:h.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:b?9:8,style:{textAlign:"center",padding:"2rem",color:"#64748b"},children:'No milestones found. Click "Add Milestone" to create one.'})}):R.map(t=>{const n=he(t.computedStatus),l=x[t.id],s=y[t.id]?.length||0;return e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx(q,{to:`/milestones/${t.id}`,style:{fontFamily:"monospace",fontWeight:"600",color:"#3b82f6",textDecoration:"none"},onMouseEnter:d=>d.target.style.textDecoration="underline",onMouseLeave:d=>d.target.style.textDecoration="none",children:t.milestone_ref})}),e.jsx("td",{style:{fontWeight:"500"},children:t.name}),e.jsxs("td",{children:[e.jsx("span",{style:{padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.85rem",backgroundColor:n.bg,color:n.color,fontWeight:"500"},children:t.computedStatus}),s>0&&e.jsxs("span",{style:{marginLeft:"0.5rem",fontSize:"0.75rem",color:"#64748b"},children:["(",s," deliverable",s!==1?"s":"",")"]})]}),e.jsx("td",{children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("div",{style:{width:"80px",height:"8px",backgroundColor:"#e2e8f0",borderRadius:"4px",overflow:"hidden"},children:e.jsx("div",{style:{width:`${t.computedProgress}%`,height:"100%",backgroundColor:t.computedStatus==="Completed"?"#10b981":"#3b82f6",transition:"width 0.3s"}})}),e.jsxs("span",{style:{fontSize:"0.85rem",fontWeight:"600",minWidth:"40px"},children:[t.computedProgress,"%"]}),e.jsx("span",{style:{fontSize:"0.75rem",color:"#64748b",fontStyle:"italic"},children:"(auto)"})]})}),e.jsx("td",{children:t.actual_start_date||t.start_date?new Date(t.actual_start_date||t.start_date).toLocaleDateString("en-GB"):"-"}),e.jsx("td",{children:t.forecast_end_date||t.end_date?new Date(t.forecast_end_date||t.end_date).toLocaleDateString("en-GB"):"-"}),e.jsxs("td",{title:"Invoiced on completion",children:["Â£",(t.budget||0).toLocaleString()]}),e.jsx("td",{children:t.computedStatus==="Completed"?l?e.jsxs("button",{onClick:()=>D(t),style:{display:"flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",backgroundColor:w(l.status).bg,color:w(l.status).color,border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"0.8rem",fontWeight:"500"},children:[e.jsx(Re,{size:14}),l.status==="Signed"?"Signed":l.status==="Pending Customer Signature"?"Awaiting Customer":l.status==="Pending Supplier Signature"?"Awaiting Supplier":"View"]}):b&&e.jsxs("button",{onClick:()=>xe(t),style:{display:"flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",backgroundColor:"#fef3c7",color:"#d97706",border:"none",borderRadius:"4px",cursor:"pointer",fontSize:"0.8rem",fontWeight:"500"},children:[e.jsx(I,{size:14}),"Generate"]}):e.jsx("span",{style:{fontSize:"0.8rem",color:"#94a3b8",fontStyle:"italic"},children:"Not ready"})}),b&&e.jsx("td",{children:e.jsxs("div",{style:{display:"flex",gap:"0.25rem"},children:[e.jsx("button",{onClick:()=>pe(t),style:{padding:"0.5rem",backgroundColor:"#eff6ff",color:"#3b82f6",border:"none",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center"},title:"Edit",children:e.jsx(J,{size:16})}),e.jsx("button",{onClick:()=>ue(t),style:{padding:"0.5rem",backgroundColor:"#fef2f2",color:"#ef4444",border:"none",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center"},title:"Delete",children:e.jsx(We,{size:16})})]})})]},t.id)})})]})]}),ne&&e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:e.jsxs("div",{style:{backgroundColor:"white",padding:"1.5rem",borderRadius:"12px",maxWidth:"600px",width:"90%",maxHeight:"90vh",overflow:"auto"},children:[e.jsxs("h3",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginTop:0},children:[e.jsx(J,{size:20}),"Edit Milestone - ",i.milestone_ref]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 2fr",gap:"1rem",marginBottom:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Reference *"}),e.jsx("input",{type:"text",value:i.milestone_ref,onChange:t=>m({...i,milestone_ref:t.target.value}),style:{width:"100%",padding:"0.5rem",border:"1px solid #e2e8f0",borderRadius:"6px"}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Name *"}),e.jsx("input",{type:"text",value:i.name,onChange:t=>m({...i,name:t.target.value}),style:{width:"100%",padding:"0.5rem",border:"1px solid #e2e8f0",borderRadius:"6px"}})]})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Description"}),e.jsx("textarea",{value:i.description,onChange:t=>m({...i,description:t.target.value}),rows:3,style:{width:"100%",padding:"0.5rem",border:"1px solid #e2e8f0",borderRadius:"6px"}})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("h4",{style:{margin:"0 0 0.5rem 0",fontSize:"0.85rem",color:"#64748b"},children:"Baseline Schedule (Original Plan)"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Baseline Start"}),e.jsx("input",{type:"date",value:i.baseline_start_date,onChange:t=>m({...i,baseline_start_date:t.target.value}),style:{width:"100%",padding:"0.5rem",border:"1px solid #e2e8f0",borderRadius:"6px"}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Baseline End"}),e.jsx("input",{type:"date",value:i.baseline_end_date,onChange:t=>m({...i,baseline_end_date:t.target.value}),style:{width:"100%",padding:"0.5rem",border:"1px solid #e2e8f0",borderRadius:"6px"}})]})]})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("h4",{style:{margin:"0 0 0.5rem 0",fontSize:"0.85rem",color:"#64748b"},children:"Current Schedule"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Actual Start"}),e.jsx("input",{type:"date",value:i.actual_start_date,onChange:t=>m({...i,actual_start_date:t.target.value}),style:{width:"100%",padding:"0.5rem",border:"1px solid #e2e8f0",borderRadius:"6px"}})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Forecast End"}),e.jsx("input",{type:"date",value:i.forecast_end_date,onChange:t=>m({...i,forecast_end_date:t.target.value}),style:{width:"100%",padding:"0.5rem",border:"1px solid #e2e8f0",borderRadius:"6px"}})]})]})]}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{style:{display:"block",fontWeight:"500",marginBottom:"0.25rem"},children:"Billable Amount (Â£)"}),e.jsx("input",{type:"number",value:i.budget,onChange:t=>m({...i,budget:t.target.value}),style:{width:"200px",padding:"0.5rem",border:"1px solid #e2e8f0",borderRadius:"6px"}}),e.jsx("p",{style:{fontSize:"0.8rem",color:"#64748b",margin:"0.25rem 0 0 0"},children:"Amount invoiced when milestone is completed (not a budget for doing the work)"})]}),e.jsxs("div",{style:{padding:"0.75rem",backgroundColor:"#eff6ff",borderRadius:"6px",marginBottom:"1rem",fontSize:"0.9rem",color:"#1e40af"},children:[e.jsx("strong",{children:"ðŸ’¡ Note:"})," Status and progress are ",e.jsx("strong",{children:"automatically calculated"})," from associated deliverables and cannot be manually edited.",e.jsxs("ul",{style:{margin:"0.5rem 0 0 1rem",paddingLeft:"0.5rem"},children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Not Started"})," â€” No deliverables have begun"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"In Progress"})," â€” At least one deliverable is in progress"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Completed"})," â€” All deliverables are delivered"]})]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:"0.5rem"},children:[e.jsxs("button",{onClick:()=>M(!1),style:{padding:"0.5rem 1rem",backgroundColor:"#f1f5f9",color:"#64748b",border:"none",borderRadius:"6px",cursor:"pointer",display:"flex",alignItems:"center",gap:"0.25rem"},children:[e.jsx(Ie,{size:16})," Cancel"]}),e.jsxs("button",{onClick:fe,style:{padding:"0.5rem 1rem",backgroundColor:"#10b981",color:"white",border:"none",borderRadius:"6px",cursor:"pointer",display:"flex",alignItems:"center",gap:"0.25rem"},children:[e.jsx(Te,{size:16})," Save Changes"]})]})]})}),le&&a&&e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:e.jsxs("div",{style:{backgroundColor:"white",padding:"2rem",borderRadius:"12px",maxWidth:"700px",width:"90%",maxHeight:"90vh",overflow:"auto"},children:[e.jsxs("div",{style:{textAlign:"center",borderBottom:"2px solid #10b981",paddingBottom:"1rem",marginBottom:"1.5rem"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",gap:"0.5rem",marginBottom:"0.5rem"},children:[e.jsx(I,{size:32,style:{color:"#10b981"}}),e.jsx("h2",{style:{margin:0,color:"#166534"},children:"Milestone Acceptance Certificate"})]}),e.jsxs("div",{style:{fontSize:"0.9rem",color:"#64748b"},children:["Certificate No: ",e.jsx("strong",{children:a.certificate_number})]}),e.jsx("div",{style:{display:"inline-block",marginTop:"0.5rem",padding:"0.25rem 0.75rem",borderRadius:"999px",fontSize:"0.85rem",fontWeight:"600",backgroundColor:w(a.status).bg,color:w(a.status).color},children:a.status})]}),e.jsxs("div",{style:{marginBottom:"1.5rem"},children:[e.jsx("h4",{style:{margin:"0 0 0.75rem 0",color:"#1e293b"},children:"Milestone Details"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"0.75rem",backgroundColor:"#f8fafc",padding:"1rem",borderRadius:"8px"},children:[e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b"},children:"Reference"}),e.jsx("div",{style:{fontWeight:"600"},children:a.milestone_ref})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b"},children:"Name"}),e.jsx("div",{style:{fontWeight:"600"},children:a.milestone_name})]}),e.jsxs("div",{style:{gridColumn:"1 / -1"},children:[e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b"},children:"Payment Milestone Associated"}),e.jsxs("div",{style:{fontWeight:"700",fontSize:"1.25rem",color:"#10b981"},children:["Â£",(a.payment_milestone_value||0).toLocaleString()]})]})]})]}),e.jsxs("div",{style:{marginBottom:"1.5rem"},children:[e.jsx("h4",{style:{margin:"0 0 0.75rem 0",color:"#1e293b"},children:"Deliverables Accepted"}),e.jsx("div",{style:{border:"1px solid #e2e8f0",borderRadius:"8px",overflow:"hidden"},children:e.jsxs("table",{style:{width:"100%",fontSize:"0.9rem"},children:[e.jsx("thead",{children:e.jsxs("tr",{style:{backgroundColor:"#f1f5f9"},children:[e.jsx("th",{style:{padding:"0.5rem",textAlign:"left"},children:"Ref"}),e.jsx("th",{style:{padding:"0.5rem",textAlign:"left"},children:"Name"}),e.jsx("th",{style:{padding:"0.5rem",textAlign:"center"},children:"Status"})]})}),e.jsx("tbody",{children:(a.deliverables_snapshot||[]).map((t,n)=>e.jsxs("tr",{style:{borderTop:"1px solid #e2e8f0"},children:[e.jsx("td",{style:{padding:"0.5rem",fontFamily:"monospace",fontWeight:"600"},children:t.deliverable_ref}),e.jsx("td",{style:{padding:"0.5rem"},children:t.name}),e.jsx("td",{style:{padding:"0.5rem",textAlign:"center"},children:e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",color:"#16a34a"},children:[e.jsx(X,{size:14})," Accepted"]})})]},n))})]})})]}),e.jsxs("div",{style:{marginBottom:"1.5rem"},children:[e.jsx("h4",{style:{margin:"0 0 0.75rem 0",color:"#1e293b"},children:"Signatures"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsxs("div",{style:{padding:"1rem",border:"2px solid",borderColor:a.supplier_pm_signed_at?"#10b981":"#e2e8f0",borderRadius:"8px",backgroundColor:a.supplier_pm_signed_at?"#f0fdf4":"#f8fafc"},children:[e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b",marginBottom:"0.5rem"},children:"Supplier PM"}),a.supplier_pm_signed_at?e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",fontWeight:"600",color:"#166534"},children:[e.jsx(B,{size:16}),a.supplier_pm_name]}),e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b",marginTop:"0.25rem"},children:new Date(a.supplier_pm_signed_at).toLocaleString("en-GB")})]}):be&&a.status!=="Signed"?e.jsxs("button",{onClick:()=>H("supplier"),style:{width:"100%",padding:"0.5rem",backgroundColor:"#10b981",color:"white",border:"none",borderRadius:"6px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"0.5rem",fontWeight:"500"},children:[e.jsx(B,{size:16})," Sign as Supplier PM"]}):e.jsx("div",{style:{color:"#94a3b8",fontStyle:"italic"},children:"Awaiting signature"})]}),e.jsxs("div",{style:{padding:"1rem",border:"2px solid",borderColor:a.customer_pm_signed_at?"#10b981":"#e2e8f0",borderRadius:"8px",backgroundColor:a.customer_pm_signed_at?"#f0fdf4":"#f8fafc"},children:[e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b",marginBottom:"0.5rem"},children:"Customer PM"}),a.customer_pm_signed_at?e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",fontWeight:"600",color:"#166534"},children:[e.jsx(B,{size:16}),a.customer_pm_name]}),e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b",marginTop:"0.25rem"},children:new Date(a.customer_pm_signed_at).toLocaleString("en-GB")})]}):je&&a.status!=="Signed"?e.jsxs("button",{onClick:()=>H("customer"),style:{width:"100%",padding:"0.5rem",backgroundColor:"#3b82f6",color:"white",border:"none",borderRadius:"6px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",gap:"0.5rem",fontWeight:"500"},children:[e.jsx(B,{size:16})," Sign as Customer PM"]}):e.jsx("div",{style:{color:"#94a3b8",fontStyle:"italic"},children:"Awaiting signature"})]})]})]}),e.jsxs("div",{style:{fontSize:"0.8rem",color:"#64748b",textAlign:"center",marginBottom:"1rem"},children:["Generated: ",new Date(a.generated_at).toLocaleString("en-GB")]}),e.jsx("div",{style:{display:"flex",justifyContent:"center"},children:e.jsx("button",{onClick:()=>O(!1),style:{padding:"0.75rem 2rem",backgroundColor:"#f1f5f9",color:"#64748b",border:"none",borderRadius:"6px",cursor:"pointer",fontWeight:"500"},children:"Close"})})]})}),e.jsxs("div",{className:"card",style:{marginTop:"1.5rem",backgroundColor:"#eff6ff",borderLeft:"4px solid #3b82f6"},children:[e.jsx("h4",{style:{marginBottom:"0.5rem",color:"#1e40af"},children:"ðŸ’¡ How Milestone Status & Progress Work"}),e.jsxs("ul",{style:{margin:"0.5rem 0 0 1.5rem",color:"#1e40af",fontSize:"0.9rem"},children:[e.jsxs("li",{children:["Milestone ",e.jsx("strong",{children:"status"})," and ",e.jsx("strong",{children:"progress"})," are automatically calculated from deliverables"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Not Started:"}),' All deliverables are "Not Started" (or no deliverables exist)']}),e.jsxs("li",{children:[e.jsx("strong",{children:"In Progress:"})," At least one deliverable has begun work"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Completed:"})," All deliverables have been delivered"]}),e.jsx("li",{children:"Click milestone reference to view and manage deliverables"}),e.jsx("li",{children:"Progress = average of all deliverable progress percentages"}),e.jsx("li",{children:"Timesheets continue to be logged against milestones (not individual deliverables)"}),e.jsx("li",{children:"Payment aligned to milestone completion per SOW requirements"})]})]}),e.jsx(Pe,{isOpen:v.isOpen,onClose:()=>A({isOpen:!1,milestone:null}),onConfirm:ge,title:"Delete Milestone?",message:v.milestone?`This will permanently delete "${v.milestone.milestone_ref}: ${v.milestone.name}" and all associated deliverables. This action cannot be undone.`:"",confirmText:"Delete Milestone",cancelText:"Cancel",type:"danger",isLoading:de})]})}export{Ue as default};
