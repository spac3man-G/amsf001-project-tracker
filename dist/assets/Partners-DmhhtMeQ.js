import{u as Q,a as V,b as X,p as o,j as e,P as Z,S as j,s as y}from"./index-B5r_rj8e.js";import{u as ee,r}from"./vendor-react-JFEV0ROX.js";import{u as te}from"./usePermissions-D0smDYjW.js";import{C as se}from"./ConfirmDialog-CubZijV7.js";import{H as F,k as v,a6 as E,a7 as D,a2 as ae,U as ne,v as re,F as le,a8 as ie,T as ce}from"./vendor-icons-Bd7vp13O.js";import"./vendor-supabase-DgEUAXvv.js";function pe(){const R=ee(),{user:oe}=Q(),{projectId:d}=V(),{hasRole:q}=te(),{showSuccess:m,showError:i}=X(),[c,z]=r.useState([]),[I,N]=r.useState(!0),[L,u]=r.useState(!1),[x,w]=r.useState(null),[s,h]=r.useState({show:!1,partner:null,dependents:null}),[b,g]=r.useState(!1),[a,n]=r.useState({name:"",contact_name:"",contact_email:"",payment_terms:"Net 30",notes:"",is_active:!0}),f=q(["admin","supplier_pm"]);r.useEffect(()=>{d&&f&&p()},[d,f]);const p=async()=>{try{N(!0);const t=await o.getAll(d);z(t)}catch{i("Failed to load partners. Please try again.")}finally{N(!1)}},C=()=>{n({name:"",contact_name:"",contact_email:"",payment_terms:"Net 30",notes:"",is_active:!0}),w(null),u(!1)},$=t=>{n({name:t.name||"",contact_name:t.contact_name||"",contact_email:t.contact_email||"",payment_terms:t.payment_terms||"Net 30",notes:t.notes||"",is_active:t.is_active??!0}),w(t),u(!0)},M=async t=>{if(t.preventDefault(),!a.name.trim()){i("Partner name is required");return}try{g(!0),x?(await o.update(x.id,a),m("Partner updated successfully")):(await o.create({...a,project_id:d}),m("Partner added successfully")),await p(),C()}catch(l){i(l.message||"Failed to save partner. Please try again.")}finally{g(!1)}},U=async()=>{if(s.partner)try{g(!0),await o.delete(s.partner.id),await p(),h({show:!1,partner:null,dependents:null}),m("Partner deleted successfully")}catch{i("Failed to delete partner. Please try again.")}finally{g(!1)}},B=async t=>{try{const{data:l,error:_}=await y.from("resources").select("id").eq("partner_id",t.id);if(_)throw _;const P=l?.length||0;let k=0,S=0,A=0;if(P>0){const T=l.map(K=>K.id),{count:G}=await y.from("timesheets").select("*",{count:"exact",head:!0}).in("resource_id",T);k=G||0;const{count:J}=await y.from("expenses").select("*",{count:"exact",head:!0}).in("resource_id",T);S=J||0}const{count:W}=await y.from("partner_invoices").select("*",{count:"exact",head:!0}).eq("partner_id",t.id);A=W||0,h({show:!0,partner:t,dependents:{resourceCount:P,timesheetCount:k,expenseCount:S,invoiceCount:A}})}catch{h({show:!0,partner:t,dependents:null})}},H=async t=>{try{await o.toggleActive(t.id),await p(),m(`Partner ${t.is_active?"deactivated":"activated"}`)}catch{i("Failed to update partner status.")}};if(!f)return e.jsx("div",{className:"p-6",children:e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("p",{className:"text-red-800",children:"You don't have permission to access this page. Partners management is only available to Admin and Supplier PM roles."})})});if(I)return e.jsx(PageSkeleton,{statsCount:3,tableRows:5,tableColumns:5});const Y=c.filter(t=>t.is_active).length,O=c.filter(t=>!t.is_active).length;return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsx(Z,{title:"Partners",subtitle:"Manage third-party partner companies for resource allocation and invoicing",actions:e.jsxs("button",{onClick:()=>u(!0),className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[e.jsx(F,{className:"w-4 h-4"}),"Add Partner"]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(j,{icon:v,label:"Total Partners",value:c.length}),e.jsx(j,{icon:E,label:"Active Partners",value:Y,color:"green"}),e.jsx(j,{icon:D,label:"Inactive Partners",value:O,color:"gray"})]}),L&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsx("div",{className:"bg-white rounded-lg shadow-xl w-full max-w-lg mx-4",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:x?"Edit Partner":"Add New Partner"}),e.jsxs("form",{onSubmit:M,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Company Name *"}),e.jsx("input",{type:"text",value:a.name,onChange:t=>n({...a,name:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"e.g., Agilisys",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Contact Name"}),e.jsx("input",{type:"text",value:a.contact_name,onChange:t=>n({...a,contact_name:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Primary contact name"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Contact Email"}),e.jsx("input",{type:"email",value:a.contact_email,onChange:t=>n({...a,contact_email:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"contact@company.com"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Payment Terms"}),e.jsxs("select",{value:a.payment_terms,onChange:t=>n({...a,payment_terms:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"Net 15",children:"Net 15"}),e.jsx("option",{value:"Net 30",children:"Net 30"}),e.jsx("option",{value:"Net 45",children:"Net 45"}),e.jsx("option",{value:"Net 60",children:"Net 60"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx("textarea",{value:a.notes,onChange:t=>n({...a,notes:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",rows:3,placeholder:"Additional notes about this partner..."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",id:"is_active",checked:a.is_active,onChange:t=>n({...a,is_active:t.target.checked}),className:"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"}),e.jsx("label",{htmlFor:"is_active",className:"text-sm text-gray-700",children:"Partner is active"})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[e.jsx("button",{type:"button",onClick:C,className:"px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors",disabled:b,children:"Cancel"}),e.jsx("button",{type:"submit",className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50",disabled:b,children:b?"Saving...":x?"Update Partner":"Add Partner"})]})]})]})})}),c.length===0?e.jsxs("div",{className:"bg-white rounded-lg shadow p-8 text-center",children:[e.jsx(v,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No Partners Yet"}),e.jsx("p",{className:"text-gray-500 mb-4",children:"Add your first partner company to start tracking third-party resources and expenses."}),e.jsxs("button",{onClick:()=>u(!0),className:"inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[e.jsx(F,{className:"w-4 h-4"}),"Add Partner"]})]}):e.jsx("div",{className:"bg-white rounded-lg shadow overflow-hidden",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Partner"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Contact"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Payment Terms"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:c.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center gap-3 cursor-pointer",onClick:()=>R(`/partners/${t.id}`),title:"Click to view details",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center",children:e.jsx(v,{className:"w-5 h-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium text-gray-900 flex items-center gap-2",children:[e.jsx("span",{style:{color:"#2563eb"},children:t.name}),e.jsx(ae,{size:14,style:{color:"#9ca3af"}})]}),t.notes&&e.jsx("div",{className:"text-sm text-gray-500 truncate max-w-xs",title:t.notes,children:t.notes})]})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"space-y-1",children:[t.contact_name&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-900",children:[e.jsx(ne,{className:"w-4 h-4 text-gray-400"}),t.contact_name]}),t.contact_email&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-500",children:[e.jsx(re,{className:"w-4 h-4 text-gray-400"}),e.jsx("a",{href:`mailto:${t.contact_email}`,className:"hover:text-blue-600",children:t.contact_email})]}),!t.contact_name&&!t.contact_email&&e.jsx("span",{className:"text-sm text-gray-400",children:"No contact info"})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-900",children:[e.jsx(le,{className:"w-4 h-4 text-gray-400"}),t.payment_terms]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("button",{onClick:()=>H(t),className:`inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium transition-colors ${t.is_active?"bg-green-100 text-green-800 hover:bg-green-200":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,children:t.is_active?e.jsxs(e.Fragment,{children:[e.jsx(E,{className:"w-3 h-3"}),"Active"]}):e.jsxs(e.Fragment,{children:[e.jsx(D,{className:"w-3 h-3"}),"Inactive"]})})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{onClick:()=>$(t),className:"p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors",title:"Edit partner",children:e.jsx(ie,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>B(t),className:"p-2 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors",title:"Delete partner",children:e.jsx(ce,{className:"w-4 h-4"})})]})})]},t.id))})]})}),e.jsx(se,{isOpen:s.show,onClose:()=>h({show:!1,partner:null,dependents:null}),onConfirm:U,title:"Delete Partner",message:e.jsxs("div",{children:[e.jsxs("p",{children:['Are you sure you want to delete "',e.jsx("strong",{children:s.partner?.name}),'"?']}),s.dependents&&e.jsxs("div",{style:{marginTop:"1rem",padding:"0.75rem",backgroundColor:"#fef2f2",borderRadius:"6px",border:"1px solid #fecaca"},children:[e.jsx("p",{style:{fontWeight:"600",color:"#991b1b",marginBottom:"0.5rem"},children:"⚠️ This will also affect:"}),e.jsxs("ul",{style:{margin:"0",paddingLeft:"1.25rem",fontSize:"0.875rem",color:"#7f1d1d"},children:[s.dependents.resourceCount>0&&e.jsxs("li",{children:[s.dependents.resourceCount," linked resource",s.dependents.resourceCount!==1?"s":""," (will be unlinked)"]}),s.dependents.timesheetCount>0&&e.jsxs("li",{children:[s.dependents.timesheetCount," timesheet",s.dependents.timesheetCount!==1?"s":""]}),s.dependents.expenseCount>0&&e.jsxs("li",{children:[s.dependents.expenseCount," expense",s.dependents.expenseCount!==1?"s":""]}),s.dependents.invoiceCount>0&&e.jsxs("li",{children:[s.dependents.invoiceCount," invoice",s.dependents.invoiceCount!==1?"s":""]})]})]}),e.jsx("p",{style:{marginTop:"1rem",color:"#6b7280",fontSize:"0.875rem"},children:"This action cannot be undone."})]}),confirmText:"Delete",type:"danger"})]})}export{pe as default};
