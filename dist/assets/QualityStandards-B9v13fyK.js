import{u as ee,a as te,s as f,j as e,L as ae,P as se,S as y}from"./index-B5r_rj8e.js";import{r as o,L as w}from"./vendor-react-JFEV0ROX.js";import{u as re}from"./usePermissions-D0smDYjW.js";import{C as ne}from"./ConfirmDialog-CubZijV7.js";import{f as Q,H as le,C as T,A as k,h as D,N as I,a as z,J as ie,T as oe,I as de,m as ce,u as ue}from"./vendor-icons-Bd7vp13O.js";import"./vendor-supabase-DgEUAXvv.js";function be(){const{user:R,role:me}=ee(),{projectId:u}=te(),P=R?.id||null,{canManageQualityStandards:E}=re(),c=E,[m,L]=o.useState([]),[p,O]=o.useState({}),[F,he]=o.useState(!0),[C,b]=o.useState(!1),[W,v]=o.useState(null),[r,x]=o.useState({}),[g,S]=o.useState({isOpen:!1,qs:null}),[$,N]=o.useState(!1),[s,h]=o.useState({qs_ref:"",name:"",description:"",target:100,current_value:0});o.useEffect(()=>{u&&j(u)},[u]);async function j(t){const a=t||u;if(a)try{const{data:n,error:l}=await f.from("quality_standards").select("*").eq("project_id",a).order("qs_ref");if(l)throw l;L(n||[]);const d={};for(const i of n||[]){const{data:q}=await f.from("deliverable_qs_assessments").select("criteria_met").eq("quality_standard_id",i.id),Y=q?.filter(_=>_.criteria_met!==null).length||0,Z=q?.filter(_=>_.criteria_met===!0).length||0;d[i.id]={total:Y,met:Z}}O(d)}catch{}}async function B(t){if(t.preventDefault(),!s.qs_ref||!s.name){alert("Please fill in Reference and Name");return}try{const{error:a}=await f.from("quality_standards").insert({project_id:u,qs_ref:s.qs_ref,name:s.name,description:s.description,target:parseInt(s.target)||100,current_value:parseInt(s.current_value)||0,created_by:P});if(a)throw a;await j(),b(!1),h({qs_ref:"",name:"",description:"",target:100,current_value:0}),alert("Quality Standard added successfully!")}catch(a){alert("Failed to add: "+a.message)}}function H(t){v(t.id),x({qs_ref:t.qs_ref,name:t.name,description:t.description||"",target:t.target||100,current_value:t.current_value||0})}async function M(t){try{const{error:a}=await f.from("quality_standards").update({qs_ref:r.qs_ref,name:r.name,description:r.description,target:parseInt(r.target)||100,current_value:parseInt(r.current_value)||0}).eq("id",t);if(a)throw a;await j(),v(null),alert("Quality Standard updated!")}catch(a){alert("Failed to update: "+a.message)}}async function U(t){S({isOpen:!0,qs:t})}async function J(){const t=g.qs;if(t){N(!0);try{await f.from("deliverable_qs_assessments").delete().eq("quality_standard_id",t.id);const{error:a}=await f.from("quality_standards").delete().eq("id",t.id);if(a)throw a;await j(),S({isOpen:!1,qs:null})}catch(a){alert("Failed to delete: "+a.message)}finally{N(!1)}}}function A(t){const a=p[t.id]||{total:0,met:0};if(a.total===0)return{label:"Not Started",color:"#64748b",bg:"#f1f5f9",icon:D};const n=a.met/a.total*100,l=t.target||100;return n>=l?{label:"Achieved",color:"#16a34a",bg:"#dcfce7",icon:T}:n>=l*.8?{label:"On Track",color:"#2563eb",bg:"#dbeafe",icon:ce}:n>=l*.6?{label:"At Risk",color:"#ea580c",bg:"#ffedd5",icon:k}:{label:"Critical",color:"#dc2626",bg:"#fee2e2",icon:ue}}const V=m.length,X=m.filter(t=>{const a=p[t.id]||{total:0,met:0};return a.total===0?!1:a.met/a.total*100>=(t.target||100)}).length,G=m.filter(t=>{const a=A(t);return a.label==="At Risk"||a.label==="Critical"}).length,K=m.filter(t=>(p[t.id]||{total:0}).total===0).length;return F&&!u?e.jsx(ae,{message:"Loading quality standards...",size:"large",fullPage:!0}):e.jsxs("div",{className:"page-container",children:[e.jsx(se,{icon:Q,title:"Quality Standards",subtitle:"Track quality compliance across deliverables",children:c&&!C&&e.jsxs("button",{className:"btn btn-primary",onClick:()=>b(!0),children:[e.jsx(le,{size:18})," Add Quality Standard"]})}),e.jsxs("div",{className:"stats-grid",children:[e.jsx(y,{icon:Q,label:"Total Standards",value:V,color:"#3b82f6"}),e.jsx(y,{icon:T,label:"Achieved",value:X,color:"#16a34a"}),e.jsx(y,{icon:k,label:"At Risk",value:G,color:"#ea580c"}),e.jsx(y,{icon:D,label:"Not Started",value:K,color:"#64748b"})]}),C&&c&&e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem",border:"2px solid var(--primary)"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Add New Quality Standard"}),e.jsxs("form",{onSubmit:B,children:[e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 2fr",gap:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Reference *"}),e.jsx("input",{type:"text",className:"form-input",placeholder:"e.g., QS08",value:s.qs_ref,onChange:t=>h({...s,qs_ref:t.target.value}),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Name *"}),e.jsx("input",{type:"text",className:"form-input",placeholder:"e.g., Documentation Quality",value:s.name,onChange:t=>h({...s,name:t.target.value}),required:!0})]})]}),e.jsxs("div",{style:{marginTop:"1rem"},children:[e.jsx("label",{className:"form-label",children:"Description"}),e.jsx("textarea",{className:"form-input",rows:3,placeholder:"Describe what this quality standard measures...",value:s.description,onChange:t=>h({...s,description:t.target.value})})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem",marginTop:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Target (%)"}),e.jsx("input",{type:"number",className:"form-input",min:"0",max:"100",value:s.target,onChange:t=>h({...s,target:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Current Value (%)"}),e.jsx("input",{type:"number",className:"form-input",min:"0",max:"100",value:s.current_value,onChange:t=>h({...s,current_value:t.target.value})})]})]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem",marginTop:"1rem"},children:[e.jsxs("button",{type:"submit",className:"btn btn-primary",children:[e.jsx(I,{size:16})," Save Quality Standard"]}),e.jsxs("button",{type:"button",className:"btn btn-secondary",onClick:()=>b(!1),children:[e.jsx(z,{size:16})," Cancel"]})]})]})]}),e.jsx("div",{className:"card",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Ref"}),e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Target"}),e.jsx("th",{children:"Current"}),e.jsx("th",{children:"Assessments"}),e.jsx("th",{children:"Status"}),c&&e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:m.length===0?e.jsx("tr",{children:e.jsxs("td",{colSpan:c?7:6,style:{textAlign:"center",padding:"2rem",color:"#64748b"},children:["No quality standards found. ",c&&'Click "Add Quality Standard" to create one.']})}):m.map(t=>{const a=A(t),n=a.icon,l=p[t.id]||{total:0,met:0},d=W===t.id;return e.jsxs("tr",{children:[e.jsx("td",{children:d?e.jsx("input",{type:"text",className:"form-input",value:r.qs_ref,onChange:i=>x({...r,qs_ref:i.target.value}),style:{width:"80px"}}):e.jsx(w,{to:`/quality-standards/${t.id}`,style:{fontFamily:"monospace",fontWeight:"600",color:"#8b5cf6",textDecoration:"none"},children:t.qs_ref})}),e.jsx("td",{children:d?e.jsx("input",{type:"text",className:"form-input",value:r.name,onChange:i=>x({...r,name:i.target.value})}):e.jsx(w,{to:`/quality-standards/${t.id}`,style:{fontWeight:"500",color:"#3b82f6",textDecoration:"none"},children:t.name})}),e.jsx("td",{style:{textAlign:"center"},children:d?e.jsx("input",{type:"number",className:"form-input",min:"0",max:"100",value:r.target,onChange:i=>x({...r,target:i.target.value}),style:{width:"70px",textAlign:"center"}}):`${t.target}%`}),e.jsx("td",{style:{textAlign:"center"},children:d?e.jsx("input",{type:"number",className:"form-input",min:"0",max:"100",value:r.current_value,onChange:i=>x({...r,current_value:i.target.value}),style:{width:"70px",textAlign:"center"}}):e.jsxs("span",{style:{fontWeight:"600",color:t.current_value>=t.target?"#16a34a":"#64748b"},children:[t.current_value,"%"]})}),e.jsx("td",{style:{textAlign:"center"},children:l.total>0?e.jsxs("span",{style:{color:"#64748b"},children:[l.met," of ",l.total," passed"]}):e.jsx("span",{style:{color:"#94a3b8",fontStyle:"italic"},children:"None yet"})}),e.jsx("td",{children:e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.85rem",fontWeight:"500",backgroundColor:a.bg,color:a.color},children:[e.jsx(n,{size:14}),a.label]})}),c&&e.jsx("td",{children:d?e.jsxs("div",{className:"action-buttons",children:[e.jsx("button",{className:"btn-icon btn-success",onClick:()=>M(t.id),title:"Save",children:e.jsx(I,{size:16})}),e.jsx("button",{className:"btn-icon btn-secondary",onClick:()=>v(null),title:"Cancel",children:e.jsx(z,{size:16})})]}):e.jsxs("div",{className:"action-buttons",children:[e.jsx("button",{className:"btn-icon",onClick:()=>H(t),title:"Edit",children:e.jsx(ie,{size:16})}),e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>U(t),title:"Delete",children:e.jsx(oe,{size:16})})]})})]},t.id)})})]})}),e.jsx("div",{style:{marginTop:"1.5rem",padding:"1rem",backgroundColor:"#f0fdf4",borderLeft:"4px solid #16a34a",borderRadius:"4px"},children:e.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:"0.75rem"},children:[e.jsx(de,{size:20,style:{color:"#16a34a",marginTop:"2px"}}),e.jsxs("div",{children:[e.jsx("h4",{style:{margin:"0 0 0.5rem 0",color:"#166534"},children:"Quality Standards Overview"}),e.jsxs("ul",{style:{margin:0,paddingLeft:"1.25rem",color:"#166534",fontSize:"0.9rem"},children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Not Started:"})," No deliverables have been assessed against this standard yet"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Achieved:"})," Current score meets or exceeds target"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"On Track:"})," Within 80% of target"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"At Risk:"})," 60-80% of target"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Critical:"})," Below 60% of target (only for assessed standards)"]}),c&&e.jsxs("li",{children:[e.jsx("strong",{children:"Permissions:"})," Admin and Supplier PM can add/edit quality standards"]})]})]})]})}),e.jsx(ne,{isOpen:g.isOpen,onClose:()=>S({isOpen:!1,qs:null}),onConfirm:J,title:"Delete Quality Standard?",message:g.qs?`This will permanently delete "${g.qs.qs_ref}: ${g.qs.name}" and all associated assessments. This action cannot be undone.`:"",confirmText:"Delete",cancelText:"Cancel",type:"danger",isLoading:$})]})}export{be as default};
