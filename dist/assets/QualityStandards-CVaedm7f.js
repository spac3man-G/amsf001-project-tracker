import{u as E,a as F,d as L,q as j,j as e,L as $,s as B}from"./index-lCaZUE6M.js";import{d as W,r as l}from"./vendor-react-BUTV5ZEl.js";import{C as M}from"./ConfirmDialog-BPcywHcO.js";import{R as U,aj as C,c as V,al as X,l as G,I as H,p as J,b as K,W as Y,A as Z,a5 as ee}from"./vendor-icons-CWM4So-G.js";import"./vendor-supabase-6faYzd5A.js";function le(){const _=W(),{user:w}=E(),{projectId:i}=F(),A=w?.id||null,{canManageQualityStandards:Q}=L(),g=Q,[u,k]=l.useState([]),[v,D]=l.useState({}),[R,T]=l.useState(!0),[y,N]=l.useState(!1),[b,m]=l.useState(!1),[c,S]=l.useState({isOpen:!1,qs:null}),[p,h]=l.useState(!1),[a,d]=l.useState({qs_ref:"",name:"",description:"",target:100,current_value:0});l.useEffect(()=>{i&&x(i)},[i]);async function x(s){const t=s||i;if(t)try{const n=await j.getAll(t,{orderBy:{column:"qs_ref",ascending:!0}});k(n||[]);const r=await j.getAssessments(t),o={};r&&r.length>0&&r.forEach(q=>{const f=q.quality_standard_id;o[f]||(o[f]={total:0,met:0}),q.criteria_met!==null&&(o[f].total++,q.criteria_met===!0&&o[f].met++)}),D(o)}catch{}finally{T(!1),N(!1)}}async function z(){N(!0),await x()}async function O(s){if(s.preventDefault(),!a.qs_ref||!a.name){alert("Please fill in Reference and Name");return}h(!0);try{await j.create({project_id:i,qs_ref:a.qs_ref,name:a.name,description:a.description,target:parseInt(a.target)||100,current_value:parseInt(a.current_value)||0,created_by:A}),await x(),m(!1),d({qs_ref:"",name:"",description:"",target:100,current_value:0})}catch(t){alert("Failed to add: "+t.message)}finally{h(!1)}}async function I(){const s=c.qs;if(s){h(!0);try{await B.from("deliverable_qs_assessments").delete().eq("quality_standard_id",s.id),await j.delete(s.id),await x(),S({isOpen:!1,qs:null})}catch(t){alert("Failed to delete: "+t.message)}finally{h(!1)}}}function P(s){const t=v[s.id]||{total:0,met:0};if(t.total===0)return{label:"Not Started",class:"not-started",icon:J};const n=t.met/t.total*100,r=s.target||100;return n>=r?{label:"Achieved",class:"achieved",icon:K}:n>=r*.8?{label:"On Track",class:"on-track",icon:Y}:n>=r*.6?{label:"At Risk",class:"at-risk",icon:Z}:{label:"Critical",class:"critical",icon:ee}}return R&&!i?e.jsx($,{message:"Loading quality standards...",size:"large",fullPage:!0}):e.jsxs("div",{className:"qs-page",children:[e.jsx("header",{className:"qs-header",children:e.jsxs("div",{className:"qs-header-content",children:[e.jsxs("div",{className:"qs-header-left",children:[e.jsx("h1",{children:"Quality Standards"}),e.jsx("p",{children:"Track quality compliance across deliverables"})]}),e.jsxs("div",{className:"qs-header-actions",children:[e.jsxs("button",{className:"qs-btn qs-btn-secondary",onClick:z,disabled:y,children:[e.jsx(U,{size:18,className:y?"spinning":""})," Refresh"]}),g&&!b&&e.jsxs("button",{className:"qs-btn qs-btn-primary",onClick:()=>m(!0),children:[e.jsx(C,{size:18})," Add Quality Standard"]})]})]})}),e.jsxs("div",{className:"qs-content",children:[b&&g&&e.jsxs("div",{className:"qs-add-form",children:[e.jsxs("div",{className:"qs-add-form-header",children:[e.jsxs("h3",{className:"qs-add-form-title",children:[e.jsx(C,{size:20,style:{color:"var(--ds-teal)"}})," Add New Quality Standard"]}),e.jsx("button",{className:"qs-add-form-close",onClick:()=>m(!1),children:e.jsx(V,{size:18})})]}),e.jsxs("form",{onSubmit:O,children:[e.jsxs("div",{className:"qs-form-row two-col",children:[e.jsxs("div",{className:"qs-form-group",children:[e.jsx("label",{children:"Reference *"}),e.jsx("input",{type:"text",value:a.qs_ref,onChange:s=>d({...a,qs_ref:s.target.value}),placeholder:"e.g., QS09",style:{fontFamily:"var(--ds-font-mono)",fontWeight:600},required:!0})]}),e.jsxs("div",{className:"qs-form-group",children:[e.jsx("label",{children:"Name *"}),e.jsx("input",{type:"text",value:a.name,onChange:s=>d({...a,name:s.target.value}),placeholder:"e.g., Documentation Quality",required:!0})]})]}),e.jsxs("div",{className:"qs-form-group",style:{marginBottom:16},children:[e.jsx("label",{children:"Description"}),e.jsx("textarea",{value:a.description,onChange:s=>d({...a,description:s.target.value}),placeholder:"Describe what this quality standard measures...",rows:3})]}),e.jsxs("div",{className:"qs-form-row targets",children:[e.jsxs("div",{className:"qs-form-group",children:[e.jsx("label",{children:"Target (%)"}),e.jsx("input",{type:"number",min:"0",max:"100",value:a.target,onChange:s=>d({...a,target:s.target.value})})]}),e.jsxs("div",{className:"qs-form-group",children:[e.jsx("label",{children:"Current Value (%)"}),e.jsx("input",{type:"number",min:"0",max:"100",value:a.current_value,onChange:s=>d({...a,current_value:s.target.value})})]})]}),e.jsxs("div",{className:"qs-form-actions",children:[e.jsx("button",{type:"button",className:"qs-btn qs-btn-secondary",onClick:()=>m(!1),children:"Cancel"}),e.jsxs("button",{type:"submit",className:"qs-btn qs-btn-primary",disabled:p,children:[e.jsx(X,{size:16})," ",p?"Saving...":"Save Quality Standard"]})]})]})]}),e.jsxs("div",{className:"qs-table-card",children:[e.jsxs("div",{className:"qs-table-header",children:[e.jsx("h2",{className:"qs-table-title",children:"Quality Standards"}),e.jsxs("span",{className:"qs-table-count",children:[u.length," standard",u.length!==1?"s":""]})]}),u.length===0?e.jsxs("div",{className:"qs-empty",children:[e.jsx("div",{className:"qs-empty-icon",children:e.jsx(G,{size:32})}),e.jsx("div",{className:"qs-empty-title",children:"No quality standards found"}),e.jsx("div",{className:"qs-empty-text",children:g?'Click "Add Quality Standard" to create one.':"No quality standards have been defined yet."})]}):e.jsxs("table",{className:"qs-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Ref"}),e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Target"}),e.jsx("th",{children:"Current"}),e.jsx("th",{children:"Assessments"})]})}),e.jsx("tbody",{children:u.map(s=>{const t=P(s),n=v[s.id]||{total:0,met:0},r=n.total>0?Math.round(n.met/n.total*100):s.current_value||0;return e.jsxs("tr",{onClick:()=>_(`/quality-standards/${s.id}`),children:[e.jsx("td",{children:e.jsx("span",{className:"qs-ref",children:s.qs_ref})}),e.jsx("td",{children:e.jsx("span",{className:"qs-name",children:s.name})}),e.jsx("td",{children:e.jsxs("span",{className:"qs-target",children:[s.target,"%"]})}),e.jsx("td",{children:e.jsxs("span",{className:`qs-current ${t.class}`,children:[r,"%"]})}),e.jsx("td",{children:n.total>0?e.jsxs("span",{className:"qs-assessments",children:[n.met," of ",n.total," passed"]}):e.jsx("span",{className:"qs-assessments-none",children:"None yet"})})]},s.id)})})]})]}),e.jsxs("div",{className:"qs-info-box",children:[e.jsxs("div",{className:"qs-info-header",children:[e.jsx(H,{size:18})," Quality Standards Overview"]}),e.jsxs("ul",{className:"qs-info-list",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Not Started"})," — No deliverables have been assessed against this standard yet"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Achieved"})," — Current score meets or exceeds target"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"On Track"})," — Within 80% of target"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"At Risk"})," — 60-80% of target"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Critical"})," — Below 60% of target"]}),e.jsx("li",{children:"Click any row to view details and manage assessments"})]})]})]}),e.jsx(M,{isOpen:c.isOpen,onClose:()=>S({isOpen:!1,qs:null}),onConfirm:I,title:"Delete Quality Standard?",message:c.qs?`This will permanently delete "${c.qs.qs_ref}: ${c.qs.name}".`:"",confirmText:"Delete",cancelText:"Cancel",type:"danger",isLoading:p})]})}export{le as default};
