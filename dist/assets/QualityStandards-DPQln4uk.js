import{u as J,a as K,q as x,j as e,L as ee,s as te}from"./index-CX6cm4_7.js";import{u as ae,r as o}from"./vendor-react-JFEV0ROX.js";import{u as se}from"./usePermissions-CmDHq60C.js";import{S as b}from"./StatCard-DT1hdLKt.js";import{P as ne}from"./PageHeader-CtKvdE8c.js";import{C as re}from"./ConfirmDialog-DjJFYhwm.js";import{i as k,Y as le,C as w,A as Q,k as q,_ as T,a as I,Z as ie,T as oe,I as ce,q as de,y as ue}from"./vendor-icons-BZZethZ5.js";import"./vendor-supabase-DgEUAXvv.js";function ve(){const D=ae(),{user:P,role:me}=J(),{projectId:u}=K(),z=P?.id||null,{canManageQualityStandards:R}=se(),d=R,[m,E]=o.useState([]),[p,O]=o.useState({}),[F,L]=o.useState(!0),[_,v]=o.useState(!1),[W,S]=o.useState(null),[l,h]=o.useState({}),[f,C]=o.useState({isOpen:!1,qs:null}),[B,N]=o.useState(!1),[s,g]=o.useState({qs_ref:"",name:"",description:"",target:100,current_value:0});o.useEffect(()=>{u&&j(u)},[u]);async function j(t){const a=t||u;if(a)try{const c=await x.getAll(a,{orderBy:{column:"qs_ref",ascending:!0}});E(c||[]);const i=await x.getAssessments(a),r={};i&&i.length>0&&i.forEach(n=>{const y=n.quality_standard_id;r[y]||(r[y]={total:0,met:0}),n.criteria_met!==null&&(r[y].total++,n.criteria_met===!0&&r[y].met++)}),O(r)}catch{}finally{L(!1)}}async function $(t){if(t.preventDefault(),!s.qs_ref||!s.name){alert("Please fill in Reference and Name");return}try{await x.create({project_id:u,qs_ref:s.qs_ref,name:s.name,description:s.description,target:parseInt(s.target)||100,current_value:parseInt(s.current_value)||0,created_by:z}),await j(),v(!1),g({qs_ref:"",name:"",description:"",target:100,current_value:0}),alert("Quality Standard added successfully!")}catch(a){alert("Failed to add: "+a.message)}}function M(t){S(t.id),h({qs_ref:t.qs_ref,name:t.name,description:t.description||"",target:t.target||100,current_value:t.current_value||0})}async function U(t){try{await x.update(t,{qs_ref:l.qs_ref,name:l.name,description:l.description,target:parseInt(l.target)||100,current_value:parseInt(l.current_value)||0}),await j(),S(null),alert("Quality Standard updated!")}catch(a){alert("Failed to update: "+a.message)}}async function H(t){C({isOpen:!0,qs:t})}async function V(){const t=f.qs;if(t){N(!0);try{await te.from("deliverable_qs_assessments").delete().eq("quality_standard_id",t.id),await x.delete(t.id),await j(),C({isOpen:!1,qs:null})}catch(a){alert("Failed to delete: "+a.message)}finally{N(!1)}}}function A(t){const a=p[t.id]||{total:0,met:0};if(a.total===0)return{label:"Not Started",color:"#64748b",bg:"#f1f5f9",icon:q};const c=a.met/a.total*100,i=t.target||100;return c>=i?{label:"Achieved",color:"#16a34a",bg:"#dcfce7",icon:w}:c>=i*.8?{label:"On Track",color:"#2563eb",bg:"#dbeafe",icon:de}:c>=i*.6?{label:"At Risk",color:"#ea580c",bg:"#ffedd5",icon:Q}:{label:"Critical",color:"#dc2626",bg:"#fee2e2",icon:ue}}const X=m.length,Y=m.filter(t=>{const a=p[t.id]||{total:0,met:0};return a.total===0?!1:a.met/a.total*100>=(t.target||100)}).length,Z=m.filter(t=>{const a=A(t);return a.label==="At Risk"||a.label==="Critical"}).length,G=m.filter(t=>(p[t.id]||{total:0}).total===0).length;return F&&!u?e.jsx(ee,{message:"Loading quality standards...",size:"large",fullPage:!0}):e.jsxs("div",{className:"page-container",children:[e.jsx(ne,{icon:k,title:"Quality Standards",subtitle:"Track quality compliance across deliverables",children:d&&!_&&e.jsxs("button",{className:"btn btn-primary",onClick:()=>v(!0),children:[e.jsx(le,{size:18})," Add Quality Standard"]})}),e.jsxs("div",{className:"stats-grid",children:[e.jsx(b,{icon:k,label:"Total Standards",value:X,color:"#3b82f6"}),e.jsx(b,{icon:w,label:"Achieved",value:Y,color:"#16a34a"}),e.jsx(b,{icon:Q,label:"At Risk",value:Z,color:"#ea580c"}),e.jsx(b,{icon:q,label:"Not Started",value:G,color:"#64748b"})]}),_&&d&&e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem",border:"2px solid var(--primary)"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Add New Quality Standard"}),e.jsxs("form",{onSubmit:$,children:[e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 2fr",gap:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Reference *"}),e.jsx("input",{type:"text",className:"form-input",placeholder:"e.g., QS08",value:s.qs_ref,onChange:t=>g({...s,qs_ref:t.target.value}),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Name *"}),e.jsx("input",{type:"text",className:"form-input",placeholder:"e.g., Documentation Quality",value:s.name,onChange:t=>g({...s,name:t.target.value}),required:!0})]})]}),e.jsxs("div",{style:{marginTop:"1rem"},children:[e.jsx("label",{className:"form-label",children:"Description"}),e.jsx("textarea",{className:"form-input",rows:3,placeholder:"Describe what this quality standard measures...",value:s.description,onChange:t=>g({...s,description:t.target.value})})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem",marginTop:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Target (%)"}),e.jsx("input",{type:"number",className:"form-input",min:"0",max:"100",value:s.target,onChange:t=>g({...s,target:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Current Value (%)"}),e.jsx("input",{type:"number",className:"form-input",min:"0",max:"100",value:s.current_value,onChange:t=>g({...s,current_value:t.target.value})})]})]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem",marginTop:"1rem"},children:[e.jsxs("button",{type:"submit",className:"btn btn-primary",children:[e.jsx(T,{size:16})," Save Quality Standard"]}),e.jsxs("button",{type:"button",className:"btn btn-secondary",onClick:()=>v(!1),children:[e.jsx(I,{size:16})," Cancel"]})]})]})]}),e.jsx("div",{className:"card",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Ref"}),e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Target"}),e.jsx("th",{children:"Current"}),e.jsx("th",{children:"Assessments"}),e.jsx("th",{children:"Status"}),d&&e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:m.length===0?e.jsx("tr",{children:e.jsxs("td",{colSpan:d?7:6,style:{textAlign:"center",padding:"2rem",color:"#64748b"},children:["No quality standards found. ",d&&'Click "Add Quality Standard" to create one.']})}):m.map(t=>{const a=A(t),c=a.icon,i=p[t.id]||{total:0,met:0},r=W===t.id;return e.jsxs("tr",{onClick:()=>!r&&D(`/quality-standards/${t.id}`),style:{cursor:r?"default":"pointer"},className:r?"":"table-row-clickable",children:[e.jsx("td",{onClick:n=>r&&n.stopPropagation(),children:r?e.jsx("input",{type:"text",className:"form-input",value:l.qs_ref,onChange:n=>h({...l,qs_ref:n.target.value}),style:{width:"80px"}}):e.jsx("span",{style:{fontFamily:"monospace",fontWeight:"600",color:"#8b5cf6"},children:t.qs_ref})}),e.jsx("td",{onClick:n=>r&&n.stopPropagation(),children:r?e.jsx("input",{type:"text",className:"form-input",value:l.name,onChange:n=>h({...l,name:n.target.value})}):e.jsx("span",{style:{fontWeight:"500"},children:t.name})}),e.jsx("td",{style:{textAlign:"center"},children:r?e.jsx("input",{type:"number",className:"form-input",min:"0",max:"100",value:l.target,onChange:n=>h({...l,target:n.target.value}),style:{width:"70px",textAlign:"center"}}):`${t.target}%`}),e.jsx("td",{style:{textAlign:"center"},children:r?e.jsx("input",{type:"number",className:"form-input",min:"0",max:"100",value:l.current_value,onChange:n=>h({...l,current_value:n.target.value}),style:{width:"70px",textAlign:"center"}}):e.jsxs("span",{style:{fontWeight:"600",color:t.current_value>=t.target?"#16a34a":"#64748b"},children:[t.current_value,"%"]})}),e.jsx("td",{style:{textAlign:"center"},children:i.total>0?e.jsxs("span",{style:{color:"#64748b"},children:[i.met," of ",i.total," passed"]}):e.jsx("span",{style:{color:"#94a3b8",fontStyle:"italic"},children:"None yet"})}),e.jsx("td",{children:e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",borderRadius:"4px",fontSize:"0.85rem",fontWeight:"500",backgroundColor:a.bg,color:a.color},children:[e.jsx(c,{size:14}),a.label]})}),d&&e.jsx("td",{onClick:n=>n.stopPropagation(),children:r?e.jsxs("div",{className:"action-buttons",children:[e.jsx("button",{className:"btn-icon btn-success",onClick:()=>U(t.id),title:"Save",children:e.jsx(T,{size:16})}),e.jsx("button",{className:"btn-icon btn-secondary",onClick:()=>S(null),title:"Cancel",children:e.jsx(I,{size:16})})]}):e.jsxs("div",{className:"action-buttons",children:[e.jsx("button",{className:"btn-icon",onClick:()=>M(t),title:"Edit",children:e.jsx(ie,{size:16})}),e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>H(t),title:"Delete",children:e.jsx(oe,{size:16})})]})})]},t.id)})})]})}),e.jsx("div",{style:{marginTop:"1.5rem",padding:"1rem",backgroundColor:"#f0fdf4",borderLeft:"4px solid #16a34a",borderRadius:"4px"},children:e.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:"0.75rem"},children:[e.jsx(ce,{size:20,style:{color:"#16a34a",marginTop:"2px"}}),e.jsxs("div",{children:[e.jsx("h4",{style:{margin:"0 0 0.5rem 0",color:"#166534"},children:"Quality Standards Overview"}),e.jsxs("ul",{style:{margin:0,paddingLeft:"1.25rem",color:"#166534",fontSize:"0.9rem"},children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Not Started:"})," No deliverables have been assessed against this standard yet"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Achieved:"})," Current score meets or exceeds target"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"On Track:"})," Within 80% of target"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"At Risk:"})," 60-80% of target"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Critical:"})," Below 60% of target (only for assessed standards)"]}),d&&e.jsxs("li",{children:[e.jsx("strong",{children:"Permissions:"})," Admin and Supplier PM can add/edit quality standards"]})]})]})]})}),e.jsx(re,{isOpen:f.isOpen,onClose:()=>C({isOpen:!1,qs:null}),onConfirm:V,title:"Delete Quality Standard?",message:f.qs?`This will permanently delete "${f.qs.qs_ref}: ${f.qs.name}" and all associated assessments. This action cannot be undone.`:"",confirmText:"Delete",cancelText:"Cancel",type:"danger",isLoading:B})]})}export{ve as default};
