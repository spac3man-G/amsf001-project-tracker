import{y as ne,z as Le,A as ot,B as ct,C as De,D as ve,S as _,E as ae,x as qe,s as ye,F as V,R as M,G as dt,a as Se,u as xe,H as Ke,I as Nt,j as e,L as Ge,J as we,K,M as Qe,N as Ct,O as ut,P as Tt,Q as re,T as _t,U as wt}from"./index-CmJB_GBp.js";import{r as c,R as At}from"./vendor-react-BUTV5ZEl.js";import{C as Dt}from"./ConfirmDialog-qy_GdwwA.js";import{aJ as Ne,aK as Rt,S as se,F as X,ab as Mt,$ as It,h as Re,e as ie,aL as kt,w as Me,a4 as Q,I as mt,aM as pt,O as le,a8 as Pt,aN as Ot,aa as Lt,J as zt,aI as Ut,c as Ce,a as Ie,am as Bt,ai as je,a1 as Ft,C as ht,f as ft,a9 as Gt,aO as $t,av as Vt,aP as gt,az as Ae,ap as Yt,aq as Wt,aQ as Ht,b as Ze,R as ze,E as qt,D as Kt,ak as Ue,ay as Qt,x as Xe,A as Zt,B as Be,g as Je,i as Xt,U as Jt,L as yt,ao as es,aR as xt,aS as jt,p as ke}from"./vendor-icons-C6BNM9_X.js";import"./vendor-supabase-6faYzd5A.js";function $e(a,t){const s=ne(a);return isNaN(t)?Le(a,NaN):(t&&s.setDate(s.getDate()+t),s)}function Ee(a,t){const s=ne(a);if(isNaN(t))return Le(a,NaN);if(!t)return s;const n=s.getDate(),r=Le(a,s.getTime());r.setMonth(s.getMonth()+t+1,0);const l=r.getDate();return n>=l?r:(s.setFullYear(r.getFullYear(),r.getMonth(),n),s)}function ts(a,t){const s=t*7;return $e(a,s)}function he(a){const t=ne(a),s=t.getMonth();return t.setFullYear(t.getFullYear(),s+1,0),t.setHours(23,59,59,999),t}function et(a){const t=ne(a),s=t.getMonth(),n=s-s%3;return t.setMonth(n,1),t.setHours(0,0,0,0),t}function fe(a){const t=ne(a);return t.setDate(1),t.setHours(0,0,0,0),t}function ss(a,t){const s=+ne(a),[n,r]=[+ne(t.start),+ne(t.end)].sort((l,o)=>l-o);return s>=n&&s<=r}function as(a,t){return $e(a,-1)}function Fe(a,t){const n=ls(a);let r;if(n.date){const u=os(n.date,2);r=cs(u.restDateString,u.year)}if(!r||isNaN(r.getTime()))return new Date(NaN);const l=r.getTime();let o=0,i;if(n.time&&(o=ds(n.time),isNaN(o)))return new Date(NaN);if(n.timezone){if(i=us(n.timezone),isNaN(i))return new Date(NaN)}else{const u=new Date(l+o),d=new Date(0);return d.setFullYear(u.getUTCFullYear(),u.getUTCMonth(),u.getUTCDate()),d.setHours(u.getUTCHours(),u.getUTCMinutes(),u.getUTCSeconds(),u.getUTCMilliseconds()),d}return new Date(l+o+i)}const _e={dateTimeDelimiter:/[T ]/,timeZoneDelimiter:/[Z ]/i,timezone:/([Z+-].*)$/},rs=/^-?(?:(\d{3})|(\d{2})(?:-?(\d{2}))?|W(\d{2})(?:-?(\d{1}))?|)$/,ns=/^(\d{2}(?:[.,]\d*)?)(?::?(\d{2}(?:[.,]\d*)?))?(?::?(\d{2}(?:[.,]\d*)?))?$/,is=/^([+-])(\d{2})(?::?(\d{2}))?$/;function ls(a){const t={},s=a.split(_e.dateTimeDelimiter);let n;if(s.length>2)return t;if(/:/.test(s[0])?n=s[0]:(t.date=s[0],n=s[1],_e.timeZoneDelimiter.test(t.date)&&(t.date=a.split(_e.timeZoneDelimiter)[0],n=a.substr(t.date.length,a.length))),n){const r=_e.timezone.exec(n);r?(t.time=n.replace(r[1],""),t.timezone=r[1]):t.time=n}return t}function os(a,t){const s=new RegExp("^(?:(\\d{4}|[+-]\\d{"+(4+t)+"})|(\\d{2}|[+-]\\d{"+(2+t)+"})$)"),n=a.match(s);if(!n)return{year:NaN,restDateString:""};const r=n[1]?parseInt(n[1]):null,l=n[2]?parseInt(n[2]):null;return{year:l===null?r:l*100,restDateString:a.slice((n[1]||n[2]).length)}}function cs(a,t){if(t===null)return new Date(NaN);const s=a.match(rs);if(!s)return new Date(NaN);const n=!!s[4],r=be(s[1]),l=be(s[2])-1,o=be(s[3]),i=be(s[4]),u=be(s[5])-1;if(n)return gs(t,i,u)?ms(t,i,u):new Date(NaN);{const d=new Date(0);return!hs(t,l,o)||!fs(t,r)?new Date(NaN):(d.setUTCFullYear(t,l,Math.max(r,o)),d)}}function be(a){return a?parseInt(a):1}function ds(a){const t=a.match(ns);if(!t)return NaN;const s=Pe(t[1]),n=Pe(t[2]),r=Pe(t[3]);return ys(s,n,r)?s*ot+n*ct+r*1e3:NaN}function Pe(a){return a&&parseFloat(a.replace(",","."))||0}function us(a){if(a==="Z")return 0;const t=a.match(is);if(!t)return 0;const s=t[1]==="+"?-1:1,n=parseInt(t[2]),r=t[3]&&parseInt(t[3])||0;return xs(n,r)?s*(n*ot+r*ct):NaN}function ms(a,t,s){const n=new Date(0);n.setUTCFullYear(a,0,4);const r=n.getUTCDay()||7,l=(t-1)*7+s+1-r;return n.setUTCDate(n.getUTCDate()+l),n}const ps=[31,null,31,30,31,30,31,31,30,31,30,31];function vt(a){return a%400===0||a%4===0&&a%100!==0}function hs(a,t,s){return t>=0&&t<=11&&s>=1&&s<=(ps[t]||(vt(a)?29:28))}function fs(a,t){return t>=1&&t<=(vt(a)?366:365)}function gs(a,t,s){return t>=1&&t<=53&&s>=0&&s<=6}function ys(a,t,s){return a===24?t===0&&s===0:s>=0&&s<60&&t>=0&&t<60&&a>=0&&a<25}function xs(a,t){return t>=0&&t<=59}function Y(a,t){return Ee(a,-t)}function js(a,t={}){const s=new Date;let n,r,l;switch(a){case M.LAST_MONTH:case"lastMonth":n=fe(Y(s,1)),r=he(Y(s,1)),l=V(n,"MMMM yyyy");break;case M.LAST_QUARTER:case"lastQuarter":r=he(Y(s,1)),n=fe(Y(s,3)),l=`${V(n,"MMM yyyy")} - ${V(r,"MMM yyyy")}`;break;case M.LAST_6_MONTHS:case"last6Months":r=he(Y(s,1)),n=fe(Y(s,6)),l=`${V(n,"MMM yyyy")} - ${V(r,"MMM yyyy")}`;break;case M.YEAR_TO_DATE:case"yearToDate":n=dt(s),r=s,l=`${V(n,"MMM yyyy")} - ${V(r,"MMM yyyy")}`;break;case M.CUSTOM:case"custom":t.startDate&&t.endDate?(n=typeof t.startDate=="string"?Fe(t.startDate):t.startDate,r=typeof t.endDate=="string"?Fe(t.endDate):t.endDate,l=`${V(n,"dd MMM yyyy")} - ${V(r,"dd MMM yyyy")}`):(n=fe(Y(s,1)),r=he(Y(s,1)),l=V(n,"MMMM yyyy"));break;default:n=fe(Y(s,1)),r=he(Y(s,1)),l=V(n,"MMMM yyyy")}return{startDate:n,endDate:r,label:l}}function Oe(a){const t=new Date,s=t;let n,r;switch(a){case"1week":n=$e(t,7),r="Next Week";break;case"2weeks":n=ts(t,2),r="Next 2 Weeks";break;case"1month":n=Ee(t,1),r="Next Month";break;case"3months":n=Ee(t,3),r="Next 3 Months";break;case"6months":n=Ee(t,6),r="Next 6 Months";break;default:n=Ee(t,3),r="Next 3 Months"}return{startDate:s,endDate:n,label:r}}class vs{constructor(){this.cache=new Map,this.cacheTimeout=3e4}clearCache(){this.cache.clear()}getCached(t){const s=this.cache.get(t);return s&&Date.now()-s.timestamp<this.cacheTimeout?s.data:null}setCache(t,s){this.cache.set(t,{data:s,timestamp:Date.now()})}async fetchSectionData(t,s,n){const r=De(t);if(!r)throw new Error(`Unknown section type: ${t}`);if(r.roleRestriction&&!r.roleRestriction.includes(n.userRole))return{restricted:!0,message:"You do not have permission to view this section"};const l=js(n.reportingPeriod,n.customDateRange);switch(r.dataSource){case ve.METRICS_SERVICE:return this.fetchMetricsData(t,s,n,l);case ve.RAID_SERVICE:return this.fetchRAIDData(s,n,l);case ve.CUSTOM_QUERY:return this.fetchCustomData(t,s,n,l);case ve.USER_INPUT:case ve.AI_GENERATED:return{type:"content",content:s.content||"",heading:s.heading||r.name};default:throw new Error(`Unknown data source: ${r.dataSource}`)}}async fetchAllSectionData(t,s){const n=new Map,r=t.map(async l=>{try{const o=await this.fetchSectionData(l.type,l.config,s);n.set(l.id,{success:!0,data:o})}catch(o){const i=o?.message||o?.toString()||"Unknown error occurred";n.set(l.id,{success:!1,error:i,data:null})}});return await Promise.all(r),n}async fetchMetricsData(t,s,n,r){const{projectId:l}=n;switch(t){case _.MILESTONE_SUMMARY:return this.fetchMilestoneSummary(l,s,r);case _.DELIVERABLE_SUMMARY:return this.fetchDeliverableSummary(l,s,r);case _.KPI_PERFORMANCE:return this.fetchKPIPerformance(l,s,r);case _.QUALITY_STANDARDS:return this.fetchQualityStandards(l,s,r);case _.BUDGET_ANALYSIS:return this.fetchBudgetAnalysis(l,s,r);case _.TIMESHEET_SUMMARY:return this.fetchTimesheetSummary(l,s,r);case _.EXPENSE_SUMMARY:return this.fetchExpenseSummary(l,s,r);case _.RESOURCE_SUMMARY:return this.fetchResourceSummary(l,s,r);default:throw new Error(`No metrics handler for section type: ${t}`)}}async fetchMilestoneSummary(t,s,n){try{const r=await ae.getMilestoneMetrics(t);let l=r.milestones;return s.statusFilter&&!s.statusFilter.includes("all")&&(l=r.milestones.filter(o=>s.statusFilter.includes(o.status))),l=this.sortItems(l,s.sortBy,"milestone_ref"),{type:_.MILESTONE_SUMMARY,dateRange:n,summary:{total:r.total,completed:r.completed,inProgress:r.inProgress,notStarted:r.notStarted,totalBudget:r.totalBudget,averageProgress:r.averageProgress},items:l.map(o=>({id:o.id,ref:o.milestone_ref,name:o.name,status:o.status,progress:o.progress||0,budget:s.showBudget!==!1?parseFloat(o.baseline_billable)||0:null,percentComplete:o.percent_complete||o.progress||0})),config:{includeChart:s.includeChart!==!1,showBudget:s.showBudget!==!1,showProgress:s.showProgress!==!1}}}catch(r){throw r}}async fetchDeliverableSummary(t,s,n){try{const r=await ae.getDeliverableMetrics(t);let l=r.deliverables;s.statusFilter&&!s.statusFilter.includes("all")&&(l=r.deliverables.filter(d=>s.statusFilter.includes(d.status))),l=this.sortItems(l,s.sortBy,"deliverable_ref");let o=null;s.groupByMilestone&&(o=this.groupByMilestone(l));const i=new Date().toISOString().split("T")[0],u=new Set(l.filter(d=>d.due_date<i&&d.status!=="Delivered").map(d=>d.id));return{type:_.DELIVERABLE_SUMMARY,dateRange:n,summary:{total:r.total,delivered:r.delivered,inProgress:r.inProgress,notStarted:r.notStarted,overdue:r.overdue,completionPercent:r.completionPercent},items:l.map(d=>({id:d.id,ref:d.deliverable_ref,name:d.name,status:d.status,dueDate:d.due_date,milestoneId:d.milestone_id,isOverdue:s.highlightOverdue!==!1&&u.has(d.id)})),groupedByMilestone:o,config:{includeChart:s.includeChart!==!1,groupByMilestone:s.groupByMilestone||!1,highlightOverdue:s.highlightOverdue!==!1}}}catch(r){throw r}}async fetchKPIPerformance(t,s,n){try{const r=await ae.getKPIMetrics(t);let l=this.sortItems(r.kpis,s.sortBy,"kpi_ref"),o=null;return s.groupByCategory!==!1&&(o=r.byCategory),{type:_.KPI_PERFORMANCE,dateRange:n,summary:{total:r.total,achieved:r.achieved,atRisk:r.atRisk,failing:r.failing,achievementPercent:r.achievementPercent},items:l.map(i=>({id:i.id,ref:i.kpi_ref,name:i.name,category:i.category,target:s.includeTarget!==!1?i.target:null,actual:i.calculatedValue,ragStatus:s.showRAG!==!1?i.ragStatus:null,assessmentCount:i.assessmentCount,isAchieved:i.isAchieved})),byCategory:o,config:{includeChart:s.includeChart!==!1,showRAG:s.showRAG!==!1,includeTarget:s.includeTarget!==!1,groupByCategory:s.groupByCategory!==!1}}}catch(r){throw r}}async fetchQualityStandards(t,s,n){try{const r=await ae.getQualityStandardMetrics(t);let l=this.sortItems(r.qualityStandards,s.sortBy,"qs_ref");return{type:_.QUALITY_STANDARDS,dateRange:n,summary:{total:r.total,achieved:r.achieved,partial:r.partial,notMet:r.notMet,achievementPercent:r.achievementPercent},items:l.map(o=>({id:o.id,ref:o.qs_ref,name:o.name,target:o.target,actual:o.calculatedValue,assessmentCount:s.showAssessmentCount!==!1?o.assessmentCount:null,assessmentsMet:o.assessmentsMet,isAchieved:o.isAchieved})),config:{includeChart:s.includeChart!==!1,showAssessmentCount:s.showAssessmentCount!==!1}}}catch(r){throw r}}async fetchBudgetAnalysis(t,s,n){try{const r=await ae.getAllDashboardMetrics(t);let l=[];return s.showByMilestone!==!1&&(l=(r.milestones.milestones||[]).map(i=>({id:i.id,ref:i.milestone_ref,name:i.name,budget:parseFloat(i.baseline_billable)||0,spend:r.milestoneSpend?.[i.id]||0,variance:(parseFloat(i.baseline_billable)||0)-(r.milestoneSpend?.[i.id]||0)}))),{type:_.BUDGET_ANALYSIS,dateRange:n,summary:{totalBudget:r.budget.totalBudget,totalSpend:r.budget.totalSpend,variance:r.budget.totalBudget-r.budget.totalSpend,utilizationPercent:r.budget.utilizationPercent,timesheetSpend:r.budget.timesheetSpend,expenseSpend:r.budget.expenseSpend},pmoVsDelivery:s.showPMOvsDelivery!==!1?{pmo:{budget:r.budget.pmoBudget,spend:r.budget.pmoSpend,variance:r.budget.pmoBudget-r.budget.pmoSpend},delivery:{budget:r.budget.deliveryBudget,spend:r.budget.deliverySpend,variance:r.budget.deliveryBudget-r.budget.deliverySpend}}:null,byMilestone:l,config:{includeChart:s.includeChart!==!1,showPMOvsDelivery:s.showPMOvsDelivery!==!1,showByMilestone:s.showByMilestone!==!1,showVariance:s.showVariance!==!1}}}catch(r){throw r}}async fetchTimesheetSummary(t,s,n){try{const r=await ae.getTimesheetMetrics(t);let l=[];s.showByResource!==!1&&(l=Object.entries(r.spendByResource||{}).map(([i,u])=>({resourceId:i,spend:u})));let o=[];return s.showByMilestone!==!1&&(o=Object.entries(r.spendByMilestone||{}).map(([i,u])=>({milestoneId:i,spend:u}))),{type:_.TIMESHEET_SUMMARY,dateRange:n,summary:{totalEntries:r.totalEntries,validEntries:r.validEntries,draftEntries:r.draftEntries,totalHours:r.totalHours,totalSpend:r.totalSpend,pmoSpend:r.pmoSpend,deliverySpend:r.deliverySpend},byResource:l,byMilestone:o,config:{includeChart:s.includeChart!==!1,showByResource:s.showByResource!==!1,showByMilestone:s.showByMilestone!==!1}}}catch(r){throw r}}async fetchExpenseSummary(t,s,n){try{const r=await ae.getExpenseMetrics(t);let l=[];return s.showByCategory!==!1&&(l=Object.entries(r.byCategory||{}).map(([o,i])=>({category:o,amount:i})).sort((o,i)=>i.amount-o.amount)),{type:_.EXPENSE_SUMMARY,dateRange:n,summary:{totalEntries:r.totalEntries,validEntries:r.validEntries,draftEntries:r.draftEntries,totalAmount:r.totalAmount,chargeableAmount:r.chargeableAmount,nonChargeableAmount:r.nonChargeableAmount},byCategory:l,chargeableBreakdown:s.showChargeableBreakdown!==!1?{chargeable:r.chargeableAmount,nonChargeable:r.nonChargeableAmount}:null,config:{includeChart:s.includeChart!==!1,showByCategory:s.showByCategory!==!1,showChargeableBreakdown:s.showChargeableBreakdown!==!1}}}catch(r){throw r}}async fetchResourceSummary(t,s,n){try{const r=await ae.getResourceMetrics(t);let l=null;return s.groupByRole!==!1&&(l={},r.resources.forEach(o=>{const i=o.role||"Unassigned";l[i]||(l[i]=[]),l[i].push(o)})),{type:_.RESOURCE_SUMMARY,dateRange:n,summary:{total:r.total,pmoCount:r.pmoCount,deliveryCount:r.deliveryCount,totalBudget:r.totalBudget,pmoBudget:r.pmoBudget,deliveryBudget:r.deliveryBudget},items:r.resources.map(o=>({id:o.id,name:o.name,role:o.role,daysAllocated:s.showAllocation!==!1?o.days_allocated:null,sellPrice:o.sell_price,budget:(o.sell_price||0)*(o.days_allocated||0)})),byRole:l,config:{includeChart:s.includeChart!==!1,showAllocation:s.showAllocation!==!1,showUtilisation:s.showUtilisation!==!1,groupByRole:s.groupByRole!==!1}}}catch(r){throw r}}async fetchRAIDData(t,s,n){try{const{projectId:r}=s,l={};t.categories&&t.categories.length>0&&t.categories.includes("all"),t.statusFilter&&t.statusFilter.length>0&&(l.status=t.statusFilter),t.severityFilter&&t.severityFilter.length>0&&t.severityFilter.includes("all");let o=await qe.getAllWithRelations(r,l);t.categories&&t.categories.length>0&&!t.categories.includes("all")&&(o=o.filter(d=>t.categories.includes(d.category))),t.severityFilter&&t.severityFilter.length>0&&!t.severityFilter.includes("all")&&(o=o.filter(d=>t.severityFilter.includes(d.severity))),t.maxItems&&t.maxItems>0&&(o=o.slice(0,t.maxItems));const i=await qe.getSummary(r),u={Risk:o.filter(d=>d.category==="Risk"),Assumption:o.filter(d=>d.category==="Assumption"),Issue:o.filter(d=>d.category==="Issue"),Dependency:o.filter(d=>d.category==="Dependency")};return{type:_.RAID_SUMMARY,dateRange:n,summary:{total:i.total,byCategory:i.byCategory,byStatus:i.byStatus,bySeverity:i.bySeverity,highPriorityCount:i.highPriorityItems.length},items:o.map(d=>({id:d.id,ref:d.raid_ref,category:d.category,title:d.title,description:t.showDetails!==!1?d.description:null,status:d.status,severity:d.severity,owner:d.owner?{id:d.owner.id,name:d.owner.name}:null,dueDate:d.due_date,milestone:d.milestone?{id:d.milestone.id,ref:d.milestone.milestone_ref,name:d.milestone.name}:null})),byCategory:u,highPriorityItems:i.highPriorityItems,config:{includeChart:t.includeChart!==!1,showDetails:t.showDetails!==!1,categories:t.categories||["Risk","Assumption","Issue","Dependency"],maxItems:t.maxItems||0}}}catch(r){throw r}}async fetchCustomData(t,s,n,r){switch(t){case _.FORWARD_LOOK:return this.fetchForwardLook(s,n);case _.UPCOMING_MILESTONES:return this.fetchUpcomingMilestones(s,n);case _.UPCOMING_DELIVERABLES:return this.fetchUpcomingDeliverables(s,n);default:throw new Error(`No custom handler for section type: ${t}`)}}async fetchForwardLook(t,s){try{const{projectId:n}=s,r=Oe(t.lookAheadPeriod||"3months"),l=new Date().toISOString().split("T")[0],o=r.endDate.toISOString().split("T")[0],i={type:_.FORWARD_LOOK,lookAheadRange:r,milestones:[],deliverables:[],dependencies:[],resources:[]};if(t.includeMilestones!==!1){const{data:u,error:d}=await ye.from("milestones").select("id, milestone_ref, name, status, end_date, progress, baseline_billable").eq("project_id",n).eq("is_deleted",!1).neq("status","Completed").gte("end_date",l).lte("end_date",o).order("end_date",{ascending:!0});d||(i.milestones=u||[])}if(t.includeDeliverables!==!1){const{data:u,error:d}=await ye.from("deliverables").select("id, deliverable_ref, name, status, due_date, milestone_id").eq("project_id",n).eq("is_deleted",!1).neq("status","Delivered").gte("due_date",l).lte("due_date",o).order("due_date",{ascending:!0});d||(i.deliverables=u||[])}if(t.includeDependencies!==!1){const{data:u,error:d}=await ye.from("raid_items").select(`
            id, raid_ref, title, description, status, severity, due_date,
            owner:resources!raid_items_owner_id_fkey(id, name),
            milestone:milestones!raid_items_milestone_id_fkey(id, name, milestone_ref)
          `).eq("project_id",n).eq("category","Dependency").eq("is_deleted",!1).in("status",["Open","In Progress"]).order("severity",{ascending:!1});d||(i.dependencies=u||[])}return t.includeResources&&(i.resources=[]),{...i,summary:{milestonesCount:i.milestones.length,deliverablesCount:i.deliverables.length,dependenciesCount:i.dependencies.length,highPriorityDependencies:i.dependencies.filter(u=>u.severity==="High").length},config:{lookAheadPeriod:t.lookAheadPeriod||"3months",includeMilestones:t.includeMilestones!==!1,includeDeliverables:t.includeDeliverables!==!1,includeDependencies:t.includeDependencies!==!1,includeResources:t.includeResources||!1}}}catch(n){throw n}}async fetchUpcomingMilestones(t,s){try{const{projectId:n}=s,r=Oe(t.lookAheadPeriod||"3months"),l=new Date().toISOString().split("T")[0],o=r.endDate.toISOString().split("T")[0],i=["Not Started"];t.includeInProgress!==!1&&i.push("In Progress");const{data:u,error:d}=await ye.from("milestones").select("id, milestone_ref, name, status, end_date, progress, baseline_billable").eq("project_id",n).eq("is_deleted",!1).in("status",i).lte("end_date",o).order("end_date",{ascending:!0});if(d)throw d;let h=[];if(t.showDependencies){const x=u?.map(p=>p.id)||[];if(x.length>0){const{data:p,error:y}=await ye.from("raid_items").select("id, raid_ref, title, milestone_id, status, severity").eq("category","Dependency").eq("is_deleted",!1).in("milestone_id",x).in("status",["Open","In Progress"]);!y&&p&&(h=p)}}const g=(u||[]).map(x=>({...x,dependencies:h.filter(p=>p.milestone_id===x.id)}));return{type:_.UPCOMING_MILESTONES,lookAheadRange:r,items:g,summary:{total:g.length,notStarted:g.filter(x=>x.status==="Not Started").length,inProgress:g.filter(x=>x.status==="In Progress").length,withBlockingDeps:g.filter(x=>x.dependencies.length>0).length},config:{lookAheadPeriod:t.lookAheadPeriod||"3months",includeInProgress:t.includeInProgress!==!1,showDependencies:t.showDependencies||!1}}}catch(n){throw n}}async fetchUpcomingDeliverables(t,s){try{const{projectId:n}=s,r=Oe(t.lookAheadPeriod||"1month"),l=new Date().toISOString().split("T")[0],o=r.endDate.toISOString().split("T")[0],{data:i,error:u}=await ye.from("deliverables").select(`
          id, deliverable_ref, name, status, due_date, milestone_id,
          milestone:milestones!deliverables_milestone_id_fkey(id, name, milestone_ref)
        `).eq("project_id",n).eq("is_deleted",!1).neq("status","Delivered").lte("due_date",o).order("due_date",{ascending:!0});if(u)throw u;const d=new Set((i||[]).filter(g=>g.due_date<l).map(g=>g.id));let h=null;return t.groupByMilestone!==!1&&(h={},(i||[]).forEach(g=>{const x=g.milestone?.milestone_ref||"Unassigned";h[x]||(h[x]={milestone:g.milestone,deliverables:[]}),h[x].deliverables.push(g)})),{type:_.UPCOMING_DELIVERABLES,lookAheadRange:r,items:(i||[]).map(g=>({...g,isOverdue:t.highlightOverdue!==!1&&d.has(g.id)})),groupedByMilestone:h,summary:{total:(i||[]).length,overdue:d.size,dueThisWeek:(i||[]).filter(g=>{const x=g.due_date,p=new Date;return p.setDate(p.getDate()+7),x>=l&&x<=p.toISOString().split("T")[0]}).length},config:{lookAheadPeriod:t.lookAheadPeriod||"1month",groupByMilestone:t.groupByMilestone!==!1,highlightOverdue:t.highlightOverdue!==!1}}}catch(n){throw n}}sortItems(t,s,n="id"){const r=s||n;return[...t].sort((l,o)=>{const i=l[r],u=o[r];return i==null&&u==null?0:i==null?1:u==null?-1:typeof i=="number"&&typeof u=="number"?i-u:String(i).localeCompare(String(u))})}groupByMilestone(t){const s={};return t.forEach(n=>{const r=n.milestone_id||"unassigned";s[r]||(s[r]=[]),s[r].push(n)}),s}filterByDateRange(t,s,n,r){return t.filter(l=>{const o=l[s];if(!o)return!0;const i=typeof o=="string"?Fe(o):o;return ss(i,{start:n,end:r})})}calculatePeriodComparison(t,s){if(!s||s===0)return{change:null,percentChange:null};const n=t-s,r=Math.round(n/s*100);return{change:n,percentChange:r}}}const bs=new vs,O={TEMPLATE_SELECTION:1,PARAMETERS:2,SECTION_BUILDER:3,PREVIEW_GENERATE:4},Es={[O.TEMPLATE_SELECTION]:{label:"Select Template",description:"Choose a template or start from scratch"},[O.PARAMETERS]:{label:"Configure",description:"Set report name and parameters"},[O.SECTION_BUILDER]:{label:"Build Report",description:"Add and configure sections"},[O.PREVIEW_GENERATE]:{label:"Preview & Generate",description:"Review and generate your report"}},E={SET_STEP:"SET_STEP",NEXT_STEP:"NEXT_STEP",PREV_STEP:"PREV_STEP",SELECT_TEMPLATE:"SELECT_TEMPLATE",CLEAR_TEMPLATE:"CLEAR_TEMPLATE",SET_REPORT_NAME:"SET_REPORT_NAME",SET_PARAMETERS:"SET_PARAMETERS",UPDATE_PARAMETER:"UPDATE_PARAMETER",ADD_SECTION:"ADD_SECTION",REMOVE_SECTION:"REMOVE_SECTION",UPDATE_SECTION:"UPDATE_SECTION",REORDER_SECTIONS:"REORDER_SECTIONS",CLEAR_SECTIONS:"CLEAR_SECTIONS",SET_SECTIONS:"SET_SECTIONS",SET_PREVIEW:"SET_PREVIEW",CLEAR_PREVIEW:"CLEAR_PREVIEW",SET_GENERATING:"SET_GENERATING",SET_PREVIEW_ERROR:"SET_PREVIEW_ERROR",TOGGLE_AI_PANEL:"TOGGLE_AI_PANEL",SET_AI_PANEL_OPEN:"SET_AI_PANEL_OPEN",ADD_AI_MESSAGE:"ADD_AI_MESSAGE",CLEAR_AI_MESSAGES:"CLEAR_AI_MESSAGES",SET_AI_LOADING:"SET_AI_LOADING",SET_DIRTY:"SET_DIRTY",RESET_WIZARD:"RESET_WIZARD",LOAD_SAVED_STATE:"LOAD_SAVED_STATE"},bt=()=>({currentStep:O.TEMPLATE_SELECTION,selectedTemplate:null,isCustom:!1,reportName:"",reportType:"custom",parameters:{reportingPeriod:M.LAST_MONTH,customStartDate:null,customEndDate:null,includeCoverPage:!0,includeTableOfContents:!1},sections:[],previewHtml:null,previewError:null,isGenerating:!1,lastPreviewTime:null,aiPanelOpen:!1,aiMessages:[],aiLoading:!1,isDirty:!1,savedTemplateId:null});function Ss(a,t){switch(t.type){case E.SET_STEP:return{...a,currentStep:t.payload};case E.NEXT_STEP:return{...a,currentStep:Math.min(a.currentStep+1,O.PREVIEW_GENERATE)};case E.PREV_STEP:return{...a,currentStep:Math.max(a.currentStep-1,O.TEMPLATE_SELECTION)};case E.SELECT_TEMPLATE:{const{template:s,isCustom:n}=t.payload,r=s?.template_definition?.sections||[],l=s?.default_parameters||a.parameters;return{...a,selectedTemplate:s,isCustom:n||!1,reportName:n?"Custom Report":s?.name||"New Report",reportType:s?.report_type||"custom",sections:r.map(o=>{const i=De(o.type);return{...o,id:o.id||`section_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,name:o.name||i?.name||o.type,config:{...i?.defaultConfig||{},...o.config||{}}}}),parameters:{...a.parameters,...l},isDirty:!1,previewHtml:null,previewError:null}}case E.CLEAR_TEMPLATE:return{...a,selectedTemplate:null,isCustom:!0,sections:[],isDirty:!1};case E.SET_REPORT_NAME:return{...a,reportName:t.payload,isDirty:!0};case E.SET_PARAMETERS:return{...a,parameters:{...a.parameters,...t.payload},isDirty:!0,previewHtml:null};case E.UPDATE_PARAMETER:return{...a,parameters:{...a.parameters,[t.payload.key]:t.payload.value},isDirty:!0,previewHtml:null};case E.ADD_SECTION:{const s=t.payload;return{...a,sections:[...a.sections,s],isDirty:!0,previewHtml:null}}case E.REMOVE_SECTION:{const s=t.payload;return{...a,sections:a.sections.filter(n=>n.id!==s),isDirty:!0,previewHtml:null}}case E.UPDATE_SECTION:{const{sectionId:s,updates:n}=t.payload;return{...a,sections:a.sections.map(r=>r.id===s?{...r,...n,config:{...r.config,...n.config}}:r),isDirty:!0,previewHtml:null}}case E.REORDER_SECTIONS:{const{fromIndex:s,toIndex:n}=t.payload,r=[...a.sections],[l]=r.splice(s,1);return r.splice(n,0,l),{...a,sections:r,isDirty:!0,previewHtml:null}}case E.CLEAR_SECTIONS:return{...a,sections:[],isDirty:!0,previewHtml:null};case E.SET_SECTIONS:return{...a,sections:t.payload,isDirty:!0,previewHtml:null};case E.SET_PREVIEW:return{...a,previewHtml:t.payload.html,previewError:null,lastPreviewTime:new Date().toISOString(),isGenerating:!1};case E.CLEAR_PREVIEW:return{...a,previewHtml:null,previewError:null,lastPreviewTime:null};case E.SET_GENERATING:return{...a,isGenerating:t.payload,previewError:t.payload?null:a.previewError};case E.SET_PREVIEW_ERROR:return{...a,previewError:t.payload,isGenerating:!1};case E.TOGGLE_AI_PANEL:return{...a,aiPanelOpen:!a.aiPanelOpen};case E.SET_AI_PANEL_OPEN:return{...a,aiPanelOpen:t.payload};case E.ADD_AI_MESSAGE:return{...a,aiMessages:[...a.aiMessages,{...t.payload,id:`msg_${Date.now()}`,timestamp:new Date().toISOString()}]};case E.CLEAR_AI_MESSAGES:return{...a,aiMessages:[]};case E.SET_AI_LOADING:return{...a,aiLoading:t.payload};case E.SET_DIRTY:return{...a,isDirty:t.payload};case E.RESET_WIZARD:return bt();case E.LOAD_SAVED_STATE:return{...a,...t.payload,isDirty:!1};default:return a}}const Et=c.createContext(null);function Ns({children:a}){const{projectId:t,projectName:s,projectRef:n}=Se(),{user:r,profile:l,role:o}=xe(),[i,u]=c.useReducer(Ss,null,bt),d=c.useCallback(j=>{u({type:E.SET_STEP,payload:j})},[]),h=c.useCallback(()=>{u({type:E.NEXT_STEP})},[]),g=c.useCallback(()=>{u({type:E.PREV_STEP})},[]),x=c.useCallback(j=>{j>=O.TEMPLATE_SELECTION&&j<=O.PREVIEW_GENERATE&&u({type:E.SET_STEP,payload:j})},[]),p=c.useCallback((j,N=!1)=>{u({type:E.SELECT_TEMPLATE,payload:{template:j,isCustom:N}})},[]),y=c.useCallback(()=>{u({type:E.SELECT_TEMPLATE,payload:{template:null,isCustom:!0}})},[]),v=c.useCallback(()=>{u({type:E.CLEAR_TEMPLATE})},[]),b=c.useCallback(j=>{u({type:E.SET_REPORT_NAME,payload:j})},[]),f=c.useCallback(j=>{u({type:E.SET_PARAMETERS,payload:j})},[]),m=c.useCallback((j,N)=>{u({type:E.UPDATE_PARAMETER,payload:{key:j,value:N}})},[]),S=c.useCallback((j,N={})=>{try{const G=Ke(j,N);return u({type:E.ADD_SECTION,payload:G}),G}catch{return null}},[]),I=c.useCallback((j,N,G={})=>{try{const Z=Ke(j,G);return u({type:E.SET_SECTIONS,payload:[...i.sections.slice(0,N),Z,...i.sections.slice(N)]}),Z}catch{return null}},[i.sections]),D=c.useCallback(j=>{u({type:E.REMOVE_SECTION,payload:j})},[]),$=c.useCallback((j,N)=>{u({type:E.UPDATE_SECTION,payload:{sectionId:j,updates:N}})},[]),L=c.useCallback((j,N)=>{u({type:E.UPDATE_SECTION,payload:{sectionId:j,updates:{config:N}}})},[]),z=c.useCallback((j,N)=>{j!==N&&u({type:E.REORDER_SECTIONS,payload:{fromIndex:j,toIndex:N}})},[]),C=c.useCallback(j=>{const N=i.sections.findIndex(G=>G.id===j);N>0&&z(N,N-1)},[i.sections,z]),R=c.useCallback(j=>{const N=i.sections.findIndex(G=>G.id===j);N<i.sections.length-1&&z(N,N+1)},[i.sections,z]),T=c.useCallback(()=>{u({type:E.CLEAR_SECTIONS})},[]),w=c.useCallback(j=>{const N=i.sections.find(ge=>ge.id===j);if(!N)return null;const G={...N,id:`section_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,name:`${N.name} (Copy)`,config:{...N.config}},Z=i.sections.findIndex(ge=>ge.id===j);return u({type:E.SET_SECTIONS,payload:[...i.sections.slice(0,Z+1),G,...i.sections.slice(Z+1)]}),G},[i.sections]),B=c.useCallback(j=>{u({type:E.SET_PREVIEW,payload:{html:j}})},[]),k=c.useCallback(()=>{u({type:E.CLEAR_PREVIEW})},[]),H=c.useCallback(j=>{u({type:E.SET_GENERATING,payload:j})},[]),ce=c.useCallback(j=>{u({type:E.SET_PREVIEW_ERROR,payload:j})},[]),J=c.useCallback(()=>{u({type:E.TOGGLE_AI_PANEL})},[]),A=c.useCallback(j=>{u({type:E.SET_AI_PANEL_OPEN,payload:j})},[]),W=c.useCallback(j=>{u({type:E.ADD_AI_MESSAGE,payload:j})},[]),ee=c.useCallback(()=>{u({type:E.CLEAR_AI_MESSAGES})},[]),q=c.useCallback(j=>{u({type:E.SET_AI_LOADING,payload:j})},[]),te=c.useCallback(j=>{u({type:E.SET_DIRTY,payload:j})},[]),U=c.useCallback(()=>{u({type:E.RESET_WIZARD})},[]),F=c.useCallback(j=>{u({type:E.LOAD_SAVED_STATE,payload:j})},[]),P=c.useCallback(j=>{switch(j){case O.TEMPLATE_SELECTION:return!0;case O.PARAMETERS:return i.selectedTemplate!==null||i.isCustom;case O.SECTION_BUILDER:return i.reportName.trim().length>0;case O.PREVIEW_GENERATE:return i.sections.length>0;default:return!1}},[i.selectedTemplate,i.isCustom,i.reportName,i.sections]),de=c.useCallback(j=>{const N={valid:!0,errors:[]};switch(j){case O.TEMPLATE_SELECTION:!i.selectedTemplate&&!i.isCustom&&(N.valid=!1,N.errors.push("Please select a template or choose to start from scratch"));break;case O.PARAMETERS:i.reportName.trim()||(N.valid=!1,N.errors.push("Report name is required")),i.parameters.reportingPeriod===M.CUSTOM&&(!i.parameters.customStartDate||!i.parameters.customEndDate)&&(N.valid=!1,N.errors.push("Custom date range requires start and end dates"));break;case O.SECTION_BUILDER:i.sections.length===0&&(N.valid=!1,N.errors.push("Add at least one section to your report")),i.sections.forEach((G,Z)=>{const ge=Nt(G);ge.valid||(N.valid=!1,N.errors.push(`Section ${Z+1}: ${ge.errors.join(", ")}`))});break;case O.PREVIEW_GENERATE:for(let G=1;G<O.PREVIEW_GENERATE;G++){const Z=de(G);Z.valid||(N.valid=!1,N.errors.push(...Z.errors))}break}return N},[i]),ue=c.useMemo(()=>P(i.currentStep+1),[P,i.currentStep]),Te=c.useMemo(()=>i.currentStep>O.TEMPLATE_SELECTION,[i.currentStep]),me=c.useCallback(()=>({metadata:{title:i.reportName,subtitle:"{{project.name}}",generatedAt:"{{generated.date}}",generatedBy:"{{generated.by}}",includeCoverPage:i.parameters.includeCoverPage,includeTableOfContents:i.parameters.includeTableOfContents},parameters:[{id:"reportingPeriod",value:i.parameters.reportingPeriod},...i.parameters.reportingPeriod===M.CUSTOM?[{id:"customStartDate",value:i.parameters.customStartDate},{id:"customEndDate",value:i.parameters.customEndDate}]:[]],sections:i.sections}),[i.reportName,i.parameters,i.sections]),pe=c.useCallback(()=>({projectId:t,projectName:s,projectRef:n,reportingPeriod:i.parameters.reportingPeriod,customDateRange:i.parameters.reportingPeriod===M.CUSTOM?{startDate:i.parameters.customStartDate,endDate:i.parameters.customEndDate}:null,userRole:o||l?.role||"viewer",user:{id:r?.id,email:r?.email,full_name:l?.full_name},project:{id:t,name:s,ref:n}}),[t,s,n,i.parameters,o,l,r]),Ve=c.useCallback(j=>i.sections.find(N=>N.id===j)||null,[i.sections]),Ye=c.useCallback(j=>i.sections.findIndex(N=>N.id===j),[i.sections]),We=c.useCallback(j=>i.sections.some(N=>N.type===j),[i.sections]),He=c.useCallback(()=>i.sections.length,[i.sections]),St=c.useMemo(()=>({...i,setStep:d,nextStep:h,prevStep:g,goToStep:x,canProceed:ue,canGoBack:Te,selectTemplate:p,startFromScratch:y,clearTemplate:v,setReportName:b,setParameters:f,updateParameter:m,addSection:S,addSectionAtIndex:I,removeSection:D,updateSection:$,updateSectionConfig:L,reorderSections:z,moveSectionUp:C,moveSectionDown:R,clearSections:T,duplicateSection:w,getSectionById:Ve,getSectionIndex:Ye,hasSectionType:We,getSectionCount:He,setPreview:B,clearPreview:k,setGenerating:H,setPreviewError:ce,toggleAIPanel:J,setAIPanelOpen:A,addAIMessage:W,clearAIMessages:ee,setAILoading:q,setDirty:te,resetWizard:U,loadSavedState:F,canProceedToStep:P,getStepValidation:de,buildTemplateDefinition:me,getReportContext:pe}),[i,d,h,g,x,ue,Te,p,y,v,b,f,m,S,I,D,$,L,z,C,R,T,w,Ve,Ye,We,He,B,k,H,ce,J,A,W,ee,q,te,U,F,P,de,me,pe]);return e.jsx(Et.Provider,{value:St,children:a})}function oe(){const a=c.useContext(Et);if(!a)throw new Error("useReportBuilder must be used within a ReportBuilderProvider");return a}function Cs(){const{aiPanelOpen:a,aiMessages:t,aiLoading:s,toggleAIPanel:n,setAIPanelOpen:r,addAIMessage:l,clearAIMessages:o,setAILoading:i}=oe();return{isOpen:a,messages:t,isLoading:s,toggle:n,setOpen:r,addMessage:l,clearMessages:o,setLoading:i}}function Ts(){const{previewHtml:a,previewError:t,isGenerating:s,lastPreviewTime:n,setPreview:r,clearPreview:l,setGenerating:o,setPreviewError:i}=oe();return{html:a,error:t,isGenerating:s,lastPreviewTime:n,setPreview:r,clearPreview:l,setGenerating:o,setPreviewError:i,hasPreview:!!a,needsRefresh:!a&&!s}}const tt=[{id:"default-monthly-retro",name:"Monthly Retrospective",code:"monthly_retrospective",description:"Comprehensive monthly review with backward and forward-looking sections. Ideal for programme steering meetings.",report_type:K.MONTHLY_RETROSPECTIVE,is_system:!0,template_definition:{metadata:{title:"Monthly Retrospective Report",subtitle:"{{project.name}}",includeCoverPage:!0,includeTableOfContents:!0},sections:[{id:"exec-summary",type:"executive_summary",name:"Executive Summary"},{id:"milestone-summary",type:"milestone_summary",name:"Milestone Summary"},{id:"deliverable-summary",type:"deliverable_summary",name:"Deliverable Summary"},{id:"kpi-performance",type:"kpi_performance",name:"KPI Performance"},{id:"budget-analysis",type:"budget_analysis",name:"Budget Analysis"},{id:"raid-summary",type:"raid_summary",name:"RAID Summary"},{id:"forward-look",type:"forward_look",name:"Forward Look"},{id:"lessons-learned",type:"lessons_learned",name:"Lessons Learned"}]},default_parameters:{reportingPeriod:"lastMonth",includeCoverPage:!0,includeTableOfContents:!0}},{id:"default-status-summary",name:"Project Status Summary",code:"status_summary",description:"Quick status overview for stakeholder updates. Focuses on key metrics and immediate priorities.",report_type:K.STATUS_SUMMARY,is_system:!0,template_definition:{metadata:{title:"Project Status Summary",subtitle:"{{project.name}}",includeCoverPage:!1,includeTableOfContents:!1},sections:[{id:"exec-summary",type:"executive_summary",name:"Executive Summary"},{id:"milestone-summary",type:"milestone_summary",name:"Milestone Status"},{id:"kpi-performance",type:"kpi_performance",name:"Key Metrics"},{id:"raid-summary",type:"raid_summary",name:"Key Risks & Issues",config:{raidTypes:["risk","issue"]}}]},default_parameters:{reportingPeriod:"lastMonth",includeCoverPage:!1,includeTableOfContents:!1}},{id:"default-budget-variance",name:"Budget Variance Report",code:"budget_variance",description:"Financial analysis with detailed budget vs actual comparison. Includes cost breakdowns and forecasts.",report_type:K.BUDGET_VARIANCE,is_system:!0,template_definition:{metadata:{title:"Budget Variance Report",subtitle:"{{project.name}}",includeCoverPage:!0,includeTableOfContents:!1},sections:[{id:"budget-analysis",type:"budget_analysis",name:"Budget Overview"},{id:"timesheet-summary",type:"timesheet_summary",name:"Timesheet Analysis"},{id:"expense-summary",type:"expense_summary",name:"Expense Analysis"},{id:"resource-summary",type:"resource_summary",name:"Resource Utilisation"}]},default_parameters:{reportingPeriod:"lastMonth",includeCoverPage:!0,includeTableOfContents:!1}}],_s={[K.MONTHLY_RETROSPECTIVE]:Re,[K.STATUS_SUMMARY]:It,[K.BUDGET_VARIANCE]:Mt,[K.CUSTOM]:X};function st({template:a,isSelected:t,onClick:s}){const n=_s[a.report_type]||X,r=a.template_definition?.sections?.length||0,l=Qe[a.report_type]||Qe[K.CUSTOM];return e.jsxs("div",{className:`template-card ${t?"selected":""}`,onClick:s,role:"button",tabIndex:0,onKeyDown:o=>o.key==="Enter"&&s(),children:[e.jsxs("div",{className:"template-card-header",children:[e.jsx("div",{className:"template-card-icon",children:e.jsx(n,{size:22})}),e.jsxs("div",{className:"template-card-info",children:[e.jsx("h5",{className:"template-card-name",children:a.name}),e.jsx("span",{className:"template-card-type",children:l.label})]}),t&&e.jsx("div",{className:"template-card-check",children:e.jsx(ie,{size:20})})]}),e.jsx("p",{className:"template-card-description",children:a.description}),e.jsxs("div",{className:"template-card-footer",children:[e.jsxs("div",{className:"template-card-sections",children:[e.jsx(Ne,{size:14}),e.jsxs("span",{children:[r," section",r!==1?"s":""]})]}),a.is_system&&e.jsxs("span",{className:"template-card-badge",children:[e.jsx(ie,{size:12}),"System"]})]})]})}function ws({isSelected:a,onClick:t}){return e.jsxs("div",{className:`template-card scratch-card ${a?"selected":""}`,onClick:t,role:"button",tabIndex:0,onKeyDown:s=>s.key==="Enter"&&t(),children:[e.jsxs("div",{className:"template-card-header",children:[e.jsx("div",{className:"template-card-icon",children:e.jsx(kt,{size:22})}),e.jsxs("div",{className:"template-card-info",children:[e.jsx("h5",{className:"template-card-name",children:"Start from Scratch"}),e.jsx("span",{className:"template-card-type",children:"Custom"})]}),a&&e.jsx("div",{className:"template-card-check",children:e.jsx(ie,{size:20})})]}),e.jsx("p",{className:"template-card-description",children:"Build a completely custom report by selecting individual sections. Perfect for unique reporting needs."}),e.jsx("div",{className:"template-card-footer",children:e.jsxs("div",{className:"template-card-sections",children:[e.jsx(Ne,{size:14}),e.jsx("span",{children:"0 sections (add your own)"})]})})]})}function As({onClick:a}){return e.jsxs("div",{className:"template-card ai-card",onClick:a,role:"button",tabIndex:0,onKeyDown:t=>t.key==="Enter"&&a(),children:[e.jsxs("div",{className:"template-card-header",children:[e.jsx("div",{className:"template-card-icon",children:e.jsx(se,{size:22})}),e.jsxs("div",{className:"template-card-info",children:[e.jsx("h5",{className:"template-card-name",children:"Describe What You Need"}),e.jsx("span",{className:"template-card-type",children:"AI-Powered"})]})]}),e.jsx("p",{className:"template-card-description",children:"Tell the AI assistant what kind of report you need, and it will suggest the best template and sections for you."}),e.jsxs("div",{className:"template-card-footer",children:[e.jsxs("div",{className:"template-card-sections",children:[e.jsx(se,{size:14}),e.jsx("span",{children:"AI will configure"})]}),e.jsxs("span",{className:"template-card-badge",children:[e.jsx(se,{size:12}),"AI"]})]})]})}function Ds({template:a,isCustom:t}){if(!a&&!t)return null;const s=t?"Start from Scratch":a?.name,n=t?"You'll add sections manually in the next steps":`${a?.template_definition?.sections?.length||0} pre-configured sections`;return e.jsxs("div",{className:"selected-template-info",children:[e.jsx(ie,{size:20}),e.jsxs("div",{className:"selected-template-info-content",children:[e.jsxs("strong",{children:["Selected: ",s]}),e.jsx("span",{children:n})]}),e.jsx(Me,{size:20,style:{color:"var(--color-text-secondary)"}})]})}function at(){const{projectId:a}=Se(),{selectedTemplate:t,isCustom:s,selectTemplate:n,startFromScratch:r,setAIPanelOpen:l,nextStep:o}=oe(),[i,u]=c.useState([]),[d,h]=c.useState(!0),[g,x]=c.useState(null);c.useEffect(()=>{async function m(){if(!a){h(!1);return}try{h(!0),x(null);const S=await we.getTemplatesForProject(a,{activeOnly:!0,includeSystem:!0});!S||S.length===0?u(tt):u(S)}catch{x("Failed to load templates"),u(tt)}finally{h(!1)}}m()},[a]);const p=c.useCallback(m=>{n(m,!1)},[n]),y=c.useCallback(()=>{r()},[r]),v=c.useCallback(()=>{r(),l(!0)},[r,l]),b=c.useMemo(()=>({system:i.filter(S=>S.is_system),custom:i.filter(S=>!S.is_system)}),[i]),f=c.useCallback(m=>t?.id===m.id&&!s,[t,s]);return d?e.jsx("div",{className:"template-selector",children:e.jsxs("div",{className:"template-loading",children:[e.jsx(Ge,{size:"large"}),e.jsx("p",{children:"Loading templates..."})]})}):e.jsxs("div",{className:"template-selector",children:[e.jsxs("div",{className:"template-selector-header",children:[e.jsx("h3",{children:"Choose a Template"}),e.jsx("p",{children:"Select a pre-built template or start from scratch to create your report."})]}),g&&e.jsxs("div",{className:"template-error",style:{padding:"var(--space-md)",background:"var(--color-danger-light)",borderRadius:"var(--radius)",marginBottom:"var(--space-lg)",color:"var(--color-danger)",fontSize:"var(--font-size-sm)"},children:[g,". Using default templates instead."]}),e.jsxs("div",{className:"template-categories",children:[b.system.length>0&&e.jsxs("div",{className:"template-category",children:[e.jsxs("div",{className:"template-category-header",children:[e.jsx(Ne,{size:18}),e.jsx("h4",{children:"Pre-built Templates"})]}),e.jsx("div",{className:"template-grid",children:b.system.map(m=>e.jsx(st,{template:m,isSelected:f(m),onClick:()=>p(m)},m.id))})]}),b.custom.length>0&&e.jsxs("div",{className:"template-category",children:[e.jsxs("div",{className:"template-category-header",children:[e.jsx(Rt,{size:18}),e.jsx("h4",{children:"Saved Templates"})]}),e.jsx("div",{className:"template-grid",children:b.custom.map(m=>e.jsx(st,{template:m,isSelected:f(m),onClick:()=>p(m)},m.id))})]}),e.jsxs("div",{className:"template-category",children:[e.jsxs("div",{className:"template-category-header",children:[e.jsx(se,{size:18}),e.jsx("h4",{children:"Start Fresh"})]}),e.jsxs("div",{className:"template-grid",children:[e.jsx(ws,{isSelected:s&&!t,onClick:y}),e.jsx(As,{onClick:v})]})]})]}),e.jsx(Ds,{template:t,isCustom:s&&!t})]})}const Rs={[M.LAST_MONTH]:Re,[M.LAST_QUARTER]:pt,[M.LAST_6_MONTHS]:zt,[M.YEAR_TO_DATE]:Lt,[M.CUSTOM]:le};function Ms(a){const t=new Date;switch(a){case M.LAST_MONTH:{const s=Y(t,1);return{start:fe(s),end:he(s),label:V(s,"MMMM yyyy")}}case M.LAST_QUARTER:{const s=as(et(t)),n=et(s);return{start:n,end:s,label:`Q${Math.ceil((n.getMonth()+1)/3)} ${n.getFullYear()}`}}case M.LAST_6_MONTHS:{const s=Y(t,6);return{start:fe(s),end:he(Y(t,1)),label:`${V(s,"MMM yyyy")} - ${V(Y(t,1),"MMM yyyy")}`}}case M.YEAR_TO_DATE:return{start:dt(t),end:t,label:`Jan - ${V(t,"MMM yyyy")}`};case M.CUSTOM:default:return{start:null,end:null,label:"Select dates"}}}function rt(a){if(!a)return"";try{const t=new Date(a);return V(t,"d MMM yyyy")}catch{return""}}function nt(a){if(!a)return"";try{const t=new Date(a);return V(t,"yyyy-MM-dd")}catch{return""}}function Is({period:a,config:t,isSelected:s,onClick:n,dateRange:r}){const l=Rs[a]||Re;return e.jsxs("div",{className:`parameter-card ${s?"selected":""}`,onClick:n,role:"button",tabIndex:0,onKeyDown:o=>o.key==="Enter"&&n(),children:[e.jsx("div",{className:"parameter-card-icon",children:e.jsx(l,{size:20})}),e.jsxs("div",{className:"parameter-card-content",children:[e.jsx("span",{className:"parameter-card-label",children:t.label}),e.jsx("span",{className:"parameter-card-description",children:a===M.CUSTOM?t.description:r.label})]}),s&&e.jsx("div",{className:"parameter-card-check",children:e.jsx(ie,{size:16})})]})}function it({id:a,checked:t,onChange:s,label:n,description:r,icon:l}){return e.jsxs("div",{className:"parameter-toggle",children:[e.jsxs("div",{className:"parameter-toggle-info",children:[l&&e.jsx(l,{size:18,className:"parameter-toggle-icon"}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:a,className:"parameter-toggle-label",children:n}),r&&e.jsx("span",{className:"parameter-toggle-description",children:r})]})]}),e.jsx("button",{id:a,type:"button",role:"switch","aria-checked":t,className:`toggle-switch ${t?"active":""}`,onClick:()=>s(!t),children:e.jsx("span",{className:"toggle-switch-thumb"})})]})}function ks({template:a,isCustom:t}){if(t&&!a)return e.jsxs("div",{className:"parameter-template-info custom",children:[e.jsx(le,{size:18}),e.jsxs("div",{children:[e.jsx("strong",{children:"Custom Report"}),e.jsx("span",{children:"You're building a report from scratch"})]})]});if(!a)return null;const s=a.template_definition?.sections?.length||0;return e.jsxs("div",{className:"parameter-template-info",children:[e.jsx(X,{size:18}),e.jsxs("div",{children:[e.jsx("strong",{children:a.name}),e.jsxs("span",{children:[s," pre-configured section",s!==1?"s":""]})]})]})}function Ps(){const{reportName:a,setReportName:t,parameters:s,updateParameter:n,selectedTemplate:r,isCustom:l}=oe(),[o,i]=c.useState(""),[u,d]=c.useState(""),h=c.useMemo(()=>Object.keys(M).reduce((m,S)=>(m[M[S]]=Ms(M[S]),m),{}),[]);c.useEffect(()=>{a.trim().length===0?i("Report name is required"):a.trim().length<3?i("Report name must be at least 3 characters"):a.trim().length>100?i("Report name must be less than 100 characters"):i("")},[a]),c.useEffect(()=>{s.reportingPeriod===M.CUSTOM?!s.customStartDate||!s.customEndDate?d("Both start and end dates are required for custom range"):new Date(s.customStartDate)>new Date(s.customEndDate)?d("Start date must be before end date"):d(""):d("")},[s.reportingPeriod,s.customStartDate,s.customEndDate]);const g=c.useCallback(m=>{t(m.target.value)},[t]),x=c.useCallback(m=>{n("reportingPeriod",m),m!==M.CUSTOM&&(n("customStartDate",null),n("customEndDate",null))},[n]),p=c.useCallback(m=>{n("customStartDate",m.target.value||null)},[n]),y=c.useCallback(m=>{n("customEndDate",m.target.value||null)},[n]),v=c.useCallback(m=>{n("includeCoverPage",m)},[n]),b=c.useCallback(m=>{n("includeTableOfContents",m)},[n]),f=c.useMemo(()=>s.reportingPeriod===M.CUSTOM?s.customStartDate&&s.customEndDate?`${rt(s.customStartDate)} - ${rt(s.customEndDate)}`:"Select date range":h[s.reportingPeriod]?.label||"",[s.reportingPeriod,s.customStartDate,s.customEndDate,h]);return e.jsxs("div",{className:"parameter-config",children:[e.jsxs("div",{className:"parameter-header",children:[e.jsx("h3",{children:"Configure Report"}),e.jsx("p",{children:"Set up your report parameters before adding sections."})]}),e.jsx(ks,{template:r,isCustom:l}),e.jsxs("div",{className:"parameter-section",children:[e.jsxs("div",{className:"parameter-section-header",children:[e.jsx(X,{size:18}),e.jsx("h4",{children:"Report Name"})]}),e.jsxs("div",{className:"parameter-input-group",children:[e.jsx("input",{type:"text",id:"reportName",className:`parameter-input ${o?"error":""}`,value:a,onChange:g,placeholder:"Enter report name...",maxLength:100}),o&&e.jsxs("div",{className:"parameter-error",children:[e.jsx(Q,{size:14}),e.jsx("span",{children:o})]}),e.jsxs("div",{className:"parameter-hint",children:[e.jsx(mt,{size:12}),e.jsx("span",{children:"This will appear as the title on your generated report"})]})]})]}),e.jsxs("div",{className:"parameter-section",children:[e.jsxs("div",{className:"parameter-section-header",children:[e.jsx(Re,{size:18}),e.jsx("h4",{children:"Reporting Period"})]}),e.jsx("div",{className:"parameter-period-grid",children:Object.entries(Ct).map(([m,S])=>e.jsx(Is,{period:m,config:S,isSelected:s.reportingPeriod===m,onClick:()=>x(m),dateRange:h[m]},m))}),s.reportingPeriod===M.CUSTOM&&e.jsxs("div",{className:"parameter-custom-dates",children:[e.jsxs("div",{className:"parameter-date-inputs",children:[e.jsxs("div",{className:"parameter-date-field",children:[e.jsx("label",{htmlFor:"startDate",children:"Start Date"}),e.jsx("input",{type:"date",id:"startDate",className:`parameter-input ${u?"error":""}`,value:nt(s.customStartDate),onChange:p})]}),e.jsx("span",{className:"parameter-date-separator",children:"to"}),e.jsxs("div",{className:"parameter-date-field",children:[e.jsx("label",{htmlFor:"endDate",children:"End Date"}),e.jsx("input",{type:"date",id:"endDate",className:`parameter-input ${u?"error":""}`,value:nt(s.customEndDate),onChange:y})]})]}),u&&e.jsxs("div",{className:"parameter-error",children:[e.jsx(Q,{size:14}),e.jsx("span",{children:u})]})]}),e.jsxs("div",{className:"parameter-period-summary",children:[e.jsx(pt,{size:16}),e.jsxs("span",{children:["Report will cover: ",e.jsx("strong",{children:f})]})]})]}),e.jsxs("div",{className:"parameter-section",children:[e.jsxs("div",{className:"parameter-section-header",children:[e.jsx(le,{size:18}),e.jsx("h4",{children:"Document Options"})]}),e.jsxs("div",{className:"parameter-toggles",children:[e.jsx(it,{id:"includeCoverPage",checked:s.includeCoverPage,onChange:v,label:"Include Cover Page",description:"Add a professional title page with project details",icon:Pt}),e.jsx(it,{id:"includeTableOfContents",checked:s.includeTableOfContents,onChange:b,label:"Include Table of Contents",description:"Add a navigation section listing all report sections",icon:Ot})]})]})]})}function Os({sectionType:a,isAdded:t,onAdd:s,isRestricted:n}){const r=a.icon,l=c.useCallback(()=>{n||s(a.type)},[s,a.type,n]),o=c.useCallback(i=>{(i.key==="Enter"||i.key===" ")&&(i.preventDefault(),l())},[l]);return e.jsxs("div",{className:`section-library-item ${t?"added":""} ${n?"restricted":""}`,onClick:l,onKeyDown:o,role:"button",tabIndex:n?-1:0,title:n?"Not available for your role":t?"Already added - click to add another":`Add ${a.name}`,children:[e.jsx("div",{className:"section-library-item-icon",children:r&&e.jsx(r,{size:18})}),e.jsxs("div",{className:"section-library-item-content",children:[e.jsx("span",{className:"section-library-item-name",children:a.name}),e.jsx("span",{className:"section-library-item-description",children:a.description})]}),e.jsx("div",{className:"section-library-item-action",children:n?e.jsx(Bt,{size:14}):t?e.jsx("div",{className:"section-library-item-badge added",children:e.jsx(ie,{size:12})}):e.jsx(je,{size:16})})]})}function Ls({category:a,sections:t,isExpanded:s,onToggle:n,onAddSection:r,isSectionTypeAdded:l}){const o=ut[a],i=o?.icon,u=c.useMemo(()=>t.filter(d=>l(d.type)).length,[t,l]);return e.jsxs("div",{className:`section-library-category ${s?"expanded":"collapsed"}`,children:[e.jsxs("button",{type:"button",className:"section-library-category-header",onClick:n,"aria-expanded":s,children:[e.jsx("span",{className:"section-library-category-toggle",children:s?e.jsx(Ie,{size:16}):e.jsx(Me,{size:16})}),i&&e.jsx("span",{className:"section-library-category-icon",children:e.jsx(i,{size:16})}),e.jsx("span",{className:"section-library-category-name",children:o?.label||a}),e.jsxs("span",{className:"section-library-category-count",children:[t.length," type",t.length!==1?"s":"",u>0&&e.jsxs("span",{className:"section-library-category-added",children:["(",u," added)"]})]})]}),s&&e.jsxs("div",{className:"section-library-category-content",children:[e.jsx("p",{className:"section-library-category-description",children:o?.description}),e.jsx("div",{className:"section-library-category-items",children:t.map(d=>e.jsx(Os,{sectionType:d,isAdded:l(d.type),isRestricted:!1,onAdd:r},d.type))})]})]})}function zs({value:a,onChange:t,onClear:s}){return e.jsxs("div",{className:"section-library-search",children:[e.jsx(Ut,{size:16,className:"section-library-search-icon"}),e.jsx("input",{type:"text",className:"section-library-search-input",placeholder:"Search sections...",value:a,onChange:n=>t(n.target.value)}),a&&e.jsx("button",{type:"button",className:"section-library-search-clear",onClick:s,"aria-label":"Clear search",children:e.jsx(Ce,{size:14})})]})}function Us({sectionTypesByCategory:a,orderedCategories:t,onAddSection:s,isSectionTypeAdded:n}){const[r,l]=c.useState(()=>t.reduce((p,y)=>(p[y]=!0,p),{})),[o,i]=c.useState(""),u=c.useCallback(p=>{l(y=>({...y,[p]:!y[p]}))},[]),d=c.useCallback(()=>{i("")},[]),h=c.useMemo(()=>{if(!o.trim())return a;const p=o.toLowerCase(),y={};return Object.entries(a).forEach(([v,b])=>{const f=b.filter(m=>m.name.toLowerCase().includes(p)||m.description.toLowerCase().includes(p));f.length>0&&(y[v]=f)}),y},[a,o]),g=c.useMemo(()=>Object.values(a).reduce((p,y)=>p+y.length,0),[a]),x=c.useMemo(()=>Object.values(h).reduce((p,y)=>p+y.length,0),[h]);return e.jsxs("div",{className:"section-library",children:[e.jsx(zs,{value:o,onChange:i,onClear:d}),e.jsx("div",{className:"section-library-summary",children:o?e.jsxs("span",{children:[x," of ",g," sections match"]}):e.jsxs("span",{children:[g," section types available"]})}),e.jsxs("div",{className:"section-library-categories",children:[t.map(p=>{const y=h[p];return!y||y.length===0?null:e.jsx(Ls,{category:p,sections:y,isExpanded:r[p],onToggle:()=>u(p),onAddSection:s,isSectionTypeAdded:n},p)}),o&&x===0&&e.jsxs("div",{className:"section-library-no-results",children:[e.jsxs("p",{children:['No sections match "',o,'"']}),e.jsx("button",{type:"button",className:"btn btn-sm btn-secondary",onClick:d,children:"Clear Search"})]})]})]})}function Bs({section:a,index:t,isFirst:s,isLast:n,isHighlighted:r,isDragging:l,isDragOver:o,onRemove:i,onConfigure:u,onDuplicate:d,onMoveUp:h,onMoveDown:g,onDragStart:x,onDragEnd:p,onDragOver:y,onDrop:v}){const b=De(a.type),f=b?.icon,m=b?.category||"content",S=c.useRef(null),I=c.useCallback(k=>{k.dataTransfer.effectAllowed="move",k.dataTransfer.setData("text/plain",t.toString()),x(t),setTimeout(()=>{S.current&&S.current.classList.add("dragging")},0)},[t,x]),D=c.useCallback(k=>{S.current&&S.current.classList.remove("dragging"),p()},[p]),$=c.useCallback(k=>{k.preventDefault(),k.dataTransfer.dropEffect="move",y(t)},[t,y]),L=c.useCallback(k=>{k.preventDefault();const H=parseInt(k.dataTransfer.getData("text/plain"),10);!isNaN(H)&&H!==t&&v(H,t)},[t,v]),z=c.useCallback(k=>{k.stopPropagation(),i(a.id)},[a.id,i]),C=c.useCallback(k=>{k.stopPropagation(),u(a)},[a,u]),R=c.useCallback(k=>{k.stopPropagation(),d(a.id)},[a.id,d]),T=c.useCallback(k=>{k.stopPropagation(),h(t)},[t,h]),w=c.useCallback(k=>{k.stopPropagation(),g(t)},[t,g]),B=!a.config||Object.keys(a.config).length===0;return e.jsxs("div",{ref:S,className:`section-list-item ${r?"highlighted":""} ${l?"dragging":""} ${o?"drag-over":""} category-${m}`,draggable:!0,onDragStart:I,onDragEnd:D,onDragOver:$,onDrop:L,onClick:C,role:"listitem",children:[e.jsx("div",{className:"section-list-item-handle",title:"Drag to reorder",children:e.jsx(Ft,{size:16})}),e.jsx("div",{className:"section-list-item-number",children:t+1}),e.jsx("div",{className:"section-list-item-icon",children:f&&e.jsx(f,{size:18})}),e.jsxs("div",{className:"section-list-item-info",children:[e.jsx("span",{className:"section-list-item-name",children:a.name||b?.name||"Unnamed Section"}),e.jsx("span",{className:"section-list-item-type",children:b?.name||a.type})]}),B&&e.jsx("div",{className:"section-list-item-warning",title:"Configuration may need review",children:e.jsx(Q,{size:14})}),e.jsxs("div",{className:"section-list-item-actions",children:[e.jsx("button",{type:"button",className:"section-list-item-btn",onClick:T,disabled:s,title:"Move up","aria-label":"Move section up",children:e.jsx(ht,{size:14})}),e.jsx("button",{type:"button",className:"section-list-item-btn",onClick:w,disabled:n,title:"Move down","aria-label":"Move section down",children:e.jsx(Ie,{size:14})}),e.jsx("button",{type:"button",className:"section-list-item-btn",onClick:C,title:"Configure section","aria-label":"Configure section",children:e.jsx(le,{size:14})}),e.jsx("button",{type:"button",className:"section-list-item-btn",onClick:R,title:"Duplicate section","aria-label":"Duplicate section",children:e.jsx(ft,{size:14})}),e.jsx("button",{type:"button",className:"section-list-item-btn danger",onClick:z,title:"Remove section","aria-label":"Remove section",children:e.jsx(Ce,{size:14})})]})]})}function Fs({onDrop:a,isActive:t}){const s=c.useCallback(r=>{r.preventDefault(),r.dataTransfer.dropEffect="move"},[]),n=c.useCallback(r=>{r.preventDefault();const l=parseInt(r.dataTransfer.getData("text/plain"),10);isNaN(l)||a(l)},[a]);return e.jsx("div",{className:`section-list-dropzone ${t?"active":""}`,onDragOver:s,onDrop:n,children:e.jsx("span",{children:"Drop section here"})})}function Gs({sections:a,onRemove:t,onReorder:s,onConfigure:n,onDuplicate:r,highlightedSection:l}){const[o,i]=c.useState(null),[u,d]=c.useState(null),h=c.useCallback(f=>{i(f)},[]),g=c.useCallback(()=>{i(null),d(null)},[]),x=c.useCallback(f=>{d(f)},[]),p=c.useCallback((f,m)=>{i(null),d(null),f!==m&&s(f,m)},[s]),y=c.useCallback(f=>{i(null),d(null);const m=a.length-1;f!==m&&s(f,m)},[a.length,s]),v=c.useCallback(f=>{f>0&&s(f,f-1)},[s]),b=c.useCallback(f=>{f<a.length-1&&s(f,f+1)},[a.length,s]);return e.jsxs("div",{className:"section-list",role:"list",children:[a.map((f,m)=>e.jsx(Bs,{section:f,index:m,isFirst:m===0,isLast:m===a.length-1,isHighlighted:l===f.id,isDragging:o===m,isDragOver:u===m&&o!==m,onRemove:t,onConfigure:n,onDuplicate:r,onMoveUp:v,onMoveDown:b,onDragStart:h,onDragEnd:g,onDragOver:x,onDrop:p},f.id)),o!==null&&o!==a.length-1&&e.jsx(Fs,{onDrop:y,isActive:u===a.length})]})}function $s({id:a,label:t,description:s,options:n=[],value:r,onChange:l,required:o=!1,disabled:i=!1,error:u}){const d=h=>{const g=h.target.value,x=n.find(p=>String(p.value)===g);l(x?x.value:g)};return e.jsxs("div",{className:`config-field config-field-select ${u?"has-error":""}`,children:[e.jsxs("label",{htmlFor:a,className:"config-field-label",children:[t,o&&e.jsx("span",{className:"config-field-required",children:"*"})]}),s&&e.jsx("p",{className:"config-field-description",children:s}),e.jsxs("div",{className:"config-select-wrapper",children:[e.jsx("select",{id:a,name:a,value:r??"",onChange:d,disabled:i,className:"config-select",children:n.map(h=>e.jsx("option",{value:h.value,children:h.label},h.value))}),e.jsx(Ie,{size:16,className:"config-select-icon"})]}),u&&e.jsx("p",{className:"config-field-error",children:u})]})}function Vs({id:a,label:t,description:s,options:n=[],value:r=[],onChange:l,required:o=!1,disabled:i=!1,error:u}){const d=Array.isArray(r)?r:[r].filter(Boolean),h=c.useCallback(f=>d.includes(f),[d]),g=c.useCallback(f=>{if(i)return;let m;if(f==="all")h("all")?m=[]:m=["all"];else{const S=d.filter(I=>I!=="all");h(f)?m=S.filter(I=>I!==f):m=[...S,f]}l(m)},[d,h,i,l]),x=c.useCallback(()=>{if(i)return;const f=n.filter(S=>S.value!=="all"),m=f.every(S=>h(S.value));l(m?[]:f.map(S=>S.value))},[n,h,i,l]),p=n.filter(f=>f.value!=="all"),y=d.filter(f=>f!=="all").length,v=n.some(f=>f.value==="all"),b=h("all")||p.length>0&&y===p.length;return e.jsxs("div",{className:`config-field config-field-multiselect ${u?"has-error":""}`,children:[e.jsxs("div",{className:"config-field-header",children:[e.jsxs("label",{htmlFor:a,className:"config-field-label",children:[t,o&&e.jsx("span",{className:"config-field-required",children:"*"})]}),p.length>2&&!v&&e.jsx("button",{type:"button",className:"config-multiselect-toggle",onClick:x,disabled:i,children:b?"Clear All":"Select All"})]}),s&&e.jsx("p",{className:"config-field-description",children:s}),e.jsx("div",{className:"config-multiselect-options",children:n.map(f=>{const m=h(f.value),S=f.value==="all";return e.jsxs("button",{type:"button",className:`config-multiselect-option ${m?"selected":""} ${S?"all-option":""}`,onClick:()=>g(f.value),disabled:i,children:[e.jsx("span",{className:"config-multiselect-checkbox",children:m?e.jsx(Gt,{size:16}):e.jsx($t,{size:16})}),e.jsx("span",{className:"config-multiselect-label",children:f.label})]},f.value)})}),y>0&&!h("all")&&e.jsxs("p",{className:"config-field-hint",children:[y," item",y!==1?"s":""," selected"]}),u&&e.jsx("p",{className:"config-field-error",children:u})]})}function Ys({id:a,label:t,description:s,value:n=!1,onChange:r,disabled:l=!1,error:o}){const i=()=>{l||r(!n)},u=d=>{(d.key==="Enter"||d.key===" ")&&(d.preventDefault(),i())};return e.jsxs("div",{className:`config-field config-field-boolean ${o?"has-error":""}`,children:[e.jsxs("div",{className:"config-boolean-row",children:[e.jsxs("div",{className:"config-boolean-info",children:[e.jsx("label",{htmlFor:a,className:"config-field-label config-boolean-label",onClick:i,children:t}),s&&e.jsx("p",{className:"config-field-description",children:s})]}),e.jsx("button",{type:"button",id:a,role:"switch","aria-checked":n,className:`toggle-switch ${n?"active":""}`,onClick:i,onKeyDown:u,disabled:l,children:e.jsx("span",{className:"toggle-switch-thumb"})})]}),o&&e.jsx("p",{className:"config-field-error",children:o})]})}function Ws({id:a,label:t,description:s,value:n,onChange:r,min:l,max:o,step:i=1,required:u=!1,disabled:d=!1,error:h}){const[g,x]=c.useState(null),p=typeof n=="number"?n:parseInt(n,10)||0,y=c.useCallback(D=>l!==void 0&&D<l?`Minimum value is ${l}`:o!==void 0&&D>o?`Maximum value is ${o}`:null,[l,o]),v=D=>{const $=D.target.value;if($===""){r(l!==void 0?l:0),x(null);return}const L=parseInt($,10);if(isNaN(L)){x("Please enter a valid number");return}const z=y(L);x(z);let C=L;l!==void 0&&L<l&&(C=l),o!==void 0&&L>o&&(C=o),r(C)},b=()=>{if(d)return;const D=p+i;o!==void 0&&D>o||(r(D),x(null))},f=()=>{if(d)return;const D=p-i;l!==void 0&&D<l||(r(D),x(null))},m=h||g,S=o===void 0||p<o,I=l===void 0||p>l;return e.jsxs("div",{className:`config-field config-field-number ${m?"has-error":""}`,children:[e.jsxs("label",{htmlFor:a,className:"config-field-label",children:[t,u&&e.jsx("span",{className:"config-field-required",children:"*"})]}),s&&e.jsx("p",{className:"config-field-description",children:s}),e.jsxs("div",{className:"config-number-wrapper",children:[e.jsx("button",{type:"button",className:"config-number-btn",onClick:f,disabled:d||!I,"aria-label":"Decrease value",children:e.jsx(Vt,{size:16})}),e.jsx("input",{type:"number",id:a,name:a,value:p,onChange:v,min:l,max:o,step:i,disabled:d,className:"config-number-input"}),e.jsx("button",{type:"button",className:"config-number-btn",onClick:b,disabled:d||!S,"aria-label":"Increase value",children:e.jsx(je,{size:16})})]}),(l!==void 0||o!==void 0)&&e.jsx("p",{className:"config-field-hint",children:l!==void 0&&o!==void 0?`Range: ${l} - ${o}`:l!==void 0?`Minimum: ${l}`:`Maximum: ${o}`}),m&&e.jsx("p",{className:"config-field-error",children:m})]})}function Hs({id:a,label:t,description:s,placeholder:n,value:r="",onChange:l,rows:o=4,maxLength:i,required:u=!1,disabled:d=!1,aiAssist:h=!1,onAIAssist:g,error:x}){const[p,y]=c.useState(!1),v=c.useCallback(I=>{const D=I.target.value;i&&D.length>i||l(D)},[l,i]),b=c.useCallback(()=>{g?g(a,r):alert("AI assistance will be available in the next update.")},[g,a,r]),f=r?.length||0,m=i&&f>=i*.9,S=i&&f>=i;return e.jsxs("div",{className:`config-field config-field-textarea ${x?"has-error":""}`,children:[e.jsxs("div",{className:"config-field-header",children:[e.jsxs("label",{htmlFor:a,className:"config-field-label",children:[t,u&&e.jsx("span",{className:"config-field-required",children:"*"})]}),h&&e.jsxs("button",{type:"button",className:"config-textarea-ai-btn",onClick:b,disabled:d,title:"Get AI assistance with this content",children:[e.jsx(se,{size:14}),e.jsx("span",{children:"AI Assist"})]})]}),s&&e.jsx("p",{className:"config-field-description",children:s}),e.jsx("div",{className:`config-textarea-wrapper ${p?"focused":""}`,children:e.jsx("textarea",{id:a,name:a,value:r,onChange:v,placeholder:n,rows:o,disabled:d,className:"config-textarea",onFocus:()=>y(!0),onBlur:()=>y(!1)})}),e.jsxs("div",{className:"config-textarea-footer",children:[i&&e.jsxs("span",{className:`config-textarea-count ${m?"near-limit":""} ${S?"at-limit":""}`,children:[f," / ",i]}),x&&e.jsxs("span",{className:"config-field-error",children:[e.jsx(Q,{size:12}),x]})]})]})}function qs({id:a,label:t,description:s,placeholder:n,value:r="",onChange:l,maxLength:o,required:i=!1,disabled:u=!1,error:d}){const h=c.useCallback(g=>{const x=g.target.value;o&&x.length>o||l(x)},[l,o]);return e.jsxs("div",{className:`config-field config-field-text ${d?"has-error":""}`,children:[e.jsxs("label",{htmlFor:a,className:"config-field-label",children:[t,i&&e.jsx("span",{className:"config-field-required",children:"*"})]}),s&&e.jsx("p",{className:"config-field-description",children:s}),e.jsx("input",{type:"text",id:a,name:a,value:r,onChange:h,placeholder:n,maxLength:o,disabled:u,className:"config-text-input"}),d&&e.jsx("p",{className:"config-field-error",children:d})]})}function Ks({fieldId:a,fieldConfig:t,value:s,onChange:n,disabled:r,onAIAssist:l}){const{type:o,label:i,description:u,options:d,placeholder:h,rows:g,min:x,max:p,aiAssist:y,default:v}=t,f={id:a,label:i,description:u,value:s!==void 0?s:v,onChange:m=>n(a,m),disabled:r};switch(o){case re.SELECT:return e.jsx($s,{...f,options:d||[]});case re.MULTI_SELECT:return e.jsx(Vs,{...f,options:d||[]});case re.BOOLEAN:return e.jsx(Ys,{...f});case re.NUMBER:return e.jsx(Ws,{...f,min:x,max:p});case re.TEXTAREA:return e.jsx(Hs,{...f,placeholder:h,rows:g||4,aiAssist:y,onAIAssist:l});case re.TEXT:return e.jsx(qs,{...f,placeholder:h});default:return e.jsxs("div",{className:"config-field-unknown",children:["Unknown field type: ",o]})}}function Qs({section:a,onSave:t,onClose:s,onAIAssist:n}){const{role:r,profile:l}=xe(),o=r||l?.role||"viewer",i=c.useMemo(()=>De(a?.type),[a?.type]),u=c.useMemo(()=>i?.configSchema?Tt(i.configSchema,o):{},[i,o]),[d,h]=c.useState(()=>({...a?.config})),[g,x]=c.useState(!1),[p,y]=c.useState({});c.useEffect(()=>{a?.config&&(h({...a.config}),x(!1),y({}))},[a]);const v=c.useCallback((C,R)=>{h(T=>({...T,[C]:R})),x(!0),y(T=>{const w={...T};return delete w[C],w})},[]),b=c.useCallback(C=>{if(!C.showWhen)return!0;const[R,T]=Object.entries(C.showWhen)[0];return d[R]===T},[d]),f=c.useMemo(()=>Object.entries(u).filter(([C,R])=>b(R)).map(([C,R])=>({fieldId:C,fieldConfig:R})),[u,b]),m=c.useCallback(()=>{const C={};let R=!0;return f.forEach(({fieldId:T,fieldConfig:w})=>{const B=d[T];if(w.required&&(B===void 0||B===""||B===null)){C[T]="This field is required",R=!1;return}switch(w.type){case re.NUMBER:B!=null&&(w.min!==void 0&&B<w.min&&(C[T]=`Minimum value is ${w.min}`,R=!1),w.max!==void 0&&B>w.max&&(C[T]=`Maximum value is ${w.max}`,R=!1));break;case re.MULTI_SELECT:w.required&&(!Array.isArray(B)||B.length===0)&&(C[T]="Please select at least one option",R=!1);break}}),y(C),R},[f,d]),S=c.useCallback(()=>{m()&&(t(a.id,d),s())},[m,t,a?.id,d,s]),I=c.useCallback(()=>{s()},[g,s]),D=c.useCallback(C=>{C.target===C.currentTarget&&I()},[I]);c.useEffect(()=>{const C=R=>{R.key==="Escape"&&I()};return window.addEventListener("keydown",C),()=>window.removeEventListener("keydown",C)},[I]);const $=c.useCallback((C,R)=>{n&&n(C,R,a)},[n,a]);if(!a||!i)return null;const L=i.icon,z=Object.keys(p).length>0;return e.jsx("div",{className:"section-config-modal-overlay",onClick:D,children:e.jsxs("div",{className:"section-config-modal",onClick:C=>C.stopPropagation(),role:"dialog","aria-modal":"true","aria-labelledby":"config-modal-title",children:[e.jsxs("div",{className:"section-config-modal-header",children:[e.jsxs("div",{className:"section-config-modal-title",children:[L&&e.jsx(L,{size:20}),e.jsxs("h3",{id:"config-modal-title",children:["Configure: ",a.name]})]}),e.jsx("button",{type:"button",className:"section-config-close",onClick:I,"aria-label":"Close modal",children:e.jsx(Ce,{size:20})})]}),e.jsxs("div",{className:"section-config-modal-body",children:[e.jsx("div",{className:"section-config-description",children:e.jsx("p",{children:i.description})}),f.length>0?e.jsx("div",{className:"section-config-fields",children:f.map(({fieldId:C,fieldConfig:R})=>e.jsx(Ks,{fieldId:C,fieldConfig:R,value:d[C],onChange:v,disabled:!1,onAIAssist:$},C))}):e.jsxs("div",{className:"section-config-no-options",children:[e.jsx(le,{size:24}),e.jsx("p",{children:"This section has no configurable options."})]}),z&&e.jsxs("div",{className:"section-config-errors",children:[e.jsx(Q,{size:16}),e.jsx("span",{children:"Please fix the errors above before saving."})]})]}),e.jsxs("div",{className:"section-config-modal-footer",children:[e.jsx("div",{className:"section-config-footer-left",children:g&&e.jsxs("span",{className:"section-config-dirty-indicator",children:[e.jsx("span",{className:"dirty-dot"}),"Unsaved changes"]})}),e.jsxs("div",{className:"section-config-footer-right",children:[e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:I,children:"Cancel"}),e.jsxs("button",{type:"button",className:"btn btn-primary",onClick:S,disabled:z,children:[e.jsx(gt,{size:16}),"Save Configuration"]})]})]})]})})}function Zs({sectionCount:a,reportName:t}){const s=a>0;return e.jsxs("div",{className:"section-builder-header",children:[e.jsxs("div",{className:"section-builder-header-main",children:[e.jsx("h3",{children:"Build Your Report"}),e.jsxs("p",{children:['Add and arrange sections for "',t,'"']})]}),e.jsx("div",{className:`section-builder-status ${s?"valid":"warning"}`,children:s?e.jsxs(e.Fragment,{children:[e.jsx(gt,{size:16}),e.jsxs("span",{children:[a," section",a!==1?"s":""," added"]})]}):e.jsxs(e.Fragment,{children:[e.jsx(Q,{size:16}),e.jsx("span",{children:"Add at least one section"})]})})]})}function Xs({onOpenAI:a}){return e.jsxs("div",{className:"section-builder-ai-bar",onClick:a,children:[e.jsx(se,{size:18}),e.jsxs("div",{className:"section-builder-ai-content",children:[e.jsx("span",{className:"section-builder-ai-title",children:"Need help choosing sections?"}),e.jsx("span",{className:"section-builder-ai-subtitle",children:"Ask the AI assistant to suggest sections based on your needs"})]}),e.jsx("button",{type:"button",className:"section-builder-ai-btn",children:"Get Suggestions"})]})}function Js({onOpenLibrary:a}){return e.jsxs("div",{className:"section-builder-empty",children:[e.jsx("div",{className:"section-builder-empty-icon",children:e.jsx(Ne,{size:40,strokeWidth:1.5})}),e.jsx("h4",{children:"No sections yet"}),e.jsx("p",{children:"Start building your report by adding sections from the library."}),e.jsx("div",{className:"section-builder-empty-actions",children:e.jsx("button",{type:"button",className:"btn btn-primary",onClick:a,children:"Browse Section Library"})})]})}function ea(){return e.jsxs("div",{className:"section-builder-instructions",children:[e.jsx(mt,{size:14}),e.jsxs("div",{children:[e.jsx("strong",{children:"How to build your report:"}),e.jsxs("ul",{children:[e.jsx("li",{children:"Click sections in the library to add them"}),e.jsx("li",{children:"Drag sections to reorder them"}),e.jsx("li",{children:"Click the gear icon to configure a section"}),e.jsx("li",{children:"Click the X to remove a section"})]})]})]})}function ta(){const{sections:a,reportName:t,addSection:s,removeSection:n,reorderSections:r,updateSectionConfig:l,duplicateSection:o,setAIPanelOpen:i}=oe(),{role:u,profile:d}=xe(),h=u||d?.role||"viewer",[g,x]=c.useState(null),[p,y]=c.useState(null),v=c.useMemo(()=>_t(h),[h]),b=c.useMemo(()=>Object.entries(ut).sort((T,w)=>T[1].order-w[1].order).map(([T])=>T),[]),f=c.useCallback(T=>{const w=s(T);w&&(y(w.id),setTimeout(()=>y(null),1500))},[s]),m=c.useCallback(T=>{n(T)},[n]),S=c.useCallback((T,w)=>{r(T,w)},[r]),I=c.useCallback(T=>{x(T)},[]),D=c.useCallback((T,w)=>{l(T,w)},[l]),$=c.useCallback(()=>{x(null)},[]),L=c.useCallback((T,w,B)=>{i(!0)},[i]),z=c.useCallback(T=>{const w=o(T);w&&(y(w.id),setTimeout(()=>y(null),1500))},[o]),C=c.useCallback(()=>{i(!0)},[i]),R=c.useCallback(T=>a.some(w=>w.type===T),[a]);return e.jsxs("div",{className:"section-builder",children:[e.jsx(Zs,{sectionCount:a.length,reportName:t}),e.jsx(Xs,{onOpenAI:C}),e.jsxs("div",{className:"section-builder-layout",children:[e.jsxs("div",{className:"section-builder-library-panel",children:[e.jsxs("div",{className:"section-builder-panel-header",children:[e.jsx(Ne,{size:18}),e.jsx("h4",{children:"Section Library"})]}),e.jsx(Us,{sectionTypesByCategory:v,orderedCategories:b,onAddSection:f,isSectionTypeAdded:R})]}),e.jsxs("div",{className:"section-builder-list-panel",children:[e.jsxs("div",{className:"section-builder-panel-header",children:[e.jsx(le,{size:18}),e.jsxs("h4",{children:["Report Sections (",a.length,")"]})]}),a.length===0?e.jsx(Js,{onOpenLibrary:()=>{}}):e.jsxs(e.Fragment,{children:[e.jsx(ea,{}),e.jsx(Gs,{sections:a,onRemove:m,onReorder:S,onConfigure:I,onDuplicate:z,highlightedSection:p})]})]})]}),g&&e.jsx(Qs,{section:g,onSave:D,onClose:$,onAIAssist:L})]})}function sa({zoom:a,onZoomIn:t,onZoomOut:s,onReset:n}){return e.jsxs("div",{className:"preview-zoom-controls",children:[e.jsx("button",{className:"preview-zoom-btn",onClick:s,disabled:a<=50,title:"Zoom Out",children:e.jsx(Yt,{size:16})}),e.jsxs("span",{className:"preview-zoom-level",children:[a,"%"]}),e.jsx("button",{className:"preview-zoom-btn",onClick:t,disabled:a>=200,title:"Zoom In",children:e.jsx(Wt,{size:16})}),e.jsx("button",{className:"preview-zoom-btn",onClick:n,disabled:a===100,title:"Reset Zoom",children:e.jsx(Ht,{size:16})})]})}const aa=c.forwardRef(function({html:t,title:s="Report"},n){const r=c.useRef(null),[l,o]=c.useState(!0),[i,u]=c.useState(!1),[d,h]=c.useState(100);c.useImperativeHandle(n,()=>({print:()=>{if(r.current&&r.current.contentWindow)try{r.current.contentWindow.focus(),r.current.contentWindow.print()}catch{const v=window.open("","_blank");v&&(v.document.write(t),v.document.close(),v.focus(),v.print())}},getHtml:()=>t}),[t]),c.useEffect(()=>{if(!(!t||!r.current)){o(!0),u(!1);try{const y=r.current,v=y.contentDocument||y.contentWindow?.document;if(v)v.open(),v.write(t),v.close(),y.contentWindow&&(y.contentWindow.onload=()=>{o(!1)}),setTimeout(()=>{o(!1)},500);else throw new Error("Could not access iframe document")}catch{u(!0),o(!1)}}},[t]);const g=c.useCallback(()=>{h(y=>Math.min(y+25,200))},[]),x=c.useCallback(()=>{h(y=>Math.max(y-25,50))},[]),p=c.useCallback(()=>{h(100)},[]);return t?e.jsxs("div",{className:"preview-frame-container",children:[e.jsx(sa,{zoom:d,onZoomIn:g,onZoomOut:x,onReset:p}),l&&e.jsxs("div",{className:"preview-frame-loading",children:[e.jsx(Ae,{size:32,className:"ai-spinner"}),e.jsx("p",{children:"Loading preview..."})]}),i&&e.jsxs("div",{className:"preview-frame-error",children:[e.jsx(Q,{size:32}),e.jsx("p",{children:"Failed to load preview"})]}),e.jsx("div",{className:"preview-frame-wrapper",style:{transform:`scale(${d/100})`,transformOrigin:"top center"},children:e.jsx("iframe",{ref:r,title:s,className:"preview-frame",sandbox:"allow-same-origin allow-scripts"})})]}):e.jsxs("div",{className:"preview-frame-empty",children:[e.jsx(X,{size:48}),e.jsx("p",{children:"No preview content available"})]})});function ra({isOpen:a,onClose:t,onSave:s,defaultName:n,isSaving:r}){const[l,o]=c.useState(n||""),[i,u]=c.useState(""),[d,h]=c.useState(""),[g,x]=c.useState(!1),[p,y]=c.useState("");c.useEffect(()=>{if(a){o(n||"");const b=(n||"").toLowerCase().replace(/[^a-z0-9\s]/g,"").replace(/\s+/g,"_").substring(0,50);u(b),h(""),x(!1),y("")}},[a,n]);const v=()=>{if(!l.trim()){y("Template name is required");return}if(!i.trim()){y("Template code is required");return}s({name:l.trim(),code:i.trim(),description:d.trim(),is_default:g})};return a?e.jsx("div",{className:"section-config-modal-overlay",onClick:t,children:e.jsxs("div",{className:"section-config-modal",onClick:b=>b.stopPropagation(),children:[e.jsxs("div",{className:"section-config-modal-header",children:[e.jsxs("div",{className:"section-config-modal-title",children:[e.jsx(Ue,{size:20}),e.jsx("h3",{children:"Save as Template"})]}),e.jsx("button",{className:"section-config-close",onClick:t,disabled:r,children:e.jsx("span",{children:""})})]}),e.jsxs("div",{className:"section-config-modal-body",children:[e.jsx("div",{className:"section-config-description",children:e.jsx("p",{children:"Save your current report configuration as a reusable template. This template will be available for future reports in this project."})}),e.jsxs("div",{className:"section-config-fields",children:[e.jsxs("div",{className:"config-field",children:[e.jsxs("label",{className:"config-field-label",children:["Template Name ",e.jsx("span",{className:"config-field-required",children:"*"})]}),e.jsx("input",{type:"text",className:"config-text-input",value:l,onChange:b=>{o(b.target.value),y("")},placeholder:"e.g., Monthly Retrospective",disabled:r})]}),e.jsxs("div",{className:"config-field",children:[e.jsxs("label",{className:"config-field-label",children:["Template Code ",e.jsx("span",{className:"config-field-required",children:"*"})]}),e.jsx("input",{type:"text",className:"config-text-input",value:i,onChange:b=>{u(b.target.value.toLowerCase().replace(/[^a-z0-9_]/g,"")),y("")},placeholder:"e.g., monthly_retrospective",disabled:r}),e.jsx("p",{className:"config-field-description",children:"Unique identifier for this template (lowercase letters, numbers, underscores only)"})]}),e.jsxs("div",{className:"config-field",children:[e.jsx("label",{className:"config-field-label",children:"Description"}),e.jsx("textarea",{className:"config-textarea",value:d,onChange:b=>h(b.target.value),placeholder:"Brief description of what this template is for...",rows:3,disabled:r})]}),e.jsx("div",{className:"config-field config-field-boolean",children:e.jsxs("div",{className:"config-boolean-row",children:[e.jsxs("div",{className:"config-boolean-info",children:[e.jsx("label",{className:"config-field-label config-boolean-label",children:"Set as Default Template"}),e.jsx("p",{className:"config-field-description",children:"This template will be pre-selected when creating new reports"})]}),e.jsx("button",{type:"button",className:`toggle-switch ${g?"active":""}`,onClick:()=>x(!g),disabled:r,children:e.jsx("span",{className:"toggle-switch-thumb"})})]})}),p&&e.jsxs("div",{className:"section-config-errors",children:[e.jsx(Q,{size:16}),e.jsx("span",{children:p})]})]})]}),e.jsxs("div",{className:"section-config-modal-footer",children:[e.jsx("div",{className:"section-config-footer-left"}),e.jsxs("div",{className:"section-config-footer-right",children:[e.jsx("button",{className:"btn btn-secondary",onClick:t,disabled:r,children:"Cancel"}),e.jsx("button",{className:"btn btn-primary",onClick:v,disabled:r,children:r?e.jsxs(e.Fragment,{children:[e.jsx(Ae,{size:16,className:"ai-spinner"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ue,{size:16}),"Save Template"]})})]})]})]})}):null}function na({warnings:a,onDismiss:t}){return!a||a.length===0?null:e.jsxs("div",{className:"preview-warnings",children:[e.jsxs("div",{className:"preview-warnings-header",children:[e.jsx(Zt,{size:16}),e.jsxs("span",{children:[a.length," warning",a.length!==1?"s":""," during generation"]}),e.jsx("button",{className:"preview-warnings-dismiss",onClick:t,title:"Dismiss warnings",children:""})]}),e.jsx("ul",{className:"preview-warnings-list",children:a.map((s,n)=>e.jsx("li",{children:s},n))})]})}function ia(){const{reportName:a,sections:t,parameters:s,isCustom:n,selectedTemplate:r,buildTemplateDefinition:l,getReportContext:o,setPreview:i,setGenerating:u,setPreviewError:d,isDirty:h}=oe(),{html:g,error:x,isGenerating:p,lastPreviewTime:y,hasPreview:v}=Ts(),{projectId:b}=Se(),{user:f,profile:m}=xe(),[S,I]=c.useState([]),[D,$]=c.useState(!0),[L,z]=c.useState(!1),[C,R]=c.useState(!1),[T,w]=c.useState(!1),[B,k]=c.useState(null),H=c.useRef(null),ce=c.useRef(null),J=c.useCallback(async()=>{if(!(!b||t.length===0)){u(!0),d(null),I([]),w(!1),ce.current=Date.now();try{const U=l(),F=o(),P={name:a,report_type:n?"custom":r?.report_type||"custom",template_definition:U,default_parameters:s},de=new Map;for(const me of t)try{const pe=await bs.fetchSectionData(me.type,me.config||{},F);de.set(me.id,{success:!0,data:pe})}catch(pe){de.set(me.id,{success:!1,error:pe?.message||pe?.toString()||"Unknown error"})}const ue=wt.renderReport(P,de,F),Te=Date.now()-ce.current;k(Te),ue.warnings&&ue.warnings.length>0&&(I(ue.warnings),$(!0)),i(ue.html)}catch(U){d(U.message||"Failed to generate report preview")}finally{u(!1)}}},[b,t,a,s,n,r,l,o,i,u,d]);c.useEffect(()=>{!v&&!p&&t.length>0&&J()},[]);const A=c.useCallback(()=>{H.current&&H.current.print()},[]),W=c.useCallback(()=>{if(!g)return;const U=new Blob([g],{type:"text/html"}),F=URL.createObjectURL(U),P=document.createElement("a");P.href=F,P.download=`${a.replace(/[^a-z0-9]/gi,"_").toLowerCase()}_report.html`,document.body.appendChild(P),P.click(),document.body.removeChild(P),URL.revokeObjectURL(F)},[g,a]),ee=c.useCallback(async U=>{if(b){R(!0);try{const F=l(),P={project_id:b,name:U.name,code:U.code,description:U.description||"",report_type:"custom",template_definition:F,default_parameters:s,is_system:!1,is_default:U.is_default,is_active:!0};await we.createTemplate(P),z(!1),w(!0),setTimeout(()=>w(!1),5e3)}catch(F){alert(`Failed to save template: ${F.message}`)}finally{R(!1)}}},[b,l,s]),q=c.useCallback(()=>{if(!g)return;const U=new Blob([g],{type:"text/html"}),F=URL.createObjectURL(U);window.open(F,"_blank")},[g]),te=c.useCallback(async()=>{if(g)try{await navigator.clipboard.writeText(g)}catch{}},[g]);return e.jsxs("div",{className:"preview-generate",children:[e.jsxs("div",{className:"preview-header",children:[e.jsxs("div",{className:"preview-header-main",children:[e.jsx("h3",{children:"Preview & Generate"}),e.jsx("p",{children:"Review your report and generate the final output"})]}),y&&!p&&e.jsxs("div",{className:"preview-generation-info",children:[e.jsx(Ze,{size:14}),e.jsxs("span",{children:["Generated ",new Date(y).toLocaleTimeString(),B&&` (${(B/1e3).toFixed(1)}s)`]})]})]}),T&&e.jsxs("div",{className:"preview-success-banner",children:[e.jsx(Ze,{size:16}),e.jsx("span",{children:"Template saved successfully! It will appear in the template selector for future reports."})]}),D&&S.length>0&&e.jsx(na,{warnings:S,onDismiss:()=>$(!1)}),e.jsxs("div",{className:"preview-toolbar",children:[e.jsxs("div",{className:"preview-toolbar-left",children:[e.jsx("button",{className:"btn btn-secondary preview-btn",onClick:J,disabled:p||t.length===0,children:p?e.jsxs(e.Fragment,{children:[e.jsx(Ae,{size:16,className:"ai-spinner"}),"Generating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ze,{size:16}),"Refresh Preview"]})}),h&&v&&e.jsxs("span",{className:"preview-dirty-hint",children:[e.jsx(Q,{size:14}),"Report configuration changed - refresh to see updates"]})]}),e.jsxs("div",{className:"preview-toolbar-right",children:[e.jsx("button",{className:"btn btn-secondary preview-btn",onClick:te,disabled:!v||p,title:"Copy HTML to clipboard",children:e.jsx(ft,{size:16})}),e.jsx("button",{className:"btn btn-secondary preview-btn",onClick:q,disabled:!v||p,title:"Open in new tab",children:e.jsx(qt,{size:16})}),e.jsxs("button",{className:"btn btn-secondary preview-btn",onClick:W,disabled:!v||p,children:[e.jsx(Kt,{size:16}),"Download HTML"]}),e.jsxs("button",{className:"btn btn-secondary preview-btn",onClick:()=>z(!0),disabled:p||t.length===0,children:[e.jsx(Ue,{size:16}),"Save as Template"]}),e.jsxs("button",{className:"btn btn-primary preview-btn",onClick:A,disabled:!v||p,children:[e.jsx(Qt,{size:16}),"Print / PDF"]})]})]}),e.jsx("div",{className:"preview-container",children:p?e.jsxs("div",{className:"preview-loading",children:[e.jsx(Ae,{size:48,className:"ai-spinner"}),e.jsx("h4",{children:"Generating Report..."}),e.jsxs("p",{children:["Fetching data and rendering ",t.length," section",t.length!==1?"s":""]}),e.jsx("div",{className:"preview-loading-sections",children:t.map((U,F)=>e.jsxs("span",{className:"preview-loading-section",children:[F+1,". ",U.name]},U.id))})]}):x?e.jsxs("div",{className:"preview-error",children:[e.jsx(Q,{size:48}),e.jsx("h4",{children:"Generation Failed"}),e.jsx("p",{children:x}),e.jsxs("button",{className:"btn btn-primary",onClick:J,children:[e.jsx(ze,{size:16}),"Try Again"]})]}):v?e.jsx(aa,{ref:H,html:g,title:a}):e.jsxs("div",{className:"preview-empty",children:[e.jsx(Xe,{size:48}),e.jsx("h4",{children:"No Preview Available"}),e.jsx("p",{children:'Click "Refresh Preview" to generate your report'}),e.jsxs("button",{className:"btn btn-primary",onClick:J,disabled:t.length===0,children:[e.jsx(Xe,{size:16}),"Generate Preview"]})]})}),e.jsxs("div",{className:"preview-summary",children:[e.jsxs("div",{className:"preview-summary-item",children:[e.jsx(X,{size:16}),e.jsx("span",{children:e.jsx("strong",{children:a})})]}),e.jsxs("div",{className:"preview-summary-item",children:[e.jsx(le,{size:16}),e.jsxs("span",{children:[t.length," section",t.length!==1?"s":""]})]}),s.reportingPeriod&&e.jsx("div",{className:"preview-summary-item",children:e.jsxs("span",{children:["Period: ",s.reportingPeriod]})})]}),e.jsx(ra,{isOpen:L,onClose:()=>z(!1),onSave:ee,defaultName:a,isSaving:C})]})}const la=[{id:"suggest-monthly",label:"Suggest sections for monthly report",prompt:"I need to create a monthly retrospective report. What sections should I include?"},{id:"suggest-status",label:"Suggest sections for status update",prompt:"Help me build a project status update report."},{id:"explain-sections",label:"Explain available sections",prompt:"What sections are available and what do they show?"},{id:"generate-summary",label:"Generate executive summary",prompt:"Generate an executive summary for my report."}];function oa({message:a,onActionClick:t,isLatest:s}){const[n,r]=c.useState(!0),l=a.role==="user",o=a.actions&&a.actions.length>0;return e.jsxs("div",{className:`ai-message ${l?"user":"assistant"}`,children:[e.jsx("div",{className:"ai-message-avatar",children:l?e.jsx(Jt,{size:16}):e.jsx(Be,{size:16})}),e.jsxs("div",{className:"ai-message-content",children:[e.jsx("div",{className:"ai-message-text",children:a.content}),o&&e.jsxs("div",{className:"ai-message-actions",children:[e.jsxs("button",{className:"ai-actions-toggle",onClick:()=>r(!n),children:[e.jsxs("span",{children:["Suggested Actions (",a.actions.length,")"]}),n?e.jsx(ht,{size:14}):e.jsx(Ie,{size:14})]}),n&&e.jsx("div",{className:"ai-actions-list",children:a.actions.map((i,u)=>e.jsx(ca,{action:i,onClick:()=>t(i),disabled:!s},u))})]}),a.error&&e.jsxs("div",{className:"ai-message-error",children:[e.jsx(Q,{size:14}),e.jsx("span",{children:a.error})]}),e.jsx("div",{className:"ai-message-time",children:new Date(a.timestamp).toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"})})]})]})}function ca({action:a,onClick:t,disabled:s}){const n=()=>{switch(a.type){case"ADD_SECTION":return e.jsx(je,{size:16});case"UPDATE_SECTION_CONFIG":return e.jsx(le,{size:16});case"GENERATED_CONTENT":return e.jsx(X,{size:16});default:return e.jsx(yt,{size:16})}},r=()=>{switch(a.type){case"ADD_SECTION":return`Add "${a.sectionName}"`;case"UPDATE_SECTION_CONFIG":return"Update Configuration";case"GENERATED_CONTENT":return`Generated ${a.contentType?.replace("_"," ")}`;default:return"Action"}};return e.jsxs("button",{className:`ai-action-card ${s?"disabled":""}`,onClick:t,disabled:s,children:[e.jsx("div",{className:"ai-action-icon",children:n()}),e.jsxs("div",{className:"ai-action-info",children:[e.jsx("span",{className:"ai-action-title",children:r()}),e.jsx("span",{className:"ai-action-description",children:a.message})]}),!s&&e.jsxs("div",{className:"ai-action-apply",children:[e.jsx(ie,{size:14}),e.jsx("span",{children:"Apply"})]})]})}function da({suggestions:a,onSelect:t,disabled:s}){return!a||a.length===0?null:e.jsxs("div",{className:"ai-suggestions",children:[e.jsxs("div",{className:"ai-suggestions-label",children:[e.jsx(yt,{size:12}),e.jsx("span",{children:"Suggested sections to add:"})]}),e.jsx("div",{className:"ai-suggestions-chips",children:a.slice(0,5).map((n,r)=>e.jsxs("button",{className:"ai-suggestion-chip",onClick:()=>t(n),disabled:s,children:[e.jsx(je,{size:12}),n.name]},r))})]})}function ua({onSelect:a,disabled:t}){return e.jsxs("div",{className:"ai-quick-prompts",children:[e.jsx("div",{className:"ai-quick-prompts-label",children:"Quick actions:"}),e.jsx("div",{className:"ai-quick-prompts-list",children:la.map(s=>e.jsx("button",{className:"ai-quick-prompt",onClick:()=>a(s.prompt),disabled:t,children:s.label},s.id))})]})}function ma({onClose:a}){const{sections:t,reportName:s,selectedTemplate:n,parameters:r,currentStep:l,addSection:o,updateSectionConfig:i}=oe(),{messages:u,isLoading:d,addMessage:h,setLoading:g,clearMessages:x}=Cs(),{projectId:p,projectName:y,projectRef:v}=Se(),{user:b,profile:f}=xe(),[m,S]=c.useState(""),[I,D]=c.useState([]),[$,L]=c.useState(null),z=c.useRef(null),C=c.useRef(null);c.useEffect(()=>{z.current?.scrollIntoView({behavior:"smooth"})},[u]),c.useEffect(()=>{C.current?.focus()},[]);const R=c.useCallback(()=>({reportContext:{reportName:s,templateName:n?.name||"Custom",currentStep:l,sections:t.map(A=>({id:A.id,type:A.type,name:A.name,config:A.config})),parameters:r},projectContext:{projectId:p,projectName:y,projectRef:v},userContext:{email:b?.email,name:f?.full_name,role:f?.role}}),[s,n,l,t,r,p,y,v,b,f]),T=c.useCallback(async A=>{if(!(!A.trim()||d)){h({role:"user",content:A.trim()}),S(""),g(!0),D([]);try{const W=R(),ee=[...u.map(P=>({role:P.role,content:P.content})),{role:"user",content:A.trim()}],q=await fetch("/api/report-ai",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:ee,...W})});if(!q.ok){const P=await q.json();throw new Error(P.error||"Failed to get response")}const te=await q.json();h({role:"assistant",content:te.message,actions:te.actions||[]});const U=(te.actions||[]).filter(P=>P.type==="ADD_SECTION").map(P=>({type:P.sectionType,name:P.sectionName}));U.length>0&&D(U);const F=(te.actions||[]).find(P=>P.type==="GENERATED_CONTENT");F&&L(F)}catch(W){h({role:"assistant",content:"I apologize, but I encountered an error. Please try again.",error:W.message})}finally{g(!1)}}},[d,u,h,g,R]),w=c.useCallback(A=>{A.preventDefault(),T(m)},[m,T]),B=c.useCallback(A=>{T(A)},[T]),k=c.useCallback(A=>{switch(A.type){case"ADD_SECTION":o(A.sectionType,A.customConfig||{})&&(h({role:"assistant",content:` Added "${A.sectionName}" section to your report.`}),D(ee=>ee.filter(q=>q.type!==A.sectionType)));break;case"UPDATE_SECTION_CONFIG":i(A.sectionId,A.configUpdates),h({role:"assistant",content:" Updated section configuration."});break;case"GENERATED_CONTENT":navigator.clipboard?.writeText(A.content),h({role:"assistant",content:" Content copied to clipboard. You can paste it in the section configuration."}),L(null);break}},[o,i,h]),H=c.useCallback(A=>{o(A.type,{})&&(h({role:"assistant",content:` Added "${A.name}" section to your report.`}),D(ee=>ee.filter(q=>q.type!==A.type)))},[o,h]),ce=c.useCallback(()=>{x(),D([]),L(null)},[x]),J=u.length>0;return e.jsxs("div",{className:"report-ai-assistant",children:[e.jsxs("div",{className:"ai-assistant-header",children:[e.jsxs("div",{className:"ai-assistant-title",children:[e.jsx(se,{size:18}),e.jsx("span",{children:"AI Assistant"})]}),e.jsxs("div",{className:"ai-assistant-actions",children:[J&&e.jsx("button",{className:"ai-header-btn",onClick:ce,title:"Clear conversation",children:e.jsx(ze,{size:14})}),e.jsx("button",{className:"ai-header-btn",onClick:a,title:"Close assistant",children:e.jsx(Ce,{size:16})})]})]}),e.jsx("div",{className:"ai-assistant-messages",children:J?e.jsxs(e.Fragment,{children:[u.map((A,W)=>e.jsx(oa,{message:A,onActionClick:k,isLatest:W===u.length-1},A.id||W)),e.jsx(da,{suggestions:I,onSelect:H,disabled:d}),d&&e.jsxs("div",{className:"ai-message assistant loading",children:[e.jsx("div",{className:"ai-message-avatar",children:e.jsx(Be,{size:16})}),e.jsx("div",{className:"ai-message-content",children:e.jsxs("div",{className:"ai-loading-indicator",children:[e.jsx(Je,{size:16,className:"ai-spinner"}),e.jsx("span",{children:"Thinking..."})]})})]}),e.jsx("div",{ref:z})]}):e.jsxs("div",{className:"ai-assistant-welcome",children:[e.jsx("div",{className:"ai-welcome-icon",children:e.jsx(Be,{size:32})}),e.jsx("h4",{children:"How can I help you?"}),e.jsx("p",{children:"I can suggest sections for your report, explain what each section shows, generate content, and help configure your report."}),e.jsx(ua,{onSelect:B,disabled:d})]})}),e.jsxs("form",{className:"ai-assistant-input",onSubmit:w,children:[e.jsx("input",{ref:C,type:"text",value:m,onChange:A=>S(A.target.value),placeholder:"Ask me about report sections...",disabled:d,className:"ai-input-field"}),e.jsx("button",{type:"submit",disabled:!m.trim()||d,className:"ai-send-btn",children:d?e.jsx(Je,{size:18,className:"ai-spinner"}):e.jsx(Xt,{size:18})})]})]})}function pa({currentStep:a,canProceedToStep:t,onStepClick:s}){const n=Object.entries(Es);return e.jsx("div",{className:"wizard-steps",children:n.map(([r,l],o)=>{const i=parseInt(r),u=i===a,d=i<a,h=t(i);return e.jsxs(At.Fragment,{children:[e.jsxs("button",{className:`wizard-step ${u?"active":""} ${d?"completed":""} ${h?"clickable":""}`,onClick:()=>h&&s(i),disabled:!h,type:"button",children:[e.jsx("div",{className:"wizard-step-number",children:d?e.jsx(ie,{size:14}):i}),e.jsxs("div",{className:"wizard-step-info",children:[e.jsx("span",{className:"wizard-step-label",children:l.label}),e.jsx("span",{className:"wizard-step-description",children:l.description})]})]}),o<n.length-1&&e.jsx("div",{className:`wizard-step-connector ${d?"completed":""}`})]},r)})})}function ha({currentStep:a,canProceed:t,canGoBack:s,onNext:n,onPrev:r,onCancel:l,isGenerating:o,validation:i}){const u=a===O.PREVIEW_GENERATE,d=a===O.TEMPLATE_SELECTION;return e.jsxs("div",{className:"wizard-navigation",children:[e.jsx("div",{className:"wizard-nav-left",children:e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:l,children:"Cancel"})}),!i.valid&&i.errors.length>0&&e.jsxs("div",{className:"wizard-validation-hint",children:[e.jsx(Q,{size:14}),e.jsx("span",{children:i.errors[0]})]}),e.jsxs("div",{className:"wizard-nav-right",children:[!d&&e.jsxs("button",{type:"button",className:"btn btn-secondary",onClick:r,disabled:!s||o,children:[e.jsx(es,{size:16}),"Back"]}),!u&&e.jsxs("button",{type:"button",className:"btn btn-primary",onClick:n,disabled:!t||o,children:["Next",e.jsx(Me,{size:16})]})]})]})}function fa({onClose:a}){const{currentStep:t,nextStep:s,prevStep:n,goToStep:r,canProceed:l,canGoBack:o,canProceedToStep:i,getStepValidation:u,isDirty:d,isGenerating:h,aiPanelOpen:g,toggleAIPanel:x,resetWizard:p}=oe(),[y,v]=c.useState(!1),b=u(t),f=c.useCallback(L=>{i(L)&&r(L)},[i,r]),m=c.useCallback(()=>{l&&s()},[l,s]),S=c.useCallback(()=>{o&&n()},[o,n]),I=c.useCallback(()=>{d?v(!0):(p(),a())},[d,p,a]),D=c.useCallback(()=>{v(!1),p(),a()},[p,a]),$=()=>{switch(t){case O.TEMPLATE_SELECTION:return e.jsx(at,{});case O.PARAMETERS:return e.jsx(Ps,{});case O.SECTION_BUILDER:return e.jsx(ta,{});case O.PREVIEW_GENERATE:return e.jsx(ia,{});default:return e.jsx(at,{})}};return e.jsxs("div",{className:`report-wizard ${g?"ai-panel-open":""}`,children:[e.jsxs("div",{className:"wizard-header",children:[e.jsxs("div",{className:"wizard-header-title",children:[e.jsx(X,{size:24}),e.jsx("h2",{children:"Report Builder"})]}),e.jsxs("div",{className:"wizard-header-actions",children:[e.jsxs("button",{type:"button",className:`wizard-ai-toggle ${g?"active":""}`,onClick:x,title:"Toggle AI Assistant",children:[e.jsx(se,{size:18}),e.jsx("span",{children:"AI Assistant"})]}),e.jsx("button",{type:"button",className:"wizard-close-btn",onClick:I,title:"Close wizard",children:e.jsx(Ce,{size:20})})]})]}),e.jsx(pa,{currentStep:t,canProceedToStep:i,onStepClick:f}),e.jsxs("div",{className:"wizard-content",children:[e.jsx("div",{className:"wizard-main",children:$()}),g&&e.jsx("div",{className:"wizard-ai-panel",children:e.jsx(ma,{onClose:x})})]}),e.jsx(ha,{currentStep:t,canProceed:l,canGoBack:o,onNext:m,onPrev:S,onCancel:I,isGenerating:h,validation:b}),e.jsx(Dt,{isOpen:y,title:"Discard Changes?",message:"You have unsaved changes to your report. Are you sure you want to close the wizard? Your progress will be lost.",confirmLabel:"Discard",cancelLabel:"Keep Working",variant:"danger",onConfirm:D,onCancel:()=>v(!1)})]})}function ga({isOpen:a,onClose:t}){return a?e.jsx("div",{className:"report-wizard-overlay",children:e.jsx(Ns,{children:e.jsx(fa,{onClose:t})})}):null}const ya={code:"monthly_retrospective",name:"Monthly Retrospective",description:"Comprehensive monthly report for stakeholder meetings. Includes executive summary, milestone progress, KPI performance, budget analysis, RAID review, lessons learned, and forward look.",report_type:K.MONTHLY_RETROSPECTIVE,is_system:!0,is_default:!0,template_definition:{metadata:{title:"Monthly Programme Retrospective",subtitle:"{{project.name}}",generatedAt:"{{generated.date}}",generatedBy:"{{generated.by}}",includeCoverPage:!0,includeTableOfContents:!0},sections:[{id:"section_exec_summary",type:_.EXECUTIVE_SUMMARY,name:"Executive Summary",config:{content:"",includeAIGeneration:!0}},{id:"section_milestones",type:_.MILESTONE_SUMMARY,name:"Milestone Summary",config:{statusFilter:["Completed","In Progress","Not Started"],includeChart:!0,showBudget:!0}},{id:"section_deliverables",type:_.DELIVERABLE_SUMMARY,name:"Deliverable Summary",config:{statusFilter:["Delivered","In Progress","Overdue"],includeChart:!0,highlightOverdue:!0}},{id:"section_kpis",type:_.KPI_PERFORMANCE,name:"KPI Performance",config:{includeChart:!0,showRAG:!0,includeTarget:!0}},{id:"section_budget",type:_.BUDGET_ANALYSIS,name:"Budget Analysis",config:{includeChart:!0,showPMOvsDelivery:!0,showByMilestone:!0}},{id:"section_raid",type:_.RAID_SUMMARY,name:"RAID Summary",config:{categoryFilter:["Risk","Assumption","Issue","Dependency"],statusFilter:["Open","Mitigated"],includeChart:!0,showDetails:!0,maxItems:20}},{id:"section_lessons",type:_.LESSONS_LEARNED,name:"Lessons Learned",config:{format:"structured",content:[]}},{id:"section_forward",type:_.FORWARD_LOOK,name:"Forward Look",config:{lookAheadPeriod:"3months",includeMilestones:!0,includeDeliverables:!0,includeDependencies:!0}}]},default_parameters:{reportingPeriod:M.LAST_MONTH,includeCoverPage:!0,includeTableOfContents:!0}},xa={code:"project_status",name:"Project Status Summary",description:"Quick overview of current project status. Ideal for weekly updates and brief stakeholder communications.",report_type:K.STATUS_SUMMARY,is_system:!0,is_default:!1,template_definition:{metadata:{title:"Project Status Summary",subtitle:"{{project.name}}",generatedAt:"{{generated.date}}",generatedBy:"{{generated.by}}",includeCoverPage:!1,includeTableOfContents:!1},sections:[{id:"section_exec_summary",type:_.EXECUTIVE_SUMMARY,name:"Executive Summary",config:{content:"",includeAIGeneration:!0}},{id:"section_milestones",type:_.MILESTONE_SUMMARY,name:"Milestone Progress",config:{statusFilter:["Completed","In Progress"],includeChart:!0,showBudget:!1}},{id:"section_kpis",type:_.KPI_PERFORMANCE,name:"KPI Performance",config:{includeChart:!0,showRAG:!0,includeTarget:!0}},{id:"section_risks",type:_.RAID_SUMMARY,name:"Key Risks",config:{categoryFilter:["Risk"],statusFilter:["Open"],includeChart:!1,showDetails:!0,maxItems:10}}]},default_parameters:{reportingPeriod:M.LAST_MONTH,includeCoverPage:!1,includeTableOfContents:!1}},ja={code:"budget_variance",name:"Budget Variance Report",description:"Financial analysis with budget vs actual comparison. Includes detailed expense and timesheet summaries.",report_type:K.BUDGET_VARIANCE,is_system:!0,is_default:!1,template_definition:{metadata:{title:"Budget Variance Report",subtitle:"{{project.name}}",generatedAt:"{{generated.date}}",generatedBy:"{{generated.by}}",includeCoverPage:!0,includeTableOfContents:!1},sections:[{id:"section_budget",type:_.BUDGET_ANALYSIS,name:"Budget Analysis",config:{includeChart:!0,showPMOvsDelivery:!0,showByMilestone:!0}},{id:"section_expenses",type:_.EXPENSE_SUMMARY,name:"Expense Summary",config:{includeChart:!0,showByCategory:!0}},{id:"section_timesheets",type:_.TIMESHEET_SUMMARY,name:"Timesheet Summary",config:{includeChart:!0}}]},default_parameters:{reportingPeriod:M.LAST_QUARTER,includeCoverPage:!0,includeTableOfContents:!1}},va={code:"resource_utilisation",name:"Resource Utilisation Report",description:"Resource allocation and utilisation analysis. Shows team allocation, time tracking, and cost distribution.",report_type:K.CUSTOM,is_system:!0,is_default:!1,template_definition:{metadata:{title:"Resource Utilisation Report",subtitle:"{{project.name}}",generatedAt:"{{generated.date}}",generatedBy:"{{generated.by}}",includeCoverPage:!1,includeTableOfContents:!1},sections:[{id:"section_resources",type:_.RESOURCE_SUMMARY,name:"Resource Summary",config:{includeChart:!0,groupByRole:!0,showAllocation:!0}},{id:"section_timesheets",type:_.TIMESHEET_SUMMARY,name:"Time Tracking",config:{includeChart:!0}},{id:"section_budget",type:_.BUDGET_ANALYSIS,name:"Cost Analysis",config:{includeChart:!0,showPMOvsDelivery:!0,showByMilestone:!1}}]},default_parameters:{reportingPeriod:M.LAST_MONTH,includeCoverPage:!1,includeTableOfContents:!1}},ba=[ya,xa,ja,va];function lt({template:a,onSelect:t}){const s=a.template_definition?.sections?.length||0;return e.jsxs("div",{className:"report-template-card",onClick:()=>t(a),children:[e.jsx("div",{className:"report-template-card-icon",children:e.jsx(xt,{size:24})}),e.jsxs("div",{className:"report-template-card-content",children:[e.jsx("h4",{children:a.name}),e.jsx("p",{children:a.description}),e.jsxs("div",{className:"report-template-card-meta",children:[e.jsxs("span",{children:[e.jsx(jt,{size:14}),s," section",s!==1?"s":""]}),a.is_default&&e.jsx("span",{className:"template-default-badge",children:"Default"})]})]}),e.jsx(Me,{size:20,className:"report-template-card-arrow"})]})}function Ea({onOpenWizard:a,onSelectTemplate:t}){return e.jsxs("div",{className:"report-quick-start",children:[e.jsx("h3",{children:"Quick Start"}),e.jsxs("div",{className:"report-quick-start-grid",children:[e.jsxs("button",{className:"report-quick-start-card primary",onClick:a,children:[e.jsx("div",{className:"quick-start-icon",children:e.jsx(je,{size:24})}),e.jsxs("div",{className:"quick-start-content",children:[e.jsx("h4",{children:"Create New Report"}),e.jsx("p",{children:"Build a custom report from scratch or use a template"})]})]}),e.jsxs("button",{className:"report-quick-start-card ai",onClick:a,children:[e.jsx("div",{className:"quick-start-icon",children:e.jsx(se,{size:24})}),e.jsxs("div",{className:"quick-start-content",children:[e.jsx("h4",{children:"AI-Assisted Report"}),e.jsx("p",{children:"Describe what you need and let AI build your report"})]})]})]})]})}function Sa({templates:a,isLoading:t,onSelectTemplate:s}){const n=ba,r=a.filter(l=>!l.is_system);return e.jsxs("div",{className:"report-templates-section",children:[e.jsxs("div",{className:"report-templates-group",children:[e.jsxs("h3",{children:[e.jsx(xt,{size:20}),"Report Templates"]}),e.jsx("p",{className:"report-templates-description",children:"Pre-built templates for common reporting needs"}),t?e.jsxs("div",{className:"report-templates-loading",children:[e.jsx(Ge,{size:"small"}),e.jsx("span",{children:"Loading templates..."})]}):e.jsx("div",{className:"report-templates-list",children:n.map(l=>e.jsx(lt,{template:l,onSelect:s},l.code))})]}),r.length>0&&e.jsxs("div",{className:"report-templates-group",children:[e.jsxs("h3",{children:[e.jsx(jt,{size:20}),"Saved Templates"]}),e.jsx("p",{className:"report-templates-description",children:"Your custom report templates"}),e.jsx("div",{className:"report-templates-list",children:r.map(l=>e.jsx(lt,{template:l,onSelect:s},l.id))})]})]})}function Na({reports:a,isLoading:t}){return t?e.jsxs("div",{className:"report-recent-section",children:[e.jsxs("h3",{children:[e.jsx(ke,{size:20}),"Recent Reports"]}),e.jsxs("div",{className:"report-recent-loading",children:[e.jsx(Ge,{size:"small"}),e.jsx("span",{children:"Loading recent reports..."})]})]}):!a||a.length===0?e.jsxs("div",{className:"report-recent-section",children:[e.jsxs("h3",{children:[e.jsx(ke,{size:20}),"Recent Reports"]}),e.jsxs("div",{className:"report-recent-empty",children:[e.jsx(X,{size:32}),e.jsx("p",{children:"No reports generated yet"}),e.jsx("span",{children:"Your generated reports will appear here"})]})]}):e.jsxs("div",{className:"report-recent-section",children:[e.jsxs("h3",{children:[e.jsx(ke,{size:20}),"Recent Reports"]}),e.jsx("div",{className:"report-recent-list",children:a.map(s=>e.jsxs("div",{className:"report-recent-item",children:[e.jsx(X,{size:16}),e.jsxs("div",{className:"report-recent-info",children:[e.jsx("span",{className:"report-recent-name",children:s.report_name}),e.jsx("span",{className:"report-recent-date",children:new Date(s.generated_at).toLocaleDateString()})]})]},s.id))})]})}function Da(){const{projectId:a}=Se(),{profile:t}=xe(),[s,n]=c.useState(!1),[r,l]=c.useState([]),[o,i]=c.useState([]),[u,d]=c.useState(!0),[h,g]=c.useState(!0);c.useEffect(()=>{async function v(){if(a){d(!0);try{const b=await we.getTemplatesForProject(a,{activeOnly:!0,includeSystem:!1});l(b||[])}catch{}finally{d(!1)}}}v()},[a]),c.useEffect(()=>{async function v(){if(a){g(!0);try{const b=await we.getRecentGenerations(a,5);i(b||[])}catch{}finally{g(!1)}}}v()},[a]);const x=()=>{n(!0)},p=()=>{n(!1)},y=v=>{n(!0)};return e.jsxs("div",{className:"reports-page",children:[e.jsx("div",{className:"card",children:e.jsxs("div",{className:"card-header",children:[e.jsxs("div",{className:"reports-header-content",children:[e.jsxs("h2",{className:"card-title",children:[e.jsx(X,{size:24}),"Reports"]}),e.jsx("p",{className:"reports-header-description",children:"Generate project reports, export data, and track project progress"})]}),e.jsxs("button",{className:"btn btn-primary",onClick:x,children:[e.jsx(je,{size:20}),"New Report"]})]})}),e.jsxs("div",{className:"reports-content",children:[e.jsxs("div",{className:"reports-main",children:[e.jsx(Ea,{onOpenWizard:x,onSelectTemplate:y}),e.jsx(Sa,{templates:r,isLoading:u,onSelectTemplate:y})]}),e.jsx("div",{className:"reports-sidebar",children:e.jsx(Na,{reports:o,isLoading:h})})]}),e.jsx(ga,{isOpen:s,onClose:p})]})}export{Da as default};
