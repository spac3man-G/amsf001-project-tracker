import{u as Ne,a as we,b as Se,r as g,t as Le,c as ke,j as e,L as Re,h as Q}from"./index-BFvXjpTE.js";import{u as Te,r as n}from"./vendor-react-JFEV0ROX.js";import{u as Fe}from"./usePermissions-BIxHvmwA.js";import{S as w}from"./StatCard-DnnpIQpU.js";import{P as ze}from"./PageHeader-BJNUu_zZ.js";import{C as De}from"./ConfirmDialog-C6zSiPs4.js";import{p as Z,V as Ie,a1 as Ae,k as Pe,q as ee,Y as se,a as te,i as Me,W as $e,T as Ee,a8 as ae,a9 as Be,aa as We,o as Oe}from"./vendor-icons-MGuLpNnD.js";import"./vendor-supabase-DgEUAXvv.js";function Ke(){const le=Te(),{user:re,role:P}=Ne(),{projectId:y}=we(),{showSuccess:S,showError:f,showWarning:ne}=Se(),M=re?.id||null,{canManageResources:$,canSeeResourceType:j,canSeeCostPrice:o}=Fe(),[_,ie]=n.useState([]),[E,de]=n.useState({}),[oe,B]=n.useState(!0),[v,L]=n.useState(null),[l,p]=n.useState({}),[ce,k]=n.useState(!1),[R,ue]=n.useState("all"),[c,C]=n.useState({isOpen:!1,resource:null,dependents:null}),[pe,W]=n.useState(!1),[a,i]=n.useState({resource_ref:"",name:"",email:"",role:"",sfia_level:"L4",daily_rate:"",cost_price:"",discount_percent:0,days_allocated:"",days_used:0,resource_type:"internal"}),b=n.useCallback(async()=>{if(y){B(!0);try{const s=await g.getAll(y,{includePartner:!1});ie(s);const t=await Le.getAllFiltered(y,!0),x={};t.forEach(d=>{if(!(ke(d.status)&&!d.was_rejected))return;const m=parseFloat(d.hours_worked||d.hours||0);x[d.resource_id]=(x[d.resource_id]||0)+m}),de(x)}catch{f("Failed to load resources")}finally{B(!1)}}},[y,f]);n.useEffect(()=>{b()},[b]);function T(s){return s?typeof s=="string"&&s.startsWith("L")?s:`L${s}`:"L4"}function O(s){return s?typeof s=="number"?s:typeof s=="string"&&s.startsWith("L")?parseInt(s.substring(1))||4:parseInt(s)||4:4}function U(s,t){return!s||s===0||!t?null:(s-t)/s*100}function H(s){return s===null?{color:"#9ca3af",bg:"#f1f5f9",label:"N/A",icon:ae}:s>=25?{color:"#16a34a",bg:"#dcfce7",label:"Good",icon:ee}:s>=10?{color:"#d97706",bg:"#fef3c7",label:"Low",icon:ae}:{color:"#dc2626",bg:"#fee2e2",label:"Critical",icon:Be}}function he(s){L(s.id),p({name:s.name,email:s.email,role:s.role,sfia_level:T(s.sfia_level),daily_rate:s.daily_rate,cost_price:s.cost_price||"",discount_percent:s.discount_percent,days_allocated:s.days_allocated,days_used:s.days_used,resource_type:s.resource_type||"internal"})}async function me(s){try{const t={name:l.name,email:l.email,role:l.role,sfia_level:O(l.sfia_level),daily_rate:parseFloat(l.daily_rate)||0,discount_percent:parseFloat(l.discount_percent)||0,days_allocated:parseInt(l.days_allocated)||0,days_used:parseFloat(l.days_used)||0,resource_type:l.resource_type||"internal"};o&&(t.cost_price=l.cost_price===""?null:parseFloat(l.cost_price)),await g.update(s,t),await b(),L(null),S("Resource updated!")}catch(t){f("Failed to update: "+t.message)}}async function xe(){try{const s=await g.getProfileByEmail(a.email);if(!s){ne("This email is not registered. They need to sign up first.");return}await g.create({...a,project_id:y,user_id:s.id,sfia_level:O(a.sfia_level),daily_rate:parseFloat(a.daily_rate),cost_price:a.cost_price?parseFloat(a.cost_price):null,days_allocated:parseInt(a.days_allocated),discount_percent:parseFloat(a.discount_percent)||0,created_by:M}),await b(),k(!1),i({resource_ref:"",name:"",email:"",role:"",sfia_level:"L4",daily_rate:"",cost_price:"",discount_percent:0,days_allocated:"",days_used:0,resource_type:"internal"}),S("Resource added!")}catch(s){f("Failed to add: "+s.message)}}async function ge(s){try{const t=await g.getDependencyCounts(s.id);C({isOpen:!0,resource:s,dependents:{timesheets:t.timesheetCount,expenses:t.expenseCount}})}catch{C({isOpen:!0,resource:s,dependents:null})}}async function ye(){const s=c.resource;if(s){W(!0);try{await g.delete(s.id,M),await b(),C({isOpen:!1,resource:null,dependents:null}),S("Resource deleted")}catch{f("Failed to delete")}finally{W(!1)}}}const fe=s=>{switch(T(s)){case"L6":return"badge-warning";case"L5":return"badge-success";case"L4":return"badge-primary";default:return"badge-secondary"}},je=s=>s==="third_party"?{bg:"#fef3c7",color:"#92400e",icon:We,label:"Third-Party"}:{bg:"#dbeafe",color:"#1e40af",icon:Oe,label:"Internal"},h=_.filter(s=>R==="all"||(s.resource_type||"internal")===R),be=h.reduce((s,t)=>s+(t.daily_rate||0)*(t.days_allocated||0),0),F=h.reduce((s,t)=>s+(t.days_allocated||0),0),_e=h.reduce((s,t)=>s+(E[t.id]||0),0),G=Q(_e),V=F>0?Math.round(G/F*100):0,X=_.filter(s=>(s.resource_type||"internal")==="internal").length,q=_.filter(s=>s.resource_type==="third_party").length,Y=h.filter(s=>s.cost_price&&s.daily_rate),z=Y.reduce((s,t)=>s+(t.daily_rate||0)*(t.days_allocated||0),0),ve=Y.reduce((s,t)=>s+(t.cost_price||0)*(t.days_allocated||0),0),D=z>0?(z-ve)/z*100:null,J=H(D),u={good:0,low:0,critical:0,unknown:0};return h.forEach(s=>{const t=U(s.daily_rate,s.cost_price);t===null?u.unknown++:t>=25?u.good++:t>=10?u.low++:u.critical++}),oe?e.jsx(Re,{message:"Loading resources...",size:"large",fullPage:!0}):e.jsxs("div",{className:"page-container",children:[e.jsx(ze,{icon:Z,title:"Team Resources",subtitle:"Manage project team allocation and utilization",children:P==="admin"&&e.jsxs("button",{className:"btn btn-primary",onClick:()=>k(!0),children:[e.jsx(Ie,{size:18})," Add Resource"]})}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1rem"},children:[e.jsx(w,{icon:Z,label:"Team Members",value:h.length,subtext:j?`${X} internal, ${q} third-party`:void 0,color:"#3b82f6"}),e.jsx(w,{icon:Ae,label:"Resource Budget",value:`£${be.toLocaleString()}`,color:"#10b981"}),e.jsx(w,{icon:Pe,label:"Days Allocated",value:F,color:"#3b82f6"}),e.jsx(w,{icon:ee,label:"Utilization",value:`${V}%`,subtext:`${G.toFixed(1)} days used`,color:V>0?"#10b981":"#64748b"})]}),o&&e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem"},children:[e.jsxs("div",{className:"stat-card",style:{borderLeft:`4px solid ${J.color}`},children:[e.jsx("div",{className:"stat-value",style:{color:J.color},children:D!==null?`${D.toFixed(1)}%`:"N/A"}),e.jsx("div",{className:"stat-label",children:"Overall Margin"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-value",style:{color:"#16a34a"},children:u.good}),e.jsx("div",{className:"stat-label",children:"Good (≥25%)"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-value",style:{color:"#d97706"},children:u.low}),e.jsx("div",{className:"stat-label",children:"Low (10-25%)"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-value",style:{color:u.critical>0?"#dc2626":"#64748b"},children:u.critical}),e.jsx("div",{className:"stat-label",children:"Critical (<10%)"})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"1rem"},children:[e.jsx("h2",{className:"card-title",children:"Team Resources"}),j&&e.jsxs("select",{value:R,onChange:s=>ue(s.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsxs("option",{value:"all",children:["All (",_.length,")"]}),e.jsxs("option",{value:"internal",children:["Internal (",X,")"]}),e.jsxs("option",{value:"third_party",children:["Third-Party (",q,")"]})]})]})}),ce&&e.jsxs("div",{style:{padding:"1rem",borderBottom:"2px solid var(--border)"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Add New Resource"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(4, 1fr)",gap:"1rem"},children:[e.jsx("input",{className:"input-field",placeholder:"Reference",value:a.resource_ref,onChange:s=>i({...a,resource_ref:s.target.value})}),e.jsx("input",{className:"input-field",placeholder:"Name",value:a.name,onChange:s=>i({...a,name:s.target.value})}),e.jsx("input",{className:"input-field",placeholder:"Email",type:"email",value:a.email,onChange:s=>i({...a,email:s.target.value})}),e.jsx("input",{className:"input-field",placeholder:"Role",value:a.role,onChange:s=>i({...a,role:s.target.value})}),e.jsxs("select",{className:"input-field",value:a.sfia_level,onChange:s=>i({...a,sfia_level:s.target.value}),children:[e.jsx("option",{value:"L3",children:"L3"}),e.jsx("option",{value:"L4",children:"L4"}),e.jsx("option",{value:"L5",children:"L5"}),e.jsx("option",{value:"L6",children:"L6"})]}),e.jsx("input",{className:"input-field",placeholder:"Daily Rate (£)",type:"number",value:a.daily_rate,onChange:s=>i({...a,daily_rate:s.target.value})}),o&&e.jsx("input",{className:"input-field",placeholder:"Cost Price (£)",type:"number",value:a.cost_price,onChange:s=>i({...a,cost_price:s.target.value})}),e.jsx("input",{className:"input-field",placeholder:"Days Allocated",type:"number",value:a.days_allocated,onChange:s=>i({...a,days_allocated:s.target.value})}),e.jsxs("select",{className:"input-field",value:a.resource_type,onChange:s=>i({...a,resource_type:s.target.value}),children:[e.jsx("option",{value:"internal",children:"Internal"}),e.jsx("option",{value:"third_party",children:"Third-Party"})]})]}),e.jsxs("div",{style:{marginTop:"1rem",display:"flex",gap:"0.5rem"},children:[e.jsxs("button",{className:"btn btn-primary",onClick:xe,children:[e.jsx(se,{size:16})," Save"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:()=>k(!1),children:[e.jsx(te,{size:16})," Cancel"]})]})]}),e.jsx("div",{style:{overflowX:"auto"},children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),j&&e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Role"}),e.jsx("th",{children:"SFIA"}),e.jsx("th",{children:"Rate"}),o&&e.jsx("th",{children:"Cost"}),o&&e.jsx("th",{children:"Margin"}),e.jsx("th",{children:"Days"}),e.jsx("th",{children:"Util"}),e.jsx("th",{children:"Value"}),$&&e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:h.map(s=>{const t=E[s.id]||0,x=Q(t),d=s.days_allocated||0,N=d>0?x/d*100:0,m=je(s.resource_type),K=m.icon,I=U(s.daily_rate,s.cost_price),A=H(I),Ce=A.icon;return e.jsx("tr",{onClick:()=>v!==s.id&&le(`/resources/${s.id}`),style:{cursor:v===s.id?"default":"pointer"},className:v===s.id?"":"table-row-clickable",children:v===s.id?e.jsxs(e.Fragment,{children:[e.jsx("td",{children:e.jsx("input",{className:"input-field",value:l.name,onChange:r=>p({...l,name:r.target.value})})}),j&&e.jsx("td",{children:e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.35rem",padding:"0.35rem 0.65rem",backgroundColor:m.bg,color:m.color,borderRadius:"6px",fontSize:"0.8rem"},children:[e.jsx(K,{size:14}),s.resource_type==="third_party"?"3rd Party":"Internal"]})}),e.jsx("td",{children:e.jsx("input",{className:"input-field",value:l.role,onChange:r=>p({...l,role:r.target.value})})}),e.jsx("td",{children:e.jsxs("select",{className:"input-field",value:l.sfia_level,onChange:r=>p({...l,sfia_level:r.target.value}),children:[e.jsx("option",{value:"L3",children:"L3"}),e.jsx("option",{value:"L4",children:"L4"}),e.jsx("option",{value:"L5",children:"L5"}),e.jsx("option",{value:"L6",children:"L6"})]})}),e.jsx("td",{children:e.jsx("input",{className:"input-field",type:"number",value:l.daily_rate,onChange:r=>p({...l,daily_rate:r.target.value}),style:{width:"80px"}})}),o&&e.jsx("td",{children:e.jsx("input",{className:"input-field",type:"number",value:l.cost_price,onChange:r=>p({...l,cost_price:r.target.value}),style:{width:"80px"}})}),o&&e.jsx("td",{children:"-"}),e.jsx("td",{children:e.jsx("input",{className:"input-field",type:"number",value:l.days_allocated,onChange:r=>p({...l,days_allocated:r.target.value}),style:{width:"60px"}})}),e.jsx("td",{children:"-"}),e.jsx("td",{children:"-"}),e.jsx("td",{children:e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsx("button",{className:"btn btn-sm btn-primary",onClick:()=>me(s.id),children:e.jsx(se,{size:16})}),e.jsx("button",{className:"btn btn-sm btn-secondary",onClick:()=>L(null),children:e.jsx(te,{size:16})})]})})]}):e.jsxs(e.Fragment,{children:[e.jsx("td",{children:e.jsxs("div",{children:[e.jsx("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:e.jsx("strong",{style:{color:"#2563eb"},children:s.name})}),e.jsx("div",{style:{fontSize:"0.875rem",color:"var(--text-light)"},children:s.email})]})}),j&&e.jsx("td",{children:e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.35rem",padding:"0.35rem 0.65rem",backgroundColor:m.bg,color:m.color,borderRadius:"6px",fontSize:"0.8rem"},children:[e.jsx(K,{size:14}),s.resource_type==="third_party"?"3rd Party":"Internal"]})}),e.jsx("td",{children:s.role}),e.jsx("td",{children:e.jsxs("span",{className:`badge ${fe(s.sfia_level)}`,children:[e.jsx(Me,{size:14,style:{marginRight:"0.25rem"}}),T(s.sfia_level)]})}),e.jsxs("td",{children:["£",s.daily_rate]}),o&&e.jsx("td",{children:s.cost_price?`£${s.cost_price}`:e.jsx("span",{style:{color:"#9ca3af"},children:"-"})}),o&&e.jsx("td",{children:e.jsxs("div",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",backgroundColor:A.bg,color:A.color,borderRadius:"4px",fontSize:"0.85rem",fontWeight:"600"},children:[e.jsx(Ce,{size:14}),I!==null?`${I.toFixed(0)}%`:"N/A"]})}),e.jsx("td",{children:e.jsxs("div",{children:[e.jsx("span",{style:{fontWeight:"500"},children:x.toFixed(1)}),"/",d]})}),e.jsx("td",{children:e.jsxs("div",{children:[e.jsx("div",{style:{width:"60px",height:"6px",backgroundColor:"#e2e8f0",borderRadius:"3px",overflow:"hidden"},children:e.jsx("div",{style:{width:`${Math.min(N,100)}%`,height:"100%",backgroundColor:N>100?"#dc2626":"#3b82f6"}})}),e.jsxs("span",{style:{fontSize:"0.875rem"},children:[Math.round(N),"%"]})]})}),e.jsx("td",{children:e.jsxs("strong",{children:["£",((s.daily_rate||0)*(s.days_allocated||0)).toLocaleString()]})}),$&&e.jsx("td",{onClick:r=>r.stopPropagation(),children:e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsx("button",{className:"btn btn-sm btn-secondary",onClick:()=>he(s),children:e.jsx($e,{size:16})}),P==="admin"&&e.jsx("button",{className:"btn btn-sm btn-danger",onClick:()=>ge(s),children:e.jsx(Ee,{size:16})})]})})]})},s.id)})})]})})]}),e.jsx("style",{jsx:!0,children:`
        .input-field { width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; }
        .badge { display: inline-flex; align-items: center; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-primary { background: #dbeafe; color: #1e40af; }
        .badge-secondary { background: #f1f5f9; color: #475569; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .btn-danger { background: #fee2e2; color: #dc2626; border: none; cursor: pointer; padding: 0.5rem; border-radius: 4px; }
        .btn-danger:hover { background: #fecaca; }
        .btn-secondary { background: #f1f5f9; color: #475569; border: none; cursor: pointer; padding: 0.5rem; border-radius: 4px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
      `}),e.jsx(De,{isOpen:c.isOpen,onClose:()=>C({isOpen:!1,resource:null,dependents:null}),onConfirm:ye,title:"Delete Resource?",message:c.resource?e.jsxs(e.Fragment,{children:['Delete "',e.jsx("strong",{children:c.resource.name}),'"?',c.dependents&&(c.dependents.timesheets>0||c.dependents.expenses>0)&&e.jsxs(e.Fragment,{children:[e.jsx("br",{}),e.jsx("br",{}),e.jsxs("span",{style:{color:"#dc2626"},children:["⚠️ Also deletes: ",c.dependents.timesheets," timesheets, ",c.dependents.expenses," expenses"]})]})]}):"",confirmText:"Delete",type:"danger",isLoading:pe})]})}export{Ke as default};
