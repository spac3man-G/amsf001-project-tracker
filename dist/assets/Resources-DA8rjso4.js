import{u as G,a as J,b as K,r as j,t as Q,g as Z,j as e,L as ee,h as se}from"./index-hknTwC-T.js";import{b as ae,r as t}from"./vendor-react-B1g8b4mG.js";import{u as re,R as l,g as te,a as le,c as ne,b as ce,d as ie,s as oe,e as de,f as ue}from"./resourceCalculations-zVdSRYv6.js";import{C as he}from"./ConfirmDialog-BP4IRYiW.js";import{q as pe,R as me,a9 as xe,ab as je,c as fe,l as ge}from"./vendor-icons-CaeMuLCT.js";import"./vendor-supabase-DSZ6Ejbd.js";function Ce(){const I=ae(),{user:P}=G(),{projectId:o}=J(),{showSuccess:_,showError:h,showWarning:D}=K(),y=P?.id||null,{canCreate:F,canSeeResourceType:p,canSeeCostPrice:f,canSeeMargins:R}=re(),[m,L]=t.useState([]),[k,z]=t.useState({}),[O,b]=t.useState(!0),[C,T]=t.useState(!1),[M,g]=t.useState(!1),[N,H]=t.useState("all"),[n,S]=t.useState({isOpen:!1,resource:null,dependents:null}),[U,A]=t.useState(!1),[a,c]=t.useState({resource_ref:"",name:"",email:"",role:"",sfia_level:"L4",sell_price:"",cost_price:"",discount_percent:0,resource_type:l.INTERNAL}),d=t.useCallback(async()=>{if(o){b(!0);try{const s=await j.getAll(o,{includePartner:!1});L(s);const x=await Q.getAllFiltered(o,!0),i={};x.forEach(r=>{if(!(Z(r.status)&&!r.was_rejected))return;const u=parseFloat(r.hours_worked||r.hours||0);i[r.resource_id]=(i[r.resource_id]||0)+u}),z(i)}catch{h("Failed to load resources")}finally{b(!1),T(!1)}}},[o,h]);t.useEffect(()=>{d()},[d]);async function $(){T(!0),await d()}async function Y(){try{const s=await j.getProfileByEmail(a.email);if(!s){D("This email is not registered. They need to sign up first.");return}await j.create({...a,project_id:o,user_id:s.id,sfia_level:ue(a.sfia_level),sell_price:parseFloat(a.sell_price),cost_price:a.cost_price?parseFloat(a.cost_price):null,discount_percent:parseFloat(a.discount_percent)||0,created_by:y}),await d(),g(!1),c({resource_ref:"",name:"",email:"",role:"",sfia_level:"L4",sell_price:"",cost_price:"",discount_percent:0,resource_type:l.INTERNAL}),_("Resource added!")}catch(s){h("Failed to add: "+s.message)}}async function V(){const s=n.resource;if(s){A(!0);try{await j.delete(s.id,y),await d(),S({isOpen:!1,resource:null,dependents:null}),_("Resource deleted")}catch{h("Failed to delete")}finally{A(!1)}}}const v=m.filter(s=>N==="all"||(s.resource_type||l.INTERNAL)===N),B=m.filter(s=>(s.resource_type||l.INTERNAL)===l.INTERNAL).length,W=m.filter(s=>s.resource_type===l.THIRD_PARTY).length;return O?e.jsx(ee,{message:"Loading resources...",size:"large",fullPage:!0}):e.jsxs("div",{className:"resources-page",children:[e.jsx("header",{className:"res-header",children:e.jsxs("div",{className:"res-header-content",children:[e.jsxs("div",{className:"res-header-left",children:[e.jsx("div",{className:"res-header-icon",children:e.jsx(pe,{size:24})}),e.jsxs("div",{children:[e.jsx("h1",{children:"Team Resources"}),e.jsx("p",{children:"Manage project team members and rates"})]})]}),e.jsxs("div",{className:"res-header-actions",children:[e.jsxs("button",{className:"res-btn res-btn-secondary",onClick:$,disabled:C,children:[e.jsx(me,{size:18,className:C?"spinning":""})," Refresh"]}),F&&e.jsxs("button",{className:"res-btn res-btn-primary",onClick:()=>g(!0),children:[e.jsx(xe,{size:18})," Add Resource"]})]})]})}),e.jsxs("div",{className:"res-content",children:[M&&e.jsxs("div",{className:"res-add-form",children:[e.jsx("h3",{className:"res-add-form-title",children:"Add New Resource"}),e.jsxs("div",{className:"res-form-grid",children:[e.jsx("input",{className:"res-input",placeholder:"Reference",value:a.resource_ref,onChange:s=>c({...a,resource_ref:s.target.value})}),e.jsx("input",{className:"res-input",placeholder:"Name",value:a.name,onChange:s=>c({...a,name:s.target.value})}),e.jsx("input",{className:"res-input",placeholder:"Email",type:"email",value:a.email,onChange:s=>c({...a,email:s.target.value})}),e.jsx("input",{className:"res-input",placeholder:"Role",value:a.role,onChange:s=>c({...a,role:s.target.value})}),e.jsx("select",{className:"res-input",value:a.sfia_level,onChange:s=>c({...a,sfia_level:s.target.value}),children:te().map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))}),e.jsx("input",{className:"res-input",placeholder:"Sell Price (£/day)",type:"number",value:a.sell_price,onChange:s=>c({...a,sell_price:s.target.value})}),f&&e.jsx("input",{className:"res-input",placeholder:"Cost Price (£/day)",type:"number",value:a.cost_price,onChange:s=>c({...a,cost_price:s.target.value})}),p&&e.jsxs("select",{className:"res-input",value:a.resource_type,onChange:s=>c({...a,resource_type:s.target.value}),children:[e.jsx("option",{value:l.INTERNAL,children:"Internal"}),e.jsx("option",{value:l.THIRD_PARTY,children:"Third-Party"})]})]}),e.jsxs("div",{className:"res-form-actions",children:[e.jsxs("button",{className:"res-btn res-btn-primary",onClick:Y,children:[e.jsx(je,{size:16})," Save"]}),e.jsxs("button",{className:"res-btn res-btn-secondary",onClick:()=>g(!1),children:[e.jsx(fe,{size:16})," Cancel"]})]})]}),e.jsxs("div",{className:"res-table-card",children:[e.jsxs("div",{className:"res-table-header",children:[e.jsxs("div",{className:"res-table-header-left",children:[e.jsx("h2",{className:"res-table-title",children:"Team Resources"}),p&&e.jsxs("select",{value:N,onChange:s=>H(s.target.value),className:"res-filter-select",children:[e.jsxs("option",{value:"all",children:["All (",m.length,")"]}),e.jsxs("option",{value:l.INTERNAL,children:["Internal (",B,")"]}),e.jsxs("option",{value:l.THIRD_PARTY,children:["Third-Party (",W,")"]})]})]}),e.jsxs("span",{className:"res-table-count",children:[v.length," resource",v.length!==1?"s":""]})]}),e.jsxs("table",{className:"res-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),p&&e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Role"}),e.jsx("th",{children:"SFIA"}),e.jsx("th",{children:"Sell Rate"}),f&&e.jsx("th",{children:"Cost Rate"}),R&&e.jsx("th",{children:"Margin"}),e.jsx("th",{children:"Days Used"}),e.jsx("th",{children:"Value"})]})}),e.jsx("tbody",{children:v.map(s=>{const x=k[s.id]||0,i=se(x),r=le(s.resource_type),w=r.icon,u=ne(s.sell_price,s.cost_price),E=ce(u.percent),q=E.icon,X=ie(i,s.sell_price);return e.jsxs("tr",{onClick:()=>I(`/resources/${s.id}`),children:[e.jsx("td",{children:e.jsxs("div",{className:"res-name-cell",children:[e.jsx("span",{className:"res-name",children:s.name}),e.jsx("span",{className:"res-email",children:s.email})]})}),p&&e.jsx("td",{children:e.jsxs("span",{className:`res-type-badge ${r.cssClass}`,style:{backgroundColor:r.bg,color:r.color},children:[e.jsx(w,{size:14}),r.shortLabel]})}),e.jsx("td",{children:s.role}),e.jsx("td",{children:e.jsxs("span",{className:`res-sfia-badge ${de(s.sfia_level)}`,children:[e.jsx(ge,{size:14}),oe(s.sfia_level)]})}),e.jsxs("td",{className:"res-mono",children:["£",s.sell_price]}),f&&e.jsx("td",{className:"res-mono",children:s.cost_price?`£${s.cost_price}`:e.jsx("span",{className:"res-na",children:"—"})}),R&&e.jsx("td",{children:e.jsxs("span",{className:"res-margin",style:{color:E.color},children:[e.jsx(q,{size:14}),u.percent!==null?`${u.percent.toFixed(0)}%`:"N/A"]})}),e.jsx("td",{children:e.jsx("span",{className:"res-days",children:i.toFixed(1)})}),e.jsxs("td",{className:"res-value",children:["£",X.toLocaleString()]})]},s.id)})})]})]})]}),e.jsx(he,{isOpen:n.isOpen,onClose:()=>S({isOpen:!1,resource:null,dependents:null}),onConfirm:V,title:"Delete Resource?",message:n.resource?e.jsxs(e.Fragment,{children:['Delete "',e.jsx("strong",{children:n.resource.name}),'"?',n.dependents&&(n.dependents.timesheets>0||n.dependents.expenses>0)&&e.jsxs(e.Fragment,{children:[e.jsx("br",{}),e.jsx("br",{}),e.jsxs("span",{style:{color:"#dc2626"},children:["⚠️ Also deletes: ",n.dependents.timesheets," timesheets, ",n.dependents.expenses," expenses"]})]})]}):"",confirmText:"Delete",type:"danger",isLoading:U})]})}export{Ce as default};
