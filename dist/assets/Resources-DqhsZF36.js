import{u as ve,a as Ce,b as Ne,r as g,t as we,c as Se,j as e,L as Le}from"./index-C6WAEMo1.js";import{u as ke,r as n}from"./vendor-react-JFEV0ROX.js";import{u as Re}from"./usePermissions-CuGXgLEi.js";import{S as w}from"./StatCard-ixtkUJ0x.js";import{P as Te}from"./PageHeader-DRZmYy4x.js";import{C as Fe}from"./ConfirmDialog-Dz7Ha419.js";import{p as K,Y as ze,a1 as De,k as Ie,q as Q,_ as ee,a as te,i as Ae,Z as Pe,T as Me,a9 as se,aa as $e,ab as Ee,o as We}from"./vendor-icons-BZZethZ5.js";import"./vendor-supabase-DgEUAXvv.js";function Ze(){const ae=ke(),{user:le,role:P}=ve(),{projectId:y}=Ce(),{showSuccess:S,showError:f,showWarning:re}=Ne(),M=le?.id||null,{canManageResources:$,canSeeResourceType:j,canSeeCostPrice:o}=Re(),[_,ne]=n.useState([]),[E,ie]=n.useState({}),[de,W]=n.useState(!0),[v,L]=n.useState(null),[l,p]=n.useState({}),[oe,k]=n.useState(!1),[R,ce]=n.useState("all"),[c,C]=n.useState({isOpen:!1,resource:null,dependents:null}),[ue,B]=n.useState(!1),[a,i]=n.useState({resource_ref:"",name:"",email:"",role:"",sfia_level:"L4",daily_rate:"",cost_price:"",discount_percent:0,days_allocated:"",days_used:0,resource_type:"internal"}),b=n.useCallback(async()=>{if(y){W(!0);try{const t=await g.getAll(y,{includePartner:!1});ne(t);const s=await we.getAllFiltered(y,!0),x={};s.forEach(d=>{if(!(Se(d.status)&&!d.was_rejected))return;const m=parseFloat(d.hours_worked||d.hours||0);x[d.resource_id]=(x[d.resource_id]||0)+m}),ie(x)}catch{f("Failed to load resources")}finally{W(!1)}}},[y,f]);n.useEffect(()=>{b()},[b]);function T(t){return t?typeof t=="string"&&t.startsWith("L")?t:`L${t}`:"L4"}function O(t){return t?typeof t=="number"?t:typeof t=="string"&&t.startsWith("L")?parseInt(t.substring(1))||4:parseInt(t)||4:4}function U(t,s){return!t||t===0||!s?null:(t-s)/t*100}function H(t){return t===null?{color:"#9ca3af",bg:"#f1f5f9",label:"N/A",icon:se}:t>=25?{color:"#16a34a",bg:"#dcfce7",label:"Good",icon:Q}:t>=10?{color:"#d97706",bg:"#fef3c7",label:"Low",icon:se}:{color:"#dc2626",bg:"#fee2e2",label:"Critical",icon:$e}}function pe(t){L(t.id),p({name:t.name,email:t.email,role:t.role,sfia_level:T(t.sfia_level),daily_rate:t.daily_rate,cost_price:t.cost_price||"",discount_percent:t.discount_percent,days_allocated:t.days_allocated,days_used:t.days_used,resource_type:t.resource_type||"internal"})}async function he(t){try{const s={name:l.name,email:l.email,role:l.role,sfia_level:O(l.sfia_level),daily_rate:parseFloat(l.daily_rate)||0,discount_percent:parseFloat(l.discount_percent)||0,days_allocated:parseInt(l.days_allocated)||0,days_used:parseFloat(l.days_used)||0,resource_type:l.resource_type||"internal"};o&&(s.cost_price=l.cost_price===""?null:parseFloat(l.cost_price)),await g.update(t,s),await b(),L(null),S("Resource updated!")}catch(s){f("Failed to update: "+s.message)}}async function me(){try{const t=await g.getProfileByEmail(a.email);if(!t){re("This email is not registered. They need to sign up first.");return}await g.create({...a,project_id:y,user_id:t.id,sfia_level:O(a.sfia_level),daily_rate:parseFloat(a.daily_rate),cost_price:a.cost_price?parseFloat(a.cost_price):null,days_allocated:parseInt(a.days_allocated),discount_percent:parseFloat(a.discount_percent)||0,created_by:M}),await b(),k(!1),i({resource_ref:"",name:"",email:"",role:"",sfia_level:"L4",daily_rate:"",cost_price:"",discount_percent:0,days_allocated:"",days_used:0,resource_type:"internal"}),S("Resource added!")}catch(t){f("Failed to add: "+t.message)}}async function xe(t){try{const s=await g.getDependencyCounts(t.id);C({isOpen:!0,resource:t,dependents:{timesheets:s.timesheetCount,expenses:s.expenseCount}})}catch{C({isOpen:!0,resource:t,dependents:null})}}async function ge(){const t=c.resource;if(t){B(!0);try{await g.delete(t.id,M),await b(),C({isOpen:!1,resource:null,dependents:null}),S("Resource deleted")}catch{f("Failed to delete")}finally{B(!1)}}}const ye=t=>{switch(T(t)){case"L6":return"badge-warning";case"L5":return"badge-success";case"L4":return"badge-primary";default:return"badge-secondary"}},fe=t=>t==="third_party"?{bg:"#fef3c7",color:"#92400e",icon:Ee,label:"Third-Party"}:{bg:"#dbeafe",color:"#1e40af",icon:We,label:"Internal"},h=_.filter(t=>R==="all"||(t.resource_type||"internal")===R),je=h.reduce((t,s)=>t+(s.daily_rate||0)*(s.days_allocated||0),0),F=h.reduce((t,s)=>t+(s.days_allocated||0),0),G=h.reduce((t,s)=>t+(E[s.id]||0),0)/8,X=F>0?Math.round(G/F*100):0,q=_.filter(t=>(t.resource_type||"internal")==="internal").length,V=_.filter(t=>t.resource_type==="third_party").length,Y=h.filter(t=>t.cost_price&&t.daily_rate),z=Y.reduce((t,s)=>t+(s.daily_rate||0)*(s.days_allocated||0),0),be=Y.reduce((t,s)=>t+(s.cost_price||0)*(s.days_allocated||0),0),D=z>0?(z-be)/z*100:null,Z=H(D),u={good:0,low:0,critical:0,unknown:0};return h.forEach(t=>{const s=U(t.daily_rate,t.cost_price);s===null?u.unknown++:s>=25?u.good++:s>=10?u.low++:u.critical++}),de?e.jsx(Le,{message:"Loading resources...",size:"large",fullPage:!0}):e.jsxs("div",{className:"page-container",children:[e.jsx(Te,{icon:K,title:"Team Resources",subtitle:"Manage project team allocation and utilization",children:P==="admin"&&e.jsxs("button",{className:"btn btn-primary",onClick:()=>k(!0),children:[e.jsx(ze,{size:18})," Add Resource"]})}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1rem"},children:[e.jsx(w,{icon:K,label:"Team Members",value:h.length,subtext:j?`${q} internal, ${V} third-party`:void 0,color:"#3b82f6"}),e.jsx(w,{icon:De,label:"Resource Budget",value:`£${je.toLocaleString()}`,color:"#10b981"}),e.jsx(w,{icon:Ie,label:"Days Allocated",value:F,color:"#3b82f6"}),e.jsx(w,{icon:Q,label:"Utilization",value:`${X}%`,subtext:`${G.toFixed(1)} days used`,color:X>0?"#10b981":"#64748b"})]}),o&&e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem"},children:[e.jsxs("div",{className:"stat-card",style:{borderLeft:`4px solid ${Z.color}`},children:[e.jsx("div",{className:"stat-value",style:{color:Z.color},children:D!==null?`${D.toFixed(1)}%`:"N/A"}),e.jsx("div",{className:"stat-label",children:"Overall Margin"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-value",style:{color:"#16a34a"},children:u.good}),e.jsx("div",{className:"stat-label",children:"Good (≥25%)"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-value",style:{color:"#d97706"},children:u.low}),e.jsx("div",{className:"stat-label",children:"Low (10-25%)"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-value",style:{color:u.critical>0?"#dc2626":"#64748b"},children:u.critical}),e.jsx("div",{className:"stat-label",children:"Critical (<10%)"})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"1rem"},children:[e.jsx("h2",{className:"card-title",children:"Team Resources"}),j&&e.jsxs("select",{value:R,onChange:t=>ce(t.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsxs("option",{value:"all",children:["All (",_.length,")"]}),e.jsxs("option",{value:"internal",children:["Internal (",q,")"]}),e.jsxs("option",{value:"third_party",children:["Third-Party (",V,")"]})]})]})}),oe&&e.jsxs("div",{style:{padding:"1rem",borderBottom:"2px solid var(--border)"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Add New Resource"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(4, 1fr)",gap:"1rem"},children:[e.jsx("input",{className:"input-field",placeholder:"Reference",value:a.resource_ref,onChange:t=>i({...a,resource_ref:t.target.value})}),e.jsx("input",{className:"input-field",placeholder:"Name",value:a.name,onChange:t=>i({...a,name:t.target.value})}),e.jsx("input",{className:"input-field",placeholder:"Email",type:"email",value:a.email,onChange:t=>i({...a,email:t.target.value})}),e.jsx("input",{className:"input-field",placeholder:"Role",value:a.role,onChange:t=>i({...a,role:t.target.value})}),e.jsxs("select",{className:"input-field",value:a.sfia_level,onChange:t=>i({...a,sfia_level:t.target.value}),children:[e.jsx("option",{value:"L3",children:"L3"}),e.jsx("option",{value:"L4",children:"L4"}),e.jsx("option",{value:"L5",children:"L5"}),e.jsx("option",{value:"L6",children:"L6"})]}),e.jsx("input",{className:"input-field",placeholder:"Daily Rate (£)",type:"number",value:a.daily_rate,onChange:t=>i({...a,daily_rate:t.target.value})}),o&&e.jsx("input",{className:"input-field",placeholder:"Cost Price (£)",type:"number",value:a.cost_price,onChange:t=>i({...a,cost_price:t.target.value})}),e.jsx("input",{className:"input-field",placeholder:"Days Allocated",type:"number",value:a.days_allocated,onChange:t=>i({...a,days_allocated:t.target.value})}),e.jsxs("select",{className:"input-field",value:a.resource_type,onChange:t=>i({...a,resource_type:t.target.value}),children:[e.jsx("option",{value:"internal",children:"Internal"}),e.jsx("option",{value:"third_party",children:"Third-Party"})]})]}),e.jsxs("div",{style:{marginTop:"1rem",display:"flex",gap:"0.5rem"},children:[e.jsxs("button",{className:"btn btn-primary",onClick:me,children:[e.jsx(ee,{size:16})," Save"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:()=>k(!1),children:[e.jsx(te,{size:16})," Cancel"]})]})]}),e.jsx("div",{style:{overflowX:"auto"},children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),j&&e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Role"}),e.jsx("th",{children:"SFIA"}),e.jsx("th",{children:"Rate"}),o&&e.jsx("th",{children:"Cost"}),o&&e.jsx("th",{children:"Margin"}),e.jsx("th",{children:"Days"}),e.jsx("th",{children:"Util"}),e.jsx("th",{children:"Value"}),$&&e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:h.map(t=>{const x=(E[t.id]||0)/8,d=t.days_allocated||0,N=d>0?x/d*100:0,m=fe(t.resource_type),J=m.icon,I=U(t.daily_rate,t.cost_price),A=H(I),_e=A.icon;return e.jsx("tr",{onClick:()=>v!==t.id&&ae(`/resources/${t.id}`),style:{cursor:v===t.id?"default":"pointer"},className:v===t.id?"":"table-row-clickable",children:v===t.id?e.jsxs(e.Fragment,{children:[e.jsx("td",{children:e.jsx("input",{className:"input-field",value:l.name,onChange:r=>p({...l,name:r.target.value})})}),j&&e.jsx("td",{children:e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.35rem",padding:"0.35rem 0.65rem",backgroundColor:m.bg,color:m.color,borderRadius:"6px",fontSize:"0.8rem"},children:[e.jsx(J,{size:14}),t.resource_type==="third_party"?"3rd Party":"Internal"]})}),e.jsx("td",{children:e.jsx("input",{className:"input-field",value:l.role,onChange:r=>p({...l,role:r.target.value})})}),e.jsx("td",{children:e.jsxs("select",{className:"input-field",value:l.sfia_level,onChange:r=>p({...l,sfia_level:r.target.value}),children:[e.jsx("option",{value:"L3",children:"L3"}),e.jsx("option",{value:"L4",children:"L4"}),e.jsx("option",{value:"L5",children:"L5"}),e.jsx("option",{value:"L6",children:"L6"})]})}),e.jsx("td",{children:e.jsx("input",{className:"input-field",type:"number",value:l.daily_rate,onChange:r=>p({...l,daily_rate:r.target.value}),style:{width:"80px"}})}),o&&e.jsx("td",{children:e.jsx("input",{className:"input-field",type:"number",value:l.cost_price,onChange:r=>p({...l,cost_price:r.target.value}),style:{width:"80px"}})}),o&&e.jsx("td",{children:"-"}),e.jsx("td",{children:e.jsx("input",{className:"input-field",type:"number",value:l.days_allocated,onChange:r=>p({...l,days_allocated:r.target.value}),style:{width:"60px"}})}),e.jsx("td",{children:"-"}),e.jsx("td",{children:"-"}),e.jsx("td",{children:e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsx("button",{className:"btn btn-sm btn-primary",onClick:()=>he(t.id),children:e.jsx(ee,{size:16})}),e.jsx("button",{className:"btn btn-sm btn-secondary",onClick:()=>L(null),children:e.jsx(te,{size:16})})]})})]}):e.jsxs(e.Fragment,{children:[e.jsx("td",{children:e.jsxs("div",{children:[e.jsx("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:e.jsx("strong",{style:{color:"#2563eb"},children:t.name})}),e.jsx("div",{style:{fontSize:"0.875rem",color:"var(--text-light)"},children:t.email})]})}),j&&e.jsx("td",{children:e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.35rem",padding:"0.35rem 0.65rem",backgroundColor:m.bg,color:m.color,borderRadius:"6px",fontSize:"0.8rem"},children:[e.jsx(J,{size:14}),t.resource_type==="third_party"?"3rd Party":"Internal"]})}),e.jsx("td",{children:t.role}),e.jsx("td",{children:e.jsxs("span",{className:`badge ${ye(t.sfia_level)}`,children:[e.jsx(Ae,{size:14,style:{marginRight:"0.25rem"}}),T(t.sfia_level)]})}),e.jsxs("td",{children:["£",t.daily_rate]}),o&&e.jsx("td",{children:t.cost_price?`£${t.cost_price}`:e.jsx("span",{style:{color:"#9ca3af"},children:"-"})}),o&&e.jsx("td",{children:e.jsxs("div",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",backgroundColor:A.bg,color:A.color,borderRadius:"4px",fontSize:"0.85rem",fontWeight:"600"},children:[e.jsx(_e,{size:14}),I!==null?`${I.toFixed(0)}%`:"N/A"]})}),e.jsx("td",{children:e.jsxs("div",{children:[e.jsx("span",{style:{fontWeight:"500"},children:x.toFixed(1)}),"/",d]})}),e.jsx("td",{children:e.jsxs("div",{children:[e.jsx("div",{style:{width:"60px",height:"6px",backgroundColor:"#e2e8f0",borderRadius:"3px",overflow:"hidden"},children:e.jsx("div",{style:{width:`${Math.min(N,100)}%`,height:"100%",backgroundColor:N>100?"#dc2626":"#3b82f6"}})}),e.jsxs("span",{style:{fontSize:"0.875rem"},children:[Math.round(N),"%"]})]})}),e.jsx("td",{children:e.jsxs("strong",{children:["£",((t.daily_rate||0)*(t.days_allocated||0)).toLocaleString()]})}),$&&e.jsx("td",{onClick:r=>r.stopPropagation(),children:e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsx("button",{className:"btn btn-sm btn-secondary",onClick:()=>pe(t),children:e.jsx(Pe,{size:16})}),P==="admin"&&e.jsx("button",{className:"btn btn-sm btn-danger",onClick:()=>xe(t),children:e.jsx(Me,{size:16})})]})})]})},t.id)})})]})})]}),e.jsx("style",{jsx:!0,children:`
        .input-field { width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; }
        .badge { display: inline-flex; align-items: center; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-primary { background: #dbeafe; color: #1e40af; }
        .badge-secondary { background: #f1f5f9; color: #475569; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .btn-danger { background: #fee2e2; color: #dc2626; border: none; cursor: pointer; padding: 0.5rem; border-radius: 4px; }
        .btn-danger:hover { background: #fecaca; }
        .btn-secondary { background: #f1f5f9; color: #475569; border: none; cursor: pointer; padding: 0.5rem; border-radius: 4px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
      `}),e.jsx(Fe,{isOpen:c.isOpen,onClose:()=>C({isOpen:!1,resource:null,dependents:null}),onConfirm:ge,title:"Delete Resource?",message:c.resource?e.jsxs(e.Fragment,{children:['Delete "',e.jsx("strong",{children:c.resource.name}),'"?',c.dependents&&(c.dependents.timesheets>0||c.dependents.expenses>0)&&e.jsxs(e.Fragment,{children:[e.jsx("br",{}),e.jsx("br",{}),e.jsxs("span",{style:{color:"#dc2626"},children:["⚠️ Also deletes: ",c.dependents.timesheets," timesheets, ",c.dependents.expenses," expenses"]})]})]}):"",confirmText:"Delete",type:"danger",isLoading:ue})]})}export{Ze as default};
