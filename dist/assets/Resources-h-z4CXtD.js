import{u as ve,a as Ce,b as Ne,r as g,t as we,j as e,L as Le,P as Se,S as N}from"./index-DzSfoXVj.js";import{u as ke,r}from"./vendor-react-CaXNtsgv.js";import{u as Re}from"./usePermissions-C1V5jo-Y.js";import{C as Fe}from"./ConfirmDialog-BTAghqNf.js";import{m as K,Q as Te,O as ze,h as De,n as Y,y as Z,a as ee,a5 as Ae,f as Ie,V as Pe,T as Me,a6 as se,a7 as $e,a8 as Ee,l as We}from"./vendor-icons-DN1Ea9uG.js";import"./vendor-supabase-qY1sfceY.js";import"./vendor-charts-_mIYJ_kN.js";function qe(){const te=ke(),{user:ae,role:I}=ve(),{projectId:y}=Ce(),{showSuccess:w,showError:f,showWarning:le}=Ne(),P=ae?.id||null,{canManageResources:M,canSeeResourceType:j,canSeeCostPrice:o}=Re(),[_,re]=r.useState([]),[$,ne]=r.useState({}),[ie,E]=r.useState(!0),[de,L]=r.useState(null),[l,p]=r.useState({}),[oe,S]=r.useState(!1),[k,ce]=r.useState("all"),[c,v]=r.useState({isOpen:!1,resource:null,dependents:null}),[ue,W]=r.useState(!1),[a,d]=r.useState({resource_ref:"",name:"",email:"",role:"",sfia_level:"L4",daily_rate:"",cost_price:"",discount_percent:0,days_allocated:"",days_used:0,resource_type:"internal"}),b=r.useCallback(async()=>{if(y){E(!0);try{const s=await g.getAll(y,{includePartner:!1});re(s);const t=await we.getAllFiltered(y,!0),x={};t.forEach(n=>{if(!(n.status==="Approved"||n.status==="Submitted"&&!n.was_rejected))return;const m=parseFloat(n.hours_worked||n.hours||0);x[n.resource_id]=(x[n.resource_id]||0)+m}),ne(x)}catch{f("Failed to load resources")}finally{E(!1)}}},[y,f]);r.useEffect(()=>{b()},[b]);function R(s){return s?typeof s=="string"&&s.startsWith("L")?s:`L${s}`:"L4"}function B(s){return s?typeof s=="number"?s:typeof s=="string"&&s.startsWith("L")?parseInt(s.substring(1))||4:parseInt(s)||4:4}function O(s,t){return!s||s===0||!t?null:(s-t)/s*100}function U(s){return s===null?{color:"#9ca3af",bg:"#f1f5f9",label:"N/A",icon:se}:s>=25?{color:"#16a34a",bg:"#dcfce7",label:"Good",icon:Y}:s>=10?{color:"#d97706",bg:"#fef3c7",label:"Low",icon:se}:{color:"#dc2626",bg:"#fee2e2",label:"Critical",icon:$e}}function pe(s){L(s.id),p({name:s.name,email:s.email,role:s.role,sfia_level:R(s.sfia_level),daily_rate:s.daily_rate,cost_price:s.cost_price||"",discount_percent:s.discount_percent,days_allocated:s.days_allocated,days_used:s.days_used,resource_type:s.resource_type||"internal"})}async function he(s){try{const t={name:l.name,email:l.email,role:l.role,sfia_level:B(l.sfia_level),daily_rate:parseFloat(l.daily_rate)||0,discount_percent:parseFloat(l.discount_percent)||0,days_allocated:parseInt(l.days_allocated)||0,days_used:parseFloat(l.days_used)||0,resource_type:l.resource_type||"internal"};o&&(t.cost_price=l.cost_price===""?null:parseFloat(l.cost_price)),await g.update(s,t),await b(),L(null),w("Resource updated!")}catch(t){f("Failed to update: "+t.message)}}async function me(){try{const s=await g.getProfileByEmail(a.email);if(!s){le("This email is not registered. They need to sign up first.");return}await g.create({...a,project_id:y,user_id:s.id,sfia_level:B(a.sfia_level),daily_rate:parseFloat(a.daily_rate),cost_price:a.cost_price?parseFloat(a.cost_price):null,days_allocated:parseInt(a.days_allocated),discount_percent:parseFloat(a.discount_percent)||0,created_by:P}),await b(),S(!1),d({resource_ref:"",name:"",email:"",role:"",sfia_level:"L4",daily_rate:"",cost_price:"",discount_percent:0,days_allocated:"",days_used:0,resource_type:"internal"}),w("Resource added!")}catch(s){f("Failed to add: "+s.message)}}async function xe(s){try{const t=await g.getDependencyCounts(s.id);v({isOpen:!0,resource:s,dependents:{timesheets:t.timesheetCount,expenses:t.expenseCount}})}catch{v({isOpen:!0,resource:s,dependents:null})}}async function ge(){const s=c.resource;if(s){W(!0);try{await g.delete(s.id,P),await b(),v({isOpen:!1,resource:null,dependents:null}),w("Resource deleted")}catch{f("Failed to delete")}finally{W(!1)}}}const ye=s=>{switch(R(s)){case"L6":return"badge-warning";case"L5":return"badge-success";case"L4":return"badge-primary";default:return"badge-secondary"}},fe=s=>s==="third_party"?{bg:"#fef3c7",color:"#92400e",icon:Ee,label:"Third-Party"}:{bg:"#dbeafe",color:"#1e40af",icon:We,label:"Internal"},h=_.filter(s=>k==="all"||(s.resource_type||"internal")===k),je=h.reduce((s,t)=>s+(t.daily_rate||0)*(t.days_allocated||0),0),F=h.reduce((s,t)=>s+(t.days_allocated||0),0),H=h.reduce((s,t)=>s+($[t.id]||0),0)/8,G=F>0?Math.round(H/F*100):0,V=_.filter(s=>(s.resource_type||"internal")==="internal").length,X=_.filter(s=>s.resource_type==="third_party").length,Q=h.filter(s=>s.cost_price&&s.daily_rate),T=Q.reduce((s,t)=>s+(t.daily_rate||0)*(t.days_allocated||0),0),be=Q.reduce((s,t)=>s+(t.cost_price||0)*(t.days_allocated||0),0),z=T>0?(T-be)/T*100:null,q=U(z),u={good:0,low:0,critical:0,unknown:0};return h.forEach(s=>{const t=O(s.daily_rate,s.cost_price);t===null?u.unknown++:t>=25?u.good++:t>=10?u.low++:u.critical++}),ie?e.jsx(Le,{message:"Loading resources...",size:"large",fullPage:!0}):e.jsxs("div",{className:"page-container",children:[e.jsx(Se,{icon:K,title:"Team Resources",subtitle:"Manage project team allocation and utilization",children:I==="admin"&&e.jsxs("button",{className:"btn btn-primary",onClick:()=>S(!0),children:[e.jsx(Te,{size:18})," Add Resource"]})}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1rem"},children:[e.jsx(N,{icon:K,label:"Team Members",value:h.length,subtext:j?`${V} internal, ${X} third-party`:void 0,color:"#3b82f6"}),e.jsx(N,{icon:ze,label:"Resource Budget",value:`£${je.toLocaleString()}`,color:"#10b981"}),e.jsx(N,{icon:De,label:"Days Allocated",value:F,color:"#3b82f6"}),e.jsx(N,{icon:Y,label:"Utilization",value:`${G}%`,subtext:`${H.toFixed(1)} days used`,color:G>0?"#10b981":"#64748b"})]}),o&&e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem"},children:[e.jsxs("div",{className:"stat-card",style:{borderLeft:`4px solid ${q.color}`},children:[e.jsx("div",{className:"stat-value",style:{color:q.color},children:z!==null?`${z.toFixed(1)}%`:"N/A"}),e.jsx("div",{className:"stat-label",children:"Overall Margin"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-value",style:{color:"#16a34a"},children:u.good}),e.jsx("div",{className:"stat-label",children:"Good (≥25%)"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-value",style:{color:"#d97706"},children:u.low}),e.jsx("div",{className:"stat-label",children:"Low (10-25%)"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-value",style:{color:u.critical>0?"#dc2626":"#64748b"},children:u.critical}),e.jsx("div",{className:"stat-label",children:"Critical (<10%)"})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"1rem"},children:[e.jsx("h2",{className:"card-title",children:"Team Resources"}),j&&e.jsxs("select",{value:k,onChange:s=>ce(s.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsxs("option",{value:"all",children:["All (",_.length,")"]}),e.jsxs("option",{value:"internal",children:["Internal (",V,")"]}),e.jsxs("option",{value:"third_party",children:["Third-Party (",X,")"]})]})]})}),oe&&e.jsxs("div",{style:{padding:"1rem",borderBottom:"2px solid var(--border)"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Add New Resource"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(4, 1fr)",gap:"1rem"},children:[e.jsx("input",{className:"input-field",placeholder:"Reference",value:a.resource_ref,onChange:s=>d({...a,resource_ref:s.target.value})}),e.jsx("input",{className:"input-field",placeholder:"Name",value:a.name,onChange:s=>d({...a,name:s.target.value})}),e.jsx("input",{className:"input-field",placeholder:"Email",type:"email",value:a.email,onChange:s=>d({...a,email:s.target.value})}),e.jsx("input",{className:"input-field",placeholder:"Role",value:a.role,onChange:s=>d({...a,role:s.target.value})}),e.jsxs("select",{className:"input-field",value:a.sfia_level,onChange:s=>d({...a,sfia_level:s.target.value}),children:[e.jsx("option",{value:"L3",children:"L3"}),e.jsx("option",{value:"L4",children:"L4"}),e.jsx("option",{value:"L5",children:"L5"}),e.jsx("option",{value:"L6",children:"L6"})]}),e.jsx("input",{className:"input-field",placeholder:"Daily Rate (£)",type:"number",value:a.daily_rate,onChange:s=>d({...a,daily_rate:s.target.value})}),o&&e.jsx("input",{className:"input-field",placeholder:"Cost Price (£)",type:"number",value:a.cost_price,onChange:s=>d({...a,cost_price:s.target.value})}),e.jsx("input",{className:"input-field",placeholder:"Days Allocated",type:"number",value:a.days_allocated,onChange:s=>d({...a,days_allocated:s.target.value})}),e.jsxs("select",{className:"input-field",value:a.resource_type,onChange:s=>d({...a,resource_type:s.target.value}),children:[e.jsx("option",{value:"internal",children:"Internal"}),e.jsx("option",{value:"third_party",children:"Third-Party"})]})]}),e.jsxs("div",{style:{marginTop:"1rem",display:"flex",gap:"0.5rem"},children:[e.jsxs("button",{className:"btn btn-primary",onClick:me,children:[e.jsx(Z,{size:16})," Save"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:()=>S(!1),children:[e.jsx(ee,{size:16})," Cancel"]})]})]}),e.jsx("div",{style:{overflowX:"auto"},children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),j&&e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Role"}),e.jsx("th",{children:"SFIA"}),e.jsx("th",{children:"Rate"}),o&&e.jsx("th",{children:"Cost"}),o&&e.jsx("th",{children:"Margin"}),e.jsx("th",{children:"Days"}),e.jsx("th",{children:"Util"}),e.jsx("th",{children:"Value"}),M&&e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:h.map(s=>{const x=($[s.id]||0)/8,n=s.days_allocated||0,C=n>0?x/n*100:0,m=fe(s.resource_type),J=m.icon,D=O(s.daily_rate,s.cost_price),A=U(D),_e=A.icon;return e.jsx("tr",{children:de===s.id?e.jsxs(e.Fragment,{children:[e.jsx("td",{children:e.jsx("input",{className:"input-field",value:l.name,onChange:i=>p({...l,name:i.target.value})})}),j&&e.jsx("td",{children:e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.35rem",padding:"0.35rem 0.65rem",backgroundColor:m.bg,color:m.color,borderRadius:"6px",fontSize:"0.8rem"},children:[e.jsx(J,{size:14}),s.resource_type==="third_party"?"3rd Party":"Internal"]})}),e.jsx("td",{children:e.jsx("input",{className:"input-field",value:l.role,onChange:i=>p({...l,role:i.target.value})})}),e.jsx("td",{children:e.jsxs("select",{className:"input-field",value:l.sfia_level,onChange:i=>p({...l,sfia_level:i.target.value}),children:[e.jsx("option",{value:"L3",children:"L3"}),e.jsx("option",{value:"L4",children:"L4"}),e.jsx("option",{value:"L5",children:"L5"}),e.jsx("option",{value:"L6",children:"L6"})]})}),e.jsx("td",{children:e.jsx("input",{className:"input-field",type:"number",value:l.daily_rate,onChange:i=>p({...l,daily_rate:i.target.value}),style:{width:"80px"}})}),o&&e.jsx("td",{children:e.jsx("input",{className:"input-field",type:"number",value:l.cost_price,onChange:i=>p({...l,cost_price:i.target.value}),style:{width:"80px"}})}),o&&e.jsx("td",{children:"-"}),e.jsx("td",{children:e.jsx("input",{className:"input-field",type:"number",value:l.days_allocated,onChange:i=>p({...l,days_allocated:i.target.value}),style:{width:"60px"}})}),e.jsx("td",{children:"-"}),e.jsx("td",{children:"-"}),e.jsx("td",{children:e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsx("button",{className:"btn btn-sm btn-primary",onClick:()=>he(s.id),children:e.jsx(Z,{size:16})}),e.jsx("button",{className:"btn btn-sm btn-secondary",onClick:()=>L(null),children:e.jsx(ee,{size:16})})]})})]}):e.jsxs(e.Fragment,{children:[e.jsx("td",{children:e.jsxs("div",{onClick:()=>te(`/resources/${s.id}`),style:{cursor:"pointer"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("strong",{style:{color:"#2563eb"},children:s.name}),e.jsx(Ae,{size:14,style:{color:"#9ca3af"}})]}),e.jsx("div",{style:{fontSize:"0.875rem",color:"var(--text-light)"},children:s.email})]})}),j&&e.jsx("td",{children:e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.35rem",padding:"0.35rem 0.65rem",backgroundColor:m.bg,color:m.color,borderRadius:"6px",fontSize:"0.8rem"},children:[e.jsx(J,{size:14}),s.resource_type==="third_party"?"3rd Party":"Internal"]})}),e.jsx("td",{children:s.role}),e.jsx("td",{children:e.jsxs("span",{className:`badge ${ye(s.sfia_level)}`,children:[e.jsx(Ie,{size:14,style:{marginRight:"0.25rem"}}),R(s.sfia_level)]})}),e.jsxs("td",{children:["£",s.daily_rate]}),o&&e.jsx("td",{children:s.cost_price?`£${s.cost_price}`:e.jsx("span",{style:{color:"#9ca3af"},children:"-"})}),o&&e.jsx("td",{children:e.jsxs("div",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",backgroundColor:A.bg,color:A.color,borderRadius:"4px",fontSize:"0.85rem",fontWeight:"600"},children:[e.jsx(_e,{size:14}),D!==null?`${D.toFixed(0)}%`:"N/A"]})}),e.jsx("td",{children:e.jsxs("div",{children:[e.jsx("span",{style:{fontWeight:"500"},children:x.toFixed(1)}),"/",n]})}),e.jsx("td",{children:e.jsxs("div",{children:[e.jsx("div",{style:{width:"60px",height:"6px",backgroundColor:"#e2e8f0",borderRadius:"3px",overflow:"hidden"},children:e.jsx("div",{style:{width:`${Math.min(C,100)}%`,height:"100%",backgroundColor:C>100?"#dc2626":"#3b82f6"}})}),e.jsxs("span",{style:{fontSize:"0.875rem"},children:[Math.round(C),"%"]})]})}),e.jsx("td",{children:e.jsxs("strong",{children:["£",((s.daily_rate||0)*(s.days_allocated||0)).toLocaleString()]})}),M&&e.jsx("td",{children:e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsx("button",{className:"btn btn-sm btn-secondary",onClick:()=>pe(s),children:e.jsx(Pe,{size:16})}),I==="admin"&&e.jsx("button",{className:"btn btn-sm btn-danger",onClick:()=>xe(s),children:e.jsx(Me,{size:16})})]})})]})},s.id)})})]})})]}),e.jsx("style",{jsx:!0,children:`
        .input-field { width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; }
        .badge { display: inline-flex; align-items: center; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-primary { background: #dbeafe; color: #1e40af; }
        .badge-secondary { background: #f1f5f9; color: #475569; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .btn-danger { background: #fee2e2; color: #dc2626; border: none; cursor: pointer; padding: 0.5rem; border-radius: 4px; }
        .btn-danger:hover { background: #fecaca; }
        .btn-secondary { background: #f1f5f9; color: #475569; border: none; cursor: pointer; padding: 0.5rem; border-radius: 4px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
      `}),e.jsx(Fe,{isOpen:c.isOpen,onClose:()=>v({isOpen:!1,resource:null,dependents:null}),onConfirm:ge,title:"Delete Resource?",message:c.resource?e.jsxs(e.Fragment,{children:['Delete "',e.jsx("strong",{children:c.resource.name}),'"?',c.dependents&&(c.dependents.timesheets>0||c.dependents.expenses>0)&&e.jsxs(e.Fragment,{children:[e.jsx("br",{}),e.jsx("br",{}),e.jsxs("span",{style:{color:"#dc2626"},children:["⚠️ Also deletes: ",c.dependents.timesheets," timesheets, ",c.dependents.expenses," expenses"]})]})]}):"",confirmText:"Delete",type:"danger",isLoading:ue})]})}export{qe as default};
