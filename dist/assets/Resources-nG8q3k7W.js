import{u as ee,a as se,b as ae,c as re,r as j,t as te,g as le,j as e,L as ne,h as ie}from"./index-CaOm8KX_.js";import{b as ce,r}from"./vendor-react-B1g8b4mG.js";import{C as oe}from"./ConfirmDialog-CokknysC.js";import{m as de,R as ue,a7 as he,a9 as pe,a as me,aj as xe,j as je,h as fe,ak as F,z as ge,a3 as ye}from"./vendor-icons-D-7N55ks.js";import"./vendor-supabase-DSZ6Ejbd.js";function Le(){const D=ce(),{user:z,role:k}=ee(),{projectId:o}=se(),{showSuccess:v,showError:h,showWarning:P}=ae(),b=z?.id||null,{canManageResources:_e,canSeeResourceType:f,canSeeCostPrice:d}=re(),[p,I]=r.useState([]),[M,E]=r.useState({}),[$,C]=r.useState(!0),[S,L]=r.useState(!1),[O,g]=r.useState(!1),[y,U]=r.useState("all"),[n,w]=r.useState({isOpen:!1,resource:null,dependents:null}),[W,R]=r.useState(!1),[a,t]=r.useState({resource_ref:"",name:"",email:"",role:"",sfia_level:"L4",sell_price:"",cost_price:"",discount_percent:0,days_allocated:"",days_used:0,resource_type:"internal"}),u=r.useCallback(async()=>{if(o){C(!0);try{const s=await j.getAll(o,{includePartner:!1});I(s);const i=await te.getAllFiltered(o,!0),c={};i.forEach(l=>{if(!(le(l.status)&&!l.was_rejected))return;const x=parseFloat(l.hours_worked||l.hours||0);c[l.resource_id]=(c[l.resource_id]||0)+x}),E(c)}catch{h("Failed to load resources")}finally{C(!1),L(!1)}}},[o,h]);r.useEffect(()=>{u()},[u]);async function B(){L(!0),await u()}function T(s){return s?typeof s=="string"&&s.startsWith("L")?s:`L${s}`:"L4"}function H(s){return s?typeof s=="number"?s:typeof s=="string"&&s.startsWith("L")?parseInt(s.substring(1))||4:parseInt(s)||4:4}function G(s,i){return!s||s===0||!i?null:(s-i)/s*100}function V(s){return s===null?{color:"#9ca3af",label:"N/A",icon:F}:s>=25?{color:"#16a34a",label:"Good",icon:ge}:s>=10?{color:"#d97706",label:"Low",icon:F}:{color:"#dc2626",label:"Critical",icon:ye}}async function X(){try{const s=await j.getProfileByEmail(a.email);if(!s){P("This email is not registered. They need to sign up first.");return}await j.create({...a,project_id:o,user_id:s.id,sfia_level:H(a.sfia_level),sell_price:parseFloat(a.sell_price),cost_price:a.cost_price?parseFloat(a.cost_price):null,days_allocated:parseInt(a.days_allocated),discount_percent:parseFloat(a.discount_percent)||0,created_by:b}),await u(),g(!1),t({resource_ref:"",name:"",email:"",role:"",sfia_level:"L4",sell_price:"",cost_price:"",discount_percent:0,days_allocated:"",days_used:0,resource_type:"internal"}),v("Resource added!")}catch(s){h("Failed to add: "+s.message)}}async function q(){const s=n.resource;if(s){R(!0);try{await j.delete(s.id,b),await u(),w({isOpen:!1,resource:null,dependents:null}),v("Resource deleted")}catch{h("Failed to delete")}finally{R(!1)}}}const J=s=>{switch(T(s)){case"L6":return"sfia-l6";case"L5":return"sfia-l5";case"L4":return"sfia-l4";default:return"sfia-default"}},K=s=>s==="third_party"?{className:"type-third-party",label:"3rd Party"}:{className:"type-internal",label:"Internal"},_=p.filter(s=>y==="all"||(s.resource_type||"internal")===y),Q=p.filter(s=>(s.resource_type||"internal")==="internal").length,Y=p.filter(s=>s.resource_type==="third_party").length;return $?e.jsx(ne,{message:"Loading resources...",size:"large",fullPage:!0}):e.jsxs("div",{className:"resources-page",children:[e.jsx("header",{className:"res-header",children:e.jsxs("div",{className:"res-header-content",children:[e.jsxs("div",{className:"res-header-left",children:[e.jsx("div",{className:"res-header-icon",children:e.jsx(de,{size:24})}),e.jsxs("div",{children:[e.jsx("h1",{children:"Team Resources"}),e.jsx("p",{children:"Manage project team allocation and utilization"})]})]}),e.jsxs("div",{className:"res-header-actions",children:[e.jsxs("button",{className:"res-btn res-btn-secondary",onClick:B,disabled:S,children:[e.jsx(ue,{size:18,className:S?"spinning":""})," Refresh"]}),k==="admin"&&e.jsxs("button",{className:"res-btn res-btn-primary",onClick:()=>g(!0),children:[e.jsx(he,{size:18})," Add Resource"]})]})]})}),e.jsxs("div",{className:"res-content",children:[O&&e.jsxs("div",{className:"res-add-form",children:[e.jsx("h3",{className:"res-add-form-title",children:"Add New Resource"}),e.jsxs("div",{className:"res-form-grid",children:[e.jsx("input",{className:"res-input",placeholder:"Reference",value:a.resource_ref,onChange:s=>t({...a,resource_ref:s.target.value})}),e.jsx("input",{className:"res-input",placeholder:"Name",value:a.name,onChange:s=>t({...a,name:s.target.value})}),e.jsx("input",{className:"res-input",placeholder:"Email",type:"email",value:a.email,onChange:s=>t({...a,email:s.target.value})}),e.jsx("input",{className:"res-input",placeholder:"Role",value:a.role,onChange:s=>t({...a,role:s.target.value})}),e.jsxs("select",{className:"res-input",value:a.sfia_level,onChange:s=>t({...a,sfia_level:s.target.value}),children:[e.jsx("option",{value:"L3",children:"L3"}),e.jsx("option",{value:"L4",children:"L4"}),e.jsx("option",{value:"L5",children:"L5"}),e.jsx("option",{value:"L6",children:"L6"})]}),e.jsx("input",{className:"res-input",placeholder:"Sell Price (£)",type:"number",value:a.sell_price,onChange:s=>t({...a,sell_price:s.target.value})}),d&&e.jsx("input",{className:"res-input",placeholder:"Cost Price (£)",type:"number",value:a.cost_price,onChange:s=>t({...a,cost_price:s.target.value})}),e.jsx("input",{className:"res-input",placeholder:"Days Allocated",type:"number",value:a.days_allocated,onChange:s=>t({...a,days_allocated:s.target.value})}),e.jsxs("select",{className:"res-input",value:a.resource_type,onChange:s=>t({...a,resource_type:s.target.value}),children:[e.jsx("option",{value:"internal",children:"Internal"}),e.jsx("option",{value:"third_party",children:"Third-Party"})]})]}),e.jsxs("div",{className:"res-form-actions",children:[e.jsxs("button",{className:"res-btn res-btn-primary",onClick:X,children:[e.jsx(pe,{size:16})," Save"]}),e.jsxs("button",{className:"res-btn res-btn-secondary",onClick:()=>g(!1),children:[e.jsx(me,{size:16})," Cancel"]})]})]}),e.jsxs("div",{className:"res-table-card",children:[e.jsxs("div",{className:"res-table-header",children:[e.jsxs("div",{className:"res-table-header-left",children:[e.jsx("h2",{className:"res-table-title",children:"Team Resources"}),f&&e.jsxs("select",{value:y,onChange:s=>U(s.target.value),className:"res-filter-select",children:[e.jsxs("option",{value:"all",children:["All (",p.length,")"]}),e.jsxs("option",{value:"internal",children:["Internal (",Q,")"]}),e.jsxs("option",{value:"third_party",children:["Third-Party (",Y,")"]})]})]}),e.jsxs("span",{className:"res-table-count",children:[_.length," resource",_.length!==1?"s":""]})]}),e.jsxs("table",{className:"res-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),f&&e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Role"}),e.jsx("th",{children:"SFIA"}),e.jsx("th",{children:"Rate"}),d&&e.jsx("th",{children:"Cost"}),d&&e.jsx("th",{children:"Margin"}),e.jsx("th",{children:"Days"}),e.jsx("th",{children:"Util"}),e.jsx("th",{children:"Value"})]})}),e.jsx("tbody",{children:_.map(s=>{const i=M[s.id]||0,c=ie(i),l=s.days_allocated||0,m=l>0?c/l*100:0,x=K(s.resource_type),N=G(s.sell_price,s.cost_price),A=V(N),Z=A.icon;return e.jsxs("tr",{onClick:()=>D(`/resources/${s.id}`),children:[e.jsx("td",{children:e.jsxs("div",{className:"res-name-cell",children:[e.jsx("span",{className:"res-name",children:s.name}),e.jsx("span",{className:"res-email",children:s.email})]})}),f&&e.jsx("td",{children:e.jsxs("span",{className:`res-type-badge ${x.className}`,children:[s.resource_type==="third_party"?e.jsx(xe,{size:14}):e.jsx(je,{size:14}),x.label]})}),e.jsx("td",{children:s.role}),e.jsx("td",{children:e.jsxs("span",{className:`res-sfia-badge ${J(s.sfia_level)}`,children:[e.jsx(fe,{size:14}),T(s.sfia_level)]})}),e.jsxs("td",{className:"res-mono",children:["£",s.sell_price]}),d&&e.jsx("td",{className:"res-mono",children:s.cost_price?`£${s.cost_price}`:e.jsx("span",{className:"res-na",children:"—"})}),d&&e.jsx("td",{children:e.jsxs("span",{className:"res-margin",style:{color:A.color},children:[e.jsx(Z,{size:14}),N!==null?`${N.toFixed(0)}%`:"N/A"]})}),e.jsx("td",{children:e.jsxs("span",{className:"res-days",children:[c.toFixed(1),"/",l]})}),e.jsx("td",{children:e.jsxs("div",{className:"res-util",children:[e.jsx("div",{className:"res-util-bar",children:e.jsx("div",{className:"res-util-fill",style:{width:`${Math.min(m,100)}%`,backgroundColor:m>100?"#dc2626":"#3b82f6"}})}),e.jsxs("span",{className:"res-util-text",children:[Math.round(m),"%"]})]})}),e.jsxs("td",{className:"res-value",children:["£",((s.sell_price||0)*(s.days_allocated||0)).toLocaleString()]})]},s.id)})})]})]})]}),e.jsx(oe,{isOpen:n.isOpen,onClose:()=>w({isOpen:!1,resource:null,dependents:null}),onConfirm:q,title:"Delete Resource?",message:n.resource?e.jsxs(e.Fragment,{children:['Delete "',e.jsx("strong",{children:n.resource.name}),'"?',n.dependents&&(n.dependents.timesheets>0||n.dependents.expenses>0)&&e.jsxs(e.Fragment,{children:[e.jsx("br",{}),e.jsx("br",{}),e.jsxs("span",{style:{color:"#dc2626"},children:["⚠️ Also deletes: ",n.dependents.timesheets," timesheets, ",n.dependents.expenses," expenses"]})]})]}):"",confirmText:"Delete",type:"danger",isLoading:W})]})}export{Le as default};
