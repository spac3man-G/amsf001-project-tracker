import{u as k,a as F,s as f,j as e,L as D,P as E}from"./index-DjXTtB8m.js";import{u as O,r as l}from"./vendor-react-JFEV0ROX.js";import{u as W}from"./usePermissions-BN-cu4kW.js";import{u as x,i as q,C as $,R as A,N as J,w as U,D as H,I as Y}from"./vendor-icons-Bd7vp13O.js";import"./vendor-supabase-DgEUAXvv.js";function ee(){const P=O(),{user:G,role:j}=k(),{projectId:o,refreshProject:b}=F(),{canAccessSettings:y}=W(),[M,T]=l.useState(!0),[c,v]=l.useState(!1),[S,d]=l.useState(null),[s,g]=l.useState({name:"",reference:"",total_budget:0,pmo_threshold:15}),[B,N]=l.useState(null),[h,z]=l.useState([]),[p,C]=l.useState(null);l.useEffect(()=>{if(o&&j){if(!y){P("/dashboard");return}I()}},[o,j]);async function I(){try{const{data:t,error:r}=await f.from("projects").select("*").eq("id",o).single();if(r)throw r;if(t){const w={name:t.name||"",reference:t.reference||"",total_budget:t.total_budget||326829,pmo_threshold:t.pmo_threshold||15};g(w),N(w)}const{data:i,error:n}=await f.from("milestones").select("id, milestone_ref, name, budget").eq("project_id",o).order("milestone_ref");if(n)throw n;z(i||[])}catch{d("error")}finally{T(!1)}}async function L(){v(!0),d(null);try{const{data:t,error:r}=await f.from("projects").update({name:s.name,total_budget:parseFloat(s.total_budget)||0,pmo_threshold:parseInt(s.pmo_threshold)||15}).eq("id",o).select();if(r)throw r;if(!t||t.length===0)throw new Error("Update failed - no rows returned. This may be a permissions issue.");N({...s}),d("success"),b&&b(),setTimeout(()=>d(null),3e3)}catch{d("error")}finally{v(!1)}}async function R(t,r){C(t);try{const{error:i}=await f.from("milestones").update({budget:parseFloat(r)||0}).eq("id",t);if(i)throw i;z(h.map(n=>n.id===t?{...n,budget:parseFloat(r)||0}:n))}catch(i){alert("Failed to update milestone budget: "+i.message)}finally{C(null)}}const m=h.reduce((t,r)=>t+(parseFloat(r.budget)||0),0),u=parseFloat(s.total_budget)-m,a=s.total_budget>0?Math.round(m/s.total_budget*100):0,_=JSON.stringify(s)!==JSON.stringify(B);return M?e.jsx(D,{message:"Loading settings...",size:"large",fullPage:!0}):y?e.jsxs("div",{className:"page-container",children:[e.jsxs(E,{icon:q,title:"Project Settings",subtitle:"Configure project parameters and budget allocations",children:[S==="success"&&e.jsxs("span",{style:{color:"#10b981",display:"flex",alignItems:"center",gap:"0.25rem"},children:[e.jsx($,{size:18})," Saved"]}),S==="error"&&e.jsxs("span",{style:{color:"#ef4444",display:"flex",alignItems:"center",gap:"0.25rem"},children:[e.jsx(x,{size:18})," Error saving"]}),e.jsxs("button",{className:"btn btn-primary",onClick:L,disabled:c||!_,style:{opacity:!_||c?.6:1},children:[c?e.jsx(A,{size:18,className:"spin"}):e.jsx(J,{size:18}),c?"Saving...":"Save Settings"]})]}),e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsxs("h3",{style:{marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(U,{size:20}),"Project Information"]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Project Name"}),e.jsx("input",{className:"form-input",value:s.name,onChange:t=>g({...s,name:t.target.value})})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Project Reference"}),e.jsx("input",{className:"form-input",value:s.reference,disabled:!0,style:{backgroundColor:"#f1f5f9",cursor:"not-allowed"}}),e.jsx("span",{style:{fontSize:"0.8rem",color:"#64748b"},children:"Reference cannot be changed"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Total Project Budget (£)"}),e.jsx("input",{className:"form-input",type:"number",min:"0",step:"0.01",value:s.total_budget,onChange:t=>g({...s,total_budget:t.target.value})})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"PMO Threshold (%)"}),e.jsx("input",{className:"form-input",type:"number",min:"0",max:"100",value:s.pmo_threshold,onChange:t=>g({...s,pmo_threshold:t.target.value})}),e.jsx("span",{style:{fontSize:"0.8rem",color:"#64748b"},children:"Percentage of budget allocated to PMO overhead"})]})]})]}),e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsxs("h3",{style:{marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(H,{size:20}),"Milestone Budget Allocation"]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:"1rem",marginBottom:"1.5rem",padding:"1rem",backgroundColor:"#f8fafc",borderRadius:"8px"},children:[e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"0.85rem",color:"#64748b"},children:"Total Budget"}),e.jsxs("div",{style:{fontSize:"1.5rem",fontWeight:"700"},children:["£",parseFloat(s.total_budget).toLocaleString()]})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"0.85rem",color:"#64748b"},children:"Allocated to Milestones"}),e.jsxs("div",{style:{fontSize:"1.5rem",fontWeight:"700",color:"#3b82f6"},children:["£",m.toLocaleString()]})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"0.85rem",color:"#64748b"},children:"Unallocated"}),e.jsxs("div",{style:{fontSize:"1.5rem",fontWeight:"700",color:u<0?"#ef4444":u>0?"#f59e0b":"#10b981"},children:["£",u.toLocaleString()]})]})]}),e.jsxs("div",{style:{marginBottom:"1.5rem"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.85rem",color:"#64748b"},children:"Allocation Progress"}),e.jsxs("span",{style:{fontSize:"0.85rem",fontWeight:"600"},children:[a,"%"]})]}),e.jsx("div",{style:{width:"100%",height:"8px",backgroundColor:"#e2e8f0",borderRadius:"4px",overflow:"hidden"},children:e.jsx("div",{style:{width:`${Math.min(a,100)}%`,height:"100%",backgroundColor:a>100?"#ef4444":a===100?"#10b981":"#3b82f6",borderRadius:"4px",transition:"width 0.3s ease"}})}),a>100&&e.jsxs("div",{style:{color:"#ef4444",fontSize:"0.85rem",marginTop:"0.5rem",display:"flex",alignItems:"center",gap:"0.25rem"},children:[e.jsx(x,{size:14})," Budget over-allocated by £",Math.abs(u).toLocaleString()]})]}),h.length>0?e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Milestone"}),e.jsx("th",{children:"Name"}),e.jsx("th",{style:{textAlign:"right"},children:"Billable Amount (£)"}),e.jsx("th",{style:{textAlign:"right"},children:"% of Total"})]})}),e.jsxs("tbody",{children:[h.map(t=>e.jsxs("tr",{children:[e.jsx("td",{style:{fontFamily:"monospace",fontWeight:"600"},children:t.milestone_ref}),e.jsx("td",{children:t.name}),e.jsx("td",{style:{textAlign:"right"},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"flex-end",gap:"0.5rem"},children:[e.jsx("input",{type:"number",min:"0",step:"0.01",value:t.budget||"",onChange:r=>R(t.id,r.target.value),disabled:p===t.id,style:{width:"120px",textAlign:"right",padding:"0.25rem 0.5rem",border:"1px solid #d1d5db",borderRadius:"4px",opacity:p===t.id?.6:1}}),p===t.id&&e.jsx(A,{size:14,className:"spin",style:{color:"#3b82f6"}})]})}),e.jsx("td",{style:{textAlign:"right",color:"#64748b"},children:s.total_budget>0?`${((t.budget||0)/s.total_budget*100).toFixed(1)}%`:"0%"})]},t.id)),e.jsxs("tr",{style:{fontWeight:"700",backgroundColor:"#f8fafc"},children:[e.jsx("td",{colSpan:2,children:"Total Allocated"}),e.jsxs("td",{style:{textAlign:"right"},children:["£",m.toLocaleString()]}),e.jsxs("td",{style:{textAlign:"right"},children:[a,"%"]})]})]})]}):e.jsx("div",{style:{textAlign:"center",padding:"2rem",color:"#64748b"},children:e.jsx("p",{children:"No milestones found. Create milestones on the Milestones page to allocate budgets."})})]}),e.jsxs("div",{className:"card",style:{backgroundColor:"#eff6ff",borderLeft:"4px solid #3b82f6"},children:[e.jsxs("h4",{style:{marginBottom:"0.5rem",color:"#1e40af",display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(Y,{size:18}),"Settings Tips"]}),e.jsxs("ul",{style:{margin:"0.5rem 0 0 1.5rem",color:"#1e40af",fontSize:"0.9rem"},children:[e.jsxs("li",{children:["The ",e.jsx("strong",{children:"Total Budget"})," is used to calculate overall project progress on the Dashboard"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Milestone billable amounts"})," determine invoice values when milestones are completed and certificates are signed"]}),e.jsxs("li",{children:["The ",e.jsx("strong",{children:"PMO Threshold"})," helps separate management costs from delivery costs on the Dashboard"]}),e.jsx("li",{children:"Milestone budget changes are saved automatically when you change the value"}),e.jsx("li",{children:'Project name and budget changes require clicking "Save Settings"'})]})]})]}):e.jsx("div",{className:"page-container",children:e.jsxs("div",{className:"card",style:{textAlign:"center",padding:"3rem"},children:[e.jsx(x,{size:48,style:{color:"#ef4444",marginBottom:"1rem"}}),e.jsx("h2",{children:"Access Denied"}),e.jsx("p",{style:{color:"#64748b"},children:"You don't have permission to access project settings."}),e.jsx("p",{style:{color:"#64748b",fontSize:"0.9rem"},children:"Only Supplier PM and Admin can access this page."})]})})}export{ee as default};
