import{u as k,a as F,d as O,s as _,m as A,j as e,L as D}from"./index-CADyJjeh.js";import{d as E,r as l}from"./vendor-react-BUTV5ZEl.js";import{P as W}from"./PageHeader-XqSgIxLq.js";import{a3 as f,K as q,b as $,R as P,af as J,m as U,ab as H,I as K}from"./vendor-icons-CtZxSxcO.js";import"./vendor-supabase-6faYzd5A.js";function ee(){const w=E(),{user:Y,role:p}=k(),{projectId:n,refreshProject:x}=F(),{canAccessSettings:j}=O(),[M,B]=l.useState(!0),[d,b]=l.useState(!1),[y,o]=l.useState(null),[s,c]=l.useState({name:"",reference:"",total_budget:0,pmo_threshold:15}),[T,v]=l.useState(null),[g,S]=l.useState([]),[u,N]=l.useState(null);l.useEffect(()=>{if(n&&p){if(!j){w("/dashboard");return}I()}},[n,p]);async function I(){try{const{data:t,error:r}=await _.from("projects").select("*").eq("id",n).single();if(r)throw r;if(t){const C={name:t.name||"",reference:t.reference||"",total_budget:t.total_budget||326829,pmo_threshold:t.pmo_threshold||15};c(C),v(C)}const a=await A.getAll(n,{orderBy:{column:"milestone_ref",ascending:!0}});S(a||[])}catch{o("error")}finally{B(!1)}}async function L(){b(!0),o(null);try{const{data:t,error:r}=await _.from("projects").update({name:s.name,total_budget:parseFloat(s.total_budget)||0,pmo_threshold:parseInt(s.pmo_threshold)||15}).eq("id",n).select();if(r)throw r;if(!t||t.length===0)throw new Error("Update failed - no rows returned. This may be a permissions issue.");v({...s}),o("success"),x&&x(),setTimeout(()=>o(null),3e3)}catch{o("error")}finally{b(!1)}}async function R(t,r){N(t);try{await A.update(t,{budget:parseFloat(r)||0}),S(g.map(a=>a.id===t?{...a,budget:parseFloat(r)||0}:a))}catch(a){alert("Failed to update milestone budget: "+a.message)}finally{N(null)}}const h=g.reduce((t,r)=>t+(parseFloat(r.billable)||0),0),m=parseFloat(s.total_budget)-h,i=s.total_budget>0?Math.round(h/s.total_budget*100):0,z=JSON.stringify(s)!==JSON.stringify(T);return M?e.jsx(D,{message:"Loading settings...",size:"large",fullPage:!0}):j?e.jsxs("div",{className:"page-container",children:[e.jsxs(W,{icon:q,title:"Project Settings",subtitle:"Configure project parameters and budget allocations",children:[y==="success"&&e.jsxs("span",{style:{color:"#10b981",display:"flex",alignItems:"center",gap:"0.25rem"},children:[e.jsx($,{size:18})," Saved"]}),y==="error"&&e.jsxs("span",{style:{color:"#ef4444",display:"flex",alignItems:"center",gap:"0.25rem"},children:[e.jsx(f,{size:18})," Error saving"]}),e.jsxs("button",{className:"btn btn-primary",onClick:L,disabled:d||!z,style:{opacity:!z||d?.6:1},children:[d?e.jsx(P,{size:18,className:"spin"}):e.jsx(J,{size:18}),d?"Saving...":"Save Settings"]})]}),e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsxs("h3",{style:{marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(U,{size:20}),"Project Information"]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Project Name"}),e.jsx("input",{className:"form-input",value:s.name,onChange:t=>c({...s,name:t.target.value})})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Project Reference"}),e.jsx("input",{className:"form-input",value:s.reference,disabled:!0,style:{backgroundColor:"#f1f5f9",cursor:"not-allowed"}}),e.jsx("span",{style:{fontSize:"0.8rem",color:"#64748b"},children:"Reference cannot be changed"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Total Project Budget (£)"}),e.jsx("input",{className:"form-input",type:"number",min:"0",step:"0.01",value:s.total_budget,onChange:t=>c({...s,total_budget:t.target.value})})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"PMO Threshold (%)"}),e.jsx("input",{className:"form-input",type:"number",min:"0",max:"100",value:s.pmo_threshold,onChange:t=>c({...s,pmo_threshold:t.target.value})}),e.jsx("span",{style:{fontSize:"0.8rem",color:"#64748b"},children:"Percentage of budget allocated to PMO overhead"})]})]})]}),e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsxs("h3",{style:{marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(H,{size:20}),"Milestone Budget Allocation"]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(3, 1fr)",gap:"1rem",marginBottom:"1.5rem",padding:"1rem",backgroundColor:"#f8fafc",borderRadius:"8px"},children:[e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"0.85rem",color:"#64748b"},children:"Total Budget"}),e.jsxs("div",{style:{fontSize:"1.5rem",fontWeight:"700"},children:["£",parseFloat(s.total_budget).toLocaleString()]})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"0.85rem",color:"#64748b"},children:"Allocated to Milestones"}),e.jsxs("div",{style:{fontSize:"1.5rem",fontWeight:"700",color:"#3b82f6"},children:["£",h.toLocaleString()]})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"0.85rem",color:"#64748b"},children:"Unallocated"}),e.jsxs("div",{style:{fontSize:"1.5rem",fontWeight:"700",color:m<0?"#ef4444":m>0?"#f59e0b":"#10b981"},children:["£",m.toLocaleString()]})]})]}),e.jsxs("div",{style:{marginBottom:"1.5rem"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.85rem",color:"#64748b"},children:"Allocation Progress"}),e.jsxs("span",{style:{fontSize:"0.85rem",fontWeight:"600"},children:[i,"%"]})]}),e.jsx("div",{style:{width:"100%",height:"8px",backgroundColor:"#e2e8f0",borderRadius:"4px",overflow:"hidden"},children:e.jsx("div",{style:{width:`${Math.min(i,100)}%`,height:"100%",backgroundColor:i>100?"#ef4444":i===100?"#10b981":"#3b82f6",borderRadius:"4px",transition:"width 0.3s ease"}})}),i>100&&e.jsxs("div",{style:{color:"#ef4444",fontSize:"0.85rem",marginTop:"0.5rem",display:"flex",alignItems:"center",gap:"0.25rem"},children:[e.jsx(f,{size:14})," Budget over-allocated by £",Math.abs(m).toLocaleString()]})]}),g.length>0?e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Milestone"}),e.jsx("th",{children:"Name"}),e.jsx("th",{style:{textAlign:"right"},children:"Billable Amount (£)"}),e.jsx("th",{style:{textAlign:"right"},children:"% of Total"})]})}),e.jsxs("tbody",{children:[g.map(t=>e.jsxs("tr",{children:[e.jsx("td",{style:{fontFamily:"monospace",fontWeight:"600"},children:t.milestone_ref}),e.jsx("td",{children:t.name}),e.jsx("td",{style:{textAlign:"right"},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"flex-end",gap:"0.5rem"},children:[e.jsx("input",{type:"number",min:"0",step:"0.01",value:t.billable||"",onChange:r=>R(t.id,r.target.value),disabled:u===t.id,style:{width:"120px",textAlign:"right",padding:"0.25rem 0.5rem",border:"1px solid #d1d5db",borderRadius:"4px",opacity:u===t.id?.6:1}}),u===t.id&&e.jsx(P,{size:14,className:"spin",style:{color:"#3b82f6"}})]})}),e.jsx("td",{style:{textAlign:"right",color:"#64748b"},children:s.total_budget>0?`${((t.billable||0)/s.total_budget*100).toFixed(1)}%`:"0%"})]},t.id)),e.jsxs("tr",{style:{fontWeight:"700",backgroundColor:"#f8fafc"},children:[e.jsx("td",{colSpan:2,children:"Total Allocated"}),e.jsxs("td",{style:{textAlign:"right"},children:["£",h.toLocaleString()]}),e.jsxs("td",{style:{textAlign:"right"},children:[i,"%"]})]})]})]}):e.jsx("div",{style:{textAlign:"center",padding:"2rem",color:"#64748b"},children:e.jsx("p",{children:"No milestones found. Create milestones on the Milestones page to allocate budgets."})})]}),e.jsxs("div",{className:"card",style:{backgroundColor:"#eff6ff",borderLeft:"4px solid #3b82f6"},children:[e.jsxs("h4",{style:{marginBottom:"0.5rem",color:"#1e40af",display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(K,{size:18}),"Settings Tips"]}),e.jsxs("ul",{style:{margin:"0.5rem 0 0 1.5rem",color:"#1e40af",fontSize:"0.9rem"},children:[e.jsxs("li",{children:["The ",e.jsx("strong",{children:"Total Budget"})," is used to calculate overall project progress on the Dashboard"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Milestone billable amounts"})," determine invoice values when milestones are completed and certificates are signed"]}),e.jsxs("li",{children:["The ",e.jsx("strong",{children:"PMO Threshold"})," helps separate management costs from delivery costs on the Dashboard"]}),e.jsx("li",{children:"Milestone budget changes are saved automatically when you change the value"}),e.jsx("li",{children:'Project name and budget changes require clicking "Save Settings"'})]})]})]}):e.jsx("div",{className:"page-container",children:e.jsxs("div",{className:"card",style:{textAlign:"center",padding:"3rem"},children:[e.jsx(f,{size:48,style:{color:"#ef4444",marginBottom:"1rem"}}),e.jsx("h2",{children:"Access Denied"}),e.jsx("p",{style:{color:"#64748b"},children:"You don't have permission to access project settings."}),e.jsx("p",{style:{color:"#64748b",fontSize:"0.9rem"},children:"Only Supplier PM and Admin can access this page."})]})})}export{ee as default};
