import{u as J,n as Y,f as G,c as H,s as p,j as e,L as F}from"./index-IaXQkjEL.js";import{r as m,d as K}from"./vendor-react-BUTV5ZEl.js";/* empty css                    */import{z as h,a3 as Q,x as X,R as Z,ai as _,aU as P,a$ as V,b0 as ee}from"./vendor-icons-C6BNM9_X.js";import"./vendor-supabase-6faYzd5A.js";function ne(){const[o,W]=m.useState([]),[B,k]=m.useState(!0),[D,f]=m.useState(!1),[j,C]=m.useState(!1),[t,c]=m.useState({email:"",password:"",full_name:"",isAdmin:!1}),z=K(),{user:A}=J(),{isSystemAdmin:y,loading:b}=Y(),{showTestUsers:n,toggleTestUsers:L,canToggleTestUsers:$}=G(),{showSuccess:w,showError:g,showWarning:N}=H();m.useEffect(()=>{b||(y?x():z("/dashboard"))},[y,n,z,b]);async function x(){try{k(!0);const{data:s,error:a}=await p.from("profiles").select("id, email, full_name, role, is_test_user, created_at").order("created_at",{ascending:!1});if(a)throw a;const{data:r,error:l}=await p.from("user_projects").select("id, user_id, role, project_id");if(l)throw l;const T=[...new Set((r||[]).map(i=>i.project_id))];let R=[];if(T.length>0){const{data:i,error:u}=await p.from("projects").select("id, name, reference").in("id",T);if(u)throw u;R=i||[]}let S=(s||[]).map(i=>{const u=(r||[]).filter(d=>d.user_id===i.id);return{id:i.id,email:i.email,full_name:i.full_name,isAdmin:i.role==="admin",is_test_user:i.is_test_user,created_at:i.created_at,projects:u.map(d=>{const E=R.find(M=>M.id===d.project_id);return{id:d.project_id,name:E?.name||"Unknown",reference:E?.reference||"",role:d.role}}).filter(d=>d.id)}});n||(S=S.filter(i=>!i.is_test_user)),W(S)}catch{g("Failed to load system users")}finally{k(!1)}}async function O(){if(!t.email||!t.password){N("Email and password are required");return}if(t.password.length<8){N("Password must be at least 8 characters");return}try{C(!0);const{data:{session:s}}=await p.auth.getSession(),a=await fetch("/api/create-user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t.email,password:t.password,full_name:t.full_name||t.email.split("@")[0],role:t.isAdmin?"admin":"viewer",adminToken:s?.access_token})}),r=await a.json();if(!a.ok)throw new Error(r.error||"Failed to create user");await x(),f(!1),c({email:"",password:"",full_name:"",isAdmin:!1}),w("User created! They will need to set a secure password on first login.")}catch(s){g("Failed to create user: "+s.message)}finally{C(!1)}}async function I(s,a){if(s===A?.id&&a){N("You can't remove your own admin access");return}try{const r=a?"viewer":"admin",{error:l}=await p.from("profiles").update({role:r}).eq("id",s);if(l)throw l;await x(),w(a?"Admin access removed":"Admin access granted")}catch{g("Failed to update admin status")}}async function q(s,a){try{const{error:r}=await p.from("profiles").update({is_test_user:!a}).eq("id",s);if(r)throw r;await x(),w(a?"User marked as real":"User marked as test")}catch{g("Failed to update user")}}const U=o.filter(s=>s.isAdmin).length,v=o.filter(s=>s.is_test_user).length;return b?e.jsx(F,{message:"Loading permissions...",size:"large",fullPage:!0}):y?B?e.jsx(F,{message:"Loading system users...",size:"large",fullPage:!0}):e.jsxs("div",{className:"users-page",children:[e.jsx("header",{className:"users-header",children:e.jsxs("div",{className:"header-content",children:[e.jsxs("div",{className:"header-title",children:[e.jsx(h,{size:28,strokeWidth:1.5}),e.jsxs("div",{children:[e.jsx("h1",{children:"System Users"}),e.jsxs("p",{children:[o.length," user account",o.length!==1?"s":""," in the system"]})]})]}),e.jsxs("div",{className:"header-actions",children:[$&&e.jsxs("button",{onClick:L,className:`btn-toggle ${n?"active":""}`,children:[n?e.jsx(Q,{size:16}):e.jsx(X,{size:16}),n?"Hide Test":"Show Test"]}),e.jsx("button",{className:"btn-secondary",onClick:x,children:e.jsx(Z,{size:16})}),e.jsxs("button",{className:"btn-primary",onClick:()=>f(!0),children:[e.jsx(_,{size:16}),"Create User"]})]})]})}),e.jsxs("div",{className:"users-content",children:[e.jsxs("div",{className:"stats-row",style:{display:"flex",gap:"12px",marginBottom:"20px",flexWrap:"wrap"},children:[e.jsxs("div",{className:"stat-chip",style:{padding:"8px 16px",background:"#f8fafc",borderRadius:"8px",fontSize:"14px"},children:[e.jsx("strong",{children:o.length})," Total Users"]}),e.jsxs("div",{className:"stat-chip",style:{padding:"8px 16px",background:"#7c3aed15",color:"#7c3aed",borderRadius:"8px",fontSize:"14px"},children:[e.jsx("strong",{children:U})," Admin",U!==1?"s":""]})]}),D&&e.jsxs("div",{className:"create-form-card",style:{background:"white",border:"1px solid #e2e8f0",borderRadius:"12px",padding:"24px",marginBottom:"20px"},children:[e.jsx("h3",{style:{margin:"0 0 16px",fontSize:"18px"},children:"Create New User"}),e.jsxs("div",{className:"form-grid",style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:"16px",alignItems:"end"},children:[e.jsxs("div",{className:"form-field",children:[e.jsx("label",{style:{display:"block",marginBottom:"4px",fontWeight:"500",fontSize:"14px"},children:"Email *"}),e.jsx("input",{type:"email",placeholder:"user@example.com",value:t.email,onChange:s=>c({...t,email:s.target.value}),style:{width:"100%",padding:"10px 12px",border:"1px solid #e2e8f0",borderRadius:"8px",fontSize:"14px"}})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{style:{display:"block",marginBottom:"4px",fontWeight:"500",fontSize:"14px"},children:"Password *"}),e.jsx("input",{type:"password",placeholder:"Min 8 characters",value:t.password,onChange:s=>c({...t,password:s.target.value}),style:{width:"100%",padding:"10px 12px",border:"1px solid #e2e8f0",borderRadius:"8px",fontSize:"14px"}})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{style:{display:"block",marginBottom:"4px",fontWeight:"500",fontSize:"14px"},children:"Full Name"}),e.jsx("input",{type:"text",placeholder:"John Smith",value:t.full_name,onChange:s=>c({...t,full_name:s.target.value}),style:{width:"100%",padding:"10px 12px",border:"1px solid #e2e8f0",borderRadius:"8px",fontSize:"14px"}})]}),e.jsxs("div",{className:"form-field",children:[e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"10px",padding:"10px 0",cursor:"pointer",fontSize:"14px",fontWeight:"500"},children:[e.jsx("input",{type:"checkbox",checked:t.isAdmin,onChange:s=>c({...t,isAdmin:s.target.checked}),style:{width:"18px",height:"18px",accentColor:"#7c3aed",cursor:"pointer"}}),e.jsx(h,{size:16,style:{color:"#7c3aed"}}),"Make Admin"]}),e.jsx("p",{style:{fontSize:"12px",color:"#64748b",margin:"4px 0 0"},children:"Admins can manage all system users"})]})]}),e.jsxs("div",{className:"form-actions",style:{marginTop:"16px",display:"flex",gap:"12px"},children:[e.jsxs("button",{className:"btn-primary",onClick:O,disabled:j,style:{padding:"10px 20px",background:"#7c3aed",color:"white",border:"none",borderRadius:"8px",cursor:j?"not-allowed":"pointer",display:"flex",alignItems:"center",gap:"8px",fontSize:"14px",fontWeight:"500"},children:[e.jsx(_,{size:16})," ",j?"Creating...":"Create User"]}),e.jsx("button",{className:"btn-secondary",onClick:()=>{f(!1),c({email:"",password:"",full_name:"",isAdmin:!1})},style:{padding:"10px 20px",background:"#f1f5f9",color:"#64748b",border:"none",borderRadius:"8px",cursor:"pointer",fontSize:"14px",fontWeight:"500"},children:"Cancel"})]})]}),n&&v>0&&e.jsxs("div",{className:"test-banner",children:[e.jsx(P,{size:16}),e.jsxs("span",{children:["Showing ",v," test user",v!==1?"s":""]})]}),e.jsx("div",{className:"table-card",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"User"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"Admin"}),e.jsx("th",{children:"Projects"}),e.jsx("th",{children:"Created"}),n&&e.jsx("th",{children:"Type"})]})}),e.jsx("tbody",{children:o.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:n?6:5,className:"empty-state",children:e.jsxs("div",{style:{textAlign:"center",padding:"40px 20px"},children:[e.jsx(h,{size:48,style:{color:"#94a3b8",marginBottom:"12px"}}),e.jsx("p",{style:{color:"#64748b",marginBottom:"16px"},children:"No user accounts in the system yet"}),e.jsxs("button",{className:"btn-primary",onClick:()=>f(!0),style:{display:"inline-flex",alignItems:"center",gap:"8px"},children:[e.jsx(_,{size:16}),"Create First User"]})]})})}):o.map(s=>{const a=s.is_test_user,r=s.id===A?.id;return e.jsxs("tr",{className:a?"test-user-row":"",children:[e.jsx("td",{children:e.jsxs("div",{className:"user-cell",children:[e.jsx("div",{className:`user-avatar ${a?"test":""}`,children:(s.full_name||s.email||"U")[0].toUpperCase()}),e.jsxs("div",{className:"user-info",children:[e.jsx("span",{className:"user-name",children:s.full_name||"No name"}),r&&e.jsx("span",{className:"you-badge",children:"you"})]})]})}),e.jsx("td",{className:"email-cell",children:s.email}),e.jsx("td",{children:e.jsx("button",{onClick:()=>I(s.id,s.isAdmin),className:`admin-toggle ${s.isAdmin?"is-admin":""}`,title:r&&s.isAdmin?"You can't remove your own admin access":s.isAdmin?"Click to remove admin access":"Click to grant admin access",disabled:r&&s.isAdmin,style:{display:"inline-flex",alignItems:"center",gap:"6px",padding:"6px 12px",borderRadius:"6px",border:"none",fontSize:"13px",fontWeight:"500",cursor:r&&s.isAdmin?"not-allowed":"pointer",transition:"all 0.15s ease",background:s.isAdmin?"#7c3aed15":"#f1f5f9",color:s.isAdmin?"#7c3aed":"#94a3b8",opacity:r&&s.isAdmin?.6:1},children:s.isAdmin?e.jsxs(e.Fragment,{children:[e.jsx(V,{size:14}),"Admin"]}):e.jsxs(e.Fragment,{children:[e.jsx(ee,{size:14}),"No"]})})}),e.jsx("td",{children:s.projects.length>0?e.jsxs("span",{className:"projects-badge",title:s.projects.map(l=>`${l.reference||l.name} (${l.role})`).join(", "),style:{background:"#dbeafe",color:"#2563eb",padding:"4px 10px",borderRadius:"12px",fontSize:"13px",cursor:"help"},children:[s.projects.length," project",s.projects.length!==1?"s":""]}):e.jsx("span",{style:{color:"#94a3b8",fontSize:"13px"},children:"No projects"})}),e.jsx("td",{className:"date-cell",children:s.created_at?new Date(s.created_at).toLocaleDateString("en-GB"):"-"}),n&&e.jsx("td",{children:e.jsx("button",{onClick:()=>q(s.id,s.is_test_user),className:`type-badge ${a?"test":"real"}`,style:{cursor:"pointer",border:"none",background:"transparent"},title:a?"Click to mark as real user":"Click to mark as test user",children:a?e.jsxs(e.Fragment,{children:[e.jsx(P,{size:12})," Test"]}):"Real"})})]},s.id)})})]})}),e.jsxs("div",{style:{marginTop:"24px",padding:"16px 20px",background:"#f8fafc",borderRadius:"8px",fontSize:"14px",color:"#64748b",display:"flex",alignItems:"flex-start",gap:"12px"},children:[e.jsx(h,{size:18,style:{color:"#7c3aed",flexShrink:0,marginTop:"2px"}}),e.jsxs("div",{children:[e.jsx("strong",{style:{color:"#334155"},children:"About Admin Access"}),e.jsx("p",{style:{margin:"4px 0 0"},children:"Admins can access this System Users page and manage all user accounts. Project-level permissions (what users can do within each project) are managed separately via the Team Members page for each project."})]})]})]})]}):e.jsx("div",{className:"users-page",children:e.jsxs("div",{className:"access-denied",children:[e.jsx(h,{size:48}),e.jsx("h2",{children:"Access Denied"}),e.jsx("p",{children:"Only administrators can access system user management."})]})})}export{ne as default};
