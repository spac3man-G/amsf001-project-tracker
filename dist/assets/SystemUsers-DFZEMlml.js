import{u as J,n as H,f as K,c as Q,s as u,j as e,L as E}from"./index-CvJ0uIlS.js";import{r as p,d as V}from"./vendor-react-BUTV5ZEl.js";/* empty css                    */import{z as N,a3 as X,x as Y,R as Z,ai as S,aU as P}from"./vendor-icons-qkJ_CSr6.js";import"./vendor-supabase-6faYzd5A.js";function le(){const[n,B]=p.useState([]),[W,C]=p.useState(!0),[D,x]=p.useState(!1),[j,k]=p.useState(!1),[r,d]=p.useState({email:"",password:"",full_name:"",role:"viewer"}),z=V(),{user:L}=J(),{isSystemAdmin:b,loading:y}=H(),{showTestUsers:i,toggleTestUsers:A,canToggleTestUsers:$}=K(),{showSuccess:U,showError:v,showWarning:R}=Q(),m=[{value:"admin",label:"Admin",color:"#7c3aed"},{value:"supplier_pm",label:"Supplier PM",color:"#059669"},{value:"supplier_finance",label:"Supplier Finance",color:"#0d9488"},{value:"customer_pm",label:"Customer PM",color:"#d97706"},{value:"customer_finance",label:"Customer Finance",color:"#ea580c"},{value:"contributor",label:"Contributor",color:"#2563eb"},{value:"viewer",label:"Viewer",color:"#64748b"}];p.useEffect(()=>{y||(b?h():z("/dashboard"))},[b,i,z,y]);async function h(){try{C(!0);const{data:s,error:a}=await u.from("profiles").select("id, email, full_name, role, is_test_user, created_at").order("created_at",{ascending:!1});if(a)throw a;const{data:t,error:f}=await u.from("user_projects").select("id, user_id, role, project_id");if(f)throw f;const c=[...new Set((t||[]).map(l=>l.project_id))];let T=[];if(c.length>0){const{data:l,error:g}=await u.from("projects").select("id, name, reference").in("id",c);if(g)throw g;T=l||[]}let _=(s||[]).map(l=>{const g=(t||[]).filter(o=>o.user_id===l.id);return{id:l.id,email:l.email,full_name:l.full_name,global_role:l.role,is_test_user:l.is_test_user,created_at:l.created_at,projects:g.map(o=>{const F=T.find(q=>q.id===o.project_id);return{id:o.project_id,name:F?.name||"Unknown",reference:F?.reference||"",role:o.role}}).filter(o=>o.id)}});i||(_=_.filter(l=>!l.is_test_user)),B(_)}catch{v("Failed to load system users")}finally{C(!1)}}async function G(){if(!r.email||!r.password){R("Email and password are required");return}if(r.password.length<8){R("Password must be at least 8 characters");return}try{k(!0);const{data:{session:s}}=await u.auth.getSession(),a=await fetch("/api/create-user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:r.email,password:r.password,full_name:r.full_name||r.email.split("@")[0],role:r.role,adminToken:s?.access_token})}),t=await a.json();if(!a.ok)throw new Error(t.error||"Failed to create user");await h(),x(!1),d({email:"",password:"",full_name:"",role:"viewer"}),U("User created! They will need to set a secure password on first login.")}catch(s){v("Failed to create user: "+s.message)}finally{k(!1)}}async function M(s,a){try{const{error:t}=await u.from("profiles").update({is_test_user:!a}).eq("id",s);if(t)throw t;await h(),U(a?"User marked as real":"User marked as test")}catch{v("Failed to update user")}}function O(s){return m.find(a=>a.value===s)||m[6]}const I=n.reduce((s,a)=>(s[a.global_role]=(s[a.global_role]||0)+1,s),{}),w=n.filter(s=>s.is_test_user).length;return y?e.jsx(E,{message:"Loading permissions...",size:"large",fullPage:!0}):b?W?e.jsx(E,{message:"Loading system users...",size:"large",fullPage:!0}):e.jsxs("div",{className:"users-page",children:[e.jsx("header",{className:"users-header",children:e.jsxs("div",{className:"header-content",children:[e.jsxs("div",{className:"header-title",children:[e.jsx(N,{size:28,strokeWidth:1.5}),e.jsxs("div",{children:[e.jsx("h1",{children:"System Users"}),e.jsxs("p",{children:[n.length," user account",n.length!==1?"s":""," in the system"]})]})]}),e.jsxs("div",{className:"header-actions",children:[$&&e.jsxs("button",{onClick:A,className:`btn-toggle ${i?"active":""}`,children:[i?e.jsx(X,{size:16}):e.jsx(Y,{size:16}),i?"Hide Test":"Show Test"]}),e.jsx("button",{className:"btn-secondary",onClick:h,children:e.jsx(Z,{size:16})}),e.jsxs("button",{className:"btn-primary",onClick:()=>x(!0),children:[e.jsx(S,{size:16}),"Create User"]})]})]})}),e.jsxs("div",{className:"users-content",children:[e.jsxs("div",{className:"stats-row",style:{display:"flex",gap:"12px",marginBottom:"20px",flexWrap:"wrap"},children:[e.jsxs("div",{className:"stat-chip",style:{padding:"8px 16px",background:"#f8fafc",borderRadius:"8px",fontSize:"14px"},children:[e.jsx("strong",{children:n.length})," Total Users"]}),m.map(s=>{const a=I[s.value]||0;return a===0?null:e.jsxs("div",{className:"stat-chip",style:{padding:"8px 16px",background:s.color+"15",color:s.color,borderRadius:"8px",fontSize:"14px"},children:[e.jsx("strong",{children:a})," ",s.label]},s.value)})]}),D&&e.jsxs("div",{className:"create-form-card",style:{background:"white",border:"1px solid #e2e8f0",borderRadius:"12px",padding:"24px",marginBottom:"20px"},children:[e.jsx("h3",{style:{margin:"0 0 16px",fontSize:"18px"},children:"Create New User"}),e.jsxs("div",{className:"form-grid",style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:"16px"},children:[e.jsxs("div",{className:"form-field",children:[e.jsx("label",{style:{display:"block",marginBottom:"4px",fontWeight:"500",fontSize:"14px"},children:"Email *"}),e.jsx("input",{type:"email",placeholder:"user@example.com",value:r.email,onChange:s=>d({...r,email:s.target.value}),style:{width:"100%",padding:"10px 12px",border:"1px solid #e2e8f0",borderRadius:"8px",fontSize:"14px"}})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{style:{display:"block",marginBottom:"4px",fontWeight:"500",fontSize:"14px"},children:"Password *"}),e.jsx("input",{type:"password",placeholder:"Min 8 characters",value:r.password,onChange:s=>d({...r,password:s.target.value}),style:{width:"100%",padding:"10px 12px",border:"1px solid #e2e8f0",borderRadius:"8px",fontSize:"14px"}})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{style:{display:"block",marginBottom:"4px",fontWeight:"500",fontSize:"14px"},children:"Full Name"}),e.jsx("input",{type:"text",placeholder:"John Smith",value:r.full_name,onChange:s=>d({...r,full_name:s.target.value}),style:{width:"100%",padding:"10px 12px",border:"1px solid #e2e8f0",borderRadius:"8px",fontSize:"14px"}})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{style:{display:"block",marginBottom:"4px",fontWeight:"500",fontSize:"14px"},children:"Global Role"}),e.jsx("select",{value:r.role,onChange:s=>d({...r,role:s.target.value}),style:{width:"100%",padding:"10px 12px",border:"1px solid #e2e8f0",borderRadius:"8px",fontSize:"14px",background:"white"},children:m.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]})]}),e.jsxs("div",{className:"form-actions",style:{marginTop:"16px",display:"flex",gap:"12px"},children:[e.jsxs("button",{className:"btn-primary",onClick:G,disabled:j,style:{padding:"10px 20px",background:"#7c3aed",color:"white",border:"none",borderRadius:"8px",cursor:j?"not-allowed":"pointer",display:"flex",alignItems:"center",gap:"8px",fontSize:"14px",fontWeight:"500"},children:[e.jsx(S,{size:16})," ",j?"Creating...":"Create User"]}),e.jsx("button",{className:"btn-secondary",onClick:()=>{x(!1),d({email:"",password:"",full_name:"",role:"viewer"})},style:{padding:"10px 20px",background:"#f1f5f9",color:"#64748b",border:"none",borderRadius:"8px",cursor:"pointer",fontSize:"14px",fontWeight:"500"},children:"Cancel"})]})]}),i&&w>0&&e.jsxs("div",{className:"test-banner",children:[e.jsx(P,{size:16}),e.jsxs("span",{children:["Showing ",w," test user",w!==1?"s":""]})]}),e.jsx("div",{className:"table-card",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"User"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"Global Role"}),e.jsx("th",{children:"Projects"}),e.jsx("th",{children:"Created"}),i&&e.jsx("th",{children:"Type"})]})}),e.jsx("tbody",{children:n.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:i?6:5,className:"empty-state",children:e.jsxs("div",{style:{textAlign:"center",padding:"40px 20px"},children:[e.jsx(N,{size:48,style:{color:"#94a3b8",marginBottom:"12px"}}),e.jsx("p",{style:{color:"#64748b",marginBottom:"16px"},children:"No user accounts in the system yet"}),e.jsxs("button",{className:"btn-primary",onClick:()=>x(!0),style:{display:"inline-flex",alignItems:"center",gap:"8px"},children:[e.jsx(S,{size:16}),"Create First User"]})]})})}):n.map(s=>{const a=O(s.global_role),t=s.is_test_user,f=s.id===L?.id;return e.jsxs("tr",{className:t?"test-user-row":"",children:[e.jsx("td",{children:e.jsxs("div",{className:"user-cell",children:[e.jsx("div",{className:`user-avatar ${t?"test":""}`,children:(s.full_name||s.email||"U")[0].toUpperCase()}),e.jsxs("div",{className:"user-info",children:[e.jsx("span",{className:"user-name",children:s.full_name||"No name"}),f&&e.jsx("span",{className:"you-badge",children:"you"})]})]})}),e.jsx("td",{className:"email-cell",children:s.email}),e.jsx("td",{children:e.jsx("span",{className:"role-badge",style:{backgroundColor:a.color+"15",color:a.color,cursor:"default"},children:a.label})}),e.jsx("td",{children:s.projects.length>0?e.jsxs("span",{className:"projects-badge",title:s.projects.map(c=>`${c.reference||c.name} (${c.role})`).join(", "),style:{background:"#dbeafe",color:"#2563eb",padding:"4px 10px",borderRadius:"12px",fontSize:"13px",cursor:"help"},children:[s.projects.length," project",s.projects.length!==1?"s":""]}):e.jsx("span",{style:{color:"#94a3b8",fontSize:"13px"},children:"No projects"})}),e.jsx("td",{className:"date-cell",children:s.created_at?new Date(s.created_at).toLocaleDateString("en-GB"):"-"}),i&&e.jsx("td",{children:e.jsx("button",{onClick:()=>M(s.id,s.is_test_user),className:`type-badge ${t?"test":"real"}`,style:{cursor:"pointer",border:"none",background:"transparent"},title:t?"Click to mark as real user":"Click to mark as test user",children:t?e.jsxs(e.Fragment,{children:[e.jsx(P,{size:12})," Test"]}):"Real"})})]},s.id)})})]})}),e.jsxs("div",{className:"role-legend",children:[e.jsx("h4",{children:"Global Role Reference"}),e.jsx("div",{className:"legend-grid",children:m.map(s=>e.jsxs("div",{className:"legend-item",children:[e.jsx("span",{className:"legend-dot",style:{backgroundColor:s.color}}),e.jsx("span",{className:"legend-label",style:{color:s.color},children:s.label}),e.jsxs("span",{className:"legend-desc",children:[s.value==="admin"&&"Full system access",s.value==="supplier_pm"&&"Manage resources, partners, and invoices",s.value==="supplier_finance"&&"Financial management (supplier side)",s.value==="customer_pm"&&"Reviews deliverables, validates timesheets",s.value==="customer_finance"&&"Financial management (customer side)",s.value==="contributor"&&"Submits timesheets & expenses",s.value==="viewer"&&"Read-only dashboard access"]})]},s.value))})]})]})]}):e.jsx("div",{className:"users-page",children:e.jsxs("div",{className:"access-denied",children:[e.jsx(N,{size:48}),e.jsx("h2",{children:"Access Denied"}),e.jsx("p",{children:"Only administrators can access system user management."})]})})}export{le as default};
