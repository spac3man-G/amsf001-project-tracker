import{u as pe,n as be,f as ve,c as ge,a as _e,s as d,j as e,L as $}from"./index-CvJ0uIlS.js";import{r as l}from"./vendor-react-BUTV5ZEl.js";/* empty css                    */import{C as V}from"./ConfirmDialog-DVEUKBdx.js";import{z as Ne,q as Y,a3 as ye,x as ke,R as we,aT as G,aU as H,ak as Ce,c as P,aV as Ue,aW as Re,a as Se}from"./vendor-icons-qkJ_CSr6.js";import"./vendor-supabase-6faYzd5A.js";function Pe(){const[x,X]=l.useState([]),[O,J]=l.useState([]),[K,D]=l.useState(!0),[Q,Z]=l.useState(null),[ee,y]=l.useState(null),[se,k]=l.useState(null),[w,C]=l.useState(""),[v,U]=l.useState({isOpen:!1,resourceId:null,resourceName:null}),[R,f]=l.useState(!1),[L,ae]=l.useState([]),[g,S]=l.useState(""),[E,T]=l.useState("viewer"),[q,B]=l.useState(!1),[_,z]=l.useState({isOpen:!1,member:null}),{user:N}=pe(),{effectiveRole:I,loading:A}=be(),{showTestUsers:c,toggleTestUsers:le,canToggleTestUsers:re}=ve(),{showSuccess:p,showError:u,showWarning:F}=ge(),{currentProject:m}=_e(),b=[{value:"admin",label:"Admin",color:"#7c3aed"},{value:"supplier_pm",label:"Supplier PM",color:"#059669"},{value:"supplier_finance",label:"Supplier Finance",color:"#0d9488"},{value:"customer_pm",label:"Customer PM",color:"#d97706"},{value:"customer_finance",label:"Customer Finance",color:"#ea580c"},{value:"contributor",label:"Contributor",color:"#2563eb"},{value:"viewer",label:"Viewer",color:"#64748b"}];l.useEffect(()=>{N&&Z(N.id)},[N]),l.useEffect(()=>{W&&!A&&h()},[I,c,m?.id,A]),l.useEffect(()=>{R&&oe()},[R,c]);const W=I==="admin"||I==="supplier_pm";async function h(){if(m?.id)try{D(!0);const{data:s,error:a}=await d.from("user_projects").select(`
          id,
          user_id,
          role,
          is_default,
          created_at
        `).eq("project_id",m.id).order("created_at",{ascending:!1});if(a)throw a;const t=(s||[]).map(n=>n.user_id);let o=[];if(t.length>0){const{data:n,error:j}=await d.from("profiles").select("id, full_name, email, is_test_user").in("id",t);if(j)throw j;o=n||[]}let i=(s||[]).map(n=>{const j=o.find(xe=>xe.id===n.user_id)||{};return{id:n.id,user_id:n.user_id,full_name:j.full_name||null,email:j.email||"Unknown",role:n.role,is_test_user:j.is_test_user||!1,is_default:n.is_default,created_at:n.created_at}});c||(i=i.filter(n=>!n.is_test_user)),X(i);const{data:r}=await d.from("resources").select("id, name, email, user_id").eq("project_id",m.id).order("name");J(r||[])}catch{u("Failed to load team members")}finally{D(!1)}}async function te(s,a){try{const{error:t}=await d.from("user_projects").update({role:a,updated_at:new Date().toISOString()}).eq("id",s);if(t)throw t;await h(),y(null),p("Role updated")}catch{u("Failed to update role")}}async function ie(s){if(!w){F("Please select a resource");return}try{const{error:a}=await d.from("resources").update({user_id:s}).eq("id",w);if(a)throw a;await h(),k(null),C(""),p("Resource linked successfully!")}catch{u("Failed to link resource")}}function ne(s,a){U({isOpen:!0,resourceId:s,resourceName:a})}async function ce(){if(v.resourceId)try{const{error:s}=await d.from("resources").update({user_id:null}).eq("id",v.resourceId);if(s)throw s;U({isOpen:!1,resourceId:null,resourceName:null}),await h(),p("Resource unlinked")}catch{u("Failed to unlink resource")}}async function oe(){if(m?.id)try{const{data:s}=await d.from("profiles").select("id, full_name, email, is_test_user").order("full_name"),{data:a}=await d.from("user_projects").select("user_id").eq("project_id",m.id),t=(a||[]).map(i=>i.user_id);let o=(s||[]).filter(i=>!t.includes(i.id));c||(o=o.filter(i=>!i.is_test_user)),ae(o)}catch{u("Failed to load available users")}}async function de(){if(!g){F("Please select a user");return}try{B(!0);const{error:s}=await d.from("user_projects").insert({user_id:g,project_id:m.id,role:E,is_default:!1});if(s)throw s;p("Team member added successfully"),f(!1),S(""),T("viewer"),await h()}catch(s){s.code==="23505"?u("User is already a team member"):u("Failed to add team member")}finally{B(!1)}}function ue(s){if(s.user_id===N?.id){F("You can't remove yourself from the project");return}z({isOpen:!0,member:s})}async function me(){const s=_.member;if(s)try{const{error:a}=await d.from("user_projects").delete().eq("id",s.id);if(a)throw a;p(`${s.full_name||s.email} removed from project`),z({isOpen:!1,member:null}),await h()}catch{u("Failed to remove team member")}}function he(s){return b.find(a=>a.value===s)||b[4]}function fe(s){return O.find(a=>a.user_id===s)}function je(){return O.filter(s=>!s.user_id)}const M=x.filter(s=>s.is_test_user).length;return A?e.jsx($,{message:"Loading permissions...",size:"large",fullPage:!0}):W?K?e.jsx($,{message:"Loading team members...",size:"large",fullPage:!0}):e.jsxs("div",{className:"users-page",children:[e.jsx("header",{className:"users-header",children:e.jsxs("div",{className:"header-content",children:[e.jsxs("div",{className:"header-title",children:[e.jsx(Y,{size:28,strokeWidth:1.5}),e.jsxs("div",{children:[e.jsx("h1",{children:"Team Members"}),e.jsxs("p",{children:[x.length," member",x.length!==1?"s":""," in this project"]})]})]}),e.jsxs("div",{className:"header-actions",children:[re&&e.jsxs("button",{onClick:le,className:`btn-toggle ${c?"active":""}`,children:[c?e.jsx(ye,{size:16}):e.jsx(ke,{size:16}),c?"Hide Test":"Show Test"]}),e.jsx("button",{className:"btn-secondary",onClick:h,children:e.jsx(we,{size:16})}),e.jsxs("button",{className:"btn-primary",onClick:()=>f(!0),children:[e.jsx(G,{size:16}),"Add Team Member"]})]})]})}),e.jsxs("div",{className:"users-content",children:[c&&M>0&&e.jsxs("div",{className:"test-banner",children:[e.jsx(H,{size:16}),e.jsxs("span",{children:["Showing ",M," test user",M!==1?"s":""]})]}),e.jsx("div",{className:"table-card",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"User"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"Linked Resource"}),e.jsx("th",{children:"Role"}),e.jsx("th",{children:"Created"}),c&&e.jsx("th",{children:"Type"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:x.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:c?7:6,className:"empty-state",children:e.jsxs("div",{style:{textAlign:"center",padding:"40px 20px"},children:[e.jsx(Y,{size:48,style:{color:"#94a3b8",marginBottom:"12px"}}),e.jsx("p",{style:{color:"#64748b",marginBottom:"16px"},children:"No team members assigned to this project yet"}),e.jsxs("button",{className:"btn-primary",onClick:()=>f(!0),style:{display:"inline-flex",alignItems:"center",gap:"8px"},children:[e.jsx(G,{size:16}),"Add First Team Member"]})]})})}):x.map(s=>{const a=he(s.role),t=s.is_test_user,o=fe(s.user_id),i=s.user_id===Q;return e.jsxs("tr",{className:t?"test-user-row":"",children:[e.jsx("td",{children:e.jsxs("div",{className:"user-cell",children:[e.jsx("div",{className:`user-avatar ${t?"test":""}`,children:(s.full_name||s.email||"U")[0].toUpperCase()}),e.jsxs("div",{className:"user-info",children:[e.jsx("span",{className:"user-name",children:s.full_name||"No name"}),i&&e.jsx("span",{className:"you-badge",children:"you"})]})]})}),e.jsx("td",{className:"email-cell",children:s.email}),e.jsx("td",{children:se===s.id?e.jsxs("div",{className:"link-form",children:[e.jsxs("select",{value:w,onChange:r=>C(r.target.value),children:[e.jsx("option",{value:"",children:"Select..."}),je().map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]}),e.jsx("button",{className:"btn-icon success",onClick:()=>ie(s.user_id),children:e.jsx(Ce,{size:14})}),e.jsx("button",{className:"btn-icon",onClick:()=>{k(null),C("")},children:e.jsx(P,{size:14})})]}):o?e.jsxs("div",{className:"linked-resource",children:[e.jsx(Ue,{size:14}),e.jsx("span",{children:o.name}),e.jsx("button",{className:"btn-icon-small",onClick:()=>ne(o.id,o.name),title:"Unlink",children:e.jsx(Re,{size:12})})]}):e.jsx("button",{className:"link-button",onClick:()=>k(s.id),children:"Link resource"})}),e.jsx("td",{children:ee===s.id?e.jsx("div",{className:"role-edit",children:e.jsx("select",{value:s.role,onChange:r=>te(s.id,r.target.value),autoFocus:!0,onBlur:()=>y(null),children:b.map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))})}):e.jsxs("button",{className:"role-badge",style:{backgroundColor:a.color+"15",color:a.color},onClick:()=>y(s.id),children:[a.label,e.jsx(Se,{size:12})]})}),e.jsx("td",{className:"date-cell",children:s.created_at?new Date(s.created_at).toLocaleDateString("en-GB"):"-"}),c&&e.jsx("td",{children:t?e.jsxs("span",{className:"type-badge test",children:[e.jsx(H,{size:12})," Test"]}):e.jsx("span",{className:"type-badge real",children:"Real"})}),e.jsx("td",{className:"actions-cell",children:!i&&e.jsx("button",{className:"btn-icon danger",onClick:()=>ue(s),title:"Remove from project",children:e.jsx(P,{size:16})})})]},s.id)})})]})}),e.jsxs("div",{className:"role-legend",children:[e.jsx("h4",{children:"Project Role Permissions"}),e.jsx("div",{className:"legend-grid",children:b.map(s=>e.jsxs("div",{className:"legend-item",children:[e.jsx("span",{className:"legend-dot",style:{backgroundColor:s.color}}),e.jsx("span",{className:"legend-label",style:{color:s.color},children:s.label}),e.jsxs("span",{className:"legend-desc",children:[s.value==="admin"&&"Full system access",s.value==="supplier_pm"&&"Full access + validates timesheets/expenses",s.value==="supplier_finance"&&"Financial management (supplier side)",s.value==="customer_pm"&&"Reviews deliverables, validates timesheets",s.value==="customer_finance"&&"Financial management (customer side)",s.value==="contributor"&&"Submits timesheets & expenses",s.value==="viewer"&&"Read-only dashboard access"]})]},s.value))})]})]}),R&&e.jsx("div",{className:"modal-overlay",onClick:()=>f(!1),children:e.jsxs("div",{className:"modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h3",{children:"Add Team Member"}),e.jsx("button",{className:"btn-icon",onClick:()=>f(!1),children:e.jsx(P,{size:20})})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"form-field",children:[e.jsx("label",{children:"Select User"}),e.jsxs("select",{value:g,onChange:s=>S(s.target.value),children:[e.jsx("option",{value:"",children:"Choose a user..."}),L.map(s=>e.jsx("option",{value:s.id,children:s.full_name||s.email},s.id))]}),L.length===0&&e.jsx("p",{className:"help-text",children:"All users are already team members"})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{children:"Project Role"}),e.jsx("select",{value:E,onChange:s=>T(s.target.value),children:b.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>{f(!1),S(""),T("viewer")},children:"Cancel"}),e.jsx("button",{className:"btn btn-primary",onClick:de,disabled:!g||q,children:q?"Adding...":"Add to Project"})]})]})}),e.jsx(V,{isOpen:v.isOpen,onClose:()=>U({isOpen:!1,resourceId:null,resourceName:null}),onConfirm:ce,title:"Unlink Resource",message:e.jsxs(e.Fragment,{children:["Unlink ",e.jsx("strong",{children:v.resourceName})," from this user?"]}),confirmText:"Unlink",cancelText:"Cancel",type:"warning"}),e.jsx(V,{isOpen:_.isOpen,onClose:()=>z({isOpen:!1,member:null}),onConfirm:me,title:"Remove Team Member",message:e.jsxs(e.Fragment,{children:["Remove ",e.jsx("strong",{children:_.member?.full_name||_.member?.email})," from this project?",e.jsx("br",{}),e.jsx("br",{}),"They will lose access to all project data. Their account will remain active for other projects."]}),confirmText:"Remove",type:"danger"})]}):e.jsx("div",{className:"users-page",children:e.jsxs("div",{className:"access-denied",children:[e.jsx(Ne,{size:48}),e.jsx("h2",{children:"Access Denied"}),e.jsx("p",{children:"You don't have permission to manage team members."})]})})}export{Pe as default};
