import{u as Se,n as Ue,f as Re,c as Te,a as ze,s as d,j as e,L as Q}from"./index-IaXQkjEL.js";import{r as l}from"./vendor-react-BUTV5ZEl.js";/* empty css                    */import{C as Z}from"./ConfirmDialog-CmqcCv3X.js";import{z as Ee,q as ee,a3 as Fe,x as Ie,R as Me,aT as se,aU as ae,ak as Pe,c as w,aV as Ae,aW as Oe,a as De,aX as Le}from"./vendor-icons-C6BNM9_X.js";import"./vendor-supabase-6faYzd5A.js";function Ye(){const[v,le]=l.useState([]),[q,te]=l.useState([]),[re,B]=l.useState(!0),[ie,ne]=l.useState(null),[ce,S]=l.useState(null),[oe,U]=l.useState(null),[R,T]=l.useState(""),[_,z]=l.useState({isOpen:!1,resourceId:null,resourceName:null}),[E,j]=l.useState(!1),[$,de]=l.useState([]),[N,F]=l.useState(""),[W,I]=l.useState("viewer"),[V,X]=l.useState(!1),[y,M]=l.useState({isOpen:!1,member:null}),[me,g]=l.useState(!1),[u,P]=l.useState(null),[C,Y]=l.useState({full_name:""}),[G,H]=l.useState(!1),{user:k}=Se(),{effectiveRole:A,loading:O}=Ue(),{showTestUsers:c,toggleTestUsers:ue,canToggleTestUsers:he}=Re(),{showSuccess:x,showError:m,showWarning:D}=Te(),{currentProject:f}=ze(),p=[{value:"admin",label:"Admin",color:"#7c3aed"},{value:"supplier_pm",label:"Supplier PM",color:"#059669"},{value:"supplier_finance",label:"Supplier Finance",color:"#0d9488"},{value:"customer_pm",label:"Customer PM",color:"#d97706"},{value:"customer_finance",label:"Customer Finance",color:"#ea580c"},{value:"contributor",label:"Contributor",color:"#2563eb"},{value:"viewer",label:"Viewer",color:"#64748b"}];l.useEffect(()=>{k&&ne(k.id)},[k]),l.useEffect(()=>{J&&!O&&h()},[A,c,f?.id,O]),l.useEffect(()=>{E&&pe()},[E,c]);const J=A==="admin"||A==="supplier_pm";async function h(){if(f?.id)try{B(!0);const{data:s,error:a}=await d.from("user_projects").select(`
          id,
          user_id,
          role,
          is_default,
          created_at
        `).eq("project_id",f.id).order("created_at",{ascending:!1});if(a)throw a;const r=(s||[]).map(n=>n.user_id);let o=[];if(r.length>0){const{data:n,error:b}=await d.from("profiles").select("id, full_name, email, is_test_user").in("id",r);if(b)throw b;o=n||[]}let i=(s||[]).map(n=>{const b=o.find(we=>we.id===n.user_id)||{};return{id:n.id,user_id:n.user_id,full_name:b.full_name||null,email:b.email||"Unknown",role:n.role,is_test_user:b.is_test_user||!1,is_default:n.is_default,created_at:n.created_at}});c||(i=i.filter(n=>!n.is_test_user)),le(i);const{data:t}=await d.from("resources").select("id, name, email, user_id").eq("project_id",f.id).order("name");te(t||[])}catch{m("Failed to load team members")}finally{B(!1)}}async function K(s,a){try{const{error:r}=await d.from("user_projects").update({role:a,updated_at:new Date().toISOString()}).eq("id",s);if(r)throw r;await h(),S(null),x("Role updated")}catch{m("Failed to update role")}}async function fe(s){if(!R){D("Please select a resource");return}try{const{error:a}=await d.from("resources").update({user_id:s}).eq("id",R);if(a)throw a;await h(),U(null),T(""),x("Resource linked successfully!")}catch{m("Failed to link resource")}}function je(s,a){z({isOpen:!0,resourceId:s,resourceName:a})}async function xe(){if(_.resourceId)try{const{error:s}=await d.from("resources").update({user_id:null}).eq("id",_.resourceId);if(s)throw s;z({isOpen:!1,resourceId:null,resourceName:null}),await h(),x("Resource unlinked")}catch{m("Failed to unlink resource")}}async function pe(){if(f?.id)try{const{data:s}=await d.from("profiles").select("id, full_name, email, is_test_user").order("full_name"),{data:a}=await d.from("user_projects").select("user_id").eq("project_id",f.id),r=(a||[]).map(i=>i.user_id);let o=(s||[]).filter(i=>!r.includes(i.id));c||(o=o.filter(i=>!i.is_test_user)),de(o)}catch{m("Failed to load available users")}}async function be(){if(!N){D("Please select a user");return}try{X(!0);const{error:s}=await d.from("user_projects").insert({user_id:N,project_id:f.id,role:W,is_default:!1});if(s)throw s;x("Team member added successfully"),j(!1),F(""),I("viewer"),await h()}catch(s){s.code==="23505"?m("User is already a team member"):m("Failed to add team member")}finally{X(!1)}}function ve(s){if(s.user_id===k?.id){D("You can't remove yourself from the project");return}M({isOpen:!0,member:s})}function ge(s){P(s),Y({full_name:s.full_name||""}),g(!0)}async function _e(){if(u)try{H(!0);const{error:s}=await d.from("profiles").update({full_name:C.full_name.trim()||null,updated_at:new Date().toISOString()}).eq("id",u.user_id);if(s)throw s;x("Team member updated successfully"),g(!1),P(null),await h()}catch{m("Failed to update team member")}finally{H(!1)}}async function Ne(){const s=y.member;if(s)try{const{error:a}=await d.from("user_projects").delete().eq("id",s.id);if(a)throw a;x(`${s.full_name||s.email} removed from project`),M({isOpen:!1,member:null}),await h()}catch{m("Failed to remove team member")}}function ye(s){return p.find(a=>a.value===s)||p[4]}function Ce(s){return q.find(a=>a.user_id===s)}function ke(){return q.filter(s=>!s.user_id)}const L=v.filter(s=>s.is_test_user).length;return O?e.jsx(Q,{message:"Loading permissions...",size:"large",fullPage:!0}):J?re?e.jsx(Q,{message:"Loading team members...",size:"large",fullPage:!0}):e.jsxs("div",{className:"users-page",children:[e.jsx("header",{className:"users-header",children:e.jsxs("div",{className:"header-content",children:[e.jsxs("div",{className:"header-title",children:[e.jsx(ee,{size:28,strokeWidth:1.5}),e.jsxs("div",{children:[e.jsx("h1",{children:"Team Members"}),e.jsxs("p",{children:[v.length," member",v.length!==1?"s":""," in this project"]})]})]}),e.jsxs("div",{className:"header-actions",children:[he&&e.jsxs("button",{onClick:ue,className:`btn-toggle ${c?"active":""}`,children:[c?e.jsx(Fe,{size:16}):e.jsx(Ie,{size:16}),c?"Hide Test":"Show Test"]}),e.jsx("button",{className:"btn-secondary",onClick:h,children:e.jsx(Me,{size:16})}),e.jsxs("button",{className:"btn-primary",onClick:()=>j(!0),children:[e.jsx(se,{size:16}),"Add Team Member"]})]})]})}),e.jsxs("div",{className:"users-content",children:[c&&L>0&&e.jsxs("div",{className:"test-banner",children:[e.jsx(ae,{size:16}),e.jsxs("span",{children:["Showing ",L," test user",L!==1?"s":""]})]}),e.jsx("div",{className:"table-card",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"User"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"Linked Resource"}),e.jsx("th",{children:"Role"}),e.jsx("th",{children:"Created"}),c&&e.jsx("th",{children:"Type"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:v.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:c?7:6,className:"empty-state",children:e.jsxs("div",{style:{textAlign:"center",padding:"40px 20px"},children:[e.jsx(ee,{size:48,style:{color:"#94a3b8",marginBottom:"12px"}}),e.jsx("p",{style:{color:"#64748b",marginBottom:"16px"},children:"No team members assigned to this project yet"}),e.jsxs("button",{className:"btn-primary",onClick:()=>j(!0),style:{display:"inline-flex",alignItems:"center",gap:"8px"},children:[e.jsx(se,{size:16}),"Add First Team Member"]})]})})}):v.map(s=>{const a=ye(s.role),r=s.is_test_user,o=Ce(s.user_id),i=s.user_id===ie;return e.jsxs("tr",{className:r?"test-user-row":"",children:[e.jsx("td",{children:e.jsxs("div",{className:"user-cell",children:[e.jsx("div",{className:`user-avatar ${r?"test":""}`,children:(s.full_name||s.email||"U")[0].toUpperCase()}),e.jsxs("div",{className:"user-info",children:[e.jsx("span",{className:"user-name",children:s.full_name||"No name"}),i&&e.jsx("span",{className:"you-badge",children:"you"})]})]})}),e.jsx("td",{className:"email-cell",children:s.email}),e.jsx("td",{children:oe===s.id?e.jsxs("div",{className:"link-form",children:[e.jsxs("select",{value:R,onChange:t=>T(t.target.value),children:[e.jsx("option",{value:"",children:"Select..."}),ke().map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsx("button",{className:"btn-icon success",onClick:()=>fe(s.user_id),children:e.jsx(Pe,{size:14})}),e.jsx("button",{className:"btn-icon",onClick:()=>{U(null),T("")},children:e.jsx(w,{size:14})})]}):o?e.jsxs("div",{className:"linked-resource",children:[e.jsx(Ae,{size:14}),e.jsx("span",{children:o.name}),e.jsx("button",{className:"btn-icon-small",onClick:()=>je(o.id,o.name),title:"Unlink",children:e.jsx(Oe,{size:12})})]}):e.jsx("button",{className:"link-button",onClick:()=>U(s.id),children:"Link resource"})}),e.jsx("td",{children:ce===s.id?e.jsx("div",{className:"role-edit",children:e.jsx("select",{value:s.role,onChange:t=>K(s.id,t.target.value),autoFocus:!0,onBlur:()=>S(null),children:p.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))})}):e.jsxs("button",{className:"role-badge",style:{backgroundColor:a.color+"15",color:a.color},onClick:()=>S(s.id),children:[a.label,e.jsx(De,{size:12})]})}),e.jsx("td",{className:"date-cell",children:s.created_at?new Date(s.created_at).toLocaleDateString("en-GB"):"-"}),c&&e.jsx("td",{children:r?e.jsxs("span",{className:"type-badge test",children:[e.jsx(ae,{size:12})," Test"]}):e.jsx("span",{className:"type-badge real",children:"Real"})}),e.jsx("td",{className:"actions-cell",children:e.jsxs("div",{className:"action-buttons",children:[e.jsx("button",{className:"btn-icon",onClick:()=>ge(s),title:"Edit member details",children:e.jsx(Le,{size:14})}),!i&&e.jsx("button",{className:"btn-icon danger",onClick:()=>ve(s),title:"Remove from project",children:e.jsx(w,{size:16})})]})})]},s.id)})})]})}),e.jsxs("div",{className:"role-legend",children:[e.jsx("h4",{children:"Project Role Permissions"}),e.jsx("div",{className:"legend-grid",children:p.map(s=>e.jsxs("div",{className:"legend-item",children:[e.jsx("span",{className:"legend-dot",style:{backgroundColor:s.color}}),e.jsx("span",{className:"legend-label",style:{color:s.color},children:s.label}),e.jsxs("span",{className:"legend-desc",children:[s.value==="admin"&&"Full system access",s.value==="supplier_pm"&&"Full access + validates timesheets/expenses",s.value==="supplier_finance"&&"Financial management (supplier side)",s.value==="customer_pm"&&"Reviews deliverables, validates timesheets",s.value==="customer_finance"&&"Financial management (customer side)",s.value==="contributor"&&"Submits timesheets & expenses",s.value==="viewer"&&"Read-only dashboard access"]})]},s.value))})]})]}),E&&e.jsx("div",{className:"modal-overlay",onClick:()=>j(!1),children:e.jsxs("div",{className:"modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h3",{children:"Add Team Member"}),e.jsx("button",{className:"btn-icon",onClick:()=>j(!1),children:e.jsx(w,{size:20})})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"form-field",children:[e.jsx("label",{children:"Select User"}),e.jsxs("select",{value:N,onChange:s=>F(s.target.value),children:[e.jsx("option",{value:"",children:"Choose a user..."}),$.map(s=>e.jsx("option",{value:s.id,children:s.full_name||s.email},s.id))]}),$.length===0&&e.jsx("p",{className:"help-text",children:"All users are already team members"})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{children:"Project Role"}),e.jsx("select",{value:W,onChange:s=>I(s.target.value),children:p.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>{j(!1),F(""),I("viewer")},children:"Cancel"}),e.jsx("button",{className:"btn btn-primary",onClick:be,disabled:!N||V,children:V?"Adding...":"Add to Project"})]})]})}),e.jsx(Z,{isOpen:_.isOpen,onClose:()=>z({isOpen:!1,resourceId:null,resourceName:null}),onConfirm:xe,title:"Unlink Resource",message:e.jsxs(e.Fragment,{children:["Unlink ",e.jsx("strong",{children:_.resourceName})," from this user?"]}),confirmText:"Unlink",cancelText:"Cancel",type:"warning"}),e.jsx(Z,{isOpen:y.isOpen,onClose:()=>M({isOpen:!1,member:null}),onConfirm:Ne,title:"Remove Team Member",message:e.jsxs(e.Fragment,{children:["Remove ",e.jsx("strong",{children:y.member?.full_name||y.member?.email})," from this project?",e.jsx("br",{}),e.jsx("br",{}),"They will lose access to all project data. Their account will remain active for other projects."]}),confirmText:"Remove",type:"danger"}),me&&u&&e.jsx("div",{className:"modal-overlay",onClick:()=>g(!1),children:e.jsxs("div",{className:"modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h3",{children:"Edit Team Member"}),e.jsx("button",{className:"btn-icon",onClick:()=>g(!1),children:e.jsx(w,{size:20})})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"edit-member-header",children:[e.jsx("div",{className:`user-avatar ${u.is_test_user?"test":""}`,children:(C.full_name||u.email||"U")[0].toUpperCase()}),e.jsx("div",{className:"edit-member-info",children:e.jsx("span",{className:"edit-member-email",children:u.email})})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{children:"Full Name"}),e.jsx("input",{type:"text",value:C.full_name,onChange:s=>Y({...C,full_name:s.target.value}),placeholder:"Enter full name",autoFocus:!0})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{children:"Project Role"}),e.jsx("select",{value:u.role,onChange:s=>K(u.id,s.target.value),children:p.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))}),e.jsx("p",{className:"help-text",children:"Role determines permissions within this project"})]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>{g(!1),P(null)},children:"Cancel"}),e.jsx("button",{className:"btn btn-primary",onClick:_e,disabled:G,children:G?"Saving...":"Save Changes"})]})]})})]}):e.jsx("div",{className:"users-page",children:e.jsxs("div",{className:"access-denied",children:[e.jsx(Ee,{size:48}),e.jsx("h2",{children:"Access Denied"}),e.jsx("p",{children:"You don't have permission to manage team members."})]})})}export{Ye as default};
