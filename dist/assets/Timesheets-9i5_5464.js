import{c as Ce,a as Se,b as De,d as Te,r as l,n as Ne,s as c,j as e,L as Ee,P as Fe,k as V,S as k,C as X,A as Ae,X as P,U as Re,o as Ie,T as ze}from"./index-BcgMsB79.js";import{u as We}from"./usePermissions-utoNxF_l.js";import{C as Pe}from"./ConfirmDialog-Ca5wY-Fp.js";import"./qualityStandards.service-BPaGDFlt.js";import{P as Be}from"./plus-D1ijkXGv.js";import{C as B}from"./calendar-BARQmSIo.js";import{S as J}from"./save-BEtYqOhB.js";import{P as Me}from"./pen-C5qRXid0.js";/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ue=Ce("CalendarDays",[["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",ry:"2",key:"eu3xkr"}],["line",{x1:"16",x2:"16",y1:"2",y2:"6",key:"m3sa8f"}],["line",{x1:"8",x2:"8",y1:"2",y2:"6",key:"18kwsl"}],["line",{x1:"3",x2:"21",y1:"10",y2:"10",key:"xt86sb"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 18h.01",key:"lrp35t"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M16 18h.01",key:"kzsmim"}]]);function Je(){const{user:_,role:v,linkedResource:C}=Se(),{projectId:u}=De(),{showSuccess:j,showError:x,showWarning:M}=Te(),U=(_==null?void 0:_.id)||null,w=(C==null?void 0:C.id)||null,{canAddTimesheet:K,canEditTimesheet:Z,canDeleteTimesheet:ee,canSubmitTimesheet:te,canValidateTimesheet:se,getAvailableResources:re}=We(),[L,ie]=l.useState([]),[g,oe]=l.useState([]),[S,ne]=l.useState([]),[ae,le]=l.useState(!0),[O,D]=l.useState(!1),[f,T]=l.useState(null),[o,m]=l.useState({}),[N,de]=l.useState("all"),[Le,Oe]=l.useState("all"),[a,q]=l.useState("daily"),[d,E]=l.useState({isOpen:!1,timesheetId:null,timesheetData:null}),{showTestUsers:F,testUserIds:A}=Ne(),[i,h]=l.useState({resource_id:"",milestone_id:"",work_date:new Date().toISOString().split("T")[0],week_ending:H(),hours_worked:"",description:"",status:"Draft",entry_type:"daily"}),ce=["Draft","Submitted","Approved","Rejected"];function H(){const t=new Date,s=7-t.getDay(),n=new Date(t);return n.setDate(t.getDate()+(t.getDay()===0?0:s)),n.toISOString().split("T")[0]}l.useEffect(()=>{u&&p(u)},[u]),l.useEffect(()=>{u&&p(u)},[F]),l.useEffect(()=>{w&&h(t=>({...t,resource_id:w}))},[w]);async function p(t){const s=t||u;if(s)try{let n=c.from("timesheets").select(`
          *,
          resources (id, name, email),
          milestones (id, milestone_ref, name)
        `).eq("project_id",s).order("date",{ascending:!1});F||(n=n.or("is_test_content.is.null,is_test_content.eq.false"));const{data:r,error:b}=await n;b?console.error("Timesheets error:",b):ie(r||[]);let I=c.from("resources").select("id, name, email, user_id").order("name");const{data:z,error:Q}=await I;if(Q)console.error("Resources error:",Q);else{let W=z||[];!F&&A&&A.length>0&&(W=W.filter($=>!$.user_id||!A.includes($.user_id))),oe(W)}const{data:ve,error:Y}=await c.from("milestones").select("id, milestone_ref, name").eq("project_id",s).order("milestone_ref");Y?console.error("Milestones error:",Y):ne(ve||[])}catch(n){console.error("Error fetching data:",n)}finally{le(!1)}}async function ue(){if(!i.resource_id||!i.hours_worked){M("Please fill in all required fields");return}if(!u){x("Project not found");return}try{const t=g.find(b=>b.id===i.resource_id),s=a==="daily"?i.work_date:i.week_ending,n={project_id:u,resource_id:i.resource_id,milestone_id:i.milestone_id||null,user_id:(t==null?void 0:t.user_id)||U,created_by:U,date:s,work_date:s,week_ending:a==="weekly"?i.week_ending:null,hours_worked:parseFloat(i.hours_worked),hours:parseFloat(i.hours_worked),description:i.description,comments:i.description,status:i.status,entry_type:a},{error:r}=await c.from("timesheets").insert([n]);if(r)throw r;await p(),D(!1),h({resource_id:w||"",milestone_id:"",work_date:new Date().toISOString().split("T")[0],week_ending:H(),hours_worked:"",description:"",status:"Draft",entry_type:a}),j("Timesheet added successfully!")}catch(t){console.error("Error adding timesheet:",t),x("Failed to add timesheet: "+t.message)}}async function me(t){T(t.id),m({resource_id:t.resource_id,milestone_id:t.milestone_id||"",work_date:t.work_date||t.date||"",week_ending:t.week_ending||"",hours_worked:t.hours_worked||t.hours||0,description:t.description||t.comments||"",status:t.status,entry_type:t.entry_type||"daily"})}async function he(t){try{const{error:s}=await c.from("timesheets").update({resource_id:o.resource_id,milestone_id:o.milestone_id||null,date:o.work_date,work_date:o.work_date,week_ending:o.week_ending||null,hours:parseFloat(o.hours_worked),hours_worked:parseFloat(o.hours_worked),comments:o.description,description:o.description,status:o.status}).eq("id",t);if(s)throw s;await p(),T(null),j("Timesheet updated!")}catch(s){console.error("Error updating timesheet:",s),x("Failed to update: "+s.message)}}function pe(){T(null),m({})}function xe(t){const s=g.find(z=>z.id===t.resource_id),n=(s==null?void 0:s.cost_price)||0,r=parseFloat(t.hours_worked)||0,I=r/8*n;E({isOpen:!0,timesheetId:t.id,timesheetData:{resourceName:t.resource_name||(s==null?void 0:s.name)||"Unknown",date:t.work_date,hours:r,costImpact:I,status:t.status}})}async function fe(){if(d.timesheetId)try{const{error:t}=await c.from("timesheets").delete().eq("id",d.timesheetId);if(t)throw t;await p(),E({isOpen:!1,timesheetId:null,timesheetData:null}),j("Timesheet deleted")}catch(t){console.error("Error deleting timesheet:",t),x("Failed to delete: "+t.message)}}async function ye(t){try{const{error:s}=await c.from("timesheets").update({status:"Submitted"}).eq("id",t);if(s)throw s;await p(),j("Timesheet submitted for approval!")}catch(s){console.error("Error submitting timesheet:",s),x("Failed to submit: "+s.message)}}async function ge(t){try{const{error:s}=await c.from("timesheets").update({status:"Approved"}).eq("id",t);if(s)throw s;await p(),j("Timesheet approved!")}catch(s){console.error("Error approving timesheet:",s),x("Failed to approve: "+s.message)}}async function je(t){prompt("Please provide a reason for rejection (optional):");try{const{error:s}=await c.from("timesheets").update({status:"Rejected"}).eq("id",t);if(s)throw s;await p(),M("Timesheet rejected")}catch(s){console.error("Error rejecting timesheet:",s),x("Failed to reject: "+s.message)}}function be(t){switch(t){case"Approved":return"status-approved";case"Submitted":return"status-submitted";case"Rejected":return"status-rejected";default:return"status-draft"}}const y=L.filter(t=>!(N!=="all"&&t.resource_id!==N));[...new Set(L.map(t=>t.week_ending).filter(Boolean))].sort().reverse();const we=y.reduce((t,s)=>t+parseFloat(s.hours_worked||s.hours||0),0),ke=y.filter(t=>t.status==="Approved").reduce((t,s)=>t+parseFloat(s.hours_worked||s.hours||0),0),_e=y.filter(t=>t.status==="Submitted").length,G=g.map(t=>({name:t.name,hours:y.filter(s=>s.resource_id===t.id).reduce((s,n)=>s+parseFloat(n.hours_worked||n.hours||0),0)})).filter(t=>t.hours>0),R=re(g);return ae?e.jsx(Ee,{message:"Loading timesheets...",size:"large",fullPage:!0}):e.jsxs("div",{className:"page-container",children:[e.jsx(Fe,{icon:V,title:"Timesheets",subtitle:"Track time spent on project activities",children:!O&&K&&e.jsxs("button",{className:"btn btn-primary",onClick:()=>D(!0),children:[e.jsx(Be,{size:18})," Add Timesheet"]})}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem"},children:[e.jsx(k,{icon:B,label:"Total Entries",value:y.length,color:"#3b82f6"}),e.jsx(k,{icon:V,label:"Total Hours",value:we.toFixed(1),color:"#3b82f6"}),e.jsx(k,{icon:X,label:"Approved Hours",value:ke.toFixed(1),color:"#10b981"}),e.jsx(k,{icon:Ae,label:"Pending Approval",value:_e,color:"#f59e0b"})]}),G.length>0&&e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsx("h4",{style:{marginBottom:"0.75rem"},children:"Hours by Resource"}),e.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"1rem"},children:G.map(t=>e.jsxs("div",{style:{padding:"0.75rem 1rem",backgroundColor:"#f1f5f9",borderRadius:"8px",minWidth:"120px"},children:[e.jsx("div",{style:{fontWeight:"600",fontSize:"0.9rem"},children:t.name}),e.jsxs("div",{style:{fontSize:"1.25rem",fontWeight:"700",color:"#3b82f6"},children:[t.hours.toFixed(1),"h"]})]},t.name))})]}),e.jsx("div",{className:"card",style:{marginBottom:"1.5rem"},children:e.jsxs("div",{style:{display:"flex",gap:"1rem",alignItems:"center",flexWrap:"wrap"},children:[e.jsx("span",{style:{fontWeight:"500"},children:"Filter:"}),e.jsxs("select",{value:N,onChange:t=>de(t.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"all",children:"All Resources"}),g.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]})}),O&&e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem",border:"2px solid var(--primary)"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Add Timesheet Entry"}),e.jsxs("div",{style:{marginBottom:"1.5rem"},children:[e.jsx("label",{style:{fontWeight:"500",marginBottom:"0.5rem",display:"block"},children:"Entry Type"}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsxs("button",{type:"button",onClick:()=>q("daily"),style:{padding:"0.75rem 1.5rem",border:"2px solid",borderColor:a==="daily"?"#10b981":"#e2e8f0",backgroundColor:a==="daily"?"#f0fdf4":"white",borderRadius:"8px",cursor:"pointer",display:"flex",alignItems:"center",gap:"0.5rem",fontWeight:a==="daily"?"600":"400",color:a==="daily"?"#16a34a":"#64748b"},children:[e.jsx(B,{size:18}),"Daily Entry"]}),e.jsxs("button",{type:"button",onClick:()=>q("weekly"),style:{padding:"0.75rem 1.5rem",border:"2px solid",borderColor:a==="weekly"?"#10b981":"#e2e8f0",backgroundColor:a==="weekly"?"#f0fdf4":"white",borderRadius:"8px",cursor:"pointer",display:"flex",alignItems:"center",gap:"0.5rem",fontWeight:a==="weekly"?"600":"400",color:a==="weekly"?"#16a34a":"#64748b"},children:[e.jsx(Ue,{size:18}),"Weekly Summary"]})]}),e.jsx("p",{style:{fontSize:"0.85rem",color:"#64748b",marginTop:"0.5rem"},children:a==="daily"?"Log hours for a specific day - ideal when working on different milestones each day.":"Log total hours for an entire week - ideal for consistent weekly work on a single milestone."})]}),R.length===0&&e.jsx("div",{style:{padding:"0.75rem",backgroundColor:"#fef2f2",borderRadius:"6px",marginBottom:"1rem",color:"#dc2626",fontSize:"0.9rem"},children:"âš ï¸ Your account is not linked to a resource. Contact an admin to be added."}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsxs("div",{children:[e.jsxs("label",{className:"form-label",children:["Resource * (",R.length," available)"]}),e.jsxs("select",{className:"form-input",value:i.resource_id,onChange:t=>h({...i,resource_id:t.target.value}),children:[e.jsx("option",{value:"",children:"Select Resource"}),R.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),a==="daily"?e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Date *"}),e.jsx("input",{type:"date",className:"form-input",value:i.work_date,onChange:t=>h({...i,work_date:t.target.value})})]}):e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Week Ending (Sunday) *"}),e.jsx("input",{type:"date",className:"form-input",value:i.week_ending,onChange:t=>h({...i,week_ending:t.target.value})})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"form-label",children:["Milestone (",S.length," available)"]}),e.jsxs("select",{className:"form-input",value:i.milestone_id,onChange:t=>h({...i,milestone_id:t.target.value}),children:[e.jsx("option",{value:"",children:"-- No specific milestone --"}),S.map(t=>e.jsxs("option",{value:t.id,children:[t.milestone_ref," - ",t.name]},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Hours Worked *"}),e.jsx("input",{type:"number",step:"0.5",min:"0.5",max:a==="daily"?"12":"60",className:"form-input",placeholder:a==="daily"?"e.g., 8":"e.g., 40",value:i.hours_worked,onChange:t=>h({...i,hours_worked:t.target.value})}),e.jsx("span",{style:{fontSize:"0.8rem",color:"#64748b"},children:a==="daily"?"Max 12 hours per day":"Total hours for the week"})]}),e.jsxs("div",{style:{gridColumn:"1 / -1"},children:[e.jsx("label",{className:"form-label",children:"Description"}),e.jsx("textarea",{className:"form-input",rows:2,placeholder:"What did you work on?",value:i.description,onChange:t=>h({...i,description:t.target.value})})]})]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem",marginTop:"1rem"},children:[e.jsxs("button",{className:"btn btn-primary",onClick:ue,children:[e.jsx(J,{size:16})," Save Timesheet"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:()=>D(!1),children:[e.jsx(P,{size:16})," Cancel"]})]})]}),e.jsx("div",{className:"card",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Resource"}),e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Milestone"}),e.jsx("th",{style:{textAlign:"right"},children:"Hours"}),e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:y.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:7,style:{textAlign:"center",color:"#64748b",padding:"2rem"},children:"No timesheets found."})}):y.map(t=>{var s,n;return e.jsxs("tr",{style:{backgroundColor:t.is_test_content?"#fffbeb":"transparent"},children:[e.jsx("td",{children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(Re,{size:16,style:{color:"#64748b"}}),f===t.id?e.jsx("select",{className:"form-input",value:o.resource_id,onChange:r=>m({...o,resource_id:r.target.value}),disabled:v!=="admin",children:g.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))}):e.jsx("span",{style:{fontWeight:"500"},children:((s=t.resources)==null?void 0:s.name)||"Unknown"})]})}),e.jsx("td",{children:f===t.id?e.jsx("input",{type:"date",className:"form-input",value:o.work_date,onChange:r=>m({...o,work_date:r.target.value})}):e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(B,{size:14,style:{color:"#64748b"}}),e.jsxs("div",{children:[t.work_date||t.date?new Date(t.work_date||t.date).toLocaleDateString("en-GB"):"-",t.entry_type==="weekly"&&e.jsx("span",{style:{fontSize:"0.75rem",color:"#64748b",display:"block"},children:"(Weekly)"})]})]})}),e.jsx("td",{children:f===t.id?e.jsxs("select",{className:"form-input",value:o.milestone_id,onChange:r=>m({...o,milestone_id:r.target.value}),children:[e.jsx("option",{value:"",children:"None"}),S.map(r=>e.jsx("option",{value:r.id,children:r.milestone_ref},r.id))]}):((n=t.milestones)==null?void 0:n.milestone_ref)||"-"}),e.jsx("td",{style:{textAlign:"right",fontWeight:"600"},children:f===t.id?e.jsx("input",{type:"number",step:"0.5",className:"form-input",value:o.hours_worked,onChange:r=>m({...o,hours_worked:r.target.value}),style:{width:"80px",textAlign:"right"}}):`${parseFloat(t.hours_worked||t.hours||0).toFixed(1)}h`}),e.jsx("td",{style:{maxWidth:"200px"},children:f===t.id?e.jsx("input",{type:"text",className:"form-input",value:o.description,onChange:r=>m({...o,description:r.target.value})}):e.jsx("div",{style:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",color:t.description||t.comments?"inherit":"#9ca3af"},children:t.description||t.comments||"No description"})}),e.jsx("td",{children:f===t.id&&v==="admin"?e.jsx("select",{className:"form-input",value:o.status,onChange:r=>m({...o,status:r.target.value}),children:ce.map(r=>e.jsx("option",{value:r,children:r},r))}):e.jsx("span",{className:`status-badge ${be(t.status)}`,children:t.status})}),e.jsx("td",{children:f===t.id?e.jsxs("div",{className:"action-buttons",children:[e.jsx("button",{className:"btn-icon btn-success",onClick:()=>he(t.id),title:"Save",children:e.jsx(J,{size:16})}),e.jsx("button",{className:"btn-icon btn-secondary",onClick:pe,title:"Cancel",children:e.jsx(P,{size:16})})]}):e.jsxs("div",{className:"action-buttons",children:[te(t)&&e.jsx("button",{className:"btn-icon",onClick:()=>ye(t.id),title:"Submit for Approval",style:{color:"#3b82f6"},children:e.jsx(Ie,{size:16})}),se(t)&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn-icon btn-success",onClick:()=>ge(t.id),title:"Approve",children:e.jsx(X,{size:16})}),e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>je(t.id),title:"Reject",children:e.jsx(P,{size:16})})]}),Z(t)&&e.jsx("button",{className:"btn-icon",onClick:()=>me(t),title:"Edit",children:e.jsx(Me,{size:16})}),ee(t)&&e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>xe(t),title:"Delete",children:e.jsx(ze,{size:16})})]})})]},t.id)})})]})}),e.jsxs("div",{className:"card",style:{marginTop:"1.5rem",backgroundColor:"#f0fdf4",borderLeft:"4px solid #22c55e"},children:[e.jsx("h4",{style:{marginBottom:"0.5rem",color:"#166534"},children:"ðŸ’¡ Timesheet Tips"}),e.jsxs("ul",{style:{margin:"0.5rem 0 0 1.5rem",color:"#166534",fontSize:"0.9rem"},children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Daily Entry:"})," Use when working on different milestones on different days"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Weekly Entry:"})," Use when working consistently on the same milestone all week"]}),e.jsx("li",{children:"Link time to specific milestones when possible for better tracking"}),e.jsxs("li",{children:[e.jsx("strong",{children:"Submit:"})," Click the send icon (â†’) to submit for approval"]}),v==="customer_pm"&&e.jsxs("li",{children:[e.jsx("strong",{children:"As Customer PM:"})," You can approve or reject submitted timesheets"]})]})]}),e.jsx(Pe,{isOpen:d.isOpen,onClose:()=>E({isOpen:!1,timesheetId:null,timesheetData:null}),onConfirm:fe,title:"Delete Timesheet Entry",message:d.timesheetData?e.jsxs("div",{children:[e.jsx("p",{children:"Are you sure you want to delete this timesheet entry?"}),e.jsxs("div",{style:{backgroundColor:"#fef3c7",border:"1px solid #f59e0b",borderRadius:"6px",padding:"0.75rem",marginTop:"0.75rem"},children:[e.jsx("p",{style:{fontWeight:"600",color:"#92400e",margin:"0 0 0.5rem 0"},children:"âš ï¸ Impact on Running Totals:"}),e.jsxs("ul",{style:{margin:"0",paddingLeft:"1.25rem",color:"#92400e",fontSize:"0.9rem"},children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Resource:"})," ",d.timesheetData.resourceName]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Date:"})," ",d.timesheetData.date]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Hours:"})," ",d.timesheetData.hours,"h (",(d.timesheetData.hours/8).toFixed(2)," days)"]}),d.timesheetData.costImpact>0&&e.jsxs("li",{children:[e.jsx("strong",{children:"Cost Impact:"})," -Â£",d.timesheetData.costImpact.toLocaleString("en-GB",{minimumFractionDigits:2})]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Status:"})," ",d.timesheetData.status]})]})]}),e.jsx("p",{style:{marginTop:"0.75rem",fontSize:"0.85rem",color:"#6b7280"},children:"This will permanently remove this entry from all reports and partner invoices."})]}):"Are you sure you want to delete this timesheet?",confirmText:"Delete",cancelText:"Cancel",variant:"danger"})]})}export{Je as default};
