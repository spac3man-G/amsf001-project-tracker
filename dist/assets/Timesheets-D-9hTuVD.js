import{u as Ce,a as Se,b as De,c as Ne,s as d,j as e,L as Te,P as Fe,S as _}from"./index-BiMCcVir.js";import{r as o}from"./vendor-react-JFEV0ROX.js";import{u as Re}from"./usePermissions-tzByz7f2.js";import{C as Ae}from"./ConfirmDialog-Dx_9nxHd.js";import"./qualityStandards.service-CdfaH9UL.js";import{h as G,H as Ie,V as E,C as Q,u as ze,ab as Ee,N as V,a as W,U as We,b as Be,J as Pe,T as Ue}from"./vendor-icons-CoFrSbed.js";import"./vendor-supabase-DgEUAXvv.js";function $e(){const{user:Y,role:v,linkedResource:$}=Ce(),{projectId:c}=Se(),{showSuccess:y,showError:p,showWarning:B}=De(),P=Y?.id||null,b=$?.id||null,{canAddTimesheet:J,canEditTimesheet:X,canDeleteTimesheet:K,canSubmitTimesheet:Z,canValidateTimesheet:ee,getAvailableResources:te}=Re(),[U,se]=o.useState([]),[j,re]=o.useState([]),[k,ie]=o.useState([]),[ne,oe]=o.useState(!0),[L,C]=o.useState(!1),[f,S]=o.useState(null),[i,u]=o.useState({}),[D,ae]=o.useState("all"),[Le,He]=o.useState("all"),[n,H]=o.useState("daily"),[l,N]=o.useState({isOpen:!1,timesheetId:null,timesheetData:null}),{showTestUsers:T,testUserIds:F}=Ne(),[r,m]=o.useState({resource_id:"",milestone_id:"",work_date:new Date().toISOString().split("T")[0],week_ending:O(),hours_worked:"",description:"",status:"Draft",entry_type:"daily"}),le=["Draft","Submitted","Approved","Rejected"];function O(){const t=new Date,s=7-t.getDay(),a=new Date(t);return a.setDate(t.getDate()+(t.getDay()===0?0:s)),a.toISOString().split("T")[0]}o.useEffect(()=>{c&&h(c)},[c]),o.useEffect(()=>{c&&h(c)},[T]),o.useEffect(()=>{b&&m(t=>({...t,resource_id:b}))},[b]);async function h(t){const s=t||c;if(s)try{let a=d.from("timesheets").select(`
          *,
          resources (id, name, email),
          milestones (id, milestone_ref, name)
        `).eq("project_id",s).order("date",{ascending:!1});T||(a=a.or("is_test_content.is.null,is_test_content.eq.false"));const{data:g,error:w}=await a;w||se(g||[]);let A=d.from("resources").select("id, name, email, user_id").order("name");const{data:I,error:_e}=await A;if(!_e){let z=I||[];!T&&F&&F.length>0&&(z=z.filter(M=>!M.user_id||!F.includes(M.user_id))),re(z)}const{data:ve,error:ke}=await d.from("milestones").select("id, milestone_ref, name").eq("project_id",s).order("milestone_ref");ke||ie(ve||[])}catch{}finally{oe(!1)}}async function de(){if(!r.resource_id||!r.hours_worked){B("Please fill in all required fields");return}if(!c){p("Project not found");return}try{const t=j.find(w=>w.id===r.resource_id),s=n==="daily"?r.work_date:r.week_ending,a={project_id:c,resource_id:r.resource_id,milestone_id:r.milestone_id||null,user_id:t?.user_id||P,created_by:P,date:s,work_date:s,week_ending:n==="weekly"?r.week_ending:null,hours_worked:parseFloat(r.hours_worked),hours:parseFloat(r.hours_worked),description:r.description,comments:r.description,status:r.status,entry_type:n},{error:g}=await d.from("timesheets").insert([a]);if(g)throw g;await h(),C(!1),m({resource_id:b||"",milestone_id:"",work_date:new Date().toISOString().split("T")[0],week_ending:O(),hours_worked:"",description:"",status:"Draft",entry_type:n}),y("Timesheet added successfully!")}catch(t){p("Failed to add timesheet: "+t.message)}}async function ce(t){S(t.id),u({resource_id:t.resource_id,milestone_id:t.milestone_id||"",work_date:t.work_date||t.date||"",week_ending:t.week_ending||"",hours_worked:t.hours_worked||t.hours||0,description:t.description||t.comments||"",status:t.status,entry_type:t.entry_type||"daily"})}async function ue(t){try{const{error:s}=await d.from("timesheets").update({resource_id:i.resource_id,milestone_id:i.milestone_id||null,date:i.work_date,work_date:i.work_date,week_ending:i.week_ending||null,hours:parseFloat(i.hours_worked),hours_worked:parseFloat(i.hours_worked),comments:i.description,description:i.description,status:i.status}).eq("id",t);if(s)throw s;await h(),S(null),y("Timesheet updated!")}catch(s){p("Failed to update: "+s.message)}}function me(){S(null),u({})}function he(t){const s=j.find(I=>I.id===t.resource_id),a=s?.cost_price||0,g=parseFloat(t.hours_worked)||0,A=g/8*a;N({isOpen:!0,timesheetId:t.id,timesheetData:{resourceName:t.resource_name||s?.name||"Unknown",date:t.work_date,hours:g,costImpact:A,status:t.status}})}async function pe(){if(l.timesheetId)try{const{error:t}=await d.from("timesheets").delete().eq("id",l.timesheetId);if(t)throw t;await h(),N({isOpen:!1,timesheetId:null,timesheetData:null}),y("Timesheet deleted")}catch(t){p("Failed to delete: "+t.message)}}async function fe(t){try{const{error:s}=await d.from("timesheets").update({status:"Submitted"}).eq("id",t);if(s)throw s;await h(),y("Timesheet submitted for approval!")}catch(s){p("Failed to submit: "+s.message)}}async function xe(t){try{const{error:s}=await d.from("timesheets").update({status:"Approved"}).eq("id",t);if(s)throw s;await h(),y("Timesheet approved!")}catch(s){p("Failed to approve: "+s.message)}}async function ge(t){prompt("Please provide a reason for rejection (optional):");try{const{error:s}=await d.from("timesheets").update({status:"Rejected"}).eq("id",t);if(s)throw s;await h(),B("Timesheet rejected")}catch(s){p("Failed to reject: "+s.message)}}function je(t){switch(t){case"Approved":return"status-approved";case"Submitted":return"status-submitted";case"Rejected":return"status-rejected";default:return"status-draft"}}const x=U.filter(t=>!(D!=="all"&&t.resource_id!==D));[...new Set(U.map(t=>t.week_ending).filter(Boolean))].sort().reverse();const ye=x.reduce((t,s)=>t+parseFloat(s.hours_worked||s.hours||0),0),be=x.filter(t=>t.status==="Approved").reduce((t,s)=>t+parseFloat(s.hours_worked||s.hours||0),0),we=x.filter(t=>t.status==="Submitted").length,q=j.map(t=>({name:t.name,hours:x.filter(s=>s.resource_id===t.id).reduce((s,a)=>s+parseFloat(a.hours_worked||a.hours||0),0)})).filter(t=>t.hours>0),R=te(j);return ne?e.jsx(Te,{message:"Loading timesheets...",size:"large",fullPage:!0}):e.jsxs("div",{className:"page-container",children:[e.jsx(Fe,{icon:G,title:"Timesheets",subtitle:"Track time spent on project activities",children:!L&&J&&e.jsxs("button",{className:"btn btn-primary",onClick:()=>C(!0),children:[e.jsx(Ie,{size:18})," Add Timesheet"]})}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem"},children:[e.jsx(_,{icon:E,label:"Total Entries",value:x.length,color:"#3b82f6"}),e.jsx(_,{icon:G,label:"Total Hours",value:ye.toFixed(1),color:"#3b82f6"}),e.jsx(_,{icon:Q,label:"Approved Hours",value:be.toFixed(1),color:"#10b981"}),e.jsx(_,{icon:ze,label:"Pending Approval",value:we,color:"#f59e0b"})]}),q.length>0&&e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsx("h4",{style:{marginBottom:"0.75rem"},children:"Hours by Resource"}),e.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"1rem"},children:q.map(t=>e.jsxs("div",{style:{padding:"0.75rem 1rem",backgroundColor:"#f1f5f9",borderRadius:"8px",minWidth:"120px"},children:[e.jsx("div",{style:{fontWeight:"600",fontSize:"0.9rem"},children:t.name}),e.jsxs("div",{style:{fontSize:"1.25rem",fontWeight:"700",color:"#3b82f6"},children:[t.hours.toFixed(1),"h"]})]},t.name))})]}),e.jsx("div",{className:"card",style:{marginBottom:"1.5rem"},children:e.jsxs("div",{style:{display:"flex",gap:"1rem",alignItems:"center",flexWrap:"wrap"},children:[e.jsx("span",{style:{fontWeight:"500"},children:"Filter:"}),e.jsxs("select",{value:D,onChange:t=>ae(t.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"all",children:"All Resources"}),j.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]})}),L&&e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem",border:"2px solid var(--primary)"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Add Timesheet Entry"}),e.jsxs("div",{style:{marginBottom:"1.5rem"},children:[e.jsx("label",{style:{fontWeight:"500",marginBottom:"0.5rem",display:"block"},children:"Entry Type"}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsxs("button",{type:"button",onClick:()=>H("daily"),style:{padding:"0.75rem 1.5rem",border:"2px solid",borderColor:n==="daily"?"#10b981":"#e2e8f0",backgroundColor:n==="daily"?"#f0fdf4":"white",borderRadius:"8px",cursor:"pointer",display:"flex",alignItems:"center",gap:"0.5rem",fontWeight:n==="daily"?"600":"400",color:n==="daily"?"#16a34a":"#64748b"},children:[e.jsx(E,{size:18}),"Daily Entry"]}),e.jsxs("button",{type:"button",onClick:()=>H("weekly"),style:{padding:"0.75rem 1.5rem",border:"2px solid",borderColor:n==="weekly"?"#10b981":"#e2e8f0",backgroundColor:n==="weekly"?"#f0fdf4":"white",borderRadius:"8px",cursor:"pointer",display:"flex",alignItems:"center",gap:"0.5rem",fontWeight:n==="weekly"?"600":"400",color:n==="weekly"?"#16a34a":"#64748b"},children:[e.jsx(Ee,{size:18}),"Weekly Summary"]})]}),e.jsx("p",{style:{fontSize:"0.85rem",color:"#64748b",marginTop:"0.5rem"},children:n==="daily"?"Log hours for a specific day - ideal when working on different milestones each day.":"Log total hours for an entire week - ideal for consistent weekly work on a single milestone."})]}),R.length===0&&e.jsx("div",{style:{padding:"0.75rem",backgroundColor:"#fef2f2",borderRadius:"6px",marginBottom:"1rem",color:"#dc2626",fontSize:"0.9rem"},children:"âš ï¸ Your account is not linked to a resource. Contact an admin to be added."}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsxs("div",{children:[e.jsxs("label",{className:"form-label",children:["Resource * (",R.length," available)"]}),e.jsxs("select",{className:"form-input",value:r.resource_id,onChange:t=>m({...r,resource_id:t.target.value}),children:[e.jsx("option",{value:"",children:"Select Resource"}),R.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),n==="daily"?e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Date *"}),e.jsx("input",{type:"date",className:"form-input",value:r.work_date,onChange:t=>m({...r,work_date:t.target.value})})]}):e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Week Ending (Sunday) *"}),e.jsx("input",{type:"date",className:"form-input",value:r.week_ending,onChange:t=>m({...r,week_ending:t.target.value})})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"form-label",children:["Milestone (",k.length," available)"]}),e.jsxs("select",{className:"form-input",value:r.milestone_id,onChange:t=>m({...r,milestone_id:t.target.value}),children:[e.jsx("option",{value:"",children:"-- No specific milestone --"}),k.map(t=>e.jsxs("option",{value:t.id,children:[t.milestone_ref," - ",t.name]},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Hours Worked *"}),e.jsx("input",{type:"number",step:"0.5",min:"0.5",max:n==="daily"?"12":"60",className:"form-input",placeholder:n==="daily"?"e.g., 8":"e.g., 40",value:r.hours_worked,onChange:t=>m({...r,hours_worked:t.target.value})}),e.jsx("span",{style:{fontSize:"0.8rem",color:"#64748b"},children:n==="daily"?"Max 12 hours per day":"Total hours for the week"})]}),e.jsxs("div",{style:{gridColumn:"1 / -1"},children:[e.jsx("label",{className:"form-label",children:"Description"}),e.jsx("textarea",{className:"form-input",rows:2,placeholder:"What did you work on?",value:r.description,onChange:t=>m({...r,description:t.target.value})})]})]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem",marginTop:"1rem"},children:[e.jsxs("button",{className:"btn btn-primary",onClick:de,children:[e.jsx(V,{size:16})," Save Timesheet"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:()=>C(!1),children:[e.jsx(W,{size:16})," Cancel"]})]})]}),e.jsx("div",{className:"card",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Resource"}),e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Milestone"}),e.jsx("th",{style:{textAlign:"right"},children:"Hours"}),e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:x.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:7,style:{textAlign:"center",color:"#64748b",padding:"2rem"},children:"No timesheets found."})}):x.map(t=>e.jsxs("tr",{style:{backgroundColor:t.is_test_content?"#fffbeb":"transparent"},children:[e.jsx("td",{children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(We,{size:16,style:{color:"#64748b"}}),f===t.id?e.jsx("select",{className:"form-input",value:i.resource_id,onChange:s=>u({...i,resource_id:s.target.value}),disabled:v!=="admin",children:j.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))}):e.jsx("span",{style:{fontWeight:"500"},children:t.resources?.name||"Unknown"})]})}),e.jsx("td",{children:f===t.id?e.jsx("input",{type:"date",className:"form-input",value:i.work_date,onChange:s=>u({...i,work_date:s.target.value})}):e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(E,{size:14,style:{color:"#64748b"}}),e.jsxs("div",{children:[t.work_date||t.date?new Date(t.work_date||t.date).toLocaleDateString("en-GB"):"-",t.entry_type==="weekly"&&e.jsx("span",{style:{fontSize:"0.75rem",color:"#64748b",display:"block"},children:"(Weekly)"})]})]})}),e.jsx("td",{children:f===t.id?e.jsxs("select",{className:"form-input",value:i.milestone_id,onChange:s=>u({...i,milestone_id:s.target.value}),children:[e.jsx("option",{value:"",children:"None"}),k.map(s=>e.jsx("option",{value:s.id,children:s.milestone_ref},s.id))]}):t.milestones?.milestone_ref||"-"}),e.jsx("td",{style:{textAlign:"right",fontWeight:"600"},children:f===t.id?e.jsx("input",{type:"number",step:"0.5",className:"form-input",value:i.hours_worked,onChange:s=>u({...i,hours_worked:s.target.value}),style:{width:"80px",textAlign:"right"}}):`${parseFloat(t.hours_worked||t.hours||0).toFixed(1)}h`}),e.jsx("td",{style:{maxWidth:"200px"},children:f===t.id?e.jsx("input",{type:"text",className:"form-input",value:i.description,onChange:s=>u({...i,description:s.target.value})}):e.jsx("div",{style:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",color:t.description||t.comments?"inherit":"#9ca3af"},children:t.description||t.comments||"No description"})}),e.jsx("td",{children:f===t.id&&v==="admin"?e.jsx("select",{className:"form-input",value:i.status,onChange:s=>u({...i,status:s.target.value}),children:le.map(s=>e.jsx("option",{value:s,children:s},s))}):e.jsx("span",{className:`status-badge ${je(t.status)}`,children:t.status})}),e.jsx("td",{children:f===t.id?e.jsxs("div",{className:"action-buttons",children:[e.jsx("button",{className:"btn-icon btn-success",onClick:()=>ue(t.id),title:"Save",children:e.jsx(V,{size:16})}),e.jsx("button",{className:"btn-icon btn-secondary",onClick:me,title:"Cancel",children:e.jsx(W,{size:16})})]}):e.jsxs("div",{className:"action-buttons",children:[Z(t)&&e.jsx("button",{className:"btn-icon",onClick:()=>fe(t.id),title:"Submit for Approval",style:{color:"#3b82f6"},children:e.jsx(Be,{size:16})}),ee(t)&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn-icon btn-success",onClick:()=>xe(t.id),title:"Approve",children:e.jsx(Q,{size:16})}),e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>ge(t.id),title:"Reject",children:e.jsx(W,{size:16})})]}),X(t)&&e.jsx("button",{className:"btn-icon",onClick:()=>ce(t),title:"Edit",children:e.jsx(Pe,{size:16})}),K(t)&&e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>he(t),title:"Delete",children:e.jsx(Ue,{size:16})})]})})]},t.id))})]})}),e.jsxs("div",{className:"card",style:{marginTop:"1.5rem",backgroundColor:"#f0fdf4",borderLeft:"4px solid #22c55e"},children:[e.jsx("h4",{style:{marginBottom:"0.5rem",color:"#166534"},children:"ðŸ’¡ Timesheet Tips"}),e.jsxs("ul",{style:{margin:"0.5rem 0 0 1.5rem",color:"#166534",fontSize:"0.9rem"},children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Daily Entry:"})," Use when working on different milestones on different days"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Weekly Entry:"})," Use when working consistently on the same milestone all week"]}),e.jsx("li",{children:"Link time to specific milestones when possible for better tracking"}),e.jsxs("li",{children:[e.jsx("strong",{children:"Submit:"})," Click the send icon (â†’) to submit for approval"]}),v==="customer_pm"&&e.jsxs("li",{children:[e.jsx("strong",{children:"As Customer PM:"})," You can approve or reject submitted timesheets"]})]})]}),e.jsx(Ae,{isOpen:l.isOpen,onClose:()=>N({isOpen:!1,timesheetId:null,timesheetData:null}),onConfirm:pe,title:"Delete Timesheet Entry",message:l.timesheetData?e.jsxs("div",{children:[e.jsx("p",{children:"Are you sure you want to delete this timesheet entry?"}),e.jsxs("div",{style:{backgroundColor:"#fef3c7",border:"1px solid #f59e0b",borderRadius:"6px",padding:"0.75rem",marginTop:"0.75rem"},children:[e.jsx("p",{style:{fontWeight:"600",color:"#92400e",margin:"0 0 0.5rem 0"},children:"âš ï¸ Impact on Running Totals:"}),e.jsxs("ul",{style:{margin:"0",paddingLeft:"1.25rem",color:"#92400e",fontSize:"0.9rem"},children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Resource:"})," ",l.timesheetData.resourceName]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Date:"})," ",l.timesheetData.date]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Hours:"})," ",l.timesheetData.hours,"h (",(l.timesheetData.hours/8).toFixed(2)," days)"]}),l.timesheetData.costImpact>0&&e.jsxs("li",{children:[e.jsx("strong",{children:"Cost Impact:"})," -Â£",l.timesheetData.costImpact.toLocaleString("en-GB",{minimumFractionDigits:2})]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Status:"})," ",l.timesheetData.status]})]})]}),e.jsx("p",{style:{marginTop:"0.75rem",fontSize:"0.85rem",color:"#6b7280"},children:"This will permanently remove this entry from all reports and partner invoices."})]}):"Are you sure you want to delete this timesheet?",confirmText:"Delete",cancelText:"Cancel",variant:"danger"})]})}export{$e as default};
