import{u as xe,a as ge,b as je,c as fe,t as x,r as ye,m as be,j as e,L as we,P as ve,S as _}from"./index-D73npgqV.js";import{r as n}from"./vendor-react-CaXNtsgv.js";import{u as _e}from"./usePermissions-Dl3GKB24.js";import{C as ke}from"./ConfirmDialog-C52PSqL8.js";import{k as H,Z as Se,a0 as F,C as P,y as Ce,ai as Ne,N as L,a as R,U as De,e as Te,_ as Fe,T as Re}from"./vendor-icons-cI_2Oee6.js";import"./vendor-supabase-qY1sfceY.js";import"./vendor-charts-_mIYJ_kN.js";const Ae=["Draft","Submitted","Approved","Rejected"];function M(){const g=new Date,b=7-g.getDay(),w=new Date(g);return w.setDate(g.getDate()+(g.getDay()===0?0:b)),w.toISOString().split("T")[0]}function He(){const{user:g,role:b,linkedResource:w}=xe(),{projectId:j}=ge(),{showSuccess:y,showError:l,showWarning:A}=je(),{showTestUsers:k,testUserIds:I}=fe(),S=g?.id||null,v=w?.id||null,{canAddTimesheet:$,canEditTimesheet:q,canDeleteTimesheet:G,canSubmitTimesheet:V,canValidateTimesheet:X,getAvailableResources:Y}=_e(),[Z,J]=n.useState([]),[f,K]=n.useState([]),[z,Q]=n.useState([]),[ee,E]=n.useState(!0),[W,C]=n.useState(!1),[u,N]=n.useState(null),[r,m]=n.useState({}),[D,te]=n.useState("all"),[a,B]=n.useState("daily"),[h,T]=n.useState({isOpen:!1,timesheetId:null,timesheetData:null}),[i,d]=n.useState({resource_id:"",milestone_id:"",work_date:new Date().toISOString().split("T")[0],week_ending:M(),hours_worked:"",description:"",status:"Draft",entry_type:"daily"}),c=n.useCallback(async()=>{if(j){E(!0);try{const t=await x.getAllFiltered(j,k);J(t);const s=await ye.getAllWithTestFilter(j,k?[]:I);K(s);const o=await be.getAll(j,{orderBy:{column:"milestone_ref",ascending:!0}});Q(o)}catch{l("Failed to load timesheets")}finally{E(!1)}}},[j,k,I,l]);n.useEffect(()=>{c()},[c]),n.useEffect(()=>{v&&d(t=>({...t,resource_id:v}))},[v]);async function se(){if(!i.resource_id||!i.hours_worked){A("Please fill in all required fields");return}try{const t=f.find(o=>o.id===i.resource_id),s=a==="daily"?i.work_date:i.week_ending;await x.create({project_id:j,resource_id:i.resource_id,milestone_id:i.milestone_id||null,user_id:t?.user_id||S,created_by:S,date:s,work_date:s,week_ending:a==="weekly"?i.week_ending:null,hours_worked:parseFloat(i.hours_worked),hours:parseFloat(i.hours_worked),description:i.description,comments:i.description,status:i.status,entry_type:a}),await c(),C(!1),d({resource_id:v||"",milestone_id:"",work_date:new Date().toISOString().split("T")[0],week_ending:M(),hours_worked:"",description:"",status:"Draft",entry_type:a}),y("Timesheet added successfully!")}catch(t){l("Failed to add timesheet: "+t.message)}}function ie(t){N(t.id),m({resource_id:t.resource_id,milestone_id:t.milestone_id||"",work_date:t.work_date||t.date||"",week_ending:t.week_ending||"",hours_worked:t.hours_worked||t.hours||0,description:t.description||t.comments||"",status:t.status,entry_type:t.entry_type||"daily"})}async function re(t){try{await x.update(t,{resource_id:r.resource_id,milestone_id:r.milestone_id||null,date:r.work_date,work_date:r.work_date,week_ending:r.week_ending||null,hours:parseFloat(r.hours_worked),hours_worked:parseFloat(r.hours_worked),comments:r.description,description:r.description,status:r.status}),await c(),N(null),y("Timesheet updated!")}catch(s){l("Failed to update: "+s.message)}}function ae(t){const s=f.find(pe=>pe.id===t.resource_id),o=parseFloat(t.hours_worked)||0;T({isOpen:!0,timesheetId:t.id,timesheetData:{resourceName:t.resources?.name||s?.name||"Unknown",date:t.work_date||t.date,hours:o,costImpact:o/8*(s?.cost_price||0),status:t.status}})}async function ne(){if(h.timesheetId)try{await x.delete(h.timesheetId,S),await c(),T({isOpen:!1,timesheetId:null,timesheetData:null}),y("Timesheet deleted")}catch(t){l("Failed to delete: "+t.message)}}async function oe(t){try{await x.submit(t),await c(),y("Timesheet submitted!")}catch(s){l("Failed to submit: "+s.message)}}async function le(t){try{await x.approve(t),await c(),y("Timesheet approved!")}catch(s){l("Failed to approve: "+s.message)}}async function de(t){const s=prompt("Rejection reason (optional):");try{await x.reject(t,s),await c(),A("Timesheet rejected")}catch(o){l("Failed to reject: "+o.message)}}function ce(t){switch(t){case"Approved":return"status-approved";case"Submitted":return"status-submitted";case"Rejected":return"status-rejected";default:return"status-draft"}}const p=Z.filter(t=>D==="all"||t.resource_id===D),ue=p.reduce((t,s)=>t+parseFloat(s.hours_worked||s.hours||0),0),me=p.filter(t=>t.status==="Approved").reduce((t,s)=>t+parseFloat(s.hours_worked||s.hours||0),0),he=p.filter(t=>t.status==="Submitted").length,U=f.map(t=>({name:t.name,hours:p.filter(s=>s.resource_id===t.id).reduce((s,o)=>s+parseFloat(o.hours_worked||o.hours||0),0)})).filter(t=>t.hours>0),O=Y(f);return ee?e.jsx(we,{message:"Loading timesheets...",size:"large",fullPage:!0}):e.jsxs("div",{className:"page-container",children:[e.jsx(ve,{icon:H,title:"Timesheets",subtitle:"Track time spent on project activities",children:!W&&$&&e.jsxs("button",{className:"btn btn-primary",onClick:()=>C(!0),children:[e.jsx(Se,{size:18})," Add Timesheet"]})}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem"},children:[e.jsx(_,{icon:F,label:"Total Entries",value:p.length,color:"#3b82f6"}),e.jsx(_,{icon:H,label:"Total Hours",value:ue.toFixed(1),color:"#3b82f6"}),e.jsx(_,{icon:P,label:"Approved Hours",value:me.toFixed(1),color:"#10b981"}),e.jsx(_,{icon:Ce,label:"Pending Approval",value:he,color:"#f59e0b"})]}),U.length>0&&e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsx("h4",{style:{marginBottom:"0.75rem"},children:"Hours by Resource"}),e.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"1rem"},children:U.map(t=>e.jsxs("div",{style:{padding:"0.75rem 1rem",backgroundColor:"#f1f5f9",borderRadius:"8px",minWidth:"120px"},children:[e.jsx("div",{style:{fontWeight:"600",fontSize:"0.9rem"},children:t.name}),e.jsxs("div",{style:{fontSize:"1.25rem",fontWeight:"700",color:"#3b82f6"},children:[t.hours.toFixed(1),"h"]})]},t.name))})]}),e.jsx("div",{className:"card",style:{marginBottom:"1.5rem"},children:e.jsxs("div",{style:{display:"flex",gap:"1rem",alignItems:"center",flexWrap:"wrap"},children:[e.jsx("span",{style:{fontWeight:"500"},children:"Filter:"}),e.jsxs("select",{value:D,onChange:t=>te(t.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"all",children:"All Resources"}),f.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]})}),W&&e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem",border:"2px solid var(--primary)"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Add Timesheet Entry"}),e.jsxs("div",{style:{marginBottom:"1.5rem"},children:[e.jsx("label",{style:{fontWeight:"500",marginBottom:"0.5rem",display:"block"},children:"Entry Type"}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsxs("button",{type:"button",onClick:()=>B("daily"),style:{padding:"0.75rem 1.5rem",border:"2px solid",borderColor:a==="daily"?"#10b981":"#e2e8f0",backgroundColor:a==="daily"?"#f0fdf4":"white",borderRadius:"8px",cursor:"pointer",display:"flex",alignItems:"center",gap:"0.5rem",fontWeight:a==="daily"?"600":"400",color:a==="daily"?"#16a34a":"#64748b"},children:[e.jsx(F,{size:18})," Daily Entry"]}),e.jsxs("button",{type:"button",onClick:()=>B("weekly"),style:{padding:"0.75rem 1.5rem",border:"2px solid",borderColor:a==="weekly"?"#10b981":"#e2e8f0",backgroundColor:a==="weekly"?"#f0fdf4":"white",borderRadius:"8px",cursor:"pointer",display:"flex",alignItems:"center",gap:"0.5rem",fontWeight:a==="weekly"?"600":"400",color:a==="weekly"?"#16a34a":"#64748b"},children:[e.jsx(Ne,{size:18})," Weekly Summary"]})]})]}),O.length===0&&e.jsx("div",{style:{padding:"0.75rem",backgroundColor:"#fef2f2",borderRadius:"6px",marginBottom:"1rem",color:"#dc2626",fontSize:"0.9rem"},children:"⚠️ Your account is not linked to a resource."}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Resource *"}),e.jsxs("select",{className:"form-input",value:i.resource_id,onChange:t=>d({...i,resource_id:t.target.value}),children:[e.jsx("option",{value:"",children:"Select Resource"}),O.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),a==="daily"?e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Date *"}),e.jsx("input",{type:"date",className:"form-input",value:i.work_date,onChange:t=>d({...i,work_date:t.target.value})})]}):e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Week Ending *"}),e.jsx("input",{type:"date",className:"form-input",value:i.week_ending,onChange:t=>d({...i,week_ending:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Milestone"}),e.jsxs("select",{className:"form-input",value:i.milestone_id,onChange:t=>d({...i,milestone_id:t.target.value}),children:[e.jsx("option",{value:"",children:"-- No specific milestone --"}),z.map(t=>e.jsxs("option",{value:t.id,children:[t.milestone_ref," - ",t.name]},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Hours *"}),e.jsx("input",{type:"number",step:"0.5",min:"0.5",max:a==="daily"?"12":"60",className:"form-input",placeholder:a==="daily"?"e.g., 8":"e.g., 40",value:i.hours_worked,onChange:t=>d({...i,hours_worked:t.target.value})})]}),e.jsxs("div",{style:{gridColumn:"1 / -1"},children:[e.jsx("label",{className:"form-label",children:"Description"}),e.jsx("textarea",{className:"form-input",rows:2,placeholder:"What did you work on?",value:i.description,onChange:t=>d({...i,description:t.target.value})})]})]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem",marginTop:"1rem"},children:[e.jsxs("button",{className:"btn btn-primary",onClick:se,children:[e.jsx(L,{size:16})," Save"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:()=>C(!1),children:[e.jsx(R,{size:16})," Cancel"]})]})]}),e.jsx("div",{className:"card",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Resource"}),e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Milestone"}),e.jsx("th",{style:{textAlign:"right"},children:"Hours"}),e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:p.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:7,style:{textAlign:"center",color:"#64748b",padding:"2rem"},children:"No timesheets found."})}):p.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(De,{size:16,style:{color:"#64748b"}}),u===t.id?e.jsx("select",{className:"form-input",value:r.resource_id,onChange:s=>m({...r,resource_id:s.target.value}),disabled:b!=="admin",children:f.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))}):e.jsx("span",{style:{fontWeight:"500"},children:t.resources?.name||"Unknown"})]})}),e.jsx("td",{children:u===t.id?e.jsx("input",{type:"date",className:"form-input",value:r.work_date,onChange:s=>m({...r,work_date:s.target.value})}):e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(F,{size:14,style:{color:"#64748b"}}),t.work_date||t.date?new Date(t.work_date||t.date).toLocaleDateString("en-GB"):"-"]})}),e.jsx("td",{children:u===t.id?e.jsxs("select",{className:"form-input",value:r.milestone_id,onChange:s=>m({...r,milestone_id:s.target.value}),children:[e.jsx("option",{value:"",children:"None"}),z.map(s=>e.jsx("option",{value:s.id,children:s.milestone_ref},s.id))]}):t.milestones?.milestone_ref||"-"}),e.jsx("td",{style:{textAlign:"right",fontWeight:"600"},children:u===t.id?e.jsx("input",{type:"number",step:"0.5",className:"form-input",value:r.hours_worked,onChange:s=>m({...r,hours_worked:s.target.value}),style:{width:"80px",textAlign:"right"}}):`${parseFloat(t.hours_worked||t.hours||0).toFixed(1)}h`}),e.jsx("td",{style:{maxWidth:"200px"},children:u===t.id?e.jsx("input",{type:"text",className:"form-input",value:r.description,onChange:s=>m({...r,description:s.target.value})}):e.jsx("div",{style:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:t.description||t.comments||"No description"})}),e.jsx("td",{children:u===t.id&&b==="admin"?e.jsx("select",{className:"form-input",value:r.status,onChange:s=>m({...r,status:s.target.value}),children:Ae.map(s=>e.jsx("option",{value:s,children:s},s))}):e.jsx("span",{className:`status-badge ${ce(t.status)}`,children:t.status})}),e.jsx("td",{children:u===t.id?e.jsxs("div",{className:"action-buttons",children:[e.jsx("button",{className:"btn-icon btn-success",onClick:()=>re(t.id),children:e.jsx(L,{size:16})}),e.jsx("button",{className:"btn-icon btn-secondary",onClick:()=>N(null),children:e.jsx(R,{size:16})})]}):e.jsxs("div",{className:"action-buttons",children:[V(t)&&e.jsx("button",{className:"btn-icon",onClick:()=>oe(t.id),title:"Submit",style:{color:"#3b82f6"},children:e.jsx(Te,{size:16})}),X(t)&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn-icon btn-success",onClick:()=>le(t.id),title:"Approve",children:e.jsx(P,{size:16})}),e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>de(t.id),title:"Reject",children:e.jsx(R,{size:16})})]}),q(t)&&e.jsx("button",{className:"btn-icon",onClick:()=>ie(t),title:"Edit",children:e.jsx(Fe,{size:16})}),G(t)&&e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>ae(t),title:"Delete",children:e.jsx(Re,{size:16})})]})})]},t.id))})]})}),e.jsx(ke,{isOpen:h.isOpen,onClose:()=>T({isOpen:!1,timesheetId:null,timesheetData:null}),onConfirm:ne,title:"Delete Timesheet",message:h.timesheetData?e.jsxs("div",{children:[e.jsx("p",{children:"Delete this timesheet entry?"}),e.jsx("div",{style:{backgroundColor:"#fef3c7",border:"1px solid #f59e0b",borderRadius:"6px",padding:"0.75rem",marginTop:"0.75rem"},children:e.jsxs("ul",{style:{margin:"0",paddingLeft:"1.25rem",color:"#92400e",fontSize:"0.9rem"},children:[e.jsxs("li",{children:["Resource: ",h.timesheetData.resourceName]}),e.jsxs("li",{children:["Hours: ",h.timesheetData.hours,"h"]}),e.jsxs("li",{children:["Status: ",h.timesheetData.status]})]})})]}):"Delete this timesheet?",confirmText:"Delete",cancelText:"Cancel",variant:"danger"})]})}export{He as default};
