import{u as ge,a as je,b as fe,c as ye,t as x,s as be,m as we,j as e,L as _e,P as ve,S as v}from"./index-B5r_rj8e.js";import{r as n}from"./vendor-react-JFEV0ROX.js";import{u as ke}from"./usePermissions-D0smDYjW.js";import{C as Ce}from"./ConfirmDialog-CubZijV7.js";import{h as L,H as Se,V as A,C as M,u as Ne,ab as De,N as V,a as I,U as Te,b as Fe,J as Re,T as Ae}from"./vendor-icons-Bd7vp13O.js";import"./vendor-supabase-DgEUAXvv.js";const Ie=["Draft","Submitted","Approved","Rejected"];function $(){const g=new Date,b=7-g.getDay(),w=new Date(g);return w.setDate(g.getDate()+(g.getDay()===0?0:b)),w.toISOString().split("T")[0]}function Oe(){const{user:g,role:b,linkedResource:w}=ge(),{projectId:f}=je(),{showSuccess:y,showError:l,showWarning:z}=fe(),{showTestUsers:k,testUserIds:C}=ye(),S=g?.id||null,_=w?.id||null,{canAddTimesheet:q,canEditTimesheet:G,canDeleteTimesheet:J,canSubmitTimesheet:X,canValidateTimesheet:Y,getAvailableResources:K}=ke(),[Q,Z]=n.useState([]),[j,ee]=n.useState([]),[E,te]=n.useState([]),[se,W]=n.useState(!0),[B,N]=n.useState(!1),[u,D]=n.useState(null),[r,m]=n.useState({}),[T,ie]=n.useState("all"),[a,U]=n.useState("daily"),[h,F]=n.useState({isOpen:!1,timesheetId:null,timesheetData:null}),[i,d]=n.useState({resource_id:"",milestone_id:"",work_date:new Date().toISOString().split("T")[0],week_ending:$(),hours_worked:"",description:"",status:"Draft",entry_type:"daily"}),c=n.useCallback(async()=>{if(f){W(!0);try{const t=await x.getAllFiltered(f,k);Z(t);const{data:s}=await be.from("resources").select("id, name, email, user_id, cost_price").order("name");let o=s||[];!k&&C?.length>0&&(o=o.filter(P=>!P.user_id||!C.includes(P.user_id))),ee(o);const R=await we.getAll(f,{orderBy:{column:"milestone_ref",ascending:!0}});te(R)}catch{l("Failed to load timesheets")}finally{W(!1)}}},[f,k,C,l]);n.useEffect(()=>{c()},[c]),n.useEffect(()=>{_&&d(t=>({...t,resource_id:_}))},[_]);async function re(){if(!i.resource_id||!i.hours_worked){z("Please fill in all required fields");return}try{const t=j.find(o=>o.id===i.resource_id),s=a==="daily"?i.work_date:i.week_ending;await x.create({project_id:f,resource_id:i.resource_id,milestone_id:i.milestone_id||null,user_id:t?.user_id||S,created_by:S,date:s,work_date:s,week_ending:a==="weekly"?i.week_ending:null,hours_worked:parseFloat(i.hours_worked),hours:parseFloat(i.hours_worked),description:i.description,comments:i.description,status:i.status,entry_type:a}),await c(),N(!1),d({resource_id:_||"",milestone_id:"",work_date:new Date().toISOString().split("T")[0],week_ending:$(),hours_worked:"",description:"",status:"Draft",entry_type:a}),y("Timesheet added successfully!")}catch(t){l("Failed to add timesheet: "+t.message)}}function ae(t){D(t.id),m({resource_id:t.resource_id,milestone_id:t.milestone_id||"",work_date:t.work_date||t.date||"",week_ending:t.week_ending||"",hours_worked:t.hours_worked||t.hours||0,description:t.description||t.comments||"",status:t.status,entry_type:t.entry_type||"daily"})}async function ne(t){try{await x.update(t,{resource_id:r.resource_id,milestone_id:r.milestone_id||null,date:r.work_date,work_date:r.work_date,week_ending:r.week_ending||null,hours:parseFloat(r.hours_worked),hours_worked:parseFloat(r.hours_worked),comments:r.description,description:r.description,status:r.status}),await c(),D(null),y("Timesheet updated!")}catch(s){l("Failed to update: "+s.message)}}function oe(t){const s=j.find(R=>R.id===t.resource_id),o=parseFloat(t.hours_worked)||0;F({isOpen:!0,timesheetId:t.id,timesheetData:{resourceName:t.resources?.name||s?.name||"Unknown",date:t.work_date||t.date,hours:o,costImpact:o/8*(s?.cost_price||0),status:t.status}})}async function le(){if(h.timesheetId)try{await x.delete(h.timesheetId,S),await c(),F({isOpen:!1,timesheetId:null,timesheetData:null}),y("Timesheet deleted")}catch(t){l("Failed to delete: "+t.message)}}async function de(t){try{await x.submit(t),await c(),y("Timesheet submitted!")}catch(s){l("Failed to submit: "+s.message)}}async function ce(t){try{await x.approve(t),await c(),y("Timesheet approved!")}catch(s){l("Failed to approve: "+s.message)}}async function ue(t){const s=prompt("Rejection reason (optional):");try{await x.reject(t,s),await c(),z("Timesheet rejected")}catch(o){l("Failed to reject: "+o.message)}}function me(t){switch(t){case"Approved":return"status-approved";case"Submitted":return"status-submitted";case"Rejected":return"status-rejected";default:return"status-draft"}}const p=Q.filter(t=>T==="all"||t.resource_id===T),he=p.reduce((t,s)=>t+parseFloat(s.hours_worked||s.hours||0),0),pe=p.filter(t=>t.status==="Approved").reduce((t,s)=>t+parseFloat(s.hours_worked||s.hours||0),0),xe=p.filter(t=>t.status==="Submitted").length,H=j.map(t=>({name:t.name,hours:p.filter(s=>s.resource_id===t.id).reduce((s,o)=>s+parseFloat(o.hours_worked||o.hours||0),0)})).filter(t=>t.hours>0),O=K(j);return se?e.jsx(_e,{message:"Loading timesheets...",size:"large",fullPage:!0}):e.jsxs("div",{className:"page-container",children:[e.jsx(ve,{icon:L,title:"Timesheets",subtitle:"Track time spent on project activities",children:!B&&q&&e.jsxs("button",{className:"btn btn-primary",onClick:()=>N(!0),children:[e.jsx(Se,{size:18})," Add Timesheet"]})}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem"},children:[e.jsx(v,{icon:A,label:"Total Entries",value:p.length,color:"#3b82f6"}),e.jsx(v,{icon:L,label:"Total Hours",value:he.toFixed(1),color:"#3b82f6"}),e.jsx(v,{icon:M,label:"Approved Hours",value:pe.toFixed(1),color:"#10b981"}),e.jsx(v,{icon:Ne,label:"Pending Approval",value:xe,color:"#f59e0b"})]}),H.length>0&&e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsx("h4",{style:{marginBottom:"0.75rem"},children:"Hours by Resource"}),e.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"1rem"},children:H.map(t=>e.jsxs("div",{style:{padding:"0.75rem 1rem",backgroundColor:"#f1f5f9",borderRadius:"8px",minWidth:"120px"},children:[e.jsx("div",{style:{fontWeight:"600",fontSize:"0.9rem"},children:t.name}),e.jsxs("div",{style:{fontSize:"1.25rem",fontWeight:"700",color:"#3b82f6"},children:[t.hours.toFixed(1),"h"]})]},t.name))})]}),e.jsx("div",{className:"card",style:{marginBottom:"1.5rem"},children:e.jsxs("div",{style:{display:"flex",gap:"1rem",alignItems:"center",flexWrap:"wrap"},children:[e.jsx("span",{style:{fontWeight:"500"},children:"Filter:"}),e.jsxs("select",{value:T,onChange:t=>ie(t.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"all",children:"All Resources"}),j.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]})}),B&&e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem",border:"2px solid var(--primary)"},children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Add Timesheet Entry"}),e.jsxs("div",{style:{marginBottom:"1.5rem"},children:[e.jsx("label",{style:{fontWeight:"500",marginBottom:"0.5rem",display:"block"},children:"Entry Type"}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsxs("button",{type:"button",onClick:()=>U("daily"),style:{padding:"0.75rem 1.5rem",border:"2px solid",borderColor:a==="daily"?"#10b981":"#e2e8f0",backgroundColor:a==="daily"?"#f0fdf4":"white",borderRadius:"8px",cursor:"pointer",display:"flex",alignItems:"center",gap:"0.5rem",fontWeight:a==="daily"?"600":"400",color:a==="daily"?"#16a34a":"#64748b"},children:[e.jsx(A,{size:18})," Daily Entry"]}),e.jsxs("button",{type:"button",onClick:()=>U("weekly"),style:{padding:"0.75rem 1.5rem",border:"2px solid",borderColor:a==="weekly"?"#10b981":"#e2e8f0",backgroundColor:a==="weekly"?"#f0fdf4":"white",borderRadius:"8px",cursor:"pointer",display:"flex",alignItems:"center",gap:"0.5rem",fontWeight:a==="weekly"?"600":"400",color:a==="weekly"?"#16a34a":"#64748b"},children:[e.jsx(De,{size:18})," Weekly Summary"]})]})]}),O.length===0&&e.jsx("div",{style:{padding:"0.75rem",backgroundColor:"#fef2f2",borderRadius:"6px",marginBottom:"1rem",color:"#dc2626",fontSize:"0.9rem"},children:"⚠️ Your account is not linked to a resource."}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Resource *"}),e.jsxs("select",{className:"form-input",value:i.resource_id,onChange:t=>d({...i,resource_id:t.target.value}),children:[e.jsx("option",{value:"",children:"Select Resource"}),O.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),a==="daily"?e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Date *"}),e.jsx("input",{type:"date",className:"form-input",value:i.work_date,onChange:t=>d({...i,work_date:t.target.value})})]}):e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Week Ending *"}),e.jsx("input",{type:"date",className:"form-input",value:i.week_ending,onChange:t=>d({...i,week_ending:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Milestone"}),e.jsxs("select",{className:"form-input",value:i.milestone_id,onChange:t=>d({...i,milestone_id:t.target.value}),children:[e.jsx("option",{value:"",children:"-- No specific milestone --"}),E.map(t=>e.jsxs("option",{value:t.id,children:[t.milestone_ref," - ",t.name]},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Hours *"}),e.jsx("input",{type:"number",step:"0.5",min:"0.5",max:a==="daily"?"12":"60",className:"form-input",placeholder:a==="daily"?"e.g., 8":"e.g., 40",value:i.hours_worked,onChange:t=>d({...i,hours_worked:t.target.value})})]}),e.jsxs("div",{style:{gridColumn:"1 / -1"},children:[e.jsx("label",{className:"form-label",children:"Description"}),e.jsx("textarea",{className:"form-input",rows:2,placeholder:"What did you work on?",value:i.description,onChange:t=>d({...i,description:t.target.value})})]})]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem",marginTop:"1rem"},children:[e.jsxs("button",{className:"btn btn-primary",onClick:re,children:[e.jsx(V,{size:16})," Save"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:()=>N(!1),children:[e.jsx(I,{size:16})," Cancel"]})]})]}),e.jsx("div",{className:"card",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Resource"}),e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Milestone"}),e.jsx("th",{style:{textAlign:"right"},children:"Hours"}),e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:p.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:7,style:{textAlign:"center",color:"#64748b",padding:"2rem"},children:"No timesheets found."})}):p.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(Te,{size:16,style:{color:"#64748b"}}),u===t.id?e.jsx("select",{className:"form-input",value:r.resource_id,onChange:s=>m({...r,resource_id:s.target.value}),disabled:b!=="admin",children:j.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))}):e.jsx("span",{style:{fontWeight:"500"},children:t.resources?.name||"Unknown"})]})}),e.jsx("td",{children:u===t.id?e.jsx("input",{type:"date",className:"form-input",value:r.work_date,onChange:s=>m({...r,work_date:s.target.value})}):e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(A,{size:14,style:{color:"#64748b"}}),t.work_date||t.date?new Date(t.work_date||t.date).toLocaleDateString("en-GB"):"-"]})}),e.jsx("td",{children:u===t.id?e.jsxs("select",{className:"form-input",value:r.milestone_id,onChange:s=>m({...r,milestone_id:s.target.value}),children:[e.jsx("option",{value:"",children:"None"}),E.map(s=>e.jsx("option",{value:s.id,children:s.milestone_ref},s.id))]}):t.milestones?.milestone_ref||"-"}),e.jsx("td",{style:{textAlign:"right",fontWeight:"600"},children:u===t.id?e.jsx("input",{type:"number",step:"0.5",className:"form-input",value:r.hours_worked,onChange:s=>m({...r,hours_worked:s.target.value}),style:{width:"80px",textAlign:"right"}}):`${parseFloat(t.hours_worked||t.hours||0).toFixed(1)}h`}),e.jsx("td",{style:{maxWidth:"200px"},children:u===t.id?e.jsx("input",{type:"text",className:"form-input",value:r.description,onChange:s=>m({...r,description:s.target.value})}):e.jsx("div",{style:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:t.description||t.comments||"No description"})}),e.jsx("td",{children:u===t.id&&b==="admin"?e.jsx("select",{className:"form-input",value:r.status,onChange:s=>m({...r,status:s.target.value}),children:Ie.map(s=>e.jsx("option",{value:s,children:s},s))}):e.jsx("span",{className:`status-badge ${me(t.status)}`,children:t.status})}),e.jsx("td",{children:u===t.id?e.jsxs("div",{className:"action-buttons",children:[e.jsx("button",{className:"btn-icon btn-success",onClick:()=>ne(t.id),children:e.jsx(V,{size:16})}),e.jsx("button",{className:"btn-icon btn-secondary",onClick:()=>D(null),children:e.jsx(I,{size:16})})]}):e.jsxs("div",{className:"action-buttons",children:[X(t)&&e.jsx("button",{className:"btn-icon",onClick:()=>de(t.id),title:"Submit",style:{color:"#3b82f6"},children:e.jsx(Fe,{size:16})}),Y(t)&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn-icon btn-success",onClick:()=>ce(t.id),title:"Approve",children:e.jsx(M,{size:16})}),e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>ue(t.id),title:"Reject",children:e.jsx(I,{size:16})})]}),G(t)&&e.jsx("button",{className:"btn-icon",onClick:()=>ae(t),title:"Edit",children:e.jsx(Re,{size:16})}),J(t)&&e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>oe(t),title:"Delete",children:e.jsx(Ae,{size:16})})]})})]},t.id))})]})}),e.jsx(Ce,{isOpen:h.isOpen,onClose:()=>F({isOpen:!1,timesheetId:null,timesheetData:null}),onConfirm:le,title:"Delete Timesheet",message:h.timesheetData?e.jsxs("div",{children:[e.jsx("p",{children:"Delete this timesheet entry?"}),e.jsx("div",{style:{backgroundColor:"#fef3c7",border:"1px solid #f59e0b",borderRadius:"6px",padding:"0.75rem",marginTop:"0.75rem"},children:e.jsxs("ul",{style:{margin:"0",paddingLeft:"1.25rem",color:"#92400e",fontSize:"0.9rem"},children:[e.jsxs("li",{children:["Resource: ",h.timesheetData.resourceName]}),e.jsxs("li",{children:["Hours: ",h.timesheetData.hours,"h"]}),e.jsxs("li",{children:["Status: ",h.timesheetData.status]})]})})]}):"Delete this timesheet?",confirmText:"Delete",cancelText:"Cancel",variant:"danger"})]})}export{Oe as default};
