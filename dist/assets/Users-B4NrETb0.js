import{f as Q,c as Z,s as c,j as e,L as ee}from"./index-CBgfEH4u.js";import{r as n}from"./vendor-react-B1g8b4mG.js";import{C as se}from"./ConfirmDialog-D1XFvXRB.js";import{aD as ae,q as le,a7 as re,w as ne,R as te,ab as S,aE as z,ad as ie,c as ce,aF as oe,aG as de,a as ue}from"./vendor-icons-CcYex6rY.js";import"./vendor-supabase-DSZ6Ejbd.js";function pe(){const[u,T]=n.useState([]),[y,E]=n.useState([]),[I,U]=n.useState(!0),[p,D]=n.useState("viewer"),[F,L]=n.useState(null),[q,v]=n.useState(!1),[O,g]=n.useState(null),[P,N]=n.useState(null),[b,w]=n.useState(""),[x,C]=n.useState({isOpen:!1,resourceId:null,resourceName:null}),{showTestUsers:i,toggleTestUsers:A,canToggleTestUsers:M}=Q(),{showSuccess:j,showError:f,showWarning:_}=Z(),[l,m]=n.useState({email:"",password:"",full_name:"",role:"viewer"}),h=[{value:"admin",label:"Admin",color:"#7c3aed"},{value:"supplier_pm",label:"Supplier PM",color:"#059669"},{value:"customer_pm",label:"Customer PM",color:"#d97706"},{value:"contributor",label:"Contributor",color:"#2563eb"},{value:"viewer",label:"Viewer",color:"#64748b"}];n.useEffect(()=>{$()},[]),n.useEffect(()=>{R&&o()},[p,i]);async function $(){const{data:{user:s}}=await c.auth.getUser();if(s){L(s.id);const{data:a}=await c.from("profiles").select("role").eq("id",s.id).single();a&&D(a.role)}}const R=p==="admin"||p==="supplier_pm";async function o(){try{U(!0);let s=c.from("profiles").select("*").order("created_at",{ascending:!1});i||(s=s.or("is_test_user.is.null,is_test_user.eq.false"));const{data:a,error:r}=await s;if(r)throw r;T(a||[]);const{data:d}=await c.from("resources").select("id, name, email, user_id").order("name");E(d||[])}catch{}finally{U(!1)}}async function B(){if(!l.email||!l.password){_("Email and password are required");return}try{const{data:s,error:a}=await c.auth.admin.createUser({email:l.email,password:l.password,email_confirm:!0});if(a)throw a;const{error:r}=await c.from("profiles").insert({id:s.user.id,email:l.email,full_name:l.full_name||l.email.split("@")[0],role:l.role,is_test_user:!1});if(r)throw r;await o(),v(!1),m({email:"",password:"",full_name:"",role:"viewer"}),j("User created successfully!")}catch(s){f("Failed to create user: "+s.message)}}async function G(s,a){try{const{error:r}=await c.from("profiles").update({role:a,updated_at:new Date().toISOString()}).eq("id",s);if(r)throw r;await o(),g(null),j("Role updated")}catch{f("Failed to update role")}}async function W(s){if(!b){_("Please select a resource");return}try{const{error:a}=await c.from("resources").update({user_id:s}).eq("id",b);if(a)throw a;await o(),N(null),w(""),j("Resource linked successfully!")}catch{f("Failed to link resource")}}function H(s,a){C({isOpen:!0,resourceId:s,resourceName:a})}async function J(){if(x.resourceId)try{const{error:s}=await c.from("resources").update({user_id:null}).eq("id",x.resourceId);if(s)throw s;C({isOpen:!1,resourceId:null,resourceName:null}),await o(),j("Resource unlinked")}catch{f("Failed to unlink resource")}}function V(s){return h.find(a=>a.value===s)||h[4]}function X(s){return y.find(a=>a.user_id===s)}function Y(){return y.filter(s=>!s.user_id)}const k=u.filter(s=>s.is_test_user).length;return R?I?e.jsx(ee,{message:"Loading users...",size:"large",fullPage:!0}):e.jsxs("div",{className:"users-page",children:[e.jsx("header",{className:"users-header",children:e.jsxs("div",{className:"header-content",children:[e.jsxs("div",{className:"header-title",children:[e.jsx(le,{size:28,strokeWidth:1.5}),e.jsxs("div",{children:[e.jsx("h1",{children:"Users"}),e.jsxs("p",{children:[u.length," user",u.length!==1?"s":""]})]})]}),e.jsxs("div",{className:"header-actions",children:[M&&e.jsxs("button",{onClick:A,className:`btn-toggle ${i?"active":""}`,children:[i?e.jsx(re,{size:16}):e.jsx(ne,{size:16}),i?"Hide Test":"Show Test"]}),e.jsx("button",{className:"btn-secondary",onClick:o,children:e.jsx(te,{size:16})}),e.jsxs("button",{className:"btn-primary",onClick:()=>v(!0),children:[e.jsx(S,{size:16}),"Add User"]})]})]})}),e.jsxs("div",{className:"users-content",children:[q&&e.jsxs("div",{className:"create-form-card",children:[e.jsx("h3",{children:"Create New User"}),e.jsxs("div",{className:"form-grid",children:[e.jsxs("div",{className:"form-field",children:[e.jsx("label",{children:"Email *"}),e.jsx("input",{type:"email",placeholder:"user@example.com",value:l.email,onChange:s=>m({...l,email:s.target.value})})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{children:"Password *"}),e.jsx("input",{type:"password",placeholder:"Secure password",value:l.password,onChange:s=>m({...l,password:s.target.value})})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{children:"Full Name"}),e.jsx("input",{type:"text",placeholder:"John Smith",value:l.full_name,onChange:s=>m({...l,full_name:s.target.value})})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{children:"Role"}),e.jsx("select",{value:l.role,onChange:s=>m({...l,role:s.target.value}),children:h.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]})]}),e.jsxs("div",{className:"form-actions",children:[e.jsxs("button",{className:"btn-primary",onClick:B,children:[e.jsx(S,{size:16})," Create User"]}),e.jsx("button",{className:"btn-secondary",onClick:()=>v(!1),children:"Cancel"})]})]}),i&&k>0&&e.jsxs("div",{className:"test-banner",children:[e.jsx(z,{size:16}),e.jsxs("span",{children:["Showing ",k," test user",k!==1?"s":""]})]}),e.jsx("div",{className:"table-card",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"User"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"Linked Resource"}),e.jsx("th",{children:"Role"}),e.jsx("th",{children:"Created"}),i&&e.jsx("th",{children:"Type"})]})}),e.jsx("tbody",{children:u.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:i?6:5,className:"empty-state",children:"No users found"})}):u.map(s=>{const a=V(s.role),r=s.is_test_user,d=X(s.id),K=s.id===F;return e.jsxs("tr",{className:r?"test-user-row":"",children:[e.jsx("td",{children:e.jsxs("div",{className:"user-cell",children:[e.jsx("div",{className:`user-avatar ${r?"test":""}`,children:(s.full_name||s.email||"U")[0].toUpperCase()}),e.jsxs("div",{className:"user-info",children:[e.jsx("span",{className:"user-name",children:s.full_name||"No name"}),K&&e.jsx("span",{className:"you-badge",children:"you"})]})]})}),e.jsx("td",{className:"email-cell",children:s.email}),e.jsx("td",{children:P===s.id?e.jsxs("div",{className:"link-form",children:[e.jsxs("select",{value:b,onChange:t=>w(t.target.value),children:[e.jsx("option",{value:"",children:"Select..."}),Y().map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsx("button",{className:"btn-icon success",onClick:()=>W(s.id),children:e.jsx(ie,{size:14})}),e.jsx("button",{className:"btn-icon",onClick:()=>{N(null),w("")},children:e.jsx(ce,{size:14})})]}):d?e.jsxs("div",{className:"linked-resource",children:[e.jsx(oe,{size:14}),e.jsx("span",{children:d.name}),e.jsx("button",{className:"btn-icon-small",onClick:()=>H(d.id,d.name),title:"Unlink",children:e.jsx(de,{size:12})})]}):e.jsx("button",{className:"link-button",onClick:()=>N(s.id),children:"Link resource"})}),e.jsx("td",{children:O===s.id?e.jsx("div",{className:"role-edit",children:e.jsx("select",{value:s.role,onChange:t=>G(s.id,t.target.value),autoFocus:!0,onBlur:()=>g(null),children:h.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))})}):e.jsxs("button",{className:"role-badge",style:{backgroundColor:a.color+"15",color:a.color},onClick:()=>g(s.id),children:[a.label,e.jsx(ue,{size:12})]})}),e.jsx("td",{className:"date-cell",children:s.created_at?new Date(s.created_at).toLocaleDateString("en-GB"):"-"}),i&&e.jsx("td",{children:r?e.jsxs("span",{className:"type-badge test",children:[e.jsx(z,{size:12})," Test"]}):e.jsx("span",{className:"type-badge real",children:"Real"})})]},s.id)})})]})}),e.jsxs("div",{className:"role-legend",children:[e.jsx("h4",{children:"Role Permissions"}),e.jsx("div",{className:"legend-grid",children:h.map(s=>e.jsxs("div",{className:"legend-item",children:[e.jsx("span",{className:"legend-dot",style:{backgroundColor:s.color}}),e.jsx("span",{className:"legend-label",style:{color:s.color},children:s.label}),e.jsxs("span",{className:"legend-desc",children:[s.value==="admin"&&"Full system access",s.value==="supplier_pm"&&"Full access + validates timesheets/expenses",s.value==="customer_pm"&&"Reviews deliverables, validates timesheets",s.value==="contributor"&&"Submits timesheets & expenses",s.value==="viewer"&&"Read-only dashboard access"]})]},s.value))})]})]}),e.jsx(se,{isOpen:x.isOpen,onClose:()=>C({isOpen:!1,resourceId:null,resourceName:null}),onConfirm:J,title:"Unlink Resource",message:e.jsxs(e.Fragment,{children:["Unlink ",e.jsx("strong",{children:x.resourceName})," from this user?"]}),confirmText:"Unlink",cancelText:"Cancel",type:"warning"})]}):e.jsx("div",{className:"users-page",children:e.jsxs("div",{className:"access-denied",children:[e.jsx(ae,{size:48}),e.jsx("h2",{children:"Access Denied"}),e.jsx("p",{children:"You don't have permission to manage users."})]})})}export{pe as default};
