import{f as Q,c as Z,s as c,j as e,L as ee}from"./index-B9FHEUBb.js";import{r}from"./vendor-react-BUTV5ZEl.js";import{C as se}from"./ConfirmDialog-OQf_RGQN.js";import{a3 as ae,q as le,a4 as re,x as ne,R as te,aj as R,aU as T,al as ie,c as ce,aV as oe,aW as de,a as ue}from"./vendor-icons-CWM4So-G.js";import"./vendor-supabase-6faYzd5A.js";function fe(){const[u,z]=r.useState([]),[U,I]=r.useState([]),[E,S]=r.useState(!0),[f,F]=r.useState("viewer"),[L,D]=r.useState(null),[O,g]=r.useState(!1),[P,v]=r.useState(null),[q,w]=r.useState(null),[N,b]=r.useState(""),[x,C]=r.useState({isOpen:!1,resourceId:null,resourceName:null}),{showTestUsers:i,toggleTestUsers:A,canToggleTestUsers:M}=Q(),{showSuccess:j,showError:p,showWarning:k}=Z(),[l,h]=r.useState({email:"",password:"",full_name:"",role:"viewer"}),m=[{value:"admin",label:"Admin",color:"#7c3aed"},{value:"supplier_pm",label:"Supplier PM",color:"#059669"},{value:"customer_pm",label:"Customer PM",color:"#d97706"},{value:"contributor",label:"Contributor",color:"#2563eb"},{value:"viewer",label:"Viewer",color:"#64748b"}];r.useEffect(()=>{W()},[]),r.useEffect(()=>{_&&o()},[f,i]);async function W(){const{data:{user:s}}=await c.auth.getUser();if(s){D(s.id);const{data:a}=await c.from("profiles").select("role").eq("id",s.id).single();a&&F(a.role)}}const _=f==="admin"||f==="supplier_pm";async function o(){try{S(!0);let s=c.from("profiles").select("*").order("created_at",{ascending:!1});i||(s=s.or("is_test_user.is.null,is_test_user.eq.false"));const{data:a,error:n}=await s;if(n)throw n;z(a||[]);const{data:d}=await c.from("resources").select("id, name, email, user_id").order("name");I(d||[])}catch{}finally{S(!1)}}async function $(){if(!l.email||!l.password){k("Email and password are required");return}if(l.password.length<8){k("Password must be at least 8 characters");return}try{const{data:{session:s}}=await c.auth.getSession(),a=await fetch("/api/create-user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:l.email,password:l.password,full_name:l.full_name||l.email.split("@")[0],role:l.role,adminToken:s?.access_token})}),n=await a.json();if(!a.ok)throw new Error(n.error||"Failed to create user");await o(),g(!1),h({email:"",password:"",full_name:"",role:"viewer"}),j("User created! They will need to set a secure password on first login.")}catch(s){p("Failed to create user: "+s.message)}}async function B(s,a){try{const{error:n}=await c.from("profiles").update({role:a,updated_at:new Date().toISOString()}).eq("id",s);if(n)throw n;await o(),v(null),j("Role updated")}catch{p("Failed to update role")}}async function J(s){if(!N){k("Please select a resource");return}try{const{error:a}=await c.from("resources").update({user_id:s}).eq("id",N);if(a)throw a;await o(),w(null),b(""),j("Resource linked successfully!")}catch{p("Failed to link resource")}}function V(s,a){C({isOpen:!0,resourceId:s,resourceName:a})}async function G(){if(x.resourceId)try{const{error:s}=await c.from("resources").update({user_id:null}).eq("id",x.resourceId);if(s)throw s;C({isOpen:!1,resourceId:null,resourceName:null}),await o(),j("Resource unlinked")}catch{p("Failed to unlink resource")}}function H(s){return m.find(a=>a.value===s)||m[4]}function X(s){return U.find(a=>a.user_id===s)}function Y(){return U.filter(s=>!s.user_id)}const y=u.filter(s=>s.is_test_user).length;return _?E?e.jsx(ee,{message:"Loading users...",size:"large",fullPage:!0}):e.jsxs("div",{className:"users-page",children:[e.jsx("header",{className:"users-header",children:e.jsxs("div",{className:"header-content",children:[e.jsxs("div",{className:"header-title",children:[e.jsx(le,{size:28,strokeWidth:1.5}),e.jsxs("div",{children:[e.jsx("h1",{children:"Users"}),e.jsxs("p",{children:[u.length," user",u.length!==1?"s":""]})]})]}),e.jsxs("div",{className:"header-actions",children:[M&&e.jsxs("button",{onClick:A,className:`btn-toggle ${i?"active":""}`,children:[i?e.jsx(re,{size:16}):e.jsx(ne,{size:16}),i?"Hide Test":"Show Test"]}),e.jsx("button",{className:"btn-secondary",onClick:o,children:e.jsx(te,{size:16})}),e.jsxs("button",{className:"btn-primary",onClick:()=>g(!0),children:[e.jsx(R,{size:16}),"Add User"]})]})]})}),e.jsxs("div",{className:"users-content",children:[O&&e.jsxs("div",{className:"create-form-card",children:[e.jsx("h3",{children:"Create New User"}),e.jsxs("div",{className:"form-grid",children:[e.jsxs("div",{className:"form-field",children:[e.jsx("label",{children:"Email *"}),e.jsx("input",{type:"email",placeholder:"user@example.com",value:l.email,onChange:s=>h({...l,email:s.target.value})})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{children:"Password *"}),e.jsx("input",{type:"password",placeholder:"Secure password",value:l.password,onChange:s=>h({...l,password:s.target.value})})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{children:"Full Name"}),e.jsx("input",{type:"text",placeholder:"John Smith",value:l.full_name,onChange:s=>h({...l,full_name:s.target.value})})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{children:"Role"}),e.jsx("select",{value:l.role,onChange:s=>h({...l,role:s.target.value}),children:m.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]})]}),e.jsxs("div",{className:"form-actions",children:[e.jsxs("button",{className:"btn-primary",onClick:$,children:[e.jsx(R,{size:16})," Create User"]}),e.jsx("button",{className:"btn-secondary",onClick:()=>g(!1),children:"Cancel"})]})]}),i&&y>0&&e.jsxs("div",{className:"test-banner",children:[e.jsx(T,{size:16}),e.jsxs("span",{children:["Showing ",y," test user",y!==1?"s":""]})]}),e.jsx("div",{className:"table-card",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"User"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"Linked Resource"}),e.jsx("th",{children:"Role"}),e.jsx("th",{children:"Created"}),i&&e.jsx("th",{children:"Type"})]})}),e.jsx("tbody",{children:u.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:i?6:5,className:"empty-state",children:"No users found"})}):u.map(s=>{const a=H(s.role),n=s.is_test_user,d=X(s.id),K=s.id===L;return e.jsxs("tr",{className:n?"test-user-row":"",children:[e.jsx("td",{children:e.jsxs("div",{className:"user-cell",children:[e.jsx("div",{className:`user-avatar ${n?"test":""}`,children:(s.full_name||s.email||"U")[0].toUpperCase()}),e.jsxs("div",{className:"user-info",children:[e.jsx("span",{className:"user-name",children:s.full_name||"No name"}),K&&e.jsx("span",{className:"you-badge",children:"you"})]})]})}),e.jsx("td",{className:"email-cell",children:s.email}),e.jsx("td",{children:q===s.id?e.jsxs("div",{className:"link-form",children:[e.jsxs("select",{value:N,onChange:t=>b(t.target.value),children:[e.jsx("option",{value:"",children:"Select..."}),Y().map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsx("button",{className:"btn-icon success",onClick:()=>J(s.id),children:e.jsx(ie,{size:14})}),e.jsx("button",{className:"btn-icon",onClick:()=>{w(null),b("")},children:e.jsx(ce,{size:14})})]}):d?e.jsxs("div",{className:"linked-resource",children:[e.jsx(oe,{size:14}),e.jsx("span",{children:d.name}),e.jsx("button",{className:"btn-icon-small",onClick:()=>V(d.id,d.name),title:"Unlink",children:e.jsx(de,{size:12})})]}):e.jsx("button",{className:"link-button",onClick:()=>w(s.id),children:"Link resource"})}),e.jsx("td",{children:P===s.id?e.jsx("div",{className:"role-edit",children:e.jsx("select",{value:s.role,onChange:t=>B(s.id,t.target.value),autoFocus:!0,onBlur:()=>v(null),children:m.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))})}):e.jsxs("button",{className:"role-badge",style:{backgroundColor:a.color+"15",color:a.color},onClick:()=>v(s.id),children:[a.label,e.jsx(ue,{size:12})]})}),e.jsx("td",{className:"date-cell",children:s.created_at?new Date(s.created_at).toLocaleDateString("en-GB"):"-"}),i&&e.jsx("td",{children:n?e.jsxs("span",{className:"type-badge test",children:[e.jsx(T,{size:12})," Test"]}):e.jsx("span",{className:"type-badge real",children:"Real"})})]},s.id)})})]})}),e.jsxs("div",{className:"role-legend",children:[e.jsx("h4",{children:"Role Permissions"}),e.jsx("div",{className:"legend-grid",children:m.map(s=>e.jsxs("div",{className:"legend-item",children:[e.jsx("span",{className:"legend-dot",style:{backgroundColor:s.color}}),e.jsx("span",{className:"legend-label",style:{color:s.color},children:s.label}),e.jsxs("span",{className:"legend-desc",children:[s.value==="admin"&&"Full system access",s.value==="supplier_pm"&&"Full access + validates timesheets/expenses",s.value==="customer_pm"&&"Reviews deliverables, validates timesheets",s.value==="contributor"&&"Submits timesheets & expenses",s.value==="viewer"&&"Read-only dashboard access"]})]},s.value))})]})]}),e.jsx(se,{isOpen:x.isOpen,onClose:()=>C({isOpen:!1,resourceId:null,resourceName:null}),onConfirm:G,title:"Unlink Resource",message:e.jsxs(e.Fragment,{children:["Unlink ",e.jsx("strong",{children:x.resourceName})," from this user?"]}),confirmText:"Unlink",cancelText:"Cancel",type:"warning"})]}):e.jsx("div",{className:"users-page",children:e.jsxs("div",{className:"access-denied",children:[e.jsx(ae,{size:48}),e.jsx("h2",{children:"Access Denied"}),e.jsx("p",{children:"You don't have permission to manage users."})]})})}export{fe as default};
