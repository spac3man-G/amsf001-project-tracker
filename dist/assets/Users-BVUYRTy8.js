import{e as X,b as Y,s as c,j as e,L as K}from"./index-CXY_8y1M.js";import{r as t}from"./vendor-react-B1g8b4mG.js";import{aC as Q,m as Z,a4 as ee,a5 as se,R as ae,a7 as k,aD as R,a9 as le,a as re,aE as te,aF as ie,aB as ne}from"./vendor-icons-BfsEacNp.js";import"./vendor-supabase-DSZ6Ejbd.js";function he(){const[d,S]=t.useState([]),[y,z]=t.useState([]),[E,C]=t.useState(!0),[f,T]=t.useState("viewer"),[F,L]=t.useState(null),[D,p]=t.useState(!1),[I,v]=t.useState(null),[q,g]=t.useState(null),[b,w]=t.useState(""),{showTestUsers:n,toggleTestUsers:P,canToggleTestUsers:A}=X(),{showSuccess:x,showError:j,showWarning:U}=Y(),[l,u]=t.useState({email:"",password:"",full_name:"",role:"viewer"}),h=[{value:"admin",label:"Admin",color:"#7c3aed"},{value:"supplier_pm",label:"Supplier PM",color:"#059669"},{value:"customer_pm",label:"Customer PM",color:"#d97706"},{value:"contributor",label:"Contributor",color:"#2563eb"},{value:"viewer",label:"Viewer",color:"#64748b"}];t.useEffect(()=>{B()},[]),t.useEffect(()=>{_&&o()},[f,n]);async function B(){const{data:{user:s}}=await c.auth.getUser();if(s){L(s.id);const{data:a}=await c.from("profiles").select("role").eq("id",s.id).single();a&&T(a.role)}}const _=f==="admin"||f==="supplier_pm";async function o(){try{C(!0);let s=c.from("profiles").select("*").order("created_at",{ascending:!1});n||(s=s.or("is_test_user.is.null,is_test_user.eq.false"));const{data:a,error:r}=await s;if(r)throw r;S(a||[]);const{data:m}=await c.from("resources").select("id, name, email, user_id").order("name");z(m||[])}catch{}finally{C(!1)}}async function M(){if(!l.email||!l.password){U("Email and password are required");return}try{const{data:s,error:a}=await c.auth.admin.createUser({email:l.email,password:l.password,email_confirm:!0});if(a)throw a;const{error:r}=await c.from("profiles").insert({id:s.user.id,email:l.email,full_name:l.full_name||l.email.split("@")[0],role:l.role,is_test_user:!1});if(r)throw r;await o(),p(!1),u({email:"",password:"",full_name:"",role:"viewer"}),x("User created successfully!")}catch(s){j("Failed to create user: "+s.message)}}async function $(s,a){try{const{error:r}=await c.from("profiles").update({role:a,updated_at:new Date().toISOString()}).eq("id",s);if(r)throw r;await o(),v(null),x("Role updated")}catch{j("Failed to update role")}}async function O(s){if(!b){U("Please select a resource");return}try{const{error:a}=await c.from("resources").update({user_id:s}).eq("id",b);if(a)throw a;await o(),g(null),w(""),x("Resource linked successfully!")}catch{j("Failed to link resource")}}async function W(s){if(confirm("Unlink this resource from the user?"))try{const{error:a}=await c.from("resources").update({user_id:null}).eq("id",s);if(a)throw a;await o(),x("Resource unlinked")}catch{j("Failed to unlink resource")}}function G(s){return h.find(a=>a.value===s)||h[4]}function H(s){return y.find(a=>a.user_id===s)}function J(){return y.filter(s=>!s.user_id)}const N=d.filter(s=>s.is_test_user).length;return _?E?e.jsx(K,{message:"Loading users...",size:"large",fullPage:!0}):e.jsxs("div",{className:"users-page",children:[e.jsx("header",{className:"users-header",children:e.jsxs("div",{className:"header-content",children:[e.jsxs("div",{className:"header-title",children:[e.jsx(Z,{size:28,strokeWidth:1.5}),e.jsxs("div",{children:[e.jsx("h1",{children:"Users"}),e.jsxs("p",{children:[d.length," user",d.length!==1?"s":""]})]})]}),e.jsxs("div",{className:"header-actions",children:[A&&e.jsxs("button",{onClick:P,className:`btn-toggle ${n?"active":""}`,children:[n?e.jsx(ee,{size:16}):e.jsx(se,{size:16}),n?"Hide Test":"Show Test"]}),e.jsx("button",{className:"btn-secondary",onClick:o,children:e.jsx(ae,{size:16})}),e.jsxs("button",{className:"btn-primary",onClick:()=>p(!0),children:[e.jsx(k,{size:16}),"Add User"]})]})]})}),e.jsxs("div",{className:"users-content",children:[D&&e.jsxs("div",{className:"create-form-card",children:[e.jsx("h3",{children:"Create New User"}),e.jsxs("div",{className:"form-grid",children:[e.jsxs("div",{className:"form-field",children:[e.jsx("label",{children:"Email *"}),e.jsx("input",{type:"email",placeholder:"user@example.com",value:l.email,onChange:s=>u({...l,email:s.target.value})})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{children:"Password *"}),e.jsx("input",{type:"password",placeholder:"Secure password",value:l.password,onChange:s=>u({...l,password:s.target.value})})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{children:"Full Name"}),e.jsx("input",{type:"text",placeholder:"John Smith",value:l.full_name,onChange:s=>u({...l,full_name:s.target.value})})]}),e.jsxs("div",{className:"form-field",children:[e.jsx("label",{children:"Role"}),e.jsx("select",{value:l.role,onChange:s=>u({...l,role:s.target.value}),children:h.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]})]}),e.jsxs("div",{className:"form-actions",children:[e.jsxs("button",{className:"btn-primary",onClick:M,children:[e.jsx(k,{size:16})," Create User"]}),e.jsx("button",{className:"btn-secondary",onClick:()=>p(!1),children:"Cancel"})]})]}),n&&N>0&&e.jsxs("div",{className:"test-banner",children:[e.jsx(R,{size:16}),e.jsxs("span",{children:["Showing ",N," test user",N!==1?"s":""]})]}),e.jsx("div",{className:"table-card",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"User"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"Linked Resource"}),e.jsx("th",{children:"Role"}),e.jsx("th",{children:"Created"}),n&&e.jsx("th",{children:"Type"})]})}),e.jsx("tbody",{children:d.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:n?6:5,className:"empty-state",children:"No users found"})}):d.map(s=>{const a=G(s.role),r=s.is_test_user,m=H(s.id),V=s.id===F;return e.jsxs("tr",{className:r?"test-user-row":"",children:[e.jsx("td",{children:e.jsxs("div",{className:"user-cell",children:[e.jsx("div",{className:`user-avatar ${r?"test":""}`,children:(s.full_name||s.email||"U")[0].toUpperCase()}),e.jsxs("div",{className:"user-info",children:[e.jsx("span",{className:"user-name",children:s.full_name||"No name"}),V&&e.jsx("span",{className:"you-badge",children:"you"})]})]})}),e.jsx("td",{className:"email-cell",children:s.email}),e.jsx("td",{children:q===s.id?e.jsxs("div",{className:"link-form",children:[e.jsxs("select",{value:b,onChange:i=>w(i.target.value),children:[e.jsx("option",{value:"",children:"Select..."}),J().map(i=>e.jsx("option",{value:i.id,children:i.name},i.id))]}),e.jsx("button",{className:"btn-icon success",onClick:()=>O(s.id),children:e.jsx(le,{size:14})}),e.jsx("button",{className:"btn-icon",onClick:()=>{g(null),w("")},children:e.jsx(re,{size:14})})]}):m?e.jsxs("div",{className:"linked-resource",children:[e.jsx(te,{size:14}),e.jsx("span",{children:m.name}),e.jsx("button",{className:"btn-icon-small",onClick:()=>W(m.id),title:"Unlink",children:e.jsx(ie,{size:12})})]}):e.jsx("button",{className:"link-button",onClick:()=>g(s.id),children:"Link resource"})}),e.jsx("td",{children:I===s.id?e.jsx("div",{className:"role-edit",children:e.jsx("select",{value:s.role,onChange:i=>$(s.id,i.target.value),autoFocus:!0,onBlur:()=>v(null),children:h.map(i=>e.jsx("option",{value:i.value,children:i.label},i.value))})}):e.jsxs("button",{className:"role-badge",style:{backgroundColor:a.color+"15",color:a.color},onClick:()=>v(s.id),children:[a.label,e.jsx(ne,{size:12})]})}),e.jsx("td",{className:"date-cell",children:s.created_at?new Date(s.created_at).toLocaleDateString("en-GB"):"-"}),n&&e.jsx("td",{children:r?e.jsxs("span",{className:"type-badge test",children:[e.jsx(R,{size:12})," Test"]}):e.jsx("span",{className:"type-badge real",children:"Real"})})]},s.id)})})]})}),e.jsxs("div",{className:"role-legend",children:[e.jsx("h4",{children:"Role Permissions"}),e.jsx("div",{className:"legend-grid",children:h.map(s=>e.jsxs("div",{className:"legend-item",children:[e.jsx("span",{className:"legend-dot",style:{backgroundColor:s.color}}),e.jsx("span",{className:"legend-label",style:{color:s.color},children:s.label}),e.jsxs("span",{className:"legend-desc",children:[s.value==="admin"&&"Full system access",s.value==="supplier_pm"&&"Full access + validates timesheets/expenses",s.value==="customer_pm"&&"Reviews deliverables, validates timesheets",s.value==="contributor"&&"Submits timesheets & expenses",s.value==="viewer"&&"Read-only dashboard access"]})]},s.value))})]})]})]}):e.jsx("div",{className:"users-page",children:e.jsxs("div",{className:"access-denied",children:[e.jsx(Q,{size:48}),e.jsx("h2",{children:"Access Denied"}),e.jsx("p",{children:"You don't have permission to manage users."})]})})}export{he as default};
