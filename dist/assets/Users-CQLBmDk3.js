import{c as U,r as n,n as se,d as re,s as o,j as e,L as te,E as le,R as ie,X as N,T as ne}from"./index-CspTly-R.js";import{S as ae}from"./shield-C-1jLL9q.js";import{E as oe}from"./eye-off-hoBthlSK.js";import{E as ce}from"./eye-B_u6uLs8.js";import{P as I}from"./plus-DwqEgAX3.js";import{S as L}from"./save-CA5ETuwq.js";import{P as de}from"./pen-opG0b6Iw.js";/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const me=U("Link",[["path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71",key:"1cjeqo"}],["path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71",key:"19qd67"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const M=U("TestTube",[["path",{d:"M14.5 2v17.5c0 1.4-1.1 2.5-2.5 2.5h0c-1.4 0-2.5-1.1-2.5-2.5V2",key:"187lwq"}],["path",{d:"M8.5 2h7",key:"csnxdl"}],["path",{d:"M14.5 16h-5",key:"1ox875"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=U("Unlink",[["path",{d:"m18.84 12.25 1.72-1.71h-.02a5.004 5.004 0 0 0-.12-7.07 5.006 5.006 0 0 0-6.95 0l-1.72 1.71",key:"yqzxt4"}],["path",{d:"m5.17 11.75-1.71 1.71a5.004 5.004 0 0 0 .12 7.07 5.006 5.006 0 0 0 6.95 0l1.71-1.71",key:"4qinb0"}],["line",{x1:"8",x2:"8",y1:"2",y2:"5",key:"1041cp"}],["line",{x1:"2",x2:"5",y1:"8",y2:"8",key:"14m1p5"}],["line",{x1:"16",x2:"16",y1:"19",y2:"22",key:"rzdirn"}],["line",{x1:"19",x2:"22",y1:"16",y2:"16",key:"ox905f"}]]);function ve(){const[d,W]=n.useState([]),[z,q]=n.useState([]),[A,_]=n.useState(!0),[g,D]=n.useState("viewer"),[R,F]=n.useState(null),[P,y]=n.useState(!1),[E,b]=n.useState(null),[v,T]=n.useState({}),[B,w]=n.useState(null),[k,C]=n.useState(""),{showTestUsers:i,toggleTestUsers:V,canToggleTestUsers:O,testUserIds:he}=se(),{showSuccess:x,showError:u,showWarning:p}=re(),[l,h]=n.useState({email:"",password:"",full_name:"",role:"viewer"}),j=[{value:"admin",label:"Admin",color:"#7c3aed"},{value:"supplier_pm",label:"Supplier PM",color:"#059669"},{value:"customer_pm",label:"Customer PM",color:"#d97706"},{value:"contributor",label:"Contributor",color:"#2563eb"},{value:"viewer",label:"Viewer",color:"#64748b"}];n.useEffect(()=>{G()},[]),n.useEffect(()=>{c&&m()},[g,i]);async function G(){const{data:{user:s}}=await o.auth.getUser();if(s){F(s.id);const{data:r}=await o.from("profiles").select("role").eq("id",s.id).single();r&&D(r.role)}}const c=g==="admin"||g==="supplier_pm";async function m(){try{_(!0);let s=o.from("profiles").select("*").order("created_at",{ascending:!1});i||(s=s.or("is_test_user.is.null,is_test_user.eq.false"));const{data:r,error:t}=await s;if(t)throw t;W(r||[]);const{data:f}=await o.from("resources").select("id, name, email, user_id").order("name");q(f||[])}catch(s){console.error("Error fetching users:",s)}finally{_(!1)}}async function H(){if(!l.email||!l.password){p("Email and password are required");return}try{const{data:s,error:r}=await o.auth.admin.createUser({email:l.email,password:l.password,email_confirm:!0});if(r)throw r;const{error:t}=await o.from("profiles").insert({id:s.user.id,email:l.email,full_name:l.full_name||l.email.split("@")[0],role:l.role,is_test_user:!1});if(t)throw t;await m(),y(!1),h({email:"",password:"",full_name:"",role:"viewer"}),x("User created successfully!")}catch(s){console.error("Error creating user:",s),u("Failed to create user: "+s.message)}}async function J(s,r){try{const{error:t}=await o.from("profiles").update({role:r,updated_at:new Date().toISOString()}).eq("id",s);if(t)throw t;await m(),b(null)}catch(t){console.error("Error updating role:",t),u("Failed to update role")}}async function Y(s){if(s===R){p("You cannot delete your own account");return}const r=d.find(t=>t.id===s);if(r!=null&&r.is_test_user&&!i){p("Cannot delete test users");return}if(confirm("Delete this user? This cannot be undone."))try{const{error:t}=await o.from("profiles").delete().eq("id",s);if(t)throw t;await m(),x("User deleted")}catch(t){console.error("Error deleting user:",t),u("Failed to delete user")}}async function X(s){if(!k){p("Please select a resource");return}try{const{error:r}=await o.from("resources").update({user_id:s}).eq("id",k);if(r)throw r;await m(),w(null),C(""),x("Resource linked successfully!")}catch(r){console.error("Error linking resource:",r),u("Failed to link resource")}}async function $(s){if(confirm("Unlink this resource from the user?"))try{const{error:r}=await o.from("resources").update({user_id:null}).eq("id",s);if(r)throw r;await m(),x("Resource unlinked")}catch(r){console.error("Error unlinking resource:",r),u("Failed to unlink resource")}}function K(s){return j.find(r=>r.value===s)||j[4]}function Q(s){return z.find(r=>r.user_id===s)}function Z(){return z.filter(s=>!s.user_id)}const ee=d.filter(s=>s.is_test_user).length;return c?A?e.jsx(te,{message:"Loading users...",size:"large",fullPage:!0}):e.jsxs("div",{className:"page-container",children:[e.jsxs("div",{className:"page-header",children:[e.jsxs("div",{className:"page-title",children:[e.jsx(le,{size:28}),e.jsxs("div",{children:[e.jsx("h1",{children:"User Management"}),e.jsx("p",{children:"Manage user accounts and permissions"})]})]}),e.jsxs("button",{className:"btn btn-secondary",onClick:m,children:[e.jsx(ie,{size:18})," Refresh"]})]}),O&&e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem",backgroundColor:i?"#fef3c7":"#f8fafc",borderLeft:i?"4px solid #f59e0b":"4px solid #e2e8f0",display:"flex",alignItems:"center",justifyContent:"space-between",padding:"1rem 1.5rem"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem"},children:[e.jsx(M,{size:20,style:{color:i?"#d97706":"#64748b"}}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:"500",color:i?"#92400e":"#374151"},children:i?"Test Users Visible":"Test Users Hidden"}),e.jsx("div",{style:{fontSize:"0.85rem",color:"#64748b"},children:i?`Showing ${ee} test user(s) and their content`:"Test users and their content are hidden from all views"})]})]}),e.jsxs("button",{onClick:V,className:"btn",style:{backgroundColor:i?"#fbbf24":"#e2e8f0",color:i?"#78350f":"#374151",display:"flex",alignItems:"center",gap:"0.5rem"},children:[i?e.jsx(oe,{size:16}):e.jsx(ce,{size:16}),i?"Hide Test Users":"Show Test Users"]})]}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem"},children:[e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-label",children:"TOTAL USERS"}),e.jsx("div",{className:"stat-value",children:d.length})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-label",children:"ADMINS"}),e.jsx("div",{className:"stat-value",style:{color:"#7c3aed"},children:d.filter(s=>s.role==="admin").length})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-label",children:"PROJECT MANAGERS"}),e.jsx("div",{className:"stat-value",style:{color:"#059669"},children:d.filter(s=>s.role==="supplier_pm"||s.role==="customer_pm").length})]})]}),c&&e.jsx("div",{className:"card",style:{marginBottom:"1.5rem"},children:P?e.jsxs("div",{children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Create New User Account"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:"1rem",marginBottom:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Email *"}),e.jsx("input",{type:"email",className:"form-input",placeholder:"user@example.com",value:l.email,onChange:s=>h({...l,email:s.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Password *"}),e.jsx("input",{type:"password",className:"form-input",placeholder:"Secure password",value:l.password,onChange:s=>h({...l,password:s.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Full Name"}),e.jsx("input",{type:"text",className:"form-input",placeholder:"John Smith",value:l.full_name,onChange:s=>h({...l,full_name:s.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Role"}),e.jsx("select",{className:"form-input",value:l.role,onChange:s=>h({...l,role:s.target.value}),children:j.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]})]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsxs("button",{className:"btn btn-primary",onClick:H,children:[e.jsx(I,{size:16})," Create User"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:()=>y(!1),children:[e.jsx(N,{size:16})," Cancel"]})]})]}):e.jsxs("button",{className:"btn btn-primary",onClick:()=>y(!0),children:[e.jsx(I,{size:18})," Create User Account"]})}),e.jsx("div",{className:"card",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"User"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"Linked Resource"}),e.jsx("th",{children:"Role"}),e.jsx("th",{children:"Created"}),i&&e.jsx("th",{children:"Type"}),c&&e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:d.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:c?7:6,style:{textAlign:"center",padding:"2rem",color:"#64748b"},children:"No users found"})}):d.map(s=>{const r=K(s.role),t=s.is_test_user,f=Q(s.id),S=s.id===R;return e.jsxs("tr",{style:{backgroundColor:t?"#fffbeb":"transparent"},children:[e.jsx("td",{children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem"},children:[e.jsx("div",{style:{width:"36px",height:"36px",borderRadius:"50%",backgroundColor:t?"#fbbf24":"#10b981",display:"flex",alignItems:"center",justifyContent:"center",color:"white",fontWeight:"600",fontSize:"0.85rem"},children:(s.full_name||s.email||"U")[0].toUpperCase()}),e.jsxs("div",{children:[e.jsx("span",{style:{fontWeight:"500"},children:s.full_name||"No name"}),S&&e.jsx("span",{style:{marginLeft:"0.5rem",fontSize:"0.75rem",color:"#10b981",fontWeight:"600"},children:"(you)"})]})]})}),e.jsx("td",{style:{color:"#64748b"},children:s.email}),e.jsx("td",{children:B===s.id?e.jsxs("div",{style:{display:"flex",gap:"0.5rem",alignItems:"center"},children:[e.jsxs("select",{className:"form-input",value:k,onChange:a=>C(a.target.value),style:{width:"150px",fontSize:"0.85rem"},children:[e.jsx("option",{value:"",children:"Select resource..."}),Z().map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]}),e.jsx("button",{className:"btn-icon btn-success",onClick:()=>X(s.id),title:"Link",children:e.jsx(L,{size:14})}),e.jsx("button",{className:"btn-icon btn-secondary",onClick:()=>{w(null),C("")},title:"Cancel",children:e.jsx(N,{size:14})})]}):f?e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(me,{size:14,style:{color:"#10b981"}}),e.jsx("span",{style:{color:"#10b981",fontWeight:"500"},children:f.name}),c&&e.jsx("button",{className:"btn-icon",onClick:()=>$(f.id),title:"Unlink resource",style:{padding:"0.25rem"},children:e.jsx(ue,{size:12})})]}):e.jsxs("span",{style:{color:"#9ca3af",fontSize:"0.85rem"},children:["Not linked",c&&e.jsx("button",{onClick:()=>w(s.id),style:{marginLeft:"0.5rem",background:"none",border:"none",color:"#3b82f6",cursor:"pointer",fontSize:"0.8rem",textDecoration:"underline"},children:"Link"})]})}),e.jsx("td",{children:E===s.id?e.jsx("select",{className:"form-input",value:v.role,onChange:a=>T({...v,role:a.target.value}),style:{width:"140px"},children:j.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))}):e.jsxs("span",{style:{padding:"0.25rem 0.75rem",backgroundColor:r.color+"20",color:r.color,borderRadius:"4px",fontSize:"0.85rem",fontWeight:"500"},children:[r.label,S&&" (you)"]})}),e.jsx("td",{style:{color:"#64748b",fontSize:"0.9rem"},children:s.created_at?new Date(s.created_at).toLocaleDateString("en-GB"):"-"}),i&&e.jsx("td",{children:t?e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",backgroundColor:"#fef3c7",color:"#92400e",borderRadius:"4px",fontSize:"0.8rem",fontWeight:"500"},children:[e.jsx(M,{size:12})," Test"]}):e.jsx("span",{style:{color:"#64748b",fontSize:"0.85rem"},children:"Real"})}),c&&e.jsx("td",{children:E===s.id?e.jsxs("div",{style:{display:"flex",gap:"0.25rem"},children:[e.jsx("button",{className:"btn-icon btn-success",onClick:()=>J(s.id,v.role),title:"Save",children:e.jsx(L,{size:16})}),e.jsx("button",{className:"btn-icon btn-secondary",onClick:()=>b(null),title:"Cancel",children:e.jsx(N,{size:16})})]}):e.jsxs("div",{style:{display:"flex",gap:"0.25rem"},children:[e.jsx("button",{className:"btn-icon",onClick:()=>{b(s.id),T({role:s.role})},title:"Edit Role",children:e.jsx(de,{size:16})}),!t&&!S&&e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>Y(s.id),title:"Delete",children:e.jsx(ne,{size:16})})]})})]},s.id)})})]})}),e.jsxs("div",{className:"card",style:{marginTop:"1.5rem",backgroundColor:"#f8fafc"},children:[e.jsx("h4",{style:{marginBottom:"1rem"},children:"Role Descriptions"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:"1rem"},children:[e.jsxs("div",{children:[e.jsx("span",{style:{fontWeight:"600",color:"#7c3aed"},children:"Admin"}),e.jsx("p",{style:{fontSize:"0.85rem",color:"#64748b",margin:"0.25rem 0 0 0"},children:"Full system access. No workflow notifications."})]}),e.jsxs("div",{children:[e.jsx("span",{style:{fontWeight:"600",color:"#059669"},children:"Supplier PM"}),e.jsx("p",{style:{fontSize:"0.85rem",color:"#64748b",margin:"0.25rem 0 0 0"},children:"Full system access + workflow participant. Validates timesheets & expenses."})]}),e.jsxs("div",{children:[e.jsx("span",{style:{fontWeight:"600",color:"#d97706"},children:"Customer PM"}),e.jsx("p",{style:{fontSize:"0.85rem",color:"#64748b",margin:"0.25rem 0 0 0"},children:"Workflow participant. Validates timesheets, expenses & reviews deliverables."})]}),e.jsxs("div",{children:[e.jsx("span",{style:{fontWeight:"600",color:"#2563eb"},children:"Contributor"}),e.jsx("p",{style:{fontSize:"0.85rem",color:"#64748b",margin:"0.25rem 0 0 0"},children:"Submits timesheets & expenses. Gets rejection notifications."})]}),e.jsxs("div",{children:[e.jsx("span",{style:{fontWeight:"600",color:"#64748b"},children:"Viewer"}),e.jsx("p",{style:{fontSize:"0.85rem",color:"#64748b",margin:"0.25rem 0 0 0"},children:"Read-only access to dashboards and reports."})]})]})]})]}):e.jsx("div",{className:"page-container",children:e.jsxs("div",{className:"card",style:{textAlign:"center",padding:"3rem"},children:[e.jsx(ae,{size:48,style:{color:"#ef4444",marginBottom:"1rem"}}),e.jsx("h2",{children:"Access Denied"}),e.jsx("p",{children:"You don't have permission to manage users."})]})})}export{ve as default};
