import{f as ee,b as se,s as o,j as e,L as re}from"./index-DZjyoUhu.js";import{r as n}from"./vendor-react-JFEV0ROX.js";import{as as te,n as le,R as ie,at as E,O as ne,Q as ae,W as I,a as k,Z as L,au as oe,av as ce,Y as de,T as me}from"./vendor-icons-CiBQmrAI.js";import"./vendor-supabase-DgEUAXvv.js";function je(){const[d,W]=n.useState([]),[U,A]=n.useState([]),[D,_]=n.useState(!0),[g,F]=n.useState("viewer"),[z,P]=n.useState(null),[M,b]=n.useState(!1),[R,y]=n.useState(null),[v,T]=n.useState({}),[q,w]=n.useState(null),[C,N]=n.useState(""),{showTestUsers:i,toggleTestUsers:B,canToggleTestUsers:O,testUserIds:ue}=ee(),{showSuccess:x,showError:u,showWarning:p}=se(),[l,h]=n.useState({email:"",password:"",full_name:"",role:"viewer"}),j=[{value:"admin",label:"Admin",color:"#7c3aed"},{value:"supplier_pm",label:"Supplier PM",color:"#059669"},{value:"customer_pm",label:"Customer PM",color:"#d97706"},{value:"contributor",label:"Contributor",color:"#2563eb"},{value:"viewer",label:"Viewer",color:"#64748b"}];n.useEffect(()=>{V()},[]),n.useEffect(()=>{c&&m()},[g,i]);async function V(){const{data:{user:s}}=await o.auth.getUser();if(s){P(s.id);const{data:r}=await o.from("profiles").select("role").eq("id",s.id).single();r&&F(r.role)}}const c=g==="admin"||g==="supplier_pm";async function m(){try{_(!0);let s=o.from("profiles").select("*").order("created_at",{ascending:!1});i||(s=s.or("is_test_user.is.null,is_test_user.eq.false"));const{data:r,error:t}=await s;if(t)throw t;W(r||[]);const{data:f}=await o.from("resources").select("id, name, email, user_id").order("name");A(f||[])}catch{}finally{_(!1)}}async function G(){if(!l.email||!l.password){p("Email and password are required");return}try{const{data:s,error:r}=await o.auth.admin.createUser({email:l.email,password:l.password,email_confirm:!0});if(r)throw r;const{error:t}=await o.from("profiles").insert({id:s.user.id,email:l.email,full_name:l.full_name||l.email.split("@")[0],role:l.role,is_test_user:!1});if(t)throw t;await m(),b(!1),h({email:"",password:"",full_name:"",role:"viewer"}),x("User created successfully!")}catch(s){u("Failed to create user: "+s.message)}}async function Y(s,r){try{const{error:t}=await o.from("profiles").update({role:r,updated_at:new Date().toISOString()}).eq("id",s);if(t)throw t;await m(),y(null)}catch{u("Failed to update role")}}async function H(s){if(s===z){p("You cannot delete your own account");return}if(d.find(t=>t.id===s)?.is_test_user&&!i){p("Cannot delete test users");return}if(confirm("Delete this user? This cannot be undone."))try{const{error:t}=await o.from("profiles").delete().eq("id",s);if(t)throw t;await m(),x("User deleted")}catch{u("Failed to delete user")}}async function J(s){if(!C){p("Please select a resource");return}try{const{error:r}=await o.from("resources").update({user_id:s}).eq("id",C);if(r)throw r;await m(),w(null),N(""),x("Resource linked successfully!")}catch{u("Failed to link resource")}}async function Q(s){if(confirm("Unlink this resource from the user?"))try{const{error:r}=await o.from("resources").update({user_id:null}).eq("id",s);if(r)throw r;await m(),x("Resource unlinked")}catch{u("Failed to unlink resource")}}function X(s){return j.find(r=>r.value===s)||j[4]}function Z(s){return U.find(r=>r.user_id===s)}function $(){return U.filter(s=>!s.user_id)}const K=d.filter(s=>s.is_test_user).length;return c?D?e.jsx(re,{message:"Loading users...",size:"large",fullPage:!0}):e.jsxs("div",{className:"page-container",children:[e.jsxs("div",{className:"page-header",children:[e.jsxs("div",{className:"page-title",children:[e.jsx(le,{size:28}),e.jsxs("div",{children:[e.jsx("h1",{children:"User Management"}),e.jsx("p",{children:"Manage user accounts and permissions"})]})]}),e.jsxs("button",{className:"btn btn-secondary",onClick:m,children:[e.jsx(ie,{size:18})," Refresh"]})]}),O&&e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem",backgroundColor:i?"#fef3c7":"#f8fafc",borderLeft:i?"4px solid #f59e0b":"4px solid #e2e8f0",display:"flex",alignItems:"center",justifyContent:"space-between",padding:"1rem 1.5rem"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem"},children:[e.jsx(E,{size:20,style:{color:i?"#d97706":"#64748b"}}),e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:"500",color:i?"#92400e":"#374151"},children:i?"Test Users Visible":"Test Users Hidden"}),e.jsx("div",{style:{fontSize:"0.85rem",color:"#64748b"},children:i?`Showing ${K} test user(s) and their content`:"Test users and their content are hidden from all views"})]})]}),e.jsxs("button",{onClick:B,className:"btn",style:{backgroundColor:i?"#fbbf24":"#e2e8f0",color:i?"#78350f":"#374151",display:"flex",alignItems:"center",gap:"0.5rem"},children:[i?e.jsx(ne,{size:16}):e.jsx(ae,{size:16}),i?"Hide Test Users":"Show Test Users"]})]}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem"},children:[e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-label",children:"TOTAL USERS"}),e.jsx("div",{className:"stat-value",children:d.length})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-label",children:"ADMINS"}),e.jsx("div",{className:"stat-value",style:{color:"#7c3aed"},children:d.filter(s=>s.role==="admin").length})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-label",children:"PROJECT MANAGERS"}),e.jsx("div",{className:"stat-value",style:{color:"#059669"},children:d.filter(s=>s.role==="supplier_pm"||s.role==="customer_pm").length})]})]}),c&&e.jsx("div",{className:"card",style:{marginBottom:"1.5rem"},children:M?e.jsxs("div",{children:[e.jsx("h3",{style:{marginBottom:"1rem"},children:"Create New User Account"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:"1rem",marginBottom:"1rem"},children:[e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Email *"}),e.jsx("input",{type:"email",className:"form-input",placeholder:"user@example.com",value:l.email,onChange:s=>h({...l,email:s.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Password *"}),e.jsx("input",{type:"password",className:"form-input",placeholder:"Secure password",value:l.password,onChange:s=>h({...l,password:s.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Full Name"}),e.jsx("input",{type:"text",className:"form-input",placeholder:"John Smith",value:l.full_name,onChange:s=>h({...l,full_name:s.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",children:"Role"}),e.jsx("select",{className:"form-input",value:l.role,onChange:s=>h({...l,role:s.target.value}),children:j.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]})]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsxs("button",{className:"btn btn-primary",onClick:G,children:[e.jsx(I,{size:16})," Create User"]}),e.jsxs("button",{className:"btn btn-secondary",onClick:()=>b(!1),children:[e.jsx(k,{size:16})," Cancel"]})]})]}):e.jsxs("button",{className:"btn btn-primary",onClick:()=>b(!0),children:[e.jsx(I,{size:18})," Create User Account"]})}),e.jsx("div",{className:"card",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"User"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"Linked Resource"}),e.jsx("th",{children:"Role"}),e.jsx("th",{children:"Created"}),i&&e.jsx("th",{children:"Type"}),c&&e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:d.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:c?7:6,style:{textAlign:"center",padding:"2rem",color:"#64748b"},children:"No users found"})}):d.map(s=>{const r=X(s.role),t=s.is_test_user,f=Z(s.id),S=s.id===z;return e.jsxs("tr",{style:{backgroundColor:t?"#fffbeb":"transparent"},children:[e.jsx("td",{children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem"},children:[e.jsx("div",{style:{width:"36px",height:"36px",borderRadius:"50%",backgroundColor:t?"#fbbf24":"#10b981",display:"flex",alignItems:"center",justifyContent:"center",color:"white",fontWeight:"600",fontSize:"0.85rem"},children:(s.full_name||s.email||"U")[0].toUpperCase()}),e.jsxs("div",{children:[e.jsx("span",{style:{fontWeight:"500"},children:s.full_name||"No name"}),S&&e.jsx("span",{style:{marginLeft:"0.5rem",fontSize:"0.75rem",color:"#10b981",fontWeight:"600"},children:"(you)"})]})]})}),e.jsx("td",{style:{color:"#64748b"},children:s.email}),e.jsx("td",{children:q===s.id?e.jsxs("div",{style:{display:"flex",gap:"0.5rem",alignItems:"center"},children:[e.jsxs("select",{className:"form-input",value:C,onChange:a=>N(a.target.value),style:{width:"150px",fontSize:"0.85rem"},children:[e.jsx("option",{value:"",children:"Select resource..."}),$().map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]}),e.jsx("button",{className:"btn-icon btn-success",onClick:()=>J(s.id),title:"Link",children:e.jsx(L,{size:14})}),e.jsx("button",{className:"btn-icon btn-secondary",onClick:()=>{w(null),N("")},title:"Cancel",children:e.jsx(k,{size:14})})]}):f?e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(oe,{size:14,style:{color:"#10b981"}}),e.jsx("span",{style:{color:"#10b981",fontWeight:"500"},children:f.name}),c&&e.jsx("button",{className:"btn-icon",onClick:()=>Q(f.id),title:"Unlink resource",style:{padding:"0.25rem"},children:e.jsx(ce,{size:12})})]}):e.jsxs("span",{style:{color:"#9ca3af",fontSize:"0.85rem"},children:["Not linked",c&&e.jsx("button",{onClick:()=>w(s.id),style:{marginLeft:"0.5rem",background:"none",border:"none",color:"#3b82f6",cursor:"pointer",fontSize:"0.8rem",textDecoration:"underline"},children:"Link"})]})}),e.jsx("td",{children:R===s.id?e.jsx("select",{className:"form-input",value:v.role,onChange:a=>T({...v,role:a.target.value}),style:{width:"140px"},children:j.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))}):e.jsxs("span",{style:{padding:"0.25rem 0.75rem",backgroundColor:r.color+"20",color:r.color,borderRadius:"4px",fontSize:"0.85rem",fontWeight:"500"},children:[r.label,S&&" (you)"]})}),e.jsx("td",{style:{color:"#64748b",fontSize:"0.9rem"},children:s.created_at?new Date(s.created_at).toLocaleDateString("en-GB"):"-"}),i&&e.jsx("td",{children:t?e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.25rem 0.5rem",backgroundColor:"#fef3c7",color:"#92400e",borderRadius:"4px",fontSize:"0.8rem",fontWeight:"500"},children:[e.jsx(E,{size:12})," Test"]}):e.jsx("span",{style:{color:"#64748b",fontSize:"0.85rem"},children:"Real"})}),c&&e.jsx("td",{children:R===s.id?e.jsxs("div",{style:{display:"flex",gap:"0.25rem"},children:[e.jsx("button",{className:"btn-icon btn-success",onClick:()=>Y(s.id,v.role),title:"Save",children:e.jsx(L,{size:16})}),e.jsx("button",{className:"btn-icon btn-secondary",onClick:()=>y(null),title:"Cancel",children:e.jsx(k,{size:16})})]}):e.jsxs("div",{style:{display:"flex",gap:"0.25rem"},children:[e.jsx("button",{className:"btn-icon",onClick:()=>{y(s.id),T({role:s.role})},title:"Edit Role",children:e.jsx(de,{size:16})}),!t&&!S&&e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>H(s.id),title:"Delete",children:e.jsx(me,{size:16})})]})})]},s.id)})})]})}),e.jsxs("div",{className:"card",style:{marginTop:"1.5rem",backgroundColor:"#f8fafc"},children:[e.jsx("h4",{style:{marginBottom:"1rem"},children:"Role Descriptions"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:"1rem"},children:[e.jsxs("div",{children:[e.jsx("span",{style:{fontWeight:"600",color:"#7c3aed"},children:"Admin"}),e.jsx("p",{style:{fontSize:"0.85rem",color:"#64748b",margin:"0.25rem 0 0 0"},children:"Full system access. No workflow notifications."})]}),e.jsxs("div",{children:[e.jsx("span",{style:{fontWeight:"600",color:"#059669"},children:"Supplier PM"}),e.jsx("p",{style:{fontSize:"0.85rem",color:"#64748b",margin:"0.25rem 0 0 0"},children:"Full system access + workflow participant. Validates timesheets & expenses."})]}),e.jsxs("div",{children:[e.jsx("span",{style:{fontWeight:"600",color:"#d97706"},children:"Customer PM"}),e.jsx("p",{style:{fontSize:"0.85rem",color:"#64748b",margin:"0.25rem 0 0 0"},children:"Workflow participant. Validates timesheets, expenses & reviews deliverables."})]}),e.jsxs("div",{children:[e.jsx("span",{style:{fontWeight:"600",color:"#2563eb"},children:"Contributor"}),e.jsx("p",{style:{fontSize:"0.85rem",color:"#64748b",margin:"0.25rem 0 0 0"},children:"Submits timesheets & expenses. Gets rejection notifications."})]}),e.jsxs("div",{children:[e.jsx("span",{style:{fontWeight:"600",color:"#64748b"},children:"Viewer"}),e.jsx("p",{style:{fontSize:"0.85rem",color:"#64748b",margin:"0.25rem 0 0 0"},children:"Read-only access to dashboards and reports."})]})]})]})]}):e.jsx("div",{className:"page-container",children:e.jsxs("div",{className:"card",style:{textAlign:"center",padding:"3rem"},children:[e.jsx(te,{size:48,style:{color:"#ef4444",marginBottom:"1rem"}}),e.jsx("h2",{children:"Access Denied"}),e.jsx("p",{children:"You don't have permission to manage users."})]})})}export{je as default};
