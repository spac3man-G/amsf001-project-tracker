import{u as ie,a as te,c as ne,d as le,m as ce,x as f,j as e,L as re,z as p}from"./index-CdSw3Cue.js";import{i as oe,d as de,r}from"./vendor-react-BUTV5ZEl.js";import{a as m,f as b}from"./formatters-BTbCMDgc.js";import{ac as F,ah as ve,F as fe,Y as B,Q as D,P as W,aO as me,e as M,T as he,A as pe,p as O,I as xe,u as ue,i as je}from"./vendor-icons-Hb5rh3SC.js";import"./vendor-supabase-6faYzd5A.js";const V=[{id:1,name:"Basic Info",icon:fe},{id:2,name:"Milestones",icon:B},{id:3,name:"Impacts",icon:D},{id:4,name:"Deliverables",icon:W},{id:5,name:"Review",icon:me}],$=[{value:p.SCOPE_EXTENSION,label:"Scope Extension",desc:"Additional work beyond original scope"},{value:p.SCOPE_REDUCTION,label:"Scope Reduction",desc:"Removal of work from original scope"},{value:p.TIME_EXTENSION,label:"Time Extension",desc:"Schedule adjustment without scope change"},{value:p.COST_ADJUSTMENT,label:"Cost Adjustment",desc:"Price change without scope/time change"},{value:p.COMBINED,label:"Combined",desc:"Multiple impact types"}];function Se(){const{id:x}=oe(),g=de(),{user:L}=ie(),{projectId:u}=te(),{showSuccess:w,showError:y,showWarning:A}=ne(),{canCreateVariation:_e}=le(),U=!!x,[Y,q]=r.useState(!0),[I,j]=r.useState(!1),[n,S]=r.useState(1),[z,X]=r.useState([]),[h,_]=r.useState("saved"),[i,C]=r.useState({title:"",variation_type:"",description:"",reason:"",contract_terms_reference:"",affected_milestones:[],deliverable_changes:[],impact_summary:""}),[l,P]=r.useState(null);r.useEffect(()=>{u&&G()},[u,x]);async function G(){try{const s=await ce.getAll(u,{orderBy:{column:"milestone_ref",ascending:!0}});if(X(s||[]),x){const a=await f.getWithDetails(x);a&&(P(a),S(a.form_step||1),a.form_data?C(t=>({...t,...a.form_data})):C({title:a.title||"",variation_type:a.variation_type||"",description:a.description||"",reason:a.reason||"",contract_terms_reference:a.contract_terms_reference||"",affected_milestones:a.affected_milestones||[],deliverable_changes:a.deliverable_changes||[],impact_summary:a.impact_summary||""}))}}catch{y("Failed to load data")}finally{q(!1)}}const J=r.useCallback(async()=>{if(l?.id){_("saving");try{await f.saveFormProgress(l.id,i,n),_("saved")}catch{_("error")}}},[l?.id,i,n]);r.useEffect(()=>{if(!l?.id)return;const s=setTimeout(()=>{J()},2e3);return()=>clearTimeout(s)},[i,n]);function o(s,a){C(t=>({...t,[s]:a})),_("unsaved")}async function T(s){l?.id&&await f.saveFormProgress(l.id,i,s),S(s)}async function Q(){n<5&&await T(n+1)}async function H(){n>1&&await T(n-1)}function k(s){switch(s){case 1:return i.title&&i.variation_type;case 2:return i.affected_milestones.length>0;case 3:return i.affected_milestones.every(a=>a.new_baseline_cost!==void 0||a.new_baseline_end);case 4:return!0;case 5:return!0;default:return!0}}function K(s){const a=z.find(c=>c.id===s);if(!a)return;if(i.affected_milestones.some(c=>c.milestone_id===s)){A("Milestone already added");return}const t={milestone_id:s,milestone:a,is_new_milestone:!1,original_baseline_cost:a.billable||0,new_baseline_cost:a.billable||0,original_baseline_start:a.baseline_start_date||a.start_date,new_baseline_start:a.baseline_start_date||a.start_date,original_baseline_end:a.baseline_end_date||a.end_date,new_baseline_end:a.baseline_end_date||a.end_date,change_rationale:""};o("affected_milestones",[...i.affected_milestones,t])}function Z(s){const a=[...i.affected_milestones];a.splice(s,1),o("affected_milestones",a)}function E(s,a,t){const c=[...i.affected_milestones];c[s]={...c[s],[a]:t},o("affected_milestones",c)}function ee(){let s=0,a=0;return i.affected_milestones.forEach(t=>{if(s+=(t.new_baseline_cost||0)-(t.original_baseline_cost||0),t.original_baseline_end&&t.new_baseline_end){const c=new Date(t.original_baseline_end),N=new Date(t.new_baseline_end);a+=Math.round((N-c)/(1e3*60*60*24))}}),{totalCost:s,totalDays:a}}async function R(){j(!0);try{if(l?.id)await f.update(l.id,{title:i.title,variation_type:i.variation_type,description:i.description,reason:i.reason,contract_terms_reference:i.contract_terms_reference,form_data:i,form_step:n}),w("Draft saved");else{const s=await f.createVariation(u,{title:i.title,variation_type:i.variation_type,description:i.description,reason:i.reason,contract_terms_reference:i.contract_terms_reference,form_data:i,form_step:n},L?.id);P(s),w("Draft created"),g(`/variations/${s.id}/edit`,{replace:!0})}}catch{y("Failed to save draft")}finally{j(!1)}}async function se(){for(let s=1;s<=5;s++)if(!k(s)){A(`Please complete Step ${s} before submitting`),S(s);return}j(!0);try{await R(),await f.submitForApproval(l.id,i.impact_summary),w("Variation submitted for approval"),g(`/variations/${l.id}`)}catch{y("Failed to submit variation")}finally{j(!1)}}function ae(){g("/variations")}if(Y)return e.jsx(re,{message:"Loading...",size:"large",fullPage:!0});const{totalCost:d,totalDays:v}=ee();return e.jsxs("div",{className:"variation-form-page",children:[e.jsx("header",{className:"vf-header",children:e.jsxs("div",{className:"vf-header-content",children:[e.jsxs("div",{className:"vf-header-left",children:[e.jsx("button",{className:"vf-back-btn",onClick:ae,children:e.jsx(F,{size:20})}),e.jsxs("div",{children:[e.jsx("h1",{children:U?"Edit Variation":"Create Variation"}),l&&e.jsx("span",{className:"vf-header-ref",children:l.variation_ref})]})]}),e.jsxs("div",{className:"vf-header-right",children:[e.jsxs("span",{className:`vf-save-status ${h}`,children:[h==="saving"&&"Saving...",h==="saved"&&"Draft saved",h==="unsaved"&&"Unsaved changes",h==="error"&&"Save failed"]}),e.jsxs("button",{className:"vf-btn vf-btn-secondary",onClick:R,disabled:I,children:[e.jsx(ve,{size:18}),"Save Draft"]})]})]})}),e.jsx("div",{className:"vf-progress",children:e.jsx("div",{className:"vf-progress-content",children:V.map((s,a)=>{const t=s.icon,c=n===s.id,N=n>s.id;return e.jsxs("div",{className:`vf-step ${c?"active":""} ${N?"complete":""}`,onClick:()=>T(s.id),children:[e.jsx("div",{className:"vf-step-icon",children:N?e.jsx(M,{size:16}):e.jsx(t,{size:16})}),e.jsx("span",{className:"vf-step-name",children:s.name}),a<V.length-1&&e.jsx("div",{className:"vf-step-connector"})]},s.id)})})}),e.jsxs("div",{className:"vf-content",children:[e.jsxs("div",{className:"vf-form",children:[n===1&&e.jsx("div",{className:"vf-step-content",children:e.jsxs("div",{className:"vf-card",children:[e.jsx("h2",{children:"Basic Information"}),e.jsx("p",{className:"vf-card-desc",children:"Enter the basic details of this variation request."}),e.jsxs("div",{className:"vf-field",children:[e.jsx("label",{children:"Variation Title *"}),e.jsx("input",{type:"text",value:i.title,onChange:s=>o("title",s.target.value),placeholder:"e.g., Additional Security Requirements"})]}),e.jsxs("div",{className:"vf-field",children:[e.jsx("label",{children:"Variation Type *"}),e.jsx("div",{className:"vf-type-grid",children:$.map(s=>e.jsxs("div",{className:`vf-type-option ${i.variation_type===s.value?"selected":""}`,onClick:()=>o("variation_type",s.value),children:[e.jsx("div",{className:"vf-type-radio",children:i.variation_type===s.value&&e.jsx(M,{size:14})}),e.jsxs("div",{className:"vf-type-info",children:[e.jsx("span",{className:"vf-type-label",children:s.label}),e.jsx("span",{className:"vf-type-desc",children:s.desc})]})]},s.value))})]}),e.jsxs("div",{className:"vf-field",children:[e.jsx("label",{children:"Description"}),e.jsx("textarea",{value:i.description,onChange:s=>o("description",s.target.value),placeholder:"Describe the variation in detail...",rows:4})]}),e.jsxs("div",{className:"vf-field",children:[e.jsx("label",{children:"Reason for Change"}),e.jsx("textarea",{value:i.reason,onChange:s=>o("reason",s.target.value),placeholder:"Why is this variation necessary?",rows:3})]}),e.jsxs("div",{className:"vf-field",children:[e.jsx("label",{children:"Contract Terms Reference"}),e.jsx("input",{type:"text",value:i.contract_terms_reference,onChange:s=>o("contract_terms_reference",s.target.value),placeholder:"e.g., Clause 7.2 - Change Control"})]})]})}),n===2&&e.jsx("div",{className:"vf-step-content",children:e.jsxs("div",{className:"vf-card",children:[e.jsx("h2",{children:"Affected Milestones"}),e.jsx("p",{className:"vf-card-desc",children:"Select the milestones affected by this variation."}),e.jsx("div",{className:"vf-milestone-selector",children:e.jsxs("select",{className:"vf-milestone-select",onChange:s=>{s.target.value&&(K(s.target.value),s.target.value="")},children:[e.jsx("option",{value:"",children:"+ Add milestone..."}),z.filter(s=>!i.affected_milestones.some(a=>a.milestone_id===s.id)).map(s=>e.jsxs("option",{value:s.id,children:[s.milestone_ref,": ",s.name]},s.id))]})}),i.affected_milestones.length===0?e.jsxs("div",{className:"vf-empty",children:[e.jsx(B,{size:32}),e.jsx("p",{children:"No milestones selected"}),e.jsx("span",{children:"Use the dropdown above to add affected milestones"})]}):e.jsx("div",{className:"vf-milestone-list",children:i.affected_milestones.map((s,a)=>e.jsxs("div",{className:"vf-milestone-item",children:[e.jsxs("div",{className:"vf-milestone-info",children:[e.jsx("span",{className:"vf-milestone-ref",children:s.milestone?.milestone_ref}),e.jsx("span",{className:"vf-milestone-name",children:s.milestone?.name})]}),e.jsxs("div",{className:"vf-milestone-current",children:[e.jsxs("span",{children:["Current: ",m(s.original_baseline_cost)]}),e.jsxs("span",{children:["End: ",b(s.original_baseline_end)]})]}),e.jsx("button",{className:"vf-milestone-remove",onClick:()=>Z(a),children:e.jsx(he,{size:16})})]},a))})]})}),n===3&&e.jsx("div",{className:"vf-step-content",children:e.jsxs("div",{className:"vf-card",children:[e.jsx("h2",{children:"Impact Details"}),e.jsx("p",{className:"vf-card-desc",children:"Specify the cost and schedule changes for each affected milestone."}),i.affected_milestones.length===0?e.jsxs("div",{className:"vf-empty",children:[e.jsx(pe,{size:32}),e.jsx("p",{children:"No milestones selected"}),e.jsx("span",{children:"Go back to Step 2 to add affected milestones"})]}):e.jsx("div",{className:"vf-impacts-list",children:i.affected_milestones.map((s,a)=>e.jsxs("div",{className:"vf-impact-item",children:[e.jsxs("div",{className:"vf-impact-header",children:[e.jsx("span",{className:"vf-impact-ref",children:s.milestone?.milestone_ref}),e.jsx("span",{className:"vf-impact-name",children:s.milestone?.name})]}),e.jsxs("div",{className:"vf-impact-fields",children:[e.jsxs("div",{className:"vf-impact-field",children:[e.jsxs("label",{children:[e.jsx(D,{size:14}),"New Baseline Cost"]}),e.jsxs("div",{className:"vf-impact-input-group",children:[e.jsx("span",{className:"vf-currency",children:"£"}),e.jsx("input",{type:"number",value:s.new_baseline_cost||"",onChange:t=>E(a,"new_baseline_cost",parseFloat(t.target.value)||0)}),e.jsxs("span",{className:"vf-original",children:["Was: ",m(s.original_baseline_cost)]})]})]}),e.jsxs("div",{className:"vf-impact-field",children:[e.jsxs("label",{children:[e.jsx(O,{size:14}),"New End Date"]}),e.jsxs("div",{className:"vf-impact-input-group",children:[e.jsx("input",{type:"date",value:s.new_baseline_end||"",onChange:t=>E(a,"new_baseline_end",t.target.value)}),e.jsxs("span",{className:"vf-original",children:["Was: ",b(s.original_baseline_end)]})]})]})]}),e.jsxs("div",{className:"vf-impact-rationale",children:[e.jsx("label",{children:"Rationale for this milestone"}),e.jsx("textarea",{value:s.change_rationale||"",onChange:t=>E(a,"change_rationale",t.target.value),placeholder:"Why is this milestone affected?",rows:2})]})]},a))}),e.jsxs("div",{className:"vf-impact-summary",children:[e.jsx("h3",{children:"Total Impact"}),e.jsxs("div",{className:"vf-impact-totals",children:[e.jsxs("div",{className:`vf-impact-total ${d>=0?"positive":"negative"}`,children:[e.jsx(D,{size:20}),e.jsxs("span",{className:"vf-total-value",children:[d>0?"+":"",m(d)]}),e.jsx("span",{className:"vf-total-label",children:"Cost"})]}),e.jsxs("div",{className:`vf-impact-total ${v>=0?"positive":"negative"}`,children:[e.jsx(O,{size:20}),e.jsxs("span",{className:"vf-total-value",children:[v>0?"+":"",v," days"]}),e.jsx("span",{className:"vf-total-label",children:"Schedule"})]})]})]})]})}),n===4&&e.jsx("div",{className:"vf-step-content",children:e.jsxs("div",{className:"vf-card",children:[e.jsx("h2",{children:"Deliverable Changes"}),e.jsx("p",{className:"vf-card-desc",children:"Specify any deliverables to add, remove, or modify. (Optional)"}),e.jsxs("div",{className:"vf-info-box",children:[e.jsx(xe,{size:18}),e.jsxs("div",{children:[e.jsx("strong",{children:"Coming Soon"}),e.jsx("p",{children:"Deliverable change management will be available in a future release. For now, describe any deliverable changes in the Impact Summary on the next step."})]})]}),e.jsxs("div",{className:"vf-empty",children:[e.jsx(W,{size:32}),e.jsx("p",{children:"No deliverable changes specified"}),e.jsx("span",{children:"This step is optional - proceed to Review"})]})]})}),n===5&&e.jsx("div",{className:"vf-step-content",children:e.jsxs("div",{className:"vf-card",children:[e.jsx("h2",{children:"Review & Submit"}),e.jsx("p",{className:"vf-card-desc",children:"Review your variation and add a summary before submitting."}),e.jsxs("div",{className:"vf-review-section",children:[e.jsx("h3",{children:"Basic Information"}),e.jsxs("div",{className:"vf-review-row",children:[e.jsx("span",{className:"vf-review-label",children:"Title"}),e.jsx("span",{className:"vf-review-value",children:i.title||"-"})]}),e.jsxs("div",{className:"vf-review-row",children:[e.jsx("span",{className:"vf-review-label",children:"Type"}),e.jsx("span",{className:"vf-review-value",children:$.find(s=>s.value===i.variation_type)?.label||"-"})]}),i.description&&e.jsxs("div",{className:"vf-review-row",children:[e.jsx("span",{className:"vf-review-label",children:"Description"}),e.jsx("span",{className:"vf-review-value",children:i.description})]}),i.reason&&e.jsxs("div",{className:"vf-review-row",children:[e.jsx("span",{className:"vf-review-label",children:"Reason"}),e.jsx("span",{className:"vf-review-value",children:i.reason})]})]}),e.jsxs("div",{className:"vf-review-section",children:[e.jsxs("h3",{children:["Affected Milestones (",i.affected_milestones.length,")"]}),i.affected_milestones.map((s,a)=>e.jsxs("div",{className:"vf-review-milestone",children:[e.jsx("span",{className:"vf-review-ms-ref",children:s.milestone?.milestone_ref}),e.jsx("span",{className:"vf-review-ms-name",children:s.milestone?.name}),e.jsxs("div",{className:"vf-review-ms-changes",children:[s.original_baseline_cost!==s.new_baseline_cost&&e.jsxs("span",{children:["Cost: ",m(s.original_baseline_cost)," → ",m(s.new_baseline_cost)]}),s.original_baseline_end!==s.new_baseline_end&&e.jsxs("span",{children:["End: ",b(s.original_baseline_end)," → ",b(s.new_baseline_end)]})]})]},a))]}),e.jsxs("div",{className:"vf-review-section",children:[e.jsx("h3",{children:"Total Impact"}),e.jsxs("div",{className:"vf-review-impacts",children:[e.jsxs("div",{className:`vf-review-impact ${d>=0?"positive":"negative"}`,children:[e.jsx("span",{className:"vf-review-impact-label",children:"Cost"}),e.jsxs("span",{className:"vf-review-impact-value",children:[d>0?"+":"",m(d)]})]}),e.jsxs("div",{className:`vf-review-impact ${v>=0?"positive":"negative"}`,children:[e.jsx("span",{className:"vf-review-impact-label",children:"Schedule"}),e.jsxs("span",{className:"vf-review-impact-value",children:[v>0?"+":"",v," days"]})]})]})]}),e.jsxs("div",{className:"vf-field",children:[e.jsx("label",{children:"Impact Summary *"}),e.jsx("textarea",{value:i.impact_summary,onChange:s=>o("impact_summary",s.target.value),placeholder:"Provide a summary of the overall impact of this variation...",rows:4}),e.jsx("span",{className:"vf-field-hint",children:"This summary will appear on the variation certificate"})]})]})})]}),e.jsx("div",{className:"vf-footer",children:e.jsxs("div",{className:"vf-footer-content",children:[e.jsxs("button",{className:"vf-btn vf-btn-secondary",onClick:H,disabled:n===1,children:[e.jsx(F,{size:18}),"Previous"]}),e.jsx("div",{className:"vf-footer-right",children:n<5?e.jsxs("button",{className:"vf-btn vf-btn-primary",onClick:Q,disabled:!k(n),children:["Next",e.jsx(ue,{size:18})]}):e.jsxs("button",{className:"vf-btn vf-btn-submit",onClick:se,disabled:I||!i.impact_summary,children:[e.jsx(je,{size:18}),"Submit for Approval"]})})]})})]})]})}export{Se as default};
