import{u as G,a as W,c as B,d as Y,X as v,Y as s,j as a,L as J,Z as X,_ as q,$ as o}from"./index-IaXQkjEL.js";import{d as H,r}from"./vendor-react-BUTV5ZEl.js";import{C as Q}from"./ConfirmDialog-CmqcCv3X.js";import{a as y,f as Z}from"./formatters-BTbCMDgc.js";import{R as K,ai as aa,F as p,p as C,aP as ea,Q as T,aY as sa,T as ta,I as ra,w as S}from"./vendor-icons-C6BNM9_X.js";import"./vendor-supabase-6faYzd5A.js";const ia=[{value:"all",label:"All Variations"},{value:"draft",label:"Drafts"},{value:"pending",label:"Pending Approval"},{value:"approved",label:"Approved"},{value:"applied",label:"Applied"},{value:"rejected",label:"Rejected"}];function ja(){const j=H(),{user:na,profile:la}=G(),{projectId:c}=W(),{showSuccess:b,showError:x}=B(),{canCreateVariation:_,canDeleteVariation:f,canSignAsSupplier:ca,canSignAsCustomer:da}=Y(),[A,I]=r.useState([]),[E,D]=r.useState(!0),[N,g]=r.useState(!1),[t,P]=r.useState("all"),[i,w]=r.useState(null),[l,m]=r.useState({open:!1,variation:null});r.useEffect(()=>{c&&(h(),u())},[c]);async function h(){try{const e=await v.getAllWithStats(c);I(e||[])}catch{x("Failed to load variations")}finally{D(!1),g(!1)}}async function u(){try{const e=await v.getSummary(c);w(e)}catch{}}async function R(){g(!0),await h(),await u()}function V(){j("/variations/new")}function z(e){j(`/variations/${e.id}`)}function F(e,n){e.stopPropagation(),m({open:!0,variation:n})}async function O(){const e=l.variation;if(e)try{await v.deleteDraftVariation(e.id),b(`Variation ${e.variation_ref} deleted`),m({open:!1,variation:null}),await h(),await u()}catch(n){x(n.message||"Failed to delete variation")}}function M(){m({open:!1,variation:null})}const d=A.filter(e=>t==="all"?!0:t==="pending"?[s.SUBMITTED,s.AWAITING_CUSTOMER,s.AWAITING_SUPPLIER].includes(e.status):e.status===t);function U(e){return{[s.DRAFT]:"draft",[s.SUBMITTED]:"submitted",[s.AWAITING_CUSTOMER]:"awaiting",[s.AWAITING_SUPPLIER]:"awaiting",[s.APPROVED]:"approved",[s.APPLIED]:"applied",[s.REJECTED]:"rejected"}[e]||"draft"}function k(e){switch(e){case o.SCOPE_EXTENSION:return a.jsx(S,{size:14});case o.SCOPE_REDUCTION:return a.jsx(S,{size:14,className:"rotate-180"});case o.TIME_EXTENSION:return a.jsx(C,{size:14});case o.COST_ADJUSTMENT:return a.jsx(T,{size:14});default:return a.jsx(p,{size:14})}}return E?a.jsx(J,{message:"Loading variations...",size:"large",fullPage:!0}):a.jsxs("div",{className:"variations-page",children:[a.jsx("header",{className:"var-header",children:a.jsxs("div",{className:"var-header-content",children:[a.jsxs("div",{className:"var-header-left",children:[a.jsx("h1",{children:"Variations"}),a.jsx("p",{children:"Project change control and variation management"})]}),a.jsxs("div",{className:"var-header-actions",children:[a.jsxs("button",{className:"var-btn var-btn-secondary",onClick:R,disabled:N,children:[a.jsx(K,{size:18,className:N?"spinning":""}),"Refresh"]}),_&&a.jsxs("button",{className:"var-btn var-btn-primary",onClick:V,children:[a.jsx(aa,{size:18}),"Create Variation"]})]})]})}),a.jsxs("div",{className:"var-content",children:[i&&a.jsxs("div",{className:"var-summary-grid",children:[a.jsxs("div",{className:"var-summary-card accent",children:[a.jsx("div",{className:"var-summary-icon",children:a.jsx(p,{size:22})}),a.jsx("div",{className:"var-summary-value",children:i.total}),a.jsx("div",{className:"var-summary-label",children:"Total Variations"})]}),a.jsxs("div",{className:"var-summary-card warning",children:[a.jsx("div",{className:"var-summary-icon",children:a.jsx(C,{size:22})}),a.jsx("div",{className:"var-summary-value",children:i.pending}),a.jsx("div",{className:"var-summary-label",children:"Pending Approval"})]}),a.jsxs("div",{className:"var-summary-card success",children:[a.jsx("div",{className:"var-summary-icon",children:a.jsx(ea,{size:22})}),a.jsx("div",{className:"var-summary-value",children:i.applied}),a.jsx("div",{className:"var-summary-label",children:"Applied"})]}),a.jsxs("div",{className:"var-summary-card primary",children:[a.jsx("div",{className:"var-summary-icon",children:a.jsx(T,{size:22})}),a.jsxs("div",{className:"var-summary-value",children:[i.totalCostImpact>=0?"+":"",y(i.totalCostImpact)]}),a.jsx("div",{className:"var-summary-label",children:"Net Cost Impact"})]})]}),a.jsxs("div",{className:"var-filter-bar",children:[a.jsxs("div",{className:"var-filter-group",children:[a.jsx(sa,{size:16}),a.jsx("span",{children:"Filter:"}),ia.map(e=>a.jsx("button",{className:`var-filter-btn ${t===e.value?"active":""}`,onClick:()=>P(e.value),children:e.label},e.value))]}),a.jsxs("div",{className:"var-filter-count",children:[d.length," variation",d.length!==1?"s":""]})]}),a.jsx("div",{className:"var-table-card",children:d.length===0?a.jsxs("div",{className:"var-empty",children:[a.jsx("div",{className:"var-empty-icon",children:a.jsx(p,{size:32})}),a.jsx("div",{className:"var-empty-title",children:t==="all"?"No variations yet":`No ${t} variations`}),a.jsx("div",{className:"var-empty-text",children:t==="all"?'Click "Create Variation" to request a project change.':"Try a different filter to see more variations."})]}):a.jsxs("table",{className:"var-table",children:[a.jsx("thead",{children:a.jsxs("tr",{children:[a.jsx("th",{children:"Reference"}),a.jsx("th",{children:"Title"}),a.jsx("th",{children:"Type"}),a.jsx("th",{children:"Status"}),a.jsx("th",{children:"Cost Impact"}),a.jsx("th",{children:"Days Impact"}),a.jsx("th",{children:"Milestones"}),a.jsx("th",{children:"Created"}),f&&a.jsx("th",{className:"var-actions-col",children:"Actions"})]})}),a.jsx("tbody",{children:d.map(e=>{const n=X[e.status],$=q[e.variation_type];return a.jsxs("tr",{onClick:()=>z(e),children:[a.jsx("td",{children:a.jsx("span",{className:"var-ref",children:e.variation_ref})}),a.jsxs("td",{children:[a.jsx("div",{className:"var-title",children:e.title}),e.description&&a.jsxs("div",{className:"var-title-sub",children:[e.description.substring(0,60),e.description.length>60?"...":""]})]}),a.jsx("td",{children:a.jsxs("span",{className:"var-type-badge",children:[k(e.variation_type),$?.label||e.variation_type]})}),a.jsx("td",{children:a.jsxs("span",{className:`var-status-badge ${U(e.status)}`,children:[a.jsx("span",{className:"var-status-dot"}),n?.label||e.status]})}),a.jsx("td",{children:a.jsx("span",{className:`var-impact ${e.total_cost_impact>=0?"positive":"negative"}`,children:e.total_cost_impact!==0?a.jsxs(a.Fragment,{children:[e.total_cost_impact>0?"+":"",y(e.total_cost_impact)]}):a.jsx("span",{className:"var-neutral",children:"—"})})}),a.jsx("td",{children:a.jsx("span",{className:`var-impact ${e.total_days_impact>=0?"positive":"negative"}`,children:e.total_days_impact!==0?a.jsxs(a.Fragment,{children:[e.total_days_impact>0?"+":"",e.total_days_impact," days"]}):a.jsx("span",{className:"var-neutral",children:"—"})})}),a.jsx("td",{children:a.jsx("span",{className:"var-milestone-count",children:e.milestone_count||0})}),a.jsx("td",{children:a.jsx("span",{className:"var-date",children:Z(e.created_at)})}),f&&a.jsx("td",{className:"var-actions-cell",children:[s.DRAFT,s.SUBMITTED,s.REJECTED].includes(e.status)?a.jsx("button",{className:"var-delete-btn",onClick:L=>F(L,e),title:"Delete variation",children:a.jsx(ta,{size:16})}):a.jsx("span",{className:"var-no-action",children:"—"})})]},e.id)})})]})}),a.jsxs("div",{className:"var-info-box",children:[a.jsxs("div",{className:"var-info-header",children:[a.jsx(ra,{size:18}),"How Variations Work"]}),a.jsxs("ul",{className:"var-info-list",children:[a.jsxs("li",{children:[a.jsx("strong",{children:"Create:"})," Define the change, select affected milestones, and specify impacts"]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Submit:"})," Send the variation for dual-signature approval"]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Approve:"})," Both Supplier PM and Customer PM must sign to approve"]}),a.jsxs("li",{children:[a.jsx("strong",{children:"Apply:"})," Approved variations update milestone baselines automatically"]}),a.jsx("li",{children:"Click any variation row to view details or continue editing drafts"})]})]})]}),a.jsx(Q,{isOpen:l.open,title:"Delete Variation",message:l.variation?`Are you sure you want to delete ${l.variation.variation_ref}?

"${l.variation.title}"

This action cannot be undone.`:"",confirmLabel:"Delete",confirmVariant:"danger",onConfirm:O,onCancel:M})]})}export{ja as default};
