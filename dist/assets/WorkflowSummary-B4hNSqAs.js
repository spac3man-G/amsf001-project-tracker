import{c as V,r as f,u as re,s as m,j as e,L as se,P as ie,aT as T,U as ne,R as oe,S as x,k as W,w as $,v as q,f as F,A as L,C as le,m as ae}from"./index-BcgMsB79.js";import{E as ce}from"./eye-TEZd480_.js";/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const de=V("Filter",[["polygon",{points:"22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3",key:"1yg77f"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=V("UserCheck",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["polyline",{points:"16 11 18 13 22 9",key:"1pwet4"}]]);function he(){const[G,R]=f.useState([]),[H,w]=f.useState(!0),[u,Y]=f.useState(null),[E,O]=f.useState(null),[N,J]=f.useState(null),[_,K]=f.useState("all"),[C,k]=f.useState(!1),[me,Q]=f.useState(null),y=re(),h=t=>["admin","supplier_pm","customer_pm"].includes(t),P=t=>{switch(t){case"admin":return"Admin";case"supplier_pm":return"Supplier PM";case"customer_pm":return"Customer PM";case"contributor":return"Contributor";case"viewer":return"Viewer";default:return t}};f.useEffect(()=>{X()},[]);async function X(){try{const{data:{user:t}}=await m.auth.getUser();if(!t){y("/login");return}O(t.id);const{data:o}=await m.from("profiles").select("id, role, full_name, email").eq("id",t.id).single();if(!o){alert("Profile not found."),y("/");return}if(o.role==="viewer"){alert("You do not have permission to view this page."),y("/");return}const{data:n}=await m.from("projects").select("id").eq("reference","AMSF001").single();n&&Q(n.id),Y(o.role),J(o),await A(t.id,o,n==null?void 0:n.id)}catch(t){console.error("Error checking permissions:",t),w(!1)}}async function A(t,o,n){k(!0);try{const i=t||E,c=o||N;if(!i||!c){console.error("No user ID or profile available"),R([]),w(!1),k(!1);return}let g=[];const{data:d,error:D}=await m.from("timesheets").select("*").eq("status","Submitted");if(D)console.error("Error fetching timesheets:",D);else if(d&&d.length>0){const s=[...new Set(d.map(r=>r.resource_id).filter(Boolean))];let l={};if(s.length>0){const{data:r}=await m.from("resources").select("id, name").in("id",s);r&&r.forEach(a=>{l[a.id]=a.name})}d.forEach(r=>{!h(c.role)&&r.user_id!==i||g.push({id:`ts-${r.id}`,reference_id:r.id,reference_type:"timesheet",category:"timesheet",title:"Timesheet Pending Approval",message:`${r.hours_worked||r.hours||0}h on ${new Date(r.work_date||r.date).toLocaleDateString("en-GB")}`,entityName:l[r.resource_id]||"Unknown Resource",submitterName:"",created_at:r.updated_at||r.created_at,action_url:"/timesheets",action_label:"Review Timesheet",assignedTo:{role:"customer_pm",label:"Customer PM",color:"#d97706",bg:"#fef3c7"},itemDetails:r})})}const{data:S,error:U}=await m.from("expenses").select("*").eq("status","Submitted");U?console.error("Error fetching expenses:",U):S&&S.length>0&&S.forEach(s=>{if(!h(c.role)&&s.created_by!==i)return;const l=s.chargeable_to_customer!==!1,r=l?{role:"customer_pm",label:"Customer PM",color:"#d97706",bg:"#fef3c7"}:{role:"supplier_pm",label:"Supplier PM",color:"#0891b2",bg:"#cffafe"};g.push({id:`exp-${s.id}`,reference_id:s.id,reference_type:"expense",category:"expense",title:"Expense Pending Validation",message:`${s.category}: Â£${parseFloat(s.amount||0).toFixed(2)} - ${s.reason||"No description"}`,entityName:s.resource_name||"Unknown Resource",submitterName:"",created_at:s.updated_at||s.created_at,action_url:"/expenses",action_label:"Review Expense",assignedTo:r,itemDetails:s,isChargeable:l})});const{data:z,error:M}=await m.from("deliverables").select("*").eq("status","Submitted");M?console.error("Error fetching deliverables:",M):z&&z.length>0&&z.forEach(s=>{g.push({id:`del-${s.id}`,reference_id:s.id,reference_type:"deliverable",category:"deliverable",title:"Deliverable Pending Review",message:s.name,entityName:`${s.deliverable_ref}: ${s.name}`,submitterName:"",created_at:s.updated_at||s.created_at,action_url:"/deliverables",action_label:"Review Deliverable",assignedTo:{role:"customer_pm",label:"Customer PM",color:"#d97706",bg:"#fef3c7"},itemDetails:s})});const{data:v,error:B}=await m.from("milestone_certificates").select("*").eq("status","Submitted");if(B)console.error("Error fetching certificates:",B);else if(v&&v.length>0){const s=[...new Set(v.map(r=>r.milestone_id).filter(Boolean))];let l={};if(s.length>0){const{data:r}=await m.from("milestones").select("id, milestone_ref, name").in("id",s);r&&r.forEach(a=>{l[a.id]=a})}v.forEach(r=>{const a=l[r.milestone_id]||{};g.push({id:`cert-${r.id}`,reference_id:r.id,reference_type:"milestone_certificate",category:"certificate",title:"Certificate Pending Approval",message:`${a.milestone_ref||"Unknown"}: ${a.name||"Unknown Milestone"}`,entityName:`${a.milestone_ref||"Unknown"}: ${a.name||"Unknown Milestone"}`,submitterName:"",created_at:r.updated_at||r.created_at,action_url:"/milestones",action_label:"Review Certificate",assignedTo:{role:"customer_pm",label:"Customer PM",color:"#d97706",bg:"#fef3c7"},itemDetails:r})})}g.sort((s,l)=>new Date(l.created_at)-new Date(s.created_at)),R(g)}catch(i){console.error("Error fetching workflow items:",i)}finally{w(!1),k(!1)}}const Z=t=>{switch(t){case"timesheet":return e.jsx(W,{size:18});case"expense":return e.jsx($,{size:18});case"deliverable":return e.jsx(q,{size:18});case"certificate":return e.jsx(F,{size:18});default:return e.jsx(T,{size:18})}},ee=t=>{switch(t){case"timesheet":return{bg:"#dbeafe",text:"#1e40af",border:"#93c5fd"};case"expense":return{bg:"#dcfce7",text:"#166534",border:"#86efac"};case"deliverable":return{bg:"#fef3c7",text:"#92400e",border:"#fcd34d"};case"certificate":return{bg:"#f3e8ff",text:"#6b21a8",border:"#d8b4fe"};default:return{bg:"#f1f5f9",text:"#475569",border:"#cbd5e1"}}},I=t=>{const o=new Date(t),i=new Date-o;return Math.floor(i/864e5)},te=t=>t>=5?{color:"#dc2626",fontWeight:"600"}:t>=3?{color:"#f59e0b",fontWeight:"500"}:{color:"#64748b"},j=G.filter(t=>!(_!=="all"&&t.category!==_)),b=j.reduce((t,o)=>{const n=o.category;return t[n]||(t[n]=[]),t[n].push(o),t},{}),p={total:j.length,timesheets:(b.timesheet||[]).length,expenses:(b.expense||[]).length,deliverables:(b.deliverable||[]).length,certificates:(b.certificate||[]).length,urgent:j.filter(t=>I(t.created_at)>=5).length};return H?e.jsx(se,{message:"Loading workflow summary...",size:"large",fullPage:!0}):e.jsxs("div",{className:"page-container",children:[e.jsxs(ie,{icon:T,title:"Workflow Summary",subtitle:h(u)?"All pending actions across the project":"Your pending workflow actions",children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.5rem 1rem",backgroundColor:"#f1f5f9",borderRadius:"8px",fontSize:"0.85rem"},children:[h(u)?e.jsx(ce,{size:16}):e.jsx(ne,{size:16}),e.jsxs("span",{children:["Viewing as: ",e.jsx("strong",{children:P(u)})]})]}),e.jsxs("button",{className:"btn btn-secondary",onClick:()=>A(E,N),disabled:C,children:[e.jsx(oe,{size:18,className:C?"spinning":""}),C?"Refreshing...":"Refresh"]})]}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem",gridTemplateColumns:"repeat(6, 1fr)"},children:[e.jsx(x,{icon:T,label:"Total Pending",value:p.total,color:"#64748b"}),e.jsx(x,{icon:W,label:"Timesheets",value:p.timesheets,color:"#3b82f6"}),e.jsx(x,{icon:$,label:"Expenses",value:p.expenses,color:"#10b981"}),e.jsx(x,{icon:q,label:"Deliverables",value:p.deliverables,color:"#f59e0b"}),e.jsx(x,{icon:F,label:"Certificates",value:p.certificates,color:"#8b5cf6"}),e.jsx(x,{icon:L,label:"Urgent (5+ days)",value:p.urgent,color:"#dc2626"})]}),e.jsx("div",{className:"card",style:{marginBottom:"1.5rem"},children:e.jsxs("div",{style:{display:"flex",gap:"1rem",alignItems:"center",flexWrap:"wrap"},children:[e.jsx(de,{size:18,style:{color:"#64748b"}}),e.jsx("span",{style:{fontWeight:"500"},children:"Filter:"}),e.jsxs("select",{value:_,onChange:t=>K(t.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"all",children:"All Categories"}),e.jsx("option",{value:"timesheet",children:"Timesheets"}),e.jsx("option",{value:"expense",children:"Expenses"}),e.jsx("option",{value:"deliverable",children:"Deliverables"}),e.jsx("option",{value:"certificate",children:"Certificates"})]})]})}),j.length===0?e.jsxs("div",{className:"card",style:{textAlign:"center",padding:"3rem"},children:[e.jsx(le,{size:48,style:{color:"#10b981",marginBottom:"1rem"}}),e.jsx("h3",{style:{margin:"0 0 0.5rem"},children:"All Clear!"}),e.jsx("p",{style:{color:"#64748b",margin:0},children:h(u)?"No pending workflow actions across the project.":"You have no pending workflow actions."})]}):Object.entries(b).map(([t,o])=>{const n=ee(t);return e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem",marginBottom:"1rem",paddingBottom:"0.75rem",borderBottom:`2px solid ${n.border}`},children:[e.jsx("div",{style:{width:"40px",height:"40px",borderRadius:"10px",backgroundColor:n.bg,display:"flex",alignItems:"center",justifyContent:"center",color:n.text},children:Z(t)}),e.jsxs("div",{children:[e.jsx("h3",{style:{margin:0,textTransform:"capitalize"},children:t==="certificate"?"Milestone Certificates":`${t}s`}),e.jsxs("span",{style:{fontSize:"0.85rem",color:"#64748b"},children:[o.length," pending action",o.length!==1?"s":""]})]})]}),e.jsxs("table",{style:{width:"100%",borderCollapse:"collapse"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:{textAlign:"left",padding:"0.75rem",borderBottom:"1px solid #e2e8f0",fontSize:"0.85rem",fontWeight:"600",color:"#64748b"},children:"Item"}),e.jsx("th",{style:{textAlign:"left",padding:"0.75rem",borderBottom:"1px solid #e2e8f0",fontSize:"0.85rem",fontWeight:"600",color:"#64748b"},children:"Action Required"}),e.jsx("th",{style:{textAlign:"left",padding:"0.75rem",borderBottom:"1px solid #e2e8f0",fontSize:"0.85rem",fontWeight:"600",color:"#64748b"},children:"Assigned To"}),e.jsx("th",{style:{textAlign:"center",padding:"0.75rem",borderBottom:"1px solid #e2e8f0",fontSize:"0.85rem",fontWeight:"600",color:"#64748b"},children:"Days Pending"}),e.jsx("th",{style:{textAlign:"right",padding:"0.75rem",borderBottom:"1px solid #e2e8f0",fontSize:"0.85rem",fontWeight:"600",color:"#64748b"},children:"Action"})]})}),e.jsx("tbody",{children:o.map(i=>{const c=I(i.created_at),g=te(c),d=i.assignedTo;return e.jsxs("tr",{style:{borderBottom:"1px solid #f1f5f9"},children:[e.jsxs("td",{style:{padding:"0.75rem"},children:[e.jsx("div",{style:{fontWeight:"500"},children:i.entityName||"Unknown"}),e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b"},children:i.message}),i.submitterName&&e.jsxs("div",{style:{fontSize:"0.75rem",color:"#9ca3af",marginTop:"0.25rem"},children:["Submitted by: ",i.submitterName]})]}),e.jsxs("td",{style:{padding:"0.75rem"},children:[e.jsx("span",{style:{padding:"4px 10px",backgroundColor:n.bg,color:n.text,borderRadius:"12px",fontSize:"0.8rem",fontWeight:"500"},children:i.action_label||i.title}),i.category==="expense"&&e.jsx("div",{style:{fontSize:"0.7rem",marginTop:"0.25rem",color:i.isChargeable?"#10b981":"#f59e0b"},children:i.isChargeable?"âœ“ Chargeable":"âœ— Non-chargeable"})]}),e.jsx("td",{style:{padding:"0.75rem"},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(fe,{size:14,style:{color:d.color}}),e.jsx("span",{style:{padding:"4px 10px",backgroundColor:d.bg,color:d.color,borderRadius:"6px",fontSize:"0.85rem",fontWeight:"500"},children:d.label})]})}),e.jsx("td",{style:{padding:"0.75rem",textAlign:"center"},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"0.5rem"},children:[c>=5&&e.jsx(L,{size:14,style:{color:"#dc2626"}}),e.jsx("span",{style:g,children:c===0?"Today":`${c}d`})]})}),e.jsx("td",{style:{padding:"0.75rem",textAlign:"right"},children:e.jsxs("button",{onClick:()=>y(i.action_url||"/"),style:{padding:"6px 12px",backgroundColor:"#3b82f6",color:"white",border:"none",borderRadius:"6px",cursor:"pointer",fontSize:"0.85rem",fontWeight:"500",display:"inline-flex",alignItems:"center",gap:"4px"},children:["Go ",e.jsx(ae,{size:14})]})})]},i.id)})})]})]},t)}),e.jsxs("div",{className:"card",style:{backgroundColor:"#f8fafc",marginTop:"1.5rem"},children:[e.jsx("h4",{style:{marginBottom:"0.75rem"},children:"ðŸ“Š Understanding This View"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:"1rem",fontSize:"0.9rem",color:"#64748b"},children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Days Pending:"})," How long the action has been waiting"]}),e.jsxs("div",{children:[e.jsx("strong",{style:{color:"#dc2626"},children:"Urgent (5+ days):"})," Requires immediate attention"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Assigned To:"})," The role/person responsible for this action"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Go:"})," Navigate to the item to take action"]})]}),e.jsxs("div",{style:{marginTop:"1rem",padding:"0.75rem",backgroundColor:"#f0fdf4",borderRadius:"6px",fontSize:"0.85rem",color:"#166534"},children:[e.jsx("strong",{children:"Validation Rules:"}),e.jsxs("ul",{style:{margin:"0.5rem 0 0 1rem",paddingLeft:"0.5rem"},children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Timesheets:"})," Always validated by Customer PM (billable hours)"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Chargeable Expenses:"})," Validated by Customer PM"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Non-Chargeable Expenses:"})," Validated by Supplier PM"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Deliverables & Certificates:"})," Validated by Customer PM"]})]})]}),h(u)&&e.jsxs("div",{style:{marginTop:"1rem",padding:"0.75rem",backgroundColor:"#dbeafe",borderRadius:"6px",fontSize:"0.85rem",color:"#1e40af"},children:[e.jsx("strong",{children:"Note:"})," As ",P(u),", you can see all pending workflow items across the project."]})]}),e.jsx("style",{children:`
        .spinning {
          animation: spin 1s linear infinite;
        }
        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
      `})]})}export{he as default};
