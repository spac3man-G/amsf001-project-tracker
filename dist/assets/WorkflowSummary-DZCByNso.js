import{n as O,u as Z,j as e,L as J,s as f}from"./index-CmJB_GBp.js";import{r as h,d as K}from"./vendor-react-BUTV5ZEl.js";import{S as p}from"./StatCard-DUs7rA-H.js";import{P as Q}from"./PageHeader-C51tVEBz.js";import{$ as N,x as X,U as ee,R as te,p as E,o as I,F as M,l as $,a4 as B,aY as re,b as se,aZ as ie,w as ne}from"./vendor-icons-C6BNM9_X.js";import"./vendor-supabase-6faYzd5A.js";function ge(){const[W,T]=h.useState([]),[U,v]=h.useState(!0),[w,F]=h.useState("all"),[_,C]=h.useState(!1),[oe,L]=h.useState(null),b=K(),{effectiveRole:a,loading:S}=O(),{user:k}=Z(),z=k?.id||null,g=t=>["admin","supplier_pm","customer_pm"].includes(t),A=t=>{switch(t){case"admin":return"Admin";case"supplier_pm":return"Supplier PM";case"customer_pm":return"Customer PM";case"contributor":return"Contributor";case"viewer":return"Viewer";default:return t}};h.useEffect(()=>{if(S)return;if(a==="viewer"){alert("You do not have permission to view this page."),b("/");return}if(!k){b("/login");return}async function t(){try{const{data:i}=await f.from("projects").select("id").eq("reference","AMSF001").single();i&&L(i.id),await P(i?.id)}catch{v(!1)}}t()},[S,a,k,b]);async function P(t){C(!0);try{if(!z||!a){T([]),v(!1),C(!1);return}let i=[];const{data:o,error:n}=await f.from("timesheets").select("*").eq("status","Submitted");if(!n){if(o&&o.length>0){const s=[...new Set(o.map(r=>r.resource_id).filter(Boolean))];let l={};if(s.length>0){const{data:r}=await f.from("resources").select("id, name").in("id",s);r&&r.forEach(d=>{l[d.id]=d.name})}o.forEach(r=>{!g(a)&&r.user_id!==z||i.push({id:`ts-${r.id}`,reference_id:r.id,reference_type:"timesheet",category:"timesheet",title:"Timesheet Pending Approval",message:`${r.hours_worked||r.hours||0}h on ${new Date(r.work_date||r.date).toLocaleDateString("en-GB")}`,entityName:l[r.resource_id]||"Unknown Resource",submitterName:"",created_at:r.updated_at||r.created_at,action_url:"/timesheets",action_label:"Review Timesheet",assignedTo:{role:"customer_pm",label:"Customer PM",color:"#d97706",bg:"#fef3c7"},itemDetails:r})})}}const{data:c,error:R}=await f.from("expenses").select("*").eq("status","Submitted");R||c&&c.length>0&&c.forEach(s=>{if(!g(a)&&s.created_by!==z)return;const l=s.chargeable_to_customer!==!1,r=l?{role:"customer_pm",label:"Customer PM",color:"#d97706",bg:"#fef3c7"}:{role:"supplier_pm",label:"Supplier PM",color:"#0891b2",bg:"#cffafe"};i.push({id:`exp-${s.id}`,reference_id:s.id,reference_type:"expense",category:"expense",title:"Expense Pending Validation",message:`${s.category}: Â£${parseFloat(s.amount||0).toFixed(2)} - ${s.reason||"No description"}`,entityName:s.resource_name||"Unknown Resource",submitterName:"",created_at:s.updated_at||s.created_at,action_url:"/expenses",action_label:"Review Expense",assignedTo:r,itemDetails:s,isChargeable:l})});const{data:m,error:G}=await f.from("deliverables").select("*").eq("status","Submitted");G||m&&m.length>0&&m.forEach(s=>{i.push({id:`del-${s.id}`,reference_id:s.id,reference_type:"deliverable",category:"deliverable",title:"Deliverable Pending Review",message:s.name,entityName:`${s.deliverable_ref}: ${s.name}`,submitterName:"",created_at:s.updated_at||s.created_at,action_url:"/deliverables",action_label:"Review Deliverable",assignedTo:{role:"customer_pm",label:"Customer PM",color:"#d97706",bg:"#fef3c7"},itemDetails:s})});const{data:j,error:H}=await f.from("milestone_certificates").select("*").eq("status","Submitted");if(!H){if(j&&j.length>0){const s=[...new Set(j.map(r=>r.milestone_id).filter(Boolean))];let l={};if(s.length>0){const{data:r}=await f.from("milestones").select("id, milestone_ref, name").in("id",s);r&&r.forEach(d=>{l[d.id]=d})}j.forEach(r=>{const d=l[r.milestone_id]||{};i.push({id:`cert-${r.id}`,reference_id:r.id,reference_type:"milestone_certificate",category:"certificate",title:"Certificate Pending Approval",message:`${d.milestone_ref||"Unknown"}: ${d.name||"Unknown Milestone"}`,entityName:`${d.milestone_ref||"Unknown"}: ${d.name||"Unknown Milestone"}`,submitterName:"",created_at:r.updated_at||r.created_at,action_url:"/milestones",action_label:"Review Certificate",assignedTo:{role:"customer_pm",label:"Customer PM",color:"#d97706",bg:"#fef3c7"},itemDetails:r})})}}i.sort((s,l)=>new Date(l.created_at)-new Date(s.created_at)),T(i)}catch{}finally{v(!1),C(!1)}}const V=t=>{switch(t){case"timesheet":return e.jsx(E,{size:18});case"expense":return e.jsx(I,{size:18});case"deliverable":return e.jsx(M,{size:18});case"certificate":return e.jsx($,{size:18});default:return e.jsx(N,{size:18})}},q=t=>{switch(t){case"timesheet":return{bg:"#dbeafe",text:"#1e40af",border:"#93c5fd"};case"expense":return{bg:"#dcfce7",text:"#166534",border:"#86efac"};case"deliverable":return{bg:"#fef3c7",text:"#92400e",border:"#fcd34d"};case"certificate":return{bg:"#f3e8ff",text:"#6b21a8",border:"#d8b4fe"};default:return{bg:"#f1f5f9",text:"#475569",border:"#cbd5e1"}}},D=t=>{const i=new Date(t),n=new Date-i;return Math.floor(n/864e5)},Y=t=>t>=5?{color:"#dc2626",fontWeight:"600"}:t>=3?{color:"#f59e0b",fontWeight:"500"}:{color:"#64748b"},y=W.filter(t=>!(w!=="all"&&t.category!==w)),x=y.reduce((t,i)=>{const o=i.category;return t[o]||(t[o]=[]),t[o].push(i),t},{}),u={total:y.length,timesheets:(x.timesheet||[]).length,expenses:(x.expense||[]).length,deliverables:(x.deliverable||[]).length,certificates:(x.certificate||[]).length,urgent:y.filter(t=>D(t.created_at)>=5).length};return U||S?e.jsx(J,{message:"Loading workflow summary...",size:"large",fullPage:!0}):e.jsxs("div",{className:"page-container",children:[e.jsxs(Q,{icon:N,title:"Workflow Summary",subtitle:g(a)?"All pending actions across the project":"Your pending workflow actions",children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.5rem 1rem",backgroundColor:"#f1f5f9",borderRadius:"8px",fontSize:"0.85rem"},children:[g(a)?e.jsx(X,{size:16}):e.jsx(ee,{size:16}),e.jsxs("span",{children:["Viewing as: ",e.jsx("strong",{children:A(a)})]})]}),e.jsxs("button",{className:"btn btn-secondary",onClick:()=>P(),disabled:_,children:[e.jsx(te,{size:18,className:_?"spinning":""}),_?"Refreshing...":"Refresh"]})]}),e.jsxs("div",{className:"stats-grid",style:{marginBottom:"1.5rem",gridTemplateColumns:"repeat(6, 1fr)"},children:[e.jsx(p,{icon:N,label:"Total Pending",value:u.total,color:"#64748b"}),e.jsx(p,{icon:E,label:"Timesheets",value:u.timesheets,color:"#3b82f6"}),e.jsx(p,{icon:I,label:"Expenses",value:u.expenses,color:"#10b981"}),e.jsx(p,{icon:M,label:"Deliverables",value:u.deliverables,color:"#f59e0b"}),e.jsx(p,{icon:$,label:"Certificates",value:u.certificates,color:"#8b5cf6"}),e.jsx(p,{icon:B,label:"Urgent (5+ days)",value:u.urgent,color:"#dc2626"})]}),e.jsx("div",{className:"card",style:{marginBottom:"1.5rem"},children:e.jsxs("div",{style:{display:"flex",gap:"1rem",alignItems:"center",flexWrap:"wrap"},children:[e.jsx(re,{size:18,style:{color:"#64748b"}}),e.jsx("span",{style:{fontWeight:"500"},children:"Filter:"}),e.jsxs("select",{value:w,onChange:t=>F(t.target.value),style:{padding:"0.5rem",borderRadius:"6px",border:"1px solid #d1d5db"},children:[e.jsx("option",{value:"all",children:"All Categories"}),e.jsx("option",{value:"timesheet",children:"Timesheets"}),e.jsx("option",{value:"expense",children:"Expenses"}),e.jsx("option",{value:"deliverable",children:"Deliverables"}),e.jsx("option",{value:"certificate",children:"Certificates"})]})]})}),y.length===0?e.jsxs("div",{className:"card",style:{textAlign:"center",padding:"3rem"},children:[e.jsx(se,{size:48,style:{color:"#10b981",marginBottom:"1rem"}}),e.jsx("h3",{style:{margin:"0 0 0.5rem"},children:"All Clear!"}),e.jsx("p",{style:{color:"#64748b",margin:0},children:g(a)?"No pending workflow actions across the project.":"You have no pending workflow actions."})]}):Object.entries(x).map(([t,i])=>{const o=q(t);return e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem",marginBottom:"1rem",paddingBottom:"0.75rem",borderBottom:`2px solid ${o.border}`},children:[e.jsx("div",{style:{width:"40px",height:"40px",borderRadius:"10px",backgroundColor:o.bg,display:"flex",alignItems:"center",justifyContent:"center",color:o.text},children:V(t)}),e.jsxs("div",{children:[e.jsx("h3",{style:{margin:0,textTransform:"capitalize"},children:t==="certificate"?"Milestone Certificates":`${t}s`}),e.jsxs("span",{style:{fontSize:"0.85rem",color:"#64748b"},children:[i.length," pending action",i.length!==1?"s":""]})]})]}),e.jsxs("table",{style:{width:"100%",borderCollapse:"collapse"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:{textAlign:"left",padding:"0.75rem",borderBottom:"1px solid #e2e8f0",fontSize:"0.85rem",fontWeight:"600",color:"#64748b"},children:"Item"}),e.jsx("th",{style:{textAlign:"left",padding:"0.75rem",borderBottom:"1px solid #e2e8f0",fontSize:"0.85rem",fontWeight:"600",color:"#64748b"},children:"Action Required"}),e.jsx("th",{style:{textAlign:"left",padding:"0.75rem",borderBottom:"1px solid #e2e8f0",fontSize:"0.85rem",fontWeight:"600",color:"#64748b"},children:"Assigned To"}),e.jsx("th",{style:{textAlign:"center",padding:"0.75rem",borderBottom:"1px solid #e2e8f0",fontSize:"0.85rem",fontWeight:"600",color:"#64748b"},children:"Days Pending"}),e.jsx("th",{style:{textAlign:"right",padding:"0.75rem",borderBottom:"1px solid #e2e8f0",fontSize:"0.85rem",fontWeight:"600",color:"#64748b"},children:"Action"})]})}),e.jsx("tbody",{children:i.map(n=>{const c=D(n.created_at),R=Y(c),m=n.assignedTo;return e.jsxs("tr",{style:{borderBottom:"1px solid #f1f5f9"},children:[e.jsxs("td",{style:{padding:"0.75rem"},children:[e.jsx("div",{style:{fontWeight:"500"},children:n.entityName||"Unknown"}),e.jsx("div",{style:{fontSize:"0.8rem",color:"#64748b"},children:n.message}),n.submitterName&&e.jsxs("div",{style:{fontSize:"0.75rem",color:"#9ca3af",marginTop:"0.25rem"},children:["Submitted by: ",n.submitterName]})]}),e.jsxs("td",{style:{padding:"0.75rem"},children:[e.jsx("span",{style:{padding:"4px 10px",backgroundColor:o.bg,color:o.text,borderRadius:"12px",fontSize:"0.8rem",fontWeight:"500"},children:n.action_label||n.title}),n.category==="expense"&&e.jsx("div",{style:{fontSize:"0.7rem",marginTop:"0.25rem",color:n.isChargeable?"#10b981":"#f59e0b"},children:n.isChargeable?"âœ“ Chargeable":"âœ— Non-chargeable"})]}),e.jsx("td",{style:{padding:"0.75rem"},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(ie,{size:14,style:{color:m.color}}),e.jsx("span",{style:{padding:"4px 10px",backgroundColor:m.bg,color:m.color,borderRadius:"6px",fontSize:"0.85rem",fontWeight:"500"},children:m.label})]})}),e.jsx("td",{style:{padding:"0.75rem",textAlign:"center"},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"0.5rem"},children:[c>=5&&e.jsx(B,{size:14,style:{color:"#dc2626"}}),e.jsx("span",{style:R,children:c===0?"Today":`${c}d`})]})}),e.jsx("td",{style:{padding:"0.75rem",textAlign:"right"},children:e.jsxs("button",{onClick:()=>b(n.action_url||"/"),style:{padding:"6px 12px",backgroundColor:"#3b82f6",color:"white",border:"none",borderRadius:"6px",cursor:"pointer",fontSize:"0.85rem",fontWeight:"500",display:"inline-flex",alignItems:"center",gap:"4px"},children:["Go ",e.jsx(ne,{size:14})]})})]},n.id)})})]})]},t)}),e.jsxs("div",{className:"card",style:{backgroundColor:"#f8fafc",marginTop:"1.5rem"},children:[e.jsx("h4",{style:{marginBottom:"0.75rem"},children:"ðŸ“Š Understanding This View"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:"1rem",fontSize:"0.9rem",color:"#64748b"},children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Days Pending:"})," How long the action has been waiting"]}),e.jsxs("div",{children:[e.jsx("strong",{style:{color:"#dc2626"},children:"Urgent (5+ days):"})," Requires immediate attention"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Assigned To:"})," The role/person responsible for this action"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Go:"})," Navigate to the item to take action"]})]}),e.jsxs("div",{style:{marginTop:"1rem",padding:"0.75rem",backgroundColor:"#f0fdf4",borderRadius:"6px",fontSize:"0.85rem",color:"#166534"},children:[e.jsx("strong",{children:"Validation Rules:"}),e.jsxs("ul",{style:{margin:"0.5rem 0 0 1rem",paddingLeft:"0.5rem"},children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Timesheets:"})," Always validated by Customer PM (billable hours)"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Chargeable Expenses:"})," Validated by Customer PM"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Non-Chargeable Expenses:"})," Validated by Supplier PM"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Deliverables & Certificates:"})," Validated by Customer PM"]})]})]}),g(a)&&e.jsxs("div",{style:{marginTop:"1rem",padding:"0.75rem",backgroundColor:"#dbeafe",borderRadius:"6px",fontSize:"0.85rem",color:"#1e40af"},children:[e.jsx("strong",{children:"Note:"})," As ",A(a),", you can see all pending workflow items across the project."]})]}),e.jsx("style",{children:`
        .spinning {
          animation: spin 1s linear infinite;
        }
        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
      `})]})}export{ge as default};
