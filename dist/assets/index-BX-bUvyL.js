const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ResetPassword-B1fBhjLO.js","assets/vendor-react-JFEV0ROX.js","assets/vendor-icons-MGuLpNnD.js","assets/vendor-supabase-DgEUAXvv.js","assets/Milestones-Bwnk3v40.js","assets/usePermissions-DHSqJAr9.js","assets/StatCard-C9noyKqB.js","assets/PageHeader-BL-2WquG.js","assets/ConfirmDialog-8gnQIa-j.js","assets/MilestoneDetail-DthUmTX7.js","assets/Gantt-DJJ1Wdge.js","assets/Deliverables-B_uj34vU.js","assets/Resources-wSjh1-HU.js","assets/ResourceDetail-DM_NAGUf.js","assets/Partners-CpPfJLGB.js","assets/PartnerDetail-BjF-IDW5.js","assets/Timesheets-Bo_cL8Ah.js","assets/Expenses-BnJq7uCq.js","assets/Expenses-OWLTi329.css","assets/KPIs-Dvi0D2Yw.js","assets/KPIDetail-BBsfvre6.js","assets/QualityStandards-WGMpxWPX.js","assets/QualityStandardDetail-Dl8446zP.js","assets/Reports-BxT7KBIE.js","assets/Users-xdr4tNM3.js","assets/Settings-B_ZnLyFS.js","assets/AccountSettings-BXT5kKaH.js","assets/WorkflowSummary-iVxYBk_n.js","assets/AuditLog-CHXHMUuE.js","assets/DeletedItems-CtVo5uK2.js"])))=>i.map(i=>d[i]);
var Pt=Object.defineProperty;var Nt=(i,t,e)=>t in i?Pt(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var ve=(i,t,e)=>Nt(i,typeof t!="symbol"?t+"":t,e);import{r as d,a as It,R as rt,u as ce,b as At,L as Ue,c as Dt,B as Mt,d as Tt,e as O,N as Ne,O as qt}from"./vendor-react-JFEV0ROX.js";import{c as Ot}from"./vendor-supabase-DgEUAXvv.js";import{A as st,R as le,I as Lt,X as at,C as qe,a as ae,M as zt,S as Bt,B as Se,D as Ut,T as Wt,U as $t,b as Ft,c as nt,d as Vt,L as Ht,e as Kt,f as Gt,g as je,h as Qt,i as it,F as Oe,j as ot,k as de,l as Yt,H as Xt,m as Jt,n as Zt,o as er,p as tr,q as rr,P as Ie,r as Ae,G as sr,s as ar,t as nr,u as ir,v as or,w as lt,x as lr,K as cr,y as Ce,z as Ee,E as ct,J as dr}from"./vendor-icons-MGuLpNnD.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function e(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerPolicy&&(n.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?n.credentials="include":a.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function r(a){if(a.ep)return;a.ep=!0;const n=e(a);fetch(a.href,n)}})();var dt={exports:{}},ge={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var ur=d,hr=Symbol.for("react.element"),mr=Symbol.for("react.fragment"),fr=Object.prototype.hasOwnProperty,pr=ur.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,gr={key:!0,ref:!0,__self:!0,__source:!0};function ut(i,t,e){var r,a={},n=null,o=null;e!==void 0&&(n=""+e),t.key!==void 0&&(n=""+t.key),t.ref!==void 0&&(o=t.ref);for(r in t)fr.call(t,r)&&!gr.hasOwnProperty(r)&&(a[r]=t[r]);if(i&&i.defaultProps)for(r in t=i.defaultProps,t)a[r]===void 0&&(a[r]=t[r]);return{$$typeof:hr,type:i,key:n,ref:o,props:a,_owner:pr.current}}ge.Fragment=mr;ge.jsx=ut;ge.jsxs=ut;dt.exports=ge;var s=dt.exports,De={},We=It;De.createRoot=We.createRoot,De.hydrateRoot=We.hydrateRoot;const yr="modulepreload",_r=function(i){return"/"+i},$e={},B=function(t,e,r){let a=Promise.resolve();if(e&&e.length>0){document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),c=o?.nonce||o?.getAttribute("nonce");a=Promise.allSettled(e.map(l=>{if(l=_r(l),l in $e)return;$e[l]=!0;const h=l.endsWith(".css"),m=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${m}`))return;const g=document.createElement("link");if(g.rel=h?"stylesheet":yr,h||(g.as="script"),g.crossOrigin="",g.href=l,c&&g.setAttribute("nonce",c),document.head.appendChild(g),h)return new Promise((p,_)=>{g.addEventListener("load",p),g.addEventListener("error",()=>_(new Error(`Unable to preload CSS for ${l}`)))})}))}function n(o){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=o,window.dispatchEvent(c),!c.defaultPrevented)throw o}return a.then(o=>{for(const c of o||[])c.status==="rejected"&&n(c.reason);return t().catch(n)})};var Fe={},xr="@vercel/analytics",wr="1.6.0",br=()=>{window.va||(window.va=function(...t){(window.vaq=window.vaq||[]).push(t)})};function ht(){return typeof window<"u"}function mt(){try{const i="production"}catch{}return"production"}function vr(i="auto"){if(i==="auto"){window.vam=mt();return}window.vam=i}function Sr(){return(ht()?window.vam:mt())||"production"}function Me(){return Sr()==="development"}function jr(i){return i.scriptSrc?i.scriptSrc:Me()?"https://va.vercel-scripts.com/v1/script.debug.js":i.basePath?`${i.basePath}/insights/script.js`:"/_vercel/insights/script.js"}function Cr(i={debug:!0}){var t;if(!ht())return;vr(i.mode),br(),i.beforeSend&&((t=window.va)==null||t.call(window,"beforeSend",i.beforeSend));const e=jr(i);if(document.head.querySelector(`script[src*="${e}"]`))return;const r=document.createElement("script");r.src=e,r.defer=!0,r.dataset.sdkn=xr+(i.framework?`/${i.framework}`:""),r.dataset.sdkv=wr,i.disableAutoTrack&&(r.dataset.disableAutoTrack="1"),i.endpoint?r.dataset.endpoint=i.endpoint:i.basePath&&(r.dataset.endpoint=`${i.basePath}/insights`),i.dsn&&(r.dataset.dsn=i.dsn),r.onerror=()=>{const a=Me()?"Please check if any ad blockers are enabled and try again.":"Be sure to enable Web Analytics for your project and deploy again. See https://vercel.com/docs/analytics/quickstart for more information."},Me()&&i.debug===!1&&(r.dataset.debug="false"),document.head.appendChild(r)}function Er({route:i,path:t}){var e;(e=window.va)==null||e.call(window,"pageview",{route:i,path:t})}function kr(){if(!(typeof process>"u"||typeof Fe>"u"))return Fe.REACT_APP_VERCEL_OBSERVABILITY_BASEPATH}function Rr(i){return d.useEffect(()=>{var t;i.beforeSend&&((t=window.va)==null||t.call(window,"beforeSend",i.beforeSend))},[i.beforeSend]),d.useEffect(()=>{Cr({framework:i.framework||"react",basePath:i.basePath??kr(),...i.route!==void 0&&{disableAutoTrack:!0},...i})},[]),d.useEffect(()=>{i.route&&i.path&&Er({route:i.route,path:i.path})},[i.route,i.path]),null}var Ve={},Pr="@vercel/speed-insights",Nr="1.2.0",Ir=()=>{window.si||(window.si=function(...t){(window.siq=window.siq||[]).push(t)})};function Ar(){return typeof window<"u"}function Dr(){try{const i="production"}catch{}return"production"}function ft(){return Dr()==="development"}function Mr(i){return i.scriptSrc?i.scriptSrc:ft()?"https://va.vercel-scripts.com/v1/speed-insights/script.debug.js":i.dsn?"https://va.vercel-scripts.com/v1/speed-insights/script.js":i.basePath?`${i.basePath}/speed-insights/script.js`:"/_vercel/speed-insights/script.js"}function Tr(i={}){var t;if(!Ar()||i.route===null)return null;Ir();const e=Mr(i);if(document.head.querySelector(`script[src*="${e}"]`))return null;i.beforeSend&&((t=window.si)==null||t.call(window,"beforeSend",i.beforeSend));const r=document.createElement("script");return r.src=e,r.defer=!0,r.dataset.sdkn=Pr+(i.framework?`/${i.framework}`:""),r.dataset.sdkv=Nr,i.sampleRate&&(r.dataset.sampleRate=i.sampleRate.toString()),i.route&&(r.dataset.route=i.route),i.endpoint?r.dataset.endpoint=i.endpoint:i.basePath&&(r.dataset.endpoint=`${i.basePath}/speed-insights/vitals`),i.dsn&&(r.dataset.dsn=i.dsn),ft()&&i.debug===!1&&(r.dataset.debug="false"),r.onerror=()=>{},document.head.appendChild(r),{setRoute:a=>{r.dataset.route=a??void 0}}}function qr(){if(!(typeof process>"u"||typeof Ve>"u"))return Ve.REACT_APP_VERCEL_OBSERVABILITY_BASEPATH}function Or(i){d.useEffect(()=>{var e;i.beforeSend&&((e=window.si)==null||e.call(window,"beforeSend",i.beforeSend))},[i.beforeSend]);const t=d.useRef(null);return d.useEffect(()=>{if(t.current)i.route&&t.current(i.route);else{const e=Tr({framework:i.framework??"react",basePath:i.basePath??qr(),...i});e&&(t.current=e.setRoute)}},[i.route]),null}const Lr=void 0,zr=void 0;throw new Error("Missing Supabase environment variables");const f=Ot(Lr,zr),pt=d.createContext(null),Br=60*1e3,Ur=5*60*1e3;function Wr({children:i}){const[t,e]=d.useState(null),[r,a]=d.useState(null),[n,o]=d.useState(null),[c,l]=d.useState(!0),[h,m]=d.useState(null),[g,p]=d.useState(!1),_=d.useRef(null),x=d.useRef(Date.now()),u=d.useCallback(()=>{x.current=Date.now()},[]);async function v(S){if(!S){a(null),o(null);return}try{const{data:j,error:M}=await f.from("profiles").select("*").eq("id",S.id).single();if(M){m(M);return}a(j);const{data:A}=await f.from("resources").select("*").eq("user_id",S.id).maybeSingle();o(A),m(null)}catch(j){m(j)}}const P=d.useCallback(async()=>{try{const{data:{session:S},error:j}=await f.auth.getSession();if(j)return;if(!S){await q();return}const M=S.expires_at*1e3,A=Date.now(),N=M-A;if(N<=0)await q();else if(N<=Ur){p(!0);const{data:V,error:J}=await f.auth.refreshSession();J||!V.session||p(!1)}else p(!1)}catch{}},[]);async function q(){e(null),a(null),o(null),p(!1),await f.auth.signOut();const S=window.location.pathname;S!=="/login"&&S!=="/register"&&(window.location.href="/login?expired=true")}const I=d.useCallback(()=>{_.current&&clearInterval(_.current),_.current=setInterval(()=>{P()},Br);const S=()=>{document.visibilityState==="visible"&&P()};document.addEventListener("visibilitychange",S);const j=["mousedown","keydown","touchstart","scroll"];return j.forEach(M=>{document.addEventListener(M,u,{passive:!0})}),()=>{_.current&&clearInterval(_.current),document.removeEventListener("visibilitychange",S),j.forEach(M=>{document.removeEventListener(M,u)})}},[P,u]);d.useEffect(()=>{let S=!0,j=null;async function M(){try{const{data:{session:N},error:V}=await f.auth.getSession();V&&S&&m(V),S&&(e(N?.user??null),l(!1),N?.user&&(v(N.user),j=I()))}catch(N){S&&(m(N),l(!1))}}M();const{data:{subscription:A}}=f.auth.onAuthStateChange(async(N,V)=>{S&&(e(V?.user??null),l(!1),V?.user?(v(V.user),j&&j(),j=I()):(a(null),o(null),j&&(j(),j=null)),(N==="SIGNED_OUT"||N==="TOKEN_REFRESHED")&&p(!1))});return()=>{S=!1,A.unsubscribe(),j&&j()}},[I]);async function b(){try{await f.auth.signOut(),e(null),a(null),o(null),p(!1)}catch(S){m(S)}}async function C(){t&&await v(t)}async function k(){try{const{data:S,error:j}=await f.auth.refreshSession();return j?!1:S.session?(p(!1),!0):!1}catch{return!1}}const E={user:t,profile:r,role:r?.role||"viewer",linkedResource:n,isLoading:c,error:h,signOut:b,refreshUserData:C,refreshSession:k,isAuthenticated:!!t,sessionExpiring:g};return s.jsx(pt.Provider,{value:E,children:i})}function ye(){const i=d.useContext(pt);if(!i)throw new Error("useAuth must be used within an AuthProvider");return i}const gt=d.createContext(null);function $r({children:i}){const[t,e]=d.useState(null),[r,a]=d.useState(!0),[n,o]=d.useState(null);d.useEffect(()=>{let m=!0;async function g(){try{const{data:p,error:_}=await f.from("projects").select("*").eq("reference","AMSF001").single();_?m&&o(_):m&&(e(p),o(null))}catch(p){m&&o(p)}finally{m&&a(!1)}}return g(),()=>{m=!1}},[]);async function c(m){a(!0),o(null);try{const{data:g,error:p}=await f.from("projects").select("*").eq("reference",m).single();p?o(p):e(g)}catch(g){o(g)}finally{a(!1)}}async function l(){if(t)try{const{data:m,error:g}=await f.from("projects").select("*").eq("id",t.id).single();g?o(g):e(m)}catch(m){o(m)}}const h={currentProject:t,projectId:t?.id||null,projectRef:t?.reference||null,projectName:t?.name||null,isLoading:r,error:n,switchProject:c,refreshProject:l};return s.jsx(gt.Provider,{value:h,children:i})}function ue(){const i=d.useContext(gt);if(!i)throw new Error("useProject must be used within a ProjectProvider");return i}const yt=d.createContext();function Fr({children:i}){const[t,e]=d.useState(!1),[r,a]=d.useState(null),[n,o]=d.useState([]);d.useEffect(()=>{c(),l()},[]);async function c(){const{data:{user:u}}=await f.auth.getUser();if(u){const{data:v}=await f.from("profiles").select("role").eq("id",u.id).single();v&&a(v.role)}}async function l(){const{data:u}=await f.from("profiles").select("id").eq("is_test_user",!0);u&&o(u.map(v=>v.id))}const h=r==="admin"||r==="supplier_pm";function m(){h&&e(u=>!u)}function g(u){return n.includes(u)}function p(u,v="user_id"){return!u||t?u:u.filter(P=>!n.includes(P[v]))}function _(u){return!u||t?u:u.filter(v=>!v.is_test_content)}const x={showTestUsers:t,setShowTestUsers:e,toggleTestUsers:m,canToggleTestUsers:h,testUserIds:n,isTestUser:g,filterTestContent:p,filterByTestFlag:_,userRole:r};return s.jsx(yt.Provider,{value:x,children:i})}function _t(){const i=d.useContext(yt);if(!i)throw new Error("useTestUsers must be used within a TestUserProvider");return i}const xt=d.createContext();function Vr(){return d.useContext(xt)}function Hr({children:i}){const[t,e]=d.useState([]),[r,a]=d.useState(0),[n,o]=d.useState(0),[c,l]=d.useState(!0),[h,m]=d.useState(null),[g,p]=d.useState(null),_=C=>["admin","supplier_pm","customer_pm"].includes(C),x=d.useCallback(async(C,k)=>{try{let E=[];if(_(k)){const{data:S}=await f.from("timesheets").select("id, hours_worked, hours, work_date, date").eq("status","Submitted"),{data:j}=await f.from("expenses").select("id, amount, category, reason, resource_name, chargeable_to_customer").eq("status","Submitted"),{data:M}=await f.from("deliverables").select("id, name, deliverable_ref").eq("status","Submitted"),{data:A}=await f.from("milestone_certificates").select("id, milestone_id").eq("status","Submitted");S&&S.forEach(N=>{E.push({id:`ts-${N.id}`,type:"timesheet",notification_type:"action",title:"Timesheet Submitted",message:`Timesheet (${N.hours_worked||N.hours||0}h) pending approval`,action_url:"/timesheets",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1})}),j&&j.forEach(N=>{const V=N.chargeable_to_customer!==!1;E.push({id:`exp-${N.id}`,type:"expense",notification_type:"action",title:"Expense Submitted",message:`${N.resource_name||"Unknown"} expense (Â£${parseFloat(N.amount||0).toFixed(2)}) pending validation`,action_url:"/expenses",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1,isChargeable:V})}),M&&M.forEach(N=>{E.push({id:`del-${N.id}`,type:"deliverable",notification_type:"action",title:"Deliverable Submitted",message:`${N.deliverable_ref}: ${N.name} pending review`,action_url:"/deliverables",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1})}),A&&A.forEach(N=>{E.push({id:`cert-${N.id}`,type:"certificate",notification_type:"action",title:"Certificate Submitted",message:"Milestone certificate pending approval",action_url:"/milestones",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1})})}else{const{data:S}=await f.from("timesheets").select("id, hours_worked, hours, work_date, date, resource_id").eq("status","Submitted").eq("user_id",C),{data:j}=await f.from("expenses").select("id, amount, category, reason, resource_name").eq("status","Submitted").eq("created_by",C);S&&S.forEach(M=>{E.push({id:`ts-${M.id}`,type:"timesheet",notification_type:"action",title:"Timesheet Submitted",message:`Your timesheet for ${M.hours_worked||M.hours||0}h is pending approval`,action_url:"/timesheets",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1})}),j&&j.forEach(M=>{E.push({id:`exp-${M.id}`,type:"expense",notification_type:"action",title:"Expense Submitted",message:`Your expense (Â£${parseFloat(M.amount||0).toFixed(2)}) is pending validation`,action_url:"/expenses",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1})})}return{count:E.length,items:E}}catch{return{count:0,items:[]}}},[]),u=d.useCallback(async()=>{try{const{data:{user:C}}=await f.auth.getUser();if(!C){e([]),a(0),o(0),l(!1);return}m(C.id);const{data:k}=await f.from("profiles").select("role").eq("id",C.id).single(),E=k?.role||"viewer";p(E);const{count:S,items:j}=await x(C.id,E);e(j),a(S),o(S)}catch{}finally{l(!1)}},[x]),v=d.useCallback(async C=>{e(k=>k.map(E=>E.id===C?{...E,is_read:!0}:E)),a(k=>Math.max(0,k-1))},[]),P=d.useCallback(async C=>{e(k=>k.map(E=>E.id===C?{...E,is_actioned:!0,is_read:!0}:E)),a(k=>Math.max(0,k-1)),o(k=>Math.max(0,k-1))},[]),q=d.useCallback(async()=>{e(C=>C.map(k=>({...k,is_read:!0}))),a(0)},[]),I=d.useCallback(async C=>{const k=t.find(E=>E.id===C);k&&(e(E=>E.filter(S=>S.id!==C)),k.is_read||a(E=>Math.max(0,E-1)),k.notification_type==="action"&&!k.is_actioned&&o(E=>Math.max(0,E-1)))},[t]);d.useEffect(()=>{u();const C=setInterval(()=>{u()},3e4);return()=>clearInterval(C)},[u]),d.useEffect(()=>{const{data:{subscription:C}}=f.auth.onAuthStateChange((k,E)=>{k==="SIGNED_IN"?u():k==="SIGNED_OUT"&&(e([]),a(0),o(0),m(null),p(null))});return()=>C.unsubscribe()},[u]);const b={notifications:t,unreadCount:r,actionCount:n,loading:c,fetchNotifications:u,markAsRead:v,markAsActioned:P,markAllAsRead:q,dismissNotification:I};return s.jsx(xt.Provider,{value:b,children:i})}const wt=d.createContext(null),Le="amsf-chat-history",Kr=50,ke={maxRetries:2,baseDelayMs:1e3,retryableCodes:[429,503,504]};function Gr(){try{const i=localStorage.getItem(Le);if(i){const t=JSON.parse(i);return{messages:t.messages||[],tokenUsage:t.tokenUsage||{input:0,output:0,requests:0}}}}catch{}return{messages:[],tokenUsage:{input:0,output:0,requests:0}}}function Qr(i,t){try{const e=i.slice(-Kr);localStorage.setItem(Le,JSON.stringify({messages:e,tokenUsage:t,savedAt:new Date().toISOString()}))}catch{}}function Yr({children:i}){const{user:t,profile:e,linkedResource:r,role:a}=ye(),{projectId:n,projectName:o,projectRef:c,currentProject:l}=ue(),h=Gr(),[m,g]=d.useState(!1),[p,_]=d.useState(h.messages),[x,u]=d.useState(!1),[v,P]=d.useState(null),[q,I]=d.useState(0),[b,C]=d.useState(h.tokenUsage),k=d.useRef(null);d.useEffect(()=>{(p.length>0||b.requests>0)&&Qr(p,b)},[p,b]);const E=d.useCallback(()=>l?{id:n,reference:c||l?.reference,name:o||l?.name,description:l?.description||null}:null,[l,n,c,o]),S=d.useCallback(()=>({name:e?.full_name||t?.email?.split("@")[0]||"User",email:t?.email,role:a||e?.role||"unknown",linkedResourceName:r?.name||null,linkedResourceId:r?.id||null,partnerId:r?.partner_id||null,partnerName:r?.partners?.name||null}),[t,e,r,a]),j=async(W,$=1)=>{k.current=new AbortController;try{const D=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(W),signal:k.current.signal}),w=await D.json().catch(()=>({}));if(!D.ok){if(ke.retryableCodes.includes(D.status)&&$<=ke.maxRetries&&w.recoverable!==!1){const K=w.retryAfter?w.retryAfter*1e3:ke.baseDelayMs*Math.pow(2,$-1);return I($),await new Promise(F=>setTimeout(F,K)),j(W,$+1)}throw new Error(w.error||`Request failed (${D.status})`)}return I(0),w}catch(D){throw D.name==="AbortError"?new Error("Request cancelled"):D}},M=d.useCallback(async W=>{if(!W.trim()||x)return;k.current&&k.current.abort();const $={role:"user",content:W.trim(),timestamp:new Date().toISOString()};_(D=>[...D,$]),u(!0),P(null),I(0);try{const D=E(),w=S(),L=[...p.slice(-9),$].map(F=>({role:F.role,content:F.content})),K=await j({messages:L,projectContext:D,userContext:w,projectId:n});K.usage&&C(F=>({input:F.input+(K.usage.input_tokens||0),output:F.output+(K.usage.output_tokens||0),requests:F.requests+1})),_(F=>[...F,{role:"assistant",content:K.message,toolsUsed:K.toolsUsed||!1,cached:K.cached||!1,timestamp:new Date().toISOString(),tokens:K.usage?{input:K.usage.input_tokens,output:K.usage.output_tokens}:null}])}catch(D){let w=D.message;D.message==="Request cancelled"?w=null:D.message.includes("Failed to fetch")&&(w="Unable to connect. Please check your internet connection."),w&&(P(w),_(L=>L.slice(0,-1)))}finally{u(!1),I(0)}},[p,x,E,S,n]),A=d.useCallback(()=>{k.current&&(k.current.abort(),u(!1),I(0))},[]),N=d.useCallback(()=>{A(),_([]),P(null),localStorage.removeItem(Le)},[A]),V=d.useCallback(()=>{N(),C({input:0,output:0,requests:0})},[N]),J=d.useCallback(()=>{g(W=>!W)},[]),se=d.useCallback(()=>{P(null)},[]),R=d.useCallback(()=>{if(p.length===0)return null;const W=S(),$=E();let D=`# Chat Export

`;return D+=`**Exported:** ${new Date().toLocaleString("en-GB")}
`,D+=`**User:** ${W.name} (${W.role})
`,$&&(D+=`**Project:** ${$.name} (${$.reference})
`),D+=`**Messages:** ${p.length}
`,D+=`**Token Usage:** ${b.input.toLocaleString()} input / ${b.output.toLocaleString()} output

`,D+=`---

`,p.forEach((w,L)=>{const K=w.role==="user"?"ðŸ‘¤ You":"ðŸ¤– Assistant",F=w.timestamp?new Date(w.timestamp).toLocaleTimeString("en-GB"):"";D+=`### ${K}${F?` (${F})`:""}

`,D+=`${w.content}

`,w.toolsUsed&&(D+=`*ðŸ“Š Queried project data*

`),L<p.length-1&&(D+=`---

`)}),D},[p,b,S,E]),U=d.useCallback(()=>{const W=R();if(!W)return;const $=new Blob([W],{type:"text/markdown"}),D=URL.createObjectURL($),w=document.createElement("a");w.href=D,w.download=`chat-export-${new Date().toISOString().split("T")[0]}.md`,document.body.appendChild(w),w.click(),document.body.removeChild(w),URL.revokeObjectURL(D)},[R]),Z=d.useCallback(async W=>{try{return await navigator.clipboard.writeText(W),!0}catch{return!1}},[]),X={isOpen:m,setIsOpen:g,toggleChat:J,messages:p,isLoading:x,error:v,retryCount:q,tokenUsage:b,sendMessage:M,clearChat:N,resetAllStats:V,cancelRequest:A,dismissError:se,exportChat:R,downloadChat:U,copyMessage:Z};return s.jsx(wt.Provider,{value:X,children:i})}function Xr(){const i=d.useContext(wt);if(!i)throw new Error("useChat must be used within a ChatProvider");return i}class Jr extends rt.Component{constructor(e){super(e);ve(this,"handleReload",()=>{window.location.reload()});ve(this,"handleReset",()=>{this.setState({hasError:!1,error:null,errorInfo:null})});this.state={hasError:!1,error:null,errorInfo:null}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,r){this.setState({errorInfo:r})}render(){return this.state.hasError?this.props.fallback?this.props.fallback:s.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"3rem",backgroundColor:"#fef2f2",borderRadius:"12px",margin:"1rem",border:"1px solid #fecaca"},children:[s.jsx(st,{size:48,style:{color:"#dc2626",marginBottom:"1rem"}}),s.jsx("h2",{style:{color:"#991b1b",margin:"0 0 0.5rem 0",fontSize:"1.25rem",fontWeight:"600"},children:"Something went wrong"}),s.jsx("p",{style:{color:"#64748b",margin:"0 0 1.5rem 0",textAlign:"center",maxWidth:"400px"},children:this.state.error?.message||"An unexpected error occurred. Please try again."}),s.jsxs("div",{style:{display:"flex",gap:"0.75rem"},children:[s.jsx("button",{onClick:this.handleReset,style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.625rem 1.25rem",backgroundColor:"white",color:"#374151",border:"1px solid #d1d5db",borderRadius:"8px",cursor:"pointer",fontSize:"0.875rem",fontWeight:"500"},children:"Try Again"}),s.jsxs("button",{onClick:this.handleReload,style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.625rem 1.25rem",backgroundColor:"#3b82f6",color:"white",border:"none",borderRadius:"8px",cursor:"pointer",fontSize:"0.875rem",fontWeight:"500"},children:[s.jsx(le,{size:16}),"Reload Page"]})]})]}):this.props.children}}function bt({message:i,size:t="medium",fullPage:e=!1,className:r=""}){const a={small:"spinner-sm",medium:"",large:"spinner-lg"};return s.jsxs("div",{className:`loading-spinner ${r}`,style:e?{minHeight:"60vh"}:void 0,children:[s.jsx("div",{className:`spinner ${a[t]}`}),i&&s.jsx("p",{className:"loading-text",children:i})]})}const Zr={background:"linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%)",backgroundSize:"200% 100%",animation:"shimmer 1.5s infinite"};function G({width:i="100%",height:t="1rem",style:e={},className:r=""}){return s.jsxs(s.Fragment,{children:[s.jsx("style",{children:`
        @keyframes shimmer {
          0% { background-position: 200% 0; }
          100% { background-position: -200% 0; }
        }
      `}),s.jsx("div",{className:r,style:{width:i,height:t,borderRadius:"4px",...Zr,...e}})]})}function Te({width:i="100%",lines:t=1}){return s.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"0.5rem"},children:Array.from({length:t}).map((e,r)=>s.jsx(G,{width:r===t-1&&t>1?"70%":i,height:"1rem"},r))})}function es(){return s.jsxs("div",{style:{backgroundColor:"white",borderRadius:"12px",padding:"1.5rem",boxShadow:"0 1px 3px rgba(0,0,0,0.1)",display:"flex",alignItems:"center",gap:"1rem"},children:[s.jsx(G,{width:"48px",height:"48px",style:{borderRadius:"12px"}}),s.jsxs("div",{style:{flex:1},children:[s.jsx(G,{width:"60%",height:"0.875rem",style:{marginBottom:"0.5rem"}}),s.jsx(G,{width:"40%",height:"1.5rem"})]})]})}function ts({columns:i=6}){return s.jsx("tr",{children:Array.from({length:i}).map((t,e)=>s.jsx("td",{style:{padding:"0.75rem 1rem"},children:s.jsx(G,{width:e===0?"80%":e===i-1?"60px":"70%",height:"1rem"})},e))})}function Re({hasHeader:i=!0}){return s.jsxs("div",{style:{backgroundColor:"white",borderRadius:"12px",padding:"1.5rem",boxShadow:"0 1px 3px rgba(0,0,0,0.1)"},children:[i&&s.jsx(G,{width:"40%",height:"1.5rem",style:{marginBottom:"1rem"}}),s.jsx(Te,{lines:3})]})}function oe({type:i="text",count:t=1,...e}){return(()=>{switch(i){case"text":return s.jsx(Te,{...e});case"stat-card":case"stats":return s.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:"1rem"},children:Array.from({length:t}).map((a,n)=>s.jsx(es,{},n))});case"table":return s.jsx("div",{className:"card",children:s.jsxs("table",{children:[s.jsx("thead",{children:s.jsx("tr",{children:Array.from({length:e.columns||6}).map((a,n)=>s.jsx("th",{style:{padding:"0.75rem 1rem"},children:s.jsx(G,{width:"60%",height:"0.875rem"})},n))})}),s.jsx("tbody",{children:Array.from({length:e.rows||5}).map((a,n)=>s.jsx(ts,{columns:e.columns||6},n))})]})});case"card":return s.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"1rem"},children:Array.from({length:t}).map((a,n)=>s.jsx(Re,{...e},n))});case"page":return s.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"1.5rem"},children:[s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[s.jsxs("div",{children:[s.jsx(G,{width:"200px",height:"1.75rem",style:{marginBottom:"0.5rem"}}),s.jsx(G,{width:"300px",height:"1rem"})]}),s.jsx(G,{width:"120px",height:"40px",style:{borderRadius:"8px"}})]}),s.jsx(oe,{type:"stats",count:4}),s.jsx(oe,{type:"table",rows:8,columns:6})]});case"detail":return s.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"1.5rem"},children:[s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"1rem"},children:[s.jsx(G,{width:"80px",height:"36px",style:{borderRadius:"8px"}}),s.jsx(G,{width:"250px",height:"1.75rem"})]}),s.jsx(oe,{type:"stats",count:4}),s.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[s.jsx(Re,{}),s.jsx(Re,{})]}),s.jsx(oe,{type:"table",rows:5,columns:5})]});default:return s.jsx(Te,{...e})}})()}const He={success:{icon:qe,bgColor:"#dcfce7",borderColor:"#86efac",textColor:"#166534",iconColor:"#16a34a"},error:{icon:at,bgColor:"#fee2e2",borderColor:"#fecaca",textColor:"#991b1b",iconColor:"#dc2626"},warning:{icon:st,bgColor:"#fef3c7",borderColor:"#fde68a",textColor:"#92400e",iconColor:"#d97706"},info:{icon:Lt,bgColor:"#dbeafe",borderColor:"#93c5fd",textColor:"#1e40af",iconColor:"#3b82f6"}};function rs({id:i,message:t,type:e="info",duration:r=4e3,onClose:a}){const n=He[e]||He.info,o=n.icon;return d.useEffect(()=>{if(r>0){const c=setTimeout(()=>{a(i)},r);return()=>clearTimeout(c)}},[i,r,a]),s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem",padding:"0.875rem 1rem",backgroundColor:n.bgColor,border:`1px solid ${n.borderColor}`,borderRadius:"8px",boxShadow:"0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)",minWidth:"300px",maxWidth:"450px",animation:"slideIn 0.3s ease-out"},children:[s.jsx(o,{size:20,style:{color:n.iconColor,flexShrink:0}}),s.jsx("span",{style:{color:n.textColor,fontSize:"0.875rem",fontWeight:"500",flex:1},children:t}),s.jsx("button",{onClick:()=>a(i),style:{background:"none",border:"none",cursor:"pointer",padding:"0.25rem",display:"flex",alignItems:"center",justifyContent:"center",color:n.textColor,opacity:.7,borderRadius:"4px"},onMouseEnter:c=>c.target.style.opacity=1,onMouseLeave:c=>c.target.style.opacity=.7,children:s.jsx(ae,{size:16})})]})}function ss({toasts:i,removeToast:t}){return i.length===0?null:s.jsxs("div",{style:{position:"fixed",top:"1rem",right:"1rem",zIndex:9999,display:"flex",flexDirection:"column",gap:"0.5rem"},children:[s.jsx("style",{children:`
          @keyframes slideIn {
            from {
              transform: translateX(100%);
              opacity: 0;
            }
            to {
              transform: translateX(0);
              opacity: 1;
            }
          }
        `}),i.map(e=>s.jsx(rs,{id:e.id,message:e.message,type:e.type,duration:e.duration,onClose:t},e.id))]})}const vt=d.createContext(null),as=4e3;function ns({children:i}){const[t,e]=d.useState([]),r=d.useCallback(m=>{e(g=>g.filter(p=>p.id!==m))},[]),a=d.useCallback((m,g="info",p=as)=>{const _=Date.now()+Math.random(),x={id:_,message:m,type:g,duration:p};return e(u=>[...u,x]),_},[]),n=d.useCallback((m,g)=>a(m,"success",g),[a]),o=d.useCallback((m,g)=>a(m,"error",g||6e3),[a]),c=d.useCallback((m,g)=>a(m,"warning",g),[a]),l=d.useCallback((m,g)=>a(m,"info",g),[a]),h={showToast:a,showSuccess:n,showError:o,showWarning:c,showInfo:l,removeToast:r};return s.jsxs(vt.Provider,{value:h,children:[i,s.jsx(ss,{toasts:t,removeToast:r})]})}function is(){const i=d.useContext(vt);if(!i)throw new Error("useToast must be used within a ToastProvider");return i}const H={timesheets:{contributeToSpend:["Submitted","Validated","Approved"],excludeFromSpend:["Draft","Rejected"],completed:["Validated","Approved"]},expenses:{contributeToSpend:["Submitted","Validated","Approved"],excludeFromSpend:["Draft","Rejected"],completed:["Validated","Approved"]},deliverables:{contributeToKPIs:["Delivered"],contributeToQS:["Delivered"],inProgress:["In Progress","Submitted","Under Review"],completed:["Delivered"],notStarted:["Not Started","Draft"]},milestones:{completed:["Completed"],inProgress:["In Progress"],notStarted:["Not Started","Planned"]},kpis:{achieved:["Achieved","On Target"],atRisk:["At Risk","Amber"],failing:["Failing","Red","Off Target"]},qualityStandards:{achieved:["Achieved","Met"],partial:["Partial","In Progress"],notMet:["Not Met","Failed"]}},os=["pmo","project manager","pm"];function me(i){if(!i)return!1;const t=i.toLowerCase();return os.some(e=>t.includes(e))}function Ke(i){return i?H.timesheets.contributeToSpend.includes(i):!1}function Ge(i){return i?H.expenses.contributeToSpend.includes(i):!1}const Qe={defaultTarget:90,amberThreshold:10,calculationMethod:"assessment_based"},ls={defaultTarget:100,calculationMethod:"assessment_based"},St={hoursPerDay:8,currency:"Â£",currencyCode:"GBP",decimalPlaces:2};function ne(i){return(parseFloat(i)||0)/St.hoursPerDay}function cs(i,t){return ne(i)*(parseFloat(t)||0)}function Ye(i,t){return ne(i)*(parseFloat(t)||0)}class ds{constructor(){this.cache=new Map,this.cacheTimeout=5e3}clearCache(){this.cache.clear()}getCached(t){const e=this.cache.get(t);return e&&Date.now()-e.timestamp<this.cacheTimeout?e.data:null}setCache(t,e){this.cache.set(t,{data:e,timestamp:Date.now()})}async getMilestoneMetrics(t){const e=`milestones_${t}`,r=this.getCached(e);if(r)return r;try{const{data:a,error:n}=await f.from("milestones").select("id, milestone_ref, name, status, progress, budget, percent_complete, is_deleted").eq("project_id",t).order("milestone_ref");if(n)throw n;const o=a?.filter(l=>l.is_deleted!==!0)||[],c={total:o.length,completed:o.filter(l=>H.milestones.completed.includes(l.status)).length,inProgress:o.filter(l=>H.milestones.inProgress.includes(l.status)).length,notStarted:o.filter(l=>H.milestones.notStarted.includes(l.status)).length,totalBudget:o.reduce((l,h)=>l+(h.budget||0),0),averageProgress:o.length>0?Math.round(o.reduce((l,h)=>l+(h.progress||0),0)/o.length):0,milestones:o};return this.setCache(e,c),c}catch(a){throw a}}async getDeliverableMetrics(t,e=!1){const r=`deliverables_${t}_${e}`,a=this.getCached(r);if(a)return a;try{const{data:n,error:o}=await f.from("deliverables").select("id, deliverable_ref, name, status, due_date, milestone_id, is_deleted, is_test_content").eq("project_id",t).order("deliverable_ref");if(o)throw o;let c=n?.filter(p=>p.is_deleted!==!0)||[];e||(c=c.filter(p=>p.is_test_content!==!0));const l=new Date().toISOString().split("T")[0],h=new Date;h.setDate(h.getDate()+7);const m=h.toISOString().split("T")[0],g={total:c.length,delivered:c.filter(p=>H.deliverables.completed.includes(p.status)).length,inProgress:c.filter(p=>H.deliverables.inProgress.includes(p.status)).length,notStarted:c.filter(p=>H.deliverables.notStarted.includes(p.status)).length,overdue:c.filter(p=>p.due_date<l&&!H.deliverables.completed.includes(p.status)).length,dueThisWeek:c.filter(p=>p.due_date>=l&&p.due_date<=m&&!H.deliverables.completed.includes(p.status)).length,deliverables:c};return g.completionPercent=g.total>0?Math.round(g.delivered/g.total*100):0,this.setCache(r,g),g}catch(n){throw n}}async getKPIMetrics(t){const e=`kpis_${t}`,r=this.getCached(e);if(r)return r;try{const{data:a,error:n}=await f.from("kpis").select("id, kpi_ref, name, category, target, current_value, is_deleted").eq("project_id",t).order("kpi_ref");if(n)throw n;const o=a?.filter(x=>x.is_deleted!==!0)||[],{data:c,error:l}=await f.from("deliverable_kpi_assessments").select(`
          kpi_id,
          criteria_met,
          deliverables!inner(id, status, is_deleted, project_id)
        `).eq("deliverables.project_id",t),h=c?.filter(x=>x.deliverables?.is_deleted!==!0&&H.deliverables.contributeToKPIs.includes(x.deliverables?.status))||[],m=new Map;h&&h.length>0&&h.forEach(x=>{m.has(x.kpi_id)||m.set(x.kpi_id,{total:0,met:0});const u=m.get(x.kpi_id);u.total++,x.criteria_met&&u.met++});const g=o.map(x=>{const u=m.get(x.id);let v=0;u&&u.total>0&&(v=Math.round(u.met/u.total*100));const P=x.target||Qe.defaultTarget,q=v>=P;return{...x,calculatedValue:v,assessmentCount:u?.total||0,assessmentsMet:u?.met||0,isAchieved:q,ragStatus:v>=P?"Green":v>=P*(1-Qe.amberThreshold/100)?"Amber":"Red"}}),p={};g.forEach(x=>{const u=x.category||"Other";p[u]||(p[u]=[]),p[u].push(x)});const _={total:o.length,achieved:g.filter(x=>x.isAchieved).length,atRisk:g.filter(x=>x.ragStatus==="Amber").length,failing:g.filter(x=>x.ragStatus==="Red").length,achievementPercent:o.length>0?Math.round(g.filter(x=>x.isAchieved).length/o.length*100):0,byCategory:p,kpis:g};return this.setCache(e,_),_}catch(a){throw a}}async getQualityStandardMetrics(t){const e=`qs_${t}`,r=this.getCached(e);if(r)return r;try{const{data:a,error:n}=await f.from("quality_standards").select("id, qs_ref, name, target, current_value, is_deleted").eq("project_id",t).order("qs_ref");if(n)throw n;const o=a?.filter(_=>_.is_deleted!==!0)||[],{data:c,error:l}=await f.from("deliverable_qs_assessments").select(`
          quality_standard_id,
          criteria_met,
          deliverables!inner(id, status, is_deleted, project_id)
        `).eq("deliverables.project_id",t),h=c?.filter(_=>_.deliverables?.is_deleted!==!0&&H.deliverables.contributeToQS.includes(_.deliverables?.status))||[],m=new Map;h&&h.length>0&&h.forEach(_=>{m.has(_.quality_standard_id)||m.set(_.quality_standard_id,{total:0,met:0});const x=m.get(_.quality_standard_id);x.total++,_.criteria_met&&x.met++});const g=o.map(_=>{const x=m.get(_.id);let u=0;x&&x.total>0&&(u=Math.round(x.met/x.total*100));const v=_.target||ls.defaultTarget,P=u>=v;return{..._,calculatedValue:u,assessmentCount:x?.total||0,assessmentsMet:x?.met||0,isAchieved:P}}),p={total:o.length,achieved:g.filter(_=>_.isAchieved).length,partial:g.filter(_=>_.calculatedValue>0&&!_.isAchieved).length,notMet:g.filter(_=>_.calculatedValue===0).length,achievementPercent:o.length>0?Math.round(g.filter(_=>_.isAchieved).length/o.length*100):0,qualityStandards:g};return this.setCache(e,p),p}catch(a){throw a}}async getTimesheetMetrics(t,e=!1){const r=`timesheets_${t}_${e}`,a=this.getCached(r);if(a)return a;try{const{data:n,error:o}=await f.from("timesheets").select(`
          id, date, hours_worked, hours, status, milestone_id, resource_id, is_deleted,
          resources(id, name, role, sell_price)
        `).eq("project_id",t);if(o)throw o;const c=n?.filter(u=>u.is_deleted!==!0)||[];let l=0,h=0,m=0,g=0;const p={},_={};c.forEach(u=>{const v=parseFloat(u.hours_worked||u.hours||0),P=u.resources,q=P?.sell_price||0,I=v/St.hoursPerDay*q;Ke(u.status)&&(l+=v,h+=I,me(P?.role)?m+=I:g+=I,u.milestone_id&&(p[u.milestone_id]=(p[u.milestone_id]||0)+I),u.resource_id&&(_[u.resource_id]=(_[u.resource_id]||0)+I))});const x={totalEntries:c.length,validEntries:c.filter(u=>Ke(u.status)).length,draftEntries:c.filter(u=>u.status==="Draft").length,rejectedEntries:c.filter(u=>u.status==="Rejected").length,totalHours:l,totalSpend:h,pmoSpend:m,deliverySpend:g,spendByMilestone:p,spendByResource:_};return this.setCache(r,x),x}catch(n){throw n}}async getExpenseMetrics(t,e=!1){const r=`expenses_${t}_${e}`,a=this.getCached(r);if(a)return a;try{const{data:n,error:o}=await f.from("expenses").select("id, expense_date, amount, status, category, chargeable_to_customer, procurement_method, is_deleted").eq("project_id",t);if(o)throw o;const c=n?.filter(_=>_.is_deleted!==!0)||[];let l=0,h=0,m=0;const g={};c.forEach(_=>{const x=parseFloat(_.amount||0);if(Ge(_.status)){l+=x,_.chargeable_to_customer?h+=x:m+=x;const u=_.category||"Other";g[u]=(g[u]||0)+x}});const p={totalEntries:c.length,validEntries:c.filter(_=>Ge(_.status)).length,draftEntries:c.filter(_=>_.status==="Draft").length,rejectedEntries:c.filter(_=>_.status==="Rejected").length,totalAmount:l,chargeableAmount:h,nonChargeableAmount:m,byCategory:g};return this.setCache(r,p),p}catch(n){throw n}}async getResourceMetrics(t){const e=`resources_${t}`,r=this.getCached(e);if(r)return r;try{const{data:a,error:n}=await f.from("resources").select("id, name, role, sell_price, days_allocated, is_deleted").eq("project_id",t);if(n)throw n;const o=a?.filter(m=>m.is_deleted!==!0)||[];let c=0,l=0;o.forEach(m=>{const g=(m.sell_price||0)*(m.days_allocated||0);me(m.role)?c+=g:l+=g});const h={total:o.length,pmoCount:o.filter(m=>me(m.role)).length,deliveryCount:o.filter(m=>!me(m.role)).length,pmoBudget:c,deliveryBudget:l,totalBudget:c+l,resources:o};return this.setCache(e,h),h}catch(a){throw a}}async getCertificateMetrics(t){const e=`certificates_${t}`,r=this.getCached(e);if(r)return r;try{const{data:a,error:n}=await f.from("milestone_certificates").select("id, milestone_id, status").eq("project_id",t);if(n)throw n;const o=await this.getMilestoneMetrics(t),c={total:a?.length||0,signed:a?.filter(l=>l.status==="Signed").length||0,pending:a?.filter(l=>l.status==="Pending Customer Signature"||l.status==="Pending Supplier Signature").length||0,awaitingGeneration:Math.max(0,o.completed-(a?.length||0))};return this.setCache(e,c),c}catch(a){throw a}}async getAllDashboardMetrics(t,e={}){const{includeTestContent:r=!1}=e;try{const[a,n,o,c,l,h,m,g]=await Promise.all([this.getMilestoneMetrics(t),this.getDeliverableMetrics(t,r),this.getKPIMetrics(t),this.getQualityStandardMetrics(t),this.getTimesheetMetrics(t,r),this.getExpenseMetrics(t,r),this.getResourceMetrics(t),this.getCertificateMetrics(t)]),p={totalBudget:a.totalBudget,timesheetSpend:l.totalSpend,expenseSpend:h.totalAmount,totalSpend:l.totalSpend+h.totalAmount,pmoBudget:m.pmoBudget,pmoSpend:l.pmoSpend,deliveryBudget:m.deliveryBudget,deliverySpend:l.deliverySpend,utilizationPercent:a.totalBudget>0?Math.round((l.totalSpend+h.totalAmount)/a.totalBudget*100):0},_={...l.spendByMilestone};return Object.entries(h.byMilestone).forEach(([x,u])=>{_[x]=(_[x]||0)+u}),{milestones:a,deliverables:n,kpis:o,qualityStandards:c,timesheets:l,expenses:h,resources:m,certificates:g,budget:p,milestoneSpend:_,projectProgress:a.averageProgress,lastUpdated:new Date().toISOString()}}catch(a){throw a}}}const Q=new ds,jt=d.createContext(null);function us({children:i}){const{projectId:t}=ue(),{showTestUsers:e}=_t(),[r,a]=d.useState(null),[n,o]=d.useState(!0),[c,l]=d.useState(null),[h,m]=d.useState(null),g=d.useCallback(async(x=!1)=>{if(!t){a(null),o(!1);return}x&&Q.clearCache(),o(!0),l(null);try{const u=await Q.getAllDashboardMetrics(t,{includeTestContent:e});a(u),m(new Date)}catch(u){l(u.message||"Failed to load metrics")}finally{o(!1)}},[t,e]),p=d.useCallback(async x=>{if(t)try{let u;switch(x){case"milestones":u=await Q.getMilestoneMetrics(t),a(v=>v?{...v,milestones:u}:null);break;case"deliverables":u=await Q.getDeliverableMetrics(t,e),a(v=>v?{...v,deliverables:u}:null);break;case"kpis":u=await Q.getKPIMetrics(t),a(v=>v?{...v,kpis:u}:null);break;case"qualityStandards":u=await Q.getQualityStandardMetrics(t),a(v=>v?{...v,qualityStandards:u}:null);break;case"timesheets":u=await Q.getTimesheetMetrics(t,e),a(v=>v?{...v,timesheets:u}:null);break;case"expenses":u=await Q.getExpenseMetrics(t,e),a(v=>v?{...v,expenses:u}:null);break;case"resources":u=await Q.getResourceMetrics(t),a(v=>v?{...v,resources:u}:null);break;case"certificates":u=await Q.getCertificateMetrics(t),a(v=>v?{...v,certificates:u}:null);break;default:await g(!0)}m(new Date)}catch{}},[t,e,g]);d.useEffect(()=>{g()},[g]);const _=d.useMemo(()=>({metrics:r,milestones:r?.milestones||null,deliverables:r?.deliverables||null,kpis:r?.kpis||null,qualityStandards:r?.qualityStandards||null,timesheets:r?.timesheets||null,expenses:r?.expenses||null,resources:r?.resources||null,certificates:r?.certificates||null,billable:r?.billable||null,milestoneSpend:r?.milestoneSpend||{},projectProgress:r?.projectProgress||0,loading:n,error:c,lastRefresh:h,refreshMetrics:()=>g(!0),refreshCategory:p,clearCache:()=>Q.clearCache()}),[r,n,c,h,g,p]);return s.jsx(jt.Provider,{value:_,children:i})}function Sa(){const i=d.useContext(jt);if(!i)throw new Error("useMetrics must be used within a MetricsProvider");return i}function hs(){const{isOpen:i,toggleChat:t,messages:e,isLoading:r,error:a,retryCount:n,tokenUsage:o,sendMessage:c,clearChat:l,cancelRequest:h,dismissError:m,downloadChat:g,copyMessage:p}=Xr(),[_,x]=d.useState(""),[u,v]=d.useState(null),[P,q]=d.useState(!1),I=d.useRef(null),b=d.useRef(null);d.useEffect(()=>{I.current?.scrollIntoView({behavior:"smooth"})},[e]),d.useEffect(()=>{i&&setTimeout(()=>b.current?.focus(),100)},[i]),d.useEffect(()=>{if(u!==null){const A=setTimeout(()=>v(null),2e3);return()=>clearTimeout(A)}},[u]);const C=A=>{A.preventDefault(),_.trim()&&!r&&(c(_),x(""))},k=A=>{A.key==="Enter"&&!A.shiftKey&&(A.preventDefault(),C(A))},E=async(A,N)=>{await p(A)&&v(N)},S={role:"assistant",content:`Hello! I'm your Project Assistant. I can query your project data and help you understand what's happening. Try asking:

â€¢ **"What do I need to do?"** - See your pending actions
â€¢ **"Show my timesheets this month"** - Query your time entries
â€¢ **"What milestones are at risk?"** - Check project progress
â€¢ **"What's the budget status?"** - View spend vs forecast
â€¢ **"What can my role do?"** - Understand your permissions

All data is scoped to your role, so just ask naturally!`},j=e.length===0?[S]:e,M=(o.input*.25/1e6+o.output*1.25/1e6).toFixed(4);return s.jsxs(s.Fragment,{children:[s.jsx("button",{className:`chat-toggle-btn ${i?"chat-open":""}`,onClick:t,"aria-label":i?"Close chat":"Open AI assistant",children:i?s.jsx(ae,{size:24}):s.jsxs(s.Fragment,{children:[s.jsx(zt,{size:24}),s.jsx(Bt,{className:"chat-sparkle",size:12})]})}),s.jsxs("div",{className:`chat-panel ${i?"chat-panel-open":""}`,children:[s.jsxs("div",{className:"chat-header",children:[s.jsxs("div",{className:"chat-header-title",children:[s.jsx(Se,{size:20}),s.jsx("span",{children:"Project Assistant"})]}),s.jsxs("div",{className:"chat-header-actions",children:[e.length>0&&s.jsxs(s.Fragment,{children:[s.jsx("button",{className:"chat-action-btn",onClick:g,title:"Export chat as Markdown",children:s.jsx(Ut,{size:16})}),s.jsx("button",{className:"chat-action-btn",onClick:l,title:"Clear chat",children:s.jsx(Wt,{size:16})})]}),s.jsx("button",{className:"chat-close-btn",onClick:t,"aria-label":"Close chat",children:s.jsx(ae,{size:20})})]})]}),s.jsxs("div",{className:"chat-messages",children:[j.map((A,N)=>s.jsxs("div",{className:`chat-message ${A.role==="user"?"chat-message-user":"chat-message-assistant"}`,children:[s.jsx("div",{className:"chat-message-avatar",children:A.role==="user"?s.jsx($t,{size:16}):s.jsx(Se,{size:16})}),s.jsxs("div",{className:"chat-message-content",children:[s.jsx(ms,{content:A.content}),s.jsxs("div",{className:"chat-message-actions",children:[A.toolsUsed&&s.jsx("span",{className:"chat-tools-indicator",title:"Queried project data",children:s.jsx(Ft,{size:12})}),s.jsx("button",{className:"chat-copy-btn",onClick:()=>E(A.content,N),title:u===N?"Copied!":"Copy message",children:u===N?s.jsx(nt,{size:12,className:"chat-copy-success"}):s.jsx(Vt,{size:12})})]})]})]},N)),r&&s.jsxs("div",{className:"chat-message chat-message-assistant",children:[s.jsx("div",{className:"chat-message-avatar",children:s.jsx(Se,{size:16})}),s.jsxs("div",{className:"chat-message-content chat-typing",children:[n>0?s.jsxs(s.Fragment,{children:[s.jsx(le,{className:"chat-typing-icon",size:16}),s.jsxs("span",{children:["Retrying (",n,"/2)..."]})]}):s.jsxs(s.Fragment,{children:[s.jsx(Ht,{className:"chat-typing-icon",size:16}),s.jsx("span",{children:"Querying data..."})]}),s.jsx("button",{className:"chat-cancel-btn",onClick:h,title:"Cancel request",children:s.jsx(at,{size:14})})]})]}),a&&s.jsxs("div",{className:"chat-error",children:[s.jsx("span",{children:a}),s.jsx("button",{className:"chat-error-dismiss",onClick:m,title:"Dismiss",children:s.jsx(ae,{size:14})})]}),s.jsx("div",{ref:I})]}),s.jsxs("form",{className:"chat-input-form",onSubmit:C,children:[s.jsx("textarea",{ref:b,className:"chat-input",value:_,onChange:A=>x(A.target.value),onKeyDown:k,placeholder:"Ask me anything about the project...",rows:1,disabled:r}),s.jsx("button",{type:"submit",className:"chat-send-btn",disabled:!_.trim()||r,"aria-label":"Send message",children:s.jsx(Kt,{size:18})})]}),s.jsxs("div",{className:"chat-footer",children:[s.jsx("button",{className:"chat-stats-toggle",onClick:()=>q(!P),title:"Toggle usage stats",children:s.jsx(Gt,{size:12})}),P?s.jsxs("div",{className:"chat-stats",children:[s.jsxs("span",{title:"Total requests",children:[o.requests," req"]}),s.jsx("span",{className:"chat-stats-divider",children:"â€¢"}),s.jsxs("span",{title:"Input tokens",children:[o.input.toLocaleString()," in"]}),s.jsx("span",{className:"chat-stats-divider",children:"â€¢"}),s.jsxs("span",{title:"Output tokens",children:[o.output.toLocaleString()," out"]}),s.jsx("span",{className:"chat-stats-divider",children:"â€¢"}),s.jsxs("span",{title:"Estimated cost",children:["$",M]})]}):s.jsx("span",{children:"Powered by Claude AI"})]})]})]})}function ms({content:i}){const t=i.split(`
`);return s.jsx("div",{className:"chat-message-text",children:t.map((e,r)=>{if(e.startsWith("â€¢ ")||e.startsWith("- ")){const a=e.substring(2);return s.jsxs("div",{className:"chat-bullet",children:[s.jsx("span",{className:"chat-bullet-dot",children:"â€¢"}),s.jsx("span",{dangerouslySetInnerHTML:{__html:Xe(a)}})]},r)}return e.trim()===""?s.jsx("div",{className:"chat-line-break"},r):s.jsx("p",{dangerouslySetInnerHTML:{__html:Xe(e)}},r)})})}function Xe(i){return i.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>")}function fs(){const[i,t]=d.useState(!1),e=d.useRef(null),r=ce(),{notifications:a,unreadCount:n,actionCount:o,loading:c,markAsRead:l,markAsActioned:h,markAllAsRead:m,dismissNotification:g}=Vr();d.useEffect(()=>{function b(C){e.current&&!e.current.contains(C.target)&&t(!1)}return document.addEventListener("mousedown",b),()=>document.removeEventListener("mousedown",b)},[]);const p=b=>{switch(b){case"timesheet":return s.jsx(de,{size:16});case"expense":return s.jsx(ot,{size:16});case"deliverable":return s.jsx(Oe,{size:16});case"certificate":return s.jsx(it,{size:16});default:return s.jsx(je,{size:16})}},_=b=>b.notification_type==="action"?b.is_actioned?"#10b981":"#f59e0b":"#3b82f6",x=async b=>{b.is_read||await l(b.id),b.action_url&&(r(b.action_url),t(!1))},u=async(b,C)=>{b.stopPropagation(),await h(C.id),C.action_url&&(r(C.action_url),t(!1))},v=async(b,C)=>{b.stopPropagation(),await g(C.id)},P=b=>{const C=new Date(b),E=new Date-C,S=Math.floor(E/6e4),j=Math.floor(E/36e5),M=Math.floor(E/864e5);return S<1?"Just now":S<60?`${S}m ago`:j<24?`${j}h ago`:M<7?`${M}d ago`:C.toLocaleDateString("en-GB",{day:"numeric",month:"short"})},q=a.slice(0,10),I=a.filter(b=>b.notification_type==="action"&&!b.is_actioned);return s.jsxs("div",{className:"notification-bell-container",ref:e,style:{position:"relative"},children:[s.jsxs("button",{onClick:()=>t(!i),style:{position:"relative",background:"none",border:"none",cursor:"pointer",padding:"8px",borderRadius:"8px",display:"flex",alignItems:"center",justifyContent:"center",transition:"background-color 0.2s",backgroundColor:i?"#f1f5f9":"transparent"},onMouseEnter:b=>b.target.style.backgroundColor="#f1f5f9",onMouseLeave:b=>b.target.style.backgroundColor=i?"#f1f5f9":"transparent",title:`${o} actions pending`,children:[s.jsx(je,{size:22,color:"#64748b"}),(n>0||o>0)&&s.jsx("span",{style:{position:"absolute",top:"2px",right:"2px",backgroundColor:o>0?"#ef4444":"#3b82f6",color:"white",fontSize:"11px",fontWeight:"600",minWidth:"18px",height:"18px",borderRadius:"9px",display:"flex",alignItems:"center",justifyContent:"center",padding:"0 4px"},children:o>0?o:n})]}),i&&s.jsxs("div",{style:{position:"absolute",top:"100%",right:0,marginTop:"8px",width:"380px",maxHeight:"500px",backgroundColor:"white",borderRadius:"12px",boxShadow:"0 10px 40px rgba(0,0,0,0.15)",border:"1px solid #e2e8f0",zIndex:1e3,overflow:"hidden"},children:[s.jsxs("div",{style:{padding:"16px",borderBottom:"1px solid #e2e8f0",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[s.jsxs("div",{children:[s.jsx("h3",{style:{margin:0,fontSize:"16px",fontWeight:"600"},children:"Notifications"}),o>0&&s.jsxs("p",{style:{margin:"4px 0 0",fontSize:"13px",color:"#f59e0b"},children:[o," action",o!==1?"s":""," required"]})]}),n>0&&s.jsx("button",{onClick:m,style:{background:"none",border:"none",color:"#3b82f6",fontSize:"13px",cursor:"pointer",padding:"4px 8px",borderRadius:"4px"},children:"Mark all read"})]}),I.length>0&&s.jsxs("div",{style:{padding:"12px 16px",backgroundColor:"#fffbeb",borderBottom:"1px solid #fef3c7"},children:[s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"8px"},children:[s.jsx("div",{style:{width:"8px",height:"8px",borderRadius:"50%",backgroundColor:"#f59e0b",animation:"pulse 2s infinite"}}),s.jsx("span",{style:{fontWeight:"600",fontSize:"13px",color:"#92400e"},children:"Actions Requiring Attention"})]}),s.jsxs("button",{onClick:()=>{r("/workflow-summary"),t(!1)},style:{width:"100%",padding:"8px 12px",backgroundColor:"#f59e0b",color:"white",border:"none",borderRadius:"6px",cursor:"pointer",fontSize:"13px",fontWeight:"500",display:"flex",alignItems:"center",justifyContent:"center",gap:"6px"},children:["View Workflow Summary",s.jsx(Qt,{size:16})]})]}),s.jsx("div",{style:{maxHeight:"350px",overflowY:"auto"},children:c?s.jsx("div",{style:{padding:"32px",textAlign:"center",color:"#64748b"},children:"Loading..."}):q.length===0?s.jsxs("div",{style:{padding:"32px",textAlign:"center",color:"#64748b"},children:[s.jsx(je,{size:32,style:{marginBottom:"8px",opacity:.5}}),s.jsx("p",{style:{margin:0},children:"No notifications"})]}):q.map(b=>s.jsx("div",{onClick:()=>x(b),style:{padding:"12px 16px",borderBottom:"1px solid #f1f5f9",cursor:"pointer",backgroundColor:b.is_read?"white":"#f8fafc",transition:"background-color 0.15s"},onMouseEnter:C=>C.currentTarget.style.backgroundColor="#f1f5f9",onMouseLeave:C=>C.currentTarget.style.backgroundColor=b.is_read?"white":"#f8fafc",children:s.jsxs("div",{style:{display:"flex",gap:"12px"},children:[s.jsx("div",{style:{width:"36px",height:"36px",borderRadius:"8px",backgroundColor:b.notification_type==="action"&&!b.is_actioned?"#fef3c7":"#f1f5f9",display:"flex",alignItems:"center",justifyContent:"center",color:_(b),flexShrink:0},children:p(b.category)}),s.jsxs("div",{style:{flex:1,minWidth:0},children:[s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",gap:"8px"},children:[s.jsx("span",{style:{fontWeight:b.is_read?"400":"600",fontSize:"14px",color:"#1e293b"},children:b.title}),s.jsx("span",{style:{fontSize:"12px",color:"#94a3b8",flexShrink:0},children:P(b.created_at)})]}),s.jsx("p",{style:{margin:"4px 0 0",fontSize:"13px",color:"#64748b",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:b.message}),s.jsxs("div",{style:{marginTop:"8px",display:"flex",gap:"8px"},children:[b.notification_type==="action"&&!b.is_actioned&&b.action_label&&s.jsx("button",{onClick:C=>u(C,b),style:{padding:"4px 12px",fontSize:"12px",fontWeight:"500",backgroundColor:"#3b82f6",color:"white",border:"none",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",gap:"4px"},children:b.action_label}),b.notification_type==="info"&&s.jsxs("button",{onClick:C=>v(C,b),style:{padding:"4px 8px",fontSize:"12px",backgroundColor:"transparent",color:"#64748b",border:"1px solid #e2e8f0",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",gap:"4px"},children:[s.jsx(ae,{size:12}),"Dismiss"]}),b.is_actioned&&s.jsxs("span",{style:{padding:"4px 8px",fontSize:"12px",color:"#10b981",display:"flex",alignItems:"center",gap:"4px"},children:[s.jsx(nt,{size:12}),"Completed"]})]})]})]})},b.id))}),a.length>10&&s.jsx("div",{style:{padding:"12px 16px",borderTop:"1px solid #e2e8f0",textAlign:"center"},children:s.jsx("button",{onClick:()=>{r("/workflow-summary"),t(!1)},style:{background:"none",border:"none",color:"#3b82f6",fontSize:"13px",fontWeight:"500",cursor:"pointer"},children:"View all notifications"})})]}),s.jsx("style",{children:`
        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.5; }
        }
      `})]})}const y={ADMIN:"admin",SUPPLIER_PM:"supplier_pm",CUSTOMER_PM:"customer_pm",CONTRIBUTOR:"contributor",VIEWER:"viewer"},ps=[y.ADMIN,y.SUPPLIER_PM,y.CUSTOMER_PM,y.CONTRIBUTOR,y.VIEWER],te=ps,ee=[y.ADMIN,y.SUPPLIER_PM,y.CUSTOMER_PM],T=[y.ADMIN,y.SUPPLIER_PM],ie=[y.ADMIN,y.CUSTOMER_PM],re=[y.ADMIN,y.SUPPLIER_PM,y.CONTRIBUTOR],Pe=[y.ADMIN],gs={timesheets:{view:te,create:re,createForOthers:T,edit:re,delete:T,submit:re,approve:ie},expenses:{view:te,create:re,createForOthers:T,edit:re,delete:T,submit:re,validateChargeable:ie,validateNonChargeable:T},milestones:{view:te,create:T,edit:T,delete:Pe,useGantt:T},deliverables:{view:te,create:[...ee,y.CONTRIBUTOR],edit:[...ee,y.CONTRIBUTOR],delete:T,submit:re,review:ie,markDelivered:ie},kpis:{view:te,create:T,edit:T,delete:T,manage:T},qualityStandards:{view:te,create:T,edit:T,delete:T,manage:T},resources:{view:te,create:T,edit:T,delete:Pe,manage:T,seeCostPrice:T,seeResourceType:T,seeMargins:T},partners:{view:T,create:T,edit:T,delete:T,manage:T},certificates:{view:ee,create:ee,signAsSupplier:T,signAsCustomer:ie},invoices:{view:ee,generateCustomer:ee,generateThirdParty:T,viewMargins:T},settings:{access:T,edit:T},users:{view:T,manage:Pe},reports:{access:ee,viewWorkflowSummary:ee}};function ja(i,t,e){const r=gs[t];if(!r)return!1;const a=r[e];return a?a.includes(i):!1}const ys={[y.ADMIN]:{label:"Admin",color:"#7c3aed",bg:"#f3e8ff"},[y.SUPPLIER_PM]:{label:"Supplier PM",color:"#059669",bg:"#d1fae5"},[y.CUSTOMER_PM]:{label:"Customer PM",color:"#d97706",bg:"#fef3c7"},[y.CONTRIBUTOR]:{label:"Contributor",color:"#2563eb",bg:"#dbeafe"},[y.VIEWER]:{label:"Viewer",color:"#64748b",bg:"#f1f5f9"}},Ca=Object.entries(ys).map(([i,t])=>({value:i,...t})),_e={workflowSummary:{id:"workflowSummary",path:"/workflow-summary",icon:nr,label:"Workflow Summary",allowedRoles:[y.ADMIN,y.SUPPLIER_PM,y.CUSTOMER_PM,y.CONTRIBUTOR],readOnlyRoles:[]},dashboard:{id:"dashboard",path:"/dashboard",icon:ar,label:"Dashboard",allowedRoles:[y.ADMIN,y.SUPPLIER_PM,y.CUSTOMER_PM,y.VIEWER],readOnlyRoles:[y.VIEWER]},reports:{id:"reports",path:"/reports",icon:Oe,label:"Reports",allowedRoles:[y.ADMIN,y.SUPPLIER_PM,y.CUSTOMER_PM],readOnlyRoles:[]},gantt:{id:"gantt",path:"/gantt",icon:sr,label:"Gantt Chart",allowedRoles:[y.ADMIN,y.SUPPLIER_PM,y.CUSTOMER_PM,y.VIEWER],readOnlyRoles:[y.VIEWER,y.CUSTOMER_PM]},milestones:{id:"milestones",path:"/milestones",icon:Ae,label:"Milestones",allowedRoles:[y.ADMIN,y.SUPPLIER_PM,y.CUSTOMER_PM,y.VIEWER],readOnlyRoles:[y.VIEWER]},deliverables:{id:"deliverables",path:"/deliverables",icon:Ie,label:"Deliverables",allowedRoles:[y.ADMIN,y.SUPPLIER_PM,y.CUSTOMER_PM,y.CONTRIBUTOR,y.VIEWER],readOnlyRoles:[y.VIEWER]},kpis:{id:"kpis",path:"/kpis",icon:rr,label:"KPIs",allowedRoles:[y.ADMIN,y.SUPPLIER_PM,y.CUSTOMER_PM,y.VIEWER],readOnlyRoles:[y.VIEWER,y.CUSTOMER_PM]},qualityStandards:{id:"qualityStandards",path:"/quality-standards",icon:it,label:"Quality Standards",allowedRoles:[y.ADMIN,y.SUPPLIER_PM,y.CUSTOMER_PM,y.VIEWER],readOnlyRoles:[y.VIEWER,y.CUSTOMER_PM]},resources:{id:"resources",path:"/resources",icon:tr,label:"Resources",allowedRoles:[y.ADMIN,y.SUPPLIER_PM],readOnlyRoles:[]},timesheets:{id:"timesheets",path:"/timesheets",icon:de,label:"Timesheets",allowedRoles:[y.ADMIN,y.SUPPLIER_PM,y.CUSTOMER_PM,y.CONTRIBUTOR],readOnlyRoles:[]},expenses:{id:"expenses",path:"/expenses",icon:ot,label:"Expenses",allowedRoles:[y.ADMIN,y.SUPPLIER_PM,y.CUSTOMER_PM,y.CONTRIBUTOR],readOnlyRoles:[]},partners:{id:"partners",path:"/partners",icon:er,label:"Partners",allowedRoles:[y.ADMIN,y.SUPPLIER_PM],readOnlyRoles:[]},users:{id:"users",path:"/users",icon:Zt,label:"Users",allowedRoles:[y.ADMIN,y.SUPPLIER_PM],readOnlyRoles:[y.SUPPLIER_PM]},settings:{id:"settings",path:"/settings",icon:Jt,label:"Settings",allowedRoles:[y.ADMIN,y.SUPPLIER_PM],readOnlyRoles:[]},auditLog:{id:"auditLog",path:"/audit-log",icon:Xt,label:"Audit Log",allowedRoles:[y.ADMIN,y.SUPPLIER_PM],readOnlyRoles:[]},deletedItems:{id:"deletedItems",path:"/deleted-items",icon:Yt,label:"Deleted Items",allowedRoles:[y.ADMIN,y.SUPPLIER_PM],readOnlyRoles:[]}},fe={[y.ADMIN]:["workflowSummary","dashboard","reports","gantt","milestones","deliverables","kpis","qualityStandards","resources","timesheets","expenses","partners","users","settings","auditLog","deletedItems"],[y.SUPPLIER_PM]:["workflowSummary","dashboard","reports","gantt","milestones","deliverables","kpis","qualityStandards","resources","timesheets","expenses","partners","users","settings","auditLog","deletedItems"],[y.CUSTOMER_PM]:["workflowSummary","dashboard","reports","gantt","milestones","deliverables","kpis","qualityStandards","timesheets","expenses"],[y.CONTRIBUTOR]:["workflowSummary","timesheets","expenses","deliverables"],[y.VIEWER]:["dashboard","gantt","milestones","deliverables","kpis","qualityStandards"]};function _s(i){return(fe[i]||fe[y.VIEWER]).map(e=>_e[e]?.path).filter(Boolean)}function Ct(i){return(fe[i]||fe[y.VIEWER]).map(e=>_e[e]).filter(e=>e&&e.allowedRoles.includes(i))}function Je(i,t){const e=_e[t];return e?e.readOnlyRoles?.includes(i)||!1:!0}function xs(i){return i!==y.VIEWER}function ws(i){return Object.values(_e).find(t=>t.path===i)||null}function bs(i){return ws(i)?.id||null}function vs(i,t){const e=Ct(i);if(!t||!Array.isArray(t)||t.length===0)return e;const r={};e.forEach(n=>{r[n.path]=n});const a=[];return t.forEach(n=>{r[n]&&(a.push(r[n]),delete r[n])}),Object.values(r).forEach(n=>{a.push(n)}),a}function Ss(i,t){if(!t||t.length===0)return!0;const e=_s(i);return t.length!==e.length?!1:t.every((r,a)=>r===e[a])}const Ze={[y.ADMIN]:{label:"Administrator",shortLabel:"Admin",color:"#7c3aed",bg:"#f3e8ff",description:"Full system access"},[y.SUPPLIER_PM]:{label:"Supplier PM",shortLabel:"Supplier PM",color:"#059669",bg:"#d1fae5",description:"Manage resources, partners, and invoices"},[y.CUSTOMER_PM]:{label:"Customer PM",shortLabel:"Customer PM",color:"#d97706",bg:"#fef3c7",description:"Approve timesheets and validate expenses"},[y.CONTRIBUTOR]:{label:"Contributor",shortLabel:"Contributor",color:"#2563eb",bg:"#dbeafe",description:"Submit timesheets and expenses"},[y.VIEWER]:{label:"Viewer",shortLabel:"Viewer",color:"#64748b",bg:"#f1f5f9",description:"Read-only access to reports"}};function js(i){return Ze[i]||Ze[y.VIEWER]}function Cs({children:i}){const t=At(),e=ce(),{showSuccess:r,showError:a}=is(),{user:n,profile:o,role:c,signOut:l}=ye(),[h,m]=d.useState(!0),[g,p]=d.useState(null),[_,x]=d.useState(null),[u,v]=d.useState(null),P=d.useRef(null),q=d.useMemo(()=>js(c),[c]),I=d.useMemo(()=>o&&(o.full_name||o.email||n?.email)||"User",[o,n]),b=d.useMemo(()=>{if(!o)return"U";if(o.full_name){const R=o.full_name.split(" ");return R.length>=2?R[0][0]+R[R.length-1][0]:o.full_name[0].toUpperCase()}return I[0].toUpperCase()},[o,I]);d.useEffect(()=>{o?.nav_order&&Array.isArray(o.nav_order)&&p(o.nav_order)},[o]);async function C(){await l(),e("/login")}const k=d.useMemo(()=>xs(c),[c]),E=d.useMemo(()=>g&&!Ss(c,g),[c,g]),S=d.useMemo(()=>{const R=Ct(c);return g&&g.length>0?vs(c,g):R},[c,g]),j=d.useMemo(()=>{const R=bs(t.pathname);return R?Je(c,R):!1},[c,t.pathname]);function M(R,U){k&&(P.current=R.target,x(U),setTimeout(()=>{P.current&&(P.current.style.opacity="0.5")},0))}function A(R,U){k&&U!==_&&v(U)}function N(R){k&&R.preventDefault()}function V(){if(k){if(P.current&&(P.current.style.opacity="1"),_!==null&&u!==null&&_!==u){const R=[...S],U=R[_];R.splice(_,1),R.splice(u,0,U);const Z=R.map(X=>X.path);p(Z),J(Z)}x(null),v(null),P.current=null}}async function J(R){if(n)try{const{error:U}=await f.from("profiles").update({nav_order:R}).eq("id",n.id);U&&a("Failed to save menu order")}catch{a("Failed to save menu order")}}async function se(){if(n)try{const{error:R}=await f.from("profiles").update({nav_order:null}).eq("id",n.id);if(R){a("Failed to reset menu order");return}p(null),r("Menu order reset to default")}catch{a("Failed to reset menu order")}}return s.jsxs("div",{style:{display:"flex",minHeight:"100vh",backgroundColor:"#f8fafc"},children:[s.jsxs("aside",{style:{width:h?"260px":"70px",backgroundColor:"white",borderRight:"1px solid #e2e8f0",transition:"width 0.3s ease",display:"flex",flexDirection:"column",position:"fixed",height:"100vh",zIndex:50},children:[s.jsxs("div",{style:{padding:"1rem",borderBottom:"1px solid #e2e8f0",display:"flex",alignItems:"center",justifyContent:"space-between"},children:[h&&s.jsxs("div",{children:[s.jsx("h2",{style:{margin:0,fontSize:"1.125rem",fontWeight:"700",color:"#0f172a"},children:"AMSF001"}),s.jsx("span",{style:{fontSize:"0.75rem",color:"#64748b"},children:"Project Tracker"})]}),s.jsx("button",{onClick:()=>m(!h),style:{padding:"0.5rem",borderRadius:"6px",border:"none",backgroundColor:"#f1f5f9",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"},children:h?s.jsx(ae,{size:20}):s.jsx(ir,{size:20})})]}),s.jsx("nav",{style:{flex:1,padding:"0.5rem",overflowY:"auto"},children:S.map((R,U)=>{const Z=R.icon,X=t.pathname===R.path||R.path!=="/dashboard"&&t.pathname.startsWith(R.path),W=_===U,$=u===U,D=Je(c,R.id);return s.jsx("div",{draggable:k,onDragStart:w=>M(w,U),onDragEnter:w=>A(w,U),onDragOver:N,onDragEnd:V,style:{position:"relative",marginBottom:"0.25rem",borderTop:$&&_>U?"2px solid #10b981":"2px solid transparent",borderBottom:$&&_<U?"2px solid #10b981":"2px solid transparent",transition:"border-color 0.15s ease"},children:s.jsxs(Ue,{to:R.path,style:{display:"flex",alignItems:"center",gap:"0.75rem",padding:h?"0.75rem 1rem":"0.75rem",borderRadius:"8px",textDecoration:"none",color:X?"#10b981":"#64748b",backgroundColor:X?"#f0fdf4":W?"#f1f5f9":"transparent",fontWeight:X?"600":"500",justifyContent:h?"flex-start":"center",transition:"all 0.15s ease",cursor:k?"grab":"pointer"},children:[h&&k&&s.jsx(or,{size:14,style:{color:"#cbd5e1",marginRight:"-0.25rem",flexShrink:0}}),s.jsx(Z,{size:20}),h&&s.jsx("span",{style:{flex:1},children:R.label}),h&&D&&s.jsx("span",{style:{fontSize:"0.6rem",padding:"0.125rem 0.375rem",backgroundColor:"#f1f5f9",color:"#64748b",borderRadius:"4px",fontWeight:"500"},children:"VIEW"})]})},R.path)})}),h&&k&&E&&s.jsx("div",{style:{padding:"0.5rem 1rem",borderTop:"1px solid #e2e8f0"},children:s.jsxs("button",{onClick:se,style:{width:"100%",display:"flex",alignItems:"center",justifyContent:"center",gap:"0.5rem",padding:"0.5rem",backgroundColor:"#f8fafc",color:"#64748b",border:"1px solid #e2e8f0",borderRadius:"6px",cursor:"pointer",fontSize:"0.75rem",fontWeight:"500",transition:"all 0.15s ease"},onMouseEnter:R=>{R.currentTarget.style.backgroundColor="#f1f5f9",R.currentTarget.style.color="#475569"},onMouseLeave:R=>{R.currentTarget.style.backgroundColor="#f8fafc",R.currentTarget.style.color="#64748b"},children:[s.jsx(lt,{size:14}),"Reset Menu Order"]})}),s.jsx("div",{style:{padding:"1rem",borderTop:"1px solid #e2e8f0",backgroundColor:"#f8fafc"},children:s.jsxs("button",{onClick:C,style:{width:"100%",display:"flex",alignItems:"center",justifyContent:h?"flex-start":"center",gap:"0.75rem",padding:"0.75rem",backgroundColor:"#fef2f2",color:"#ef4444",border:"none",borderRadius:"8px",cursor:"pointer",fontWeight:"500"},children:[s.jsx(lr,{size:20}),h&&s.jsx("span",{children:"Logout"})]})})]}),s.jsxs("main",{style:{flex:1,marginLeft:h?"260px":"70px",transition:"margin-left 0.3s ease",minHeight:"100vh",display:"flex",flexDirection:"column"},children:[s.jsxs("header",{style:{padding:"0.75rem 1.5rem",backgroundColor:"white",borderBottom:"1px solid #e2e8f0",display:"flex",justifyContent:"flex-end",alignItems:"center",gap:"1rem",position:"sticky",top:0,zIndex:40},children:[s.jsxs(Ue,{to:"/account",style:{display:"flex",alignItems:"center",gap:"0.75rem",paddingRight:"1rem",borderRight:"1px solid #e2e8f0",textDecoration:"none",cursor:"pointer",borderRadius:"8px",padding:"0.5rem 1rem 0.5rem 0.75rem",marginRight:"0",transition:"background-color 0.15s ease"},onMouseEnter:R=>R.currentTarget.style.backgroundColor="#f8fafc",onMouseLeave:R=>R.currentTarget.style.backgroundColor="transparent",children:[s.jsxs("div",{style:{textAlign:"right"},children:[s.jsx("div",{style:{fontWeight:"600",fontSize:"0.875rem",color:"#1e293b"},children:I}),s.jsx("span",{style:{display:"inline-block",padding:"0.125rem 0.5rem",backgroundColor:q.bg,color:q.color,borderRadius:"4px",fontSize:"0.65rem",fontWeight:"600",textTransform:"uppercase",letterSpacing:"0.025em"},children:q.shortLabel})]}),s.jsx("div",{style:{width:"36px",height:"36px",borderRadius:"50%",backgroundColor:q.color,display:"flex",alignItems:"center",justifyContent:"center",color:"white",fontWeight:"600",fontSize:"0.8rem"},children:b})]}),s.jsx(fs,{})]}),j&&s.jsxs("div",{style:{padding:"0.5rem 1.5rem",backgroundColor:"#f1f5f9",borderBottom:"1px solid #e2e8f0",display:"flex",alignItems:"center",gap:"0.5rem",fontSize:"0.875rem",color:"#64748b"},children:[s.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[s.jsx("circle",{cx:"12",cy:"12",r:"10"}),s.jsx("line",{x1:"12",y1:"16",x2:"12",y2:"12"}),s.jsx("line",{x1:"12",y1:"8",x2:"12.01",y2:"8"})]}),s.jsx("span",{children:"You have read-only access to this page"})]}),s.jsx("div",{style:{flex:1},children:i})]})]})}function Es(){const i=ce(),[t]=Dt(),[e,r]=d.useState(!1),[a,n]=d.useState(""),[o,c]=d.useState(""),[l,h]=d.useState(null),[m,g]=d.useState(null),[p,_]=d.useState(!1),[x,u]=d.useState(!1),[v,P]=d.useState(!1),[q,I]=d.useState(!1);d.useEffect(()=>{t.get("expired")==="true"&&(I(!0),window.history.replaceState({},document.title,"/login")),f.auth.getSession().then(({data:{session:j}})=>{j&&i("/dashboard",{replace:!0})});const{data:{subscription:S}}=f.auth.onAuthStateChange((j,M)=>{j==="SIGNED_IN"&&M&&i("/dashboard",{replace:!0})});return()=>S.unsubscribe()},[i,t]);const b=async S=>{S.preventDefault(),r(!0),h(null),g(null),I(!1);try{if(p){const{error:j}=await f.auth.signUp({email:a,password:o,options:{data:{full_name:a.split("@")[0]}}});if(j)throw j;g("Check your email for confirmation link!")}else{const{error:j}=await f.auth.signInWithPassword({email:a,password:o});if(j)throw j}}catch(j){h(j.message)}finally{r(!1)}},C=async S=>{if(S.preventDefault(),!a){h("Please enter your email address");return}r(!0),h(null),g(null);try{const{error:j}=await f.auth.resetPasswordForEmail(a,{redirectTo:`${window.location.origin}/reset-password`});if(j)throw j;g("Password reset email sent! Check your inbox.")}catch(j){h(j.message)}finally{r(!1)}},k=async S=>{if(S.preventDefault(),!a){h("Please enter your email address");return}r(!0),h(null),g(null);try{const{error:j}=await f.auth.resend({type:"signup",email:a});if(j)throw j;g("Verification email resent! Check your inbox.")}catch(j){h(j.message)}finally{r(!1)}},E=()=>{u(!1),P(!1),h(null),g(null),I(!1)};return x?s.jsx("div",{className:"auth-container",children:s.jsxs("div",{className:"auth-box",children:[s.jsxs("div",{className:"auth-logo",children:[s.jsx(cr,{size:40,style:{color:"var(--primary)",marginBottom:"0.5rem"}}),s.jsx("h1",{className:"auth-title",children:"Reset Password"}),s.jsx("p",{className:"auth-subtitle",children:"Enter your email to receive a reset link"})]}),s.jsxs("form",{onSubmit:C,children:[s.jsxs("div",{className:"form-group",children:[s.jsx("label",{className:"form-label",htmlFor:"email",children:"Email Address"}),s.jsx("input",{id:"email",className:"form-input",type:"email",placeholder:"you@example.com",value:a,onChange:S=>n(S.target.value),required:!0})]}),l&&s.jsxs("div",{style:{padding:"0.75rem",background:"#fee2e2",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#991b1b"},children:[s.jsx(Ce,{size:20}),s.jsx("span",{style:{fontSize:"0.875rem"},children:l})]}),m&&s.jsxs("div",{style:{padding:"0.75rem",background:"#dcfce7",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#166534"},children:[s.jsx(Ee,{size:20}),s.jsx("span",{style:{fontSize:"0.875rem"},children:m})]}),s.jsx("button",{type:"submit",className:"btn btn-primary",disabled:e,style:{width:"100%",justifyContent:"center"},children:e?"Sending...":"Send Reset Link"})]}),s.jsx("div",{style:{marginTop:"1.5rem",textAlign:"center"},children:s.jsx("button",{onClick:E,style:{background:"none",border:"none",color:"var(--primary)",cursor:"pointer",fontSize:"0.875rem"},children:"â† Back to Sign In"})})]})}):v?s.jsx("div",{className:"auth-container",children:s.jsxs("div",{className:"auth-box",children:[s.jsxs("div",{className:"auth-logo",children:[s.jsx(le,{size:40,style:{color:"var(--primary)",marginBottom:"0.5rem"}}),s.jsx("h1",{className:"auth-title",children:"Resend Verification"}),s.jsx("p",{className:"auth-subtitle",children:"Enter your email to resend the verification link"})]}),s.jsxs("form",{onSubmit:k,children:[s.jsxs("div",{className:"form-group",children:[s.jsx("label",{className:"form-label",htmlFor:"email",children:"Email Address"}),s.jsx("input",{id:"email",className:"form-input",type:"email",placeholder:"you@example.com",value:a,onChange:S=>n(S.target.value),required:!0})]}),l&&s.jsxs("div",{style:{padding:"0.75rem",background:"#fee2e2",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#991b1b"},children:[s.jsx(Ce,{size:20}),s.jsx("span",{style:{fontSize:"0.875rem"},children:l})]}),m&&s.jsxs("div",{style:{padding:"0.75rem",background:"#dcfce7",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#166534"},children:[s.jsx(Ee,{size:20}),s.jsx("span",{style:{fontSize:"0.875rem"},children:m})]}),s.jsx("button",{type:"submit",className:"btn btn-primary",disabled:e,style:{width:"100%",justifyContent:"center"},children:e?"Sending...":"Resend Verification Email"})]}),s.jsx("div",{style:{marginTop:"1.5rem",textAlign:"center"},children:s.jsx("button",{onClick:E,style:{background:"none",border:"none",color:"var(--primary)",cursor:"pointer",fontSize:"0.875rem"},children:"â† Back to Sign In"})})]})}):s.jsx("div",{className:"auth-container",children:s.jsxs("div",{className:"auth-box",children:[s.jsxs("div",{className:"auth-logo",children:[s.jsx("h1",{className:"auth-title",children:"AMSF001 Tracker"}),s.jsx("p",{className:"auth-subtitle",children:"Network Architecture Services Project"})]}),q&&s.jsxs("div",{style:{padding:"0.75rem",background:"#fef3c7",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#92400e",border:"1px solid #fcd34d"},children:[s.jsx(de,{size:20}),s.jsx("span",{style:{fontSize:"0.875rem"},children:"Your session has expired. Please sign in again."})]}),s.jsxs("form",{onSubmit:b,children:[s.jsxs("div",{className:"form-group",children:[s.jsx("label",{className:"form-label",htmlFor:"email",children:"Email Address"}),s.jsx("input",{id:"email",className:"form-input",type:"email",placeholder:"you@example.com",value:a,onChange:S=>n(S.target.value),required:!0})]}),s.jsxs("div",{className:"form-group",children:[s.jsx("label",{className:"form-label",htmlFor:"password",children:"Password"}),s.jsx("input",{id:"password",className:"form-input",type:"password",placeholder:"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢",value:o,onChange:S=>c(S.target.value),required:!0})]}),l&&s.jsxs("div",{style:{padding:"0.75rem",background:"#fee2e2",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#991b1b"},children:[s.jsx(Ce,{size:20}),s.jsx("span",{style:{fontSize:"0.875rem"},children:l})]}),m&&s.jsxs("div",{style:{padding:"0.75rem",background:"#dcfce7",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#166534"},children:[s.jsx(Ee,{size:20}),s.jsx("span",{style:{fontSize:"0.875rem"},children:m})]}),s.jsx("button",{type:"submit",className:"btn btn-primary",disabled:e,style:{width:"100%",justifyContent:"center"},children:e?"Loading...":p?"Sign Up":"Sign In"})]}),!p&&s.jsx("div",{style:{marginTop:"1rem",textAlign:"center"},children:s.jsx("button",{onClick:()=>{u(!0),h(null),g(null),I(!1)},style:{background:"none",border:"none",color:"#64748b",cursor:"pointer",fontSize:"0.85rem",textDecoration:"underline"},children:"Forgot your password?"})}),s.jsx("div",{style:{marginTop:"1rem",textAlign:"center"},children:s.jsx("button",{onClick:()=>{_(!p),h(null),g(null),I(!1)},style:{background:"none",border:"none",color:"var(--primary)",cursor:"pointer",fontSize:"0.875rem"},children:p?"Already have an account? Sign In":"Don't have an account? Sign Up"})}),s.jsxs("div",{style:{marginTop:"1.5rem",paddingTop:"1rem",borderTop:"1px solid #e2e8f0",textAlign:"center"},children:[s.jsx("p",{style:{fontSize:"0.8rem",color:"#64748b",marginBottom:"0.5rem"},children:"Haven't received your verification email?"}),s.jsxs("button",{onClick:()=>{P(!0),h(null),g(null),I(!1)},style:{background:"none",border:"none",color:"var(--primary)",cursor:"pointer",fontSize:"0.85rem",display:"inline-flex",alignItems:"center",gap:"0.25rem"},children:[s.jsx(le,{size:14})," Resend Verification Email"]})]})]})})}const ks={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function Rs(i){return i==null?"":typeof i!="string"?String(i):i.replace(/[&<>"'`=\/]/g,t=>ks[t])}function ze(i,t={}){const{maxLength:e=1e4,trim:r=!0,normalizeWhitespace:a=!0}=t;if(i==null)return"";typeof i!="string"&&(i=String(i));let n=i;return n=n.replace(/\0/g,""),n=n.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,""),r&&(n=n.trim()),a&&(n=n.replace(/[ \t]+/g," ")),n.length>e&&(n=n.substring(0,e)),n}function pe(i,t=255){return i==null?"":(typeof i!="string"&&(i=String(i)),ze(i,{maxLength:t}).replace(/[\r\n]/g," ").replace(/\s+/g," ").trim())}function Et(i,t=1e4){return i==null?"":(typeof i!="string"&&(i=String(i)),ze(i,{maxLength:t,normalizeWhitespace:!1}).replace(/\r\n/g,`
`).replace(/\r/g,`
`).replace(/\n{3,}/g,`

`).trim())}function kt(i){return i?pe(i,254).toLowerCase():""}function xe(i,t={}){const{min:e=-1/0,max:r=1/0,decimals:a=2}=t;if(i==null||i==="")return null;let n=String(i).replace(/[^0-9.\-]/g,""),o=parseFloat(n);return isNaN(o)?null:(o=Math.max(e,Math.min(r,o)),o=Math.round(o*Math.pow(10,a))/Math.pow(10,a),o)}function Ps(i){const t=xe(i,{min:0,decimals:2});return t!==null?Math.round(t*100)/100:null}function Ns(i){const t=xe(i,{min:0,max:24,decimals:1});return t===null?null:Math.round(t*2)/2}function Is(i){return xe(i,{min:0,max:100,decimals:1})}function As(i){if(!i)return null;const t=String(i).trim();return/^(javascript|data|vbscript):/i.test(t)?null:/^(https?:\/\/|\/|#)/i.test(t)?t:`https://${t}`}function Ds(i,t={}){if(!i||typeof i!="object")return i;const e={...i};for(const[r,a]of Object.entries(t)){if(e[r]===void 0)continue;const{type:n="text",maxLength:o}=a;switch(n){case"singleLine":e[r]=pe(e[r],o);break;case"multiLine":e[r]=Et(e[r],o);break;case"email":e[r]=kt(e[r]);break;case"number":e[r]=xe(e[r],a);break;case"currency":e[r]=Ps(e[r]);break;case"hours":e[r]=Ns(e[r]);break;case"percentage":e[r]=Is(e[r]);break;case"url":e[r]=As(e[r]);break;case"html":e[r]=Rs(e[r]);break;default:e[r]=ze(e[r],{maxLength:o})}}return e}const Ms={timesheet:{description:{type:"multiLine",maxLength:2e3},hours_worked:{type:"hours"}},expense:{reason:{type:"multiLine",maxLength:2e3},amount:{type:"currency"}},resource:{name:{type:"singleLine",maxLength:100},email:{type:"email"},role:{type:"singleLine",maxLength:100},notes:{type:"multiLine",maxLength:5e3}},partner:{name:{type:"singleLine",maxLength:200},contact_name:{type:"singleLine",maxLength:100},contact_email:{type:"email"},notes:{type:"multiLine",maxLength:5e3}},milestone:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3}},deliverable:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3}},kpi:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3},target_value:{type:"number",decimals:2},actual_value:{type:"number",decimals:2}},qualityStandard:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3},target_value:{type:"percentage"}}};function et(i,t){const e=Ms[i];return e?Ds(t,e):t}class Y{constructor(t,e={}){this.tableName=t,this.supportsSoftDelete=e.supportsSoftDelete!==!1,this.sanitizeConfig=e.sanitizeConfig||null}getSoftDeleteFilter(){return this.supportsSoftDelete?"is_deleted.is.null,is_deleted.eq.false":null}async getAll(t,e={}){try{let r=e.select||"*";const a=this.supportsSoftDelete&&!e.includeDeleted;a&&r!=="*"&&!r.includes("is_deleted")&&(r=`${r}, is_deleted`);let n=f.from(this.tableName).select(r).eq("project_id",t);e.filters&&Array.isArray(e.filters)&&e.filters.forEach(h=>{const{column:m,operator:g,value:p}=h;switch(g){case"eq":n=n.eq(m,p);break;case"neq":n=n.neq(m,p);break;case"gt":n=n.gt(m,p);break;case"gte":n=n.gte(m,p);break;case"lt":n=n.lt(m,p);break;case"lte":n=n.lte(m,p);break;case"like":n=n.like(m,p);break;case"ilike":n=n.ilike(m,p);break;case"in":n=n.in(m,p);break;case"is":n=n.is(m,p);break;default:n=n.eq(m,p)}}),e.orderBy&&(n=n.order(e.orderBy.column,{ascending:e.orderBy.ascending??!0}));const{data:o,error:c}=await n;if(c)throw c;let l=o||[];return a&&(l=l.filter(h=>h.is_deleted!==!0)),l}catch(r){throw r}}async getDeleted(t){if(!this.supportsSoftDelete)return[];try{const{data:e,error:r}=await f.from(this.tableName).select("*").eq("project_id",t).eq("is_deleted",!0).order("deleted_at",{ascending:!1});if(r)throw r;return e||[]}catch(e){throw e}}async getById(t,e={}){try{let r=e.select||"*";const a=this.supportsSoftDelete&&!e.includeDeleted;a&&r!=="*"&&!r.includes("is_deleted")&&(r=`${r}, is_deleted`);let n=f.from(this.tableName).select(r).eq("id",t);const{data:o,error:c}=await n.limit(1);if(c)throw c;const l=o&&o.length>0?o[0]:null;return l&&a&&l.is_deleted===!0?null:l}catch(r){throw r}}async create(t){try{if(!t.project_id)throw new Error("project_id is required");let e=t;this.sanitizeConfig&&(e=et(this.sanitizeConfig,t)),this.supportsSoftDelete&&(delete e.is_deleted,delete e.deleted_at,delete e.deleted_by);const{data:r,error:a}=await f.from(this.tableName).insert(e).select();if(a)throw a;if(!r||r.length===0)throw new Error("Failed to create record - no data returned");return r[0]}catch(e){throw e}}async update(t,e){try{let r=e;this.sanitizeConfig&&(r=et(this.sanitizeConfig,e));const a={...r,updated_at:new Date().toISOString()};delete a.is_deleted,delete a.deleted_at,delete a.deleted_by;const{data:n,error:o}=await f.from(this.tableName).update(a).eq("id",t).select();if(o)throw o;if(!n||n.length===0)throw new Error(`No record found with id: ${t}`);return n[0]}catch(r){throw r}}async delete(t,e=null){try{if(this.supportsSoftDelete){const{error:r}=await f.from(this.tableName).update({is_deleted:!0,deleted_at:new Date().toISOString(),deleted_by:e}).eq("id",t);if(r)throw r}else{const{error:r}=await f.from(this.tableName).delete().eq("id",t);if(r)throw r}return!0}catch(r){throw r}}async hardDelete(t){try{const{error:e}=await f.from(this.tableName).delete().eq("id",t);if(e)throw e;return!0}catch(e){throw e}}async restore(t){if(!this.supportsSoftDelete)throw new Error("This entity does not support soft delete");try{const{data:e,error:r}=await f.from(this.tableName).update({is_deleted:!1,deleted_at:null,deleted_by:null}).eq("id",t).select();if(r)throw r;if(!e||e.length===0)throw new Error(`No record found with id: ${t}`);return e[0]}catch(e){throw e}}async exists(t){try{const{data:e,error:r}=await f.from(this.tableName).select("id, is_deleted").eq("id",t).limit(1);if(r)throw r;if(!e||e.length===0)return!1;const a=e[0];return!(this.supportsSoftDelete&&a.is_deleted===!0)}catch(e){throw e}}async count(t,e=[]){try{let r=f.from(this.tableName).select("id, is_deleted").eq("project_id",t);e.forEach(c=>{const{column:l,operator:h,value:m}=c;h==="eq"?r=r.eq(l,m):h==="in"&&(r=r.in(l,m))});const{data:a,error:n}=await r;if(n)throw n;let o=a||[];return this.supportsSoftDelete&&(o=o.filter(c=>c.is_deleted!==!0)),o.length}catch(r){throw r}}}class Ts extends Y{constructor(){super("partners")}async getAll(t){return super.getAll(t,{orderBy:{column:"name",ascending:!0}})}async getActive(t){return super.getAll(t,{filters:[{column:"is_active",operator:"eq",value:!0}],orderBy:{column:"name",ascending:!0}})}async getWithResources(t){try{const{data:e,error:r}=await f.from("partners").select(`
          *,
          resources (
            id,
            name,
            sell_price,
            cost_price,
            is_active
          )
        `).eq("id",t).limit(1);if(r)throw r;return e?.[0]||null}catch(e){throw e}}async getSummary(t){try{const{data:e,error:r}=await f.from("partners").select(`
          id,
          name,
          contact_name,
          contact_email,
          payment_terms,
          is_active,
          created_at
        `).eq("project_id",t).order("name",{ascending:!0});if(r)throw r;return e||[]}catch(e){throw e}}async create(t){if(!t.name?.trim())throw new Error("Partner name is required");if(await this.findByName(t.project_id,t.name))throw new Error(`Partner "${t.name}" already exists`);return super.create({...t,name:t.name.trim(),is_active:t.is_active??!0,payment_terms:t.payment_terms||"Net 30"})}async findByName(t,e){try{const{data:r,error:a}=await f.from("partners").select("*").eq("project_id",t).ilike("name",e.trim()).limit(1);if(a)throw a;return r?.[0]||null}catch(r){throw r}}async toggleActive(t){const e=await this.getById(t);if(!e)throw new Error("Partner not found");return this.update(t,{is_active:!e.is_active})}async getForSelect(t,e=!0){return(e?await this.getActive(t):await this.getAll(t)).map(a=>({value:a.id,label:a.name}))}async getDependencyCounts(t){try{const{data:e,error:r}=await f.from("resources").select("id").eq("partner_id",t).or("is_deleted.is.null,is_deleted.eq.false");if(r)throw r;const a=e?.map(h=>h.id)||[];let n=0,o=0;if(a.length>0){const{count:h,error:m}=await f.from("timesheets").select("*",{count:"exact",head:!0}).in("resource_id",a).or("is_deleted.is.null,is_deleted.eq.false");if(m)throw m;n=h||0;const{count:g,error:p}=await f.from("expenses").select("*",{count:"exact",head:!0}).in("resource_id",a).or("is_deleted.is.null,is_deleted.eq.false");if(p)throw p;o=g||0}const{count:c,error:l}=await f.from("partner_invoices").select("*",{count:"exact",head:!0}).eq("partner_id",t).or("is_deleted.is.null,is_deleted.eq.false");if(l)throw l;return{resourceCount:e?.length||0,timesheetCount:n,expenseCount:o,invoiceCount:c||0,canDelete:!e?.length&&!c}}catch(e){throw e}}}const Ea=new Ts;class qs extends Y{constructor(){super("resources",{sanitizeConfig:"resource",supportsSoftDelete:!0})}sanitizeData(t){const e={...t};return e.name&&(e.name=pe(e.name,100)),e.role&&(e.role=pe(e.role,100)),e.email&&(e.email=kt(e.email)),e.notes&&(e.notes=Et(e.notes,5e3)),e}async getAll(t,e={}){const{includePartner:r=!0,activeOnly:a=!1,showTestUsers:n=!0,includeDeleted:o=!1}=e;let c="*";r&&(c="*, partner:partners(id, name, is_active)");let l=f.from(this.tableName).select(c).eq("project_id",t).order("name");o||(l=l.or("is_deleted.is.null,is_deleted.eq.false")),a&&(l=l.eq("is_active",!0)),n||(l=l.or("is_test_content.is.null,is_test_content.eq.false"));const{data:h,error:m}=await l;if(m)throw m;return h||[]}async getAllFiltered(t,e=!0){return this.getAll(t,{showTestUsers:e,includePartner:!0})}async getById(t){const{data:e,error:r}=await f.from(this.tableName).select("*, partner:partners(id, name, contact_name, contact_email, is_active)").eq("id",t).or("is_deleted.is.null,is_deleted.eq.false").single();if(r)throw r;return e}async getByType(t,e){const{data:r,error:a}=await f.from(this.tableName).select("*, partner:partners(id, name)").eq("project_id",t).eq("resource_type",e).or("is_deleted.is.null,is_deleted.eq.false").order("name");if(a)throw a;return r||[]}async getByPartner(t){const{data:e,error:r}=await f.from(this.tableName).select("*").eq("partner_id",t).or("is_deleted.is.null,is_deleted.eq.false").order("name");if(r)throw r;return e||[]}async getWithTimesheetSummary(t){const e=await this.getById(t);if(!e)return null;const{data:r,error:a}=await f.from("timesheets").select("id, hours_worked, hours, status, was_rejected, date").eq("resource_id",t).or("is_deleted.is.null,is_deleted.eq.false");let n=0,o=0,c=0;return r&&r.forEach(l=>{const h=parseFloat(l.hours_worked||l.hours||0);n+=h,l.status==="Approved"?o+=h:l.status==="Submitted"&&!l.was_rejected&&(c+=h)}),{...e,timesheetSummary:{totalEntries:r?.length||0,totalHours:n,approvedHours:o,pendingHours:c,daysWorked:ne(n)}}}async create(t){const e=this.sanitizeData(t);if(!e.name?.trim())throw new Error("Resource name is required");if(!e.project_id)throw new Error("Project ID is required");if(!e.email?.trim())throw new Error("Email is required");e.resource_type==="internal"&&(e.partner_id=null);const{data:r,error:a}=await f.from(this.tableName).insert([e]).select("*, partner:partners(id, name)").single();if(a)throw a;return r}async update(t,e){const r=this.sanitizeData(e);r.resource_type==="internal"&&(r.partner_id=null),r.updated_at=new Date().toISOString();const{data:a,error:n}=await f.from(this.tableName).update(r).eq("id",t).select("*, partner:partners(id, name)").single();if(n)throw n;return a}async delete(t,e=null){const{data:r,error:a}=await f.from(this.tableName).update({is_deleted:!0,deleted_at:new Date().toISOString(),deleted_by:e}).eq("id",t).select().single();if(a)throw a;return r}async restore(t){const{data:e,error:r}=await f.from(this.tableName).update({is_deleted:!1,deleted_at:null,deleted_by:null}).eq("id",t).select().single();if(r)throw r;return e}async linkToPartner(t,e){const r={partner_id:e,resource_type:e?"third_party":"internal",updated_at:new Date().toISOString()};return this.update(t,r)}async toggleActive(t){const e=await this.getById(t);if(!e)throw new Error("Resource not found");return this.update(t,{is_active:!e.is_active})}async getForSelect(t){const{data:e,error:r}=await f.from(this.tableName).select("id, name, resource_type, role").eq("project_id",t).or("is_deleted.is.null,is_deleted.eq.false").order("name");if(r)throw r;return e||[]}calculateMargin(t,e){if(!t||t===0||!e)return{percent:null,amount:null,status:"unknown"};const r=(t-e)/t*100,a=t-e;let n="critical";return r>=25?n="good":r>=10&&(n="low"),{percent:r,amount:a,status:n}}async getUtilization(t){const e=await this.getWithTimesheetSummary(t);if(!e)return null;const r=e.days_allocated||0,a=e.timesheetSummary.daysWorked,n=Math.max(0,r-a),o=r>0?a/r*100:0;return{resourceId:t,resourceName:e.name,daysAllocated:r,daysUsed:a,remaining:n,utilizationPercent:o,totalValue:(e.sell_price||0)*r,valueUsed:(e.sell_price||0)*a}}async getSummary(t){const e=await this.getAll(t,{includePartner:!1});return{total:e.length,internal:e.filter(r=>r.resource_type==="internal").length,thirdParty:e.filter(r=>r.resource_type==="third_party").length,active:e.filter(r=>r.is_active).length,totalBudget:e.reduce((r,a)=>r+(a.sell_price||0)*(a.days_allocated||0),0)}}async getProfileByEmail(t){try{const{data:e,error:r}=await this.supabase.from("profiles").select("id, email, full_name, role").eq("email",t).single();if(r){if(r.code==="PGRST116")return null;throw r}return e}catch(e){throw e}}async getAllWithTestFilter(t,e=[]){try{const r=await this.getAll(t,{orderBy:{column:"name",ascending:!0}});return e&&e.length>0?r.filter(a=>!a.user_id||!e.includes(a.user_id)):r}catch(r){throw r}}async getDependencyCounts(t){try{const[e,r]=await Promise.all([this.supabase.from("timesheets").select("id",{count:"exact",head:!0}).eq("resource_id",t).or("is_deleted.is.null,is_deleted.eq.false"),this.supabase.from("expenses").select("id",{count:"exact",head:!0}).eq("resource_id",t).or("is_deleted.is.null,is_deleted.eq.false")]);return{timesheetCount:e.count||0,expenseCount:r.count||0,canDelete:(e.count||0)===0&&(r.count||0)===0}}catch(e){throw e}}}const ka=new qs;class Os extends Y{constructor(){super("timesheets",{supportsSoftDelete:!0,sanitizeConfig:"timesheet"})}async getAll(t,e={}){return super.getAll(t,{...e,select:e.select||`
      *,
      resources(id, name, email, sell_price, cost_price),
      milestones(id, milestone_ref, name)
    `,orderBy:e.orderBy||{column:"date",ascending:!1}})}async getAllFiltered(t,e=!1){try{let r=f.from(this.tableName).select(`
          *,
          resources(id, name, email, sell_price, cost_price),
          milestones(id, milestone_ref, name)
        `).eq("project_id",t).order("date",{ascending:!1});this.supportsSoftDelete&&(r=r.or(this.getSoftDeleteFilter())),e||(r=r.or("is_test_content.is.null,is_test_content.eq.false"));const{data:a,error:n}=await r;if(n)throw n;return a||[]}catch(r){throw r}}async getByResource(t,e={}){try{let r=f.from(this.tableName).select("*, milestones(id, milestone_ref, name)").eq("resource_id",t).order("date",{ascending:!1});this.supportsSoftDelete&&(r=r.or(this.getSoftDeleteFilter())),e.start&&(r=r.gte("date",e.start)),e.end&&(r=r.lte("date",e.end)),e.status&&(r=r.eq("status",e.status));const{data:a,error:n}=await r;if(n)throw n;return a||[]}catch(r){throw r}}async getByPartner(t,e={}){try{const{data:r}=await f.from("resources").select("id, name, cost_price").eq("partner_id",t).or("is_deleted.is.null,is_deleted.eq.false");if(!r||r.length===0)return[];const a=r.map(l=>l.id);let n=f.from(this.tableName).select("*, resources(id, name, cost_price), milestones(id, milestone_ref, name)").in("resource_id",a).order("date",{ascending:!1});this.supportsSoftDelete&&(n=n.or(this.getSoftDeleteFilter())),e.start&&(n=n.gte("date",e.start)),e.end&&(n=n.lte("date",e.end)),e.status&&(n=n.eq("status",e.status));const{data:o,error:c}=await n;if(c)throw c;return o||[]}catch(r){throw r}}async getApprovedForInvoice(t,e){if(!e.start||!e.end)throw new Error("Date range (start and end) is required for invoice queries");return this.getByPartner(t,{...e,status:"Approved"})}async getSummary(t,e={}){try{const r=await this.getAll(t,e),a={totalHours:0,totalDays:0,approvedHours:0,pendingHours:0,draftHours:0,rejectedHours:0,totalCost:0,approvedCost:0,byStatus:{Draft:{count:0,hours:0},Submitted:{count:0,hours:0},Approved:{count:0,hours:0},Rejected:{count:0,hours:0}},byMilestone:{},count:r.length};return r.forEach(n=>{const o=parseFloat(n.hours_worked||n.hours||0),c=n.resources?.cost_price||0,l=Ye(o,c);switch(a.totalHours+=o,a.totalCost+=l,a.byStatus[n.status]&&(a.byStatus[n.status].count++,a.byStatus[n.status].hours+=o),n.status){case"Approved":a.approvedHours+=o,a.approvedCost+=l;break;case"Submitted":n.was_rejected||(a.pendingHours+=o);break;case"Draft":a.draftHours+=o;break;case"Rejected":a.rejectedHours+=o;break}if(n.milestone_id){const h=n.milestones?.milestone_ref||"Unknown";a.byMilestone[n.milestone_id]||(a.byMilestone[n.milestone_id]={ref:h,name:n.milestones?.name||"Unknown",hours:0,cost:0}),a.byMilestone[n.milestone_id].hours+=o,a.byMilestone[n.milestone_id].cost+=l}}),a.totalDays=ne(a.totalHours),a}catch(r){throw r}}async create(t){if(!t.resource_id)throw new Error("resource_id is required");if(!t.date)throw new Error("date is required");const e=parseFloat(t.hours_worked||t.hours||0);if(!e||e<=0)throw new Error("hours must be greater than 0");const r={...t,hours_worked:e,hours:e,date:t.date||t.work_date,work_date:t.work_date||t.date,description:t.description||t.comments||"",comments:t.comments||t.description||"",status:t.status||"Draft"};return super.create(r)}async submit(t){return this.update(t,{status:"Submitted"})}async validate(t){return this.update(t,{status:"Approved"})}async approve(t){return this.validate(t)}async reject(t,e=null){const r={status:"Rejected",was_rejected:!0};return e&&(r.rejection_reason=e),this.update(t,r)}calculateCost(t,e){return Ye(t,e)}calculateBillable(t,e){return cs(t,e)}}const Ra=new Os;class Ls extends Y{constructor(){super("expenses",{supportsSoftDelete:!0,sanitizeConfig:"expense"})}async getAll(t,e={}){return super.getAll(t,{...e,select:e.select||"*, expense_files(*)",orderBy:e.orderBy||{column:"expense_date",ascending:!1}})}async getAllFiltered(t,e=!1){try{let r=f.from(this.tableName).select("*, expense_files(*)").eq("project_id",t).order("expense_date",{ascending:!1});const{data:a,error:n}=await r;if(n)throw n;let o=a||[];return this.supportsSoftDelete&&(o=o.filter(c=>c.is_deleted!==!0)),e||(o=o.filter(c=>c.is_test_content!==!0)),o}catch(r){throw r}}async getByResource(t,e={}){try{let r=f.from(this.tableName).select("*, expense_files(*)").eq("resource_id",t).order("expense_date",{ascending:!1});e.start&&(r=r.gte("expense_date",e.start)),e.end&&(r=r.lte("expense_date",e.end));const{data:a,error:n}=await r;if(n)throw n;let o=a||[];return this.supportsSoftDelete&&(o=o.filter(c=>c.is_deleted!==!0)),o}catch(r){throw r}}async getByPartner(t,e={}){try{const{data:r}=await f.from("resources").select("id").eq("partner_id",t);if(!r||r.length===0)return[];const a=r.map(h=>h.id);let n=f.from(this.tableName).select("*, expense_files(*)").in("resource_id",a).order("expense_date",{ascending:!1});e.start&&(n=n.gte("expense_date",e.start)),e.end&&(n=n.lte("expense_date",e.end)),e.procurementMethod&&(n=n.eq("procurement_method",e.procurementMethod));const{data:o,error:c}=await n;if(c)throw c;let l=o||[];return this.supportsSoftDelete&&(l=l.filter(h=>h.is_deleted!==!0)),l}catch(r){throw r}}async getPartnerProcuredForInvoice(t,e){if(!e.start||!e.end)throw new Error("Date range (start and end) is required for invoice queries");return this.getByPartner(t,{...e,procurementMethod:"partner"})}async getSummary(t,e={}){try{const r=await this.getAll(t,e),a={total:0,chargeable:0,nonChargeable:0,supplierProcured:0,partnerProcured:0,byCategory:{Travel:0,Accommodation:0,Sustenance:0},byStatus:{Draft:0,Submitted:0,Approved:0,Rejected:0,Paid:0},count:r.length};return r.forEach(n=>{const o=parseFloat(n.amount||0);a.total+=o,n.chargeable_to_customer!==!1?a.chargeable+=o:a.nonChargeable+=o,n.procurement_method==="partner"?a.partnerProcured+=o:a.supplierProcured+=o,a.byCategory[n.category]!==void 0&&(a.byCategory[n.category]+=o),a.byStatus[n.status]!==void 0&&(a.byStatus[n.status]+=o)}),a}catch(r){throw r}}async create(t){if(!t.resource_id)throw new Error("resource_id is required");if(!t.category)throw new Error("category is required");if(!t.amount||t.amount<=0)throw new Error("amount must be greater than 0");const e={...t,status:t.status||"Draft",chargeable_to_customer:t.chargeable_to_customer??!0,procurement_method:t.procurement_method||"supplier"};return super.create(e)}async createMany(t){if(!t||t.length===0)return[];try{const e=t.map(n=>{if(!n.resource_id)throw new Error("resource_id is required for all expenses");if(!n.category)throw new Error("category is required for all expenses");if(!n.amount||n.amount<=0)throw new Error("amount must be greater than 0 for all expenses");return{...n,status:n.status||"Draft",chargeable_to_customer:n.chargeable_to_customer??!0,procurement_method:n.procurement_method||"supplier"}}),{data:r,error:a}=await f.from(this.tableName).insert(e).select();if(a)throw a;return r||[]}catch(e){throw e}}async submit(t){return this.update(t,{status:"Submitted"})}async validate(t){return this.update(t,{status:"Approved"})}async approve(t){return this.validate(t)}async reject(t,e=null){const r={status:"Rejected"};return e&&(r.rejection_reason=e),this.update(t,r)}async markPaid(t){return this.update(t,{status:"Paid"})}async uploadReceipt(t,e,r){try{const a=`${t}/${Date.now()}-${e.name}`,{error:n}=await f.storage.from("receipts").upload(a,e);if(n)throw n;const{data:o,error:c}=await f.from("expense_files").insert({expense_id:t,file_name:e.name,file_path:a,file_size:e.size,file_type:e.type,uploaded_by:r}).select();if(c)throw c;return o?.[0]}catch(a){throw a}}async downloadReceipt(t){try{const{data:e,error:r}=await f.storage.from("receipts").download(t);if(r)throw r;return e}catch(e){throw e}}}const Pa=new Ls;class zs extends Y{constructor(){super("partner_invoices")}async getAll(t,e={}){return super.getAll(t,{...e,select:e.select||"*, partners(name)",orderBy:e.orderBy||{column:"invoice_date",ascending:!1}})}async getByPartner(t,e={}){try{let r=f.from(this.tableName).select("*").eq("partner_id",t).order("invoice_date",{ascending:!1});e.status&&(r=r.eq("status",e.status));const{data:a,error:n}=await r;if(n)throw n;return a||[]}catch(r){throw r}}async getWithLines(t){try{const{data:e,error:r}=await f.from(this.tableName).select("*, partners(name, contact_name, contact_email, payment_terms)").eq("id",t).limit(1);if(r)throw r;const a=e?.[0];if(!a)return null;const{data:n,error:o}=await f.from("partner_invoice_lines").select("*").eq("invoice_id",t).order("line_type",{ascending:!0}).order("resource_name",{ascending:!0}).order("line_date",{ascending:!0});if(o)throw o;const c={timesheets:(n||[]).filter(l=>l.line_type==="timesheet"),supplierExpenses:(n||[]).filter(l=>l.line_type==="supplier_expense"),partnerExpenses:(n||[]).filter(l=>l.line_type==="expense")};return{...a,lines:n||[],groupedLines:c}}catch(e){throw e}}async generateInvoiceNumber(t){try{const r=`INV-${new Date().getFullYear()}-`,{data:a,error:n}=await f.from(this.tableName).select("invoice_number").eq("project_id",t).like("invoice_number",`${r}%`).order("invoice_number",{ascending:!1}).limit(1);if(n)throw n;let o=1;if(a&&a.length>0){const c=a[0].invoice_number,l=parseInt(c.replace(r,""),10);isNaN(l)||(o=l+1)}return`${r}${String(o).padStart(3,"0")}`}catch(e){throw e}}async generateInvoice(t){const{projectId:e,partnerId:r,periodStart:a,periodEnd:n,createdBy:o,notes:c,includeSubmitted:l=!0}=t;try{const{data:h,error:m}=await f.from("resources").select("id, name, cost_price").eq("partner_id",r);if(m)throw m;if(!h||h.length===0)throw new Error("No resources linked to this partner");const g=h.map(w=>w.id),p={};h.forEach(w=>{p[w.id]=w});const _=l?["Approved","Submitted"]:["Approved"],{data:x,error:u}=await f.from("timesheets").select("id, date, hours_worked, hours, status, resource_id").in("resource_id",g).gte("date",a).lte("date",n).in("status",_);if(u)throw u;const{data:v,error:P}=await f.from("expenses").select("id, expense_date, category, reason, amount, resource_id, resource_name, procurement_method, chargeable_to_customer, status").in("resource_id",g).gte("expense_date",a).lte("expense_date",n).in("status",["Approved","Submitted","Paid"]);if(P)throw P;const q=(v||[]).filter(w=>w.procurement_method==="partner"||!w.procurement_method),I=(v||[]).filter(w=>w.procurement_method==="supplier");let b=0,C=0;const k=[],E={};(x||[]).forEach(w=>{E[w.resource_id]||(E[w.resource_id]=[]),E[w.resource_id].push(w)}),Object.keys(E).forEach(w=>{const L=p[w];E[w].forEach(F=>{const he=parseFloat(F.hours_worked||F.hours||0),we=L?.cost_price||0,Be=ne(he),be=Be*we;b+=be,C+=be,k.push({line_type:"timesheet",timesheet_id:F.id,expense_id:null,description:`${L?.name||"Unknown"} - ${he}h (${Be.toFixed(2)} days)`,quantity:he,unit_price:we,line_total:be,resource_name:L?.name,line_date:F.date,hours:he,cost_price:we,source_status:F.status,chargeable_to_customer:!0,procurement_method:null,expense_category:null})})});let S=0,j=0,M=0;const A=[];q.forEach(w=>{const L=parseFloat(w.amount||0);S+=L,w.chargeable_to_customer?j+=L:M+=L,A.push({line_type:"expense",timesheet_id:null,expense_id:w.id,description:`${w.resource_name} - ${w.category}: ${w.reason}`,quantity:1,unit_price:L,line_total:L,resource_name:w.resource_name,line_date:w.expense_date,hours:null,cost_price:null,source_status:w.status,chargeable_to_customer:w.chargeable_to_customer,procurement_method:"partner",expense_category:w.category})});let N=0,V=0,J=0;const se=[];I.forEach(w=>{const L=parseFloat(w.amount||0);N+=L,w.chargeable_to_customer?V+=L:J+=L,se.push({line_type:"supplier_expense",timesheet_id:null,expense_id:w.id,description:`${w.resource_name} - ${w.category}: ${w.reason}`,quantity:1,unit_price:L,line_total:L,resource_name:w.resource_name,line_date:w.expense_date,hours:null,cost_price:null,source_status:w.status,chargeable_to_customer:w.chargeable_to_customer,procurement_method:"supplier",expense_category:w.category})});const R=b+S,U=C+j+V,Z=M+J,X=await this.generateInvoiceNumber(e),{data:W,error:$}=await f.from(this.tableName).insert({project_id:e,partner_id:r,invoice_number:X,invoice_date:new Date().toISOString().split("T")[0],period_start:a,period_end:n,timesheet_total:b,expense_total:S,supplier_expense_total:N,invoice_total:R,chargeable_total:U,non_chargeable_total:Z,status:"Draft",notes:c||null,created_by:o}).select().single();if($)throw $;const D=[...k,...A,...se].map(w=>({...w,invoice_id:W.id}));if(D.length>0){const{error:w}=await f.from("partner_invoice_lines").insert(D);if(w)throw w}return this.getWithLines(W.id)}catch(h){throw h}}async updateStatus(t,e){const r={status:e};return e==="Sent"?r.sent_at=new Date().toISOString():e==="Paid"&&(r.paid_at=new Date().toISOString()),this.update(t,r)}async markSent(t){return this.updateStatus(t,"Sent")}async markPaid(t){return this.updateStatus(t,"Paid")}async cancel(t){return this.updateStatus(t,"Cancelled")}async getPartnerStats(t){try{const{data:e,error:r}=await f.from(this.tableName).select("status, invoice_total").eq("partner_id",t);if(r)throw r;const a={total:0,draft:0,sent:0,paid:0,cancelled:0,count:e?.length||0};return(e||[]).forEach(n=>{const o=parseFloat(n.invoice_total||0);switch(a.total+=o,n.status){case"Draft":a.draft+=o;break;case"Sent":a.sent+=o;break;case"Paid":a.paid+=o;break;case"Cancelled":a.cancelled+=o;break}}),a}catch(e){throw e}}}const Na=new zs;class Bs extends Y{constructor(){super("milestones",{supportsSoftDelete:!0,sanitizeConfig:"milestone"})}async getAllWithStats(t){try{const e=await this.getAll(t,{orderBy:{column:"start_date",ascending:!0}}),{data:r}=await f.from("timesheets").select("milestone_id, hours_worked").eq("project_id",t).not("milestone_id","is",null).or("is_deleted.is.null,is_deleted.eq.false"),a={};return(r||[]).forEach(n=>{a[n.milestone_id]||(a[n.milestone_id]=0),a[n.milestone_id]+=parseFloat(n.hours_worked||0)}),e.map(n=>({...n,logged_hours:a[n.id]||0,logged_days:ne(a[n.id]||0)}))}catch(e){throw e}}async getWithDeliverables(t){try{const{data:e,error:r}=await f.from(this.tableName).select("*").eq("id",t).or(this.getSoftDeleteFilter()).limit(1);if(r)throw r;const a=e?.[0],{data:n,error:o}=await f.from("deliverables").select("*").eq("milestone_id",t).or("is_deleted.is.null,is_deleted.eq.false").order("due_date",{ascending:!0});if(o)throw o;return{...a,deliverables:n||[]}}catch(e){throw e}}async getByStatus(t,e){return this.getAll(t,{filters:[{column:"status",operator:"eq",value:e}],orderBy:{column:"start_date",ascending:!0}})}async getUpcoming(t,e=30){try{const r=new Date().toISOString().split("T")[0],a=new Date;a.setDate(a.getDate()+e);const n=a.toISOString().split("T")[0];let o=f.from(this.tableName).select("*").eq("project_id",t).gte("end_date",r).lte("end_date",n).neq("status","Completed").order("end_date",{ascending:!0});this.supportsSoftDelete&&(o=o.or(this.getSoftDeleteFilter()));const{data:c,error:l}=await o;if(l)throw l;return c||[]}catch(r){throw r}}async updateStatus(t,e){return this.update(t,{status:e})}async updateCompletion(t,e){const r={completion_percentage:e};return e>=100&&(r.status="Completed"),this.update(t,r)}async getSummary(t){try{const e=await this.getAll(t),r={total:e.length,completed:0,inProgress:0,notStarted:0,overdue:0,upcoming:0},a=new Date().toISOString().split("T")[0],n=new Date;n.setDate(n.getDate()+7);const o=n.toISOString().split("T")[0];return e.forEach(c=>{c.status==="Completed"?r.completed++:c.status==="In Progress"?(r.inProgress++,c.end_date<a&&r.overdue++):c.status==="Not Started"&&(r.notStarted++,c.start_date<=o&&r.upcoming++)}),r}catch(e){throw e}}async getCertificates(t){try{const{data:e,error:r}=await f.from("milestone_certificates").select("*").eq("project_id",t).order("created_at",{ascending:!1});if(r)throw r;return e||[]}catch(e){throw e}}async createCertificate(t){try{const{data:e,error:r}=await f.from("milestone_certificates").insert([t]).select();if(r)throw r;return e?.[0]}catch(e){throw e}}async updateCertificate(t,e){try{const{data:r,error:a}=await f.from("milestone_certificates").update(e).eq("id",t).select();if(a)throw a;return r?.[0]}catch(r){throw r}}}const tt=new Bs;class Us extends Y{constructor(){super("deliverables",{supportsSoftDelete:!0,sanitizeConfig:"deliverable"})}async getAllWithMilestones(t){return this.getAll(t,{select:"*, milestones(name, milestone_ref)",orderBy:{column:"due_date",ascending:!0}})}async getByMilestone(t){try{let e=f.from(this.tableName).select("*").eq("milestone_id",t).order("due_date",{ascending:!0});this.supportsSoftDelete&&(e=e.or(this.getSoftDeleteFilter()));const{data:r,error:a}=await e;if(a)throw a;return r||[]}catch(e){throw e}}async getByStatus(t,e){return this.getAll(t,{filters:[{column:"status",operator:"eq",value:e}],orderBy:{column:"due_date",ascending:!0}})}async getOverdue(t){try{const e=new Date().toISOString().split("T")[0];let r=f.from(this.tableName).select("*, milestones(name)").eq("project_id",t).lt("due_date",e).not("status","in",'("Delivered","Cancelled")').order("due_date",{ascending:!0});this.supportsSoftDelete&&(r=r.or(this.getSoftDeleteFilter()));const{data:a,error:n}=await r;if(n)throw n;return a||[]}catch(e){throw e}}async getUpcoming(t,e=14){try{const r=new Date().toISOString().split("T")[0],a=new Date;a.setDate(a.getDate()+e);const n=a.toISOString().split("T")[0];let o=f.from(this.tableName).select("*, milestones(name)").eq("project_id",t).gte("due_date",r).lte("due_date",n).not("status","eq","Delivered").order("due_date",{ascending:!0});this.supportsSoftDelete&&(o=o.or(this.getSoftDeleteFilter()));const{data:c,error:l}=await o;if(l)throw l;return c||[]}catch(r){throw r}}async updateStatus(t,e,r){const a={status:e};return e==="Submitted"?(a.submitted_date=new Date().toISOString(),a.submitted_by=r):e==="Delivered"&&(a.delivered_date=new Date().toISOString(),a.delivered_by=r),this.update(t,a)}async submit(t,e){return this.updateStatus(t,"Submitted",e)}async markDelivered(t,e){return this.updateStatus(t,"Delivered",e)}async reject(t,e){return this.update(t,{status:"Rejected",rejection_reason:e})}async getSummary(t){try{const e=await this.getAll(t),r=new Date().toISOString().split("T")[0],a={total:e.length,delivered:0,inProgress:0,notStarted:0,overdue:0,dueThisWeek:0},n=new Date;n.setDate(n.getDate()+7);const o=n.toISOString().split("T")[0];return e.forEach(c=>{c.status==="Delivered"?a.delivered++:c.status==="In Progress"?(a.inProgress++,c.due_date<r?a.overdue++:c.due_date<=o&&a.dueThisWeek++):(c.status==="Not Started"||c.status==="Draft")&&(a.notStarted++,c.due_date<r&&a.overdue++)}),a}catch(e){throw e}}async getAllWithRelations(t,e=!1){try{let r=f.from("deliverables").select(`
          *,
          milestones(milestone_ref, name),
          deliverable_kpis(kpi_id, kpis(kpi_ref, name)),
          deliverable_quality_standards(quality_standard_id, quality_standards(qs_ref, name))
        `).eq("project_id",t).or("is_deleted.is.null,is_deleted.eq.false").order("deliverable_ref");e||(r=r.or("is_test_content.is.null,is_test_content.eq.false"));const{data:a,error:n}=await r;if(n)throw n;return a||[]}catch(r){throw r}}async syncKPILinks(t,e=[]){try{const{error:r}=await f.from("deliverable_kpis").delete().eq("deliverable_id",t);if(r)throw r;if(e.length>0){const a=e.map(o=>({deliverable_id:t,kpi_id:o})),{error:n}=await f.from("deliverable_kpis").insert(a);if(n)throw n}return!0}catch(r){throw r}}async syncQSLinks(t,e=[]){try{const{error:r}=await f.from("deliverable_quality_standards").delete().eq("deliverable_id",t);if(r)throw r;if(e.length>0){const a=e.map(o=>({deliverable_id:t,quality_standard_id:o})),{error:n}=await f.from("deliverable_quality_standards").insert(a);if(n)throw n}return!0}catch(r){throw r}}async upsertKPIAssessments(t,e,r){try{const a=e.map(o=>({deliverable_id:t,kpi_id:o.kpiId,criteria_met:o.criteriaMet,assessed_at:new Date().toISOString(),assessed_by:r})),{error:n}=await f.from("deliverable_kpi_assessments").upsert(a,{onConflict:"deliverable_id,kpi_id"});if(n)throw n;return!0}catch(a){throw a}}async upsertQSAssessments(t,e,r){try{const a=e.map(o=>({deliverable_id:t,quality_standard_id:o.qsId,criteria_met:o.criteriaMet,assessed_at:new Date().toISOString(),assessed_by:r})),{error:n}=await f.from("deliverable_qs_assessments").upsert(a,{onConflict:"deliverable_id,quality_standard_id"});if(n)throw n;return!0}catch(a){throw a}}}const Rt=new Us;class Ws extends Y{constructor(){super("kpis")}async getAllWithStatus(t){try{return(await this.getAll(t,{orderBy:{column:"name",ascending:!0}})).map(r=>({...r,rag_status:this.calculateRAG(r)}))}catch(e){throw e}}calculateRAG(t){if(!t.target_value||t.actual_value===null||t.actual_value===void 0)return"Unknown";const e=parseFloat(t.actual_value),r=parseFloat(t.target_value),a=parseFloat(t.threshold_amber||10);return t.trend==="higher_better"?e>=r?"Green":e>=r*(1-a/100)?"Amber":"Red":e<=r?"Green":e<=r*(1+a/100)?"Amber":"Red"}async getByRAGStatus(t,e){try{return(await this.getAllWithStatus(t)).filter(a=>a.rag_status===e)}catch(r){throw r}}async getNeedingAttention(t){try{return(await this.getAllWithStatus(t)).filter(r=>r.rag_status==="Amber"||r.rag_status==="Red")}catch(e){throw e}}async updateActualValue(t,e){return this.update(t,{actual_value:e,last_updated:new Date().toISOString()})}async getHistory(t,e=12){try{const{data:r,error:a}=await f.from("kpi_history").select("*").eq("kpi_id",t).order("recorded_at",{ascending:!1}).limit(e);if(a)throw a;return r||[]}catch{return[]}}async getSummary(t){try{const e=await this.getAllWithStatus(t);return{total:e.length,green:e.filter(r=>r.rag_status==="Green").length,amber:e.filter(r=>r.rag_status==="Amber").length,red:e.filter(r=>r.rag_status==="Red").length,unknown:e.filter(r=>r.rag_status==="Unknown").length}}catch(e){throw e}}async getAssessments(t){try{const{data:e,error:r}=await f.from("deliverable_kpi_assessments").select(`
          kpi_id,
          criteria_met,
          deliverables!inner(id, status, is_deleted, project_id)
        `).eq("deliverables.project_id",t);return r?await this.getAssessmentsFallback(t):(e||[]).filter(n=>n.deliverables?.is_deleted!==!0&&H.deliverables.contributeToKPIs.includes(n.deliverables?.status))}catch{return[]}}async getAssessmentsFallback(t){try{const{data:e,error:r}=await f.from("deliverable_kpi_assessments").select("kpi_id, criteria_met, deliverable_id");if(r)throw r;const{data:a,error:n}=await f.from("deliverables").select("id, status, is_deleted").eq("project_id",t);if(n)throw n;const o=new Set((a||[]).filter(l=>l.is_deleted!==!0&&H.deliverables.contributeToKPIs.includes(l.status)).map(l=>l.id));return(e||[]).filter(l=>o.has(l.deliverable_id))}catch{return[]}}}const Ia=new Ws;class $s extends Y{constructor(){super("quality_standards")}async getAllWithStatus(t){try{return(await this.getAll(t,{orderBy:{column:"name",ascending:!0}})).map(r=>({...r,compliance_status:this.calculateCompliance(r)}))}catch(e){throw e}}calculateCompliance(t){if(t.actual_value===null||t.actual_value===void 0)return"Not Measured";const e=parseFloat(t.actual_value),r=parseFloat(t.target_value||0);return e>=r?"Compliant":e>=r*.9?"Near Compliant":"Non-Compliant"}async getNonCompliant(t){try{return(await this.getAllWithStatus(t)).filter(r=>r.compliance_status==="Non-Compliant")}catch(e){throw e}}async updateMeasurement(t,e,r){return this.update(t,{actual_value:e,measurement_notes:r,last_measured:new Date().toISOString()})}async getSummary(t){try{const e=await this.getAllWithStatus(t);return{total:e.length,compliant:e.filter(r=>r.compliance_status==="Compliant").length,nearCompliant:e.filter(r=>r.compliance_status==="Near Compliant").length,nonCompliant:e.filter(r=>r.compliance_status==="Non-Compliant").length,notMeasured:e.filter(r=>r.compliance_status==="Not Measured").length}}catch(e){throw e}}async getAssessments(t){try{const{data:e,error:r}=await f.from("deliverable_qs_assessments").select(`
          quality_standard_id,
          criteria_met,
          deliverables!inner(id, status, is_deleted, project_id)
        `).eq("deliverables.project_id",t);return r?await this.getAssessmentsFallback(t):(e||[]).filter(n=>n.deliverables?.is_deleted!==!0&&H.deliverables.contributeToQS.includes(n.deliverables?.status))}catch{return[]}}async getAssessmentsFallback(t){try{const{data:e,error:r}=await f.from("deliverable_qs_assessments").select("quality_standard_id, criteria_met, deliverable_id");if(r)throw r;const{data:a,error:n}=await f.from("deliverables").select("id, status, is_deleted").eq("project_id",t);if(n)throw n;const o=new Set((a||[]).filter(l=>l.is_deleted!==!0&&H.deliverables.contributeToQS.includes(l.status)).map(l=>l.id));return(e||[]).filter(l=>o.has(l.deliverable_id))}catch{return[]}}async getAllWithCalculatedValues(t){try{const e=await this.getAll(t,{orderBy:{column:"qs_ref",ascending:!0}}),r=await this.getAssessments(t),a={};return r.forEach(n=>{a[n.quality_standard_id]||(a[n.quality_standard_id]={total:0,met:0}),a[n.quality_standard_id].total++,n.criteria_met&&a[n.quality_standard_id].met++}),e.map(n=>{const o=a[n.id],c=o&&o.total>0?Math.round(o.met/o.total*100):0,l=n.target||100,h=c>=l;return{...n,calculatedValue:c,assessmentCount:o?.total||0,assessmentsMet:o?.met||0,isAchieved:h}})}catch(e){throw e}}}const Aa=new $s;class Fs extends Y{constructor(){super("standards",{supportsSoftDelete:!1,sanitizeConfig:"standard"})}async getAll(t){return super.getAll(t,{orderBy:{column:"standard_ref",ascending:!0}})}async getByStatus(t,e){return super.getAll(t,{filters:[{column:"status",operator:"eq",value:e}],orderBy:{column:"standard_ref",ascending:!0}})}async getByCategory(t,e){return super.getAll(t,{filters:[{column:"category",operator:"eq",value:e}],orderBy:{column:"standard_ref",ascending:!0}})}async getSummary(t){try{const e=await this.getAll(t);return{total:e.length,completed:e.filter(r=>r.status==="Completed").length,inProgress:e.filter(r=>r.status==="In Progress").length,notStarted:e.filter(r=>!r.status||r.status==="Not Started").length}}catch(e){throw e}}}new Fs;const Vs={version:"2.0",widgets:{"progress-hero":{visible:!0,x:0,y:0,w:12,h:2,minW:6,minH:2,maxH:3},"budget-summary":{visible:!1,x:0,y:2,w:6,h:2,minW:4,minH:2,maxH:3},"pmo-tracking":{visible:!1,x:6,y:2,w:6,h:2,minW:6,minH:2,maxH:4},"stats-grid":{visible:!0,x:0,y:2,w:12,h:2,minW:8,minH:2,maxH:3},certificates:{visible:!1,x:0,y:4,w:12,h:2,minW:6,minH:2,maxH:3},"milestones-list":{visible:!0,x:0,y:4,w:12,h:4,minW:8,minH:3,maxH:6},"kpis-category":{visible:!1,x:0,y:8,w:6,h:3,minW:4,minH:3,maxH:5},"quality-standards":{visible:!1,x:6,y:8,w:6,h:3,minW:4,minH:3,maxH:5}}};({...Vs});function Hs(){const i=ce(),{projectId:t}=ue(),[e,r]=d.useState(!0),[a,n]=d.useState({total:0,approved:0,awaitingSignatures:0,awaitingCertificate:0,inProgress:0}),o=d.useCallback(async()=>{if(t){r(!0);try{const l=await tt.getAll(t,{orderBy:{column:"milestone_ref",ascending:!0}}),h=l.map(P=>P.id);let m={};h.length>0&&(await Rt.getAll(t,{filters:[{column:"milestone_id",operator:"in",value:h}],select:"id, milestone_id, status"})||[]).forEach(q=>{m[q.milestone_id]||(m[q.milestone_id]=[]),m[q.milestone_id].push(q)});const g=await tt.getCertificates(t),p={};g.forEach(P=>{p[P.milestone_id]=P});let _=0,x=0,u=0,v=0;l.forEach(P=>{const q=m[P.id]||[],I=q.length>0&&q.every(C=>C.status==="Delivered"),b=p[P.id];b&&b.status==="Signed"?_++:b?x++:I?u++:v++}),n({total:l.length,approved:_,awaitingSignatures:x,awaitingCertificate:u,inProgress:v})}catch{}finally{r(!1)}}},[t]);d.useEffect(()=>{o()},[o]);const c=()=>{i("/milestones")};return e?s.jsxs("div",{className:"dashboard-widget",onClick:c,children:[s.jsxs("div",{className:"widget-header",children:[s.jsx("div",{className:"widget-icon",children:s.jsx(Ae,{size:20})}),s.jsx("span",{className:"widget-title",children:"Milestones"})]}),s.jsx("div",{className:"widget-loading",children:"Loading..."})]}):s.jsxs("div",{className:"dashboard-widget",onClick:c,children:[s.jsxs("div",{className:"widget-header",children:[s.jsx("div",{className:"widget-icon",children:s.jsx(Ae,{size:20})}),s.jsx("span",{className:"widget-title",children:"Milestones"}),s.jsxs("span",{className:"widget-total",children:[a.total," Total"]})]}),s.jsxs("div",{className:"widget-breakdown",children:[s.jsxs("div",{className:"widget-row",children:[s.jsx("div",{className:"widget-row-icon approved",children:s.jsx(qe,{size:16})}),s.jsx("span",{className:"widget-row-label",children:"Approved (Signed)"}),s.jsx("span",{className:"widget-row-value",children:a.approved})]}),s.jsxs("div",{className:"widget-row",children:[s.jsx("div",{className:"widget-row-icon pending",children:s.jsx(de,{size:16})}),s.jsx("span",{className:"widget-row-label",children:"Awaiting Signatures"}),s.jsx("span",{className:"widget-row-value",children:a.awaitingSignatures})]}),s.jsxs("div",{className:"widget-row",children:[s.jsx("div",{className:"widget-row-icon awaiting",children:s.jsx(Oe,{size:16})}),s.jsx("span",{className:"widget-row-label",children:"Awaiting Certificate"}),s.jsx("span",{className:"widget-row-value",children:a.awaitingCertificate})]}),s.jsxs("div",{className:"widget-row",children:[s.jsx("div",{className:"widget-row-icon progress",children:s.jsx(ct,{size:16})}),s.jsx("span",{className:"widget-row-label",children:"In Progress"}),s.jsx("span",{className:"widget-row-value",children:a.inProgress})]})]})]})}function Ks(){const i=ce(),{projectId:t}=ue(),{showTestUsers:e}=_t(),[r,a]=d.useState(!0),[n,o]=d.useState({total:0,delivered:0,reviewComplete:0,awaitingReview:0,returned:0,inProgress:0,notStarted:0}),c=d.useCallback(async()=>{if(t){a(!0);try{const h=await Rt.getAllWithRelations(t,e);let m=0,g=0,p=0,_=0,x=0,u=0;h.forEach(v=>{switch(v.status){case"Delivered":m++;break;case"Review Complete":g++;break;case"Submitted for Review":p++;break;case"Returned for More Work":_++;break;case"In Progress":x++;break;case"Not Started":default:u++;break}}),o({total:h.length,delivered:m,reviewComplete:g,awaitingReview:p,returned:_,inProgress:x,notStarted:u})}catch{}finally{a(!1)}}},[t,e]);d.useEffect(()=>{c()},[c]);const l=()=>{i("/deliverables")};return r?s.jsxs("div",{className:"dashboard-widget",onClick:l,children:[s.jsxs("div",{className:"widget-header",children:[s.jsx("div",{className:"widget-icon",style:{background:"rgba(34, 197, 94, 0.1)",color:"#22c55e"},children:s.jsx(Ie,{size:20})}),s.jsx("span",{className:"widget-title",children:"Deliverables"})]}),s.jsx("div",{className:"widget-loading",children:"Loading..."})]}):s.jsxs("div",{className:"dashboard-widget",onClick:l,children:[s.jsxs("div",{className:"widget-header",children:[s.jsx("div",{className:"widget-icon",style:{background:"rgba(34, 197, 94, 0.1)",color:"#22c55e"},children:s.jsx(Ie,{size:20})}),s.jsx("span",{className:"widget-title",children:"Deliverables"}),s.jsxs("span",{className:"widget-total",children:[n.total," Total"]})]}),s.jsxs("div",{className:"widget-breakdown",children:[s.jsxs("div",{className:"widget-row",children:[s.jsx("div",{className:"widget-row-icon approved",children:s.jsx(qe,{size:16})}),s.jsx("span",{className:"widget-row-label",children:"Delivered"}),s.jsx("span",{className:"widget-row-value",children:n.delivered})]}),s.jsxs("div",{className:"widget-row",children:[s.jsx("div",{className:"widget-row-icon",style:{background:"rgba(37, 99, 235, 0.1)",color:"#2563eb"},children:s.jsx(dr,{size:16})}),s.jsx("span",{className:"widget-row-label",children:"Review Complete"}),s.jsx("span",{className:"widget-row-value",children:n.reviewComplete})]}),s.jsxs("div",{className:"widget-row",children:[s.jsx("div",{className:"widget-row-icon pending",children:s.jsx(de,{size:16})}),s.jsx("span",{className:"widget-row-label",children:"Awaiting Review"}),s.jsx("span",{className:"widget-row-value",children:n.awaitingReview})]}),s.jsxs("div",{className:"widget-row",children:[s.jsx("div",{className:"widget-row-icon",style:{background:"rgba(220, 38, 38, 0.1)",color:"#dc2626"},children:s.jsx(lt,{size:16})}),s.jsx("span",{className:"widget-row-label",children:"Returned"}),s.jsx("span",{className:"widget-row-value",children:n.returned})]}),s.jsxs("div",{className:"widget-row",children:[s.jsx("div",{className:"widget-row-icon",style:{background:"rgba(79, 70, 229, 0.1)",color:"#4f46e5"},children:s.jsx(le,{size:16})}),s.jsx("span",{className:"widget-row-label",children:"In Progress"}),s.jsx("span",{className:"widget-row-value",children:n.inProgress})]}),s.jsxs("div",{className:"widget-row",children:[s.jsx("div",{className:"widget-row-icon progress",children:s.jsx(ct,{size:16})}),s.jsx("span",{className:"widget-row-label",children:"Not Started"}),s.jsx("span",{className:"widget-row-value",children:n.notStarted})]})]})]})}function Gs(){const{projectName:i,projectRef:t}=ue(),{user:e}=ye(),r=()=>{const a=new Date().getHours();return a<12?"Good morning":a<18?"Good afternoon":"Good evening"};return s.jsxs("div",{className:"dashboard",children:[s.jsx("div",{className:"dashboard-header",children:s.jsx("div",{className:"dashboard-header-content",children:s.jsxs("div",{children:[s.jsx("h1",{className:"dashboard-title",children:r()}),s.jsxs("p",{className:"dashboard-subtitle",children:[t," â€¢ ",i]})]})})}),s.jsx("div",{className:"dashboard-content",children:s.jsxs("div",{className:"dashboard-widgets",children:[s.jsx(Hs,{}),s.jsx(Ks,{})]})})]})}const Qs=d.lazy(()=>B(()=>import("./ResetPassword-B1fBhjLO.js"),__vite__mapDeps([0,1,2,3]))),Ys=d.lazy(()=>B(()=>import("./Milestones-Bwnk3v40.js"),__vite__mapDeps([4,1,5,6,7,8,2,3]))),Xs=d.lazy(()=>B(()=>import("./MilestoneDetail-DthUmTX7.js"),__vite__mapDeps([9,1,2,3]))),Js=d.lazy(()=>B(()=>import("./Gantt-DJJ1Wdge.js"),__vite__mapDeps([10,1,5,2,3]))),Zs=d.lazy(()=>B(()=>import("./Deliverables-B_uj34vU.js"),__vite__mapDeps([11,1,5,7,2,3]))),ea=d.lazy(()=>B(()=>import("./Resources-wSjh1-HU.js"),__vite__mapDeps([12,1,5,6,7,8,2,3]))),ta=d.lazy(()=>B(()=>import("./ResourceDetail-DM_NAGUf.js"),__vite__mapDeps([13,1,5,6,2,3]))),ra=d.lazy(()=>B(()=>import("./Partners-CpPfJLGB.js"),__vite__mapDeps([14,1,5,6,7,8,2,3]))),sa=d.lazy(()=>B(()=>import("./PartnerDetail-BjF-IDW5.js"),__vite__mapDeps([15,1,5,6,2,3]))),aa=d.lazy(()=>B(()=>import("./Timesheets-Bo_cL8Ah.js"),__vite__mapDeps([16,1,5,6,7,8,2,3]))),na=d.lazy(()=>B(()=>import("./Expenses-BnJq7uCq.js"),__vite__mapDeps([17,1,5,6,7,8,2,3,18]))),ia=d.lazy(()=>B(()=>import("./KPIs-Dvi0D2Yw.js"),__vite__mapDeps([19,1,5,6,7,8,2,3]))),oa=d.lazy(()=>B(()=>import("./KPIDetail-BBsfvre6.js"),__vite__mapDeps([20,1,5,2,3]))),la=d.lazy(()=>B(()=>import("./QualityStandards-WGMpxWPX.js"),__vite__mapDeps([21,1,5,6,7,8,2,3]))),ca=d.lazy(()=>B(()=>import("./QualityStandardDetail-Dl8446zP.js"),__vite__mapDeps([22,1,2,3]))),da=d.lazy(()=>B(()=>import("./Reports-BxT7KBIE.js"),__vite__mapDeps([23,2,1,3]))),ua=d.lazy(()=>B(()=>import("./Users-xdr4tNM3.js"),__vite__mapDeps([24,1,2,3]))),ha=d.lazy(()=>B(()=>import("./Settings-B_ZnLyFS.js"),__vite__mapDeps([25,1,5,7,2,3]))),ma=d.lazy(()=>B(()=>import("./AccountSettings-BXT5kKaH.js"),__vite__mapDeps([26,1,7,2,3]))),fa=d.lazy(()=>B(()=>import("./WorkflowSummary-iVxYBk_n.js"),__vite__mapDeps([27,1,6,7,2,3]))),pa=d.lazy(()=>B(()=>import("./AuditLog-CHXHMUuE.js"),__vite__mapDeps([28,1,7,2,3]))),ga=d.lazy(()=>B(()=>import("./DeletedItems-CtVo5uK2.js"),__vite__mapDeps([29,1,7,8,2,3])));function ya(){return s.jsx("div",{className:"page-container",children:s.jsx(oe,{type:"page"})})}function z({children:i}){const{user:t,isLoading:e}=ye();return e?s.jsx(bt,{message:"Loading...",size:"large",fullPage:!0}):t?s.jsx(Cs,{children:s.jsx(d.Suspense,{fallback:s.jsx(ya,{}),children:i||s.jsx(qt,{})})}):s.jsx(Ne,{to:"/login",replace:!0})}function _a(){return s.jsx(Mt,{children:s.jsx(Jr,{children:s.jsx(ns,{children:s.jsx(Wr,{children:s.jsx($r,{children:s.jsx(Fr,{children:s.jsx(us,{children:s.jsx(Hr,{children:s.jsxs(Yr,{children:[s.jsxs(Tt,{children:[s.jsx(O,{path:"/login",element:s.jsx(Es,{})}),s.jsx(O,{path:"/reset-password",element:s.jsx(d.Suspense,{fallback:s.jsx(bt,{fullPage:!0}),children:s.jsx(Qs,{})})}),s.jsx(O,{path:"/",element:s.jsx(Ne,{to:"/dashboard",replace:!0})}),s.jsx(O,{path:"/dashboard",element:s.jsx(z,{children:s.jsx(Gs,{})})}),s.jsx(O,{path:"/milestones",element:s.jsx(z,{children:s.jsx(Ys,{})})}),s.jsx(O,{path:"/milestones/:id",element:s.jsx(z,{children:s.jsx(Xs,{})})}),s.jsx(O,{path:"/gantt",element:s.jsx(z,{children:s.jsx(Js,{})})}),s.jsx(O,{path:"/deliverables",element:s.jsx(z,{children:s.jsx(Zs,{})})}),s.jsx(O,{path:"/resources",element:s.jsx(z,{children:s.jsx(ea,{})})}),s.jsx(O,{path:"/resources/:id",element:s.jsx(z,{children:s.jsx(ta,{})})}),s.jsx(O,{path:"/partners",element:s.jsx(z,{children:s.jsx(ra,{})})}),s.jsx(O,{path:"/partners/:id",element:s.jsx(z,{children:s.jsx(sa,{})})}),s.jsx(O,{path:"/timesheets",element:s.jsx(z,{children:s.jsx(aa,{})})}),s.jsx(O,{path:"/expenses",element:s.jsx(z,{children:s.jsx(na,{})})}),s.jsx(O,{path:"/kpis",element:s.jsx(z,{children:s.jsx(ia,{})})}),s.jsx(O,{path:"/kpis/:id",element:s.jsx(z,{children:s.jsx(oa,{})})}),s.jsx(O,{path:"/quality-standards",element:s.jsx(z,{children:s.jsx(la,{})})}),s.jsx(O,{path:"/quality-standards/:id",element:s.jsx(z,{children:s.jsx(ca,{})})}),s.jsx(O,{path:"/reports",element:s.jsx(z,{children:s.jsx(da,{})})}),s.jsx(O,{path:"/users",element:s.jsx(z,{children:s.jsx(ua,{})})}),s.jsx(O,{path:"/settings",element:s.jsx(z,{children:s.jsx(ha,{})})}),s.jsx(O,{path:"/account",element:s.jsx(z,{children:s.jsx(ma,{})})}),s.jsx(O,{path:"/workflow-summary",element:s.jsx(z,{children:s.jsx(fa,{})})}),s.jsx(O,{path:"/audit-log",element:s.jsx(z,{children:s.jsx(pa,{})})}),s.jsx(O,{path:"/deleted-items",element:s.jsx(z,{children:s.jsx(ga,{})})}),s.jsx(O,{path:"*",element:s.jsx(Ne,{to:"/dashboard",replace:!0})})]}),s.jsx(hs,{}),s.jsx(Rr,{}),s.jsx(Or,{})]})})})})})})})})})}De.createRoot(document.getElementById("root")).render(s.jsx(rt.StrictMode,{children:s.jsx(_a,{})}));export{bt as L,gs as P,ys as R,H as V,ue as a,is as b,Ke as c,Rt as d,cs as e,_t as f,Sa as g,ne as h,Pa as i,s as j,Ia as k,Ye as l,tt as m,Na as n,ja as o,Ea as p,Aa as q,ka as r,f as s,Ra as t,ye as u,y as v,Ca as w};
