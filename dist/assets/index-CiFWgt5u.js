const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ResetPassword-DhiIig9Z.js","assets/vendor-react-BUTV5ZEl.js","assets/vendor-icons-Hb5rh3SC.js","assets/vendor-supabase-6faYzd5A.js","assets/MobileChat-CTOGCrLc.js","assets/MobileChat-DDcpgNUK.css","assets/Milestones-CWxyNoYn.js","assets/ConfirmDialog-Bxkmkygg.js","assets/formatters-BTbCMDgc.js","assets/milestoneCalculations-_QItVySF.js","assets/deliverableCalculations-Ji9hunuP.js","assets/Milestones-C3emWKZh.css","assets/MilestoneDetail-DYfHqZVw.js","assets/SignatureBox-BphGgCA5.js","assets/MilestoneDetail-BJQ8Lfzq.css","assets/Gantt-zqwVrf9R.js","assets/Deliverables-BHHCWm3H.js","assets/Deliverables-CwUV7aHS.css","assets/Resources-DmRXLS7Q.js","assets/resourceCalculations-DA7I_cMU.js","assets/Resources-DqwAz4oE.css","assets/ResourceDetail-Dozm-XIR.js","assets/timesheetCalculations-i3U5D2IN.js","assets/StatCard-D-pXEpB7.js","assets/Partners-WlR0dHot.js","assets/Partners-gm1Px_xW.css","assets/PartnerDetail-Dv_1otEX.js","assets/Timesheets-BFcXZdyx.js","assets/PromptDialog-CQoymER6.js","assets/Timesheets-CGkpTkzM.css","assets/Expenses-B6RQPOqH.js","assets/Expenses-CkSEY-w5.css","assets/KPIs-B_SbuzUu.js","assets/KPIs-DqHNCrBk.css","assets/KPIDetail-C2QdyLYY.js","assets/QualityStandards-B8Nkn3Xu.js","assets/QualityStandards-BjfsOAnd.css","assets/QualityStandardDetail-CK6L99ie.js","assets/RaidLog-BNjpdHnM.js","assets/RaidLog-C9AnKyu_.css","assets/Reports-CxS3LsSz.js","assets/Billing-BCTk8XNt.js","assets/PageHeader-BIChSTxE.js","assets/Users-CZyUPie1.js","assets/Users-DDv0gteh.css","assets/Settings-JbSs2FRs.js","assets/AccountSettings-Ev9k-z9i.js","assets/WorkflowSummary-CM2spcul.js","assets/AuditLog-jntQNjrC.js","assets/DeletedItems-TlITAsZ7.js","assets/Calendar-DoQRmw_B.js","assets/Calendar-ClLQeHem.css","assets/Variations-Dd5zDtcq.js","assets/Variations-GlpGrmwL.css","assets/VariationDetail-BfTHa24p.js","assets/VariationDetail-BURdo5VX.css","assets/VariationForm-f8luhglc.js","assets/VariationForm--bNPfG3A.css"])))=>i.map(i=>d[i]);
var bs=Object.defineProperty;var xs=(i,r,t)=>r in i?bs(i,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[r]=t;var Ge=(i,r,t)=>xs(i,typeof r!="symbol"?r+"":r,t);import{r as d,b as ws,R as lt,u as At,d as be,L as St,e as vs,B as _s,f as Ss,h as V,N as tt,O as js}from"./vendor-react-BUTV5ZEl.js";import{c as Cs}from"./vendor-supabase-6faYzd5A.js";import{A as Ue,R as Se,C as ks,a as ir,I as Es,X as or,b as Pe,c as ue,M as Rs,S as Ps,B as ft,D as Ns,T as As,L as lr,U as Ds,Z as Bt,d as Is,e as Ne,f as Ms,g as Vt,h as Ke,i as cr,j as Ts,F as Fe,k as Os,l as Oe,m as Ls,n as Dt,o as ct,p as ge,q as dr,P as rt,r as Wt,s as ur,t as hr,H as jt,u as qs,E as zs,v as gt,w as Bs,x as st,y as It,G as Vs,z as Ws,J as $s,K as Us,N as Fs,O as Hs,Q as Mt,V as Gs,W as at,Y as mr,_ as Ks,$ as Qs,a0 as Ys,a1 as Js,a2 as Xs,a3 as Zs,a4 as $t,a5 as Qe,a6 as ea,a7 as yt,a8 as pr,a9 as ta,aa as ra,ab as sa}from"./vendor-icons-Hb5rh3SC.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerPolicy&&(n.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?n.credentials="include":a.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(a){if(a.ep)return;a.ep=!0;const n=t(a);fetch(a.href,n)}})();var fr={exports:{}},dt={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var aa=d,na=Symbol.for("react.element"),ia=Symbol.for("react.fragment"),oa=Object.prototype.hasOwnProperty,la=aa.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,ca={key:!0,ref:!0,__self:!0,__source:!0};function gr(i,r,t){var s,a={},n=null,o=null;t!==void 0&&(n=""+t),r.key!==void 0&&(n=""+r.key),r.ref!==void 0&&(o=r.ref);for(s in r)oa.call(r,s)&&!ca.hasOwnProperty(s)&&(a[s]=r[s]);if(i&&i.defaultProps)for(s in r=i.defaultProps,r)a[s]===void 0&&(a[s]=r[s]);return{$$typeof:na,type:i,key:n,ref:o,props:a,_owner:la.current}}dt.Fragment=ia;dt.jsx=gr;dt.jsxs=gr;fr.exports=dt;var e=fr.exports,Ct={},Ut=ws;Ct.createRoot=Ut.createRoot,Ct.hydrateRoot=Ut.hydrateRoot;const da="modulepreload",ua=function(i){return"/"+i},Ft={},F=function(r,t,s){let a=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),c=o?.nonce||o?.getAttribute("nonce");a=Promise.allSettled(t.map(l=>{if(l=ua(l),l in Ft)return;Ft[l]=!0;const u=l.endsWith(".css"),m=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${m}`))return;const h=document.createElement("link");if(h.rel=u?"stylesheet":da,u||(h.as="script"),h.crossOrigin="",h.href=l,c&&h.setAttribute("nonce",c),document.head.appendChild(h),u)return new Promise((f,y)=>{h.addEventListener("load",f),h.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${l}`)))})}))}function n(o){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=o,window.dispatchEvent(c),!c.defaultPrevented)throw o}return a.then(o=>{for(const c of o||[])c.status==="rejected"&&n(c.reason);return r().catch(n)})};var Ht={},ha="@vercel/analytics",ma="1.6.1",pa=()=>{window.va||(window.va=function(...r){(window.vaq=window.vaq||[]).push(r)})};function yr(){return typeof window<"u"}function br(){try{const i="production"}catch{}return"production"}function fa(i="auto"){if(i==="auto"){window.vam=br();return}window.vam=i}function ga(){return(yr()?window.vam:br())||"production"}function kt(){return ga()==="development"}function ya(i){return i.scriptSrc?i.scriptSrc:kt()?"https://va.vercel-scripts.com/v1/script.debug.js":i.basePath?`${i.basePath}/insights/script.js`:"/_vercel/insights/script.js"}function ba(i={debug:!0}){var r;if(!yr())return;fa(i.mode),pa(),i.beforeSend&&((r=window.va)==null||r.call(window,"beforeSend",i.beforeSend));const t=ya(i);if(document.head.querySelector(`script[src*="${t}"]`))return;const s=document.createElement("script");s.src=t,s.defer=!0,s.dataset.sdkn=ha+(i.framework?`/${i.framework}`:""),s.dataset.sdkv=ma,i.disableAutoTrack&&(s.dataset.disableAutoTrack="1"),i.endpoint?s.dataset.endpoint=i.endpoint:i.basePath&&(s.dataset.endpoint=`${i.basePath}/insights`),i.dsn&&(s.dataset.dsn=i.dsn),s.onerror=()=>{const a=kt()?"Please check if any ad blockers are enabled and try again.":"Be sure to enable Web Analytics for your project and deploy again. See https://vercel.com/docs/analytics/quickstart for more information."},kt()&&i.debug===!1&&(s.dataset.debug="false"),document.head.appendChild(s)}function xa({route:i,path:r}){var t;(t=window.va)==null||t.call(window,"pageview",{route:i,path:r})}function wa(){if(!(typeof process>"u"||typeof Ht>"u"))return Ht.REACT_APP_VERCEL_OBSERVABILITY_BASEPATH}function va(i){return d.useEffect(()=>{var r;i.beforeSend&&((r=window.va)==null||r.call(window,"beforeSend",i.beforeSend))},[i.beforeSend]),d.useEffect(()=>{ba({framework:i.framework||"react",basePath:i.basePath??wa(),...i.route!==void 0&&{disableAutoTrack:!0},...i})},[]),d.useEffect(()=>{i.route&&i.path&&xa({route:i.route,path:i.path})},[i.route,i.path]),null}var Gt={},_a="@vercel/speed-insights",Sa="1.3.1",ja=()=>{window.si||(window.si=function(...r){(window.siq=window.siq||[]).push(r)})};function Ca(){return typeof window<"u"}function ka(){try{const i="production"}catch{}return"production"}function xr(){return ka()==="development"}function Ea(i){return i.scriptSrc?i.scriptSrc:xr()?"https://va.vercel-scripts.com/v1/speed-insights/script.debug.js":i.dsn?"https://va.vercel-scripts.com/v1/speed-insights/script.js":i.basePath?`${i.basePath}/speed-insights/script.js`:"/_vercel/speed-insights/script.js"}function Ra(i={}){var r;if(!Ca()||i.route===null)return null;ja();const t=Ea(i);if(document.head.querySelector(`script[src*="${t}"]`))return null;i.beforeSend&&((r=window.si)==null||r.call(window,"beforeSend",i.beforeSend));const s=document.createElement("script");return s.src=t,s.defer=!0,s.dataset.sdkn=_a+(i.framework?`/${i.framework}`:""),s.dataset.sdkv=Sa,i.sampleRate&&(s.dataset.sampleRate=i.sampleRate.toString()),i.route&&(s.dataset.route=i.route),i.endpoint?s.dataset.endpoint=i.endpoint:i.basePath&&(s.dataset.endpoint=`${i.basePath}/speed-insights/vitals`),i.dsn&&(s.dataset.dsn=i.dsn),xr()&&i.debug===!1&&(s.dataset.debug="false"),s.onerror=()=>{},document.head.appendChild(s),{setRoute:a=>{s.dataset.route=a??void 0}}}function Pa(){if(!(typeof process>"u"||typeof Gt>"u"))return Gt.REACT_APP_VERCEL_OBSERVABILITY_BASEPATH}function Na(i){d.useEffect(()=>{var t;i.beforeSend&&((t=window.si)==null||t.call(window,"beforeSend",i.beforeSend))},[i.beforeSend]);const r=d.useRef(null);return d.useEffect(()=>{if(r.current)i.route&&r.current(i.route);else{const t=Ra({framework:i.framework??"react",basePath:i.basePath??Pa(),...i});t&&(r.current=t.setRoute)}},[i.route]),null}const Aa=void 0,Da=void 0;throw new Error("Missing Supabase environment variables");const g=Cs(Aa,Da),wr=d.createContext(null),Ia=60*1e3,Ma=5*60*1e3;function Ta({children:i}){const[r,t]=d.useState(null),[s,a]=d.useState(null),[n,o]=d.useState(null),[c,l]=d.useState(!0),[u,m]=d.useState(null),[h,f]=d.useState(!1),[y,b]=d.useState(!1),p=d.useRef(null),_=d.useRef(Date.now()),w=d.useCallback(()=>{_.current=Date.now()},[]);async function k(j){if(!j){a(null),o(null),b(!1);return}try{const{data:P,error:B}=await g.from("profiles").select("*").eq("id",j.id).single();if(B){m(B);return}a(P),b(P?.must_change_password===!0);const{data:ee}=await g.from("resources").select("*").eq("user_id",j.id).maybeSingle();o(ee),m(null)}catch(P){m(P)}}const S=d.useCallback(async()=>{try{const{data:{session:j},error:P}=await g.auth.getSession();if(P)return;if(!j){await v();return}const B=j.expires_at*1e3,ee=Date.now(),K=B-ee;if(K<=0)await v();else if(K<=Ma){f(!0);const{data:re,error:fe}=await g.auth.refreshSession();fe||!re.session||f(!1)}else f(!1)}catch{}},[]);async function v(){t(null),a(null),o(null),f(!1),await g.auth.signOut();const j=window.location.pathname;j!=="/login"&&j!=="/register"&&(window.location.href="/login?expired=true")}const E=d.useCallback(()=>{p.current&&clearInterval(p.current),p.current=setInterval(()=>{S()},Ia);const j=()=>{document.visibilityState==="visible"&&S()};document.addEventListener("visibilitychange",j);const P=["mousedown","keydown","touchstart","scroll"];return P.forEach(B=>{document.addEventListener(B,w,{passive:!0})}),()=>{p.current&&clearInterval(p.current),document.removeEventListener("visibilitychange",j),P.forEach(B=>{document.removeEventListener(B,w)})}},[S,w]);d.useEffect(()=>{let j=!0,P=null;async function B(){try{const{data:{session:K},error:re}=await g.auth.getSession();re&&j&&m(re),j&&(t(K?.user??null),l(!1),K?.user&&(k(K.user),P=E()))}catch(K){j&&(m(K),l(!1))}}B();const{data:{subscription:ee}}=g.auth.onAuthStateChange(async(K,re)=>{j&&(t(re?.user??null),l(!1),re?.user?(k(re.user),P&&P(),P=E()):(a(null),o(null),P&&(P(),P=null)),(K==="SIGNED_OUT"||K==="TOKEN_REFRESHED")&&f(!1))});return()=>{j=!1,ee.unsubscribe(),P&&P()}},[E]);async function C(){try{await g.auth.signOut(),t(null),a(null),o(null),f(!1)}catch(j){m(j)}}async function R(){r&&await k(r)}function D(){b(!1)}async function N(){try{const{data:j,error:P}=await g.auth.refreshSession();return P?!1:j.session?(f(!1),!0):!1}catch{return!1}}const I={user:r,profile:s,role:s?.role||"viewer",linkedResource:n,isLoading:c,error:u,signOut:C,refreshUserData:R,refreshSession:N,isAuthenticated:!!r,sessionExpiring:h,mustChangePassword:y,clearMustChangePassword:D};return e.jsx(wr.Provider,{value:I,children:i})}function ye(){const i=d.useContext(wr);if(!i)throw new Error("useAuth must be used within an AuthProvider");return i}const vr=d.createContext(null),bt="amsf_current_project_id";function Oa({children:i}){const{user:r,isLoading:t}=ye(),[s,a]=d.useState([]),[n,o]=d.useState(null),[c,l]=d.useState(!0),[u,m]=d.useState(null),h=d.useMemo(()=>!n||s.length===0?null:s.find(v=>v.project_id===n)||null,[n,s]),f=h?.project||null,y=h?.role||null,b=d.useCallback(async()=>{if(!r?.id){a([]),o(null),l(!1);return}l(!0),m(null);try{const{data:v,error:E}=await g.from("user_projects").select(`
          id,
          project_id,
          role,
          is_default,
          project:projects (
            id,
            name,
            reference,
            start_date,
            end_date,
            total_budget,
            allocated_days,
            expenses_budget,
            pmo_threshold,
            description
          )
        `).eq("user_id",r.id).order("is_default",{ascending:!1});if(E){m(E),l(!1);return}if(!v||v.length===0){a([]),o(null),m({message:"No projects assigned. Please contact your administrator."}),l(!1);return}const C=v.map(D=>({...D,project:D.project}));a(C);let R=null;try{const D=localStorage.getItem(bt);D&&C.find(I=>I.project_id===D)&&(R=D)}catch{}if(!R){const D=C.find(N=>N.is_default);D&&(R=D.project_id)}if(!R&&C.length>0&&(R=C[0].project_id),o(R),R)try{localStorage.setItem(bt,R)}catch{}}catch(v){m(v)}finally{l(!1)}},[r?.id]);d.useEffect(()=>{t||b()},[t,b]);const p=d.useCallback(v=>{if(!s.find(C=>C.project_id===v))return!1;o(v);try{localStorage.setItem(bt,v)}catch{}return!0},[s]),_=d.useCallback(async()=>{if(n)try{const{data:v,error:E}=await g.from("projects").select("*").eq("id",n).single();if(E){m(E);return}a(C=>C.map(R=>R.project_id===n?{...R,project:v}:R))}catch(v){m(v)}},[n]),w=d.useCallback(()=>b(),[b]),k=s.length>1,S=d.useMemo(()=>({currentProject:f,projectId:f?.id||null,projectRef:f?.reference||null,projectName:f?.name||null,projectRole:y,availableProjects:s,hasMultipleProjects:k,switchProject:p,isLoading:c||t,error:u,refreshProject:_,refreshProjectAssignments:w}),[f,y,s,k,p,c,t,u,_,w]);return e.jsx(vr.Provider,{value:S,children:i})}function de(){const i=d.useContext(vr);if(!i)throw new Error("useProject must be used within a ProjectProvider");return i}const x={ADMIN:"admin",SUPPLIER_PM:"supplier_pm",CUSTOMER_PM:"customer_pm",CONTRIBUTOR:"contributor",VIEWER:"viewer"},La=[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.CONTRIBUTOR,x.VIEWER],we=La,ie=[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM],L=[x.ADMIN,x.SUPPLIER_PM],Ie=[x.ADMIN,x.CUSTOMER_PM],ke=[x.ADMIN,x.SUPPLIER_PM,x.CONTRIBUTOR],xt=[x.ADMIN],_r={timesheets:{view:we,create:ke,createForOthers:L,edit:ke,delete:L,submit:ke,approve:Ie},expenses:{view:we,create:ke,createForOthers:L,edit:ke,delete:L,submit:ke,validateChargeable:Ie,validateNonChargeable:L},milestones:{view:we,create:L,edit:L,delete:xt,useGantt:L,editBilling:L},deliverables:{view:we,create:[...ie,x.CONTRIBUTOR],edit:[...ie,x.CONTRIBUTOR],delete:L,submit:ke,review:Ie,markDelivered:Ie},kpis:{view:we,create:L,edit:L,delete:L,manage:L},qualityStandards:{view:we,create:L,edit:L,delete:L,manage:L},raid:{view:we,create:ie,edit:ie,delete:L,manage:ie,updateStatus:ie,assignOwner:ie},resources:{view:we,create:L,edit:L,delete:xt,manage:L,seeCostPrice:L,seeResourceType:L,seeMargins:L},partners:{view:L,create:L,edit:L,delete:L,manage:L},variations:{view:we,create:L,edit:L,delete:L,submit:L,signAsSupplier:L,signAsCustomer:Ie,reject:ie,apply:L},certificates:{view:ie,create:ie,signAsSupplier:L,signAsCustomer:Ie},invoices:{view:ie,generateCustomer:ie,generateThirdParty:L,viewMargins:L},settings:{access:L,edit:L},users:{view:L,manage:xt},reports:{access:ie,viewWorkflowSummary:ie}};function A(i,r,t){const s=_r[r];if(!s)return!1;const a=s[t];return a?a.includes(i):!1}const ve={[x.ADMIN]:{label:"Admin",color:"#7c3aed",bg:"#f3e8ff"},[x.SUPPLIER_PM]:{label:"Supplier PM",color:"#059669",bg:"#d1fae5"},[x.CUSTOMER_PM]:{label:"Customer PM",color:"#d97706",bg:"#fef3c7"},[x.CONTRIBUTOR]:{label:"Contributor",color:"#2563eb",bg:"#dbeafe"},[x.VIEWER]:{label:"Viewer",color:"#64748b",bg:"#f1f5f9"}},qa=Object.entries(ve).map(([i,r])=>({value:i,...r})),Sr=d.createContext(null),Me="amsf_view_as_role",za=[x.ADMIN,x.SUPPLIER_PM],wt=[{value:x.ADMIN,label:"Admin"},{value:x.SUPPLIER_PM,label:"Supplier PM"},{value:x.CUSTOMER_PM,label:"Customer PM"},{value:x.CONTRIBUTOR,label:"Contributor"},{value:x.VIEWER,label:"Viewer"}];function Ba({children:i}){const{role:r,user:t}=ye(),{projectRole:s,projectId:a}=de(),[n,o]=d.useState(null),[c,l]=d.useState(!1),u=d.useMemo(()=>s||r||"viewer",[s,r]),m=d.useMemo(()=>za.includes(u),[u]);d.useEffect(()=>{if(!t){o(null),l(!0);return}try{const S=sessionStorage.getItem(Me);S&&m&&(wt.some(E=>E.value===S)?o(S):sessionStorage.removeItem(Me))}catch{}l(!0)},[t,m]),d.useEffect(()=>{if(!m&&n){o(null);try{sessionStorage.removeItem(Me)}catch{}}},[m,n]);const h=d.useCallback(S=>{if(!m)return;if(S===u||!S){o(null);try{sessionStorage.removeItem(Me)}catch{}return}if(wt.some(E=>E.value===S)){o(S);try{sessionStorage.setItem(Me,S)}catch{}}},[m,u]),f=d.useCallback(()=>{o(null);try{sessionStorage.removeItem(Me)}catch{}},[]),y=d.useMemo(()=>n&&m?n:u,[n,m,u]),b=d.useMemo(()=>n&&n!==u&&m,[n,u,m]),p=d.useMemo(()=>ve[y]||ve[x.VIEWER],[y]),_=d.useMemo(()=>ve[u]||ve[x.VIEWER],[u]),w=d.useMemo(()=>({globalRole:r,projectRole:s,projectId:a,actualRole:u,viewAsRole:n,effectiveRole:y,canUseViewAs:m,isImpersonating:b}),[r,s,a,u,n,y,m,b]),k={canUseViewAs:m,isInitialized:c,actualRole:u,effectiveRole:y,viewAsRole:n,globalRole:r,projectRole:s,isImpersonating:b,setViewAs:h,clearViewAs:f,effectiveRoleConfig:p,actualRoleConfig:_,availableRoles:wt,debugInfo:w};return e.jsx(Sr.Provider,{value:k,children:i})}function ut(){const i=d.useContext(Sr);if(!i)throw new Error("useViewAs must be used within a ViewAsProvider");return i}const jr=d.createContext();function Va({children:i}){const[r,t]=d.useState(!1),[s,a]=d.useState(null),[n,o]=d.useState([]);d.useEffect(()=>{c(),l()},[]);async function c(){const{data:{user:p}}=await g.auth.getUser();if(p){const{data:_}=await g.from("profiles").select("role").eq("id",p.id).single();_&&a(_.role)}}async function l(){const{data:p}=await g.from("profiles").select("id").eq("is_test_user",!0);p&&o(p.map(_=>_.id))}const u=s==="admin"||s==="supplier_pm";function m(){u&&t(p=>!p)}function h(p){return n.includes(p)}function f(p,_="user_id"){return!p||r?p:p.filter(w=>!n.includes(w[_]))}function y(p){return!p||r?p:p.filter(_=>!_.is_test_content)}const b={showTestUsers:r,setShowTestUsers:t,toggleTestUsers:m,canToggleTestUsers:u,testUserIds:n,isTestUser:h,filterTestContent:f,filterByTestFlag:y,userRole:s};return e.jsx(jr.Provider,{value:b,children:i})}function Cr(){const i=d.useContext(jr);if(!i)throw new Error("useTestUsers must be used within a TestUserProvider");return i}const kr=d.createContext();function Wa(){return d.useContext(kr)}function $a({children:i}){const[r,t]=d.useState([]),[s,a]=d.useState(0),[n,o]=d.useState(0),[c,l]=d.useState(!0),[u,m]=d.useState(null),[h,f]=d.useState(null),y=E=>["admin","supplier_pm","customer_pm"].includes(E),b=d.useCallback(async(E,C)=>{try{let R=[];if(y(C)){const{data:D}=await g.from("timesheets").select("id, hours_worked, hours, work_date, date").eq("status","Submitted"),{data:N}=await g.from("expenses").select("id, amount, category, reason, resource_name, chargeable_to_customer").eq("status","Submitted"),{data:I}=await g.from("deliverables").select("id, name, deliverable_ref").eq("status","Submitted"),{data:j}=await g.from("milestone_certificates").select("id, milestone_id").eq("status","Submitted");D&&D.forEach(P=>{R.push({id:`ts-${P.id}`,type:"timesheet",notification_type:"action",title:"Timesheet Submitted",message:`Timesheet (${P.hours_worked||P.hours||0}h) pending approval`,action_url:"/timesheets",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1})}),N&&N.forEach(P=>{const B=P.chargeable_to_customer!==!1;R.push({id:`exp-${P.id}`,type:"expense",notification_type:"action",title:"Expense Submitted",message:`${P.resource_name||"Unknown"} expense (Â£${parseFloat(P.amount||0).toFixed(2)}) pending validation`,action_url:"/expenses",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1,isChargeable:B})}),I&&I.forEach(P=>{R.push({id:`del-${P.id}`,type:"deliverable",notification_type:"action",title:"Deliverable Submitted",message:`${P.deliverable_ref}: ${P.name} pending review`,action_url:"/deliverables",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1})}),j&&j.forEach(P=>{R.push({id:`cert-${P.id}`,type:"certificate",notification_type:"action",title:"Certificate Submitted",message:"Milestone certificate pending approval",action_url:"/milestones",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1})})}else{const{data:D}=await g.from("timesheets").select("id, hours_worked, hours, work_date, date, resource_id").eq("status","Submitted").eq("user_id",E),{data:N}=await g.from("expenses").select("id, amount, category, reason, resource_name").eq("status","Submitted").eq("created_by",E);D&&D.forEach(I=>{R.push({id:`ts-${I.id}`,type:"timesheet",notification_type:"action",title:"Timesheet Submitted",message:`Your timesheet for ${I.hours_worked||I.hours||0}h is pending approval`,action_url:"/timesheets",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1})}),N&&N.forEach(I=>{R.push({id:`exp-${I.id}`,type:"expense",notification_type:"action",title:"Expense Submitted",message:`Your expense (Â£${parseFloat(I.amount||0).toFixed(2)}) is pending validation`,action_url:"/expenses",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1})})}return{count:R.length,items:R}}catch{return{count:0,items:[]}}},[]),p=d.useCallback(async()=>{try{const{data:{user:E}}=await g.auth.getUser();if(!E){t([]),a(0),o(0),l(!1);return}m(E.id);const{data:C}=await g.from("profiles").select("role").eq("id",E.id).single(),R=C?.role||"viewer";f(R);const{count:D,items:N}=await b(E.id,R);t(N),a(D),o(D)}catch{}finally{l(!1)}},[b]),_=d.useCallback(async E=>{t(C=>C.map(R=>R.id===E?{...R,is_read:!0}:R)),a(C=>Math.max(0,C-1))},[]),w=d.useCallback(async E=>{t(C=>C.map(R=>R.id===E?{...R,is_actioned:!0,is_read:!0}:R)),a(C=>Math.max(0,C-1)),o(C=>Math.max(0,C-1))},[]),k=d.useCallback(async()=>{t(E=>E.map(C=>({...C,is_read:!0}))),a(0)},[]),S=d.useCallback(async E=>{const C=r.find(R=>R.id===E);C&&(t(R=>R.filter(D=>D.id!==E)),C.is_read||a(R=>Math.max(0,R-1)),C.notification_type==="action"&&!C.is_actioned&&o(R=>Math.max(0,R-1)))},[r]);d.useEffect(()=>{p();const E=setInterval(()=>{p()},3e4);return()=>clearInterval(E)},[p]),d.useEffect(()=>{const{data:{subscription:E}}=g.auth.onAuthStateChange((C,R)=>{C==="SIGNED_IN"?p():C==="SIGNED_OUT"&&(t([]),a(0),o(0),m(null),f(null))});return()=>E.unsubscribe()},[p]);const v={notifications:r,unreadCount:s,actionCount:n,loading:c,fetchNotifications:p,markAsRead:_,markAsActioned:w,markAllAsRead:k,dismissNotification:S};return e.jsx(kr.Provider,{value:v,children:i})}const Er=d.createContext(null),Tt="amsf-chat-history",Ua=50,vt={maxRetries:2,baseDelayMs:1e3,retryableCodes:[429,503,504]};function Fa(){try{const i=localStorage.getItem(Tt);if(i){const r=JSON.parse(i);return{messages:r.messages||[],tokenUsage:r.tokenUsage||{input:0,output:0,requests:0}}}}catch{}return{messages:[],tokenUsage:{input:0,output:0,requests:0}}}function Ha(i,r){try{const t=i.slice(-Ua);localStorage.setItem(Tt,JSON.stringify({messages:t,tokenUsage:r,savedAt:new Date().toISOString()}))}catch{}}function Ga({children:i}){const{user:r,profile:t,linkedResource:s,role:a}=ye(),{projectId:n,projectName:o,projectRef:c,currentProject:l}=de(),u=Fa(),[m,h]=d.useState(!1),[f,y]=d.useState(u.messages),[b,p]=d.useState(!1),[_,w]=d.useState(null),[k,S]=d.useState(0),[v,E]=d.useState(u.tokenUsage),[C,R]=d.useState(null),[D,N]=d.useState(!1),I=d.useRef(null),j=d.useRef(null);d.useEffect(()=>{(f.length>0||v.requests>0)&&Ha(f,v)},[f,v]),d.useEffect(()=>{if(!m||!n||j.current===n)return;(async()=>{N(!0);try{const G={email:r?.email,role:a||t?.role,linkedResourceId:s?.id,partnerId:s?.partner_id},q=await fetch("/api/chat-context",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:n,userContext:G})});if(q.ok){const z=await q.json();R(z.context),j.current=n}}catch{}finally{N(!1)}})()},[m,n,r?.email,a,t?.role,s?.id,s?.partner_id]);const P=d.useCallback(()=>l?{id:n,reference:c||l?.reference,name:o||l?.name,description:l?.description||null}:null,[l,n,c,o]),B=d.useCallback(()=>({name:t?.full_name||r?.email?.split("@")[0]||"User",email:r?.email,role:a||t?.role||"unknown",linkedResourceName:s?.name||null,linkedResourceId:s?.id||null,partnerId:s?.partner_id||null,partnerName:s?.partners?.name||null}),[r,t,s,a]),ee=[{pattern:/^(what'?s?|how'?s?).*(budget|spend)/i,type:"budget"},{pattern:/budget.*(status|summary|overview)/i,type:"budget"},{pattern:/how much.*(spent|spend)/i,type:"budget"},{pattern:/^how many milestones/i,type:"milestoneCount"},{pattern:/milestone.*(count|total|how many)/i,type:"milestoneCount"},{pattern:/^how many deliverables/i,type:"deliverableCount"},{pattern:/deliverable.*(count|total|how many)/i,type:"deliverableCount"},{pattern:/^(what'?s?|how'?s?).*(pending|to.?do|actions?)/i,type:"pending"},{pattern:/what.*(need|should).*(do|action)/i,type:"pending"},{pattern:/^(project )?(status|overview|summary)$/i,type:"overview"},{pattern:/^how.*(project|things).*(going|doing)/i,type:"overview"}],K=d.useCallback(Q=>{if(!C)return null;const G=Q.toLowerCase().trim();let q=null;for(const{pattern:le,type:ce}of ee)if(le.test(G)){q=ce;break}if(!q)return null;const z=C.budgetSummary,Z=C.milestoneSummary,te=C.deliverableSummary,J=C.pendingActions,se=C.timesheetSummary,oe=le=>`Â£${(le||0).toLocaleString()}`;switch(q){case"budget":return`**Project Budget Overview:**

â€¢ **Total Budget:** ${oe(z?.projectBudget)}
â€¢ **Milestone Billable:** ${oe(z?.milestoneBillable)}
â€¢ **Actual Spend:** ${oe(z?.actualSpend)}
â€¢ **Variance:** ${oe(z?.variance)}
â€¢ **Budget Used:** ${z?.percentUsed||0}%

${z?.percentUsed>80?"âš ï¸ Budget utilisation is over 80%.":z?.percentUsed>50?"Budget is tracking normally.":"Budget utilisation is healthy."}`;case"milestoneCount":return`There are **${Z?.total||0} milestones** in total:

â€¢ Completed: ${Z?.byStatus?.completed||0}
â€¢ In Progress: ${Z?.byStatus?.inProgress||0}
â€¢ At Risk: ${Z?.byStatus?.atRisk||0}
â€¢ Not Started: ${Z?.byStatus?.notStarted||0}`;case"deliverableCount":return`There are **${te?.total||0} deliverables** in total:

â€¢ Delivered: ${te?.byStatus?.delivered||0}
â€¢ Review Complete: ${te?.byStatus?.reviewComplete||0}
â€¢ Awaiting Review: ${te?.byStatus?.awaitingReview||0}
â€¢ In Progress: ${te?.byStatus?.inProgress||0}
â€¢ Not Started: ${te?.byStatus?.notStarted||0}`;case"pending":if(!((J?.draftTimesheets||0)>0||(J?.awaitingValidation||0)>0))return"âœ… **No pending actions!** You're all caught up.";let ce=`**Your Pending Actions:**

`;return J?.draftTimesheets>0&&(ce+=`â€¢ **${J.draftTimesheets}** draft timesheet(s) to submit
`),J?.awaitingValidation>0&&(ce+=`â€¢ **${J.awaitingValidation}** item(s) awaiting your validation
`),ce;case"overview":return`**Project Overview:**

**Budget:** ${oe(z?.actualSpend)} of ${oe(z?.milestoneBillable)} spent (${z?.percentUsed||0}%)

**Milestones:** ${Z?.byStatus?.completed||0} completed, ${Z?.byStatus?.inProgress||0} in progress${Z?.byStatus?.atRisk>0?`, ${Z.byStatus.atRisk} at risk`:""}

**Deliverables:** ${te?.byStatus?.delivered||0} delivered, ${te?.byStatus?.awaitingReview||0} awaiting review

**Timesheets:** ${se?.totalHours||0} hours logged

Need more details on any of these? Just ask!`;default:return null}},[C]),re=async(Q,G=1)=>{I.current=new AbortController;try{const q=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Q),signal:I.current.signal}),z=await q.json().catch(()=>({}));if(!q.ok){if(vt.retryableCodes.includes(q.status)&&G<=vt.maxRetries&&z.recoverable!==!1){const te=z.retryAfter?z.retryAfter*1e3:vt.baseDelayMs*Math.pow(2,G-1);return S(G),await new Promise(J=>setTimeout(J,te)),re(Q,G+1)}throw new Error(z.error||`Request failed (${q.status})`)}return S(0),z}catch(q){throw q.name==="AbortError"?new Error("Request cancelled"):q}},fe=[/budget|spend|cost|variance/i,/milestone.*(status|progress|summary|count|how many)/i,/deliverable.*(status|progress|summary|count|how many)/i,/timesheet.*(summary|total|hours|count|how many)/i,/expense.*(summary|total|amount|count|how many)/i,/pending|action|todo|to do|what.*(do|need)/i,/overview|summary|status|dashboard/i,/how.*(doing|going|progress)/i],Ce=[/specific|detail|list|show me|find|search/i,/filter|between|from|to|date|week|month|year/i,/resource|person|team member|who/i,/partner|supplier/i,/compare|versus|vs/i,/kpi|quality|standard/i,/\d+/],O=Q=>{if(!C)return!1;for(const G of Ce)if(G.test(Q))return!1;for(const G of fe)if(G.test(Q))return!0;return!1},Y=async(Q,G)=>{I.current=new AbortController;const q=await fetch("/api/chat-stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Q),signal:I.current.signal});if(!q.ok)throw new Error("Streaming request failed");const z=q.body.getReader(),Z=new TextDecoder;let te="";try{for(;;){const{done:J,value:se}=await z.read();if(J)break;const oe=Z.decode(se,{stream:!0});te+=oe,G(te)}}finally{z.releaseLock()}return te},me=d.useCallback(async Q=>{if(!Q.trim()||b)return;I.current&&I.current.abort();const G={role:"user",content:Q.trim(),timestamp:new Date().toISOString()};y(q=>[...q,G]),p(!0),w(null),S(0);try{const q=K(Q.trim());if(q){await new Promise(se=>setTimeout(se,100)),y(se=>[...se,{role:"assistant",content:q,toolsUsed:!1,cached:!1,local:!0,timestamp:new Date().toISOString()}]),p(!1);return}const z=P(),Z=B();if(O(Q)){const se=f.length+1;y(oe=>[...oe,{role:"assistant",content:"",toolsUsed:!1,streaming:!0,timestamp:new Date().toISOString()}]);try{const oe=[...f.slice(-9),G].map(le=>({role:le.role,content:le.content}));await Y({messages:oe,userContext:Z,projectContext:z,prefetchedContext:C},le=>{y(ce=>{const xe=[...ce],pt=xe.length-1;return xe[pt]?.role==="assistant"&&(xe[pt]={...xe[pt],content:le}),xe})}),y(le=>{const ce=[...le],xe=ce.length-1;return ce[xe]?.role==="assistant"&&(ce[xe]={...ce[xe],streaming:!1}),ce}),p(!1);return}catch{y(le=>le.slice(0,-1))}}const te=[...f.slice(-9),G].map(se=>({role:se.role,content:se.content})),J=await re({messages:te,projectContext:z,userContext:Z,projectId:n,prefetchedContext:C});J.usage&&E(se=>({input:se.input+(J.usage.input_tokens||0),output:se.output+(J.usage.output_tokens||0),requests:se.requests+1})),y(se=>[...se,{role:"assistant",content:J.message,toolsUsed:J.toolsUsed||!1,cached:J.cached||!1,timestamp:new Date().toISOString(),tokens:J.usage?{input:J.usage.input_tokens,output:J.usage.output_tokens}:null}])}catch(q){let z=q.message;q.message==="Request cancelled"?z=null:q.message.includes("Failed to fetch")&&(z="Unable to connect. Please check your internet connection."),z&&(w(z),y(Z=>Z.slice(0,-1)))}finally{p(!1),S(0)}},[f,b,P,B,n,C]),ne=d.useCallback(()=>{I.current&&(I.current.abort(),p(!1),S(0))},[]),M=d.useCallback(()=>{ne(),y([]),w(null),localStorage.removeItem(Tt)},[ne]),X=d.useCallback(()=>{M(),E({input:0,output:0,requests:0})},[M]),Ae=d.useCallback(()=>{h(Q=>!Q)},[]),T=d.useCallback(()=>{w(null)},[]),W=d.useCallback(()=>{if(f.length===0)return null;const Q=B(),G=P();let q=`# Chat Export

`;return q+=`**Exported:** ${new Date().toLocaleString("en-GB")}
`,q+=`**User:** ${Q.name} (${Q.role})
`,G&&(q+=`**Project:** ${G.name} (${G.reference})
`),q+=`**Messages:** ${f.length}
`,q+=`**Token Usage:** ${v.input.toLocaleString()} input / ${v.output.toLocaleString()} output

`,q+=`---

`,f.forEach((z,Z)=>{const te=z.role==="user"?"ðŸ‘¤ You":"ðŸ¤– Assistant",J=z.timestamp?new Date(z.timestamp).toLocaleTimeString("en-GB"):"";q+=`### ${te}${J?` (${J})`:""}

`,q+=`${z.content}

`,z.toolsUsed&&(q+=`*ðŸ“Š Queried project data*

`),Z<f.length-1&&(q+=`---

`)}),q},[f,v,B,P]),De=d.useCallback(()=>{const Q=W();if(!Q)return;const G=new Blob([Q],{type:"text/markdown"}),q=URL.createObjectURL(G),z=document.createElement("a");z.href=q,z.download=`chat-export-${new Date().toISOString().split("T")[0]}.md`,document.body.appendChild(z),z.click(),document.body.removeChild(z),URL.revokeObjectURL(q)},[W]),He=d.useCallback(async Q=>{try{return await navigator.clipboard.writeText(Q),!0}catch{return!1}},[]),ze={isOpen:m,setIsOpen:h,toggleChat:Ae,messages:f,isLoading:b,isLoadingContext:D,error:_,retryCount:k,tokenUsage:v,sendMessage:me,clearChat:M,resetAllStats:X,cancelRequest:ne,dismissError:T,exportChat:W,downloadChat:De,copyMessage:He};return e.jsx(Er.Provider,{value:ze,children:i})}function Ka(){const i=d.useContext(Er);if(!i)throw new Error("useChat must be used within a ChatProvider");return i}class Qa extends lt.Component{constructor(t){super(t);Ge(this,"handleReload",()=>{window.location.reload()});Ge(this,"handleReset",()=>{this.setState({hasError:!1,error:null,errorInfo:null})});this.state={hasError:!1,error:null,errorInfo:null}}static getDerivedStateFromError(t){return{hasError:!0,error:t}}componentDidCatch(t,s){this.setState({errorInfo:s})}render(){return this.state.hasError?this.props.fallback?this.props.fallback:e.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"3rem",backgroundColor:"#fef2f2",borderRadius:"12px",margin:"1rem",border:"1px solid #fecaca"},children:[e.jsx(Ue,{size:48,style:{color:"#dc2626",marginBottom:"1rem"}}),e.jsx("h2",{style:{color:"#991b1b",margin:"0 0 0.5rem 0",fontSize:"1.25rem",fontWeight:"600"},children:"Something went wrong"}),e.jsx("p",{style:{color:"#64748b",margin:"0 0 1.5rem 0",textAlign:"center",maxWidth:"400px"},children:this.state.error?.message||"An unexpected error occurred. Please try again."}),e.jsxs("div",{style:{display:"flex",gap:"0.75rem"},children:[e.jsx("button",{onClick:this.handleReset,style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.625rem 1.25rem",backgroundColor:"white",color:"#374151",border:"1px solid #d1d5db",borderRadius:"8px",cursor:"pointer",fontSize:"0.875rem",fontWeight:"500"},children:"Try Again"}),e.jsxs("button",{onClick:this.handleReload,style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.625rem 1.25rem",backgroundColor:"#3b82f6",color:"white",border:"none",borderRadius:"8px",cursor:"pointer",fontSize:"0.875rem",fontWeight:"500"},children:[e.jsx(Se,{size:16}),"Reload Page"]})]})]}):this.props.children}}function Ya({error:i,resetError:r,title:t="Something went wrong",compact:s=!1}){const[a,n]=lt.useState(!1);return s?e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#fef2f2",border:"1px solid #fecaca",borderRadius:"8px",display:"flex",alignItems:"center",gap:"0.75rem"},children:[e.jsx(Ue,{size:18,style:{color:"#dc2626",flexShrink:0}}),e.jsx("span",{style:{color:"#991b1b",fontSize:"0.875rem",flex:1},children:"Failed to load this section"}),r&&e.jsxs("button",{onClick:r,style:{padding:"0.375rem 0.75rem",backgroundColor:"white",border:"1px solid #fecaca",borderRadius:"6px",cursor:"pointer",display:"flex",alignItems:"center",gap:"0.375rem",fontSize:"0.8125rem",color:"#dc2626"},children:[e.jsx(Se,{size:14}),"Retry"]})]}):e.jsxs("div",{style:{padding:"1.5rem",backgroundColor:"#fef2f2",border:"1px solid #fecaca",borderRadius:"12px",textAlign:"center"},children:[e.jsx("div",{style:{width:"48px",height:"48px",backgroundColor:"#fee2e2",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 1rem"},children:e.jsx(Ue,{size:24,style:{color:"#dc2626"}})}),e.jsx("h3",{style:{margin:"0 0 0.5rem",fontSize:"1.125rem",fontWeight:"600",color:"#991b1b"},children:t}),e.jsx("p",{style:{margin:"0 0 1rem",fontSize:"0.875rem",color:"#b91c1c"},children:"This section encountered an error and couldn't load."}),e.jsxs("div",{style:{display:"flex",gap:"0.75rem",justifyContent:"center"},children:[r&&e.jsxs("button",{onClick:r,style:{padding:"0.5rem 1rem",backgroundColor:"#dc2626",color:"white",border:"none",borderRadius:"8px",cursor:"pointer",display:"flex",alignItems:"center",gap:"0.5rem",fontSize:"0.875rem",fontWeight:"500"},children:[e.jsx(Se,{size:16}),"Try Again"]}),e.jsxs("button",{onClick:()=>n(!a),style:{padding:"0.5rem 1rem",backgroundColor:"white",color:"#991b1b",border:"1px solid #fecaca",borderRadius:"8px",cursor:"pointer",display:"flex",alignItems:"center",gap:"0.5rem",fontSize:"0.875rem"},children:[a?e.jsx(ks,{size:16}):e.jsx(ir,{size:16}),a?"Hide Details":"Show Details"]})]}),a&&i&&e.jsx("div",{style:{marginTop:"1rem",padding:"1rem",backgroundColor:"#fee2e2",borderRadius:"8px",textAlign:"left",overflow:"auto",maxHeight:"200px"},children:e.jsxs("pre",{style:{margin:0,fontSize:"0.75rem",fontFamily:"monospace",color:"#7f1d1d",whiteSpace:"pre-wrap",wordBreak:"break-word"},children:[i.message,i.stack&&e.jsxs(e.Fragment,{children:[`

`,"Stack trace:",`
`,i.stack]})]})})]})}class qo extends lt.Component{constructor(t){super(t);Ge(this,"resetError",()=>{this.setState({hasError:!1,error:null})});this.state={hasError:!1,error:null}}static getDerivedStateFromError(t){return{hasError:!0,error:t}}componentDidCatch(t,s){this.props.onError&&this.props.onError(t,s)}render(){return this.state.hasError?this.props.fallback?typeof this.props.fallback=="function"?this.props.fallback({error:this.state.error,resetError:this.resetError}):this.props.fallback:e.jsx(Ya,{error:this.state.error,resetError:this.resetError,title:this.props.errorTitle,compact:this.props.compact}):this.props.children}}function nt({message:i,size:r="medium",fullPage:t=!1,className:s=""}){const a={small:"spinner-sm",medium:"",large:"spinner-lg"};return e.jsxs("div",{className:`loading-spinner ${s}`,style:t?{minHeight:"60vh"}:void 0,children:[e.jsx("div",{className:`spinner ${a[r]}`}),i&&e.jsx("p",{className:"loading-text",children:i})]})}const Ja={background:"linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%)",backgroundSize:"200% 100%",animation:"shimmer 1.5s infinite"};function $({width:i="100%",height:r="1rem",style:t={},className:s=""}){return e.jsxs(e.Fragment,{children:[e.jsx("style",{children:`
        @keyframes shimmer {
          0% { background-position: 200% 0; }
          100% { background-position: -200% 0; }
        }
      `}),e.jsx("div",{className:s,style:{width:i,height:r,borderRadius:"4px",...Ja,...t}})]})}function Et({width:i="100%",lines:r=1}){return e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"0.5rem"},children:Array.from({length:r}).map((t,s)=>e.jsx($,{width:s===r-1&&r>1?"70%":i,height:"1rem"},s))})}function Xa(){return e.jsxs("div",{style:{backgroundColor:"white",borderRadius:"12px",padding:"1.5rem",boxShadow:"0 1px 3px rgba(0,0,0,0.1)",display:"flex",alignItems:"center",gap:"1rem"},children:[e.jsx($,{width:"48px",height:"48px",style:{borderRadius:"12px"}}),e.jsxs("div",{style:{flex:1},children:[e.jsx($,{width:"60%",height:"0.875rem",style:{marginBottom:"0.5rem"}}),e.jsx($,{width:"40%",height:"1.5rem"})]})]})}function Za({columns:i=6}){return e.jsx("tr",{children:Array.from({length:i}).map((r,t)=>e.jsx("td",{style:{padding:"0.75rem 1rem"},children:e.jsx($,{width:t===0?"80%":t===i-1?"60px":"70%",height:"1rem"})},t))})}function _t({hasHeader:i=!0}){return e.jsxs("div",{style:{backgroundColor:"white",borderRadius:"12px",padding:"1.5rem",boxShadow:"0 1px 3px rgba(0,0,0,0.1)"},children:[i&&e.jsx($,{width:"40%",height:"1.5rem",style:{marginBottom:"1rem"}}),e.jsx(Et,{lines:3})]})}function Le({rows:i=4}){return e.jsxs("div",{style:{backgroundColor:"white",borderRadius:"12px",padding:"1.25rem",boxShadow:"0 1px 3px rgba(0,0,0,0.1)",border:"1px solid #e2e8f0"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem",marginBottom:"1rem",paddingBottom:"0.75rem",borderBottom:"1px solid #f1f5f9"},children:[e.jsx($,{width:"32px",height:"32px",style:{borderRadius:"8px"}}),e.jsx($,{width:"100px",height:"1rem"}),e.jsx("div",{style:{marginLeft:"auto"},children:e.jsx($,{width:"60px",height:"0.875rem"})})]}),e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"0.75rem"},children:Array.from({length:i}).map((r,t)=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem",padding:"0.5rem 0"},children:[e.jsx($,{width:"24px",height:"24px",style:{borderRadius:"6px"}}),e.jsx($,{width:`${60+Math.random()*30}%`,height:"0.875rem"}),e.jsx("div",{style:{marginLeft:"auto"},children:e.jsx($,{width:"30px",height:"1rem"})})]},t))})]})}function Ot(){return e.jsxs("div",{style:{backgroundColor:"white",borderRadius:"12px",padding:"1rem 1.25rem",boxShadow:"0 1px 3px rgba(0,0,0,0.1)",border:"1px solid #e2e8f0",display:"flex",alignItems:"center",gap:"1rem"},children:[e.jsx($,{width:"40px",height:"40px",style:{borderRadius:"10px"}}),e.jsxs("div",{style:{flex:1},children:[e.jsx($,{width:"70%",height:"0.75rem",style:{marginBottom:"0.5rem"}}),e.jsx($,{width:"40%",height:"1.25rem"})]}),e.jsx($,{width:"50px",height:"1.5rem",style:{borderRadius:"6px"}})]})}function $e(){return e.jsxs("div",{style:{backgroundColor:"white",borderRadius:"12px",padding:"1.5rem",boxShadow:"0 1px 3px rgba(0,0,0,0.1)",border:"1px solid #e2e8f0"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"1.5rem"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem"},children:[e.jsx($,{width:"32px",height:"32px",style:{borderRadius:"8px"}}),e.jsx($,{width:"120px",height:"1.25rem"})]}),e.jsx($,{width:"80px",height:"2rem",style:{borderRadius:"8px"}})]}),e.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:"1rem",marginBottom:"1.5rem"},children:Array.from({length:4}).map((i,r)=>e.jsxs("div",{style:{padding:"0.75rem",backgroundColor:"#f8fafc",borderRadius:"8px"},children:[e.jsx($,{width:"60%",height:"0.75rem",style:{marginBottom:"0.5rem"}}),e.jsx($,{width:"80%",height:"1.25rem"})]},r))}),e.jsx($,{width:"100%",height:"8px",style:{borderRadius:"4px"}})]})}function Re({type:i="text",count:r=1,...t}){return(()=>{switch(i){case"text":return e.jsx(Et,{...t});case"stat-card":case"stats":return e.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:"1rem"},children:Array.from({length:r}).map((a,n)=>e.jsx(Xa,{},n))});case"table":return e.jsx("div",{className:"card",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsx("tr",{children:Array.from({length:t.columns||6}).map((a,n)=>e.jsx("th",{style:{padding:"0.75rem 1rem"},children:e.jsx($,{width:"60%",height:"0.875rem"})},n))})}),e.jsx("tbody",{children:Array.from({length:t.rows||5}).map((a,n)=>e.jsx(Za,{columns:t.columns||6},n))})]})});case"card":return e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"1rem"},children:Array.from({length:r}).map((a,n)=>e.jsx(_t,{...t},n))});case"widget":return e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"1rem"},children:Array.from({length:r}).map((a,n)=>e.jsx(Le,{rows:t.rows||4},n))});case"widget-grid":return e.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(280px, 1fr))",gap:"1rem"},children:Array.from({length:r}).map((a,n)=>e.jsx(Le,{rows:t.rows||4},n))});case"metric-card":case"kpi":return e.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(250px, 1fr))",gap:"1rem"},children:Array.from({length:r}).map((a,n)=>e.jsx(Ot,{},n))});case"finance-widget":return e.jsx($e,{});case"dashboard":return e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"1.5rem"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsx($,{width:"180px",height:"1.75rem",style:{marginBottom:"0.5rem"}}),e.jsx($,{width:"250px",height:"1rem"})]}),e.jsx($,{width:"100px",height:"40px",style:{borderRadius:"8px"}})]}),e.jsx(Re,{type:"widget-grid",count:4,rows:4}),e.jsx(Re,{type:"metric-card",count:5}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsx($e,{}),e.jsx($e,{})]})]});case"page":return e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"1.5rem"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsx($,{width:"200px",height:"1.75rem",style:{marginBottom:"0.5rem"}}),e.jsx($,{width:"300px",height:"1rem"})]}),e.jsx($,{width:"120px",height:"40px",style:{borderRadius:"8px"}})]}),e.jsx(Re,{type:"stats",count:4}),e.jsx(Re,{type:"table",rows:8,columns:6})]});case"detail":return e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"1.5rem"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"1rem"},children:[e.jsx($,{width:"80px",height:"36px",style:{borderRadius:"8px"}}),e.jsx($,{width:"250px",height:"1.75rem"})]}),e.jsx(Re,{type:"stats",count:4}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsx(_t,{}),e.jsx(_t,{})]}),e.jsx(Re,{type:"table",rows:5,columns:5})]});default:return e.jsx(Et,{...t})}})()}const Kt={success:{icon:Pe,bgColor:"#dcfce7",borderColor:"#86efac",textColor:"#166534",iconColor:"#16a34a"},error:{icon:or,bgColor:"#fee2e2",borderColor:"#fecaca",textColor:"#991b1b",iconColor:"#dc2626"},warning:{icon:Ue,bgColor:"#fef3c7",borderColor:"#fde68a",textColor:"#92400e",iconColor:"#d97706"},info:{icon:Es,bgColor:"#dbeafe",borderColor:"#93c5fd",textColor:"#1e40af",iconColor:"#3b82f6"}};function en({id:i,message:r,type:t="info",duration:s=4e3,onClose:a}){const n=Kt[t]||Kt.info,o=n.icon;return d.useEffect(()=>{if(s>0){const c=setTimeout(()=>{a(i)},s);return()=>clearTimeout(c)}},[i,s,a]),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem",padding:"0.875rem 1rem",backgroundColor:n.bgColor,border:`1px solid ${n.borderColor}`,borderRadius:"8px",boxShadow:"0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)",minWidth:"300px",maxWidth:"450px",animation:"slideIn 0.3s ease-out"},children:[e.jsx(o,{size:20,style:{color:n.iconColor,flexShrink:0}}),e.jsx("span",{style:{color:n.textColor,fontSize:"0.875rem",fontWeight:"500",flex:1},children:r}),e.jsx("button",{onClick:()=>a(i),style:{background:"none",border:"none",cursor:"pointer",padding:"0.25rem",display:"flex",alignItems:"center",justifyContent:"center",color:n.textColor,opacity:.7,borderRadius:"4px"},onMouseEnter:c=>c.target.style.opacity=1,onMouseLeave:c=>c.target.style.opacity=.7,children:e.jsx(ue,{size:16})})]})}function tn({toasts:i,removeToast:r}){return i.length===0?null:e.jsxs("div",{style:{position:"fixed",top:"1rem",right:"1rem",zIndex:9999,display:"flex",flexDirection:"column",gap:"0.5rem"},children:[e.jsx("style",{children:`
          @keyframes slideIn {
            from {
              transform: translateX(100%);
              opacity: 0;
            }
            to {
              transform: translateX(0);
              opacity: 1;
            }
          }
        `}),i.map(t=>e.jsx(en,{id:t.id,message:t.message,type:t.type,duration:t.duration,onClose:r},t.id))]})}const Rr=d.createContext(null),rn=4e3;function sn({children:i}){const[r,t]=d.useState([]),s=d.useCallback(m=>{t(h=>h.filter(f=>f.id!==m))},[]),a=d.useCallback((m,h="info",f=rn)=>{const y=Date.now()+Math.random(),b={id:y,message:m,type:h,duration:f};return t(p=>[...p,b]),y},[]),n=d.useCallback((m,h)=>a(m,"success",h),[a]),o=d.useCallback((m,h)=>a(m,"error",h||6e3),[a]),c=d.useCallback((m,h)=>a(m,"warning",h),[a]),l=d.useCallback((m,h)=>a(m,"info",h),[a]),u={showToast:a,showSuccess:n,showError:o,showWarning:c,showInfo:l,removeToast:s};return e.jsxs(Rr.Provider,{value:u,children:[i,e.jsx(tn,{toasts:r,removeToast:s})]})}function Pr(){const i=d.useContext(Rr);if(!i)throw new Error("useToast must be used within a ToastProvider");return i}const ae={timesheets:{contributeToSpend:["Submitted","Validated","Approved"],excludeFromSpend:["Draft","Rejected"],completed:["Validated","Approved"]},expenses:{contributeToSpend:["Submitted","Validated","Approved"],excludeFromSpend:["Draft","Rejected"],completed:["Validated","Approved"]},deliverables:{contributeToKPIs:["Delivered"],contributeToQS:["Delivered"],inProgress:["In Progress","Submitted","Under Review"],completed:["Delivered"],notStarted:["Not Started","Draft"]},milestones:{completed:["Completed"],inProgress:["In Progress"],notStarted:["Not Started","Planned"]},kpis:{achieved:["Achieved","On Target"],atRisk:["At Risk","Amber"],failing:["Failing","Red","Off Target"]},qualityStandards:{achieved:["Achieved","Met"],partial:["Partial","In Progress"],notMet:["Not Met","Failed"]}},an=["pmo","project manager","pm"];function We(i){if(!i)return!1;const r=i.toLowerCase();return an.some(t=>r.includes(t))}function Qt(i){return i?ae.timesheets.contributeToSpend.includes(i):!1}function Yt(i){return i?ae.expenses.contributeToSpend.includes(i):!1}const Jt={defaultTarget:90,amberThreshold:10,calculationMethod:"assessment_based"},nn={defaultTarget:100,calculationMethod:"assessment_based"},Nr={hoursPerDay:8,currency:"Â£",currencyCode:"GBP",decimalPlaces:2};function qe(i){return(parseFloat(i)||0)/Nr.hoursPerDay}function Lt(i,r){return qe(i)*(parseFloat(r)||0)}function Xt(i,r){return qe(i)*(parseFloat(r)||0)}class on{constructor(){this.cache=new Map,this.cacheTimeout=5e3}clearCache(){this.cache.clear()}getCached(r){const t=this.cache.get(r);return t&&Date.now()-t.timestamp<this.cacheTimeout?t.data:null}setCache(r,t){this.cache.set(r,{data:t,timestamp:Date.now()})}async getMilestoneMetrics(r){const t=`milestones_${r}`,s=this.getCached(t);if(s)return s;try{const{data:a,error:n}=await g.from("milestones").select("id, milestone_ref, name, status, progress, budget, percent_complete, is_deleted").eq("project_id",r).order("milestone_ref");if(n)throw n;const o=a?.filter(l=>l.is_deleted!==!0)||[],c={total:o.length,completed:o.filter(l=>ae.milestones.completed.includes(l.status)).length,inProgress:o.filter(l=>ae.milestones.inProgress.includes(l.status)).length,notStarted:o.filter(l=>ae.milestones.notStarted.includes(l.status)).length,totalBudget:o.reduce((l,u)=>l+(u.budget||0),0),averageProgress:o.length>0?Math.round(o.reduce((l,u)=>l+(u.progress||0),0)/o.length):0,milestones:o};return this.setCache(t,c),c}catch(a){throw a}}async getDeliverableMetrics(r,t=!1){const s=`deliverables_${r}_${t}`,a=this.getCached(s);if(a)return a;try{const{data:n,error:o}=await g.from("deliverables").select("id, deliverable_ref, name, status, due_date, milestone_id, is_deleted, is_test_content").eq("project_id",r).order("deliverable_ref");if(o)throw o;let c=n?.filter(f=>f.is_deleted!==!0)||[];t||(c=c.filter(f=>f.is_test_content!==!0));const l=new Date().toISOString().split("T")[0],u=new Date;u.setDate(u.getDate()+7);const m=u.toISOString().split("T")[0],h={total:c.length,delivered:c.filter(f=>ae.deliverables.completed.includes(f.status)).length,inProgress:c.filter(f=>ae.deliverables.inProgress.includes(f.status)).length,notStarted:c.filter(f=>ae.deliverables.notStarted.includes(f.status)).length,overdue:c.filter(f=>f.due_date<l&&!ae.deliverables.completed.includes(f.status)).length,dueThisWeek:c.filter(f=>f.due_date>=l&&f.due_date<=m&&!ae.deliverables.completed.includes(f.status)).length,deliverables:c};return h.completionPercent=h.total>0?Math.round(h.delivered/h.total*100):0,this.setCache(s,h),h}catch(n){throw n}}async getKPIMetrics(r){const t=`kpis_${r}`,s=this.getCached(t);if(s)return s;try{const{data:a,error:n}=await g.from("kpis").select("id, kpi_ref, name, category, target, current_value, is_deleted").eq("project_id",r).order("kpi_ref");if(n)throw n;const o=a?.filter(b=>b.is_deleted!==!0)||[],{data:c,error:l}=await g.from("deliverable_kpi_assessments").select(`
          kpi_id,
          criteria_met,
          deliverables!inner(id, status, is_deleted, project_id)
        `).eq("deliverables.project_id",r),u=c?.filter(b=>b.deliverables?.is_deleted!==!0&&ae.deliverables.contributeToKPIs.includes(b.deliverables?.status))||[],m=new Map;u&&u.length>0&&u.forEach(b=>{m.has(b.kpi_id)||m.set(b.kpi_id,{total:0,met:0});const p=m.get(b.kpi_id);p.total++,b.criteria_met&&p.met++});const h=o.map(b=>{const p=m.get(b.id);let _=0;p&&p.total>0&&(_=Math.round(p.met/p.total*100));const w=b.target||Jt.defaultTarget,k=_>=w;return{...b,calculatedValue:_,assessmentCount:p?.total||0,assessmentsMet:p?.met||0,isAchieved:k,ragStatus:_>=w?"Green":_>=w*(1-Jt.amberThreshold/100)?"Amber":"Red"}}),f={};h.forEach(b=>{const p=b.category||"Other";f[p]||(f[p]=[]),f[p].push(b)});const y={total:o.length,achieved:h.filter(b=>b.isAchieved).length,atRisk:h.filter(b=>b.ragStatus==="Amber").length,failing:h.filter(b=>b.ragStatus==="Red").length,achievementPercent:o.length>0?Math.round(h.filter(b=>b.isAchieved).length/o.length*100):0,byCategory:f,kpis:h};return this.setCache(t,y),y}catch(a){throw a}}async getQualityStandardMetrics(r){const t=`qs_${r}`,s=this.getCached(t);if(s)return s;try{const{data:a,error:n}=await g.from("quality_standards").select("id, qs_ref, name, target, current_value, is_deleted").eq("project_id",r).order("qs_ref");if(n)throw n;const o=a?.filter(y=>y.is_deleted!==!0)||[],{data:c,error:l}=await g.from("deliverable_qs_assessments").select(`
          quality_standard_id,
          criteria_met,
          deliverables!inner(id, status, is_deleted, project_id)
        `).eq("deliverables.project_id",r),u=c?.filter(y=>y.deliverables?.is_deleted!==!0&&ae.deliverables.contributeToQS.includes(y.deliverables?.status))||[],m=new Map;u&&u.length>0&&u.forEach(y=>{m.has(y.quality_standard_id)||m.set(y.quality_standard_id,{total:0,met:0});const b=m.get(y.quality_standard_id);b.total++,y.criteria_met&&b.met++});const h=o.map(y=>{const b=m.get(y.id);let p=0;b&&b.total>0&&(p=Math.round(b.met/b.total*100));const _=y.target||nn.defaultTarget,w=p>=_;return{...y,calculatedValue:p,assessmentCount:b?.total||0,assessmentsMet:b?.met||0,isAchieved:w}}),f={total:o.length,achieved:h.filter(y=>y.isAchieved).length,partial:h.filter(y=>y.calculatedValue>0&&!y.isAchieved).length,notMet:h.filter(y=>y.calculatedValue===0).length,achievementPercent:o.length>0?Math.round(h.filter(y=>y.isAchieved).length/o.length*100):0,qualityStandards:h};return this.setCache(t,f),f}catch(a){throw a}}async getTimesheetMetrics(r,t=!1){const s=`timesheets_${r}_${t}`,a=this.getCached(s);if(a)return a;try{const{data:n,error:o}=await g.from("timesheets").select(`
          id, date, hours_worked, hours, status, milestone_id, resource_id, is_deleted,
          resources(id, name, role, sell_price)
        `).eq("project_id",r);if(o)throw o;const c=n?.filter(p=>p.is_deleted!==!0)||[];let l=0,u=0,m=0,h=0;const f={},y={};c.forEach(p=>{const _=parseFloat(p.hours_worked||p.hours||0),w=p.resources,k=w?.sell_price||0,S=_/Nr.hoursPerDay*k;Qt(p.status)&&(l+=_,u+=S,We(w?.role)?m+=S:h+=S,p.milestone_id&&(f[p.milestone_id]=(f[p.milestone_id]||0)+S),p.resource_id&&(y[p.resource_id]=(y[p.resource_id]||0)+S))});const b={totalEntries:c.length,validEntries:c.filter(p=>Qt(p.status)).length,draftEntries:c.filter(p=>p.status==="Draft").length,rejectedEntries:c.filter(p=>p.status==="Rejected").length,totalHours:l,totalSpend:u,pmoSpend:m,deliverySpend:h,spendByMilestone:f,spendByResource:y};return this.setCache(s,b),b}catch(n){throw n}}async getExpenseMetrics(r,t=!1){const s=`expenses_${r}_${t}`,a=this.getCached(s);if(a)return a;try{const{data:n,error:o}=await g.from("expenses").select("id, expense_date, amount, status, category, chargeable_to_customer, procurement_method, is_deleted").eq("project_id",r);if(o)throw o;const c=n?.filter(y=>y.is_deleted!==!0)||[];let l=0,u=0,m=0;const h={};c.forEach(y=>{const b=parseFloat(y.amount||0);if(Yt(y.status)){l+=b,y.chargeable_to_customer?u+=b:m+=b;const p=y.category||"Other";h[p]=(h[p]||0)+b}});const f={totalEntries:c.length,validEntries:c.filter(y=>Yt(y.status)).length,draftEntries:c.filter(y=>y.status==="Draft").length,rejectedEntries:c.filter(y=>y.status==="Rejected").length,totalAmount:l,chargeableAmount:u,nonChargeableAmount:m,byCategory:h};return this.setCache(s,f),f}catch(n){throw n}}async getResourceMetrics(r){const t=`resources_${r}`,s=this.getCached(t);if(s)return s;try{const{data:a,error:n}=await g.from("resources").select("id, name, role, sell_price, days_allocated, is_deleted").eq("project_id",r);if(n)throw n;const o=a?.filter(m=>m.is_deleted!==!0)||[];let c=0,l=0;o.forEach(m=>{const h=(m.sell_price||0)*(m.days_allocated||0);We(m.role)?c+=h:l+=h});const u={total:o.length,pmoCount:o.filter(m=>We(m.role)).length,deliveryCount:o.filter(m=>!We(m.role)).length,pmoBudget:c,deliveryBudget:l,totalBudget:c+l,resources:o};return this.setCache(t,u),u}catch(a){throw a}}async getCertificateMetrics(r){const t=`certificates_${r}`,s=this.getCached(t);if(s)return s;try{const{data:a,error:n}=await g.from("milestone_certificates").select("id, milestone_id, status").eq("project_id",r);if(n)throw n;const o=await this.getMilestoneMetrics(r),c={total:a?.length||0,signed:a?.filter(l=>l.status==="Signed").length||0,pending:a?.filter(l=>l.status==="Pending Customer Signature"||l.status==="Pending Supplier Signature").length||0,awaitingGeneration:Math.max(0,o.completed-(a?.length||0))};return this.setCache(t,c),c}catch(a){throw a}}async getAllDashboardMetrics(r,t={}){const{includeTestContent:s=!1}=t;try{const[a,n,o,c,l,u,m,h]=await Promise.all([this.getMilestoneMetrics(r),this.getDeliverableMetrics(r,s),this.getKPIMetrics(r),this.getQualityStandardMetrics(r),this.getTimesheetMetrics(r,s),this.getExpenseMetrics(r,s),this.getResourceMetrics(r),this.getCertificateMetrics(r)]),f={totalBudget:a.totalBudget,timesheetSpend:l.totalSpend,expenseSpend:u.totalAmount,totalSpend:l.totalSpend+u.totalAmount,pmoBudget:m.pmoBudget,pmoSpend:l.pmoSpend,deliveryBudget:m.deliveryBudget,deliverySpend:l.deliverySpend,utilizationPercent:a.totalBudget>0?Math.round((l.totalSpend+u.totalAmount)/a.totalBudget*100):0},y={...l.spendByMilestone};return Object.entries(u.byMilestone).forEach(([b,p])=>{y[b]=(y[b]||0)+p}),{milestones:a,deliverables:n,kpis:o,qualityStandards:c,timesheets:l,expenses:u,resources:m,certificates:h,budget:f,milestoneSpend:y,projectProgress:a.averageProgress,lastUpdated:new Date().toISOString()}}catch(a){throw a}}}const pe=new on,Ar=d.createContext(null);function ln({children:i}){const{projectId:r}=de(),{showTestUsers:t}=Cr(),[s,a]=d.useState(null),[n,o]=d.useState(!0),[c,l]=d.useState(null),[u,m]=d.useState(null),h=d.useCallback(async(b=!1)=>{if(!r){a(null),o(!1);return}b&&pe.clearCache(),o(!0),l(null);try{const p=await pe.getAllDashboardMetrics(r,{includeTestContent:t});a(p),m(new Date)}catch(p){l(p.message||"Failed to load metrics")}finally{o(!1)}},[r,t]),f=d.useCallback(async b=>{if(r)try{let p;switch(b){case"milestones":p=await pe.getMilestoneMetrics(r),a(_=>_?{..._,milestones:p}:null);break;case"deliverables":p=await pe.getDeliverableMetrics(r,t),a(_=>_?{..._,deliverables:p}:null);break;case"kpis":p=await pe.getKPIMetrics(r),a(_=>_?{..._,kpis:p}:null);break;case"qualityStandards":p=await pe.getQualityStandardMetrics(r),a(_=>_?{..._,qualityStandards:p}:null);break;case"timesheets":p=await pe.getTimesheetMetrics(r,t),a(_=>_?{..._,timesheets:p}:null);break;case"expenses":p=await pe.getExpenseMetrics(r,t),a(_=>_?{..._,expenses:p}:null);break;case"resources":p=await pe.getResourceMetrics(r),a(_=>_?{..._,resources:p}:null);break;case"certificates":p=await pe.getCertificateMetrics(r),a(_=>_?{..._,certificates:p}:null);break;default:await h(!0)}m(new Date)}catch{}},[r,t,h]);d.useEffect(()=>{h()},[h]);const y=d.useMemo(()=>({metrics:s,milestones:s?.milestones||null,deliverables:s?.deliverables||null,kpis:s?.kpis||null,qualityStandards:s?.qualityStandards||null,timesheets:s?.timesheets||null,expenses:s?.expenses||null,resources:s?.resources||null,certificates:s?.certificates||null,billable:s?.billable||null,milestoneSpend:s?.milestoneSpend||{},projectProgress:s?.projectProgress||0,loading:n,error:c,lastRefresh:u,refreshMetrics:()=>h(!0),refreshCategory:f,clearCache:()=>pe.clearCache()}),[s,n,c,u,h,f]);return e.jsx(Ar.Provider,{value:y,children:i})}function zo(){const i=d.useContext(Ar);if(!i)throw new Error("useMetrics must be used within a MetricsProvider");return i}const Dr=d.createContext(null),Zt={"/":"dashboard","/dashboard":"dashboard","/milestones":"milestones","/deliverables":"deliverables","/resources":"resources","/timesheets":"timesheets","/expenses":"expenses","/partners":"partners","/kpis":"kpis","/quality-standards":"qualityStandards","/raid-log":"raidLog","/users":"users","/settings":"general","/account":"general"};function cn(i){return Zt[i]?Zt[i]:i.startsWith("/milestones/")?"milestoneDetail":i.startsWith("/deliverables/")?"deliverableDetail":i.startsWith("/resources/")?"resources":i.startsWith("/partners/")?"partners":i.startsWith("/kpis/")?"kpis":i.startsWith("/quality-standards/")?"qualityStandards":"general"}function dn({children:i}){const[r,t]=d.useState(!1),[s,a]=d.useState("general"),n=At();d.useEffect(()=>{const h=cn(n.pathname);a(h)},[n.pathname]),d.useEffect(()=>{function h(f){f.target.tagName==="INPUT"||f.target.tagName==="TEXTAREA"||f.target.isContentEditable||((f.key==="?"||f.key==="F1")&&(f.preventDefault(),t(y=>!y)),f.key==="Escape"&&r&&t(!1))}return window.addEventListener("keydown",h),()=>window.removeEventListener("keydown",h)},[r]);const o=d.useCallback((h=null)=>{h&&a(h),t(!0)},[]),c=d.useCallback(()=>{t(!1)},[]),l=d.useCallback(()=>{t(h=>!h)},[]),u=d.useCallback(h=>{a(h)},[]),m={isOpen:r,currentTopic:s,openHelp:o,closeHelp:c,toggleHelp:l,navigateToTopic:u};return e.jsx(Dr.Provider,{value:m,children:i})}function Ir(){const i=d.useContext(Dr);if(!i)throw new Error("useHelp must be used within a HelpProvider");return i}function un(i,r,t={}){const s=[{text:"What do I need to do?",category:"actions"},{text:"What's the project status?",category:"overview"}],a=hn(i,r),n=mn(r,t),o=[...a,...n,...s],c=new Set;return o.filter(l=>{const u=l.text.toLowerCase();return c.has(u)?!1:(c.add(u),!0)}).slice(0,5)}function hn(i,r){const t=i.toLowerCase().replace(/\/+$/,"");if(t==="/dashboard"||t==="")return[{text:"What milestones are at risk?",category:"milestones"},{text:"Show budget status",category:"budget"},{text:"What's overdue?",category:"overview"}];if(t==="/milestones"||t.startsWith("/milestones/"))return[{text:"Which milestones are at risk?",category:"milestones"},{text:"What milestones are due this month?",category:"milestones"},{text:"Show milestone progress summary",category:"milestones"},{text:"List overdue milestones",category:"milestones"}];if(t==="/deliverables")return[{text:"What deliverables are awaiting review?",category:"deliverables"},{text:"Show overdue deliverables",category:"deliverables"},{text:"List deliverables by milestone",category:"deliverables"},{text:"What's the deliverable completion rate?",category:"deliverables"}];if(t==="/timesheets"){const s=[{text:"Show my timesheets this month",category:"timesheets"},{text:"How many hours have I logged?",category:"timesheets"},{text:"Show timesheets pending validation",category:"timesheets"}];return["admin","supplier_pm","customer_pm"].includes(r)&&(s.push({text:"Show all submitted timesheets",category:"timesheets"}),s.push({text:"Hours by resource this month",category:"timesheets"})),s}if(t==="/expenses"){const s=[{text:"Show my expenses this month",category:"expenses"},{text:"What expenses are pending validation?",category:"expenses"}];return["admin","supplier_pm"].includes(r)&&(s.push({text:"Show all submitted expenses",category:"expenses"}),s.push({text:"Expenses by category",category:"expenses"}),s.push({text:"Total chargeable expenses",category:"expenses"})),s}return t==="/resources"||t.startsWith("/resources/")?[{text:"Show resource utilization",category:"resources"},{text:"Who's working on what?",category:"resources"},{text:"List resources by partner",category:"resources"}]:t==="/partners"||t.startsWith("/partners/")?[{text:"Show partner spend breakdown",category:"partners"},{text:"List active partners",category:"partners"},{text:"Partner hours this month",category:"partners"}]:t==="/kpis"||t.startsWith("/kpis/")?[{text:"Which KPIs are at risk?",category:"kpis"},{text:"Show KPI trends",category:"kpis"},{text:"KPI summary by status",category:"kpis"}]:t==="/raid"?[{text:"Show open risks",category:"raid"},{text:"What issues need attention?",category:"raid"},{text:"List high-priority risks",category:"raid"},{text:"Show assumptions that need validation",category:"raid"}]:t==="/quality-standards"||t.startsWith("/quality-standards/")?[{text:"Which quality standards need attention?",category:"quality"},{text:"Show quality compliance summary",category:"quality"}]:t==="/gantt"?[{text:"Show critical path",category:"timeline"},{text:"What's the project timeline?",category:"timeline"},{text:"List upcoming milestones",category:"milestones"}]:t==="/workflow-summary"?[{text:"What needs my approval?",category:"workflow"},{text:"Show pending submissions",category:"workflow"},{text:"List items awaiting validation",category:"workflow"}]:[{text:"What's the budget status?",category:"budget"},{text:"Show project overview",category:"overview"}]}function mn(i,r={}){switch(i){case"admin":case"supplier_pm":return[{text:"What needs validation?",category:"workflow"},{text:"Show budget vs actual spend",category:"budget"},{text:"Resource utilization this month",category:"resources"}];case"customer_pm":return[{text:"What deliverables need review?",category:"deliverables"},{text:"Show milestone status",category:"milestones"},{text:"What's pending my approval?",category:"workflow"}];case"contributor":return[{text:"Show my pending timesheets",category:"timesheets"},{text:"My tasks this week",category:"tasks"},{text:"What have I submitted?",category:"workflow"}];case"viewer":default:return[{text:"Project overview",category:"overview"},{text:"Show dashboard summary",category:"overview"}]}}function pn(i){if(!i)return!1;const r=i.toLowerCase();return[/this (week|month|quarter|year)/i,/last (week|month|quarter|year)/i,/(january|february|march|april|may|june|july|august|september|october|november|december)/i,/q[1-4]/i,/\d{4}/,/past \d+ (day|week|month)/i,/(from|between|since|until|before|after)/i,/when|date|period|time(frame|line)?/i].some(s=>s.test(r))}function er(i){if(!i)return null;const r=i.toLowerCase().trim(),t=new Date;t.setHours(0,0,0,0);const s=w=>{const k=new Date(w),S=k.getDay(),v=k.getDate()-S+(S===0?-6:1);return k.setDate(v),k},a=w=>new Date(w.getFullYear(),w.getMonth(),1),n=w=>new Date(w.getFullYear(),w.getMonth()+1,0),o=w=>{const k=Math.floor(w.getMonth()/3);return new Date(w.getFullYear(),k*3,1)},c=w=>{const k=Math.floor(w.getMonth()/3);return new Date(w.getFullYear(),(k+1)*3,0)},l=w=>new Date(w.getFullYear(),0,1),u=w=>new Date(w.getFullYear(),11,31);if(/^today$/i.test(r))return{start:t,end:t,label:"Today"};if(/^yesterday$/i.test(r)){const w=new Date(t);return w.setDate(w.getDate()-1),{start:w,end:w,label:"Yesterday"}}if(/^this week$/i.test(r)){const w=s(t),k=new Date(w);return k.setDate(k.getDate()+6),{start:w,end:k,label:"This Week"}}if(/^last week$/i.test(r)){const w=s(t),k=new Date(w);k.setDate(k.getDate()-7);const S=new Date(k);return S.setDate(S.getDate()+6),{start:k,end:S,label:"Last Week"}}if(/^this month$/i.test(r))return{start:a(t),end:n(t),label:"This Month"};if(/^last month$/i.test(r)){const w=new Date(t.getFullYear(),t.getMonth()-1,1);return{start:a(w),end:n(w),label:"Last Month"}}const m=r.match(/^(?:past|last)\s+(\d+)\s+(day|days|week|weeks|month|months)$/i);if(m){const w=parseInt(m[1],10),k=m[2].toLowerCase(),S=new Date(t);return k.startsWith("day")?S.setDate(S.getDate()-w):k.startsWith("week")?S.setDate(S.getDate()-w*7):k.startsWith("month")&&S.setMonth(S.getMonth()-w),{start:S,end:t,label:`Past ${w} ${k}`}}if(/^this quarter$/i.test(r))return{start:o(t),end:c(t),label:"This Quarter"};if(/^last quarter$/i.test(r)){const w=new Date(t);return w.setMonth(w.getMonth()-3),{start:o(w),end:c(w),label:"Last Quarter"}}const h=r.match(/^q([1-4])$/i);if(h){const w=parseInt(h[1],10)-1,k=t.getFullYear(),S=new Date(k,w*3,1),v=new Date(k,(w+1)*3,0);return{start:S,end:v,label:`Q${w+1} ${k}`}}const f=r.match(/^q([1-4])\s*(\d{4})$/i);if(f){const w=parseInt(f[1],10)-1,k=parseInt(f[2],10),S=new Date(k,w*3,1),v=new Date(k,(w+1)*3,0);return{start:S,end:v,label:`Q${w+1} ${k}`}}if(/^this year$/i.test(r))return{start:l(t),end:u(t),label:"This Year"};if(/^last year$/i.test(r)){const w=new Date(t.getFullYear()-1,0,1);return{start:l(w),end:u(w),label:"Last Year"}}if(/^(year to date|ytd)$/i.test(r))return{start:l(t),end:t,label:"Year to Date"};const y=["january","february","march","april","may","june","july","august","september","october","november","december"],b=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"],p=r.match(/^(january|february|march|april|may|june|july|august|september|october|november|december|jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)\s*(\d{4})?$/i);if(p){const w=p[1].toLowerCase();let k=y.indexOf(w);if(k===-1&&(k=b.indexOf(w.substring(0,3))),k!==-1){const S=p[2]?parseInt(p[2],10):t.getFullYear(),v=new Date(S,k,1),E=n(v),C=y[k].charAt(0).toUpperCase()+y[k].slice(1);return{start:v,end:E,label:p[2]?`${C} ${S}`:C}}}const _=r.match(/^(20\d{2})$/);if(_){const w=parseInt(_[1],10);return{start:new Date(w,0,1),end:new Date(w,11,31),label:String(w)}}return null}function fn(i,r){if(!i||!r)return"";const t=s=>s.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"});return i.toDateString()===r.toDateString()?t(i):i.getMonth()===r.getMonth()&&i.getFullYear()===r.getFullYear()?`${i.getDate()} - ${t(r)}`:`${t(i)} - ${t(r)}`}function gn(){const i=new Date,r=Math.floor(i.getMonth()/3)+1,t=i.toLocaleDateString("en-GB",{month:"long"});return[{text:"today",description:"Just today"},{text:"yesterday",description:"Yesterday only"},{text:"this week",description:"Current week (Mon-Sun)"},{text:"last week",description:"Previous week"},{text:"this month",description:t},{text:"last month",description:"Previous month"},{text:"past 7 days",description:"Last 7 days"},{text:"past 30 days",description:"Last 30 days"},{text:"past 2 weeks",description:"Last 14 days"},{text:"this quarter",description:`Q${r} ${i.getFullYear()}`},{text:"last quarter",description:`Q${r>1?r-1:4}`},{text:"year to date",description:"Jan 1 to today"},{text:"this year",description:`${i.getFullYear()}`},{text:"last year",description:`${i.getFullYear()-1}`}]}function yn(){const i=At(),{role:r}=ye();if(i.pathname==="/chat")return null;const{isOpen:t,toggleChat:s,messages:a,isLoading:n,isLoadingContext:o,error:c,retryCount:l,tokenUsage:u,sendMessage:m,clearChat:h,cancelRequest:f,dismissError:y,downloadChat:b,copyMessage:p}=Ka(),[_,w]=d.useState(""),[k,S]=d.useState(null),[v,E]=d.useState(!1),[C,R]=d.useState(!1),[D,N]=d.useState(!0),[I,j]=d.useState({start:"",end:""}),P=d.useRef(null),B=d.useRef(null),ee=d.useRef(null),K=d.useMemo(()=>un(i.pathname,r),[i.pathname,r]),re=d.useMemo(()=>_.length>5&&pn(_),[_]);d.useEffect(()=>{P.current?.scrollIntoView({behavior:"smooth"})},[a]),d.useEffect(()=>{t&&setTimeout(()=>B.current?.focus(),100)},[t]),d.useEffect(()=>{if(k!==null){const T=setTimeout(()=>S(null),2e3);return()=>clearTimeout(T)}},[k]),d.useEffect(()=>{function T(W){ee.current&&!ee.current.contains(W.target)&&R(!1)}return document.addEventListener("mousedown",T),()=>document.removeEventListener("mousedown",T)},[]),d.useEffect(()=>{a.length>0&&N(!1)},[a.length]);const fe=T=>{if(T.preventDefault(),_.trim()&&!n){er(_.trim());let W=_;I.start&&I.end&&(W=`${_} (from ${I.start} to ${I.end})`,j({start:"",end:""})),m(W),w(""),R(!1)}},Ce=T=>{T.key==="Enter"&&!T.shiftKey&&(T.preventDefault(),fe(T))},O=async(T,W)=>{await p(T)&&S(W)},Y=T=>{w(T),B.current?.focus()},me=T=>{const W=er(T);W&&(j({start:W.start.toISOString().split("T")[0],end:W.end.toISOString().split("T")[0]}),_.trim()&&w(`${_.trim()} ${T}`),R(!1))},ne={role:"assistant",content:`Hello! I'm your Project Assistant. I can query your project data and help you understand what's happening. Try asking:

â€¢ **"What do I need to do?"** - See your pending actions
â€¢ **"Show my timesheets this month"** - Query your time entries
â€¢ **"What milestones are at risk?"** - Check project progress
â€¢ **"What's the budget status?"** - View spend vs forecast

ðŸ’¡ **Tip:** I understand natural dates like "last month", "Q3", or "past 2 weeks"

All data is scoped to your role, so just ask naturally!`},M=a.length===0?[ne]:a,X=(u.input*.25/1e6+u.output*1.25/1e6).toFixed(4),Ae=gn();return e.jsxs(e.Fragment,{children:[e.jsx("button",{className:`chat-toggle-btn ${t?"chat-open":""}`,onClick:s,"aria-label":t?"Close chat":"Open AI assistant",children:t?e.jsx(ue,{size:24}):e.jsxs(e.Fragment,{children:[e.jsx(Rs,{size:24}),e.jsx(Ps,{className:"chat-sparkle",size:12})]})}),e.jsxs("div",{className:`chat-panel ${t?"chat-panel-open":""}`,children:[e.jsxs("div",{className:"chat-header",children:[e.jsxs("div",{className:"chat-header-title",children:[e.jsx(ft,{size:20}),e.jsx("span",{children:"Project Assistant"})]}),e.jsxs("div",{className:"chat-header-actions",children:[a.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"chat-action-btn",onClick:b,title:"Export chat as Markdown",children:e.jsx(Ns,{size:16})}),e.jsx("button",{className:"chat-action-btn",onClick:h,title:"Clear chat",children:e.jsx(As,{size:16})})]}),e.jsx("button",{className:"chat-close-btn",onClick:s,"aria-label":"Close chat",children:e.jsx(ue,{size:20})})]})]}),(a.length===0||D)&&K.length>0&&e.jsxs("div",{className:"chat-suggestions",children:[e.jsxs("div",{className:"chat-suggestions-header",children:[e.jsx(lr,{size:14}),e.jsx("span",{children:"Try asking:"})]}),e.jsx("div",{className:"chat-suggestions-list",children:K.map((T,W)=>e.jsx("button",{className:"chat-suggestion-btn",onClick:()=>Y(T.text),children:T.text},W))})]}),e.jsxs("div",{className:"chat-messages",children:[M.map((T,W)=>e.jsxs("div",{className:`chat-message ${T.role==="user"?"chat-message-user":"chat-message-assistant"} ${T.streaming?"chat-message-streaming":""}`,children:[e.jsx("div",{className:"chat-message-avatar",children:T.role==="user"?e.jsx(Ds,{size:16}):e.jsx(ft,{size:16})}),e.jsxs("div",{className:"chat-message-content",children:[e.jsx(bn,{content:T.content}),e.jsxs("div",{className:"chat-message-actions",children:[T.local&&e.jsx("span",{className:"chat-local-indicator",title:"Instant response from cached data",children:e.jsx(Bt,{size:12})}),T.toolsUsed&&e.jsx("span",{className:"chat-tools-indicator",title:"Queried project data",children:e.jsx(Is,{size:12})}),e.jsx("button",{className:"chat-copy-btn",onClick:()=>O(T.content,W),title:k===W?"Copied!":"Copy message",children:k===W?e.jsx(Ne,{size:12,className:"chat-copy-success"}):e.jsx(Ms,{size:12})})]})]})]},W)),n&&e.jsxs("div",{className:"chat-message chat-message-assistant",children:[e.jsx("div",{className:"chat-message-avatar",children:e.jsx(ft,{size:16})}),e.jsxs("div",{className:"chat-message-content chat-typing",children:[l>0?e.jsxs(e.Fragment,{children:[e.jsx(Se,{className:"chat-typing-icon",size:16}),e.jsxs("span",{children:["Retrying (",l,"/2)..."]})]}):e.jsxs(e.Fragment,{children:[e.jsx(Vt,{className:"chat-typing-icon",size:16}),e.jsx("span",{children:"Querying data..."})]}),e.jsx("button",{className:"chat-cancel-btn",onClick:f,title:"Cancel request",children:e.jsx(or,{size:14})})]})]}),c&&e.jsxs("div",{className:"chat-error",children:[e.jsx("span",{children:c}),e.jsx("button",{className:"chat-error-dismiss",onClick:y,title:"Dismiss",children:e.jsx(ue,{size:14})})]}),e.jsx("div",{ref:P})]}),C&&e.jsxs("div",{className:"chat-date-picker",ref:ee,children:[e.jsxs("div",{className:"chat-date-picker-header",children:[e.jsx(Ke,{size:14}),e.jsx("span",{children:"Select Date Range"}),e.jsx("button",{onClick:()=>R(!1),children:e.jsx(ue,{size:14})})]}),e.jsx("div",{className:"chat-date-quick",children:Ae.slice(0,8).map((T,W)=>e.jsx("button",{className:"chat-date-quick-btn",onClick:()=>me(T.text),children:T.text},W))}),e.jsxs("div",{className:"chat-date-custom",children:[e.jsxs("div",{className:"chat-date-field",children:[e.jsx("label",{children:"From"}),e.jsx("input",{type:"date",value:I.start,onChange:T=>j(W=>({...W,start:T.target.value}))})]}),e.jsxs("div",{className:"chat-date-field",children:[e.jsx("label",{children:"To"}),e.jsx("input",{type:"date",value:I.end,onChange:T=>j(W=>({...W,end:T.target.value}))})]})]}),I.start&&I.end&&e.jsxs("div",{className:"chat-date-preview",children:["Selected: ",fn(new Date(I.start),new Date(I.end))]})]}),e.jsxs("form",{className:"chat-input-form",onSubmit:fe,children:[re&&!C&&e.jsxs("div",{className:"chat-date-hint",onClick:()=>R(!0),children:[e.jsx(Ke,{size:12}),e.jsx("span",{children:"Add date range"})]}),e.jsxs("div",{className:"chat-input-wrapper",children:[e.jsx("button",{type:"button",className:`chat-date-toggle ${C?"active":""}`,onClick:()=>R(!C),title:"Select date range",children:e.jsx(Ke,{size:16})}),e.jsx("textarea",{ref:B,className:"chat-input",value:_,onChange:T=>w(T.target.value),onKeyDown:Ce,placeholder:"Ask about your project...",rows:1,disabled:n}),e.jsx("button",{type:"submit",className:"chat-send-btn",disabled:!_.trim()||n,"aria-label":"Send message",children:e.jsx(cr,{size:18})})]})]}),e.jsxs("div",{className:"chat-footer",children:[e.jsx("button",{className:"chat-stats-toggle",onClick:()=>E(!v),title:"Toggle usage stats",children:e.jsx(Ts,{size:12})}),v?e.jsxs("div",{className:"chat-stats",children:[e.jsxs("span",{title:"Total requests",children:[u.requests," req"]}),e.jsx("span",{className:"chat-stats-divider",children:"â€¢"}),e.jsxs("span",{title:"Input tokens",children:[u.input.toLocaleString()," in"]}),e.jsx("span",{className:"chat-stats-divider",children:"â€¢"}),e.jsxs("span",{title:"Output tokens",children:[u.output.toLocaleString()," out"]}),e.jsx("span",{className:"chat-stats-divider",children:"â€¢"}),e.jsxs("span",{title:"Estimated cost",children:["$",X]})]}):o?e.jsxs("span",{className:"chat-context-loading",children:[e.jsx(Vt,{size:12,className:"chat-context-spinner"}),"Loading context..."]}):e.jsxs("span",{className:"chat-context-ready",title:"Project data pre-loaded for faster responses",children:[e.jsx(Bt,{size:12}),"Powered by Claude AI"]})]})]})]})}function bn({content:i}){const r=i.split(`
`);return e.jsx("div",{className:"chat-message-text",children:r.map((t,s)=>{if(t.startsWith("â€¢ ")||t.startsWith("- ")){const a=t.substring(2);return e.jsxs("div",{className:"chat-bullet",children:[e.jsx("span",{className:"chat-bullet-dot",children:"â€¢"}),e.jsx("span",{dangerouslySetInnerHTML:{__html:tr(a)}})]},s)}return t.trim()===""?e.jsx("div",{className:"chat-line-break"},s):e.jsx("p",{dangerouslySetInnerHTML:{__html:tr(t)}},s)})})}function tr(i){return i.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>")}const Rt={dashboard:{title:"Dashboard",icon:hr,description:"Your command centre showing project KPIs, financial metrics, and progress at a glance.",sections:[{heading:"Available Widgets",type:"list",content:["Project Progress - Overall completion ring","Budget Summary - Spend vs budget","PMO Tracking - Cost breakdown","Key Statistics - Counts and metrics","Timesheets - Hours submitted and validated","Expenses - Amounts awaiting validation","Milestones List - All milestones with progress"]},{heading:"Customising Your Dashboard",type:"list",content:['Click "Customise" in the top-right corner',"Drag widgets to rearrange them","Resize widgets from their corners","Your layout saves automatically",'Click "Reset to Default" to restore']}],tips:["Your dashboard layout is saved to your account","Widgets update automatically as data changes","Data shown is specific to your current project"],relatedTopics:["milestones","timesheets","expenses","projectSwitcher"]},projectSwitcher:{title:"Project Switching",icon:ur,description:"Switch between projects you have access to. Each project has separate data and you may have different roles on different projects.",sections:[{heading:"How Project Access Works",type:"list",content:["You can only see data for projects you are assigned to","Your role may be different on each project","Switching projects changes all data you see","Your selection is remembered when you return"]},{heading:"Switching Projects",type:"list",content:["Click the Project Switcher in the header bar","See all projects you can access","Each shows your role on that project","Click a project to switch to it"]},{heading:"Project-Specific Roles",type:"text",content:"Your role is project-scoped. You might be an Admin on one project and a Contributor on another. When you switch projects, your permissions change accordingly."}],tips:["If you only have one project, the switcher won't appear","Your default project is marked with a badge","The View As feature uses your role on the current project","Ask your admin if you need access to additional projects"],relatedTopics:["users","dashboard","general"]},milestones:{title:"Milestones",icon:Wt,description:"Milestones are the primary billing units. Each represents a major project phase that triggers payment when complete.",sections:[{heading:"Milestone Status",type:"list",content:["Not Started - Work has not begun (0%)","In Progress - Work is underway (1-99%)","Completed - All work finished (100%)"]},{heading:"Financial Structure",type:"list",content:["Baseline - Original contracted amount (locked after commitment)","Forecast - Current projected amount (can be updated)","Actual - Final billable amount (set at delivery)"]},{heading:"Certificate Badges",type:"list",content:["âœ“ Both Signed - Ready for billing","Awaiting Customer - Supplier has signed","Awaiting Supplier - Customer has signed","Pending - Certificate exists, no signatures","â€“ - No certificate yet"]}],tips:["Progress is automatically calculated from deliverables","Click any row to view full milestone details","Both parties must sign before baseline is locked"],relatedTopics:["milestoneDetail","deliverables"]},milestoneDetail:{title:"Milestone Detail",icon:Wt,description:"View and manage individual milestone details, baseline commitment, and acceptance certificates.",sections:[{heading:"Baseline Commitment",type:"text",content:"Before work begins, both Supplier PM and Customer PM must sign to lock the baseline schedule and budget. This creates a formal agreement on the original contract terms."},{heading:"Signing Process",type:"list",content:["Either party can sign first",'Click "Sign as Supplier PM" or "Sign as Customer PM"',"Once both sign, baseline values are locked","Locked baselines cannot be changed"]},{heading:"Acceptance Certificates",type:"text",content:"When milestone reaches 100%, create a certificate for formal acceptance. Supplier signs to confirm delivery, Customer signs to authorise billing."}],tips:["Create the certificate only when all deliverables are complete","The Supplier PM should sign first to confirm delivery","Once both sign, the milestone is ready for invoicing"],relatedTopics:["milestones","deliverables"]},deliverables:{title:"Deliverables",icon:rt,description:"Deliverables are work-level items that contribute to milestone completion. Each is a discrete output like a document, feature, or component.",sections:[{heading:"Workflow Status",type:"list",content:["Not Started - Work has not begun","In Progress - Active work underway","Submitted for Review - Ready for customer review","Returned for More Work - Changes requested","Review Complete - Approved, ready for sign-off","Delivered - Formally accepted"]},{heading:"Status Transitions",type:"list",content:['Progress 0% â†’ automatically sets "Not Started"','Progress 1-99% â†’ automatically sets "In Progress"','"Submit for Review" â†’ sends to customer','Customer accepts â†’ "Review Complete"','Both PMs sign â†’ "Delivered"']}],tips:["Filter by milestone or status using the dropdowns",'Click "Awaiting Review" badge to see items needing review',"Due dates are derived from the parent milestone"],relatedTopics:["milestones","kpis","qualityStandards"]},deliverableDetail:{title:"Deliverable Detail",icon:rt,description:"View and manage individual deliverables, submit for review, and complete the delivery sign-off process.",sections:[{heading:"Edit Permissions",type:"list",content:["Name - Only Supplier PM can edit","Milestone - Only Supplier PM can edit","Description - Supplier PM or Contributor can edit","Progress - Supplier PM or Contributor can edit"]},{heading:"Review Process",type:"list",content:["Complete work and set progress to 100%",'Click "Submit for Review"',"Customer PM reviews the work",'Customer clicks "Accept Review" or "Return for More Work"']},{heading:"Delivery Sign-off",type:"text",content:"Once review is complete, both PMs must sign to formally accept the deliverable. This dual-signature ensures both parties agree the work is done."},{heading:"KPI & Quality Assessment",type:"text",content:"When marking as delivered, you may need to assess linked KPIs and Quality Standards. For each, indicate whether the criteria were met."}],tips:["Fields you cannot edit appear disabled with an explanation","The Supplier PM should sign first to confirm delivery","Once both sign, the deliverable is marked as Delivered"],relatedTopics:["deliverables","milestones"]},resources:{title:"Resources",icon:dr,description:"Manage team members, their allocations, and track utilisation across the project.",sections:[{heading:"Resource Information",type:"list",content:["Name and contact details","Role and partner organisation","Day rate and billing information","Allocation to milestones","Utilisation percentage"]},{heading:"Utilisation",type:"text",content:"Utilisation shows how much of a resource's allocated time has been logged. The progress bar fills based on timesheets submitted."},{heading:"Financial Visibility",type:"text",content:"Cost prices and margins are only visible to Admin and Supplier PM roles. Customer PM sees only sell prices."}],tips:["Click any row to view the full resource detail","Resources can be linked to user accounts for self-service","Filter by type (PMO, Delivery, etc.) using the dropdown"],relatedTopics:["timesheets","partners"]},timesheets:{title:"Timesheets",icon:ge,description:"Track time worked by team members. Submit timesheets for validation and approval.",sections:[{heading:"Status Flow",type:"list",content:["Draft - Saved but not submitted","Submitted - Awaiting validation by PM","Validated - Approved, ready for invoicing","Rejected - Returned with comments"]},{heading:"Filtering Options",type:"list",content:["Quick Select: This Week, Last Week, This Month, Last Month","Month/Year: Select a specific month","Custom Range: Set specific dates","Status: Filter by workflow status"]}],tips:["Use the date filters to find timesheets quickly","Click any row to open the validation modal","Validated timesheets appear on partner invoices"],relatedTopics:["resources","partners"]},expenses:{title:"Expenses",icon:ct,description:"Track and validate expense claims. Mark expenses as chargeable to pass through to customer invoices.",sections:[{heading:"Categories",type:"list",content:["Travel - Flights, trains, taxis, mileage","Accommodation - Hotels, rentals","Sustenance - Meals during work","Equipment - Hardware, software, tools","Materials - Supplies, consumables","Other - Miscellaneous items"]},{heading:"Chargeable Expenses",type:"text",content:'Mark an expense as "Chargeable to Customer" if it should be passed through on invoices. Non-chargeable expenses are internal costs.'},{heading:"AI Receipt Scanning",type:"text",content:"Upload a receipt image and AI will extract the date, amount, category, and description automatically. Review and adjust before saving."}],tips:["Use receipt scanning to save time on data entry","Attach receipt images for audit trail","Chargeable expenses appear on customer invoices"],relatedTopics:["timesheets","partners"]},partners:{title:"Partners",icon:Dt,description:"Manage partner organisations and generate invoices for their work.",sections:[{heading:"Partner Information",type:"list",content:["Contact details and status","Linked resources (team members)","Timesheet history","Expense history"]},{heading:"Invoice Generation",type:"list",content:["Select the billing period (month or custom range)",'Click "Generate Invoice"',"Review the breakdown: Timesheets + Expenses","Save as PDF using your browser's print function"]}],tips:["Toggle partner status inline without opening the detail page","Only validated timesheets appear on invoices","Non-chargeable expenses are shown separately"],relatedTopics:["resources","timesheets","expenses"]},kpis:{title:"Key Performance Indicators",icon:Ls,description:"Track and measure project performance against defined KPIs.",sections:[{heading:"KPI Information",type:"list",content:["Reference and name","Category grouping","Target and current values","Status (On Track, At Risk, Behind)"]},{heading:"Linking to Deliverables",type:"text",content:"KPIs can be linked to deliverables. When a deliverable is marked as delivered, you assess whether linked KPIs were met."}],tips:["Click any row to view full KPI details","Link KPIs to deliverables for tracking","Filter by category using the dropdown"],relatedTopics:["deliverables","qualityStandards"]},qualityStandards:{title:"Quality Standards",icon:Oe,description:"Define and track quality standards that deliverables must meet.",sections:[{heading:"Quality Standard Information",type:"list",content:["Reference and name","Category grouping","Description of criteria","Status tracking"]},{heading:"Linking to Deliverables",type:"text",content:"Quality Standards can be linked to deliverables. When a deliverable is delivered, you assess whether each standard was met."}],tips:["Link Quality Standards when creating deliverables","Assessment results are recorded for audit","Use consistent naming for easier tracking"],relatedTopics:["deliverables","kpis"]},raidLog:{title:"RAID Log",icon:Ue,description:"Track Risks, Assumptions, Issues, and Dependencies for the project.",sections:[{heading:"RAID Types",type:"list",content:["Risks - Potential problems that may occur","Assumptions - Things assumed to be true","Issues - Current problems being addressed","Dependencies - External factors affecting the project"]},{heading:"Priority Levels",type:"list",content:["Critical - Immediate attention required","High - Address soon","Medium - Monitor and plan","Low - Track for awareness"]}],tips:["Use tabs to switch between Risks and Issues","Keep RAID items updated regularly","Close items when resolved"],relatedTopics:["milestones","deliverables"]},users:{title:"User Administration",icon:Os,description:"Manage user accounts, project assignments, and resource links. Admin access required.",sections:[{heading:"User Roles",type:"list",content:["Admin - Full system access","Supplier PM - Manages delivery, validates work","Customer PM - Reviews deliverables, validates work","Contributor - Submits timesheets and expenses","Viewer - Read-only access"]},{heading:"Project-Scoped Roles",type:"text",content:"Roles are now project-specific. A user might be Admin on one project and Contributor on another. Their permissions change based on which project they are viewing."},{heading:"Linking Resources",type:"text",content:'Link users to resources so they can submit timesheets and expenses. Click "Link resource" in the user row.'}],tips:["Test users can be toggled visible/hidden","Users need a linked resource to submit timesheets","Role changes take effect immediately","Users need project assignments to access project data"],relatedTopics:["resources","timesheets","projectSwitcher"]},general:{title:"Getting Help",icon:Fe,description:"Welcome to AMSF001 Project Tracker. Here are some tips to get started.",sections:[{heading:"Navigation",type:"list",content:["Use the left menu to navigate between sections","Click any table row to view details","Use filter dropdowns to find specific items","The AI Chat assistant can answer questions"]},{heading:"Multi-Project Access",type:"list",content:["Use the Project Switcher in the header to change projects","Your role may differ between projects","All data is scoped to your current project","The switcher only appears if you have multiple projects"]},{heading:"Common Actions",type:"list",content:['Create items using the "+ Add" buttons',"Edit items from their detail pages","Submit work for validation using workflow buttons","Sign documents when both parties are ready"]}],tips:["Press ? on any page to open this help panel","Ask the AI Chat assistant for specific information","Contact your administrator if you need role changes","Your project selection is remembered between sessions"],relatedTopics:["dashboard","milestones","deliverables","projectSwitcher"]}};function xn(i){return Rt[i]||Rt.general}function wn(){const{isOpen:i,currentTopic:r,closeHelp:t,navigateToTopic:s}=Ir(),a=xn(r);if(!i)return null;const n=a.icon||jt;return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"help-drawer-backdrop",onClick:t}),e.jsxs("div",{className:"help-drawer",children:[e.jsxs("div",{className:"help-drawer-header",children:[e.jsxs("div",{className:"help-drawer-title",children:[e.jsx(n,{size:20}),e.jsx("span",{children:a.title})]}),e.jsx("button",{className:"help-drawer-close",onClick:t,children:e.jsx(ue,{size:20})})]}),e.jsxs("div",{className:"help-drawer-content",children:[e.jsx("p",{className:"help-description",children:a.description}),a.sections?.map((o,c)=>e.jsxs("div",{className:"help-section",children:[e.jsx("h3",{className:"help-section-heading",children:o.heading}),o.type==="list"?e.jsx("ul",{className:"help-list",children:o.content.map((l,u)=>e.jsx("li",{children:l},u))}):e.jsx("p",{className:"help-text",children:o.content})]},c)),a.tips?.length>0&&e.jsxs("div",{className:"help-tips",children:[e.jsxs("div",{className:"help-tips-header",children:[e.jsx(lr,{size:16}),e.jsx("span",{children:"Tips"})]}),e.jsx("ul",{className:"help-tips-list",children:a.tips.map((o,c)=>e.jsx("li",{children:o},c))})]}),a.relatedTopics?.length>0&&e.jsxs("div",{className:"help-related",children:[e.jsx("h4",{className:"help-related-heading",children:"Related Topics"}),e.jsx("div",{className:"help-related-links",children:a.relatedTopics.map(o=>{const c=Rt[o];if(!c)return null;const l=c.icon||jt;return e.jsxs("button",{className:"help-related-link",onClick:()=>s(o),children:[e.jsx(l,{size:14}),e.jsx("span",{children:c.title}),e.jsx(qs,{size:14})]},o)})})]})]}),e.jsxs("div",{className:"help-drawer-footer",children:[e.jsxs("a",{href:"/AMSF001-User-Guide.md",target:"_blank",rel:"noopener noreferrer",className:"help-full-guide-link",children:[e.jsx(zs,{size:14}),"View Full User Guide"]}),e.jsxs("span",{className:"help-shortcut",children:["Press ",e.jsx("kbd",{children:"?"})," to toggle help"]})]})]})]})}function vn(){const{toggleHelp:i,isOpen:r}=Ir();return e.jsx("button",{className:`help-button ${r?"active":""}`,onClick:i,title:"Help (Press ?)","aria-label":"Open help",children:e.jsx(jt,{size:20})})}function _n(){const[i,r]=d.useState(!1),t=d.useRef(null),s=be(),{notifications:a,unreadCount:n,actionCount:o,loading:c,markAsRead:l,markAsActioned:u,markAllAsRead:m,dismissNotification:h}=Wa();d.useEffect(()=>{function v(E){t.current&&!t.current.contains(E.target)&&r(!1)}return document.addEventListener("mousedown",v),()=>document.removeEventListener("mousedown",v)},[]);const f=v=>{switch(v){case"timesheet":return e.jsx(ge,{size:16});case"expense":return e.jsx(ct,{size:16});case"deliverable":return e.jsx(Fe,{size:16});case"certificate":return e.jsx(Oe,{size:16});default:return e.jsx(gt,{size:16})}},y=v=>v.notification_type==="action"?v.is_actioned?"#10b981":"#f59e0b":"#3b82f6",b=async v=>{v.is_read||await l(v.id),v.action_url&&(s(v.action_url),r(!1))},p=async(v,E)=>{v.stopPropagation(),await u(E.id),E.action_url&&(s(E.action_url),r(!1))},_=async(v,E)=>{v.stopPropagation(),await h(E.id)},w=v=>{const E=new Date(v),R=new Date-E,D=Math.floor(R/6e4),N=Math.floor(R/36e5),I=Math.floor(R/864e5);return D<1?"Just now":D<60?`${D}m ago`:N<24?`${N}h ago`:I<7?`${I}d ago`:E.toLocaleDateString("en-GB",{day:"numeric",month:"short"})},k=a.slice(0,10),S=a.filter(v=>v.notification_type==="action"&&!v.is_actioned);return e.jsxs("div",{className:"notification-bell-container",ref:t,style:{position:"relative"},children:[e.jsxs("button",{onClick:()=>r(!i),style:{position:"relative",background:"none",border:"none",cursor:"pointer",padding:"8px",borderRadius:"8px",display:"flex",alignItems:"center",justifyContent:"center",transition:"background-color 0.2s",backgroundColor:i?"#f1f5f9":"transparent"},onMouseEnter:v=>v.target.style.backgroundColor="#f1f5f9",onMouseLeave:v=>v.target.style.backgroundColor=i?"#f1f5f9":"transparent",title:`${o} actions pending`,children:[e.jsx(gt,{size:22,color:"#64748b"}),(n>0||o>0)&&e.jsx("span",{style:{position:"absolute",top:"2px",right:"2px",backgroundColor:o>0?"#ef4444":"#3b82f6",color:"white",fontSize:"11px",fontWeight:"600",minWidth:"18px",height:"18px",borderRadius:"9px",display:"flex",alignItems:"center",justifyContent:"center",padding:"0 4px"},children:o>0?o:n})]}),i&&e.jsxs("div",{style:{position:"absolute",top:"100%",right:0,marginTop:"8px",width:"380px",maxHeight:"500px",backgroundColor:"white",borderRadius:"12px",boxShadow:"0 10px 40px rgba(0,0,0,0.15)",border:"1px solid #e2e8f0",zIndex:1e3,overflow:"hidden"},children:[e.jsxs("div",{style:{padding:"16px",borderBottom:"1px solid #e2e8f0",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsx("h3",{style:{margin:0,fontSize:"16px",fontWeight:"600"},children:"Notifications"}),o>0&&e.jsxs("p",{style:{margin:"4px 0 0",fontSize:"13px",color:"#f59e0b"},children:[o," action",o!==1?"s":""," required"]})]}),n>0&&e.jsx("button",{onClick:m,style:{background:"none",border:"none",color:"#3b82f6",fontSize:"13px",cursor:"pointer",padding:"4px 8px",borderRadius:"4px"},children:"Mark all read"})]}),S.length>0&&e.jsxs("div",{style:{padding:"12px 16px",backgroundColor:"#fffbeb",borderBottom:"1px solid #fef3c7"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"8px"},children:[e.jsx("div",{style:{width:"8px",height:"8px",borderRadius:"50%",backgroundColor:"#f59e0b",animation:"pulse 2s infinite"}}),e.jsx("span",{style:{fontWeight:"600",fontSize:"13px",color:"#92400e"},children:"Actions Requiring Attention"})]}),e.jsxs("button",{onClick:()=>{s("/workflow-summary"),r(!1)},style:{width:"100%",padding:"8px 12px",backgroundColor:"#f59e0b",color:"white",border:"none",borderRadius:"6px",cursor:"pointer",fontSize:"13px",fontWeight:"500",display:"flex",alignItems:"center",justifyContent:"center",gap:"6px"},children:["View Workflow Summary",e.jsx(Bs,{size:16})]})]}),e.jsx("div",{style:{maxHeight:"350px",overflowY:"auto"},children:c?e.jsx("div",{style:{padding:"32px",textAlign:"center",color:"#64748b"},children:"Loading..."}):k.length===0?e.jsxs("div",{style:{padding:"32px",textAlign:"center",color:"#64748b"},children:[e.jsx(gt,{size:32,style:{marginBottom:"8px",opacity:.5}}),e.jsx("p",{style:{margin:0},children:"No notifications"})]}):k.map(v=>e.jsx("div",{onClick:()=>b(v),style:{padding:"12px 16px",borderBottom:"1px solid #f1f5f9",cursor:"pointer",backgroundColor:v.is_read?"white":"#f8fafc",transition:"background-color 0.15s"},onMouseEnter:E=>E.currentTarget.style.backgroundColor="#f1f5f9",onMouseLeave:E=>E.currentTarget.style.backgroundColor=v.is_read?"white":"#f8fafc",children:e.jsxs("div",{style:{display:"flex",gap:"12px"},children:[e.jsx("div",{style:{width:"36px",height:"36px",borderRadius:"8px",backgroundColor:v.notification_type==="action"&&!v.is_actioned?"#fef3c7":"#f1f5f9",display:"flex",alignItems:"center",justifyContent:"center",color:y(v),flexShrink:0},children:f(v.category)}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",gap:"8px"},children:[e.jsx("span",{style:{fontWeight:v.is_read?"400":"600",fontSize:"14px",color:"#1e293b"},children:v.title}),e.jsx("span",{style:{fontSize:"12px",color:"#94a3b8",flexShrink:0},children:w(v.created_at)})]}),e.jsx("p",{style:{margin:"4px 0 0",fontSize:"13px",color:"#64748b",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:v.message}),e.jsxs("div",{style:{marginTop:"8px",display:"flex",gap:"8px"},children:[v.notification_type==="action"&&!v.is_actioned&&v.action_label&&e.jsx("button",{onClick:E=>p(E,v),style:{padding:"4px 12px",fontSize:"12px",fontWeight:"500",backgroundColor:"#3b82f6",color:"white",border:"none",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",gap:"4px"},children:v.action_label}),v.notification_type==="info"&&e.jsxs("button",{onClick:E=>_(E,v),style:{padding:"4px 8px",fontSize:"12px",backgroundColor:"transparent",color:"#64748b",border:"1px solid #e2e8f0",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",gap:"4px"},children:[e.jsx(ue,{size:12}),"Dismiss"]}),v.is_actioned&&e.jsxs("span",{style:{padding:"4px 8px",fontSize:"12px",color:"#10b981",display:"flex",alignItems:"center",gap:"4px"},children:[e.jsx(Ne,{size:12}),"Completed"]})]})]})]})},v.id))}),a.length>10&&e.jsx("div",{style:{padding:"12px 16px",borderTop:"1px solid #e2e8f0",textAlign:"center"},children:e.jsx("button",{onClick:()=>{s("/workflow-summary"),r(!1)},style:{background:"none",border:"none",color:"#3b82f6",fontSize:"13px",fontWeight:"500",cursor:"pointer"},children:"View all notifications"})})]}),e.jsx("style",{children:`
        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.5; }
        }
      `})]})}function Sn(){const{canUseViewAs:i,isImpersonating:r,effectiveRole:t,actualRole:s,setViewAs:a,clearViewAs:n,availableRoles:o,effectiveRoleConfig:c}=ut();return i?e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.375rem 0.75rem",backgroundColor:r?"#fef3c7":"#f8fafc",borderRadius:"6px",border:r?"1px solid #fcd34d":"1px solid #e2e8f0",fontSize:"0.8125rem",transition:"all 0.15s ease"},children:[e.jsx(st,{size:14,style:{color:r?"#d97706":"#64748b",flexShrink:0}}),e.jsx("span",{style:{color:r?"#92400e":"#64748b",fontWeight:"500",whiteSpace:"nowrap"},children:"View as:"}),e.jsx("select",{value:t,onChange:l=>a(l.target.value),style:{padding:"0.25rem 0.5rem",paddingRight:"1.5rem",border:"none",borderRadius:"4px",backgroundColor:r?c.bg:"white",color:r?c.color:"#374151",fontWeight:"600",fontSize:"0.75rem",cursor:"pointer",outline:"none",appearance:"none",backgroundImage:`url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E")`,backgroundRepeat:"no-repeat",backgroundPosition:"right 0.25rem center",minWidth:"110px"},children:o.map(l=>e.jsxs("option",{value:l.value,style:{fontWeight:l.value===s?"700":"400"},children:[l.label,l.value===s?" (You)":""]},l.value))}),r&&e.jsx("button",{onClick:n,title:"Reset to your actual role",style:{display:"flex",alignItems:"center",justifyContent:"center",padding:"0.25rem",border:"none",borderRadius:"4px",backgroundColor:"transparent",color:"#92400e",cursor:"pointer",transition:"background-color 0.15s ease"},onMouseEnter:l=>l.currentTarget.style.backgroundColor="#fde68a",onMouseLeave:l=>l.currentTarget.style.backgroundColor="transparent",children:e.jsx(It,{size:14})})]}):null}function jn(){const{canUseViewAs:i,isImpersonating:r,effectiveRole:t,effectiveRoleConfig:s}=ut();return!i||!r?null:e.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.125rem 0.375rem",backgroundColor:"#fef3c7",border:"1px solid #fcd34d",borderRadius:"4px",fontSize:"0.65rem",fontWeight:"600",color:"#92400e"},children:[e.jsx(st,{size:10}),"viewing as ",s.label]})}function Cn(){const{currentProject:i,projectRole:r,availableProjects:t,hasMultipleProjects:s,switchProject:a,isLoading:n}=de(),[o,c]=d.useState(!1),l=d.useRef(null);if(d.useEffect(()=>{function h(f){l.current&&!l.current.contains(f.target)&&c(!1)}return document.addEventListener("mousedown",h),()=>document.removeEventListener("mousedown",h)},[]),!s||n)return null;const u=h=>ve[h]||{label:h,shortLabel:h,color:"#64748b",bg:"#f1f5f9"},m=h=>{h!==i?.id&&a(h),c(!1)};return e.jsxs("div",{ref:l,style:{position:"relative"},children:[e.jsxs("button",{onClick:()=>c(!o),style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.5rem 0.75rem",backgroundColor:"#f8fafc",border:"1px solid #e2e8f0",borderRadius:"8px",cursor:"pointer",fontSize:"0.875rem",fontWeight:"500",color:"#334155",transition:"all 0.15s ease",minWidth:"180px",justifyContent:"space-between"},onMouseEnter:h=>{h.currentTarget.style.backgroundColor="#f1f5f9",h.currentTarget.style.borderColor="#cbd5e1"},onMouseLeave:h=>{h.currentTarget.style.backgroundColor="#f8fafc",h.currentTarget.style.borderColor="#e2e8f0"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx(ur,{size:16,style:{color:"#10b981"}}),e.jsx("span",{style:{maxWidth:"120px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:i?.reference||"Select Project"})]}),e.jsx(ir,{size:16,style:{color:"#64748b",transform:o?"rotate(180deg)":"rotate(0)",transition:"transform 0.15s ease"}})]}),o&&e.jsxs("div",{style:{position:"absolute",top:"calc(100% + 4px)",left:0,right:0,minWidth:"280px",backgroundColor:"white",border:"1px solid #e2e8f0",borderRadius:"8px",boxShadow:"0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)",zIndex:100,overflow:"hidden"},children:[e.jsx("div",{style:{padding:"0.75rem 1rem",borderBottom:"1px solid #e2e8f0",backgroundColor:"#f8fafc"},children:e.jsx("div",{style:{fontSize:"0.75rem",fontWeight:"600",color:"#64748b",textTransform:"uppercase",letterSpacing:"0.025em"},children:"Switch Project"})}),e.jsx("div",{style:{maxHeight:"300px",overflowY:"auto"},children:t.map(h=>{const f=h.project,y=f?.id===i?.id,b=u(h.role);return e.jsxs("button",{onClick:()=>m(f?.id),style:{width:"100%",display:"flex",alignItems:"center",justifyContent:"space-between",gap:"0.75rem",padding:"0.75rem 1rem",backgroundColor:y?"#f0fdf4":"white",border:"none",borderBottom:"1px solid #f1f5f9",cursor:"pointer",textAlign:"left",transition:"background-color 0.15s ease"},onMouseEnter:p=>{y||(p.currentTarget.style.backgroundColor="#f8fafc")},onMouseLeave:p=>{p.currentTarget.style.backgroundColor=y?"#f0fdf4":"white"},children:[e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"0.25rem"},children:[e.jsx("span",{style:{fontWeight:"600",fontSize:"0.875rem",color:y?"#10b981":"#1e293b"},children:f?.reference}),h.is_default&&e.jsx("span",{style:{fontSize:"0.6rem",padding:"0.125rem 0.375rem",backgroundColor:"#dbeafe",color:"#1e40af",borderRadius:"4px",fontWeight:"600"},children:"DEFAULT"})]}),e.jsx("div",{style:{fontSize:"0.75rem",color:"#64748b",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:f?.name})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.65rem",padding:"0.125rem 0.5rem",backgroundColor:b.bg,color:b.color,borderRadius:"4px",fontWeight:"600",textTransform:"uppercase",whiteSpace:"nowrap"},children:b.shortLabel}),y&&e.jsx(Ne,{size:16,style:{color:"#10b981"}})]})]},h.id)})})]})]})}function Pt(i,r){return r.includes(i)}function kn(i){return Pt(i,[x.ADMIN,x.SUPPLIER_PM])}function Mr(i){return A(i,"timesheets","create")}function qt(i){return A(i,"timesheets","createForOthers")}function Ye(i){return A(i,"timesheets","approve")}function En(i,r,t,s){if(A(i,"timesheets","createForOthers"))return!0;let a,n,o;return typeof r=="object"&&r!==null?(a=r.status,n=r.created_by||r.resource?.user_id,o=t):(a=r,n=t,o=s),n===o&&(a==="Draft"||a==="Rejected")}function Rn(i,r,t,s){if(A(i,"timesheets","delete"))return!0;let a,n,o;return typeof r=="object"&&r!==null?(a=r.status,n=r.created_by||r.resource?.user_id,o=t):(a=r,n=t,o=s),n===o&&a==="Draft"}function Pn(i,r,t,s){let a,n,o;return typeof r=="object"&&r!==null?(a=r.status,n=r.created_by||r.resource?.user_id,o=t):(a=r,n=t,o=s),a!=="Draft"&&a!=="Rejected"?!1:A(i,"timesheets","createForOthers")?!0:n===o&&A(i,"timesheets","submit")}function Nt(i){return A(i,"expenses","create")}function Tr(i){return A(i,"expenses","createForOthers")}function Or(i){return A(i,"expenses","validateChargeable")}function Lr(i){return A(i,"expenses","validateNonChargeable")}function Nn(i,r,t){let s,a;return typeof r=="object"&&r!==null?(s=r.status,a=r.chargeable||r.chargeable_to_customer):(s=r,a=t),s!=="Submitted"?!1:a?A(i,"expenses","validateChargeable"):A(i,"expenses","validateNonChargeable")}function An(i,r,t,s){if(A(i,"expenses","createForOthers"))return!0;let a,n,o;return typeof r=="object"&&r!==null?(a=r.status,n=r.created_by,o=t):(a=r,n=t,o=s),n===o&&(a==="Draft"||a==="Rejected")}function Dn(i,r,t,s){if(A(i,"expenses","delete"))return!0;let a,n,o;return typeof r=="object"&&r!==null?(a=r.status,n=r.created_by,o=t):(a=r,n=t,o=s),n===o&&a==="Draft"}function qr(i){return A(i,"milestones","create")}function zr(i){return A(i,"milestones","edit")}function Br(i){return A(i,"milestones","delete")}function Vr(i){return A(i,"milestones","useGantt")}function In(i){return A(i,"milestones","editBilling")}function Wr(i){return A(i,"deliverables","create")}function $r(i){return A(i,"deliverables","edit")}function Ur(i){return A(i,"deliverables","delete")}function Fr(i){return A(i,"deliverables","review")}function Mn(i){return A(i,"deliverables","submit")}function Tn(i,r,t){return A(i,"deliverables","edit")?!0:i===x.CONTRIBUTOR?r?.assigned_to===t||r?.resource?.user_id===t:!1}function Hr(i){return A(i,"kpis","manage")}function On(i){return A(i,"kpis","create")}function Ln(i){return A(i,"kpis","edit")}function qn(i){return A(i,"kpis","delete")}function Gr(i){return A(i,"qualityStandards","manage")}function zn(i){return A(i,"qualityStandards","create")}function Bn(i){return A(i,"qualityStandards","edit")}function Vn(i){return A(i,"qualityStandards","delete")}function Kr(i){return A(i,"resources","manage")}function Wn(i){return A(i,"resources","create")}function $n(i){return A(i,"resources","edit")}function Qr(i){return A(i,"resources","delete")}function Yr(i){return A(i,"resources","seeCostPrice")}function Un(i){return A(i,"resources","seeResourceType")}function Jr(i){return A(i,"resources","seeMargins")}function Xr(i){return A(i,"partners","view")}function Zr(i){return A(i,"partners","manage")}function Fn(i){return A(i,"partners","create")}function Hn(i){return A(i,"partners","edit")}function Gn(i){return A(i,"partners","delete")}function Kn(i){return A(i,"variations","create")}function Qn(i){return A(i,"variations","edit")}function Yn(i){return A(i,"variations","delete")}function Jn(i){return A(i,"variations","submit")}function Xn(i){return A(i,"variations","signAsSupplier")}function Zn(i){return A(i,"variations","signAsCustomer")}function ei(i){return A(i,"variations","reject")}function es(i){return A(i,"certificates","signAsSupplier")}function ts(i){return A(i,"certificates","signAsCustomer")}function ti(i){return A(i,"certificates","create")}function rs(i){return A(i,"settings","access")}function ri(i){return A(i,"settings","edit")}function ss(i){return A(i,"users","manage")}function si(i){return A(i,"users","view")}function as(i){return A(i,"reports","viewWorkflowSummary")}function ns(i){return A(i,"invoices","generateCustomer")}function is(i){return A(i,"invoices","generateThirdParty")}function ai(i){return A(i,"invoices","viewMargins")}function ni(i){return A(i,"reports","access")}function os(i,r,t){return!r||!Array.isArray(r)?[]:qt(i)?r:r.filter(s=>s.user_id===t)}function ii(i,r){return!i||!Array.isArray(i)?null:i.find(t=>t.user_id===r)||null}function ls(i,r,t){const s=os(i,r,t);return s.length===0?null:s.find(n=>n.user_id===t)||s[0]}function oi(i,r,t){return ls(i,r,t)?.id||null}function cs(i){return ve[i]||ve[x.VIEWER]}function ds(i){return cs(i).label}function li(i){return{role:i,roleLabel:ds(i),timesheets:{canAdd:Mr(i),canAddForOthers:qt(i),canApprove:Ye(i)},expenses:{canAdd:Nt(i),canAddForOthers:Tr(i),canValidateChargeable:Or(i),canValidateNonChargeable:Lr(i)},milestones:{canCreate:qr(i),canEdit:zr(i),canDelete:Br(i),canUseGantt:Vr(i)},deliverables:{canCreate:Wr(i),canEdit:$r(i),canDelete:Ur(i),canReview:Fr(i)},kpis:{canManage:Hr(i)},qualityStandards:{canManage:Gr(i)},resources:{canManage:Kr(i),canDelete:Qr(i),canSeeCostPrice:Yr(i),canSeeMargins:Jr(i)},partners:{canView:Xr(i),canManage:Zr(i)},certificates:{canSignAsSupplier:es(i),canSignAsCustomer:ts(i)},admin:{canAccessSettings:rs(i),canManageUsers:ss(i),canViewWorkflowSummary:as(i)},invoicing:{canGenerateCustomerInvoice:ns(i),canGenerateThirdPartyInvoice:is(i)}}}const ht={workflowSummary:{id:"workflowSummary",path:"/workflow-summary",icon:Qs,label:"Workflow Summary",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.CONTRIBUTOR],readOnlyRoles:[]},dashboard:{id:"dashboard",path:"/dashboard",icon:hr,label:"Dashboard",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.VIEWER],readOnlyRoles:[x.VIEWER]},reports:{id:"reports",path:"/reports",icon:Fe,label:"Reports",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM],readOnlyRoles:[]},gantt:{id:"gantt",path:"/gantt",icon:Ks,label:"Gantt Chart",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.VIEWER],readOnlyRoles:[x.VIEWER,x.CUSTOMER_PM]},milestones:{id:"milestones",path:"/milestones",icon:mr,label:"Milestones",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.VIEWER],readOnlyRoles:[x.VIEWER]},deliverables:{id:"deliverables",path:"/deliverables",icon:rt,label:"Deliverables",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.CONTRIBUTOR,x.VIEWER],readOnlyRoles:[x.VIEWER]},kpis:{id:"kpis",path:"/kpis",icon:at,label:"KPIs",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.VIEWER],readOnlyRoles:[x.VIEWER,x.CUSTOMER_PM]},qualityStandards:{id:"qualityStandards",path:"/quality-standards",icon:Oe,label:"Quality Standards",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.VIEWER],readOnlyRoles:[x.VIEWER,x.CUSTOMER_PM]},raid:{id:"raid",path:"/raid",icon:Gs,label:"RAID Log",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.VIEWER],readOnlyRoles:[x.VIEWER]},resources:{id:"resources",path:"/resources",icon:dr,label:"Resources",allowedRoles:[x.ADMIN,x.SUPPLIER_PM],readOnlyRoles:[]},timesheets:{id:"timesheets",path:"/timesheets",icon:ge,label:"Timesheets",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.CONTRIBUTOR],readOnlyRoles:[]},expenses:{id:"expenses",path:"/expenses",icon:ct,label:"Expenses",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.CONTRIBUTOR],readOnlyRoles:[]},billing:{id:"billing",path:"/billing",icon:Mt,label:"Billing",allowedRoles:[x.ADMIN,x.SUPPLIER_PM],readOnlyRoles:[]},partners:{id:"partners",path:"/partners",icon:Dt,label:"Partners",allowedRoles:[x.ADMIN,x.SUPPLIER_PM],readOnlyRoles:[]},users:{id:"users",path:"/users",icon:Hs,label:"Users",allowedRoles:[x.ADMIN,x.SUPPLIER_PM],readOnlyRoles:[x.SUPPLIER_PM]},settings:{id:"settings",path:"/settings",icon:Fs,label:"Settings",allowedRoles:[x.ADMIN,x.SUPPLIER_PM],readOnlyRoles:[]},auditLog:{id:"auditLog",path:"/audit-log",icon:Us,label:"Audit Log",allowedRoles:[x.ADMIN,x.SUPPLIER_PM],readOnlyRoles:[]},deletedItems:{id:"deletedItems",path:"/deleted-items",icon:$s,label:"Deleted Items",allowedRoles:[x.ADMIN,x.SUPPLIER_PM],readOnlyRoles:[]},calendar:{id:"calendar",path:"/calendar",icon:Ws,label:"Calendar",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.CONTRIBUTOR,x.VIEWER],readOnlyRoles:[x.VIEWER]},variations:{id:"variations",path:"/variations",icon:Vs,label:"Variations",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM],readOnlyRoles:[x.CUSTOMER_PM]}},it={[x.ADMIN]:["workflowSummary","dashboard","reports","gantt","milestones","deliverables","variations","kpis","qualityStandards","raid","resources","calendar","timesheets","expenses","billing","partners","users","settings","auditLog","deletedItems"],[x.SUPPLIER_PM]:["workflowSummary","dashboard","reports","gantt","milestones","deliverables","variations","kpis","qualityStandards","raid","resources","calendar","timesheets","expenses","billing","partners","users","settings","auditLog","deletedItems"],[x.CUSTOMER_PM]:["workflowSummary","dashboard","reports","gantt","milestones","deliverables","variations","kpis","qualityStandards","raid","calendar","timesheets","expenses"],[x.CONTRIBUTOR]:["workflowSummary","calendar","timesheets","expenses","deliverables"],[x.VIEWER]:["dashboard","gantt","milestones","deliverables","kpis","qualityStandards","raid","calendar"]};function ci(i){return(it[i]||it[x.VIEWER]).map(t=>ht[t]?.path).filter(Boolean)}function us(i){return(it[i]||it[x.VIEWER]).map(t=>ht[t]).filter(t=>t&&t.allowedRoles.includes(i))}function rr(i,r){const t=ht[r];return t?t.readOnlyRoles?.includes(i)||!1:!0}function di(i){return i!==x.VIEWER}function ui(i){return Object.values(ht).find(r=>r.path===i)||null}function hi(i){return ui(i)?.id||null}function mi(i,r){const t=us(i);if(!r||!Array.isArray(r)||r.length===0)return t;const s={};t.forEach(n=>{s[n.path]=n});const a=[];return r.forEach(n=>{s[n]&&(a.push(s[n]),delete s[n])}),Object.values(s).forEach(n=>{a.push(n)}),a}function pi(i,r){if(!r||r.length===0)return!0;const t=ci(i);return r.length!==t.length?!1:r.every((s,a)=>s===t[a])}const sr={[x.ADMIN]:{label:"Administrator",shortLabel:"Admin",color:"#7c3aed",bg:"#f3e8ff",description:"Full system access"},[x.SUPPLIER_PM]:{label:"Supplier PM",shortLabel:"Supplier PM",color:"#059669",bg:"#d1fae5",description:"Manage resources, partners, and invoices"},[x.CUSTOMER_PM]:{label:"Customer PM",shortLabel:"Customer PM",color:"#d97706",bg:"#fef3c7",description:"Approve timesheets and validate expenses"},[x.CONTRIBUTOR]:{label:"Contributor",shortLabel:"Contributor",color:"#2563eb",bg:"#dbeafe",description:"Submit timesheets and expenses"},[x.VIEWER]:{label:"Viewer",shortLabel:"Viewer",color:"#64748b",bg:"#f1f5f9",description:"Read-only access to reports"}};function fi(i){return sr[i]||sr[x.VIEWER]}function gi({children:i}){const r=At(),t=be(),{showSuccess:s,showError:a}=Pr(),{user:n,profile:o,role:c,signOut:l}=ye(),{effectiveRole:u,isImpersonating:m,effectiveRoleConfig:h}=ut(),[f,y]=d.useState(!0),[b,p]=d.useState(null),[_,w]=d.useState(null),[k,S]=d.useState(null),v=d.useRef(null),E=d.useMemo(()=>fi(u),[u]),C=d.useMemo(()=>o&&(o.full_name||o.email||n?.email)||"User",[o,n]),R=d.useMemo(()=>{if(!o)return"U";if(o.full_name){const O=o.full_name.split(" ");return O.length>=2?O[0][0]+O[O.length-1][0]:o.full_name[0].toUpperCase()}return C[0].toUpperCase()},[o,C]);d.useEffect(()=>{o?.nav_order&&Array.isArray(o.nav_order)&&p(o.nav_order)},[o]);async function D(){await l(),t("/login")}const N=d.useMemo(()=>di(u),[u]),I=d.useMemo(()=>b&&!pi(u,b),[u,b]),j=d.useMemo(()=>{const O=us(u);return b&&b.length>0?mi(u,b):O},[u,b]),P=d.useMemo(()=>{const O=hi(r.pathname);return O?rr(u,O):!1},[u,r.pathname]);function B(O,Y){N&&(v.current=O.target,w(Y),setTimeout(()=>{v.current&&(v.current.style.opacity="0.5")},0))}function ee(O,Y){N&&Y!==_&&S(Y)}function K(O){N&&O.preventDefault()}function re(){if(N){if(v.current&&(v.current.style.opacity="1"),_!==null&&k!==null&&_!==k){const O=[...j],Y=O[_];O.splice(_,1),O.splice(k,0,Y);const me=O.map(ne=>ne.path);p(me),fe(me)}w(null),S(null),v.current=null}}async function fe(O){if(n)try{const{error:Y}=await g.from("profiles").update({nav_order:O}).eq("id",n.id);Y&&a("Failed to save menu order")}catch{a("Failed to save menu order")}}async function Ce(){if(n)try{const{error:O}=await g.from("profiles").update({nav_order:null}).eq("id",n.id);if(O){a("Failed to reset menu order");return}p(null),s("Menu order reset to default")}catch{a("Failed to reset menu order")}}return e.jsxs("div",{style:{display:"flex",minHeight:"100vh",backgroundColor:"#f8fafc"},children:[e.jsxs("aside",{style:{width:f?"260px":"70px",backgroundColor:"white",borderRight:"1px solid #e2e8f0",transition:"width 0.3s ease",display:"flex",flexDirection:"column",position:"fixed",height:"100vh",zIndex:50},children:[e.jsxs("div",{style:{padding:"1rem",borderBottom:"1px solid #e2e8f0",display:"flex",alignItems:"center",justifyContent:"space-between"},children:[f&&e.jsxs("div",{children:[e.jsx("h2",{style:{margin:0,fontSize:"1.125rem",fontWeight:"700",color:"#0f172a"},children:"AMSF001"}),e.jsx("span",{style:{fontSize:"0.75rem",color:"#64748b"},children:"Project Tracker"})]}),e.jsx("button",{onClick:()=>y(!f),style:{padding:"0.5rem",borderRadius:"6px",border:"none",backgroundColor:"#f1f5f9",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"},children:f?e.jsx(ue,{size:20}):e.jsx(Ys,{size:20})})]}),e.jsx("nav",{style:{flex:1,padding:"0.5rem",overflowY:"auto"},children:j.map((O,Y)=>{const me=O.icon,ne=r.pathname===O.path||O.path!=="/dashboard"&&r.pathname.startsWith(O.path),M=_===Y,X=k===Y,Ae=rr(u,O.id);return e.jsx("div",{draggable:N,onDragStart:T=>B(T,Y),onDragEnter:T=>ee(T,Y),onDragOver:K,onDragEnd:re,style:{position:"relative",marginBottom:"0.25rem",borderTop:X&&_>Y?"2px solid #10b981":"2px solid transparent",borderBottom:X&&_<Y?"2px solid #10b981":"2px solid transparent",transition:"border-color 0.15s ease"},children:e.jsxs(St,{to:O.path,style:{display:"flex",alignItems:"center",gap:"0.75rem",padding:f?"0.75rem 1rem":"0.75rem",borderRadius:"8px",textDecoration:"none",color:ne?"#10b981":"#64748b",backgroundColor:ne?"#f0fdf4":M?"#f1f5f9":"transparent",fontWeight:ne?"600":"500",justifyContent:f?"flex-start":"center",transition:"all 0.15s ease",cursor:N?"grab":"pointer"},children:[f&&N&&e.jsx(Js,{size:14,style:{color:"#cbd5e1",marginRight:"-0.25rem",flexShrink:0}}),e.jsx(me,{size:20}),f&&e.jsx("span",{style:{flex:1},children:O.label}),f&&Ae&&e.jsx("span",{style:{fontSize:"0.6rem",padding:"0.125rem 0.375rem",backgroundColor:"#f1f5f9",color:"#64748b",borderRadius:"4px",fontWeight:"500"},children:"VIEW"})]})},O.path)})}),f&&N&&I&&e.jsx("div",{style:{padding:"0.5rem 1rem",borderTop:"1px solid #e2e8f0"},children:e.jsxs("button",{onClick:Ce,style:{width:"100%",display:"flex",alignItems:"center",justifyContent:"center",gap:"0.5rem",padding:"0.5rem",backgroundColor:"#f8fafc",color:"#64748b",border:"1px solid #e2e8f0",borderRadius:"6px",cursor:"pointer",fontSize:"0.75rem",fontWeight:"500",transition:"all 0.15s ease"},onMouseEnter:O=>{O.currentTarget.style.backgroundColor="#f1f5f9",O.currentTarget.style.color="#475569"},onMouseLeave:O=>{O.currentTarget.style.backgroundColor="#f8fafc",O.currentTarget.style.color="#64748b"},children:[e.jsx(It,{size:14}),"Reset Menu Order"]})}),e.jsx("div",{style:{padding:"1rem",borderTop:"1px solid #e2e8f0",backgroundColor:"#f8fafc"},children:e.jsxs("button",{onClick:D,style:{width:"100%",display:"flex",alignItems:"center",justifyContent:f?"flex-start":"center",gap:"0.75rem",padding:"0.75rem",backgroundColor:"#fef2f2",color:"#ef4444",border:"none",borderRadius:"8px",cursor:"pointer",fontWeight:"500"},children:[e.jsx(Xs,{size:20}),f&&e.jsx("span",{children:"Logout"})]})})]}),e.jsxs("main",{style:{flex:1,marginLeft:f?"260px":"70px",transition:"margin-left 0.3s ease",minHeight:"100vh",display:"flex",flexDirection:"column"},children:[e.jsxs("header",{style:{padding:"0.75rem 1.5rem",backgroundColor:"white",borderBottom:"1px solid #e2e8f0",display:"flex",justifyContent:"flex-end",alignItems:"center",gap:"1rem",position:"sticky",top:0,zIndex:40},children:[e.jsx(Cn,{}),e.jsx(Sn,{}),e.jsxs(St,{to:"/account",style:{display:"flex",alignItems:"center",gap:"0.75rem",paddingRight:"1rem",borderRight:"1px solid #e2e8f0",textDecoration:"none",cursor:"pointer",borderRadius:"8px",padding:"0.5rem 1rem 0.5rem 0.75rem",marginRight:"0",transition:"background-color 0.15s ease"},onMouseEnter:O=>O.currentTarget.style.backgroundColor="#f8fafc",onMouseLeave:O=>O.currentTarget.style.backgroundColor="transparent",children:[e.jsxs("div",{style:{textAlign:"right"},children:[e.jsxs("div",{style:{fontWeight:"600",fontSize:"0.875rem",color:"#1e293b"},children:[C,m&&e.jsx(jn,{})]}),e.jsx("span",{style:{display:"inline-block",padding:"0.125rem 0.5rem",backgroundColor:E.bg,color:E.color,borderRadius:"4px",fontSize:"0.65rem",fontWeight:"600",textTransform:"uppercase",letterSpacing:"0.025em"},children:E.shortLabel})]}),e.jsx("div",{style:{width:"36px",height:"36px",borderRadius:"50%",backgroundColor:E.color,display:"flex",alignItems:"center",justifyContent:"center",color:"white",fontWeight:"600",fontSize:"0.8rem"},children:R})]}),e.jsx(_n,{})]}),P&&e.jsxs("div",{style:{padding:"0.5rem 1.5rem",backgroundColor:"#f1f5f9",borderBottom:"1px solid #e2e8f0",display:"flex",alignItems:"center",gap:"0.5rem",fontSize:"0.875rem",color:"#64748b"},children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",y1:"16",x2:"12",y2:"12"}),e.jsx("line",{x1:"12",y1:"8",x2:"12.01",y2:"8"})]}),e.jsx("span",{children:"You have read-only access to this page"})]}),e.jsx("div",{style:{flex:1},children:i})]})]})}const hs={minLength:12};function yi(i){const r={length:i.length>=hs.minLength,uppercase:/[A-Z]/.test(i),lowercase:/[a-z]/.test(i),number:/[0-9]/.test(i),special:/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(i)},t=Object.values(r).every(Boolean);let s="weak";const a=Object.values(r).filter(Boolean).length;return a>=3&&(s="fair"),a>=4&&i.length>=14&&(s="good"),a===5&&i.length>=16&&(s="strong"),{checks:r,allPassed:t,strength:s}}function bi({onSuccess:i,userEmail:r}){const[t,s]=d.useState(""),[a,n]=d.useState(""),[o,c]=d.useState(!1),[l,u]=d.useState(!1),[m,h]=d.useState(!1),[f,y]=d.useState(null),b=yi(t),p=t===a&&t.length>0,_={weak:"#ef4444",fair:"#f59e0b",good:"#22c55e",strong:"#059669"},w={weak:"Weak",fair:"Fair",good:"Good",strong:"Strong"};async function k(S){if(S.preventDefault(),!b.allPassed){y("Please meet all password requirements");return}if(!p){y("Passwords do not match");return}h(!0),y(null);try{const{error:v}=await g.auth.updateUser({password:t});if(v)throw v;const{data:{user:E}}=await g.auth.getUser();if(E){const{error:C}=await g.from("profiles").update({must_change_password:!1,updated_at:new Date().toISOString()}).eq("id",E.id)}i&&i()}catch(v){y(v.message||"Failed to update password")}finally{h(!1)}}return e.jsx("div",{className:"auth-container",children:e.jsxs("div",{className:"auth-box",style:{maxWidth:"440px"},children:[e.jsxs("div",{className:"auth-logo",children:[e.jsx(Zs,{size:40,style:{color:"var(--primary)",marginBottom:"0.5rem"}}),e.jsx("h1",{className:"auth-title",children:"Set Your Password"}),e.jsx("p",{className:"auth-subtitle",children:"For security, please create a strong password before continuing"})]}),r&&e.jsxs("div",{style:{padding:"0.75rem",background:"#f1f5f9",borderRadius:"0.5rem",marginBottom:"1.5rem",textAlign:"center",fontSize:"0.875rem",color:"#475569"},children:["Logged in as: ",e.jsx("strong",{children:r})]}),e.jsxs("form",{onSubmit:k,children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",htmlFor:"password",children:"New Password"}),e.jsxs("div",{style:{position:"relative"},children:[e.jsx("input",{id:"password",className:"form-input",type:o?"text":"password",placeholder:"Enter new password",value:t,onChange:S=>s(S.target.value),style:{paddingRight:"2.5rem"},required:!0}),e.jsx("button",{type:"button",onClick:()=>c(!o),style:{position:"absolute",right:"0.75rem",top:"50%",transform:"translateY(-50%)",background:"none",border:"none",cursor:"pointer",color:"#64748b",padding:"0.25rem"},children:o?e.jsx($t,{size:18}):e.jsx(st,{size:18})})]})]}),t.length>0&&e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.75rem",color:"#64748b"},children:"Password Strength"}),e.jsx("span",{style:{fontSize:"0.75rem",fontWeight:"600",color:_[b.strength]},children:w[b.strength]})]}),e.jsx("div",{style:{height:"4px",background:"#e2e8f0",borderRadius:"2px",overflow:"hidden"},children:e.jsx("div",{style:{height:"100%",width:b.strength==="weak"?"25%":b.strength==="fair"?"50%":b.strength==="good"?"75%":"100%",background:_[b.strength],transition:"all 0.3s ease"}})})]}),e.jsxs("div",{style:{background:"#f8fafc",borderRadius:"0.5rem",padding:"0.75rem",marginBottom:"1rem"},children:[e.jsx("div",{style:{fontSize:"0.75rem",color:"#64748b",marginBottom:"0.5rem"},children:"Password Requirements:"}),[{key:"length",label:`At least ${hs.minLength} characters`},{key:"uppercase",label:"One uppercase letter (A-Z)"},{key:"lowercase",label:"One lowercase letter (a-z)"},{key:"number",label:"One number (0-9)"},{key:"special",label:"One special character (!@#$%...)"}].map(({key:S,label:v})=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",fontSize:"0.8rem",color:b.checks[S]?"#059669":"#94a3b8",marginBottom:"0.25rem"},children:[b.checks[S]?e.jsx(Ne,{size:14,style:{color:"#059669"}}):e.jsx(ue,{size:14,style:{color:"#cbd5e1"}}),v]},S))]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",htmlFor:"confirmPassword",children:"Confirm Password"}),e.jsxs("div",{style:{position:"relative"},children:[e.jsx("input",{id:"confirmPassword",className:"form-input",type:l?"text":"password",placeholder:"Confirm new password",value:a,onChange:S=>n(S.target.value),style:{paddingRight:"2.5rem",borderColor:a.length>0?p?"#22c55e":"#ef4444":void 0},required:!0}),e.jsx("button",{type:"button",onClick:()=>u(!l),style:{position:"absolute",right:"0.75rem",top:"50%",transform:"translateY(-50%)",background:"none",border:"none",cursor:"pointer",color:"#64748b",padding:"0.25rem"},children:l?e.jsx($t,{size:18}):e.jsx(st,{size:18})})]}),a.length>0&&!p&&e.jsxs("div",{style:{fontSize:"0.75rem",color:"#ef4444",marginTop:"0.25rem",display:"flex",alignItems:"center",gap:"0.25rem"},children:[e.jsx(ue,{size:12})," Passwords do not match"]}),p&&e.jsxs("div",{style:{fontSize:"0.75rem",color:"#22c55e",marginTop:"0.25rem",display:"flex",alignItems:"center",gap:"0.25rem"},children:[e.jsx(Ne,{size:12})," Passwords match"]})]}),f&&e.jsxs("div",{style:{padding:"0.75rem",background:"#fee2e2",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#991b1b"},children:[e.jsx(Qe,{size:20}),e.jsx("span",{style:{fontSize:"0.875rem"},children:f})]}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:m||!b.allPassed||!p,style:{width:"100%",justifyContent:"center",opacity:!b.allPassed||!p?.5:1},children:m?"Updating...":"Set Password & Continue"})]}),e.jsx("div",{style:{marginTop:"1.5rem",paddingTop:"1rem",borderTop:"1px solid #e2e8f0",textAlign:"center",fontSize:"0.75rem",color:"#94a3b8"},children:"This password will be used to access your account. Choose something memorable but secure."})]})})}function xi(){const i=be(),[r]=vs(),[t,s]=d.useState(!1),[a,n]=d.useState(""),[o,c]=d.useState(""),[l,u]=d.useState(null),[m,h]=d.useState(null),[f,y]=d.useState(!1),[b,p]=d.useState(!1),[_,w]=d.useState(!1),[k,S]=d.useState(!1);d.useEffect(()=>{r.get("expired")==="true"&&(S(!0),window.history.replaceState({},document.title,"/login")),g.auth.getSession().then(({data:{session:N}})=>{N&&i("/dashboard",{replace:!0})});const{data:{subscription:D}}=g.auth.onAuthStateChange((N,I)=>{N==="SIGNED_IN"&&I&&i("/dashboard",{replace:!0})});return()=>D.unsubscribe()},[i,r]);const v=async D=>{D.preventDefault(),s(!0),u(null),h(null),S(!1);try{if(f){const{error:N}=await g.auth.signUp({email:a,password:o,options:{data:{full_name:a.split("@")[0]}}});if(N)throw N;h("Check your email for confirmation link!")}else{const{error:N}=await g.auth.signInWithPassword({email:a,password:o});if(N)throw N}}catch(N){u(N.message)}finally{s(!1)}},E=async D=>{if(D.preventDefault(),!a){u("Please enter your email address");return}s(!0),u(null),h(null);try{const{error:N}=await g.auth.resetPasswordForEmail(a,{redirectTo:`${window.location.origin}/reset-password`});if(N)throw N;h("Password reset email sent! Check your inbox.")}catch(N){u(N.message)}finally{s(!1)}},C=async D=>{if(D.preventDefault(),!a){u("Please enter your email address");return}s(!0),u(null),h(null);try{const{error:N}=await g.auth.resend({type:"signup",email:a});if(N)throw N;h("Verification email resent! Check your inbox.")}catch(N){u(N.message)}finally{s(!1)}},R=()=>{p(!1),w(!1),u(null),h(null),S(!1)};return b?e.jsx("div",{className:"auth-container",children:e.jsxs("div",{className:"auth-box",children:[e.jsxs("div",{className:"auth-logo",children:[e.jsx(ea,{size:40,style:{color:"var(--primary)",marginBottom:"0.5rem"}}),e.jsx("h1",{className:"auth-title",children:"Reset Password"}),e.jsx("p",{className:"auth-subtitle",children:"Enter your email to receive a reset link"})]}),e.jsxs("form",{onSubmit:E,children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",htmlFor:"email",children:"Email Address"}),e.jsx("input",{id:"email",className:"form-input",type:"email",placeholder:"you@example.com",value:a,onChange:D=>n(D.target.value),required:!0})]}),l&&e.jsxs("div",{style:{padding:"0.75rem",background:"#fee2e2",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#991b1b"},children:[e.jsx(Qe,{size:20}),e.jsx("span",{style:{fontSize:"0.875rem"},children:l})]}),m&&e.jsxs("div",{style:{padding:"0.75rem",background:"#dcfce7",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#166534"},children:[e.jsx(yt,{size:20}),e.jsx("span",{style:{fontSize:"0.875rem"},children:m})]}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:t,style:{width:"100%",justifyContent:"center"},children:t?"Sending...":"Send Reset Link"})]}),e.jsx("div",{style:{marginTop:"1.5rem",textAlign:"center"},children:e.jsx("button",{onClick:R,style:{background:"none",border:"none",color:"var(--primary)",cursor:"pointer",fontSize:"0.875rem"},children:"â† Back to Sign In"})})]})}):_?e.jsx("div",{className:"auth-container",children:e.jsxs("div",{className:"auth-box",children:[e.jsxs("div",{className:"auth-logo",children:[e.jsx(Se,{size:40,style:{color:"var(--primary)",marginBottom:"0.5rem"}}),e.jsx("h1",{className:"auth-title",children:"Resend Verification"}),e.jsx("p",{className:"auth-subtitle",children:"Enter your email to resend the verification link"})]}),e.jsxs("form",{onSubmit:C,children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",htmlFor:"email",children:"Email Address"}),e.jsx("input",{id:"email",className:"form-input",type:"email",placeholder:"you@example.com",value:a,onChange:D=>n(D.target.value),required:!0})]}),l&&e.jsxs("div",{style:{padding:"0.75rem",background:"#fee2e2",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#991b1b"},children:[e.jsx(Qe,{size:20}),e.jsx("span",{style:{fontSize:"0.875rem"},children:l})]}),m&&e.jsxs("div",{style:{padding:"0.75rem",background:"#dcfce7",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#166534"},children:[e.jsx(yt,{size:20}),e.jsx("span",{style:{fontSize:"0.875rem"},children:m})]}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:t,style:{width:"100%",justifyContent:"center"},children:t?"Sending...":"Resend Verification Email"})]}),e.jsx("div",{style:{marginTop:"1.5rem",textAlign:"center"},children:e.jsx("button",{onClick:R,style:{background:"none",border:"none",color:"var(--primary)",cursor:"pointer",fontSize:"0.875rem"},children:"â† Back to Sign In"})})]})}):e.jsx("div",{className:"auth-container",children:e.jsxs("div",{className:"auth-box",children:[e.jsxs("div",{className:"auth-logo",children:[e.jsx("h1",{className:"auth-title",children:"AMSF001 Tracker"}),e.jsx("p",{className:"auth-subtitle",children:"Network Architecture Services Project"})]}),k&&e.jsxs("div",{style:{padding:"0.75rem",background:"#fef3c7",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#92400e",border:"1px solid #fcd34d"},children:[e.jsx(ge,{size:20}),e.jsx("span",{style:{fontSize:"0.875rem"},children:"Your session has expired. Please sign in again."})]}),e.jsxs("form",{onSubmit:v,children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",htmlFor:"email",children:"Email Address"}),e.jsx("input",{id:"email",className:"form-input",type:"email",placeholder:"you@example.com",value:a,onChange:D=>n(D.target.value),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",htmlFor:"password",children:"Password"}),e.jsx("input",{id:"password",className:"form-input",type:"password",placeholder:"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢",value:o,onChange:D=>c(D.target.value),required:!0})]}),l&&e.jsxs("div",{style:{padding:"0.75rem",background:"#fee2e2",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#991b1b"},children:[e.jsx(Qe,{size:20}),e.jsx("span",{style:{fontSize:"0.875rem"},children:l})]}),m&&e.jsxs("div",{style:{padding:"0.75rem",background:"#dcfce7",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#166534"},children:[e.jsx(yt,{size:20}),e.jsx("span",{style:{fontSize:"0.875rem"},children:m})]}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:t,style:{width:"100%",justifyContent:"center"},children:t?"Loading...":f?"Sign Up":"Sign In"})]}),!f&&e.jsx("div",{style:{marginTop:"1rem",textAlign:"center"},children:e.jsx("button",{onClick:()=>{p(!0),u(null),h(null),S(!1)},style:{background:"none",border:"none",color:"#64748b",cursor:"pointer",fontSize:"0.85rem",textDecoration:"underline"},children:"Forgot your password?"})}),e.jsx("div",{style:{marginTop:"1rem",textAlign:"center"},children:e.jsx("button",{onClick:()=>{y(!f),u(null),h(null),S(!1)},style:{background:"none",border:"none",color:"var(--primary)",cursor:"pointer",fontSize:"0.875rem"},children:f?"Already have an account? Sign In":"Don't have an account? Sign Up"})}),e.jsxs("div",{style:{marginTop:"1.5rem",paddingTop:"1rem",borderTop:"1px solid #e2e8f0",textAlign:"center"},children:[e.jsx("p",{style:{fontSize:"0.8rem",color:"#64748b",marginBottom:"0.5rem"},children:"Haven't received your verification email?"}),e.jsxs("button",{onClick:()=>{w(!0),u(null),h(null),S(!1)},style:{background:"none",border:"none",color:"var(--primary)",cursor:"pointer",fontSize:"0.85rem",display:"inline-flex",alignItems:"center",gap:"0.25rem"},children:[e.jsx(Se,{size:14})," Resend Verification Email"]})]})]})})}const wi={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function vi(i){return i==null?"":typeof i!="string"?String(i):i.replace(/[&<>"'`=\/]/g,r=>wi[r])}function zt(i,r={}){const{maxLength:t=1e4,trim:s=!0,normalizeWhitespace:a=!0}=r;if(i==null)return"";typeof i!="string"&&(i=String(i));let n=i;return n=n.replace(/\0/g,""),n=n.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,""),s&&(n=n.trim()),a&&(n=n.replace(/[ \t]+/g," ")),n.length>t&&(n=n.substring(0,t)),n}function ot(i,r=255){return i==null?"":(typeof i!="string"&&(i=String(i)),zt(i,{maxLength:r}).replace(/[\r\n]/g," ").replace(/\s+/g," ").trim())}function ms(i,r=1e4){return i==null?"":(typeof i!="string"&&(i=String(i)),zt(i,{maxLength:r,normalizeWhitespace:!1}).replace(/\r\n/g,`
`).replace(/\r/g,`
`).replace(/\n{3,}/g,`

`).trim())}function ps(i){return i?ot(i,254).toLowerCase():""}function mt(i,r={}){const{min:t=-1/0,max:s=1/0,decimals:a=2}=r;if(i==null||i==="")return null;let n=String(i).replace(/[^0-9.\-]/g,""),o=parseFloat(n);return isNaN(o)?null:(o=Math.max(t,Math.min(s,o)),o=Math.round(o*Math.pow(10,a))/Math.pow(10,a),o)}function _i(i){const r=mt(i,{min:0,decimals:2});return r!==null?Math.round(r*100)/100:null}function Si(i){const r=mt(i,{min:0,max:24,decimals:1});return r===null?null:Math.round(r*2)/2}function ji(i){return mt(i,{min:0,max:100,decimals:1})}function Ci(i){if(!i)return null;const r=String(i).trim();return/^(javascript|data|vbscript):/i.test(r)?null:/^(https?:\/\/|\/|#)/i.test(r)?r:`https://${r}`}function ki(i,r={}){if(!i||typeof i!="object")return i;const t={...i};for(const[s,a]of Object.entries(r)){if(t[s]===void 0)continue;const{type:n="text",maxLength:o}=a;switch(n){case"singleLine":t[s]=ot(t[s],o);break;case"multiLine":t[s]=ms(t[s],o);break;case"email":t[s]=ps(t[s]);break;case"number":t[s]=mt(t[s],a);break;case"currency":t[s]=_i(t[s]);break;case"hours":t[s]=Si(t[s]);break;case"percentage":t[s]=ji(t[s]);break;case"url":t[s]=Ci(t[s]);break;case"html":t[s]=vi(t[s]);break;default:t[s]=zt(t[s],{maxLength:o})}}return t}const Ei={timesheet:{description:{type:"multiLine",maxLength:2e3},hours_worked:{type:"hours"}},expense:{reason:{type:"multiLine",maxLength:2e3},amount:{type:"currency"}},resource:{name:{type:"singleLine",maxLength:100},email:{type:"email"},role:{type:"singleLine",maxLength:100},notes:{type:"multiLine",maxLength:5e3}},partner:{name:{type:"singleLine",maxLength:200},contact_name:{type:"singleLine",maxLength:100},contact_email:{type:"email"},notes:{type:"multiLine",maxLength:5e3}},milestone:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3}},deliverable:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3}},kpi:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3},target_value:{type:"number",decimals:2},actual_value:{type:"number",decimals:2}},qualityStandard:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3},target_value:{type:"percentage"}}};function ar(i,r){const t=Ei[i];return t?ki(r,t):r}class he{constructor(r,t={}){this.tableName=r,this.supportsSoftDelete=t.supportsSoftDelete!==!1,this.sanitizeConfig=t.sanitizeConfig||null}getSoftDeleteFilter(){return this.supportsSoftDelete?"is_deleted.is.null,is_deleted.eq.false":null}async getAll(r,t={}){try{let s=t.select||"*";const a=this.supportsSoftDelete&&!t.includeDeleted;a&&s!=="*"&&!s.includes("is_deleted")&&(s=`${s}, is_deleted`);let n=g.from(this.tableName).select(s).eq("project_id",r);t.filters&&Array.isArray(t.filters)&&t.filters.forEach(u=>{const{column:m,operator:h,value:f}=u;switch(h){case"eq":n=n.eq(m,f);break;case"neq":n=n.neq(m,f);break;case"gt":n=n.gt(m,f);break;case"gte":n=n.gte(m,f);break;case"lt":n=n.lt(m,f);break;case"lte":n=n.lte(m,f);break;case"like":n=n.like(m,f);break;case"ilike":n=n.ilike(m,f);break;case"in":n=n.in(m,f);break;case"is":n=n.is(m,f);break;default:n=n.eq(m,f)}}),t.orderBy&&(n=n.order(t.orderBy.column,{ascending:t.orderBy.ascending??!0}));const{data:o,error:c}=await n;if(c)throw c;let l=o||[];return a&&(l=l.filter(u=>u.is_deleted!==!0)),l}catch(s){throw s}}async getDeleted(r){if(!this.supportsSoftDelete)return[];try{const{data:t,error:s}=await g.from(this.tableName).select("*").eq("project_id",r).eq("is_deleted",!0).order("deleted_at",{ascending:!1});if(s)throw s;return t||[]}catch(t){throw t}}async getById(r,t={}){try{let s=t.select||"*";const a=this.supportsSoftDelete&&!t.includeDeleted;a&&s!=="*"&&!s.includes("is_deleted")&&(s=`${s}, is_deleted`);let n=g.from(this.tableName).select(s).eq("id",r);const{data:o,error:c}=await n.limit(1);if(c)throw c;const l=o&&o.length>0?o[0]:null;return l&&a&&l.is_deleted===!0?null:l}catch(s){throw s}}async create(r){try{if(!r.project_id)throw new Error("project_id is required");let t=r;this.sanitizeConfig&&(t=ar(this.sanitizeConfig,r)),this.supportsSoftDelete&&(delete t.is_deleted,delete t.deleted_at,delete t.deleted_by);const{data:s,error:a}=await g.from(this.tableName).insert(t).select();if(a)throw a;if(!s||s.length===0)throw new Error("Failed to create record - no data returned");return s[0]}catch(t){throw t}}async update(r,t){try{let s=t;this.sanitizeConfig&&(s=ar(this.sanitizeConfig,t));const a={...s,updated_at:new Date().toISOString()};delete a.is_deleted,delete a.deleted_at,delete a.deleted_by;const{data:n,error:o}=await g.from(this.tableName).update(a).eq("id",r).select();if(o)throw o;if(!n||n.length===0)throw new Error(`No record found with id: ${r}`);return n[0]}catch(s){throw s}}async delete(r,t=null){try{if(this.supportsSoftDelete){const{error:s}=await g.from(this.tableName).update({is_deleted:!0,deleted_at:new Date().toISOString(),deleted_by:t}).eq("id",r);if(s)throw s}else{const{error:s}=await g.from(this.tableName).delete().eq("id",r);if(s)throw s}return!0}catch(s){throw s}}async hardDelete(r){try{const{error:t}=await g.from(this.tableName).delete().eq("id",r);if(t)throw t;return!0}catch(t){throw t}}async restore(r){if(!this.supportsSoftDelete)throw new Error("This entity does not support soft delete");try{const{data:t,error:s}=await g.from(this.tableName).update({is_deleted:!1,deleted_at:null,deleted_by:null}).eq("id",r).select();if(s)throw s;if(!t||t.length===0)throw new Error(`No record found with id: ${r}`);return t[0]}catch(t){throw t}}async exists(r){try{const{data:t,error:s}=await g.from(this.tableName).select("id, is_deleted").eq("id",r).limit(1);if(s)throw s;if(!t||t.length===0)return!1;const a=t[0];return!(this.supportsSoftDelete&&a.is_deleted===!0)}catch(t){throw t}}async count(r,t=[]){try{let s=g.from(this.tableName).select("id, is_deleted").eq("project_id",r);t.forEach(c=>{const{column:l,operator:u,value:m}=c;u==="eq"?s=s.eq(l,m):u==="in"&&(s=s.in(l,m))});const{data:a,error:n}=await s;if(n)throw n;let o=a||[];return this.supportsSoftDelete&&(o=o.filter(c=>c.is_deleted!==!0)),o.length}catch(s){throw s}}}const je=new Map,Ri=5*60*1e3,Pi=100;function Je(i,r,t=""){return`${i}:${r}${t?`:${t}`:""}`}function Xe(i){const r=je.get(i);if(!r)return null;const t=Date.now();return t-r.timestamp>r.ttl?(je.delete(i),null):(r.accessCount++,r.lastAccess=t,r.data)}function Ze(i,r,t=Ri){je.size>=Pi&&Ni(),je.set(i,{data:r,timestamp:Date.now(),ttl:t,accessCount:1,lastAccess:Date.now()})}function _e(i){for(const r of je.keys())r.startsWith(`${i}:`)&&je.delete(r)}function Ni(){const i=Array.from(je.entries()).sort((t,s)=>t[1].lastAccess-s[1].lastAccess),r=Math.ceil(i.length*.2);for(let t=0;t<r;t++)je.delete(i[t][0])}const et={LONG:15*60*1e3},Ee="partners";class Ai extends he{constructor(){super("partners")}async getAll(r,t=!1){const s=Je(Ee,r,"all");if(!t){const n=Xe(s);if(n)return n}const a=await super.getAll(r,{orderBy:{column:"name",ascending:!0}});return Ze(s,a,et.LONG),a}async getActive(r){const t=Je(Ee,r,"active"),s=Xe(t);if(s)return s;const a=await super.getAll(r,{filters:[{column:"is_active",operator:"eq",value:!0}],orderBy:{column:"name",ascending:!0}});return Ze(t,a,et.LONG),a}async getWithResources(r){try{const{data:t,error:s}=await g.from("partners").select(`
          *,
          resources (
            id,
            name,
            sell_price,
            cost_price,
            is_active
          )
        `).eq("id",r).limit(1);if(s)throw s;return t?.[0]||null}catch(t){throw t}}async getSummary(r){try{const{data:t,error:s}=await g.from("partners").select(`
          id,
          name,
          contact_name,
          contact_email,
          payment_terms,
          is_active,
          created_at
        `).eq("project_id",r).order("name",{ascending:!0});if(s)throw s;return t||[]}catch(t){throw t}}async create(r){if(!r.name?.trim())throw new Error("Partner name is required");if(await this.findByName(r.project_id,r.name))throw new Error(`Partner "${r.name}" already exists`);const s=await super.create({...r,name:r.name.trim(),is_active:r.is_active??!0,payment_terms:r.payment_terms||"Net 30"});return _e(Ee),s}async update(r,t){const s=await super.update(r,t);return _e(Ee),s}async delete(r,t=null){const s=await super.delete(r,t);return _e(Ee),s}async findByName(r,t){try{const{data:s,error:a}=await g.from("partners").select("*").eq("project_id",r).ilike("name",t.trim()).limit(1);if(a)throw a;return s?.[0]||null}catch(s){throw s}}async toggleActive(r){const t=await this.getById(r);if(!t)throw new Error("Partner not found");const s=await this.update(r,{is_active:!t.is_active});return _e(Ee),s}async getForSelect(r,t=!0){const s=Je(Ee,r,`select-${t}`),a=Xe(s);if(a)return a;const o=(t?await this.getActive(r):await this.getAll(r)).map(c=>({value:c.id,label:c.name}));return Ze(s,o,et.LONG),o}async getDependencyCounts(r){try{const{data:t,error:s}=await g.from("resources").select("id").eq("partner_id",r).or("is_deleted.is.null,is_deleted.eq.false");if(s)throw s;const a=t?.map(u=>u.id)||[];let n=0,o=0;if(a.length>0){const{count:u,error:m}=await g.from("timesheets").select("*",{count:"exact",head:!0}).in("resource_id",a).or("is_deleted.is.null,is_deleted.eq.false");if(m)throw m;n=u||0;const{count:h,error:f}=await g.from("expenses").select("*",{count:"exact",head:!0}).in("resource_id",a).or("is_deleted.is.null,is_deleted.eq.false");if(f)throw f;o=h||0}const{count:c,error:l}=await g.from("partner_invoices").select("*",{count:"exact",head:!0}).eq("partner_id",r).or("is_deleted.is.null,is_deleted.eq.false");if(l)throw l;return{resourceCount:t?.length||0,timesheetCount:n,expenseCount:o,invoiceCount:c||0,canDelete:!t?.length&&!c}}catch(t){throw t}}}const Bo=new Ai,Be="resources";class Di extends he{constructor(){super("resources",{sanitizeConfig:"resource",supportsSoftDelete:!0})}sanitizeData(r){const t={...r};return t.name&&(t.name=ot(t.name,100)),t.role&&(t.role=ot(t.role,100)),t.email&&(t.email=ps(t.email)),t.notes&&(t.notes=ms(t.notes,5e3)),t}async getAll(r,t={}){const{includePartner:s=!0,activeOnly:a=!1,showTestUsers:n=!0,includeDeleted:o=!1}=t;let c="*";s&&(c="*, partner:partners(id, name, is_active)");let l=g.from(this.tableName).select(c).eq("project_id",r).order("name");o||(l=l.or("is_deleted.is.null,is_deleted.eq.false")),a&&(l=l.eq("is_active",!0)),n||(l=l.or("is_test_content.is.null,is_test_content.eq.false"));const{data:u,error:m}=await l;if(m)throw m;return u||[]}async getAllFiltered(r,t=!0){return this.getAll(r,{showTestUsers:t,includePartner:!0})}async getById(r){const{data:t,error:s}=await g.from(this.tableName).select("*, partner:partners(id, name, contact_name, contact_email, is_active)").eq("id",r).or("is_deleted.is.null,is_deleted.eq.false").single();if(s)throw s;return t}async getByType(r,t){const{data:s,error:a}=await g.from(this.tableName).select("*, partner:partners(id, name)").eq("project_id",r).eq("resource_type",t).or("is_deleted.is.null,is_deleted.eq.false").order("name");if(a)throw a;return s||[]}async getByPartner(r){const{data:t,error:s}=await g.from(this.tableName).select("*").eq("partner_id",r).or("is_deleted.is.null,is_deleted.eq.false").order("name");if(s)throw s;return t||[]}async getWithTimesheetSummary(r){const t=await this.getById(r);if(!t)return null;const{data:s,error:a}=await g.from("timesheets").select("id, hours_worked, hours, status, was_rejected, date").eq("resource_id",r).or("is_deleted.is.null,is_deleted.eq.false");let n=0,o=0,c=0;return s&&s.forEach(l=>{const u=parseFloat(l.hours_worked||l.hours||0);n+=u,l.status==="Approved"?o+=u:l.status==="Submitted"&&!l.was_rejected&&(c+=u)}),{...t,timesheetSummary:{totalEntries:s?.length||0,totalHours:n,approvedHours:o,pendingHours:c,daysWorked:qe(n)}}}async create(r){const t=this.sanitizeData(r);if(!t.name?.trim())throw new Error("Resource name is required");if(!t.project_id)throw new Error("Project ID is required");if(!t.email?.trim())throw new Error("Email is required");t.resource_type==="internal"&&(t.partner_id=null);const{data:s,error:a}=await g.from(this.tableName).insert([t]).select("*, partner:partners(id, name)").single();if(a)throw a;return _e(Be),s}async update(r,t){const s=this.sanitizeData(t);s.resource_type==="internal"&&(s.partner_id=null),s.updated_at=new Date().toISOString();const{data:a,error:n}=await g.from(this.tableName).update(s).eq("id",r).select("*, partner:partners(id, name)").single();if(n)throw n;return _e(Be),a}async delete(r,t=null){const{data:s,error:a}=await g.from(this.tableName).update({is_deleted:!0,deleted_at:new Date().toISOString(),deleted_by:t}).eq("id",r).select().single();if(a)throw a;return _e(Be),s}async restore(r){const{data:t,error:s}=await g.from(this.tableName).update({is_deleted:!1,deleted_at:null,deleted_by:null}).eq("id",r).select().single();if(s)throw s;return _e(Be),t}async linkToPartner(r,t){const s={partner_id:t,resource_type:t?"third_party":"internal",updated_at:new Date().toISOString()};return this.update(r,s)}async toggleActive(r){const t=await this.getById(r);if(!t)throw new Error("Resource not found");return this.update(r,{is_active:!t.is_active})}async getForSelect(r){const t=Je(Be,r,"select"),s=Xe(t);if(s)return s;const{data:a,error:n}=await g.from(this.tableName).select("id, name, resource_type, role").eq("project_id",r).or("is_deleted.is.null,is_deleted.eq.false").order("name");if(n)throw n;const o=a||[];return Ze(t,o,et.LONG),o}calculateMargin(r,t){if(!r||r===0||!t)return{percent:null,amount:null,status:"unknown"};const s=(r-t)/r*100,a=r-t;let n="critical";return s>=25?n="good":s>=10&&(n="low"),{percent:s,amount:a,status:n}}async getUtilization(r){const t=await this.getWithTimesheetSummary(r);if(!t)return null;const s=t.days_allocated||0,a=t.timesheetSummary.daysWorked,n=Math.max(0,s-a),o=s>0?a/s*100:0;return{resourceId:r,resourceName:t.name,daysAllocated:s,daysUsed:a,remaining:n,utilizationPercent:o,totalValue:(t.sell_price||0)*s,valueUsed:(t.sell_price||0)*a}}async getSummary(r){const t=await this.getAll(r,{includePartner:!1});return{total:t.length,internal:t.filter(s=>s.resource_type==="internal").length,thirdParty:t.filter(s=>s.resource_type==="third_party").length,active:t.filter(s=>s.is_active).length,totalBudget:t.reduce((s,a)=>s+(a.sell_price||0)*(a.days_allocated||0),0)}}async getProfileByEmail(r){try{const{data:t,error:s}=await this.supabase.from("profiles").select("id, email, full_name, role").eq("email",r).single();if(s){if(s.code==="PGRST116")return null;throw s}return t}catch(t){throw t}}async getAllWithTestFilter(r,t=[]){try{const s=await this.getAll(r,{orderBy:{column:"name",ascending:!0}});return t&&t.length>0?s.filter(a=>!a.user_id||!t.includes(a.user_id)):s}catch(s){throw s}}async getDependencyCounts(r){try{const[t,s]=await Promise.all([this.supabase.from("timesheets").select("id",{count:"exact",head:!0}).eq("resource_id",r).or("is_deleted.is.null,is_deleted.eq.false"),this.supabase.from("expenses").select("id",{count:"exact",head:!0}).eq("resource_id",r).or("is_deleted.is.null,is_deleted.eq.false")]);return{timesheetCount:t.count||0,expenseCount:s.count||0,canDelete:(t.count||0)===0&&(s.count||0)===0}}catch(t){throw t}}}const Vo=new Di;class Ii extends he{constructor(){super("timesheets",{supportsSoftDelete:!0,sanitizeConfig:"timesheet"})}async getAll(r,t={}){return super.getAll(r,{...t,select:t.select||`
      *,
      resources(id, name, email, sell_price, cost_price),
      milestones(id, milestone_ref, name)
    `,orderBy:t.orderBy||{column:"date",ascending:!1}})}async getAllFiltered(r,t=!1){try{let s=g.from(this.tableName).select(`
          *,
          resources(id, name, email, sell_price, cost_price),
          milestones(id, milestone_ref, name)
        `).eq("project_id",r).order("date",{ascending:!1});this.supportsSoftDelete&&(s=s.or(this.getSoftDeleteFilter())),t||(s=s.or("is_test_content.is.null,is_test_content.eq.false"));const{data:a,error:n}=await s;if(n)throw n;return a||[]}catch(s){throw s}}async getByResource(r,t={}){try{let s=g.from(this.tableName).select("*, milestones(id, milestone_ref, name)").eq("resource_id",r).order("date",{ascending:!1});this.supportsSoftDelete&&(s=s.or(this.getSoftDeleteFilter())),t.start&&(s=s.gte("date",t.start)),t.end&&(s=s.lte("date",t.end)),t.status&&(s=s.eq("status",t.status));const{data:a,error:n}=await s;if(n)throw n;return a||[]}catch(s){throw s}}async getByPartner(r,t={}){try{const{data:s}=await g.from("resources").select("id, name, cost_price").eq("partner_id",r).or("is_deleted.is.null,is_deleted.eq.false");if(!s||s.length===0)return[];const a=s.map(l=>l.id);let n=g.from(this.tableName).select("*, resources(id, name, cost_price), milestones(id, milestone_ref, name)").in("resource_id",a).order("date",{ascending:!1});this.supportsSoftDelete&&(n=n.or(this.getSoftDeleteFilter())),t.start&&(n=n.gte("date",t.start)),t.end&&(n=n.lte("date",t.end)),t.status&&(n=n.eq("status",t.status));const{data:o,error:c}=await n;if(c)throw c;return o||[]}catch(s){throw s}}async getApprovedForInvoice(r,t){if(!t.start||!t.end)throw new Error("Date range (start and end) is required for invoice queries");return this.getByPartner(r,{...t,status:"Approved"})}async getSummary(r,t={}){try{const s=await this.getAll(r,t),a={totalHours:0,totalDays:0,approvedHours:0,pendingHours:0,draftHours:0,rejectedHours:0,totalCost:0,approvedCost:0,byStatus:{Draft:{count:0,hours:0},Submitted:{count:0,hours:0},Approved:{count:0,hours:0},Rejected:{count:0,hours:0}},byMilestone:{},count:s.length};return s.forEach(n=>{const o=parseFloat(n.hours_worked||n.hours||0),c=n.resources?.cost_price||0,l=Xt(o,c);switch(a.totalHours+=o,a.totalCost+=l,a.byStatus[n.status]&&(a.byStatus[n.status].count++,a.byStatus[n.status].hours+=o),n.status){case"Approved":a.approvedHours+=o,a.approvedCost+=l;break;case"Submitted":n.was_rejected||(a.pendingHours+=o);break;case"Draft":a.draftHours+=o;break;case"Rejected":a.rejectedHours+=o;break}if(n.milestone_id){const u=n.milestones?.milestone_ref||"Unknown";a.byMilestone[n.milestone_id]||(a.byMilestone[n.milestone_id]={ref:u,name:n.milestones?.name||"Unknown",hours:0,cost:0}),a.byMilestone[n.milestone_id].hours+=o,a.byMilestone[n.milestone_id].cost+=l}}),a.totalDays=qe(a.totalHours),a}catch(s){throw s}}async create(r){if(!r.resource_id)throw new Error("resource_id is required");if(!r.date)throw new Error("date is required");const t=parseFloat(r.hours_worked||r.hours||0);if(!t||t<=0)throw new Error("hours must be greater than 0");const s={...r,hours_worked:t,hours:t,date:r.date||r.work_date,work_date:r.work_date||r.date,description:r.description||r.comments||"",comments:r.comments||r.description||"",status:r.status||"Draft"};return super.create(s)}async submit(r){return this.update(r,{status:"Submitted"})}async validate(r){return this.update(r,{status:"Approved"})}async approve(r){return this.validate(r)}async reject(r,t=null){const s={status:"Rejected",was_rejected:!0};return t&&(s.rejection_reason=t),this.update(r,s)}calculateCost(r,t){return Xt(r,t)}calculateBillable(r,t){return Lt(r,t)}}const fs=new Ii;class Mi extends he{constructor(){super("expenses",{supportsSoftDelete:!0,sanitizeConfig:"expense"})}async getAll(r,t={}){return super.getAll(r,{...t,select:t.select||"*, expense_files(*)",orderBy:t.orderBy||{column:"expense_date",ascending:!1}})}async getAllFiltered(r,t=!1){try{let s=g.from(this.tableName).select("*, expense_files(*)").eq("project_id",r).order("expense_date",{ascending:!1});const{data:a,error:n}=await s;if(n)throw n;let o=a||[];return this.supportsSoftDelete&&(o=o.filter(c=>c.is_deleted!==!0)),t||(o=o.filter(c=>c.is_test_content!==!0)),o}catch(s){throw s}}async getByResource(r,t={}){try{let s=g.from(this.tableName).select("*, expense_files(*)").eq("resource_id",r).order("expense_date",{ascending:!1});t.start&&(s=s.gte("expense_date",t.start)),t.end&&(s=s.lte("expense_date",t.end));const{data:a,error:n}=await s;if(n)throw n;let o=a||[];return this.supportsSoftDelete&&(o=o.filter(c=>c.is_deleted!==!0)),o}catch(s){throw s}}async getByPartner(r,t={}){try{const{data:s}=await g.from("resources").select("id").eq("partner_id",r);if(!s||s.length===0)return[];const a=s.map(u=>u.id);let n=g.from(this.tableName).select("*, expense_files(*)").in("resource_id",a).order("expense_date",{ascending:!1});t.start&&(n=n.gte("expense_date",t.start)),t.end&&(n=n.lte("expense_date",t.end)),t.procurementMethod&&(n=n.eq("procurement_method",t.procurementMethod));const{data:o,error:c}=await n;if(c)throw c;let l=o||[];return this.supportsSoftDelete&&(l=l.filter(u=>u.is_deleted!==!0)),l}catch(s){throw s}}async getPartnerProcuredForInvoice(r,t){if(!t.start||!t.end)throw new Error("Date range (start and end) is required for invoice queries");return this.getByPartner(r,{...t,procurementMethod:"partner"})}async getSummary(r,t={}){try{const s=await this.getAll(r,t),a={total:0,chargeable:0,nonChargeable:0,supplierProcured:0,partnerProcured:0,byCategory:{Travel:0,Accommodation:0,Sustenance:0},byStatus:{Draft:0,Submitted:0,Approved:0,Rejected:0,Paid:0},count:s.length};return s.forEach(n=>{const o=parseFloat(n.amount||0);a.total+=o,n.chargeable_to_customer!==!1?a.chargeable+=o:a.nonChargeable+=o,n.procurement_method==="partner"?a.partnerProcured+=o:a.supplierProcured+=o,a.byCategory[n.category]!==void 0&&(a.byCategory[n.category]+=o),a.byStatus[n.status]!==void 0&&(a.byStatus[n.status]+=o)}),a}catch(s){throw s}}async create(r){if(!r.resource_id)throw new Error("resource_id is required");if(!r.category)throw new Error("category is required");if(!r.amount||r.amount<=0)throw new Error("amount must be greater than 0");const t={...r,status:r.status||"Draft",chargeable_to_customer:r.chargeable_to_customer??!0,procurement_method:r.procurement_method||"supplier"};return super.create(t)}async createMany(r){if(!r||r.length===0)return[];try{const t=r.map(n=>{if(!n.resource_id)throw new Error("resource_id is required for all expenses");if(!n.category)throw new Error("category is required for all expenses");if(!n.amount||n.amount<=0)throw new Error("amount must be greater than 0 for all expenses");return{...n,status:n.status||"Draft",chargeable_to_customer:n.chargeable_to_customer??!0,procurement_method:n.procurement_method||"supplier"}}),{data:s,error:a}=await g.from(this.tableName).insert(t).select();if(a)throw a;return s||[]}catch(t){throw t}}async submit(r){return this.update(r,{status:"Submitted"})}async validate(r){return this.update(r,{status:"Approved"})}async approve(r){return this.validate(r)}async reject(r,t=null){const s={status:"Rejected"};return t&&(s.rejection_reason=t),this.update(r,s)}async markPaid(r){return this.update(r,{status:"Paid"})}async uploadReceipt(r,t,s){try{const a=`${r}/${Date.now()}-${t.name}`,{error:n}=await g.storage.from("receipts").upload(a,t);if(n)throw n;const{data:o,error:c}=await g.from("expense_files").insert({expense_id:r,file_name:t.name,file_path:a,file_size:t.size,file_type:t.type,uploaded_by:s}).select();if(c)throw c;return o?.[0]}catch(a){throw a}}async downloadReceipt(r){try{const{data:t,error:s}=await g.storage.from("receipts").download(r);if(s)throw s;return t}catch(t){throw t}}}const gs=new Mi;class Ti extends he{constructor(){super("partner_invoices")}async getAll(r,t={}){return super.getAll(r,{...t,select:t.select||"*, partners(name)",orderBy:t.orderBy||{column:"invoice_date",ascending:!1}})}async getByPartner(r,t={}){try{let s=g.from(this.tableName).select("*").eq("partner_id",r).order("invoice_date",{ascending:!1});t.status&&(s=s.eq("status",t.status));const{data:a,error:n}=await s;if(n)throw n;return a||[]}catch(s){throw s}}async getWithLines(r){try{const{data:t,error:s}=await g.from(this.tableName).select("*, partners(name, contact_name, contact_email, payment_terms)").eq("id",r).limit(1);if(s)throw s;const a=t?.[0];if(!a)return null;const{data:n,error:o}=await g.from("partner_invoice_lines").select("*").eq("invoice_id",r).order("line_type",{ascending:!0}).order("resource_name",{ascending:!0}).order("line_date",{ascending:!0});if(o)throw o;const c={timesheets:(n||[]).filter(l=>l.line_type==="timesheet"),supplierExpenses:(n||[]).filter(l=>l.line_type==="supplier_expense"),partnerExpenses:(n||[]).filter(l=>l.line_type==="expense")};return{...a,lines:n||[],groupedLines:c}}catch(t){throw t}}async generateInvoiceNumber(r){try{const s=`INV-${new Date().getFullYear()}-`,{data:a,error:n}=await g.from(this.tableName).select("invoice_number").eq("project_id",r).like("invoice_number",`${s}%`).order("invoice_number",{ascending:!1}).limit(1);if(n)throw n;let o=1;if(a&&a.length>0){const c=a[0].invoice_number,l=parseInt(c.replace(s,""),10);isNaN(l)||(o=l+1)}return`${s}${String(o).padStart(3,"0")}`}catch(t){throw t}}async generateInvoice(r){const{projectId:t,partnerId:s,periodStart:a,periodEnd:n,createdBy:o,notes:c,includeSubmitted:l=!0}=r;try{const{data:u,error:m}=await g.from("resources").select("id, name, cost_price").eq("partner_id",s);if(m)throw m;if(!u||u.length===0)throw new Error("No resources linked to this partner");const h=u.map(M=>M.id),f={};u.forEach(M=>{f[M.id]=M});const y=l?["Approved","Submitted"]:["Approved"],{data:b,error:p}=await g.from("timesheets").select("id, date, hours_worked, hours, status, resource_id").in("resource_id",h).gte("date",a).lte("date",n).in("status",y);if(p)throw p;const{data:_,error:w}=await g.from("expenses").select("id, expense_date, category, reason, amount, resource_id, resource_name, procurement_method, chargeable_to_customer, status").in("resource_id",h).gte("expense_date",a).lte("expense_date",n).in("status",["Approved","Submitted","Paid"]);if(w)throw w;const k=(_||[]).filter(M=>M.procurement_method==="partner"||!M.procurement_method),S=(_||[]).filter(M=>M.procurement_method==="supplier");let v=0,E=0;const C=[],R={};(b||[]).forEach(M=>{R[M.resource_id]||(R[M.resource_id]=[]),R[M.resource_id].push(M)}),Object.keys(R).forEach(M=>{const X=f[M];R[M].forEach(T=>{const W=parseFloat(T.hours_worked||T.hours||0),De=X?.cost_price||0,He=qe(W),ze=He*De;v+=ze,E+=ze,C.push({line_type:"timesheet",timesheet_id:T.id,expense_id:null,description:`${X?.name||"Unknown"} - ${W}h (${He.toFixed(2)} days)`,quantity:W,unit_price:De,line_total:ze,resource_name:X?.name,line_date:T.date,hours:W,cost_price:De,source_status:T.status,chargeable_to_customer:!0,procurement_method:null,expense_category:null})})});let D=0,N=0,I=0;const j=[];k.forEach(M=>{const X=parseFloat(M.amount||0);D+=X,M.chargeable_to_customer?N+=X:I+=X,j.push({line_type:"expense",timesheet_id:null,expense_id:M.id,description:`${M.resource_name} - ${M.category}: ${M.reason}`,quantity:1,unit_price:X,line_total:X,resource_name:M.resource_name,line_date:M.expense_date,hours:null,cost_price:null,source_status:M.status,chargeable_to_customer:M.chargeable_to_customer,procurement_method:"partner",expense_category:M.category})});let P=0,B=0,ee=0;const K=[];S.forEach(M=>{const X=parseFloat(M.amount||0);P+=X,M.chargeable_to_customer?B+=X:ee+=X,K.push({line_type:"supplier_expense",timesheet_id:null,expense_id:M.id,description:`${M.resource_name} - ${M.category}: ${M.reason}`,quantity:1,unit_price:X,line_total:X,resource_name:M.resource_name,line_date:M.expense_date,hours:null,cost_price:null,source_status:M.status,chargeable_to_customer:M.chargeable_to_customer,procurement_method:"supplier",expense_category:M.category})});const re=v+D,fe=E+N+B,Ce=I+ee,O=await this.generateInvoiceNumber(t),{data:Y,error:me}=await g.from(this.tableName).insert({project_id:t,partner_id:s,invoice_number:O,invoice_date:new Date().toISOString().split("T")[0],period_start:a,period_end:n,timesheet_total:v,expense_total:D,supplier_expense_total:P,invoice_total:re,chargeable_total:fe,non_chargeable_total:Ce,status:"Draft",notes:c||null,created_by:o}).select().single();if(me)throw me;const ne=[...C,...j,...K].map(M=>({...M,invoice_id:Y.id}));if(ne.length>0){const{error:M}=await g.from("partner_invoice_lines").insert(ne);if(M)throw M}return this.getWithLines(Y.id)}catch(u){throw u}}async updateStatus(r,t){const s={status:t};return t==="Sent"?s.sent_at=new Date().toISOString():t==="Paid"&&(s.paid_at=new Date().toISOString()),this.update(r,s)}async markSent(r){return this.updateStatus(r,"Sent")}async markPaid(r){return this.updateStatus(r,"Paid")}async cancel(r){return this.updateStatus(r,"Cancelled")}async getPartnerStats(r){try{const{data:t,error:s}=await g.from(this.tableName).select("status, invoice_total").eq("partner_id",r);if(s)throw s;const a={total:0,draft:0,sent:0,paid:0,cancelled:0,count:t?.length||0};return(t||[]).forEach(n=>{const o=parseFloat(n.invoice_total||0);switch(a.total+=o,n.status){case"Draft":a.draft+=o;break;case"Sent":a.sent+=o;break;case"Paid":a.paid+=o;break;case"Cancelled":a.cancelled+=o;break}}),a}catch(t){throw t}}}const Wo=new Ti;class Oi extends he{constructor(){super("milestones",{supportsSoftDelete:!0,sanitizeConfig:"milestone"})}async getAllWithStats(r){try{const t=await this.getAll(r,{orderBy:{column:"start_date",ascending:!0}}),{data:s}=await g.from("timesheets").select("milestone_id, hours_worked").eq("project_id",r).not("milestone_id","is",null).or("is_deleted.is.null,is_deleted.eq.false"),a={};return(s||[]).forEach(n=>{a[n.milestone_id]||(a[n.milestone_id]=0),a[n.milestone_id]+=parseFloat(n.hours_worked||0)}),t.map(n=>({...n,logged_hours:a[n.id]||0,logged_days:qe(a[n.id]||0)}))}catch(t){throw t}}async getWithDeliverables(r){try{const{data:t,error:s}=await g.from(this.tableName).select("*").eq("id",r).or(this.getSoftDeleteFilter()).limit(1);if(s)throw s;const a=t?.[0],{data:n,error:o}=await g.from("deliverables").select("*").eq("milestone_id",r).or("is_deleted.is.null,is_deleted.eq.false").order("due_date",{ascending:!0});if(o)throw o;return{...a,deliverables:n||[]}}catch(t){throw t}}async getByStatus(r,t){return this.getAll(r,{filters:[{column:"status",operator:"eq",value:t}],orderBy:{column:"start_date",ascending:!0}})}async getUpcoming(r,t=30){try{const s=new Date().toISOString().split("T")[0],a=new Date;a.setDate(a.getDate()+t);const n=a.toISOString().split("T")[0];let o=g.from(this.tableName).select("*").eq("project_id",r).gte("end_date",s).lte("end_date",n).neq("status","Completed").order("end_date",{ascending:!0});this.supportsSoftDelete&&(o=o.or(this.getSoftDeleteFilter()));const{data:c,error:l}=await o;if(l)throw l;return c||[]}catch(s){throw s}}async updateStatus(r,t){return this.update(r,{status:t})}async updateCompletion(r,t){const s={completion_percentage:t};return t>=100&&(s.status="Completed"),this.update(r,s)}async getSummary(r){try{const t=await this.getAll(r),s={total:t.length,completed:0,inProgress:0,notStarted:0,overdue:0,upcoming:0},a=new Date().toISOString().split("T")[0],n=new Date;n.setDate(n.getDate()+7);const o=n.toISOString().split("T")[0];return t.forEach(c=>{c.status==="Completed"?s.completed++:c.status==="In Progress"?(s.inProgress++,c.end_date<a&&s.overdue++):c.status==="Not Started"&&(s.notStarted++,c.start_date<=o&&s.upcoming++)}),s}catch(t){throw t}}async getCertificates(r){try{const{data:t,error:s}=await g.from("milestone_certificates").select("*").eq("project_id",r).order("created_at",{ascending:!1});if(s)throw s;return t||[]}catch(t){throw t}}async getCertificateByMilestoneId(r){try{const{data:t,error:s}=await g.from("milestone_certificates").select("*").eq("milestone_id",r).limit(1);if(s)throw s;return t?.[0]||null}catch(t){throw t}}async createCertificate(r){try{const{data:t,error:s}=await g.from("milestone_certificates").insert([r]).select();if(s)throw s;return t?.[0]}catch(t){throw t}}async updateCertificate(r,t){try{const{data:s,error:a}=await g.from("milestone_certificates").update(t).eq("id",r).select();if(a)throw a;return s?.[0]}catch(s){throw s}}async signCertificate(r,t,s,a){try{const{data:n,error:o}=await g.from("milestone_certificates").select("*").eq("id",r).limit(1);if(o)throw o;const c=n?.[0];if(!c)throw new Error("Certificate not found");const l=new Date().toISOString(),u={};if(t==="supplier")u.supplier_pm_id=s,u.supplier_pm_name=a,u.supplier_pm_signed_at=l,u.status=c.customer_pm_signed_at?"Signed":"Pending Customer Signature";else if(t==="customer")u.customer_pm_id=s,u.customer_pm_name=a,u.customer_pm_signed_at=l,u.status=c.supplier_pm_signed_at?"Signed":"Pending Supplier Signature";else throw new Error('Invalid signer role. Must be "supplier" or "customer".');const{data:m,error:h}=await g.from("milestone_certificates").update(u).eq("id",r).select();if(h)throw h;return m?.[0]}catch(n){throw n}}async signBaseline(r,t,s,a){try{const n=await this.getById(r);if(!n)throw new Error("Milestone not found");const o=new Date().toISOString(),c={};if(t==="supplier")c.baseline_supplier_pm_id=s,c.baseline_supplier_pm_name=a,c.baseline_supplier_pm_signed_at=o,n.baseline_customer_pm_signed_at&&(c.baseline_locked=!0);else if(t==="customer")c.baseline_customer_pm_id=s,c.baseline_customer_pm_name=a,c.baseline_customer_pm_signed_at=o,n.baseline_supplier_pm_signed_at&&(c.baseline_locked=!0);else throw new Error('Invalid signer role. Must be "supplier" or "customer".');return await this.update(r,c)}catch(n){throw n}}async resetBaseline(r){try{return await this.update(r,{baseline_locked:!1,baseline_supplier_pm_id:null,baseline_supplier_pm_name:null,baseline_supplier_pm_signed_at:null,baseline_customer_pm_id:null,baseline_customer_pm_name:null,baseline_customer_pm_signed_at:null})}catch(t){throw t}}async getBillableMilestones(r){try{const t=await this.getAll(r,{filters:[{column:"billable",operator:"gt",value:0}],orderBy:{column:"milestone_ref",ascending:!0}}),s=t.map(o=>o.id),{data:a}=await g.from("milestone_certificates").select("milestone_id, status").eq("project_id",r),n={};if((a||[]).forEach(o=>{(!n[o.milestone_id]||o.status==="Signed")&&(n[o.milestone_id]=o.status)}),s.length>0){const{data:o}=await g.from("deliverables").select("milestone_id, due_date").in("milestone_id",s).or("is_deleted.is.null,is_deleted.eq.false"),c={};return(o||[]).forEach(l=>{l.due_date&&(!c[l.milestone_id]||l.due_date>c[l.milestone_id])&&(c[l.milestone_id]=l.due_date)}),t.map(l=>({...l,expected_date:c[l.id]||l.forecast_end_date||l.end_date,certificate_status:n[l.id]||null,ready_to_bill:n[l.id]==="Signed"}))}return t.map(o=>({...o,expected_date:o.forecast_end_date||o.end_date,certificate_status:n[o.id]||null,ready_to_bill:n[o.id]==="Signed"}))}catch(t){throw t}}}const Te=new Oi;class Li extends he{constructor(){super("deliverables",{supportsSoftDelete:!0,sanitizeConfig:"deliverable"})}async getAllWithMilestones(r){return this.getAll(r,{select:"*, milestones(name, milestone_ref)",orderBy:{column:"due_date",ascending:!0}})}async getByMilestone(r){try{let t=g.from(this.tableName).select("*").eq("milestone_id",r).order("due_date",{ascending:!0});this.supportsSoftDelete&&(t=t.or(this.getSoftDeleteFilter()));const{data:s,error:a}=await t;if(a)throw a;return s||[]}catch(t){throw t}}async getByStatus(r,t){return this.getAll(r,{filters:[{column:"status",operator:"eq",value:t}],orderBy:{column:"due_date",ascending:!0}})}async getOverdue(r){try{const t=new Date().toISOString().split("T")[0];let s=g.from(this.tableName).select("*, milestones(name)").eq("project_id",r).lt("due_date",t).not("status","in",'("Delivered","Cancelled")').order("due_date",{ascending:!0});this.supportsSoftDelete&&(s=s.or(this.getSoftDeleteFilter()));const{data:a,error:n}=await s;if(n)throw n;return a||[]}catch(t){throw t}}async getUpcoming(r,t=14){try{const s=new Date().toISOString().split("T")[0],a=new Date;a.setDate(a.getDate()+t);const n=a.toISOString().split("T")[0];let o=g.from(this.tableName).select("*, milestones(name)").eq("project_id",r).gte("due_date",s).lte("due_date",n).not("status","eq","Delivered").order("due_date",{ascending:!0});this.supportsSoftDelete&&(o=o.or(this.getSoftDeleteFilter()));const{data:c,error:l}=await o;if(l)throw l;return c||[]}catch(s){throw s}}async updateStatus(r,t,s){const a={status:t};return t==="Submitted"?(a.submitted_date=new Date().toISOString(),a.submitted_by=s):t==="Delivered"&&(a.delivered_date=new Date().toISOString(),a.delivered_by=s),this.update(r,a)}async submit(r,t){return this.updateStatus(r,"Submitted",t)}async markDelivered(r,t){return this.updateStatus(r,"Delivered",t)}async reject(r,t){return this.update(r,{status:"Rejected",rejection_reason:t})}async getSummary(r){try{const t=await this.getAll(r),s=new Date().toISOString().split("T")[0],a={total:t.length,delivered:0,inProgress:0,notStarted:0,overdue:0,dueThisWeek:0},n=new Date;n.setDate(n.getDate()+7);const o=n.toISOString().split("T")[0];return t.forEach(c=>{c.status==="Delivered"?a.delivered++:c.status==="In Progress"?(a.inProgress++,c.due_date<s?a.overdue++:c.due_date<=o&&a.dueThisWeek++):(c.status==="Not Started"||c.status==="Draft")&&(a.notStarted++,c.due_date<s&&a.overdue++)}),a}catch(t){throw t}}async getAllWithRelations(r,t=!1){try{let s=g.from("deliverables").select(`
          *,
          milestones(milestone_ref, name),
          deliverable_kpis(kpi_id, kpis(kpi_ref, name)),
          deliverable_quality_standards(quality_standard_id, quality_standards(qs_ref, name))
        `).eq("project_id",r).or("is_deleted.is.null,is_deleted.eq.false").order("deliverable_ref");t||(s=s.or("is_test_content.is.null,is_test_content.eq.false"));const{data:a,error:n}=await s;if(n)throw n;return a||[]}catch(s){throw s}}async syncKPILinks(r,t=[]){try{const{error:s}=await g.from("deliverable_kpis").delete().eq("deliverable_id",r);if(s)throw s;if(t.length>0){const a=t.map(o=>({deliverable_id:r,kpi_id:o})),{error:n}=await g.from("deliverable_kpis").insert(a);if(n)throw n}return!0}catch(s){throw s}}async syncQSLinks(r,t=[]){try{const{error:s}=await g.from("deliverable_quality_standards").delete().eq("deliverable_id",r);if(s)throw s;if(t.length>0){const a=t.map(o=>({deliverable_id:r,quality_standard_id:o})),{error:n}=await g.from("deliverable_quality_standards").insert(a);if(n)throw n}return!0}catch(s){throw s}}async upsertKPIAssessments(r,t,s){try{const a=t.map(o=>({deliverable_id:r,kpi_id:o.kpiId,criteria_met:o.criteriaMet,assessed_at:new Date().toISOString(),assessed_by:s})),{error:n}=await g.from("deliverable_kpi_assessments").upsert(a,{onConflict:"deliverable_id,kpi_id"});if(n)throw n;return!0}catch(a){throw a}}async upsertQSAssessments(r,t,s){try{const a=t.map(o=>({deliverable_id:r,quality_standard_id:o.qsId,criteria_met:o.criteriaMet,assessed_at:new Date().toISOString(),assessed_by:s})),{error:n}=await g.from("deliverable_qs_assessments").upsert(a,{onConflict:"deliverable_id,quality_standard_id"});if(n)throw n;return!0}catch(a){throw a}}async signDeliverable(r,t,s,a){try{const n=await this.getById(r);if(!n)throw new Error("Deliverable not found");const o={},c=new Date().toISOString();if(t==="supplier")o.supplier_pm_id=s,o.supplier_pm_name=a,o.supplier_pm_signed_at=c;else if(t==="customer")o.customer_pm_id=s,o.customer_pm_name=a,o.customer_pm_signed_at=c;else throw new Error("Invalid signer role");const l=t==="supplier"||n.supplier_pm_signed_at,u=t==="customer"||n.customer_pm_signed_at;return l&&u?(o.sign_off_status="Signed",o.status="Delivered",o.progress=100,o.delivered_date=c,o.delivered_by=s):l?o.sign_off_status="Awaiting Customer":u&&(o.sign_off_status="Awaiting Supplier"),await this.update(r,o)}catch(n){throw n}}async resetSignatures(r){try{const t={supplier_pm_id:null,supplier_pm_name:null,supplier_pm_signed_at:null,customer_pm_id:null,customer_pm_name:null,customer_pm_signed_at:null,sign_off_status:"Not Signed",status:"Review Complete"};return await this.update(r,t)}catch(t){throw t}}}const ys=new Li;class qi extends he{constructor(){super("kpis")}async getAllWithStatus(r){try{return(await this.getAll(r,{orderBy:{column:"name",ascending:!0}})).map(s=>({...s,rag_status:this.calculateRAG(s)}))}catch(t){throw t}}calculateRAG(r){if(!r.target_value||r.actual_value===null||r.actual_value===void 0)return"Unknown";const t=parseFloat(r.actual_value),s=parseFloat(r.target_value),a=parseFloat(r.threshold_amber||10);return r.trend==="higher_better"?t>=s?"Green":t>=s*(1-a/100)?"Amber":"Red":t<=s?"Green":t<=s*(1+a/100)?"Amber":"Red"}async getByRAGStatus(r,t){try{return(await this.getAllWithStatus(r)).filter(a=>a.rag_status===t)}catch(s){throw s}}async getNeedingAttention(r){try{return(await this.getAllWithStatus(r)).filter(s=>s.rag_status==="Amber"||s.rag_status==="Red")}catch(t){throw t}}async updateActualValue(r,t){return this.update(r,{actual_value:t,last_updated:new Date().toISOString()})}async getHistory(r,t=12){try{const{data:s,error:a}=await g.from("kpi_history").select("*").eq("kpi_id",r).order("recorded_at",{ascending:!1}).limit(t);if(a)throw a;return s||[]}catch{return[]}}async getSummary(r){try{const t=await this.getAllWithStatus(r);return{total:t.length,green:t.filter(s=>s.rag_status==="Green").length,amber:t.filter(s=>s.rag_status==="Amber").length,red:t.filter(s=>s.rag_status==="Red").length,unknown:t.filter(s=>s.rag_status==="Unknown").length}}catch(t){throw t}}async getAssessments(r){try{const{data:t,error:s}=await g.from("deliverable_kpi_assessments").select(`
          kpi_id,
          criteria_met,
          deliverables!inner(id, status, is_deleted, project_id)
        `).eq("deliverables.project_id",r);return s?await this.getAssessmentsFallback(r):(t||[]).filter(n=>n.deliverables?.is_deleted!==!0&&ae.deliverables.contributeToKPIs.includes(n.deliverables?.status))}catch{return[]}}async getAssessmentsFallback(r){try{const{data:t,error:s}=await g.from("deliverable_kpi_assessments").select("kpi_id, criteria_met, deliverable_id");if(s)throw s;const{data:a,error:n}=await g.from("deliverables").select("id, status, is_deleted").eq("project_id",r);if(n)throw n;const o=new Set((a||[]).filter(l=>l.is_deleted!==!0&&ae.deliverables.contributeToKPIs.includes(l.status)).map(l=>l.id));return(t||[]).filter(l=>o.has(l.deliverable_id))}catch{return[]}}}const zi=new qi;class Bi extends he{constructor(){super("quality_standards")}async getAllWithStatus(r){try{return(await this.getAll(r,{orderBy:{column:"name",ascending:!0}})).map(s=>({...s,compliance_status:this.calculateCompliance(s)}))}catch(t){throw t}}calculateCompliance(r){if(r.actual_value===null||r.actual_value===void 0)return"Not Measured";const t=parseFloat(r.actual_value),s=parseFloat(r.target_value||0);return t>=s?"Compliant":t>=s*.9?"Near Compliant":"Non-Compliant"}async getNonCompliant(r){try{return(await this.getAllWithStatus(r)).filter(s=>s.compliance_status==="Non-Compliant")}catch(t){throw t}}async updateMeasurement(r,t,s){return this.update(r,{actual_value:t,measurement_notes:s,last_measured:new Date().toISOString()})}async getSummary(r){try{const t=await this.getAllWithStatus(r);return{total:t.length,compliant:t.filter(s=>s.compliance_status==="Compliant").length,nearCompliant:t.filter(s=>s.compliance_status==="Near Compliant").length,nonCompliant:t.filter(s=>s.compliance_status==="Non-Compliant").length,notMeasured:t.filter(s=>s.compliance_status==="Not Measured").length}}catch(t){throw t}}async getAssessments(r){try{const{data:t,error:s}=await g.from("deliverable_qs_assessments").select(`
          quality_standard_id,
          criteria_met,
          deliverables!inner(id, status, is_deleted, project_id)
        `).eq("deliverables.project_id",r);return s?await this.getAssessmentsFallback(r):(t||[]).filter(n=>n.deliverables?.is_deleted!==!0&&ae.deliverables.contributeToQS.includes(n.deliverables?.status))}catch{return[]}}async getAssessmentsFallback(r){try{const{data:t,error:s}=await g.from("deliverable_qs_assessments").select("quality_standard_id, criteria_met, deliverable_id");if(s)throw s;const{data:a,error:n}=await g.from("deliverables").select("id, status, is_deleted").eq("project_id",r);if(n)throw n;const o=new Set((a||[]).filter(l=>l.is_deleted!==!0&&ae.deliverables.contributeToQS.includes(l.status)).map(l=>l.id));return(t||[]).filter(l=>o.has(l.deliverable_id))}catch{return[]}}async getAllWithCalculatedValues(r){try{const t=await this.getAll(r,{orderBy:{column:"qs_ref",ascending:!0}}),s=await this.getAssessments(r),a={};return s.forEach(n=>{a[n.quality_standard_id]||(a[n.quality_standard_id]={total:0,met:0}),a[n.quality_standard_id].total++,n.criteria_met&&a[n.quality_standard_id].met++}),t.map(n=>{const o=a[n.id],c=o&&o.total>0?Math.round(o.met/o.total*100):0,l=n.target||100,u=c>=l;return{...n,calculatedValue:c,assessmentCount:o?.total||0,assessmentsMet:o?.met||0,isAchieved:u}})}catch(t){throw t}}}const Vi=new Bi;class Wi extends he{constructor(){super("standards",{supportsSoftDelete:!1,sanitizeConfig:"standard"})}async getAll(r){return super.getAll(r,{orderBy:{column:"standard_ref",ascending:!0}})}async getByStatus(r,t){return super.getAll(r,{filters:[{column:"status",operator:"eq",value:t}],orderBy:{column:"standard_ref",ascending:!0}})}async getByCategory(r,t){return super.getAll(r,{filters:[{column:"category",operator:"eq",value:t}],orderBy:{column:"standard_ref",ascending:!0}})}async getSummary(r){try{const t=await this.getAll(r);return{total:t.length,completed:t.filter(s=>s.status==="Completed").length,inProgress:t.filter(s=>s.status==="In Progress").length,notStarted:t.filter(s=>!s.status||s.status==="Not Started").length}}catch(t){throw t}}}new Wi;const $i={version:"2.0",widgets:{"progress-hero":{visible:!0,x:0,y:0,w:12,h:2,minW:6,minH:2,maxH:3},"budget-summary":{visible:!1,x:0,y:2,w:6,h:2,minW:4,minH:2,maxH:3},"pmo-tracking":{visible:!1,x:6,y:2,w:6,h:2,minW:6,minH:2,maxH:4},"stats-grid":{visible:!0,x:0,y:2,w:12,h:2,minW:8,minH:2,maxH:3},certificates:{visible:!1,x:0,y:4,w:12,h:2,minW:6,minH:2,maxH:3},"milestones-list":{visible:!0,x:0,y:4,w:12,h:4,minW:8,minH:3,maxH:6},"kpis-category":{visible:!1,x:0,y:8,w:6,h:3,minW:4,minH:3,maxH:5},"quality-standards":{visible:!1,x:6,y:8,w:6,h:3,minW:4,minH:3,maxH:5}}};({...$i});class Ui extends he{constructor(){super("raid_items",{supportsSoftDelete:!0,sanitizeConfig:"raid_items"})}async getAllWithRelations(r,t={}){try{let s=g.from("raid_items").select(`
          *,
          owner:resources!raid_items_owner_id_fkey(id, name, email),
          milestone:milestones!raid_items_milestone_id_fkey(id, name, milestone_ref)
        `).eq("project_id",r);t.category&&(s=s.eq("category",t.category)),t.status&&(Array.isArray(t.status)?s=s.in("status",t.status):s=s.eq("status",t.status)),t.severity&&(s=s.eq("severity",t.severity));const a=t.orderBy?.column||"raid_ref",n=t.orderBy?.ascending??!0;s=s.order(a,{ascending:n});const{data:o,error:c}=await s;if(c)throw c;let l=o||[];return t.includeDeleted||(l=l.filter(u=>u.is_deleted!==!0)),l}catch(s){throw s}}async getGroupedByCategory(r){try{const t=await this.getAllWithRelations(r);return{risks:t.filter(s=>s.category==="Risk"),assumptions:t.filter(s=>s.category==="Assumption"),issues:t.filter(s=>s.category==="Issue"),dependencies:t.filter(s=>s.category==="Dependency")}}catch(t){throw t}}async getSummary(r){try{const t=await this.getAll(r),s={total:t.length,byCategory:{Risk:{total:0,open:0,highSeverity:0},Assumption:{total:0,open:0,highSeverity:0},Issue:{total:0,open:0,highSeverity:0},Dependency:{total:0,open:0,highSeverity:0}},byStatus:{Open:0,"In Progress":0,Closed:0,Accepted:0,Mitigated:0},bySeverity:{High:0,Medium:0,Low:0},highPriorityItems:[]};return t.forEach(a=>{s.byCategory[a.category]&&(s.byCategory[a.category].total++,(a.status==="Open"||a.status==="In Progress")&&s.byCategory[a.category].open++,a.severity==="High"&&s.byCategory[a.category].highSeverity++),s.byStatus.hasOwnProperty(a.status)&&s.byStatus[a.status]++,a.severity&&s.bySeverity.hasOwnProperty(a.severity)&&s.bySeverity[a.severity]++,a.severity==="High"&&(a.status==="Open"||a.status==="In Progress")&&s.highPriorityItems.push({id:a.id,raid_ref:a.raid_ref,category:a.category,title:a.title,description:a.description?.substring(0,100)+"..."})}),s}catch(t){throw t}}async getNextRef(r,t){try{const s=this.getCategoryPrefix(t),{data:a,error:n}=await g.from("raid_items").select("raid_ref").eq("project_id",r).ilike("raid_ref",`${s}%`).order("raid_ref",{ascending:!1}).limit(1);if(n)throw n;if(!a||a.length===0)return`${s}001`;const o=a[0].raid_ref,l=((parseInt(o.replace(s,""),10)||0)+1).toString().padStart(3,"0");return`${s}${l}`}catch(s){throw s}}getCategoryPrefix(r){return{Risk:"R",Assumption:"A",Issue:"I",Dependency:"D"}[r]||"X"}async createWithAutoRef(r){try{return r.raid_ref||(r.raid_ref=await this.getNextRef(r.project_id,r.category)),await this.create(r)}catch(t){throw t}}async updateStatus(r,t,s=null){try{const a={status:t};return["Closed","Accepted","Mitigated"].includes(t)?(a.closed_date=new Date().toISOString().split("T")[0],s&&(a.resolution=s)):a.closed_date=null,await this.update(r,a)}catch(a){throw a}}async getOverdue(r){try{const t=new Date().toISOString().split("T")[0],{data:s,error:a}=await g.from("raid_items").select("*").eq("project_id",r).in("status",["Open","In Progress"]).lt("due_date",t).order("due_date",{ascending:!0});if(a)throw a;return(s||[]).filter(n=>n.is_deleted!==!0)}catch(t){throw t}}async getByMilestone(r){try{const{data:t,error:s}=await g.from("raid_items").select("*").eq("milestone_id",r).order("raid_ref",{ascending:!0});if(s)throw s;return(t||[]).filter(a=>a.is_deleted!==!0)}catch(t){throw t}}async getByOwner(r){try{const{data:t,error:s}=await g.from("raid_items").select("*").eq("owner_id",r).order("raid_ref",{ascending:!0});if(s)throw s;return(t||[]).filter(a=>a.is_deleted!==!0)}catch(t){throw t}}async bulkUpdateStatus(r,t){const s={success:0,failed:0,errors:[]};for(const a of r)try{await this.updateStatus(a,t),s.success++}catch(n){s.failed++,s.errors.push({id:a,error:n.message})}return s}}const $o=new Ui,H={DRAFT:"draft",SUBMITTED:"submitted",AWAITING_CUSTOMER:"awaiting_customer",AWAITING_SUPPLIER:"awaiting_supplier",APPROVED:"approved",APPLIED:"applied",REJECTED:"rejected"},Ve={SCOPE_EXTENSION:"scope_extension",SCOPE_REDUCTION:"scope_reduction",TIME_EXTENSION:"time_extension",COST_ADJUSTMENT:"cost_adjustment",COMBINED:"combined"},Uo={[H.DRAFT]:{label:"Draft",color:"#8e8e93",bgColor:"rgba(142, 142, 147, 0.12)",description:"Being authored"},[H.SUBMITTED]:{label:"Submitted",color:"#007aff",bgColor:"rgba(0, 122, 255, 0.1)",description:"Ready for review"},[H.AWAITING_CUSTOMER]:{label:"Awaiting Customer",color:"#ff9500",bgColor:"rgba(255, 149, 0, 0.1)",description:"Supplier signed, awaiting customer"},[H.AWAITING_SUPPLIER]:{label:"Awaiting Supplier",color:"#ff9500",bgColor:"rgba(255, 149, 0, 0.1)",description:"Customer signed, awaiting supplier"},[H.APPROVED]:{label:"Approved",color:"#34c759",bgColor:"rgba(52, 199, 89, 0.1)",description:"Both parties signed"},[H.APPLIED]:{label:"Applied",color:"#0d9488",bgColor:"rgba(13, 148, 136, 0.1)",description:"Changes applied to baselines"},[H.REJECTED]:{label:"Rejected",color:"#ff3b30",bgColor:"rgba(255, 59, 48, 0.1)",description:"Rejected by a party"}},Fo={[Ve.SCOPE_EXTENSION]:{label:"Scope Extension",description:"Additional work beyond original scope",icon:"expand"},[Ve.SCOPE_REDUCTION]:{label:"Scope Reduction",description:"Removal of work from original scope",icon:"shrink"},[Ve.TIME_EXTENSION]:{label:"Time Extension",description:"Schedule adjustment without scope change",icon:"clock"},[Ve.COST_ADJUSTMENT]:{label:"Cost Adjustment",description:"Price change without scope/time change",icon:"pound"},[Ve.COMBINED]:{label:"Combined",description:"Multiple impact types",icon:"layers"}};class Fi extends he{constructor(){super("variations",{supportsSoftDelete:!0,sanitizeConfig:"variation"})}async getAllWithStats(r){try{const t=await this.getAll(r,{orderBy:{column:"created_at",ascending:!1}}),s=t.map(a=>a.id);if(s.length>0){const{data:a}=await g.from("variation_milestones").select("variation_id").in("variation_id",s),n={};return(a||[]).forEach(o=>{n[o.variation_id]=(n[o.variation_id]||0)+1}),t.map(o=>({...o,milestone_count:n[o.id]||0}))}return t.map(a=>({...a,milestone_count:0}))}catch(t){throw t}}async getWithDetails(r){try{const t=await this.getById(r);if(!t)return null;const{data:s}=await g.from("variation_milestones").select(`
          *,
          milestone:milestones(id, milestone_ref, name, billable, baseline_start_date, baseline_end_date)
        `).eq("variation_id",r),{data:a}=await g.from("variation_deliverables").select(`
          *,
          deliverable:deliverables(id, deliverable_ref, name)
        `).eq("variation_id",r);let n=null,o=null,c=null;if(t.supplier_signed_by){const{data:l}=await g.from("profiles").select("id, full_name, email").eq("id",t.supplier_signed_by).limit(1);n=l?.[0]}if(t.customer_signed_by){const{data:l}=await g.from("profiles").select("id, full_name, email").eq("id",t.customer_signed_by).limit(1);o=l?.[0]}if(t.rejected_by){const{data:l}=await g.from("profiles").select("id, full_name, email").eq("id",t.rejected_by).limit(1);c=l?.[0]}return{...t,affected_milestones:s||[],deliverable_changes:a||[],supplier_signer:n,customer_signer:o,rejector:c}}catch(t){throw t}}async createVariation(r,t,s){try{const{data:a,error:n}=await g.rpc("generate_variation_ref",{p_project_id:r});if(n){const c=(await this.getAll(r)).length+1;t.variation_ref=`VAR-${String(c).padStart(3,"0")}`}else t.variation_ref=a;return await this.create({project_id:r,...t,status:H.DRAFT,form_step:1,created_by:s})}catch(a){throw a}}async saveFormProgress(r,t,s){try{return await this.update(r,{form_data:t,form_step:s})}catch(a){throw a}}async addAffectedMilestone(r,t){try{const{data:s,error:a}=await g.from("variation_milestones").insert({variation_id:r,...t}).select();if(a)throw a;return s?.[0]}catch(s){throw s}}async updateAffectedMilestone(r,t){try{const{data:s,error:a}=await g.from("variation_milestones").update(t).eq("id",r).select();if(a)throw a;return s?.[0]}catch(s){throw s}}async removeAffectedMilestone(r){try{const{error:t}=await g.from("variation_milestones").delete().eq("id",r);if(t)throw t;return!0}catch(t){throw t}}async addDeliverableChange(r,t){try{const{data:s,error:a}=await g.from("variation_deliverables").insert({variation_id:r,...t}).select();if(a)throw a;return s?.[0]}catch(s){throw s}}async removeDeliverableChange(r){try{const{error:t}=await g.from("variation_deliverables").delete().eq("id",r);if(t)throw t;return!0}catch(t){throw t}}async submitForApproval(r,t){try{const{data:s}=await g.from("variation_milestones").select("*").eq("variation_id",r);let a=0,n=0;return(s||[]).forEach(o=>{const c=(o.new_baseline_cost||0)-(o.original_baseline_cost||0);if(a+=c,o.original_baseline_end&&o.new_baseline_end){const l=new Date(o.original_baseline_end),u=new Date(o.new_baseline_end),m=Math.round((u-l)/(1e3*60*60*24));n+=m}}),await this.update(r,{status:H.SUBMITTED,impact_summary:t,total_cost_impact:a,total_days_impact:n})}catch(s){throw s}}async signVariation(r,t,s){try{const a=await this.getById(r);if(!a)throw new Error("Variation not found");const n=new Date().toISOString(),o={};if(t==="supplier")o.supplier_signed_by=s,o.supplier_signed_at=n,a.customer_signed_at?o.status=H.APPROVED:o.status=H.AWAITING_CUSTOMER;else if(t==="customer")o.customer_signed_by=s,o.customer_signed_at=n,a.supplier_signed_at?o.status=H.APPROVED:o.status=H.AWAITING_SUPPLIER;else throw new Error("Invalid signer role");return await this.update(r,o)}catch(a){throw a}}async rejectVariation(r,t,s){try{return await this.update(r,{status:H.REJECTED,rejected_by:t,rejected_at:new Date().toISOString(),rejection_reason:s})}catch(a){throw a}}async applyVariation(r){try{const t=await this.getWithDetails(r);if(!t)throw new Error("Variation not found");if(t.status!==H.APPROVED)throw new Error("Variation must be approved before applying");for(const n of t.affected_milestones)if(n.milestone_id){const{error:o}=await g.from("milestones").update({baseline_start_date:n.new_baseline_start,baseline_end_date:n.new_baseline_end,billable:n.new_baseline_cost}).eq("id",n.milestone_id);if(o)throw o;const c=await this.getCurrentBaselineVersion(n.milestone_id),{error:l}=await g.from("milestone_baseline_versions").insert({milestone_id:n.milestone_id,version:c+1,variation_id:r,baseline_start_date:n.new_baseline_start,baseline_end_date:n.new_baseline_end,baseline_billable:n.new_baseline_cost,supplier_signed_by:t.supplier_signed_by,supplier_signed_at:t.supplier_signed_at,customer_signed_by:t.customer_signed_by,customer_signed_at:t.customer_signed_at});if(l)throw l;await this.updateAffectedMilestone(n.id,{baseline_version_before:c||1,baseline_version_after:c+1})}const s=`${t.project_id?.substring(0,8)||"PROJ"}-${t.variation_ref}-CERT`,a={variation_ref:t.variation_ref,title:t.title,type:t.variation_type,description:t.description,reason:t.reason,impact_summary:t.impact_summary,total_cost_impact:t.total_cost_impact,total_days_impact:t.total_days_impact,affected_milestones:t.affected_milestones,deliverable_changes:t.deliverable_changes,supplier_signed_by:t.supplier_signed_by,supplier_signed_at:t.supplier_signed_at,customer_signed_by:t.customer_signed_by,customer_signed_at:t.customer_signed_at,applied_at:new Date().toISOString()};return await this.update(r,{status:H.APPLIED,applied_at:new Date().toISOString(),certificate_number:s,certificate_data:a})}catch(t){throw t}}async getCurrentBaselineVersion(r){try{const{data:t,error:s}=await g.from("milestone_baseline_versions").select("version").eq("milestone_id",r).order("version",{ascending:!1}).limit(1);if(s)throw s;return t?.[0]?.version||0}catch{return 0}}async getMilestoneBaselineHistory(r){try{const{data:t,error:s}=await g.from("milestone_baseline_versions").select(`
          *,
          variation:variations(variation_ref, title)
        `).eq("milestone_id",r).order("version",{ascending:!0});if(s)throw s;return t||[]}catch(t){throw t}}async getVariationsForMilestone(r){try{const{data:t,error:s}=await g.from("variation_milestones").select(`
          *,
          variation:variations(*)
        `).eq("milestone_id",r);if(s)throw s;return(t||[]).map(a=>a.variation).filter(Boolean)}catch(t){throw t}}async hasPendingVariation(r){try{const{data:t,error:s}=await g.from("variation_milestones").select("variation_id, variations!inner(status)").eq("milestone_id",r).in("variations.status",[H.DRAFT,H.SUBMITTED,H.AWAITING_CUSTOMER,H.AWAITING_SUPPLIER,H.APPROVED]).limit(1);if(s)throw s;return(t||[]).length>0}catch{return!1}}async getSummary(r){try{const t=await this.getAll(r),s={total:t.length,draft:0,pending:0,approved:0,applied:0,rejected:0,totalCostImpact:0,totalDaysImpact:0};return t.forEach(a=>{switch(a.status){case H.DRAFT:s.draft++;break;case H.SUBMITTED:case H.AWAITING_CUSTOMER:case H.AWAITING_SUPPLIER:s.pending++;break;case H.APPROVED:s.approved++;break;case H.APPLIED:s.applied++,s.totalCostImpact+=a.total_cost_impact||0,s.totalDaysImpact+=a.total_days_impact||0;break;case H.REJECTED:s.rejected++;break}}),s}catch(t){throw t}}async getMilestonesWithDependencies(r){try{const{data:t,error:s}=await g.from("milestones").select("*").eq("project_id",r).or("is_deleted.is.null,is_deleted.eq.false").order("start_date",{ascending:!0});if(s)throw s;const a=t||[];return a.map((n,o)=>{const c=[],l=[];return a.forEach((u,m)=>{u.id!==n.id&&(u.end_date&&n.start_date&&u.end_date<=n.start_date&&c.push(u.milestone_ref),n.end_date&&u.start_date&&n.end_date<=u.start_date&&l.push(u.milestone_ref))}),{...n,dependencies:c,dependents:l}})}catch(t){throw t}}}const Ho=new Fi;function Hi({refreshTrigger:i}){const r=be(),{projectId:t}=de(),[s,a]=d.useState(!0),[n,o]=d.useState({total:0,approved:0,awaitingSignatures:0,awaitingCertificate:0,inProgress:0}),c=d.useCallback(async()=>{if(t){a(!0);try{const u=await Te.getAll(t,{orderBy:{column:"milestone_ref",ascending:!0}}),m=u.map(k=>k.id);let h={};m.length>0&&(await ys.getAll(t,{filters:[{column:"milestone_id",operator:"in",value:m}],select:"id, milestone_id, status"})||[]).forEach(S=>{h[S.milestone_id]||(h[S.milestone_id]=[]),h[S.milestone_id].push(S)});const f=await Te.getCertificates(t),y={};f.forEach(k=>{y[k.milestone_id]=k});let b=0,p=0,_=0,w=0;u.forEach(k=>{const S=h[k.id]||[],v=S.length>0&&S.every(C=>C.status==="Delivered"),E=y[k.id];E&&E.status==="Signed"?b++:E?p++:v?_++:w++}),o({total:u.length,approved:b,awaitingSignatures:p,awaitingCertificate:_,inProgress:w})}catch{}finally{a(!1)}}},[t]);d.useEffect(()=>{c()},[c,i]);const l=()=>{r("/milestones")};return s?e.jsx(Le,{rows:4}):e.jsxs("div",{className:"dashboard-widget",onClick:l,children:[e.jsxs("div",{className:"widget-header",children:[e.jsx("div",{className:"widget-icon",children:e.jsx(mr,{size:20})}),e.jsx("span",{className:"widget-title",children:"Milestones"}),e.jsxs("span",{className:"widget-total",children:[n.total," Total"]})]}),e.jsxs("div",{className:"widget-breakdown",children:[e.jsxs("div",{className:"widget-row",children:[e.jsx("div",{className:"widget-row-icon approved",children:e.jsx(Pe,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"Approved (Signed)"}),e.jsx("span",{className:"widget-row-value",children:n.approved})]}),e.jsxs("div",{className:"widget-row",children:[e.jsx("div",{className:"widget-row-icon pending",children:e.jsx(ge,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"Awaiting Signatures"}),e.jsx("span",{className:"widget-row-value",children:n.awaitingSignatures})]}),e.jsxs("div",{className:"widget-row",children:[e.jsx("div",{className:"widget-row-icon awaiting",children:e.jsx(Fe,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"Awaiting Certificate"}),e.jsx("span",{className:"widget-row-value",children:n.awaitingCertificate})]}),e.jsxs("div",{className:"widget-row",children:[e.jsx("div",{className:"widget-row-icon progress",children:e.jsx(pr,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"In Progress"}),e.jsx("span",{className:"widget-row-value",children:n.inProgress})]})]})]})}function Gi({refreshTrigger:i}){const r=be(),{projectId:t}=de(),{showTestUsers:s}=Cr(),[a,n]=d.useState(!0),[o,c]=d.useState({total:0,delivered:0,reviewComplete:0,awaitingReview:0,returned:0,inProgress:0,notStarted:0}),l=d.useCallback(async()=>{if(t){n(!0);try{const m=await ys.getAllWithRelations(t,s);let h=0,f=0,y=0,b=0,p=0,_=0;m.forEach(w=>{switch(w.status){case"Delivered":h++;break;case"Review Complete":f++;break;case"Submitted for Review":y++;break;case"Returned for More Work":b++;break;case"In Progress":p++;break;case"Not Started":default:_++;break}}),c({total:m.length,delivered:h,reviewComplete:f,awaitingReview:y,returned:b,inProgress:p,notStarted:_})}catch{}finally{n(!1)}}},[t,s]);d.useEffect(()=>{l()},[l,i]);const u=()=>{r("/deliverables")};return a?e.jsx(Le,{rows:6}):e.jsxs("div",{className:"dashboard-widget",onClick:u,children:[e.jsxs("div",{className:"widget-header",children:[e.jsx("div",{className:"widget-icon",style:{background:"rgba(34, 197, 94, 0.1)",color:"#22c55e"},children:e.jsx(rt,{size:20})}),e.jsx("span",{className:"widget-title",children:"Deliverables"}),e.jsxs("span",{className:"widget-total",children:[o.total," Total"]})]}),e.jsxs("div",{className:"widget-breakdown",children:[e.jsxs("div",{className:"widget-row",children:[e.jsx("div",{className:"widget-row-icon approved",children:e.jsx(Pe,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"Delivered"}),e.jsx("span",{className:"widget-row-value",children:o.delivered})]}),e.jsxs("div",{className:"widget-row",children:[e.jsx("div",{className:"widget-row-icon",style:{background:"rgba(37, 99, 235, 0.1)",color:"#2563eb"},children:e.jsx(ta,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"Review Complete"}),e.jsx("span",{className:"widget-row-value",children:o.reviewComplete})]}),e.jsxs("div",{className:"widget-row",children:[e.jsx("div",{className:"widget-row-icon pending",children:e.jsx(ge,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"Awaiting Review"}),e.jsx("span",{className:"widget-row-value",children:o.awaitingReview})]}),e.jsxs("div",{className:"widget-row",children:[e.jsx("div",{className:"widget-row-icon",style:{background:"rgba(220, 38, 38, 0.1)",color:"#dc2626"},children:e.jsx(It,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"Returned"}),e.jsx("span",{className:"widget-row-value",children:o.returned})]}),e.jsxs("div",{className:"widget-row",children:[e.jsx("div",{className:"widget-row-icon",style:{background:"rgba(79, 70, 229, 0.1)",color:"#4f46e5"},children:e.jsx(Se,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"In Progress"}),e.jsx("span",{className:"widget-row-value",children:o.inProgress})]}),e.jsxs("div",{className:"widget-row",children:[e.jsx("div",{className:"widget-row-icon progress",children:e.jsx(pr,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"Not Started"}),e.jsx("span",{className:"widget-row-value",children:o.notStarted})]})]})]})}function Ki({refreshTrigger:i}){const r=be(),{projectId:t}=de(),[s,a]=d.useState(!0),[n,o]=d.useState({submittedCount:0,submittedValue:0,validatedCount:0,validatedValue:0}),c=d.useCallback(async()=>{if(t){a(!0);try{const f=(await fs.getAll(t,{select:`
          id, hours_worked, hours, status, is_deleted,
          resources(id, sell_price)
        `})||[]).filter(w=>w.is_deleted!==!0);let y=0,b=0,p=0,_=0;f.forEach(w=>{const k=parseFloat(w.hours_worked||w.hours||0),S=w.resources?.sell_price||0,v=Lt(k,S);switch(w.status){case"Submitted":y++,b+=v;break;case"Validated":case"Approved":p++,_+=v;break}}),o({submittedCount:y,submittedValue:b,validatedCount:p,validatedValue:_})}catch{}finally{a(!1)}}},[t]);d.useEffect(()=>{c()},[c,i]);const l=()=>{r("/timesheets")},u=h=>`Â£${Math.round(h).toLocaleString()}`;if(s)return e.jsx(Le,{rows:2});const m=n.submittedCount+n.validatedCount;return e.jsxs("div",{className:"dashboard-widget",onClick:l,children:[e.jsxs("div",{className:"widget-header",children:[e.jsx("div",{className:"widget-icon",style:{background:"rgba(59, 130, 246, 0.1)",color:"#3b82f6"},children:e.jsx(ge,{size:20})}),e.jsx("span",{className:"widget-title",children:"Timesheets"}),e.jsxs("span",{className:"widget-total",children:[m," Active"]})]}),e.jsxs("div",{className:"widget-breakdown",children:[e.jsxs("div",{className:"widget-row",children:[e.jsx("div",{className:"widget-row-icon pending",children:e.jsx(cr,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"Submitted"}),e.jsx("span",{className:"widget-row-value",children:n.submittedCount}),e.jsx("span",{className:"widget-row-secondary",children:u(n.submittedValue)})]}),e.jsxs("div",{className:"widget-row",children:[e.jsx("div",{className:"widget-row-icon approved",children:e.jsx(Pe,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"Validated"}),e.jsx("span",{className:"widget-row-value",children:n.validatedCount}),e.jsx("span",{className:"widget-row-secondary",children:u(n.validatedValue)})]})]})]})}function Qi({refreshTrigger:i}){const r=be(),{projectId:t}=de(),[s,a]=d.useState(!0),[n,o]=d.useState({awaitingValue:0,validatedTotal:0,chargeableValue:0,nonChargeableValue:0}),c=d.useCallback(async()=>{if(t){a(!0);try{const h=(await gs.getAll(t,{select:"id, amount, status, chargeable_to_customer, is_deleted"})||[]).filter(_=>_.is_deleted!==!0);let f=0,y=0,b=0,p=0;h.forEach(_=>{const w=parseFloat(_.amount||0);switch(_.status){case"Submitted":f+=w;break;case"Validated":case"Approved":y+=w,_.chargeable_to_customer!==!1?b+=w:p+=w;break}}),o({awaitingValue:f,validatedTotal:y,chargeableValue:b,nonChargeableValue:p})}catch{}finally{a(!1)}}},[t]);d.useEffect(()=>{c()},[c,i]);const l=()=>{r("/expenses")},u=m=>`Â£${Math.round(m).toLocaleString()}`;return s?e.jsx(Le,{rows:4}):e.jsxs("div",{className:"dashboard-widget",onClick:l,children:[e.jsxs("div",{className:"widget-header",children:[e.jsx("div",{className:"widget-icon",style:{background:"rgba(168, 85, 247, 0.1)",color:"#a855f7"},children:e.jsx(ct,{size:20})}),e.jsx("span",{className:"widget-title",children:"Expenses"}),e.jsxs("span",{className:"widget-total",children:[u(n.validatedTotal)," Validated"]})]}),e.jsxs("div",{className:"widget-breakdown",children:[e.jsxs("div",{className:"widget-row",children:[e.jsx("div",{className:"widget-row-icon pending",children:e.jsx(ge,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"Awaiting Validation"}),e.jsx("span",{className:"widget-row-value",children:u(n.awaitingValue)})]}),e.jsxs("div",{className:"widget-row",children:[e.jsx("div",{className:"widget-row-icon approved",children:e.jsx(Pe,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"Validated Total"}),e.jsx("span",{className:"widget-row-value",children:u(n.validatedTotal)})]}),e.jsxs("div",{className:"widget-row",style:{paddingLeft:"1.5rem"},children:[e.jsx("div",{className:"widget-row-icon",style:{background:"rgba(34, 197, 94, 0.1)",color:"#22c55e"},children:e.jsx(ra,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"â†³ Chargeable"}),e.jsx("span",{className:"widget-row-value",children:u(n.chargeableValue)})]}),e.jsxs("div",{className:"widget-row",style:{paddingLeft:"1.5rem"},children:[e.jsx("div",{className:"widget-row-icon",style:{background:"rgba(107, 114, 128, 0.1)",color:"#6b7280"},children:e.jsx(Dt,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"â†³ Non-Chargeable"}),e.jsx("span",{className:"widget-row-value",children:u(n.nonChargeableValue)})]})]})]})}function Yi(){const{user:i}=ye();let r="viewer",t="viewer",s=!1;try{const l=ut();r=l.effectiveRole||"viewer",t=l.actualRole||"viewer",s=l.isImpersonating||!1}catch{const u=ye();r=u.role||"viewer",t=u.role||"viewer"}const a=i?.id||null,n=r,o=(l,u)=>A(n,l,u);return{userRole:n,actualRole:t,isImpersonating:s,currentUserId:a,can:o,hasPermission:o,PERMISSION_MATRIX:_r,canAddTimesheet:Mr(n),canAddTimesheetForOthers:qt(n),canApproveTimesheets:Ye(n),canApproveTimesheet:Ye(n),canAddExpense:Nt(n),canAddExpenseForOthers:Tr(n),canValidateChargeableExpenses:Or(n),canValidateNonChargeableExpenses:Lr(n),canCreateMilestone:qr(n),canEditMilestone:zr(n),canDeleteMilestone:Br(n),canUseGantt:Vr(n),canEditBilling:In(n),canCreateDeliverable:Wr(n),canEditDeliverable:$r(n),canDeleteDeliverable:Ur(n),canReviewDeliverable:Fr(n),canSubmitDeliverable:Mn(n),canManageKPIs:Hr(n),canAddKPI:On(n),canEditKPI:Ln(n),canDeleteKPI:qn(n),canManageQualityStandards:Gr(n),canAddQualityStandard:zn(n),canEditQualityStandard:Bn(n),canDeleteQualityStandard:Vn(n),canManageResources:Kr(n),canAddResource:Wn(n),canEditResource:$n(n),canDeleteResource:Qr(n),canSeeCostPrice:Yr(n),canSeeResourceType:Un(n),canSeeMargins:Jr(n),canViewPartners:Xr(n),canManagePartners:Zr(n),canAddPartner:Fn(n),canEditPartner:Hn(n),canDeletePartner:Gn(n),canCreateVariation:Kn(n),canEditVariation:Qn(n),canDeleteVariation:Yn(n),canSubmitVariation:Jn(n),canSignVariationAsSupplier:Xn(n),canSignVariationAsCustomer:Zn(n),canRejectVariation:ei(n),canSignAsSupplier:es(n),canSignAsCustomer:ts(n),canCreateCertificate:ti(n),canAccessSettings:rs(n),canEditSettings:ri(n),canManageUsers:ss(n),canViewUsers:si(n),canViewWorkflowSummary:as(n),canGenerateCustomerInvoice:ns(n),canGenerateThirdPartyInvoice:is(n),canViewMarginReports:ai(n),canAccessReports:ni(n),canEditTimesheet:l=>En(n,l,a),canDeleteTimesheet:l=>Rn(n,l,a),canSubmitTimesheet:l=>Pn(n,l,a),canValidateTimesheet:l=>l.status!=="Submitted"?!1:Ye(n),canSubmitExpense:l=>l.status!=="Draft"&&l.status!=="Rejected"?!1:Pt(n,[x.ADMIN,x.SUPPLIER_PM])?!0:l.created_by===a&&Nt(n),canValidateExpense:l=>Nn(n,l),canEditExpense:l=>An(n,l,a),canDeleteExpense:l=>Dn(n,l,a),canUpdateDeliverableStatus:l=>Tn(n,l,a),getAvailableResources:l=>os(n,l,a),getCurrentUserResource:l=>ii(l,a),getDefaultResource:l=>ls(n,l,a),getDefaultResourceId:l=>oi(n,l,a),getPermissionSummary:()=>li(n),getRoleConfig:()=>cs(n),getRoleLabel:()=>ds(n),ROLES:x,ROLE_OPTIONS:qa,hasRole:l=>Pt(n,l),isFullAdmin:kn(n)}}function Ji({editable:i=!1,fullPage:r=!1,refreshTrigger:t}){const s=be(),{projectId:a}=de(),{canEditBilling:n}=Yi(),{showSuccess:o,showError:c}=Pr(),l=i&&n,[u,m]=d.useState(!0),[h,f]=d.useState([]),[y,b]=d.useState(null),[p,_]=d.useState(""),w=d.useCallback(async()=>{if(a){m(!0);try{const j=await Te.getBillableMilestones(a);f(j||[])}catch{}finally{m(!1)}}},[a]);d.useEffect(()=>{w()},[w,t]);const k=j=>{!r&&!j.target.closest("button, input, a")&&s("/billing")},S=async(j,P)=>{if(l)try{const B=!j[P];await Te.update(j.id,{[P]:B}),f(ee=>ee.map(K=>K.id===j.id?{...K,[P]:B}:K)),o(`${P==="is_billed"?"Billed":"Received"} status updated`)}catch{c("Failed to update status")}},v=j=>{l&&(b(j.id),_(j.purchase_order||""))},E=async j=>{try{await Te.update(j.id,{purchase_order:p}),f(P=>P.map(B=>B.id===j.id?{...B,purchase_order:p}:B)),b(null),o("PO number updated")}catch{c("Failed to update PO number")}},C=j=>new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP",minimumFractionDigits:0,maximumFractionDigits:0}).format(j),R=j=>j?new Date(j).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"}):"â€”",D=h.reduce((j,P)=>j+(P.billable||0),0),N=h.filter(j=>j.is_billed).reduce((j,P)=>j+(P.billable||0),0),I=h.filter(j=>j.is_received).reduce((j,P)=>j+(P.billable||0),0);return u?e.jsx($e,{}):e.jsxs("div",{className:"dashboard-widget billing-widget",style:{cursor:r?"default":"pointer"},onClick:k,children:[e.jsxs("div",{className:"widget-header",children:[e.jsx("div",{className:"widget-icon",style:{backgroundColor:"#dcfce7",color:"#16a34a"},children:e.jsx(Mt,{size:20})}),e.jsx("span",{className:"widget-title",children:"Billing"}),e.jsxs("span",{className:"widget-total",children:[C(D)," Total"]})]}),e.jsxs("div",{style:{display:"flex",gap:"1.5rem",padding:"0.75rem 1rem",backgroundColor:"#f8fafc",borderRadius:"8px",marginBottom:"0.75rem",fontSize:"0.875rem"},children:[e.jsxs("div",{children:[e.jsx("span",{style:{color:"#64748b"},children:"Billed: "}),e.jsx("span",{style:{fontWeight:"600",color:"#16a34a"},children:C(N)})]}),e.jsxs("div",{children:[e.jsx("span",{style:{color:"#64748b"},children:"Received: "}),e.jsx("span",{style:{fontWeight:"600",color:"#2563eb"},children:C(I)})]}),e.jsxs("div",{children:[e.jsx("span",{style:{color:"#64748b"},children:"Outstanding: "}),e.jsx("span",{style:{fontWeight:"600",color:"#dc2626"},children:C(D-I)})]})]}),e.jsx("div",{style:{overflowX:"auto"},children:e.jsxs("table",{style:{width:"100%",fontSize:"0.8125rem",borderCollapse:"collapse"},children:[e.jsx("thead",{children:e.jsxs("tr",{style:{borderBottom:"1px solid #e2e8f0"},children:[e.jsx("th",{style:{textAlign:"left",padding:"0.5rem 0.25rem",fontWeight:"600",color:"#64748b"},children:"Milestone"}),e.jsx("th",{style:{textAlign:"right",padding:"0.5rem 0.25rem",fontWeight:"600",color:"#64748b"},children:"Amount"}),e.jsx("th",{style:{textAlign:"center",padding:"0.5rem 0.25rem",fontWeight:"600",color:"#64748b"},children:"Expected"}),e.jsx("th",{style:{textAlign:"center",padding:"0.5rem 0.25rem",fontWeight:"600",color:"#64748b"},children:"Ready"}),e.jsx("th",{style:{textAlign:"center",padding:"0.5rem 0.25rem",fontWeight:"600",color:"#64748b"},children:"Billed"}),e.jsx("th",{style:{textAlign:"center",padding:"0.5rem 0.25rem",fontWeight:"600",color:"#64748b"},children:"Received"}),e.jsx("th",{style:{textAlign:"left",padding:"0.5rem 0.25rem",fontWeight:"600",color:"#64748b"},children:"PO Number"})]})}),e.jsx("tbody",{children:h.map(j=>e.jsxs("tr",{style:{borderBottom:"1px solid #f1f5f9",backgroundColor:j.is_received?"#f0fdf4":"transparent"},children:[e.jsxs("td",{style:{padding:"0.625rem 0.25rem"},children:[r?e.jsx(St,{to:`/milestones/${j.id}`,style:{textDecoration:"none"},onClick:P=>P.stopPropagation(),children:e.jsx("div",{style:{fontWeight:"500",color:"#3b82f6"},children:j.milestone_ref})}):e.jsx("div",{style:{fontWeight:"500"},children:j.milestone_ref}),e.jsx("div",{style:{fontSize:"0.75rem",color:"#64748b",maxWidth:"200px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:j.name})]}),e.jsx("td",{style:{textAlign:"right",padding:"0.625rem 0.25rem",fontWeight:"600"},children:C(j.billable)}),e.jsx("td",{style:{textAlign:"center",padding:"0.625rem 0.25rem",color:"#64748b"},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"0.25rem"},children:[e.jsx(Ke,{size:12}),R(j.expected_date)]})}),e.jsx("td",{style:{textAlign:"center",padding:"0.625rem 0.25rem"},children:e.jsxs("div",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.125rem 0.5rem",borderRadius:"4px",fontSize:"0.75rem",fontWeight:"600",backgroundColor:j.ready_to_bill?"#dcfce7":"#fef3c7",color:j.ready_to_bill?"#16a34a":"#d97706"},title:j.certificate_status||"No certificate",children:[e.jsx(Oe,{size:12}),j.ready_to_bill?"Yes":"No"]})}),e.jsx("td",{style:{textAlign:"center",padding:"0.625rem 0.25rem"},children:e.jsx("button",{onClick:P=>{P.stopPropagation(),S(j,"is_billed")},disabled:!l,style:{width:"28px",height:"28px",borderRadius:"6px",border:"none",cursor:l?"pointer":"default",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:j.is_billed?"#dcfce7":"#f1f5f9",color:j.is_billed?"#16a34a":"#94a3b8"},children:j.is_billed?e.jsx(Ne,{size:16}):e.jsx(ue,{size:16})})}),e.jsx("td",{style:{textAlign:"center",padding:"0.625rem 0.25rem"},children:e.jsx("button",{onClick:P=>{P.stopPropagation(),S(j,"is_received")},disabled:!l,style:{width:"28px",height:"28px",borderRadius:"6px",border:"none",cursor:l?"pointer":"default",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:j.is_received?"#dbeafe":"#f1f5f9",color:j.is_received?"#2563eb":"#94a3b8"},children:j.is_received?e.jsx(Ne,{size:16}):e.jsx(ue,{size:16})})}),e.jsx("td",{style:{padding:"0.625rem 0.25rem"},children:y===j.id?e.jsxs("div",{style:{display:"flex",gap:"0.25rem"},onClick:P=>P.stopPropagation(),children:[e.jsx("input",{type:"text",value:p,onChange:P=>_(P.target.value),onKeyDown:P=>P.key==="Enter"&&E(j),style:{width:"100px",padding:"0.25rem 0.5rem",fontSize:"0.75rem",border:"1px solid #e2e8f0",borderRadius:"4px"},autoFocus:!0}),e.jsx("button",{onClick:()=>E(j),style:{padding:"0.25rem 0.5rem",fontSize:"0.75rem",backgroundColor:"#16a34a",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:"Save"})]}):e.jsxs("div",{onClick:P=>{P.stopPropagation(),l&&v(j)},style:{padding:"0.25rem 0.5rem",fontSize:"0.75rem",color:j.purchase_order?"#1e293b":"#94a3b8",cursor:l?"pointer":"default",borderRadius:"4px",backgroundColor:l?"#f8fafc":"transparent",display:"flex",alignItems:"center",gap:"0.25rem"},children:[e.jsx(Fe,{size:12}),j.purchase_order||(l?"Add PO":"â€”")]})})]},j.id))})]})}),h.length===0&&e.jsx("div",{style:{textAlign:"center",padding:"2rem",color:"#64748b"},children:"No billable milestones found"})]})}function Xi({refreshTrigger:i}){const{projectId:r}=de(),[t,s]=d.useState(!0),[a,n]=d.useState({totalBillable:0,timesheetsPending:0,timesheetsValidated:0,timesheetsTotal:0,gap:0,expensesPendingChargeable:0,expensesPendingNonChargeable:0,expensesValidatedChargeable:0,expensesValidatedNonChargeable:0,expensesTotalPending:0,expensesTotalValidated:0,expensesTotalChargeable:0,expensesTotalNonChargeable:0,pmoTimesheets:0,pmoPercentage:0}),o=d.useCallback(async()=>{if(r){s(!0);try{const m=(await Te.getAll(r,{select:"id, billable"})||[]).reduce((N,I)=>N+(parseFloat(I.billable)||0),0),f=(await fs.getAll(r,{select:`
          id, hours_worked, hours, status, is_deleted,
          resources(id, sell_price, role)
        `})||[]).filter(N=>N.is_deleted!==!0);let y=0,b=0,p=0;f.forEach(N=>{const I=parseFloat(N.hours_worked||N.hours||0),j=N.resources?.sell_price||0,P=Lt(I,j),B=We(N.resources?.role);switch(N.status){case"Submitted":y+=P,B&&(p+=P);break;case"Validated":case"Approved":b+=P,B&&(p+=P);break}});const _=y+b,w=m-_,k=_>0?p/_*100:0,v=(await gs.getAll(r,{select:"id, amount, status, chargeable_to_customer, is_deleted"})||[]).filter(N=>N.is_deleted!==!0);let E=0,C=0,R=0,D=0;v.forEach(N=>{const I=parseFloat(N.amount||0),j=N.chargeable_to_customer!==!1;switch(N.status){case"Submitted":j?E+=I:C+=I;break;case"Validated":case"Approved":j?R+=I:D+=I;break}}),n({totalBillable:m,timesheetsPending:y,timesheetsValidated:b,timesheetsTotal:_,gap:w,expensesPendingChargeable:E,expensesPendingNonChargeable:C,expensesValidatedChargeable:R,expensesValidatedNonChargeable:D,expensesTotalPending:E+C,expensesTotalValidated:R+D,expensesTotalChargeable:E+R,expensesTotalNonChargeable:C+D,pmoTimesheets:p,pmoPercentage:k})}catch{}finally{s(!1)}}},[r]);d.useEffect(()=>{o()},[o,i]);const c=u=>{const h=`Â£${Math.abs(Math.round(u)).toLocaleString()}`;return u<0?`-${h}`:h};if(t)return e.jsx($e,{});const l=a.gap<0;return e.jsxs("div",{className:"dashboard-widget finance-widget",children:[e.jsxs("div",{className:"widget-header",children:[e.jsx("div",{className:"widget-icon",style:{background:"rgba(16, 185, 129, 0.1)",color:"#10b981"},children:e.jsx(Mt,{size:20})}),e.jsx("span",{className:"widget-title",children:"Finance"})]}),e.jsxs("div",{className:"finance-content",children:[e.jsx("div",{className:"finance-section finance-billable",children:e.jsxs("div",{className:"finance-row finance-row-large",children:[e.jsx("span",{className:"finance-label",children:"Total Billable"}),e.jsx("span",{className:"finance-value",children:c(a.totalBillable)})]})}),e.jsxs("div",{className:"finance-section",children:[e.jsx("div",{className:"finance-section-header",children:"Timesheets"}),e.jsxs("div",{className:"finance-row",children:[e.jsx(ge,{size:14,className:"finance-icon pending"}),e.jsx("span",{className:"finance-label",children:"Pending Validation"}),e.jsx("span",{className:"finance-value",children:c(a.timesheetsPending)})]}),e.jsxs("div",{className:"finance-row",children:[e.jsx(Pe,{size:14,className:"finance-icon approved"}),e.jsx("span",{className:"finance-label",children:"Validated"}),e.jsx("span",{className:"finance-value",children:c(a.timesheetsValidated)})]}),e.jsxs("div",{className:"finance-row finance-row-total",children:[e.jsx("span",{className:"finance-label",children:"Total"}),e.jsx("span",{className:"finance-value",children:c(a.timesheetsTotal)})]}),e.jsxs("div",{className:`finance-row finance-row-gap ${l?"negative":"positive"}`,children:[l?e.jsx(sa,{size:14,className:"finance-icon"}):e.jsx(at,{size:14,className:"finance-icon"}),e.jsx("span",{className:"finance-label",children:"Gap vs Billable"}),e.jsx("span",{className:"finance-value",children:c(a.gap)})]})]}),e.jsxs("div",{className:"finance-section",children:[e.jsx("div",{className:"finance-section-header",children:"Expenses"}),e.jsxs("div",{className:"finance-expenses-grid",children:[e.jsx("div",{className:"finance-expenses-header"}),e.jsx("div",{className:"finance-expenses-header",children:"Chargeable"}),e.jsx("div",{className:"finance-expenses-header",children:"Non-Chg"}),e.jsx("div",{className:"finance-expenses-header",children:"Total"}),e.jsxs("div",{className:"finance-expenses-label",children:[e.jsx(ge,{size:12,className:"finance-icon pending"}),"Pending"]}),e.jsx("div",{className:"finance-expenses-value",children:c(a.expensesPendingChargeable)}),e.jsx("div",{className:"finance-expenses-value",children:c(a.expensesPendingNonChargeable)}),e.jsx("div",{className:"finance-expenses-value finance-expenses-total",children:c(a.expensesTotalPending)}),e.jsxs("div",{className:"finance-expenses-label",children:[e.jsx(Pe,{size:12,className:"finance-icon approved"}),"Validated"]}),e.jsx("div",{className:"finance-expenses-value",children:c(a.expensesValidatedChargeable)}),e.jsx("div",{className:"finance-expenses-value",children:c(a.expensesValidatedNonChargeable)}),e.jsx("div",{className:"finance-expenses-value finance-expenses-total",children:c(a.expensesTotalValidated)}),e.jsx("div",{className:"finance-expenses-label finance-expenses-total-label",children:"Total"}),e.jsx("div",{className:"finance-expenses-value finance-expenses-total",children:c(a.expensesTotalChargeable)}),e.jsx("div",{className:"finance-expenses-value finance-expenses-total",children:c(a.expensesTotalNonChargeable)}),e.jsx("div",{className:"finance-expenses-value finance-expenses-grand-total",children:c(a.expensesTotalChargeable+a.expensesTotalNonChargeable)})]})]}),e.jsxs("div",{className:"finance-section",children:[e.jsx("div",{className:"finance-section-header",children:"PMO Overhead"}),e.jsxs("div",{className:"finance-row",children:[e.jsx("span",{className:"finance-label",children:"PMO Timesheets"}),e.jsx("span",{className:"finance-value",children:c(a.pmoTimesheets)})]}),e.jsxs("div",{className:"finance-row",children:[e.jsx("span",{className:"finance-label",children:"% of Total Timesheets"}),e.jsxs("span",{className:"finance-value",children:[a.pmoPercentage.toFixed(1),"%"]})]}),e.jsx("div",{className:"finance-pmo-bar",children:e.jsx("div",{className:"finance-pmo-bar-fill",style:{width:`${Math.min(a.pmoPercentage,100)}%`}})})]})]})]})}function Zi({refreshTrigger:i}){const r=be(),{projectId:t}=de(),[s,a]=d.useState(!0),[n,o]=d.useState([]),c=d.useCallback(async()=>{if(t){a(!0);try{const l=await zi.getAll(t,{orderBy:{column:"kpi_ref",ascending:!0}}),{data:u}=await g.from("deliverables").select(`
          id, status, is_deleted,
          deliverable_kpis(kpi_id)
        `).eq("project_id",t).or("is_deleted.is.null,is_deleted.eq.false"),{data:m}=await g.from("deliverable_kpi_assessments").select("kpi_id, deliverable_id, criteria_met"),h={};(m||[]).forEach(y=>{const b=`${y.deliverable_id}-${y.kpi_id}`;h[b]=y.criteria_met});const f=l.map(y=>{const b=(u||[]).filter(C=>C.deliverable_kpis?.some(R=>R.kpi_id===y.id)),p=b.length,_=b.filter(C=>C.status==="Submitted for Review").length,w=b.filter(C=>C.status==="Delivered").length;let k=0,S=0;b.filter(C=>C.status==="Delivered").forEach(C=>{const R=`${C.id}-${y.id}`;h[R]===!0?k++:h[R]===!1&&S++});const v=k+S,E=v>0?Math.round(k/v*100):null;return{id:y.id,ref:y.kpi_ref,name:y.name,total:p,submitted:_,validated:w,passed:k,failed:S,passRate:E}});o(f)}catch{}finally{a(!1)}}},[t]);return d.useEffect(()=>{c()},[c,i]),s?e.jsxs("div",{className:"metrics-cards-row",children:[e.jsxs("div",{className:"metrics-cards-header",children:[e.jsx(at,{size:18}),e.jsx("span",{children:"KPI Metrics"})]}),e.jsx("div",{className:"metrics-cards-container",children:[1,2,3,4,5].map(l=>e.jsx(Ot,{},l))})]}):n.length===0?null:e.jsxs("div",{className:"metrics-cards-row",children:[e.jsxs("div",{className:"metrics-cards-header",children:[e.jsx(at,{size:18}),e.jsx("span",{children:"KPI Metrics"})]}),e.jsx("div",{className:"metrics-cards-container",children:n.map(l=>e.jsxs("div",{className:"metrics-card kpi-card",onClick:()=>r(`/kpis/${l.id}`),children:[e.jsxs("div",{className:"metrics-card-header",children:[e.jsx("span",{className:"metrics-card-ref",children:l.ref}),e.jsx("span",{className:"metrics-card-name",title:l.name,children:l.name})]}),e.jsxs("div",{className:"metrics-card-stats",children:[e.jsxs("div",{className:"metrics-stat",children:[e.jsx("span",{className:"metrics-stat-value",children:l.total}),e.jsx("span",{className:"metrics-stat-label",children:"Deliverables"})]}),e.jsxs("div",{className:"metrics-stat",children:[e.jsx("span",{className:"metrics-stat-value",children:l.submitted}),e.jsx("span",{className:"metrics-stat-label",children:"Submitted"})]}),e.jsxs("div",{className:"metrics-stat",children:[e.jsx("span",{className:"metrics-stat-value",children:l.validated}),e.jsx("span",{className:"metrics-stat-label",children:"Validated"})]})]}),e.jsx("div",{className:"metrics-card-passrate",children:l.passRate!==null?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"passrate-bar",style:{background:`linear-gradient(to right, #16a34a ${l.passRate}%, #dc2626 ${l.passRate}%)`}}),e.jsxs("div",{className:"passrate-values",children:[e.jsxs("span",{className:"passrate-pass",children:[l.passed," Yes"]}),e.jsxs("span",{className:"passrate-percent",children:[l.passRate,"%"]}),e.jsxs("span",{className:"passrate-fail",children:[l.failed," No"]})]})]}):e.jsx("div",{className:"passrate-none",children:"No assessments yet"})})]},l.id))})]})}function eo({refreshTrigger:i}){const r=be(),{projectId:t}=de(),[s,a]=d.useState(!0),[n,o]=d.useState([]),c=d.useCallback(async()=>{if(t){a(!0);try{const l=await Vi.getAll(t,{orderBy:{column:"qs_ref",ascending:!0}}),{data:u}=await g.from("deliverables").select(`
          id, status, is_deleted,
          deliverable_quality_standards(quality_standard_id)
        `).eq("project_id",t).or("is_deleted.is.null,is_deleted.eq.false"),{data:m}=await g.from("deliverable_qs_assessments").select("quality_standard_id, deliverable_id, criteria_met"),h={};(m||[]).forEach(y=>{const b=`${y.deliverable_id}-${y.quality_standard_id}`;h[b]=y.criteria_met});const f=l.map(y=>{const b=(u||[]).filter(C=>C.deliverable_quality_standards?.some(R=>R.quality_standard_id===y.id)),p=b.length,_=b.filter(C=>C.status==="Submitted for Review").length,w=b.filter(C=>C.status==="Delivered").length;let k=0,S=0;b.filter(C=>C.status==="Delivered").forEach(C=>{const R=`${C.id}-${y.id}`;h[R]===!0?k++:h[R]===!1&&S++});const v=k+S,E=v>0?Math.round(k/v*100):null;return{id:y.id,ref:y.qs_ref,name:y.name,total:p,submitted:_,validated:w,passed:k,failed:S,passRate:E}});o(f)}catch{}finally{a(!1)}}},[t]);return d.useEffect(()=>{c()},[c,i]),s?e.jsxs("div",{className:"metrics-cards-row",children:[e.jsxs("div",{className:"metrics-cards-header",children:[e.jsx(Oe,{size:18}),e.jsx("span",{children:"Quality Standards Metrics"})]}),e.jsx("div",{className:"metrics-cards-container",children:[1,2,3,4,5].map(l=>e.jsx(Ot,{},l))})]}):n.length===0?null:e.jsxs("div",{className:"metrics-cards-row",children:[e.jsxs("div",{className:"metrics-cards-header",children:[e.jsx(Oe,{size:18}),e.jsx("span",{children:"Quality Standards Metrics"})]}),e.jsx("div",{className:"metrics-cards-container",children:n.map(l=>e.jsxs("div",{className:"metrics-card qs-card",onClick:()=>r(`/quality-standards/${l.id}`),children:[e.jsxs("div",{className:"metrics-card-header",children:[e.jsx("span",{className:"metrics-card-ref",children:l.ref}),e.jsx("span",{className:"metrics-card-name",title:l.name,children:l.name})]}),e.jsxs("div",{className:"metrics-card-stats",children:[e.jsxs("div",{className:"metrics-stat",children:[e.jsx("span",{className:"metrics-stat-value",children:l.total}),e.jsx("span",{className:"metrics-stat-label",children:"Deliverables"})]}),e.jsxs("div",{className:"metrics-stat",children:[e.jsx("span",{className:"metrics-stat-value",children:l.submitted}),e.jsx("span",{className:"metrics-stat-label",children:"Submitted"})]}),e.jsxs("div",{className:"metrics-stat",children:[e.jsx("span",{className:"metrics-stat-value",children:l.validated}),e.jsx("span",{className:"metrics-stat-label",children:"Validated"})]})]}),e.jsx("div",{className:"metrics-card-passrate",children:l.passRate!==null?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"passrate-bar",style:{background:`linear-gradient(to right, #16a34a ${l.passRate}%, #dc2626 ${l.passRate}%)`}}),e.jsxs("div",{className:"passrate-values",children:[e.jsxs("span",{className:"passrate-pass",children:[l.passed," Yes"]}),e.jsxs("span",{className:"passrate-percent",children:[l.passRate,"%"]}),e.jsxs("span",{className:"passrate-fail",children:[l.failed," No"]})]})]}):e.jsx("div",{className:"passrate-none",children:"No assessments yet"})})]},l.id))})]})}function to(){const{projectName:i,projectRef:r}=de(),{user:t}=ye(),[s,a]=d.useState(0),[n,o]=d.useState(!1),c=()=>{const u=new Date().getHours();return u<12?"Good morning":u<18?"Good afternoon":"Good evening"},l=d.useCallback(()=>{o(!0),a(u=>u+1),setTimeout(()=>o(!1),1e3)},[]);return e.jsxs("div",{className:"dashboard",children:[e.jsx("div",{className:"dashboard-header",children:e.jsxs("div",{className:"dashboard-header-content",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"dashboard-title",children:c()}),e.jsxs("p",{className:"dashboard-subtitle",children:[r," â€¢ ",i]})]}),e.jsxs("button",{className:"dashboard-refresh-btn",onClick:l,disabled:n,title:"Refresh all data",children:[e.jsx(Se,{size:18,className:n?"spinning":""}),"Refresh"]})]})}),e.jsxs("div",{className:"dashboard-content",children:[e.jsxs("div",{className:"dashboard-widgets",children:[e.jsx(Hi,{refreshTrigger:s}),e.jsx(Gi,{refreshTrigger:s}),e.jsx(Ki,{refreshTrigger:s}),e.jsx(Qi,{refreshTrigger:s})]}),e.jsx(Zi,{refreshTrigger:s}),e.jsx(eo,{refreshTrigger:s}),e.jsxs("div",{className:"dashboard-widgets-row",children:[e.jsx(Ji,{editable:!1,refreshTrigger:s}),e.jsx(Xi,{refreshTrigger:s})]})]})]})}const ro=d.lazy(()=>F(()=>import("./ResetPassword-DhiIig9Z.js"),__vite__mapDeps([0,1,2,3]))),so=d.lazy(()=>F(()=>import("./MobileChat-CTOGCrLc.js"),__vite__mapDeps([4,1,2,3,5]))),ao=d.lazy(()=>F(()=>import("./Milestones-CWxyNoYn.js"),__vite__mapDeps([6,1,7,2,8,9,10,3,11]))),no=d.lazy(()=>F(()=>import("./MilestoneDetail-DYfHqZVw.js"),__vite__mapDeps([12,1,7,2,13,8,9,10,3,14]))),io=d.lazy(()=>F(()=>import("./Gantt-zqwVrf9R.js"),__vite__mapDeps([15,1,2,3]))),oo=d.lazy(()=>F(()=>import("./Deliverables-BHHCWm3H.js"),__vite__mapDeps([16,1,10,2,7,8,13,3,17]))),lo=d.lazy(()=>F(()=>import("./Resources-DmRXLS7Q.js"),__vite__mapDeps([18,1,19,2,7,3,20]))),co=d.lazy(()=>F(()=>import("./ResourceDetail-Dozm-XIR.js"),__vite__mapDeps([21,1,19,2,22,23,3]))),uo=d.lazy(()=>F(()=>import("./Partners-WlR0dHot.js"),__vite__mapDeps([24,1,2,3,25]))),ho=d.lazy(()=>F(()=>import("./PartnerDetail-Dv_1otEX.js"),__vite__mapDeps([26,1,22,2,23,3]))),mo=d.lazy(()=>F(()=>import("./Timesheets-BFcXZdyx.js"),__vite__mapDeps([27,1,7,2,28,22,3,29]))),po=d.lazy(()=>F(()=>import("./Expenses-B6RQPOqH.js"),__vite__mapDeps([30,1,7,2,28,3,31]))),fo=d.lazy(()=>F(()=>import("./KPIs-B_SbuzUu.js"),__vite__mapDeps([32,1,7,2,3,33]))),go=d.lazy(()=>F(()=>import("./KPIDetail-C2QdyLYY.js"),__vite__mapDeps([34,1,2,3]))),yo=d.lazy(()=>F(()=>import("./QualityStandards-B8Nkn3Xu.js"),__vite__mapDeps([35,1,7,2,3,36]))),bo=d.lazy(()=>F(()=>import("./QualityStandardDetail-CK6L99ie.js"),__vite__mapDeps([37,1,2,3]))),xo=d.lazy(()=>F(()=>import("./RaidLog-BNjpdHnM.js"),__vite__mapDeps([38,1,7,2,3,39]))),wo=d.lazy(()=>F(()=>import("./Reports-CxS3LsSz.js"),__vite__mapDeps([40,2,1,3]))),vo=d.lazy(()=>F(()=>import("./Billing-BCTk8XNt.js"),__vite__mapDeps([41,1,42,2,3]))),_o=d.lazy(()=>F(()=>import("./Users-CZyUPie1.js"),__vite__mapDeps([43,1,7,2,3,44]))),So=d.lazy(()=>F(()=>import("./Settings-JbSs2FRs.js"),__vite__mapDeps([45,1,42,2,3]))),jo=d.lazy(()=>F(()=>import("./AccountSettings-Ev9k-z9i.js"),__vite__mapDeps([46,1,42,2,3]))),Co=d.lazy(()=>F(()=>import("./WorkflowSummary-CM2spcul.js"),__vite__mapDeps([47,1,23,42,2,3]))),ko=d.lazy(()=>F(()=>import("./AuditLog-jntQNjrC.js"),__vite__mapDeps([48,1,42,2,3]))),Eo=d.lazy(()=>F(()=>import("./DeletedItems-TlITAsZ7.js"),__vite__mapDeps([49,1,42,7,2,3]))),Ro=d.lazy(()=>F(()=>import("./Calendar-DoQRmw_B.js"),__vite__mapDeps([50,1,2,3,51]))),Po=d.lazy(()=>F(()=>import("./Variations-Dd5zDtcq.js"),__vite__mapDeps([52,1,8,2,3,53]))),No=d.lazy(()=>F(()=>import("./VariationDetail-BfTHa24p.js"),__vite__mapDeps([54,1,8,2,3,55]))),nr=d.lazy(()=>F(()=>import("./VariationForm-f8luhglc.js"),__vite__mapDeps([56,1,8,2,3,57])));function Ao(){return e.jsx("div",{className:"page-container",children:e.jsx(Re,{type:"page"})})}function U({children:i}){const{user:r,isLoading:t,mustChangePassword:s,clearMustChangePassword:a,profile:n}=ye();return t?e.jsx(nt,{message:"Loading...",size:"large",fullPage:!0}):r?s?e.jsx(bi,{userEmail:r?.email,onSuccess:a}):e.jsx(gi,{children:e.jsx(d.Suspense,{fallback:e.jsx(Ao,{}),children:i||e.jsx(js,{})})}):e.jsx(tt,{to:"/login",replace:!0})}function Do(){const{user:i,isLoading:r}=ye();return r?e.jsx(nt,{message:"Loading...",size:"large",fullPage:!0}):i?e.jsx(d.Suspense,{fallback:e.jsx(nt,{message:"Loading chat...",size:"large",fullPage:!0}),children:e.jsx(so,{})}):e.jsx(tt,{to:"/login",replace:!0})}function Io(){return e.jsx(_s,{children:e.jsx(Qa,{children:e.jsx(sn,{children:e.jsx(Ta,{children:e.jsx(Oa,{children:e.jsx(Ba,{children:e.jsx(Va,{children:e.jsx(ln,{children:e.jsx($a,{children:e.jsx(Ga,{children:e.jsxs(dn,{children:[e.jsxs(Ss,{children:[e.jsx(V,{path:"/login",element:e.jsx(xi,{})}),e.jsx(V,{path:"/reset-password",element:e.jsx(d.Suspense,{fallback:e.jsx(nt,{fullPage:!0}),children:e.jsx(ro,{})})}),e.jsx(V,{path:"/chat",element:e.jsx(Do,{})}),e.jsx(V,{path:"/",element:e.jsx(tt,{to:"/dashboard",replace:!0})}),e.jsx(V,{path:"/dashboard",element:e.jsx(U,{children:e.jsx(to,{})})}),e.jsx(V,{path:"/milestones",element:e.jsx(U,{children:e.jsx(ao,{})})}),e.jsx(V,{path:"/milestones/:id",element:e.jsx(U,{children:e.jsx(no,{})})}),e.jsx(V,{path:"/gantt",element:e.jsx(U,{children:e.jsx(io,{})})}),e.jsx(V,{path:"/deliverables",element:e.jsx(U,{children:e.jsx(oo,{})})}),e.jsx(V,{path:"/resources",element:e.jsx(U,{children:e.jsx(lo,{})})}),e.jsx(V,{path:"/resources/:id",element:e.jsx(U,{children:e.jsx(co,{})})}),e.jsx(V,{path:"/partners",element:e.jsx(U,{children:e.jsx(uo,{})})}),e.jsx(V,{path:"/partners/:id",element:e.jsx(U,{children:e.jsx(ho,{})})}),e.jsx(V,{path:"/timesheets",element:e.jsx(U,{children:e.jsx(mo,{})})}),e.jsx(V,{path:"/expenses",element:e.jsx(U,{children:e.jsx(po,{})})}),e.jsx(V,{path:"/kpis",element:e.jsx(U,{children:e.jsx(fo,{})})}),e.jsx(V,{path:"/kpis/:id",element:e.jsx(U,{children:e.jsx(go,{})})}),e.jsx(V,{path:"/quality-standards",element:e.jsx(U,{children:e.jsx(yo,{})})}),e.jsx(V,{path:"/quality-standards/:id",element:e.jsx(U,{children:e.jsx(bo,{})})}),e.jsx(V,{path:"/raid",element:e.jsx(U,{children:e.jsx(xo,{})})}),e.jsx(V,{path:"/calendar",element:e.jsx(U,{children:e.jsx(Ro,{})})}),e.jsx(V,{path:"/variations",element:e.jsx(U,{children:e.jsx(Po,{})})}),e.jsx(V,{path:"/variations/new",element:e.jsx(U,{children:e.jsx(nr,{})})}),e.jsx(V,{path:"/variations/:id",element:e.jsx(U,{children:e.jsx(No,{})})}),e.jsx(V,{path:"/variations/:id/edit",element:e.jsx(U,{children:e.jsx(nr,{})})}),e.jsx(V,{path:"/reports",element:e.jsx(U,{children:e.jsx(wo,{})})}),e.jsx(V,{path:"/billing",element:e.jsx(U,{children:e.jsx(vo,{})})}),e.jsx(V,{path:"/users",element:e.jsx(U,{children:e.jsx(_o,{})})}),e.jsx(V,{path:"/settings",element:e.jsx(U,{children:e.jsx(So,{})})}),e.jsx(V,{path:"/account",element:e.jsx(U,{children:e.jsx(jo,{})})}),e.jsx(V,{path:"/workflow-summary",element:e.jsx(U,{children:e.jsx(Co,{})})}),e.jsx(V,{path:"/audit-log",element:e.jsx(U,{children:e.jsx(ko,{})})}),e.jsx(V,{path:"/deleted-items",element:e.jsx(U,{children:e.jsx(Eo,{})})}),e.jsx(V,{path:"*",element:e.jsx(tt,{to:"/dashboard",replace:!0})})]}),e.jsx(yn,{}),e.jsx(wn,{}),e.jsx(vn,{}),e.jsx(va,{}),e.jsx(Na,{})]})})})})})})})})})})})}Ct.createRoot(document.getElementById("root")).render(e.jsx(lt.StrictMode,{children:e.jsx(Io,{})}));export{Ji as B,nt as L,Uo as S,Fo as T,ae as V,de as a,Ka as b,Pr as c,Yi as d,ys as e,Cr as f,zo as g,Qt as h,qe as i,e as j,zi as k,gs as l,Te as m,Xt as n,Wo as o,Bo as p,Vi as q,Vo as r,g as s,fs as t,ye as u,Lt as v,$o as w,Ho as x,H as y,Ve as z};
