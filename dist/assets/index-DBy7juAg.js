const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ResetPassword-B215VcLd.js","assets/vendor-react-BUTV5ZEl.js","assets/vendor-icons-L8EmaAR6.js","assets/vendor-supabase-6faYzd5A.js","assets/MobileChat-DIfs3btc.js","assets/MobileChat-DDcpgNUK.css","assets/Milestones-BwBqUi2d.js","assets/ConfirmDialog-C4qxA-j9.js","assets/formatters-BTbCMDgc.js","assets/milestoneCalculations-DrXGKoUD.js","assets/deliverableCalculations-DFwkFn9z.js","assets/Milestones-C3emWKZh.css","assets/MilestoneDetail-DCo1s97Q.js","assets/SignatureBox-DgDxG_4D.js","assets/MilestoneDetail-BJQ8Lfzq.css","assets/Gantt-BcTpt6T-.js","assets/Deliverables-DEmSmvd_.js","assets/Deliverables-CwUV7aHS.css","assets/Resources-bmKIikKg.js","assets/resourceCalculations-CZP_7DYg.js","assets/Resources-DqwAz4oE.css","assets/ResourceDetail-DlRPSAmv.js","assets/timesheetCalculations-xsKvrrM0.js","assets/StatCard-_BJ1UOu6.js","assets/Partners-D0iBZAYI.js","assets/Partners-gm1Px_xW.css","assets/PartnerDetail-5SNtC8vI.js","assets/Timesheets-gQ93gjEK.js","assets/PromptDialog-CFqJWDkF.js","assets/Timesheets-CGkpTkzM.css","assets/Expenses-CdNu6wWI.js","assets/Expenses-CkSEY-w5.css","assets/KPIs-DjDSS_OL.js","assets/KPIs-DqHNCrBk.css","assets/KPIDetail-BvZx_JQl.js","assets/QualityStandards-Big5QTZZ.js","assets/QualityStandards-BjfsOAnd.css","assets/QualityStandardDetail-CPyIeTqJ.js","assets/RaidLog-CKA-G02n.js","assets/RaidLog-C9AnKyu_.css","assets/Reports-Dg_48irU.js","assets/Billing-8gIitAbb.js","assets/PageHeader-DzE145Dy.js","assets/Users-A2064qKa.js","assets/Users-DDv0gteh.css","assets/Settings-BKz6uizZ.js","assets/AccountSettings-BsBeCrG3.js","assets/WorkflowSummary-B5-B3-Ag.js","assets/AuditLog-BgjvO8T9.js","assets/DeletedItems-jwwOsCNd.js","assets/Calendar-B4n8SQQ4.js","assets/Calendar-ClLQeHem.css","assets/Variations-BwwwVu6V.js","assets/Variations-hRqnt2v6.css","assets/VariationDetail-CtR8Ki6X.js","assets/VariationDetail-BwOUGiSl.css","assets/VariationForm-CwvEmUJS.js","assets/VariationForm-jOo1JwjG.css"])))=>i.map(i=>d[i]);
var Js=Object.defineProperty;var Zs=(n,t,e)=>t in n?Js(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var pt=(n,t,e)=>Zs(n,typeof t!="symbol"?t+"":t,e);import{r as u,b as ea,R as At,u as Zt,d as ke,L as Ft,e as ta,B as ra,f as sa,h as z,N as _t,O as aa}from"./vendor-react-BUTV5ZEl.js";import{c as na}from"./vendor-supabase-6faYzd5A.js";import{A as Qe,R as Me,C as ia,a as Lr,I as oa,X as Br,b as We,c as be,M as la,S as ca,B as Ot,D as da,T as ua,L as qr,U as ma,Z as dr,d as ha,e as Ue,f as pa,g as ur,h as ft,i as $r,j as fa,F as Je,k as ga,l as Ve,m as Wr,n as er,o as mt,p as _e,q as tr,P as St,r as mr,s as Ur,t as Vr,H as Ht,u as ya,E as ba,v as Lt,w as wa,x as jt,y as rr,G as va,z as xa,J as _a,K as Sa,N as ja,O as Ca,Q as sr,V as Ea,W as dt,Y as ar,_ as ka,$ as Ra,a0 as Aa,a1 as Ta,a2 as Da,a3 as Pa,a4 as hr,a5 as gt,a6 as Ma,a7 as Bt,a8 as Na,a9 as Ia,aa as pr,ab as Oa,ac as La,ad as zr,ae as Ba,af as qa,ag as $a}from"./vendor-icons-L8EmaAR6.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function e(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(a){if(a.ep)return;a.ep=!0;const i=e(a);fetch(a.href,i)}})();var Fr={exports:{}},Tt={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Wa=u,Ua=Symbol.for("react.element"),Va=Symbol.for("react.fragment"),za=Object.prototype.hasOwnProperty,Fa=Wa.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,Ha={key:!0,ref:!0,__self:!0,__source:!0};function Hr(n,t,e){var r,a={},i=null,o=null;e!==void 0&&(i=""+e),t.key!==void 0&&(i=""+t.key),t.ref!==void 0&&(o=t.ref);for(r in t)za.call(t,r)&&!Ha.hasOwnProperty(r)&&(a[r]=t[r]);if(n&&n.defaultProps)for(r in t=n.defaultProps,t)a[r]===void 0&&(a[r]=t[r]);return{$$typeof:Ua,type:n,key:i,ref:o,props:a,_owner:Fa.current}}Tt.Fragment=Va;Tt.jsx=Hr;Tt.jsxs=Hr;Fr.exports=Tt;var s=Fr.exports,Yt={},fr=ea;Yt.createRoot=fr.createRoot,Yt.hydrateRoot=fr.hydrateRoot;const Ya="modulepreload",Ga=function(n){return"/"+n},gr={},X=function(t,e,r){let a=Promise.resolve();if(e&&e.length>0){document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),c=o?.nonce||o?.getAttribute("nonce");a=Promise.allSettled(e.map(l=>{if(l=Ga(l),l in gr)return;gr[l]=!0;const d=l.endsWith(".css"),h=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${h}`))return;const m=document.createElement("link");if(m.rel=d?"stylesheet":Ya,d||(m.as="script"),m.crossOrigin="",m.href=l,c&&m.setAttribute("nonce",c),document.head.appendChild(m),d)return new Promise((p,y)=>{m.addEventListener("load",p),m.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${l}`)))})}))}function i(o){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=o,window.dispatchEvent(c),!c.defaultPrevented)throw o}return a.then(o=>{for(const c of o||[])c.status==="rejected"&&i(c.reason);return t().catch(i)})};var yr={},Ka="@vercel/analytics",Qa="1.6.1",Xa=()=>{window.va||(window.va=function(...t){(window.vaq=window.vaq||[]).push(t)})};function Yr(){return typeof window<"u"}function Gr(){try{const n="production"}catch{}return"production"}function Ja(n="auto"){if(n==="auto"){window.vam=Gr();return}window.vam=n}function Za(){return(Yr()?window.vam:Gr())||"production"}function Gt(){return Za()==="development"}function en(n){return n.scriptSrc?n.scriptSrc:Gt()?"https://va.vercel-scripts.com/v1/script.debug.js":n.basePath?`${n.basePath}/insights/script.js`:"/_vercel/insights/script.js"}function tn(n={debug:!0}){var t;if(!Yr())return;Ja(n.mode),Xa(),n.beforeSend&&((t=window.va)==null||t.call(window,"beforeSend",n.beforeSend));const e=en(n);if(document.head.querySelector(`script[src*="${e}"]`))return;const r=document.createElement("script");r.src=e,r.defer=!0,r.dataset.sdkn=Ka+(n.framework?`/${n.framework}`:""),r.dataset.sdkv=Qa,n.disableAutoTrack&&(r.dataset.disableAutoTrack="1"),n.endpoint?r.dataset.endpoint=n.endpoint:n.basePath&&(r.dataset.endpoint=`${n.basePath}/insights`),n.dsn&&(r.dataset.dsn=n.dsn),r.onerror=()=>{const a=Gt()?"Please check if any ad blockers are enabled and try again.":"Be sure to enable Web Analytics for your project and deploy again. See https://vercel.com/docs/analytics/quickstart for more information."},Gt()&&n.debug===!1&&(r.dataset.debug="false"),document.head.appendChild(r)}function rn({route:n,path:t}){var e;(e=window.va)==null||e.call(window,"pageview",{route:n,path:t})}function sn(){if(!(typeof process>"u"||typeof yr>"u"))return yr.REACT_APP_VERCEL_OBSERVABILITY_BASEPATH}function an(n){return u.useEffect(()=>{var t;n.beforeSend&&((t=window.va)==null||t.call(window,"beforeSend",n.beforeSend))},[n.beforeSend]),u.useEffect(()=>{tn({framework:n.framework||"react",basePath:n.basePath??sn(),...n.route!==void 0&&{disableAutoTrack:!0},...n})},[]),u.useEffect(()=>{n.route&&n.path&&rn({route:n.route,path:n.path})},[n.route,n.path]),null}var br={},nn="@vercel/speed-insights",on="1.3.1",ln=()=>{window.si||(window.si=function(...t){(window.siq=window.siq||[]).push(t)})};function cn(){return typeof window<"u"}function dn(){try{const n="production"}catch{}return"production"}function Kr(){return dn()==="development"}function un(n){return n.scriptSrc?n.scriptSrc:Kr()?"https://va.vercel-scripts.com/v1/speed-insights/script.debug.js":n.dsn?"https://va.vercel-scripts.com/v1/speed-insights/script.js":n.basePath?`${n.basePath}/speed-insights/script.js`:"/_vercel/speed-insights/script.js"}function mn(n={}){var t;if(!cn()||n.route===null)return null;ln();const e=un(n);if(document.head.querySelector(`script[src*="${e}"]`))return null;n.beforeSend&&((t=window.si)==null||t.call(window,"beforeSend",n.beforeSend));const r=document.createElement("script");return r.src=e,r.defer=!0,r.dataset.sdkn=nn+(n.framework?`/${n.framework}`:""),r.dataset.sdkv=on,n.sampleRate&&(r.dataset.sampleRate=n.sampleRate.toString()),n.route&&(r.dataset.route=n.route),n.endpoint?r.dataset.endpoint=n.endpoint:n.basePath&&(r.dataset.endpoint=`${n.basePath}/speed-insights/vitals`),n.dsn&&(r.dataset.dsn=n.dsn),Kr()&&n.debug===!1&&(r.dataset.debug="false"),r.onerror=()=>{},document.head.appendChild(r),{setRoute:a=>{r.dataset.route=a??void 0}}}function hn(){if(!(typeof process>"u"||typeof br>"u"))return br.REACT_APP_VERCEL_OBSERVABILITY_BASEPATH}function pn(n){u.useEffect(()=>{var e;n.beforeSend&&((e=window.si)==null||e.call(window,"beforeSend",n.beforeSend))},[n.beforeSend]);const t=u.useRef(null);return u.useEffect(()=>{if(t.current)n.route&&t.current(n.route);else{const e=mn({framework:n.framework??"react",basePath:n.basePath??hn(),...n});e&&(t.current=e.setRoute)}},[n.route]),null}const fn=void 0,gn=void 0;throw new Error("Missing Supabase environment variables");const f=na(fn,gn),Qr=u.createContext(null),yn=60*1e3,bn=5*60*1e3;function wn({children:n}){const[t,e]=u.useState(null),[r,a]=u.useState(null),[i,o]=u.useState(null),[c,l]=u.useState(!0),[d,h]=u.useState(null),[m,p]=u.useState(!1),[y,b]=u.useState(!1),g=u.useRef(null),_=u.useRef(Date.now()),v=u.useCallback(()=>{_.current=Date.now()},[]);async function E(j){if(!j){a(null),o(null),b(!1);return}try{const{data:A,error:U}=await f.from("profiles").select("*").eq("id",j.id).single();if(U){h(U);return}a(A),b(A?.must_change_password===!0);const{data:ae}=await f.from("resources").select("*").eq("user_id",j.id).maybeSingle();o(ae),h(null)}catch(A){h(A)}}const S=u.useCallback(async()=>{try{const{data:{session:j},error:A}=await f.auth.getSession();if(A)return;if(!j){await x();return}const U=j.expires_at*1e3,ae=Date.now(),ee=U-ae;if(ee<=0)await x();else if(ee<=bn){p(!0);const{data:ie,error:je}=await f.auth.refreshSession();je||!ie.session||p(!1)}else p(!1)}catch{}},[]);async function x(){e(null),a(null),o(null),p(!1),await f.auth.signOut();const j=window.location.pathname;j!=="/login"&&j!=="/register"&&(window.location.href="/login?expired=true")}const k=u.useCallback(()=>{g.current&&clearInterval(g.current),g.current=setInterval(()=>{S()},yn);const j=()=>{document.visibilityState==="visible"&&S()};document.addEventListener("visibilitychange",j);const A=["mousedown","keydown","touchstart","scroll"];return A.forEach(U=>{document.addEventListener(U,v,{passive:!0})}),()=>{g.current&&clearInterval(g.current),document.removeEventListener("visibilitychange",j),A.forEach(U=>{document.removeEventListener(U,v)})}},[S,v]);u.useEffect(()=>{let j=!0,A=null;async function U(){try{const{data:{session:ee},error:ie}=await f.auth.getSession();ie&&j&&h(ie),j&&(e(ee?.user??null),l(!1),ee?.user&&(E(ee.user),A=k()))}catch(ee){j&&(h(ee),l(!1))}}U();const{data:{subscription:ae}}=f.auth.onAuthStateChange(async(ee,ie)=>{j&&(e(ie?.user??null),l(!1),ie?.user?(E(ie.user),A&&A(),A=k()):(a(null),o(null),A&&(A(),A=null)),(ee==="SIGNED_OUT"||ee==="TOKEN_REFRESHED")&&p(!1))});return()=>{j=!1,ae.unsubscribe(),A&&A()}},[k]);async function C(){try{await f.auth.signOut(),e(null),a(null),o(null),p(!1)}catch(j){h(j)}}async function R(){t&&await E(t)}function M(){b(!1)}async function T(){try{const{data:j,error:A}=await f.auth.refreshSession();return A?!1:j.session?(p(!1),!0):!1}catch{return!1}}const I={user:t,profile:r,role:r?.role||"viewer",linkedResource:i,isLoading:c,error:d,signOut:C,refreshUserData:R,refreshSession:T,isAuthenticated:!!t,sessionExpiring:m,mustChangePassword:y,clearMustChangePassword:M};return s.jsx(Qr.Provider,{value:I,children:n})}function Ee(){const n=u.useContext(Qr);if(!n)throw new Error("useAuth must be used within an AuthProvider");return n}const Xr=u.createContext(null),qt="amsf_current_project_id";function vn({children:n}){const{user:t,isLoading:e}=Ee(),[r,a]=u.useState([]),[i,o]=u.useState(null),[c,l]=u.useState(!0),[d,h]=u.useState(null),m=u.useMemo(()=>!i||r.length===0?null:r.find(x=>x.project_id===i)||null,[i,r]),p=m?.project||null,y=m?.role||null,b=u.useCallback(async()=>{if(!t?.id){a([]),o(null),l(!1);return}l(!0),h(null);try{const{data:x,error:k}=await f.from("user_projects").select(`
          id,
          project_id,
          role,
          is_default,
          project:projects (
            id,
            name,
            reference,
            start_date,
            end_date,
            total_budget,
            allocated_days,
            expenses_budget,
            pmo_threshold,
            description
          )
        `).eq("user_id",t.id).order("is_default",{ascending:!1});if(k){h(k),l(!1);return}if(!x||x.length===0){a([]),o(null),h({message:"No projects assigned. Please contact your administrator."}),l(!1);return}const C=x.map(M=>({...M,project:M.project}));a(C);let R=null;try{const M=localStorage.getItem(qt);M&&C.find(I=>I.project_id===M)&&(R=M)}catch{}if(!R){const M=C.find(T=>T.is_default);M&&(R=M.project_id)}if(!R&&C.length>0&&(R=C[0].project_id),o(R),R)try{localStorage.setItem(qt,R)}catch{}}catch(x){h(x)}finally{l(!1)}},[t?.id]);u.useEffect(()=>{e||b()},[e,b]);const g=u.useCallback(x=>{if(!r.find(C=>C.project_id===x))return!1;o(x);try{localStorage.setItem(qt,x)}catch{}return!0},[r]),_=u.useCallback(async()=>{if(i)try{const{data:x,error:k}=await f.from("projects").select("*").eq("id",i).single();if(k){h(k);return}a(C=>C.map(R=>R.project_id===i?{...R,project:x}:R))}catch(x){h(x)}},[i]),v=u.useCallback(()=>b(),[b]),E=r.length>1,S=u.useMemo(()=>({currentProject:p,projectId:p?.id||null,projectRef:p?.reference||null,projectName:p?.name||null,projectRole:y,availableProjects:r,hasMultipleProjects:E,switchProject:g,isLoading:c||e,error:d,refreshProject:_,refreshProjectAssignments:v}),[p,y,r,E,g,c,e,d,_,v]);return s.jsx(Xr.Provider,{value:S,children:n})}function ye(){const n=u.useContext(Xr);if(!n)throw new Error("useProject must be used within a ProjectProvider");return n}const w={ADMIN:"admin",SUPPLIER_PM:"supplier_pm",CUSTOMER_PM:"customer_pm",CONTRIBUTOR:"contributor",VIEWER:"viewer"},xn=[w.ADMIN,w.SUPPLIER_PM,w.CUSTOMER_PM,w.CONTRIBUTOR,w.VIEWER],Ae=xn,me=[w.ADMIN,w.SUPPLIER_PM,w.CUSTOMER_PM],q=[w.ADMIN,w.SUPPLIER_PM],Fe=[w.ADMIN,w.CUSTOMER_PM],Le=[w.ADMIN,w.SUPPLIER_PM,w.CONTRIBUTOR],$t=[w.ADMIN],Jr={timesheets:{view:Ae,create:Le,createForOthers:q,edit:Le,delete:q,submit:Le,approve:Fe},expenses:{view:Ae,create:Le,createForOthers:q,edit:Le,delete:q,submit:Le,validateChargeable:Fe,validateNonChargeable:q},milestones:{view:Ae,create:q,edit:q,delete:$t,useGantt:q,editBilling:q},deliverables:{view:Ae,create:[...me,w.CONTRIBUTOR],edit:[...me,w.CONTRIBUTOR],delete:q,submit:Le,review:Fe,markDelivered:Fe},kpis:{view:Ae,create:q,edit:q,delete:q,manage:q},qualityStandards:{view:Ae,create:q,edit:q,delete:q,manage:q},raid:{view:Ae,create:me,edit:me,delete:q,manage:me,updateStatus:me,assignOwner:me},resources:{view:Ae,create:q,edit:q,delete:$t,manage:q,seeCostPrice:q,seeResourceType:q,seeMargins:q},partners:{view:q,create:q,edit:q,delete:q,manage:q},variations:{view:Ae,create:q,edit:q,delete:q,submit:q,signAsSupplier:q,signAsCustomer:Fe,reject:me,apply:q},certificates:{view:me,create:me,signAsSupplier:q,signAsCustomer:Fe},invoices:{view:me,generateCustomer:me,generateThirdParty:q,viewMargins:q},settings:{access:q,edit:q},users:{view:q,manage:$t},reports:{access:me,viewWorkflowSummary:me}};function D(n,t,e){const r=Jr[t];if(!r)return!1;const a=r[e];return a?a.includes(n):!1}const De={[w.ADMIN]:{label:"Admin",color:"#7c3aed",bg:"#f3e8ff"},[w.SUPPLIER_PM]:{label:"Supplier PM",color:"#059669",bg:"#d1fae5"},[w.CUSTOMER_PM]:{label:"Customer PM",color:"#d97706",bg:"#fef3c7"},[w.CONTRIBUTOR]:{label:"Contributor",color:"#2563eb",bg:"#dbeafe"},[w.VIEWER]:{label:"Viewer",color:"#64748b",bg:"#f1f5f9"}},_n=Object.entries(De).map(([n,t])=>({value:n,...t})),Zr=u.createContext(null),He="amsf_view_as_role",Sn=[w.ADMIN,w.SUPPLIER_PM],Wt=[{value:w.ADMIN,label:"Admin"},{value:w.SUPPLIER_PM,label:"Supplier PM"},{value:w.CUSTOMER_PM,label:"Customer PM"},{value:w.CONTRIBUTOR,label:"Contributor"},{value:w.VIEWER,label:"Viewer"}];function jn({children:n}){const{role:t,user:e}=Ee(),{projectRole:r,projectId:a}=ye(),[i,o]=u.useState(null),[c,l]=u.useState(!1),d=u.useMemo(()=>r||t||"viewer",[r,t]),h=u.useMemo(()=>Sn.includes(d),[d]);u.useEffect(()=>{if(!e){o(null),l(!0);return}try{const S=sessionStorage.getItem(He);S&&h&&(Wt.some(k=>k.value===S)?o(S):sessionStorage.removeItem(He))}catch{}l(!0)},[e,h]),u.useEffect(()=>{if(!h&&i){o(null);try{sessionStorage.removeItem(He)}catch{}}},[h,i]);const m=u.useCallback(S=>{if(!h)return;if(S===d||!S){o(null);try{sessionStorage.removeItem(He)}catch{}return}if(Wt.some(k=>k.value===S)){o(S);try{sessionStorage.setItem(He,S)}catch{}}},[h,d]),p=u.useCallback(()=>{o(null);try{sessionStorage.removeItem(He)}catch{}},[]),y=u.useMemo(()=>i&&h?i:d,[i,h,d]),b=u.useMemo(()=>i&&i!==d&&h,[i,d,h]),g=u.useMemo(()=>De[y]||De[w.VIEWER],[y]),_=u.useMemo(()=>De[d]||De[w.VIEWER],[d]),v=u.useMemo(()=>({globalRole:t,projectRole:r,projectId:a,actualRole:d,viewAsRole:i,effectiveRole:y,canUseViewAs:h,isImpersonating:b}),[t,r,a,d,i,y,h,b]),E={canUseViewAs:h,isInitialized:c,actualRole:d,effectiveRole:y,viewAsRole:i,globalRole:t,projectRole:r,isImpersonating:b,setViewAs:m,clearViewAs:p,effectiveRoleConfig:g,actualRoleConfig:_,availableRoles:Wt,debugInfo:v};return s.jsx(Zr.Provider,{value:E,children:n})}function Dt(){const n=u.useContext(Zr);if(!n)throw new Error("useViewAs must be used within a ViewAsProvider");return n}const es=u.createContext();function Cn({children:n}){const[t,e]=u.useState(!1),[r,a]=u.useState(null),[i,o]=u.useState([]);u.useEffect(()=>{c(),l()},[]);async function c(){const{data:{user:g}}=await f.auth.getUser();if(g){const{data:_}=await f.from("profiles").select("role").eq("id",g.id).single();_&&a(_.role)}}async function l(){const{data:g}=await f.from("profiles").select("id").eq("is_test_user",!0);g&&o(g.map(_=>_.id))}const d=r==="admin"||r==="supplier_pm";function h(){d&&e(g=>!g)}function m(g){return i.includes(g)}function p(g,_="user_id"){return!g||t?g:g.filter(v=>!i.includes(v[_]))}function y(g){return!g||t?g:g.filter(_=>!_.is_test_content)}const b={showTestUsers:t,setShowTestUsers:e,toggleTestUsers:h,canToggleTestUsers:d,testUserIds:i,isTestUser:m,filterTestContent:p,filterByTestFlag:y,userRole:r};return s.jsx(es.Provider,{value:b,children:n})}function ts(){const n=u.useContext(es);if(!n)throw new Error("useTestUsers must be used within a TestUserProvider");return n}const rs=u.createContext();function En(){return u.useContext(rs)}function kn({children:n}){const[t,e]=u.useState([]),[r,a]=u.useState(0),[i,o]=u.useState(0),[c,l]=u.useState(!0),[d,h]=u.useState(null),[m,p]=u.useState(null),y=k=>["admin","supplier_pm","customer_pm"].includes(k),b=u.useCallback(async(k,C)=>{try{let R=[];if(y(C)){const{data:M}=await f.from("timesheets").select("id, hours_worked, hours, work_date, date").eq("status","Submitted"),{data:T}=await f.from("expenses").select("id, amount, category, reason, resource_name, chargeable_to_customer").eq("status","Submitted"),{data:I}=await f.from("deliverables").select("id, name, deliverable_ref").eq("status","Submitted"),{data:j}=await f.from("milestone_certificates").select("id, milestone_id").eq("status","Submitted");M&&M.forEach(A=>{R.push({id:`ts-${A.id}`,type:"timesheet",notification_type:"action",title:"Timesheet Submitted",message:`Timesheet (${A.hours_worked||A.hours||0}h) pending approval`,action_url:"/timesheets",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1})}),T&&T.forEach(A=>{const U=A.chargeable_to_customer!==!1;R.push({id:`exp-${A.id}`,type:"expense",notification_type:"action",title:"Expense Submitted",message:`${A.resource_name||"Unknown"} expense (Â£${parseFloat(A.amount||0).toFixed(2)}) pending validation`,action_url:"/expenses",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1,isChargeable:U})}),I&&I.forEach(A=>{R.push({id:`del-${A.id}`,type:"deliverable",notification_type:"action",title:"Deliverable Submitted",message:`${A.deliverable_ref}: ${A.name} pending review`,action_url:"/deliverables",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1})}),j&&j.forEach(A=>{R.push({id:`cert-${A.id}`,type:"certificate",notification_type:"action",title:"Certificate Submitted",message:"Milestone certificate pending approval",action_url:"/milestones",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1})})}else{const{data:M}=await f.from("timesheets").select("id, hours_worked, hours, work_date, date, resource_id").eq("status","Submitted").eq("user_id",k),{data:T}=await f.from("expenses").select("id, amount, category, reason, resource_name").eq("status","Submitted").eq("created_by",k);M&&M.forEach(I=>{R.push({id:`ts-${I.id}`,type:"timesheet",notification_type:"action",title:"Timesheet Submitted",message:`Your timesheet for ${I.hours_worked||I.hours||0}h is pending approval`,action_url:"/timesheets",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1})}),T&&T.forEach(I=>{R.push({id:`exp-${I.id}`,type:"expense",notification_type:"action",title:"Expense Submitted",message:`Your expense (Â£${parseFloat(I.amount||0).toFixed(2)}) is pending validation`,action_url:"/expenses",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1})})}return{count:R.length,items:R}}catch{return{count:0,items:[]}}},[]),g=u.useCallback(async()=>{try{const{data:{user:k}}=await f.auth.getUser();if(!k){e([]),a(0),o(0),l(!1);return}h(k.id);const{data:C}=await f.from("profiles").select("role").eq("id",k.id).single(),R=C?.role||"viewer";p(R);const{count:M,items:T}=await b(k.id,R);e(T),a(M),o(M)}catch{}finally{l(!1)}},[b]),_=u.useCallback(async k=>{e(C=>C.map(R=>R.id===k?{...R,is_read:!0}:R)),a(C=>Math.max(0,C-1))},[]),v=u.useCallback(async k=>{e(C=>C.map(R=>R.id===k?{...R,is_actioned:!0,is_read:!0}:R)),a(C=>Math.max(0,C-1)),o(C=>Math.max(0,C-1))},[]),E=u.useCallback(async()=>{e(k=>k.map(C=>({...C,is_read:!0}))),a(0)},[]),S=u.useCallback(async k=>{const C=t.find(R=>R.id===k);C&&(e(R=>R.filter(M=>M.id!==k)),C.is_read||a(R=>Math.max(0,R-1)),C.notification_type==="action"&&!C.is_actioned&&o(R=>Math.max(0,R-1)))},[t]);u.useEffect(()=>{g();const k=setInterval(()=>{g()},3e4);return()=>clearInterval(k)},[g]),u.useEffect(()=>{const{data:{subscription:k}}=f.auth.onAuthStateChange((C,R)=>{C==="SIGNED_IN"?g():C==="SIGNED_OUT"&&(e([]),a(0),o(0),h(null),p(null))});return()=>k.unsubscribe()},[g]);const x={notifications:t,unreadCount:r,actionCount:i,loading:c,fetchNotifications:g,markAsRead:_,markAsActioned:v,markAllAsRead:E,dismissNotification:S};return s.jsx(rs.Provider,{value:x,children:n})}const ss=u.createContext(null),nr="amsf-chat-history",Rn=50,Ut={maxRetries:2,baseDelayMs:1e3,retryableCodes:[429,503,504]};function An(){try{const n=localStorage.getItem(nr);if(n){const t=JSON.parse(n);return{messages:t.messages||[],tokenUsage:t.tokenUsage||{input:0,output:0,requests:0}}}}catch{}return{messages:[],tokenUsage:{input:0,output:0,requests:0}}}function Tn(n,t){try{const e=n.slice(-Rn);localStorage.setItem(nr,JSON.stringify({messages:e,tokenUsage:t,savedAt:new Date().toISOString()}))}catch{}}function Dn({children:n}){const{user:t,profile:e,linkedResource:r,role:a}=Ee(),{projectId:i,projectName:o,projectRef:c,currentProject:l}=ye(),d=An(),[h,m]=u.useState(!1),[p,y]=u.useState(d.messages),[b,g]=u.useState(!1),[_,v]=u.useState(null),[E,S]=u.useState(0),[x,k]=u.useState(d.tokenUsage),[C,R]=u.useState(null),[M,T]=u.useState(!1),I=u.useRef(null),j=u.useRef(null);u.useEffect(()=>{(p.length>0||x.requests>0)&&Tn(p,x)},[p,x]),u.useEffect(()=>{if(!h||!i||j.current===i)return;(async()=>{T(!0);try{const Z={email:t?.email,role:a||e?.role,linkedResourceId:r?.id,partnerId:r?.partner_id},$=await fetch("/api/chat-context",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:i,userContext:Z})});if($.ok){const W=await $.json();R(W.context),j.current=i}}catch{}finally{T(!1)}})()},[h,i,t?.email,a,e?.role,r?.id,r?.partner_id]);const A=u.useCallback(()=>l?{id:i,reference:c||l?.reference,name:o||l?.name,description:l?.description||null}:null,[l,i,c,o]),U=u.useCallback(()=>({name:e?.full_name||t?.email?.split("@")[0]||"User",email:t?.email,role:a||e?.role||"unknown",linkedResourceName:r?.name||null,linkedResourceId:r?.id||null,partnerId:r?.partner_id||null,partnerName:r?.partners?.name||null}),[t,e,r,a]),ae=[{pattern:/^(what'?s?|how'?s?).*(budget|spend)/i,type:"budget"},{pattern:/budget.*(status|summary|overview)/i,type:"budget"},{pattern:/how much.*(spent|spend)/i,type:"budget"},{pattern:/^how many milestones/i,type:"milestoneCount"},{pattern:/milestone.*(count|total|how many)/i,type:"milestoneCount"},{pattern:/^how many deliverables/i,type:"deliverableCount"},{pattern:/deliverable.*(count|total|how many)/i,type:"deliverableCount"},{pattern:/^(what'?s?|how'?s?).*(pending|to.?do|actions?)/i,type:"pending"},{pattern:/what.*(need|should).*(do|action)/i,type:"pending"},{pattern:/^(project )?(status|overview|summary)$/i,type:"overview"},{pattern:/^how.*(project|things).*(going|doing)/i,type:"overview"}],ee=u.useCallback(G=>{if(!C)return null;const Z=G.toLowerCase().trim();let $=null;for(const{pattern:fe,type:ge}of ae)if(fe.test(Z)){$=ge;break}if(!$)return null;const W=C.budgetSummary,se=C.milestoneSummary,ne=C.deliverableSummary,te=C.pendingActions,oe=C.timesheetSummary,pe=fe=>`Â£${(fe||0).toLocaleString()}`;switch($){case"budget":return`**Project Budget Overview:**

â€¢ **Total Budget:** ${pe(W?.projectBudget)}
â€¢ **Milestone Billable:** ${pe(W?.milestoneBillable)}
â€¢ **Actual Spend:** ${pe(W?.actualSpend)}
â€¢ **Variance:** ${pe(W?.variance)}
â€¢ **Budget Used:** ${W?.percentUsed||0}%

${W?.percentUsed>80?"âš ï¸ Budget utilisation is over 80%.":W?.percentUsed>50?"Budget is tracking normally.":"Budget utilisation is healthy."}`;case"milestoneCount":return`There are **${se?.total||0} milestones** in total:

â€¢ Completed: ${se?.byStatus?.completed||0}
â€¢ In Progress: ${se?.byStatus?.inProgress||0}
â€¢ At Risk: ${se?.byStatus?.atRisk||0}
â€¢ Not Started: ${se?.byStatus?.notStarted||0}`;case"deliverableCount":return`There are **${ne?.total||0} deliverables** in total:

â€¢ Delivered: ${ne?.byStatus?.delivered||0}
â€¢ Review Complete: ${ne?.byStatus?.reviewComplete||0}
â€¢ Awaiting Review: ${ne?.byStatus?.awaitingReview||0}
â€¢ In Progress: ${ne?.byStatus?.inProgress||0}
â€¢ Not Started: ${ne?.byStatus?.notStarted||0}`;case"pending":if(!((te?.draftTimesheets||0)>0||(te?.awaitingValidation||0)>0))return"âœ… **No pending actions!** You're all caught up.";let ge=`**Your Pending Actions:**

`;return te?.draftTimesheets>0&&(ge+=`â€¢ **${te.draftTimesheets}** draft timesheet(s) to submit
`),te?.awaitingValidation>0&&(ge+=`â€¢ **${te.awaitingValidation}** item(s) awaiting your validation
`),ge;case"overview":return`**Project Overview:**

**Budget:** ${pe(W?.actualSpend)} of ${pe(W?.milestoneBillable)} spent (${W?.percentUsed||0}%)

**Milestones:** ${se?.byStatus?.completed||0} completed, ${se?.byStatus?.inProgress||0} in progress${se?.byStatus?.atRisk>0?`, ${se.byStatus.atRisk} at risk`:""}

**Deliverables:** ${ne?.byStatus?.delivered||0} delivered, ${ne?.byStatus?.awaitingReview||0} awaiting review

**Timesheets:** ${oe?.totalHours||0} hours logged

Need more details on any of these? Just ask!`;default:return null}},[C]),ie=async(G,Z=1)=>{I.current=new AbortController;try{const $=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(G),signal:I.current.signal}),W=await $.json().catch(()=>({}));if(!$.ok){if(Ut.retryableCodes.includes($.status)&&Z<=Ut.maxRetries&&W.recoverable!==!1){const ne=W.retryAfter?W.retryAfter*1e3:Ut.baseDelayMs*Math.pow(2,Z-1);return S(Z),await new Promise(te=>setTimeout(te,ne)),ie(G,Z+1)}throw new Error(W.error||`Request failed (${$.status})`)}return S(0),W}catch($){throw $.name==="AbortError"?new Error("Request cancelled"):$}},je=[/budget|spend|cost|variance/i,/milestone.*(status|progress|summary|count|how many)/i,/deliverable.*(status|progress|summary|count|how many)/i,/timesheet.*(summary|total|hours|count|how many)/i,/expense.*(summary|total|amount|count|how many)/i,/pending|action|todo|to do|what.*(do|need)/i,/overview|summary|status|dashboard/i,/how.*(doing|going|progress)/i],Ie=[/specific|detail|list|show me|find|search/i,/filter|between|from|to|date|week|month|year/i,/resource|person|team member|who/i,/partner|supplier/i,/compare|versus|vs/i,/kpi|quality|standard/i,/\d+/],O=G=>{if(!C)return!1;for(const Z of Ie)if(Z.test(G))return!1;for(const Z of je)if(Z.test(G))return!0;return!1},re=async(G,Z)=>{I.current=new AbortController;const $=await fetch("/api/chat-stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(G),signal:I.current.signal});if(!$.ok)throw new Error("Streaming request failed");const W=$.body.getReader(),se=new TextDecoder;let ne="";try{for(;;){const{done:te,value:oe}=await W.read();if(te)break;const pe=se.decode(oe,{stream:!0});ne+=pe,Z(ne)}}finally{W.releaseLock()}return ne},we=u.useCallback(async G=>{if(!G.trim()||b)return;I.current&&I.current.abort();const Z={role:"user",content:G.trim(),timestamp:new Date().toISOString()};y($=>[...$,Z]),g(!0),v(null),S(0);try{const $=ee(G.trim());if($){await new Promise(oe=>setTimeout(oe,100)),y(oe=>[...oe,{role:"assistant",content:$,toolsUsed:!1,cached:!1,local:!0,timestamp:new Date().toISOString()}]),g(!1);return}const W=A(),se=U();if(O(G)){const oe=p.length+1;y(pe=>[...pe,{role:"assistant",content:"",toolsUsed:!1,streaming:!0,timestamp:new Date().toISOString()}]);try{const pe=[...p.slice(-9),Z].map(fe=>({role:fe.role,content:fe.content}));await re({messages:pe,userContext:se,projectContext:W,prefetchedContext:C},fe=>{y(ge=>{const Re=[...ge],It=Re.length-1;return Re[It]?.role==="assistant"&&(Re[It]={...Re[It],content:fe}),Re})}),y(fe=>{const ge=[...fe],Re=ge.length-1;return ge[Re]?.role==="assistant"&&(ge[Re]={...ge[Re],streaming:!1}),ge}),g(!1);return}catch{y(fe=>fe.slice(0,-1))}}const ne=[...p.slice(-9),Z].map(oe=>({role:oe.role,content:oe.content})),te=await ie({messages:ne,projectContext:W,userContext:se,projectId:i,prefetchedContext:C});te.usage&&k(oe=>({input:oe.input+(te.usage.input_tokens||0),output:oe.output+(te.usage.output_tokens||0),requests:oe.requests+1})),y(oe=>[...oe,{role:"assistant",content:te.message,toolsUsed:te.toolsUsed||!1,cached:te.cached||!1,timestamp:new Date().toISOString(),tokens:te.usage?{input:te.usage.input_tokens,output:te.usage.output_tokens}:null}])}catch($){let W=$.message;$.message==="Request cancelled"?W=null:$.message.includes("Failed to fetch")&&(W="Unable to connect. Please check your internet connection."),W&&(v(W),y(se=>se.slice(0,-1)))}finally{g(!1),S(0)}},[p,b,A,U,i,C]),ue=u.useCallback(()=>{I.current&&(I.current.abort(),g(!1),S(0))},[]),Ce=u.useCallback(()=>{ue(),y([]),v(null),localStorage.removeItem(nr)},[ue]),N=u.useCallback(()=>{Ce(),k({input:0,output:0,requests:0})},[Ce]),J=u.useCallback(()=>{m(G=>!G)},[]),L=u.useCallback(()=>{v(null)},[]),F=u.useCallback(()=>{if(p.length===0)return null;const G=U(),Z=A();let $=`# Chat Export

`;return $+=`**Exported:** ${new Date().toLocaleString("en-GB")}
`,$+=`**User:** ${G.name} (${G.role})
`,Z&&($+=`**Project:** ${Z.name} (${Z.reference})
`),$+=`**Messages:** ${p.length}
`,$+=`**Token Usage:** ${x.input.toLocaleString()} input / ${x.output.toLocaleString()} output

`,$+=`---

`,p.forEach((W,se)=>{const ne=W.role==="user"?"ðŸ‘¤ You":"ðŸ¤– Assistant",te=W.timestamp?new Date(W.timestamp).toLocaleTimeString("en-GB"):"";$+=`### ${ne}${te?` (${te})`:""}

`,$+=`${W.content}

`,W.toolsUsed&&($+=`*ðŸ“Š Queried project data*

`),se<p.length-1&&($+=`---

`)}),$},[p,x,U,A]),Oe=u.useCallback(()=>{const G=F();if(!G)return;const Z=new Blob([G],{type:"text/markdown"}),$=URL.createObjectURL(Z),W=document.createElement("a");W.href=$,W.download=`chat-export-${new Date().toISOString().split("T")[0]}.md`,document.body.appendChild(W),W.click(),document.body.removeChild(W),URL.revokeObjectURL($)},[F]),et=u.useCallback(async G=>{try{return await navigator.clipboard.writeText(G),!0}catch{return!1}},[]),ht={isOpen:h,setIsOpen:m,toggleChat:J,messages:p,isLoading:b,isLoadingContext:M,error:_,retryCount:E,tokenUsage:x,sendMessage:we,clearChat:Ce,resetAllStats:N,cancelRequest:ue,dismissError:L,exportChat:F,downloadChat:Oe,copyMessage:et};return s.jsx(ss.Provider,{value:ht,children:n})}function Pn(){const n=u.useContext(ss);if(!n)throw new Error("useChat must be used within a ChatProvider");return n}class Mn extends At.Component{constructor(e){super(e);pt(this,"handleReload",()=>{window.location.reload()});pt(this,"handleReset",()=>{this.setState({hasError:!1,error:null,errorInfo:null})});this.state={hasError:!1,error:null,errorInfo:null}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,r){this.setState({errorInfo:r})}render(){return this.state.hasError?this.props.fallback?this.props.fallback:s.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"3rem",backgroundColor:"#fef2f2",borderRadius:"12px",margin:"1rem",border:"1px solid #fecaca"},children:[s.jsx(Qe,{size:48,style:{color:"#dc2626",marginBottom:"1rem"}}),s.jsx("h2",{style:{color:"#991b1b",margin:"0 0 0.5rem 0",fontSize:"1.25rem",fontWeight:"600"},children:"Something went wrong"}),s.jsx("p",{style:{color:"#64748b",margin:"0 0 1.5rem 0",textAlign:"center",maxWidth:"400px"},children:this.state.error?.message||"An unexpected error occurred. Please try again."}),s.jsxs("div",{style:{display:"flex",gap:"0.75rem"},children:[s.jsx("button",{onClick:this.handleReset,style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.625rem 1.25rem",backgroundColor:"white",color:"#374151",border:"1px solid #d1d5db",borderRadius:"8px",cursor:"pointer",fontSize:"0.875rem",fontWeight:"500"},children:"Try Again"}),s.jsxs("button",{onClick:this.handleReload,style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.625rem 1.25rem",backgroundColor:"#3b82f6",color:"white",border:"none",borderRadius:"8px",cursor:"pointer",fontSize:"0.875rem",fontWeight:"500"},children:[s.jsx(Me,{size:16}),"Reload Page"]})]})]}):this.props.children}}function Nn({error:n,resetError:t,title:e="Something went wrong",compact:r=!1}){const[a,i]=At.useState(!1);return r?s.jsxs("div",{style:{padding:"1rem",backgroundColor:"#fef2f2",border:"1px solid #fecaca",borderRadius:"8px",display:"flex",alignItems:"center",gap:"0.75rem"},children:[s.jsx(Qe,{size:18,style:{color:"#dc2626",flexShrink:0}}),s.jsx("span",{style:{color:"#991b1b",fontSize:"0.875rem",flex:1},children:"Failed to load this section"}),t&&s.jsxs("button",{onClick:t,style:{padding:"0.375rem 0.75rem",backgroundColor:"white",border:"1px solid #fecaca",borderRadius:"6px",cursor:"pointer",display:"flex",alignItems:"center",gap:"0.375rem",fontSize:"0.8125rem",color:"#dc2626"},children:[s.jsx(Me,{size:14}),"Retry"]})]}):s.jsxs("div",{style:{padding:"1.5rem",backgroundColor:"#fef2f2",border:"1px solid #fecaca",borderRadius:"12px",textAlign:"center"},children:[s.jsx("div",{style:{width:"48px",height:"48px",backgroundColor:"#fee2e2",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 1rem"},children:s.jsx(Qe,{size:24,style:{color:"#dc2626"}})}),s.jsx("h3",{style:{margin:"0 0 0.5rem",fontSize:"1.125rem",fontWeight:"600",color:"#991b1b"},children:e}),s.jsx("p",{style:{margin:"0 0 1rem",fontSize:"0.875rem",color:"#b91c1c"},children:"This section encountered an error and couldn't load."}),s.jsxs("div",{style:{display:"flex",gap:"0.75rem",justifyContent:"center"},children:[t&&s.jsxs("button",{onClick:t,style:{padding:"0.5rem 1rem",backgroundColor:"#dc2626",color:"white",border:"none",borderRadius:"8px",cursor:"pointer",display:"flex",alignItems:"center",gap:"0.5rem",fontSize:"0.875rem",fontWeight:"500"},children:[s.jsx(Me,{size:16}),"Try Again"]}),s.jsxs("button",{onClick:()=>i(!a),style:{padding:"0.5rem 1rem",backgroundColor:"white",color:"#991b1b",border:"1px solid #fecaca",borderRadius:"8px",cursor:"pointer",display:"flex",alignItems:"center",gap:"0.5rem",fontSize:"0.875rem"},children:[a?s.jsx(ia,{size:16}):s.jsx(Lr,{size:16}),a?"Hide Details":"Show Details"]})]}),a&&n&&s.jsx("div",{style:{marginTop:"1rem",padding:"1rem",backgroundColor:"#fee2e2",borderRadius:"8px",textAlign:"left",overflow:"auto",maxHeight:"200px"},children:s.jsxs("pre",{style:{margin:0,fontSize:"0.75rem",fontFamily:"monospace",color:"#7f1d1d",whiteSpace:"pre-wrap",wordBreak:"break-word"},children:[n.message,n.stack&&s.jsxs(s.Fragment,{children:[`

`,"Stack trace:",`
`,n.stack]})]})})]})}class Dc extends At.Component{constructor(e){super(e);pt(this,"resetError",()=>{this.setState({hasError:!1,error:null})});this.state={hasError:!1,error:null}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,r){this.props.onError&&this.props.onError(e,r)}render(){return this.state.hasError?this.props.fallback?typeof this.props.fallback=="function"?this.props.fallback({error:this.state.error,resetError:this.resetError}):this.props.fallback:s.jsx(Nn,{error:this.state.error,resetError:this.resetError,title:this.props.errorTitle,compact:this.props.compact}):this.props.children}}function Ct({message:n,size:t="medium",fullPage:e=!1,className:r=""}){const a={small:"spinner-sm",medium:"",large:"spinner-lg"};return s.jsxs("div",{className:`loading-spinner ${r}`,style:e?{minHeight:"60vh"}:void 0,children:[s.jsx("div",{className:`spinner ${a[t]}`}),n&&s.jsx("p",{className:"loading-text",children:n})]})}const In={background:"linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%)",backgroundSize:"200% 100%",animation:"shimmer 1.5s infinite"};function Y({width:n="100%",height:t="1rem",style:e={},className:r=""}){return s.jsxs(s.Fragment,{children:[s.jsx("style",{children:`
        @keyframes shimmer {
          0% { background-position: 200% 0; }
          100% { background-position: -200% 0; }
        }
      `}),s.jsx("div",{className:r,style:{width:n,height:t,borderRadius:"4px",...In,...e}})]})}function Kt({width:n="100%",lines:t=1}){return s.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"0.5rem"},children:Array.from({length:t}).map((e,r)=>s.jsx(Y,{width:r===t-1&&t>1?"70%":n,height:"1rem"},r))})}function On(){return s.jsxs("div",{style:{backgroundColor:"white",borderRadius:"12px",padding:"1.5rem",boxShadow:"0 1px 3px rgba(0,0,0,0.1)",display:"flex",alignItems:"center",gap:"1rem"},children:[s.jsx(Y,{width:"48px",height:"48px",style:{borderRadius:"12px"}}),s.jsxs("div",{style:{flex:1},children:[s.jsx(Y,{width:"60%",height:"0.875rem",style:{marginBottom:"0.5rem"}}),s.jsx(Y,{width:"40%",height:"1.5rem"})]})]})}function Ln({columns:n=6}){return s.jsx("tr",{children:Array.from({length:n}).map((t,e)=>s.jsx("td",{style:{padding:"0.75rem 1rem"},children:s.jsx(Y,{width:e===0?"80%":e===n-1?"60px":"70%",height:"1rem"})},e))})}function Vt({hasHeader:n=!0}){return s.jsxs("div",{style:{backgroundColor:"white",borderRadius:"12px",padding:"1.5rem",boxShadow:"0 1px 3px rgba(0,0,0,0.1)"},children:[n&&s.jsx(Y,{width:"40%",height:"1.5rem",style:{marginBottom:"1rem"}}),s.jsx(Kt,{lines:3})]})}function Xe({rows:n=4}){return s.jsxs("div",{style:{backgroundColor:"white",borderRadius:"12px",padding:"1.25rem",boxShadow:"0 1px 3px rgba(0,0,0,0.1)",border:"1px solid #e2e8f0"},children:[s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem",marginBottom:"1rem",paddingBottom:"0.75rem",borderBottom:"1px solid #f1f5f9"},children:[s.jsx(Y,{width:"32px",height:"32px",style:{borderRadius:"8px"}}),s.jsx(Y,{width:"100px",height:"1rem"}),s.jsx("div",{style:{marginLeft:"auto"},children:s.jsx(Y,{width:"60px",height:"0.875rem"})})]}),s.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"0.75rem"},children:Array.from({length:n}).map((t,e)=>s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem",padding:"0.5rem 0"},children:[s.jsx(Y,{width:"24px",height:"24px",style:{borderRadius:"6px"}}),s.jsx(Y,{width:`${60+Math.random()*30}%`,height:"0.875rem"}),s.jsx("div",{style:{marginLeft:"auto"},children:s.jsx(Y,{width:"30px",height:"1rem"})})]},e))})]})}function ir(){return s.jsxs("div",{style:{backgroundColor:"white",borderRadius:"12px",padding:"1rem 1.25rem",boxShadow:"0 1px 3px rgba(0,0,0,0.1)",border:"1px solid #e2e8f0",display:"flex",alignItems:"center",gap:"1rem"},children:[s.jsx(Y,{width:"40px",height:"40px",style:{borderRadius:"10px"}}),s.jsxs("div",{style:{flex:1},children:[s.jsx(Y,{width:"70%",height:"0.75rem",style:{marginBottom:"0.5rem"}}),s.jsx(Y,{width:"40%",height:"1.25rem"})]}),s.jsx(Y,{width:"50px",height:"1.5rem",style:{borderRadius:"6px"}})]})}function ct(){return s.jsxs("div",{style:{backgroundColor:"white",borderRadius:"12px",padding:"1.5rem",boxShadow:"0 1px 3px rgba(0,0,0,0.1)",border:"1px solid #e2e8f0"},children:[s.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"1.5rem"},children:[s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem"},children:[s.jsx(Y,{width:"32px",height:"32px",style:{borderRadius:"8px"}}),s.jsx(Y,{width:"120px",height:"1.25rem"})]}),s.jsx(Y,{width:"80px",height:"2rem",style:{borderRadius:"8px"}})]}),s.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:"1rem",marginBottom:"1.5rem"},children:Array.from({length:4}).map((n,t)=>s.jsxs("div",{style:{padding:"0.75rem",backgroundColor:"#f8fafc",borderRadius:"8px"},children:[s.jsx(Y,{width:"60%",height:"0.75rem",style:{marginBottom:"0.5rem"}}),s.jsx(Y,{width:"80%",height:"1.25rem"})]},t))}),s.jsx(Y,{width:"100%",height:"8px",style:{borderRadius:"4px"}})]})}function qe({type:n="text",count:t=1,...e}){return(()=>{switch(n){case"text":return s.jsx(Kt,{...e});case"stat-card":case"stats":return s.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:"1rem"},children:Array.from({length:t}).map((a,i)=>s.jsx(On,{},i))});case"table":return s.jsx("div",{className:"card",children:s.jsxs("table",{children:[s.jsx("thead",{children:s.jsx("tr",{children:Array.from({length:e.columns||6}).map((a,i)=>s.jsx("th",{style:{padding:"0.75rem 1rem"},children:s.jsx(Y,{width:"60%",height:"0.875rem"})},i))})}),s.jsx("tbody",{children:Array.from({length:e.rows||5}).map((a,i)=>s.jsx(Ln,{columns:e.columns||6},i))})]})});case"card":return s.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"1rem"},children:Array.from({length:t}).map((a,i)=>s.jsx(Vt,{...e},i))});case"widget":return s.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"1rem"},children:Array.from({length:t}).map((a,i)=>s.jsx(Xe,{rows:e.rows||4},i))});case"widget-grid":return s.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(280px, 1fr))",gap:"1rem"},children:Array.from({length:t}).map((a,i)=>s.jsx(Xe,{rows:e.rows||4},i))});case"metric-card":case"kpi":return s.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(250px, 1fr))",gap:"1rem"},children:Array.from({length:t}).map((a,i)=>s.jsx(ir,{},i))});case"finance-widget":return s.jsx(ct,{});case"dashboard":return s.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"1.5rem"},children:[s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[s.jsxs("div",{children:[s.jsx(Y,{width:"180px",height:"1.75rem",style:{marginBottom:"0.5rem"}}),s.jsx(Y,{width:"250px",height:"1rem"})]}),s.jsx(Y,{width:"100px",height:"40px",style:{borderRadius:"8px"}})]}),s.jsx(qe,{type:"widget-grid",count:4,rows:4}),s.jsx(qe,{type:"metric-card",count:5}),s.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[s.jsx(ct,{}),s.jsx(ct,{})]})]});case"page":return s.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"1.5rem"},children:[s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[s.jsxs("div",{children:[s.jsx(Y,{width:"200px",height:"1.75rem",style:{marginBottom:"0.5rem"}}),s.jsx(Y,{width:"300px",height:"1rem"})]}),s.jsx(Y,{width:"120px",height:"40px",style:{borderRadius:"8px"}})]}),s.jsx(qe,{type:"stats",count:4}),s.jsx(qe,{type:"table",rows:8,columns:6})]});case"detail":return s.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"1.5rem"},children:[s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"1rem"},children:[s.jsx(Y,{width:"80px",height:"36px",style:{borderRadius:"8px"}}),s.jsx(Y,{width:"250px",height:"1.75rem"})]}),s.jsx(qe,{type:"stats",count:4}),s.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[s.jsx(Vt,{}),s.jsx(Vt,{})]}),s.jsx(qe,{type:"table",rows:5,columns:5})]});default:return s.jsx(Kt,{...e})}})()}const wr={success:{icon:We,bgColor:"#dcfce7",borderColor:"#86efac",textColor:"#166534",iconColor:"#16a34a"},error:{icon:Br,bgColor:"#fee2e2",borderColor:"#fecaca",textColor:"#991b1b",iconColor:"#dc2626"},warning:{icon:Qe,bgColor:"#fef3c7",borderColor:"#fde68a",textColor:"#92400e",iconColor:"#d97706"},info:{icon:oa,bgColor:"#dbeafe",borderColor:"#93c5fd",textColor:"#1e40af",iconColor:"#3b82f6"}};function Bn({id:n,message:t,type:e="info",duration:r=4e3,onClose:a}){const i=wr[e]||wr.info,o=i.icon;return u.useEffect(()=>{if(r>0){const c=setTimeout(()=>{a(n)},r);return()=>clearTimeout(c)}},[n,r,a]),s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem",padding:"0.875rem 1rem",backgroundColor:i.bgColor,border:`1px solid ${i.borderColor}`,borderRadius:"8px",boxShadow:"0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)",minWidth:"300px",maxWidth:"450px",animation:"slideIn 0.3s ease-out"},children:[s.jsx(o,{size:20,style:{color:i.iconColor,flexShrink:0}}),s.jsx("span",{style:{color:i.textColor,fontSize:"0.875rem",fontWeight:"500",flex:1},children:t}),s.jsx("button",{onClick:()=>a(n),style:{background:"none",border:"none",cursor:"pointer",padding:"0.25rem",display:"flex",alignItems:"center",justifyContent:"center",color:i.textColor,opacity:.7,borderRadius:"4px"},onMouseEnter:c=>c.target.style.opacity=1,onMouseLeave:c=>c.target.style.opacity=.7,children:s.jsx(be,{size:16})})]})}function qn({toasts:n,removeToast:t}){return n.length===0?null:s.jsxs("div",{style:{position:"fixed",top:"1rem",right:"1rem",zIndex:9999,display:"flex",flexDirection:"column",gap:"0.5rem"},children:[s.jsx("style",{children:`
          @keyframes slideIn {
            from {
              transform: translateX(100%);
              opacity: 0;
            }
            to {
              transform: translateX(0);
              opacity: 1;
            }
          }
        `}),n.map(e=>s.jsx(Bn,{id:e.id,message:e.message,type:e.type,duration:e.duration,onClose:t},e.id))]})}const as=u.createContext(null),$n=4e3;function Wn({children:n}){const[t,e]=u.useState([]),r=u.useCallback(h=>{e(m=>m.filter(p=>p.id!==h))},[]),a=u.useCallback((h,m="info",p=$n)=>{const y=Date.now()+Math.random(),b={id:y,message:h,type:m,duration:p};return e(g=>[...g,b]),y},[]),i=u.useCallback((h,m)=>a(h,"success",m),[a]),o=u.useCallback((h,m)=>a(h,"error",m||6e3),[a]),c=u.useCallback((h,m)=>a(h,"warning",m),[a]),l=u.useCallback((h,m)=>a(h,"info",m),[a]),d={showToast:a,showSuccess:i,showError:o,showWarning:c,showInfo:l,removeToast:r};return s.jsxs(as.Provider,{value:d,children:[n,s.jsx(qn,{toasts:t,removeToast:r})]})}function ns(){const n=u.useContext(as);if(!n)throw new Error("useToast must be used within a ToastProvider");return n}const le={timesheets:{contributeToSpend:["Submitted","Validated","Approved"],excludeFromSpend:["Draft","Rejected"],completed:["Validated","Approved"]},expenses:{contributeToSpend:["Submitted","Validated","Approved"],excludeFromSpend:["Draft","Rejected"],completed:["Validated","Approved"]},deliverables:{contributeToKPIs:["Delivered"],contributeToQS:["Delivered"],inProgress:["In Progress","Submitted","Under Review"],completed:["Delivered"],notStarted:["Not Started","Draft"]},milestones:{completed:["Completed"],inProgress:["In Progress"],notStarted:["Not Started","Planned"]},kpis:{achieved:["Achieved","On Target"],atRisk:["At Risk","Amber"],failing:["Failing","Red","Off Target"]},qualityStandards:{achieved:["Achieved","Met"],partial:["Partial","In Progress"],notMet:["Not Met","Failed"]}},Un=["pmo","project manager","pm"];function lt(n){if(!n)return!1;const t=n.toLowerCase();return Un.some(e=>t.includes(e))}function vr(n){return n?le.timesheets.contributeToSpend.includes(n):!1}function xr(n){return n?le.expenses.contributeToSpend.includes(n):!1}const _r={defaultTarget:90,amberThreshold:10,calculationMethod:"assessment_based"},Vn={defaultTarget:100,calculationMethod:"assessment_based"},is={hoursPerDay:8,currency:"Â£",currencyCode:"GBP",decimalPlaces:2};function Ze(n){return(parseFloat(n)||0)/is.hoursPerDay}function or(n,t){return Ze(n)*(parseFloat(t)||0)}function Sr(n,t){return Ze(n)*(parseFloat(t)||0)}class zn{constructor(){this.cache=new Map,this.cacheTimeout=5e3}clearCache(){this.cache.clear()}getCached(t){const e=this.cache.get(t);return e&&Date.now()-e.timestamp<this.cacheTimeout?e.data:null}setCache(t,e){this.cache.set(t,{data:e,timestamp:Date.now()})}async getMilestoneMetrics(t){const e=`milestones_${t}`,r=this.getCached(e);if(r)return r;try{const{data:a,error:i}=await f.from("milestones").select("id, milestone_ref, name, status, progress, budget, percent_complete, is_deleted").eq("project_id",t).order("milestone_ref");if(i)throw i;const o=a?.filter(l=>l.is_deleted!==!0)||[],c={total:o.length,completed:o.filter(l=>le.milestones.completed.includes(l.status)).length,inProgress:o.filter(l=>le.milestones.inProgress.includes(l.status)).length,notStarted:o.filter(l=>le.milestones.notStarted.includes(l.status)).length,totalBudget:o.reduce((l,d)=>l+(d.budget||0),0),averageProgress:o.length>0?Math.round(o.reduce((l,d)=>l+(d.progress||0),0)/o.length):0,milestones:o};return this.setCache(e,c),c}catch(a){throw a}}async getDeliverableMetrics(t,e=!1){const r=`deliverables_${t}_${e}`,a=this.getCached(r);if(a)return a;try{const{data:i,error:o}=await f.from("deliverables").select("id, deliverable_ref, name, status, due_date, milestone_id, is_deleted, is_test_content").eq("project_id",t).order("deliverable_ref");if(o)throw o;let c=i?.filter(p=>p.is_deleted!==!0)||[];e||(c=c.filter(p=>p.is_test_content!==!0));const l=new Date().toISOString().split("T")[0],d=new Date;d.setDate(d.getDate()+7);const h=d.toISOString().split("T")[0],m={total:c.length,delivered:c.filter(p=>le.deliverables.completed.includes(p.status)).length,inProgress:c.filter(p=>le.deliverables.inProgress.includes(p.status)).length,notStarted:c.filter(p=>le.deliverables.notStarted.includes(p.status)).length,overdue:c.filter(p=>p.due_date<l&&!le.deliverables.completed.includes(p.status)).length,dueThisWeek:c.filter(p=>p.due_date>=l&&p.due_date<=h&&!le.deliverables.completed.includes(p.status)).length,deliverables:c};return m.completionPercent=m.total>0?Math.round(m.delivered/m.total*100):0,this.setCache(r,m),m}catch(i){throw i}}async getKPIMetrics(t){const e=`kpis_${t}`,r=this.getCached(e);if(r)return r;try{const{data:a,error:i}=await f.from("kpis").select("id, kpi_ref, name, category, target, current_value, is_deleted").eq("project_id",t).order("kpi_ref");if(i)throw i;const o=a?.filter(b=>b.is_deleted!==!0)||[],{data:c,error:l}=await f.from("deliverable_kpi_assessments").select(`
          kpi_id,
          criteria_met,
          deliverables!inner(id, status, is_deleted, project_id)
        `).eq("deliverables.project_id",t),d=c?.filter(b=>b.deliverables?.is_deleted!==!0&&le.deliverables.contributeToKPIs.includes(b.deliverables?.status))||[],h=new Map;d&&d.length>0&&d.forEach(b=>{h.has(b.kpi_id)||h.set(b.kpi_id,{total:0,met:0});const g=h.get(b.kpi_id);g.total++,b.criteria_met&&g.met++});const m=o.map(b=>{const g=h.get(b.id);let _=0;g&&g.total>0&&(_=Math.round(g.met/g.total*100));const v=b.target||_r.defaultTarget,E=_>=v;return{...b,calculatedValue:_,assessmentCount:g?.total||0,assessmentsMet:g?.met||0,isAchieved:E,ragStatus:_>=v?"Green":_>=v*(1-_r.amberThreshold/100)?"Amber":"Red"}}),p={};m.forEach(b=>{const g=b.category||"Other";p[g]||(p[g]=[]),p[g].push(b)});const y={total:o.length,achieved:m.filter(b=>b.isAchieved).length,atRisk:m.filter(b=>b.ragStatus==="Amber").length,failing:m.filter(b=>b.ragStatus==="Red").length,achievementPercent:o.length>0?Math.round(m.filter(b=>b.isAchieved).length/o.length*100):0,byCategory:p,kpis:m};return this.setCache(e,y),y}catch(a){throw a}}async getQualityStandardMetrics(t){const e=`qs_${t}`,r=this.getCached(e);if(r)return r;try{const{data:a,error:i}=await f.from("quality_standards").select("id, qs_ref, name, target, current_value, is_deleted").eq("project_id",t).order("qs_ref");if(i)throw i;const o=a?.filter(y=>y.is_deleted!==!0)||[],{data:c,error:l}=await f.from("deliverable_qs_assessments").select(`
          quality_standard_id,
          criteria_met,
          deliverables!inner(id, status, is_deleted, project_id)
        `).eq("deliverables.project_id",t),d=c?.filter(y=>y.deliverables?.is_deleted!==!0&&le.deliverables.contributeToQS.includes(y.deliverables?.status))||[],h=new Map;d&&d.length>0&&d.forEach(y=>{h.has(y.quality_standard_id)||h.set(y.quality_standard_id,{total:0,met:0});const b=h.get(y.quality_standard_id);b.total++,y.criteria_met&&b.met++});const m=o.map(y=>{const b=h.get(y.id);let g=0;b&&b.total>0&&(g=Math.round(b.met/b.total*100));const _=y.target||Vn.defaultTarget,v=g>=_;return{...y,calculatedValue:g,assessmentCount:b?.total||0,assessmentsMet:b?.met||0,isAchieved:v}}),p={total:o.length,achieved:m.filter(y=>y.isAchieved).length,partial:m.filter(y=>y.calculatedValue>0&&!y.isAchieved).length,notMet:m.filter(y=>y.calculatedValue===0).length,achievementPercent:o.length>0?Math.round(m.filter(y=>y.isAchieved).length/o.length*100):0,qualityStandards:m};return this.setCache(e,p),p}catch(a){throw a}}async getTimesheetMetrics(t,e=!1){const r=`timesheets_${t}_${e}`,a=this.getCached(r);if(a)return a;try{const{data:i,error:o}=await f.from("timesheets").select(`
          id, date, hours_worked, hours, status, milestone_id, resource_id, is_deleted,
          resources(id, name, role, sell_price)
        `).eq("project_id",t);if(o)throw o;const c=i?.filter(g=>g.is_deleted!==!0)||[];let l=0,d=0,h=0,m=0;const p={},y={};c.forEach(g=>{const _=parseFloat(g.hours_worked||g.hours||0),v=g.resources,E=v?.sell_price||0,S=_/is.hoursPerDay*E;vr(g.status)&&(l+=_,d+=S,lt(v?.role)?h+=S:m+=S,g.milestone_id&&(p[g.milestone_id]=(p[g.milestone_id]||0)+S),g.resource_id&&(y[g.resource_id]=(y[g.resource_id]||0)+S))});const b={totalEntries:c.length,validEntries:c.filter(g=>vr(g.status)).length,draftEntries:c.filter(g=>g.status==="Draft").length,rejectedEntries:c.filter(g=>g.status==="Rejected").length,totalHours:l,totalSpend:d,pmoSpend:h,deliverySpend:m,spendByMilestone:p,spendByResource:y};return this.setCache(r,b),b}catch(i){throw i}}async getExpenseMetrics(t,e=!1){const r=`expenses_${t}_${e}`,a=this.getCached(r);if(a)return a;try{const{data:i,error:o}=await f.from("expenses").select("id, expense_date, amount, status, category, chargeable_to_customer, procurement_method, is_deleted").eq("project_id",t);if(o)throw o;const c=i?.filter(y=>y.is_deleted!==!0)||[];let l=0,d=0,h=0;const m={};c.forEach(y=>{const b=parseFloat(y.amount||0);if(xr(y.status)){l+=b,y.chargeable_to_customer?d+=b:h+=b;const g=y.category||"Other";m[g]=(m[g]||0)+b}});const p={totalEntries:c.length,validEntries:c.filter(y=>xr(y.status)).length,draftEntries:c.filter(y=>y.status==="Draft").length,rejectedEntries:c.filter(y=>y.status==="Rejected").length,totalAmount:l,chargeableAmount:d,nonChargeableAmount:h,byCategory:m};return this.setCache(r,p),p}catch(i){throw i}}async getResourceMetrics(t){const e=`resources_${t}`,r=this.getCached(e);if(r)return r;try{const{data:a,error:i}=await f.from("resources").select("id, name, role, sell_price, days_allocated, is_deleted").eq("project_id",t);if(i)throw i;const o=a?.filter(h=>h.is_deleted!==!0)||[];let c=0,l=0;o.forEach(h=>{const m=(h.sell_price||0)*(h.days_allocated||0);lt(h.role)?c+=m:l+=m});const d={total:o.length,pmoCount:o.filter(h=>lt(h.role)).length,deliveryCount:o.filter(h=>!lt(h.role)).length,pmoBudget:c,deliveryBudget:l,totalBudget:c+l,resources:o};return this.setCache(e,d),d}catch(a){throw a}}async getCertificateMetrics(t){const e=`certificates_${t}`,r=this.getCached(e);if(r)return r;try{const{data:a,error:i}=await f.from("milestone_certificates").select("id, milestone_id, status").eq("project_id",t);if(i)throw i;const o=await this.getMilestoneMetrics(t),c={total:a?.length||0,signed:a?.filter(l=>l.status==="Signed").length||0,pending:a?.filter(l=>l.status==="Pending Customer Signature"||l.status==="Pending Supplier Signature").length||0,awaitingGeneration:Math.max(0,o.completed-(a?.length||0))};return this.setCache(e,c),c}catch(a){throw a}}async getAllDashboardMetrics(t,e={}){const{includeTestContent:r=!1}=e;try{const[a,i,o,c,l,d,h,m]=await Promise.all([this.getMilestoneMetrics(t),this.getDeliverableMetrics(t,r),this.getKPIMetrics(t),this.getQualityStandardMetrics(t),this.getTimesheetMetrics(t,r),this.getExpenseMetrics(t,r),this.getResourceMetrics(t),this.getCertificateMetrics(t)]),p={totalBudget:a.totalBudget,timesheetSpend:l.totalSpend,expenseSpend:d.totalAmount,totalSpend:l.totalSpend+d.totalAmount,pmoBudget:h.pmoBudget,pmoSpend:l.pmoSpend,deliveryBudget:h.deliveryBudget,deliverySpend:l.deliverySpend,utilizationPercent:a.totalBudget>0?Math.round((l.totalSpend+d.totalAmount)/a.totalBudget*100):0},y={...l.spendByMilestone};return Object.entries(d.byMilestone).forEach(([b,g])=>{y[b]=(y[b]||0)+g}),{milestones:a,deliverables:i,kpis:o,qualityStandards:c,timesheets:l,expenses:d,resources:h,certificates:m,budget:p,milestoneSpend:y,projectProgress:a.averageProgress,lastUpdated:new Date().toISOString()}}catch(a){throw a}}}const ve=new zn,os=u.createContext(null);function Fn({children:n}){const{projectId:t}=ye(),{showTestUsers:e}=ts(),[r,a]=u.useState(null),[i,o]=u.useState(!0),[c,l]=u.useState(null),[d,h]=u.useState(null),m=u.useCallback(async(b=!1)=>{if(!t){a(null),o(!1);return}b&&ve.clearCache(),o(!0),l(null);try{const g=await ve.getAllDashboardMetrics(t,{includeTestContent:e});a(g),h(new Date)}catch(g){l(g.message||"Failed to load metrics")}finally{o(!1)}},[t,e]),p=u.useCallback(async b=>{if(t)try{let g;switch(b){case"milestones":g=await ve.getMilestoneMetrics(t),a(_=>_?{..._,milestones:g}:null);break;case"deliverables":g=await ve.getDeliverableMetrics(t,e),a(_=>_?{..._,deliverables:g}:null);break;case"kpis":g=await ve.getKPIMetrics(t),a(_=>_?{..._,kpis:g}:null);break;case"qualityStandards":g=await ve.getQualityStandardMetrics(t),a(_=>_?{..._,qualityStandards:g}:null);break;case"timesheets":g=await ve.getTimesheetMetrics(t,e),a(_=>_?{..._,timesheets:g}:null);break;case"expenses":g=await ve.getExpenseMetrics(t,e),a(_=>_?{..._,expenses:g}:null);break;case"resources":g=await ve.getResourceMetrics(t),a(_=>_?{..._,resources:g}:null);break;case"certificates":g=await ve.getCertificateMetrics(t),a(_=>_?{..._,certificates:g}:null);break;default:await m(!0)}h(new Date)}catch{}},[t,e,m]);u.useEffect(()=>{m()},[m]);const y=u.useMemo(()=>({metrics:r,milestones:r?.milestones||null,deliverables:r?.deliverables||null,kpis:r?.kpis||null,qualityStandards:r?.qualityStandards||null,timesheets:r?.timesheets||null,expenses:r?.expenses||null,resources:r?.resources||null,certificates:r?.certificates||null,billable:r?.billable||null,milestoneSpend:r?.milestoneSpend||{},projectProgress:r?.projectProgress||0,loading:i,error:c,lastRefresh:d,refreshMetrics:()=>m(!0),refreshCategory:p,clearCache:()=>ve.clearCache()}),[r,i,c,d,m,p]);return s.jsx(os.Provider,{value:y,children:n})}function Pc(){const n=u.useContext(os);if(!n)throw new Error("useMetrics must be used within a MetricsProvider");return n}const ls=u.createContext(null),jr={"/":"dashboard","/dashboard":"dashboard","/milestones":"milestones","/deliverables":"deliverables","/resources":"resources","/timesheets":"timesheets","/expenses":"expenses","/partners":"partners","/kpis":"kpis","/quality-standards":"qualityStandards","/raid-log":"raidLog","/users":"users","/settings":"general","/account":"general"};function Hn(n){return jr[n]?jr[n]:n.startsWith("/milestones/")?"milestoneDetail":n.startsWith("/deliverables/")?"deliverableDetail":n.startsWith("/resources/")?"resources":n.startsWith("/partners/")?"partners":n.startsWith("/kpis/")?"kpis":n.startsWith("/quality-standards/")?"qualityStandards":"general"}function Yn({children:n}){const[t,e]=u.useState(!1),[r,a]=u.useState("general"),i=Zt();u.useEffect(()=>{const m=Hn(i.pathname);a(m)},[i.pathname]),u.useEffect(()=>{function m(p){p.target.tagName==="INPUT"||p.target.tagName==="TEXTAREA"||p.target.isContentEditable||((p.key==="?"||p.key==="F1")&&(p.preventDefault(),e(y=>!y)),p.key==="Escape"&&t&&e(!1))}return window.addEventListener("keydown",m),()=>window.removeEventListener("keydown",m)},[t]);const o=u.useCallback((m=null)=>{m&&a(m),e(!0)},[]),c=u.useCallback(()=>{e(!1)},[]),l=u.useCallback(()=>{e(m=>!m)},[]),d=u.useCallback(m=>{a(m)},[]),h={isOpen:t,currentTopic:r,openHelp:o,closeHelp:c,toggleHelp:l,navigateToTopic:d};return s.jsx(ls.Provider,{value:h,children:n})}function cs(){const n=u.useContext(ls);if(!n)throw new Error("useHelp must be used within a HelpProvider");return n}function Gn(n,t,e={}){const r=[{text:"What do I need to do?",category:"actions"},{text:"What's the project status?",category:"overview"}],a=Kn(n,t),i=Qn(t,e),o=[...a,...i,...r],c=new Set;return o.filter(l=>{const d=l.text.toLowerCase();return c.has(d)?!1:(c.add(d),!0)}).slice(0,5)}function Kn(n,t){const e=n.toLowerCase().replace(/\/+$/,"");if(e==="/dashboard"||e==="")return[{text:"What milestones are at risk?",category:"milestones"},{text:"Show budget status",category:"budget"},{text:"What's overdue?",category:"overview"}];if(e==="/milestones"||e.startsWith("/milestones/"))return[{text:"Which milestones are at risk?",category:"milestones"},{text:"What milestones are due this month?",category:"milestones"},{text:"Show milestone progress summary",category:"milestones"},{text:"List overdue milestones",category:"milestones"}];if(e==="/deliverables")return[{text:"What deliverables are awaiting review?",category:"deliverables"},{text:"Show overdue deliverables",category:"deliverables"},{text:"List deliverables by milestone",category:"deliverables"},{text:"What's the deliverable completion rate?",category:"deliverables"}];if(e==="/timesheets"){const r=[{text:"Show my timesheets this month",category:"timesheets"},{text:"How many hours have I logged?",category:"timesheets"},{text:"Show timesheets pending validation",category:"timesheets"}];return["admin","supplier_pm","customer_pm"].includes(t)&&(r.push({text:"Show all submitted timesheets",category:"timesheets"}),r.push({text:"Hours by resource this month",category:"timesheets"})),r}if(e==="/expenses"){const r=[{text:"Show my expenses this month",category:"expenses"},{text:"What expenses are pending validation?",category:"expenses"}];return["admin","supplier_pm"].includes(t)&&(r.push({text:"Show all submitted expenses",category:"expenses"}),r.push({text:"Expenses by category",category:"expenses"}),r.push({text:"Total chargeable expenses",category:"expenses"})),r}return e==="/resources"||e.startsWith("/resources/")?[{text:"Show resource utilization",category:"resources"},{text:"Who's working on what?",category:"resources"},{text:"List resources by partner",category:"resources"}]:e==="/partners"||e.startsWith("/partners/")?[{text:"Show partner spend breakdown",category:"partners"},{text:"List active partners",category:"partners"},{text:"Partner hours this month",category:"partners"}]:e==="/kpis"||e.startsWith("/kpis/")?[{text:"Which KPIs are at risk?",category:"kpis"},{text:"Show KPI trends",category:"kpis"},{text:"KPI summary by status",category:"kpis"}]:e==="/raid"?[{text:"Show open risks",category:"raid"},{text:"What issues need attention?",category:"raid"},{text:"List high-priority risks",category:"raid"},{text:"Show assumptions that need validation",category:"raid"}]:e==="/quality-standards"||e.startsWith("/quality-standards/")?[{text:"Which quality standards need attention?",category:"quality"},{text:"Show quality compliance summary",category:"quality"}]:e==="/gantt"?[{text:"Show critical path",category:"timeline"},{text:"What's the project timeline?",category:"timeline"},{text:"List upcoming milestones",category:"milestones"}]:e==="/workflow-summary"?[{text:"What needs my approval?",category:"workflow"},{text:"Show pending submissions",category:"workflow"},{text:"List items awaiting validation",category:"workflow"}]:[{text:"What's the budget status?",category:"budget"},{text:"Show project overview",category:"overview"}]}function Qn(n,t={}){switch(n){case"admin":case"supplier_pm":return[{text:"What needs validation?",category:"workflow"},{text:"Show budget vs actual spend",category:"budget"},{text:"Resource utilization this month",category:"resources"}];case"customer_pm":return[{text:"What deliverables need review?",category:"deliverables"},{text:"Show milestone status",category:"milestones"},{text:"What's pending my approval?",category:"workflow"}];case"contributor":return[{text:"Show my pending timesheets",category:"timesheets"},{text:"My tasks this week",category:"tasks"},{text:"What have I submitted?",category:"workflow"}];case"viewer":default:return[{text:"Project overview",category:"overview"},{text:"Show dashboard summary",category:"overview"}]}}function Xn(n){if(!n)return!1;const t=n.toLowerCase();return[/this (week|month|quarter|year)/i,/last (week|month|quarter|year)/i,/(january|february|march|april|may|june|july|august|september|october|november|december)/i,/q[1-4]/i,/\d{4}/,/past \d+ (day|week|month)/i,/(from|between|since|until|before|after)/i,/when|date|period|time(frame|line)?/i].some(r=>r.test(t))}function Cr(n){if(!n)return null;const t=n.toLowerCase().trim(),e=new Date;e.setHours(0,0,0,0);const r=v=>{const E=new Date(v),S=E.getDay(),x=E.getDate()-S+(S===0?-6:1);return E.setDate(x),E},a=v=>new Date(v.getFullYear(),v.getMonth(),1),i=v=>new Date(v.getFullYear(),v.getMonth()+1,0),o=v=>{const E=Math.floor(v.getMonth()/3);return new Date(v.getFullYear(),E*3,1)},c=v=>{const E=Math.floor(v.getMonth()/3);return new Date(v.getFullYear(),(E+1)*3,0)},l=v=>new Date(v.getFullYear(),0,1),d=v=>new Date(v.getFullYear(),11,31);if(/^today$/i.test(t))return{start:e,end:e,label:"Today"};if(/^yesterday$/i.test(t)){const v=new Date(e);return v.setDate(v.getDate()-1),{start:v,end:v,label:"Yesterday"}}if(/^this week$/i.test(t)){const v=r(e),E=new Date(v);return E.setDate(E.getDate()+6),{start:v,end:E,label:"This Week"}}if(/^last week$/i.test(t)){const v=r(e),E=new Date(v);E.setDate(E.getDate()-7);const S=new Date(E);return S.setDate(S.getDate()+6),{start:E,end:S,label:"Last Week"}}if(/^this month$/i.test(t))return{start:a(e),end:i(e),label:"This Month"};if(/^last month$/i.test(t)){const v=new Date(e.getFullYear(),e.getMonth()-1,1);return{start:a(v),end:i(v),label:"Last Month"}}const h=t.match(/^(?:past|last)\s+(\d+)\s+(day|days|week|weeks|month|months)$/i);if(h){const v=parseInt(h[1],10),E=h[2].toLowerCase(),S=new Date(e);return E.startsWith("day")?S.setDate(S.getDate()-v):E.startsWith("week")?S.setDate(S.getDate()-v*7):E.startsWith("month")&&S.setMonth(S.getMonth()-v),{start:S,end:e,label:`Past ${v} ${E}`}}if(/^this quarter$/i.test(t))return{start:o(e),end:c(e),label:"This Quarter"};if(/^last quarter$/i.test(t)){const v=new Date(e);return v.setMonth(v.getMonth()-3),{start:o(v),end:c(v),label:"Last Quarter"}}const m=t.match(/^q([1-4])$/i);if(m){const v=parseInt(m[1],10)-1,E=e.getFullYear(),S=new Date(E,v*3,1),x=new Date(E,(v+1)*3,0);return{start:S,end:x,label:`Q${v+1} ${E}`}}const p=t.match(/^q([1-4])\s*(\d{4})$/i);if(p){const v=parseInt(p[1],10)-1,E=parseInt(p[2],10),S=new Date(E,v*3,1),x=new Date(E,(v+1)*3,0);return{start:S,end:x,label:`Q${v+1} ${E}`}}if(/^this year$/i.test(t))return{start:l(e),end:d(e),label:"This Year"};if(/^last year$/i.test(t)){const v=new Date(e.getFullYear()-1,0,1);return{start:l(v),end:d(v),label:"Last Year"}}if(/^(year to date|ytd)$/i.test(t))return{start:l(e),end:e,label:"Year to Date"};const y=["january","february","march","april","may","june","july","august","september","october","november","december"],b=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"],g=t.match(/^(january|february|march|april|may|june|july|august|september|october|november|december|jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)\s*(\d{4})?$/i);if(g){const v=g[1].toLowerCase();let E=y.indexOf(v);if(E===-1&&(E=b.indexOf(v.substring(0,3))),E!==-1){const S=g[2]?parseInt(g[2],10):e.getFullYear(),x=new Date(S,E,1),k=i(x),C=y[E].charAt(0).toUpperCase()+y[E].slice(1);return{start:x,end:k,label:g[2]?`${C} ${S}`:C}}}const _=t.match(/^(20\d{2})$/);if(_){const v=parseInt(_[1],10);return{start:new Date(v,0,1),end:new Date(v,11,31),label:String(v)}}return null}function Jn(n,t){if(!n||!t)return"";const e=r=>r.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"});return n.toDateString()===t.toDateString()?e(n):n.getMonth()===t.getMonth()&&n.getFullYear()===t.getFullYear()?`${n.getDate()} - ${e(t)}`:`${e(n)} - ${e(t)}`}function Zn(){const n=new Date,t=Math.floor(n.getMonth()/3)+1,e=n.toLocaleDateString("en-GB",{month:"long"});return[{text:"today",description:"Just today"},{text:"yesterday",description:"Yesterday only"},{text:"this week",description:"Current week (Mon-Sun)"},{text:"last week",description:"Previous week"},{text:"this month",description:e},{text:"last month",description:"Previous month"},{text:"past 7 days",description:"Last 7 days"},{text:"past 30 days",description:"Last 30 days"},{text:"past 2 weeks",description:"Last 14 days"},{text:"this quarter",description:`Q${t} ${n.getFullYear()}`},{text:"last quarter",description:`Q${t>1?t-1:4}`},{text:"year to date",description:"Jan 1 to today"},{text:"this year",description:`${n.getFullYear()}`},{text:"last year",description:`${n.getFullYear()-1}`}]}function ei(){const n=Zt(),{role:t}=Ee();if(n.pathname==="/chat")return null;const{isOpen:e,toggleChat:r,messages:a,isLoading:i,isLoadingContext:o,error:c,retryCount:l,tokenUsage:d,sendMessage:h,clearChat:m,cancelRequest:p,dismissError:y,downloadChat:b,copyMessage:g}=Pn(),[_,v]=u.useState(""),[E,S]=u.useState(null),[x,k]=u.useState(!1),[C,R]=u.useState(!1),[M,T]=u.useState(!0),[I,j]=u.useState({start:"",end:""}),A=u.useRef(null),U=u.useRef(null),ae=u.useRef(null),ee=u.useMemo(()=>Gn(n.pathname,t),[n.pathname,t]),ie=u.useMemo(()=>_.length>5&&Xn(_),[_]);u.useEffect(()=>{A.current?.scrollIntoView({behavior:"smooth"})},[a]),u.useEffect(()=>{e&&setTimeout(()=>U.current?.focus(),100)},[e]),u.useEffect(()=>{if(E!==null){const L=setTimeout(()=>S(null),2e3);return()=>clearTimeout(L)}},[E]),u.useEffect(()=>{function L(F){ae.current&&!ae.current.contains(F.target)&&R(!1)}return document.addEventListener("mousedown",L),()=>document.removeEventListener("mousedown",L)},[]),u.useEffect(()=>{a.length>0&&T(!1)},[a.length]);const je=L=>{if(L.preventDefault(),_.trim()&&!i){Cr(_.trim());let F=_;I.start&&I.end&&(F=`${_} (from ${I.start} to ${I.end})`,j({start:"",end:""})),h(F),v(""),R(!1)}},Ie=L=>{L.key==="Enter"&&!L.shiftKey&&(L.preventDefault(),je(L))},O=async(L,F)=>{await g(L)&&S(F)},re=L=>{v(L),U.current?.focus()},we=L=>{const F=Cr(L);F&&(j({start:F.start.toISOString().split("T")[0],end:F.end.toISOString().split("T")[0]}),_.trim()&&v(`${_.trim()} ${L}`),R(!1))},ue={role:"assistant",content:`Hello! I'm your Project Assistant. I can query your project data and help you understand what's happening. Try asking:

â€¢ **"What do I need to do?"** - See your pending actions
â€¢ **"Show my timesheets this month"** - Query your time entries
â€¢ **"What milestones are at risk?"** - Check project progress
â€¢ **"What's the budget status?"** - View spend vs forecast

ðŸ’¡ **Tip:** I understand natural dates like "last month", "Q3", or "past 2 weeks"

All data is scoped to your role, so just ask naturally!`},Ce=a.length===0?[ue]:a,N=(d.input*.25/1e6+d.output*1.25/1e6).toFixed(4),J=Zn();return s.jsxs(s.Fragment,{children:[s.jsx("button",{className:`chat-toggle-btn ${e?"chat-open":""}`,onClick:r,"aria-label":e?"Close chat":"Open AI assistant",children:e?s.jsx(be,{size:24}):s.jsxs(s.Fragment,{children:[s.jsx(la,{size:24}),s.jsx(ca,{className:"chat-sparkle",size:12})]})}),s.jsxs("div",{className:`chat-panel ${e?"chat-panel-open":""}`,children:[s.jsxs("div",{className:"chat-header",children:[s.jsxs("div",{className:"chat-header-title",children:[s.jsx(Ot,{size:20}),s.jsx("span",{children:"Project Assistant"})]}),s.jsxs("div",{className:"chat-header-actions",children:[a.length>0&&s.jsxs(s.Fragment,{children:[s.jsx("button",{className:"chat-action-btn",onClick:b,title:"Export chat as Markdown",children:s.jsx(da,{size:16})}),s.jsx("button",{className:"chat-action-btn",onClick:m,title:"Clear chat",children:s.jsx(ua,{size:16})})]}),s.jsx("button",{className:"chat-close-btn",onClick:r,"aria-label":"Close chat",children:s.jsx(be,{size:20})})]})]}),(a.length===0||M)&&ee.length>0&&s.jsxs("div",{className:"chat-suggestions",children:[s.jsxs("div",{className:"chat-suggestions-header",children:[s.jsx(qr,{size:14}),s.jsx("span",{children:"Try asking:"})]}),s.jsx("div",{className:"chat-suggestions-list",children:ee.map((L,F)=>s.jsx("button",{className:"chat-suggestion-btn",onClick:()=>re(L.text),children:L.text},F))})]}),s.jsxs("div",{className:"chat-messages",children:[Ce.map((L,F)=>s.jsxs("div",{className:`chat-message ${L.role==="user"?"chat-message-user":"chat-message-assistant"} ${L.streaming?"chat-message-streaming":""}`,children:[s.jsx("div",{className:"chat-message-avatar",children:L.role==="user"?s.jsx(ma,{size:16}):s.jsx(Ot,{size:16})}),s.jsxs("div",{className:"chat-message-content",children:[s.jsx(ti,{content:L.content}),s.jsxs("div",{className:"chat-message-actions",children:[L.local&&s.jsx("span",{className:"chat-local-indicator",title:"Instant response from cached data",children:s.jsx(dr,{size:12})}),L.toolsUsed&&s.jsx("span",{className:"chat-tools-indicator",title:"Queried project data",children:s.jsx(ha,{size:12})}),s.jsx("button",{className:"chat-copy-btn",onClick:()=>O(L.content,F),title:E===F?"Copied!":"Copy message",children:E===F?s.jsx(Ue,{size:12,className:"chat-copy-success"}):s.jsx(pa,{size:12})})]})]})]},F)),i&&s.jsxs("div",{className:"chat-message chat-message-assistant",children:[s.jsx("div",{className:"chat-message-avatar",children:s.jsx(Ot,{size:16})}),s.jsxs("div",{className:"chat-message-content chat-typing",children:[l>0?s.jsxs(s.Fragment,{children:[s.jsx(Me,{className:"chat-typing-icon",size:16}),s.jsxs("span",{children:["Retrying (",l,"/2)..."]})]}):s.jsxs(s.Fragment,{children:[s.jsx(ur,{className:"chat-typing-icon",size:16}),s.jsx("span",{children:"Querying data..."})]}),s.jsx("button",{className:"chat-cancel-btn",onClick:p,title:"Cancel request",children:s.jsx(Br,{size:14})})]})]}),c&&s.jsxs("div",{className:"chat-error",children:[s.jsx("span",{children:c}),s.jsx("button",{className:"chat-error-dismiss",onClick:y,title:"Dismiss",children:s.jsx(be,{size:14})})]}),s.jsx("div",{ref:A})]}),C&&s.jsxs("div",{className:"chat-date-picker",ref:ae,children:[s.jsxs("div",{className:"chat-date-picker-header",children:[s.jsx(ft,{size:14}),s.jsx("span",{children:"Select Date Range"}),s.jsx("button",{onClick:()=>R(!1),children:s.jsx(be,{size:14})})]}),s.jsx("div",{className:"chat-date-quick",children:J.slice(0,8).map((L,F)=>s.jsx("button",{className:"chat-date-quick-btn",onClick:()=>we(L.text),children:L.text},F))}),s.jsxs("div",{className:"chat-date-custom",children:[s.jsxs("div",{className:"chat-date-field",children:[s.jsx("label",{children:"From"}),s.jsx("input",{type:"date",value:I.start,onChange:L=>j(F=>({...F,start:L.target.value}))})]}),s.jsxs("div",{className:"chat-date-field",children:[s.jsx("label",{children:"To"}),s.jsx("input",{type:"date",value:I.end,onChange:L=>j(F=>({...F,end:L.target.value}))})]})]}),I.start&&I.end&&s.jsxs("div",{className:"chat-date-preview",children:["Selected: ",Jn(new Date(I.start),new Date(I.end))]})]}),s.jsxs("form",{className:"chat-input-form",onSubmit:je,children:[ie&&!C&&s.jsxs("div",{className:"chat-date-hint",onClick:()=>R(!0),children:[s.jsx(ft,{size:12}),s.jsx("span",{children:"Add date range"})]}),s.jsxs("div",{className:"chat-input-wrapper",children:[s.jsx("button",{type:"button",className:`chat-date-toggle ${C?"active":""}`,onClick:()=>R(!C),title:"Select date range",children:s.jsx(ft,{size:16})}),s.jsx("textarea",{ref:U,className:"chat-input",value:_,onChange:L=>v(L.target.value),onKeyDown:Ie,placeholder:"Ask about your project...",rows:1,disabled:i}),s.jsx("button",{type:"submit",className:"chat-send-btn",disabled:!_.trim()||i,"aria-label":"Send message",children:s.jsx($r,{size:18})})]})]}),s.jsxs("div",{className:"chat-footer",children:[s.jsx("button",{className:"chat-stats-toggle",onClick:()=>k(!x),title:"Toggle usage stats",children:s.jsx(fa,{size:12})}),x?s.jsxs("div",{className:"chat-stats",children:[s.jsxs("span",{title:"Total requests",children:[d.requests," req"]}),s.jsx("span",{className:"chat-stats-divider",children:"â€¢"}),s.jsxs("span",{title:"Input tokens",children:[d.input.toLocaleString()," in"]}),s.jsx("span",{className:"chat-stats-divider",children:"â€¢"}),s.jsxs("span",{title:"Output tokens",children:[d.output.toLocaleString()," out"]}),s.jsx("span",{className:"chat-stats-divider",children:"â€¢"}),s.jsxs("span",{title:"Estimated cost",children:["$",N]})]}):o?s.jsxs("span",{className:"chat-context-loading",children:[s.jsx(ur,{size:12,className:"chat-context-spinner"}),"Loading context..."]}):s.jsxs("span",{className:"chat-context-ready",title:"Project data pre-loaded for faster responses",children:[s.jsx(dr,{size:12}),"Powered by Claude AI"]})]})]})]})}function ti({content:n}){const t=n.split(`
`);return s.jsx("div",{className:"chat-message-text",children:t.map((e,r)=>{if(e.startsWith("â€¢ ")||e.startsWith("- ")){const a=e.substring(2);return s.jsxs("div",{className:"chat-bullet",children:[s.jsx("span",{className:"chat-bullet-dot",children:"â€¢"}),s.jsx("span",{dangerouslySetInnerHTML:{__html:Er(a)}})]},r)}return e.trim()===""?s.jsx("div",{className:"chat-line-break"},r):s.jsx("p",{dangerouslySetInnerHTML:{__html:Er(e)}},r)})})}function Er(n){return n.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>")}const Qt={dashboard:{title:"Dashboard",icon:Vr,description:"Your command centre showing project KPIs, financial metrics, and progress at a glance.",sections:[{heading:"Available Widgets",type:"list",content:["Project Progress - Overall completion ring","Budget Summary - Spend vs budget","PMO Tracking - Cost breakdown","Key Statistics - Counts and metrics","Timesheets - Hours submitted and validated","Expenses - Amounts awaiting validation","Milestones List - All milestones with progress"]},{heading:"Customising Your Dashboard",type:"list",content:['Click "Customise" in the top-right corner',"Drag widgets to rearrange them","Resize widgets from their corners","Your layout saves automatically",'Click "Reset to Default" to restore']}],tips:["Your dashboard layout is saved to your account","Widgets update automatically as data changes","Data shown is specific to your current project"],relatedTopics:["milestones","timesheets","expenses","projectSwitcher"]},projectSwitcher:{title:"Project Switching",icon:Ur,description:"Switch between projects you have access to. Each project has separate data and you may have different roles on different projects.",sections:[{heading:"How Project Access Works",type:"list",content:["You can only see data for projects you are assigned to","Your role may be different on each project","Switching projects changes all data you see","Your selection is remembered when you return"]},{heading:"Switching Projects",type:"list",content:["Click the Project Switcher in the header bar","See all projects you can access","Each shows your role on that project","Click a project to switch to it"]},{heading:"Project-Specific Roles",type:"text",content:"Your role is project-scoped. You might be an Admin on one project and a Contributor on another. When you switch projects, your permissions change accordingly."}],tips:["If you only have one project, the switcher won't appear","Your default project is marked with a badge","The View As feature uses your role on the current project","Ask your admin if you need access to additional projects"],relatedTopics:["users","dashboard","general"]},milestones:{title:"Milestones",icon:mr,description:"Milestones are the primary billing units. Each represents a major project phase that triggers payment when complete.",sections:[{heading:"Milestone Status",type:"list",content:["Not Started - Work has not begun (0%)","In Progress - Work is underway (1-99%)","Completed - All work finished (100%)"]},{heading:"Financial Structure",type:"list",content:["Baseline - Original contracted amount (locked after commitment)","Forecast - Current projected amount (can be updated)","Actual - Final billable amount (set at delivery)"]},{heading:"Certificate Badges",type:"list",content:["âœ“ Both Signed - Ready for billing","Awaiting Customer - Supplier has signed","Awaiting Supplier - Customer has signed","Pending - Certificate exists, no signatures","â€“ - No certificate yet"]}],tips:["Progress is automatically calculated from deliverables","Click any row to view full milestone details","Both parties must sign before baseline is locked"],relatedTopics:["milestoneDetail","deliverables"]},milestoneDetail:{title:"Milestone Detail",icon:mr,description:"View and manage individual milestone details, baseline commitment, and acceptance certificates.",sections:[{heading:"Baseline Commitment",type:"text",content:"Before work begins, both Supplier PM and Customer PM must sign to lock the baseline schedule and budget. This creates a formal agreement on the original contract terms."},{heading:"Signing Process",type:"list",content:["Either party can sign first",'Click "Sign as Supplier PM" or "Sign as Customer PM"',"Once both sign, baseline values are locked","Locked baselines cannot be changed"]},{heading:"Acceptance Certificates",type:"text",content:"When milestone reaches 100%, create a certificate for formal acceptance. Supplier signs to confirm delivery, Customer signs to authorise billing."}],tips:["Create the certificate only when all deliverables are complete","The Supplier PM should sign first to confirm delivery","Once both sign, the milestone is ready for invoicing"],relatedTopics:["milestones","deliverables"]},deliverables:{title:"Deliverables",icon:St,description:"Deliverables are work-level items that contribute to milestone completion. Each is a discrete output like a document, feature, or component.",sections:[{heading:"Workflow Status",type:"list",content:["Not Started - Work has not begun","In Progress - Active work underway","Submitted for Review - Ready for customer review","Returned for More Work - Changes requested","Review Complete - Approved, ready for sign-off","Delivered - Formally accepted"]},{heading:"Status Transitions",type:"list",content:['Progress 0% â†’ automatically sets "Not Started"','Progress 1-99% â†’ automatically sets "In Progress"','"Submit for Review" â†’ sends to customer','Customer accepts â†’ "Review Complete"','Both PMs sign â†’ "Delivered"']}],tips:["Filter by milestone or status using the dropdowns",'Click "Awaiting Review" badge to see items needing review',"Due dates are derived from the parent milestone"],relatedTopics:["milestones","kpis","qualityStandards"]},deliverableDetail:{title:"Deliverable Detail",icon:St,description:"View and manage individual deliverables, submit for review, and complete the delivery sign-off process.",sections:[{heading:"Edit Permissions",type:"list",content:["Name - Only Supplier PM can edit","Milestone - Only Supplier PM can edit","Description - Supplier PM or Contributor can edit","Progress - Supplier PM or Contributor can edit"]},{heading:"Review Process",type:"list",content:["Complete work and set progress to 100%",'Click "Submit for Review"',"Customer PM reviews the work",'Customer clicks "Accept Review" or "Return for More Work"']},{heading:"Delivery Sign-off",type:"text",content:"Once review is complete, both PMs must sign to formally accept the deliverable. This dual-signature ensures both parties agree the work is done."},{heading:"KPI & Quality Assessment",type:"text",content:"When marking as delivered, you may need to assess linked KPIs and Quality Standards. For each, indicate whether the criteria were met."}],tips:["Fields you cannot edit appear disabled with an explanation","The Supplier PM should sign first to confirm delivery","Once both sign, the deliverable is marked as Delivered"],relatedTopics:["deliverables","milestones"]},resources:{title:"Resources",icon:tr,description:"Manage team members, their allocations, and track utilisation across the project.",sections:[{heading:"Resource Information",type:"list",content:["Name and contact details","Role and partner organisation","Day rate and billing information","Allocation to milestones","Utilisation percentage"]},{heading:"Utilisation",type:"text",content:"Utilisation shows how much of a resource's allocated time has been logged. The progress bar fills based on timesheets submitted."},{heading:"Financial Visibility",type:"text",content:"Cost prices and margins are only visible to Admin and Supplier PM roles. Customer PM sees only sell prices."}],tips:["Click any row to view the full resource detail","Resources can be linked to user accounts for self-service","Filter by type (PMO, Delivery, etc.) using the dropdown"],relatedTopics:["timesheets","partners"]},timesheets:{title:"Timesheets",icon:_e,description:"Track time worked by team members. Submit timesheets for validation and approval.",sections:[{heading:"Status Flow",type:"list",content:["Draft - Saved but not submitted","Submitted - Awaiting validation by PM","Validated - Approved, ready for invoicing","Rejected - Returned with comments"]},{heading:"Filtering Options",type:"list",content:["Quick Select: This Week, Last Week, This Month, Last Month","Month/Year: Select a specific month","Custom Range: Set specific dates","Status: Filter by workflow status"]}],tips:["Use the date filters to find timesheets quickly","Click any row to open the validation modal","Validated timesheets appear on partner invoices"],relatedTopics:["resources","partners"]},expenses:{title:"Expenses",icon:mt,description:"Track and validate expense claims. Mark expenses as chargeable to pass through to customer invoices.",sections:[{heading:"Categories",type:"list",content:["Travel - Flights, trains, taxis, mileage","Accommodation - Hotels, rentals","Sustenance - Meals during work","Equipment - Hardware, software, tools","Materials - Supplies, consumables","Other - Miscellaneous items"]},{heading:"Chargeable Expenses",type:"text",content:'Mark an expense as "Chargeable to Customer" if it should be passed through on invoices. Non-chargeable expenses are internal costs.'},{heading:"AI Receipt Scanning",type:"text",content:"Upload a receipt image and AI will extract the date, amount, category, and description automatically. Review and adjust before saving."}],tips:["Use receipt scanning to save time on data entry","Attach receipt images for audit trail","Chargeable expenses appear on customer invoices"],relatedTopics:["timesheets","partners"]},partners:{title:"Partners",icon:er,description:"Manage partner organisations and generate invoices for their work.",sections:[{heading:"Partner Information",type:"list",content:["Contact details and status","Linked resources (team members)","Timesheet history","Expense history"]},{heading:"Invoice Generation",type:"list",content:["Select the billing period (month or custom range)",'Click "Generate Invoice"',"Review the breakdown: Timesheets + Expenses","Save as PDF using your browser's print function"]}],tips:["Toggle partner status inline without opening the detail page","Only validated timesheets appear on invoices","Non-chargeable expenses are shown separately"],relatedTopics:["resources","timesheets","expenses"]},kpis:{title:"Key Performance Indicators",icon:Wr,description:"Track and measure project performance against defined KPIs.",sections:[{heading:"KPI Information",type:"list",content:["Reference and name","Category grouping","Target and current values","Status (On Track, At Risk, Behind)"]},{heading:"Linking to Deliverables",type:"text",content:"KPIs can be linked to deliverables. When a deliverable is marked as delivered, you assess whether linked KPIs were met."}],tips:["Click any row to view full KPI details","Link KPIs to deliverables for tracking","Filter by category using the dropdown"],relatedTopics:["deliverables","qualityStandards"]},qualityStandards:{title:"Quality Standards",icon:Ve,description:"Define and track quality standards that deliverables must meet.",sections:[{heading:"Quality Standard Information",type:"list",content:["Reference and name","Category grouping","Description of criteria","Status tracking"]},{heading:"Linking to Deliverables",type:"text",content:"Quality Standards can be linked to deliverables. When a deliverable is delivered, you assess whether each standard was met."}],tips:["Link Quality Standards when creating deliverables","Assessment results are recorded for audit","Use consistent naming for easier tracking"],relatedTopics:["deliverables","kpis"]},raidLog:{title:"RAID Log",icon:Qe,description:"Track Risks, Assumptions, Issues, and Dependencies for the project.",sections:[{heading:"RAID Types",type:"list",content:["Risks - Potential problems that may occur","Assumptions - Things assumed to be true","Issues - Current problems being addressed","Dependencies - External factors affecting the project"]},{heading:"Priority Levels",type:"list",content:["Critical - Immediate attention required","High - Address soon","Medium - Monitor and plan","Low - Track for awareness"]}],tips:["Use tabs to switch between Risks and Issues","Keep RAID items updated regularly","Close items when resolved"],relatedTopics:["milestones","deliverables"]},users:{title:"User Administration",icon:ga,description:"Manage user accounts, project assignments, and resource links. Admin access required.",sections:[{heading:"User Roles",type:"list",content:["Admin - Full system access","Supplier PM - Manages delivery, validates work","Customer PM - Reviews deliverables, validates work","Contributor - Submits timesheets and expenses","Viewer - Read-only access"]},{heading:"Project-Scoped Roles",type:"text",content:"Roles are now project-specific. A user might be Admin on one project and Contributor on another. Their permissions change based on which project they are viewing."},{heading:"Linking Resources",type:"text",content:'Link users to resources so they can submit timesheets and expenses. Click "Link resource" in the user row.'}],tips:["Test users can be toggled visible/hidden","Users need a linked resource to submit timesheets","Role changes take effect immediately","Users need project assignments to access project data"],relatedTopics:["resources","timesheets","projectSwitcher"]},general:{title:"Getting Help",icon:Je,description:"Welcome to AMSF001 Project Tracker. Here are some tips to get started.",sections:[{heading:"Navigation",type:"list",content:["Use the left menu to navigate between sections","Click any table row to view details","Use filter dropdowns to find specific items","The AI Chat assistant can answer questions"]},{heading:"Multi-Project Access",type:"list",content:["Use the Project Switcher in the header to change projects","Your role may differ between projects","All data is scoped to your current project","The switcher only appears if you have multiple projects"]},{heading:"Common Actions",type:"list",content:['Create items using the "+ Add" buttons',"Edit items from their detail pages","Submit work for validation using workflow buttons","Sign documents when both parties are ready"]}],tips:["Press ? on any page to open this help panel","Ask the AI Chat assistant for specific information","Contact your administrator if you need role changes","Your project selection is remembered between sessions"],relatedTopics:["dashboard","milestones","deliverables","projectSwitcher"]}};function ri(n){return Qt[n]||Qt.general}function si(){const{isOpen:n,currentTopic:t,closeHelp:e,navigateToTopic:r}=cs(),a=ri(t);if(!n)return null;const i=a.icon||Ht;return s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"help-drawer-backdrop",onClick:e}),s.jsxs("div",{className:"help-drawer",children:[s.jsxs("div",{className:"help-drawer-header",children:[s.jsxs("div",{className:"help-drawer-title",children:[s.jsx(i,{size:20}),s.jsx("span",{children:a.title})]}),s.jsx("button",{className:"help-drawer-close",onClick:e,children:s.jsx(be,{size:20})})]}),s.jsxs("div",{className:"help-drawer-content",children:[s.jsx("p",{className:"help-description",children:a.description}),a.sections?.map((o,c)=>s.jsxs("div",{className:"help-section",children:[s.jsx("h3",{className:"help-section-heading",children:o.heading}),o.type==="list"?s.jsx("ul",{className:"help-list",children:o.content.map((l,d)=>s.jsx("li",{children:l},d))}):s.jsx("p",{className:"help-text",children:o.content})]},c)),a.tips?.length>0&&s.jsxs("div",{className:"help-tips",children:[s.jsxs("div",{className:"help-tips-header",children:[s.jsx(qr,{size:16}),s.jsx("span",{children:"Tips"})]}),s.jsx("ul",{className:"help-tips-list",children:a.tips.map((o,c)=>s.jsx("li",{children:o},c))})]}),a.relatedTopics?.length>0&&s.jsxs("div",{className:"help-related",children:[s.jsx("h4",{className:"help-related-heading",children:"Related Topics"}),s.jsx("div",{className:"help-related-links",children:a.relatedTopics.map(o=>{const c=Qt[o];if(!c)return null;const l=c.icon||Ht;return s.jsxs("button",{className:"help-related-link",onClick:()=>r(o),children:[s.jsx(l,{size:14}),s.jsx("span",{children:c.title}),s.jsx(ya,{size:14})]},o)})})]})]}),s.jsxs("div",{className:"help-drawer-footer",children:[s.jsxs("a",{href:"/AMSF001-User-Guide.md",target:"_blank",rel:"noopener noreferrer",className:"help-full-guide-link",children:[s.jsx(ba,{size:14}),"View Full User Guide"]}),s.jsxs("span",{className:"help-shortcut",children:["Press ",s.jsx("kbd",{children:"?"})," to toggle help"]})]})]})]})}function ai(){const{toggleHelp:n,isOpen:t}=cs();return s.jsx("button",{className:`help-button ${t?"active":""}`,onClick:n,title:"Help (Press ?)","aria-label":"Open help",children:s.jsx(Ht,{size:20})})}function ni(){const[n,t]=u.useState(!1),e=u.useRef(null),r=ke(),{notifications:a,unreadCount:i,actionCount:o,loading:c,markAsRead:l,markAsActioned:d,markAllAsRead:h,dismissNotification:m}=En();u.useEffect(()=>{function x(k){e.current&&!e.current.contains(k.target)&&t(!1)}return document.addEventListener("mousedown",x),()=>document.removeEventListener("mousedown",x)},[]);const p=x=>{switch(x){case"timesheet":return s.jsx(_e,{size:16});case"expense":return s.jsx(mt,{size:16});case"deliverable":return s.jsx(Je,{size:16});case"certificate":return s.jsx(Ve,{size:16});default:return s.jsx(Lt,{size:16})}},y=x=>x.notification_type==="action"?x.is_actioned?"#10b981":"#f59e0b":"#3b82f6",b=async x=>{x.is_read||await l(x.id),x.action_url&&(r(x.action_url),t(!1))},g=async(x,k)=>{x.stopPropagation(),await d(k.id),k.action_url&&(r(k.action_url),t(!1))},_=async(x,k)=>{x.stopPropagation(),await m(k.id)},v=x=>{const k=new Date(x),R=new Date-k,M=Math.floor(R/6e4),T=Math.floor(R/36e5),I=Math.floor(R/864e5);return M<1?"Just now":M<60?`${M}m ago`:T<24?`${T}h ago`:I<7?`${I}d ago`:k.toLocaleDateString("en-GB",{day:"numeric",month:"short"})},E=a.slice(0,10),S=a.filter(x=>x.notification_type==="action"&&!x.is_actioned);return s.jsxs("div",{className:"notification-bell-container",ref:e,style:{position:"relative"},children:[s.jsxs("button",{onClick:()=>t(!n),style:{position:"relative",background:"none",border:"none",cursor:"pointer",padding:"8px",borderRadius:"8px",display:"flex",alignItems:"center",justifyContent:"center",transition:"background-color 0.2s",backgroundColor:n?"#f1f5f9":"transparent"},onMouseEnter:x=>x.target.style.backgroundColor="#f1f5f9",onMouseLeave:x=>x.target.style.backgroundColor=n?"#f1f5f9":"transparent",title:`${o} actions pending`,children:[s.jsx(Lt,{size:22,color:"#64748b"}),(i>0||o>0)&&s.jsx("span",{style:{position:"absolute",top:"2px",right:"2px",backgroundColor:o>0?"#ef4444":"#3b82f6",color:"white",fontSize:"11px",fontWeight:"600",minWidth:"18px",height:"18px",borderRadius:"9px",display:"flex",alignItems:"center",justifyContent:"center",padding:"0 4px"},children:o>0?o:i})]}),n&&s.jsxs("div",{style:{position:"absolute",top:"100%",right:0,marginTop:"8px",width:"380px",maxHeight:"500px",backgroundColor:"white",borderRadius:"12px",boxShadow:"0 10px 40px rgba(0,0,0,0.15)",border:"1px solid #e2e8f0",zIndex:1e3,overflow:"hidden"},children:[s.jsxs("div",{style:{padding:"16px",borderBottom:"1px solid #e2e8f0",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[s.jsxs("div",{children:[s.jsx("h3",{style:{margin:0,fontSize:"16px",fontWeight:"600"},children:"Notifications"}),o>0&&s.jsxs("p",{style:{margin:"4px 0 0",fontSize:"13px",color:"#f59e0b"},children:[o," action",o!==1?"s":""," required"]})]}),i>0&&s.jsx("button",{onClick:h,style:{background:"none",border:"none",color:"#3b82f6",fontSize:"13px",cursor:"pointer",padding:"4px 8px",borderRadius:"4px"},children:"Mark all read"})]}),S.length>0&&s.jsxs("div",{style:{padding:"12px 16px",backgroundColor:"#fffbeb",borderBottom:"1px solid #fef3c7"},children:[s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"8px"},children:[s.jsx("div",{style:{width:"8px",height:"8px",borderRadius:"50%",backgroundColor:"#f59e0b",animation:"pulse 2s infinite"}}),s.jsx("span",{style:{fontWeight:"600",fontSize:"13px",color:"#92400e"},children:"Actions Requiring Attention"})]}),s.jsxs("button",{onClick:()=>{r("/workflow-summary"),t(!1)},style:{width:"100%",padding:"8px 12px",backgroundColor:"#f59e0b",color:"white",border:"none",borderRadius:"6px",cursor:"pointer",fontSize:"13px",fontWeight:"500",display:"flex",alignItems:"center",justifyContent:"center",gap:"6px"},children:["View Workflow Summary",s.jsx(wa,{size:16})]})]}),s.jsx("div",{style:{maxHeight:"350px",overflowY:"auto"},children:c?s.jsx("div",{style:{padding:"32px",textAlign:"center",color:"#64748b"},children:"Loading..."}):E.length===0?s.jsxs("div",{style:{padding:"32px",textAlign:"center",color:"#64748b"},children:[s.jsx(Lt,{size:32,style:{marginBottom:"8px",opacity:.5}}),s.jsx("p",{style:{margin:0},children:"No notifications"})]}):E.map(x=>s.jsx("div",{onClick:()=>b(x),style:{padding:"12px 16px",borderBottom:"1px solid #f1f5f9",cursor:"pointer",backgroundColor:x.is_read?"white":"#f8fafc",transition:"background-color 0.15s"},onMouseEnter:k=>k.currentTarget.style.backgroundColor="#f1f5f9",onMouseLeave:k=>k.currentTarget.style.backgroundColor=x.is_read?"white":"#f8fafc",children:s.jsxs("div",{style:{display:"flex",gap:"12px"},children:[s.jsx("div",{style:{width:"36px",height:"36px",borderRadius:"8px",backgroundColor:x.notification_type==="action"&&!x.is_actioned?"#fef3c7":"#f1f5f9",display:"flex",alignItems:"center",justifyContent:"center",color:y(x),flexShrink:0},children:p(x.category)}),s.jsxs("div",{style:{flex:1,minWidth:0},children:[s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",gap:"8px"},children:[s.jsx("span",{style:{fontWeight:x.is_read?"400":"600",fontSize:"14px",color:"#1e293b"},children:x.title}),s.jsx("span",{style:{fontSize:"12px",color:"#94a3b8",flexShrink:0},children:v(x.created_at)})]}),s.jsx("p",{style:{margin:"4px 0 0",fontSize:"13px",color:"#64748b",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:x.message}),s.jsxs("div",{style:{marginTop:"8px",display:"flex",gap:"8px"},children:[x.notification_type==="action"&&!x.is_actioned&&x.action_label&&s.jsx("button",{onClick:k=>g(k,x),style:{padding:"4px 12px",fontSize:"12px",fontWeight:"500",backgroundColor:"#3b82f6",color:"white",border:"none",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",gap:"4px"},children:x.action_label}),x.notification_type==="info"&&s.jsxs("button",{onClick:k=>_(k,x),style:{padding:"4px 8px",fontSize:"12px",backgroundColor:"transparent",color:"#64748b",border:"1px solid #e2e8f0",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",gap:"4px"},children:[s.jsx(be,{size:12}),"Dismiss"]}),x.is_actioned&&s.jsxs("span",{style:{padding:"4px 8px",fontSize:"12px",color:"#10b981",display:"flex",alignItems:"center",gap:"4px"},children:[s.jsx(Ue,{size:12}),"Completed"]})]})]})]})},x.id))}),a.length>10&&s.jsx("div",{style:{padding:"12px 16px",borderTop:"1px solid #e2e8f0",textAlign:"center"},children:s.jsx("button",{onClick:()=>{r("/workflow-summary"),t(!1)},style:{background:"none",border:"none",color:"#3b82f6",fontSize:"13px",fontWeight:"500",cursor:"pointer"},children:"View all notifications"})})]}),s.jsx("style",{children:`
        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.5; }
        }
      `})]})}function ii(){const{canUseViewAs:n,isImpersonating:t,effectiveRole:e,actualRole:r,setViewAs:a,clearViewAs:i,availableRoles:o,effectiveRoleConfig:c}=Dt();return n?s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.375rem 0.75rem",backgroundColor:t?"#fef3c7":"#f8fafc",borderRadius:"6px",border:t?"1px solid #fcd34d":"1px solid #e2e8f0",fontSize:"0.8125rem",transition:"all 0.15s ease"},children:[s.jsx(jt,{size:14,style:{color:t?"#d97706":"#64748b",flexShrink:0}}),s.jsx("span",{style:{color:t?"#92400e":"#64748b",fontWeight:"500",whiteSpace:"nowrap"},children:"View as:"}),s.jsx("select",{value:e,onChange:l=>a(l.target.value),style:{padding:"0.25rem 0.5rem",paddingRight:"1.5rem",border:"none",borderRadius:"4px",backgroundColor:t?c.bg:"white",color:t?c.color:"#374151",fontWeight:"600",fontSize:"0.75rem",cursor:"pointer",outline:"none",appearance:"none",backgroundImage:`url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E")`,backgroundRepeat:"no-repeat",backgroundPosition:"right 0.25rem center",minWidth:"110px"},children:o.map(l=>s.jsxs("option",{value:l.value,style:{fontWeight:l.value===r?"700":"400"},children:[l.label,l.value===r?" (You)":""]},l.value))}),t&&s.jsx("button",{onClick:i,title:"Reset to your actual role",style:{display:"flex",alignItems:"center",justifyContent:"center",padding:"0.25rem",border:"none",borderRadius:"4px",backgroundColor:"transparent",color:"#92400e",cursor:"pointer",transition:"background-color 0.15s ease"},onMouseEnter:l=>l.currentTarget.style.backgroundColor="#fde68a",onMouseLeave:l=>l.currentTarget.style.backgroundColor="transparent",children:s.jsx(rr,{size:14})})]}):null}function oi(){const{canUseViewAs:n,isImpersonating:t,effectiveRole:e,effectiveRoleConfig:r}=Dt();return!n||!t?null:s.jsxs("span",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.125rem 0.375rem",backgroundColor:"#fef3c7",border:"1px solid #fcd34d",borderRadius:"4px",fontSize:"0.65rem",fontWeight:"600",color:"#92400e"},children:[s.jsx(jt,{size:10}),"viewing as ",r.label]})}function li(){const{currentProject:n,projectRole:t,availableProjects:e,hasMultipleProjects:r,switchProject:a,isLoading:i}=ye(),[o,c]=u.useState(!1),l=u.useRef(null);if(u.useEffect(()=>{function m(p){l.current&&!l.current.contains(p.target)&&c(!1)}return document.addEventListener("mousedown",m),()=>document.removeEventListener("mousedown",m)},[]),!r||i)return null;const d=m=>De[m]||{label:m,shortLabel:m,color:"#64748b",bg:"#f1f5f9"},h=m=>{m!==n?.id&&a(m),c(!1)};return s.jsxs("div",{ref:l,style:{position:"relative"},children:[s.jsxs("button",{onClick:()=>c(!o),style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.5rem 0.75rem",backgroundColor:"#f8fafc",border:"1px solid #e2e8f0",borderRadius:"8px",cursor:"pointer",fontSize:"0.875rem",fontWeight:"500",color:"#334155",transition:"all 0.15s ease",minWidth:"180px",justifyContent:"space-between"},onMouseEnter:m=>{m.currentTarget.style.backgroundColor="#f1f5f9",m.currentTarget.style.borderColor="#cbd5e1"},onMouseLeave:m=>{m.currentTarget.style.backgroundColor="#f8fafc",m.currentTarget.style.borderColor="#e2e8f0"},children:[s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[s.jsx(Ur,{size:16,style:{color:"#10b981"}}),s.jsx("span",{style:{maxWidth:"120px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:n?.reference||"Select Project"})]}),s.jsx(Lr,{size:16,style:{color:"#64748b",transform:o?"rotate(180deg)":"rotate(0)",transition:"transform 0.15s ease"}})]}),o&&s.jsxs("div",{style:{position:"absolute",top:"calc(100% + 4px)",left:0,right:0,minWidth:"280px",backgroundColor:"white",border:"1px solid #e2e8f0",borderRadius:"8px",boxShadow:"0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)",zIndex:100,overflow:"hidden"},children:[s.jsx("div",{style:{padding:"0.75rem 1rem",borderBottom:"1px solid #e2e8f0",backgroundColor:"#f8fafc"},children:s.jsx("div",{style:{fontSize:"0.75rem",fontWeight:"600",color:"#64748b",textTransform:"uppercase",letterSpacing:"0.025em"},children:"Switch Project"})}),s.jsx("div",{style:{maxHeight:"300px",overflowY:"auto"},children:e.map(m=>{const p=m.project,y=p?.id===n?.id,b=d(m.role);return s.jsxs("button",{onClick:()=>h(p?.id),style:{width:"100%",display:"flex",alignItems:"center",justifyContent:"space-between",gap:"0.75rem",padding:"0.75rem 1rem",backgroundColor:y?"#f0fdf4":"white",border:"none",borderBottom:"1px solid #f1f5f9",cursor:"pointer",textAlign:"left",transition:"background-color 0.15s ease"},onMouseEnter:g=>{y||(g.currentTarget.style.backgroundColor="#f8fafc")},onMouseLeave:g=>{g.currentTarget.style.backgroundColor=y?"#f0fdf4":"white"},children:[s.jsxs("div",{style:{flex:1,minWidth:0},children:[s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"0.25rem"},children:[s.jsx("span",{style:{fontWeight:"600",fontSize:"0.875rem",color:y?"#10b981":"#1e293b"},children:p?.reference}),m.is_default&&s.jsx("span",{style:{fontSize:"0.6rem",padding:"0.125rem 0.375rem",backgroundColor:"#dbeafe",color:"#1e40af",borderRadius:"4px",fontWeight:"600"},children:"DEFAULT"})]}),s.jsx("div",{style:{fontSize:"0.75rem",color:"#64748b",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:p?.name})]}),s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[s.jsx("span",{style:{fontSize:"0.65rem",padding:"0.125rem 0.5rem",backgroundColor:b.bg,color:b.color,borderRadius:"4px",fontWeight:"600",textTransform:"uppercase",whiteSpace:"nowrap"},children:b.shortLabel}),y&&s.jsx(Ue,{size:16,style:{color:"#10b981"}})]})]},m.id)})})]})]})}function Xt(n,t){return t.includes(n)}function ci(n){return Xt(n,[w.ADMIN,w.SUPPLIER_PM])}function ds(n){return D(n,"timesheets","create")}function lr(n){return D(n,"timesheets","createForOthers")}function yt(n){return D(n,"timesheets","approve")}function di(n,t,e,r){if(D(n,"timesheets","createForOthers"))return!0;let a,i,o;return typeof t=="object"&&t!==null?(a=t.status,i=t.created_by||t.resource?.user_id,o=e):(a=t,i=e,o=r),i===o&&(a==="Draft"||a==="Rejected")}function ui(n,t,e,r){if(D(n,"timesheets","delete"))return!0;let a,i,o;return typeof t=="object"&&t!==null?(a=t.status,i=t.created_by||t.resource?.user_id,o=e):(a=t,i=e,o=r),i===o&&a==="Draft"}function mi(n,t,e,r){let a,i,o;return typeof t=="object"&&t!==null?(a=t.status,i=t.created_by||t.resource?.user_id,o=e):(a=t,i=e,o=r),a!=="Draft"&&a!=="Rejected"?!1:D(n,"timesheets","createForOthers")?!0:i===o&&D(n,"timesheets","submit")}function Jt(n){return D(n,"expenses","create")}function us(n){return D(n,"expenses","createForOthers")}function ms(n){return D(n,"expenses","validateChargeable")}function hs(n){return D(n,"expenses","validateNonChargeable")}function hi(n,t,e){let r,a;return typeof t=="object"&&t!==null?(r=t.status,a=t.chargeable||t.chargeable_to_customer):(r=t,a=e),r!=="Submitted"?!1:a?D(n,"expenses","validateChargeable"):D(n,"expenses","validateNonChargeable")}function pi(n,t,e,r){if(D(n,"expenses","createForOthers"))return!0;let a,i,o;return typeof t=="object"&&t!==null?(a=t.status,i=t.created_by,o=e):(a=t,i=e,o=r),i===o&&(a==="Draft"||a==="Rejected")}function fi(n,t,e,r){if(D(n,"expenses","delete"))return!0;let a,i,o;return typeof t=="object"&&t!==null?(a=t.status,i=t.created_by,o=e):(a=t,i=e,o=r),i===o&&a==="Draft"}function ps(n){return D(n,"milestones","create")}function fs(n){return D(n,"milestones","edit")}function gs(n){return D(n,"milestones","delete")}function ys(n){return D(n,"milestones","useGantt")}function gi(n){return D(n,"milestones","editBilling")}function bs(n){return D(n,"deliverables","create")}function ws(n){return D(n,"deliverables","edit")}function vs(n){return D(n,"deliverables","delete")}function xs(n){return D(n,"deliverables","review")}function yi(n){return D(n,"deliverables","submit")}function bi(n,t,e){return D(n,"deliverables","edit")?!0:n===w.CONTRIBUTOR?t?.assigned_to===e||t?.resource?.user_id===e:!1}function _s(n){return D(n,"kpis","manage")}function wi(n){return D(n,"kpis","create")}function vi(n){return D(n,"kpis","edit")}function xi(n){return D(n,"kpis","delete")}function Ss(n){return D(n,"qualityStandards","manage")}function _i(n){return D(n,"qualityStandards","create")}function Si(n){return D(n,"qualityStandards","edit")}function ji(n){return D(n,"qualityStandards","delete")}function js(n){return D(n,"resources","manage")}function Ci(n){return D(n,"resources","create")}function Ei(n){return D(n,"resources","edit")}function Cs(n){return D(n,"resources","delete")}function Es(n){return D(n,"resources","seeCostPrice")}function ki(n){return D(n,"resources","seeResourceType")}function ks(n){return D(n,"resources","seeMargins")}function Rs(n){return D(n,"partners","view")}function As(n){return D(n,"partners","manage")}function Ri(n){return D(n,"partners","create")}function Ai(n){return D(n,"partners","edit")}function Ti(n){return D(n,"partners","delete")}function Di(n){return D(n,"variations","create")}function Pi(n){return D(n,"variations","edit")}function Mi(n){return D(n,"variations","delete")}function Ni(n){return D(n,"variations","submit")}function Ii(n){return D(n,"variations","signAsSupplier")}function Oi(n){return D(n,"variations","signAsCustomer")}function Li(n){return D(n,"variations","reject")}function Ts(n){return D(n,"certificates","signAsSupplier")}function Ds(n){return D(n,"certificates","signAsCustomer")}function Bi(n){return D(n,"certificates","create")}function Ps(n){return D(n,"settings","access")}function qi(n){return D(n,"settings","edit")}function Ms(n){return D(n,"users","manage")}function $i(n){return D(n,"users","view")}function Ns(n){return D(n,"reports","viewWorkflowSummary")}function Is(n){return D(n,"invoices","generateCustomer")}function Os(n){return D(n,"invoices","generateThirdParty")}function Wi(n){return D(n,"invoices","viewMargins")}function Ui(n){return D(n,"reports","access")}function Ls(n,t,e){return!t||!Array.isArray(t)?[]:lr(n)?t:t.filter(r=>r.user_id===e)}function Vi(n,t){return!n||!Array.isArray(n)?null:n.find(e=>e.user_id===t)||null}function Bs(n,t,e){const r=Ls(n,t,e);return r.length===0?null:r.find(i=>i.user_id===e)||r[0]}function zi(n,t,e){return Bs(n,t,e)?.id||null}function qs(n){return De[n]||De[w.VIEWER]}function $s(n){return qs(n).label}function Fi(n){return{role:n,roleLabel:$s(n),timesheets:{canAdd:ds(n),canAddForOthers:lr(n),canApprove:yt(n)},expenses:{canAdd:Jt(n),canAddForOthers:us(n),canValidateChargeable:ms(n),canValidateNonChargeable:hs(n)},milestones:{canCreate:ps(n),canEdit:fs(n),canDelete:gs(n),canUseGantt:ys(n)},deliverables:{canCreate:bs(n),canEdit:ws(n),canDelete:vs(n),canReview:xs(n)},kpis:{canManage:_s(n)},qualityStandards:{canManage:Ss(n)},resources:{canManage:js(n),canDelete:Cs(n),canSeeCostPrice:Es(n),canSeeMargins:ks(n)},partners:{canView:Rs(n),canManage:As(n)},certificates:{canSignAsSupplier:Ts(n),canSignAsCustomer:Ds(n)},admin:{canAccessSettings:Ps(n),canManageUsers:Ms(n),canViewWorkflowSummary:Ns(n)},invoicing:{canGenerateCustomerInvoice:Is(n),canGenerateThirdPartyInvoice:Os(n)}}}const Pt={workflowSummary:{id:"workflowSummary",path:"/workflow-summary",icon:Ra,label:"Workflow Summary",allowedRoles:[w.ADMIN,w.SUPPLIER_PM,w.CUSTOMER_PM,w.CONTRIBUTOR],readOnlyRoles:[]},dashboard:{id:"dashboard",path:"/dashboard",icon:Vr,label:"Dashboard",allowedRoles:[w.ADMIN,w.SUPPLIER_PM,w.CUSTOMER_PM,w.VIEWER],readOnlyRoles:[w.VIEWER]},reports:{id:"reports",path:"/reports",icon:Je,label:"Reports",allowedRoles:[w.ADMIN,w.SUPPLIER_PM,w.CUSTOMER_PM],readOnlyRoles:[]},gantt:{id:"gantt",path:"/gantt",icon:ka,label:"Gantt Chart",allowedRoles:[w.ADMIN,w.SUPPLIER_PM,w.CUSTOMER_PM,w.VIEWER],readOnlyRoles:[w.VIEWER,w.CUSTOMER_PM]},milestones:{id:"milestones",path:"/milestones",icon:ar,label:"Milestones",allowedRoles:[w.ADMIN,w.SUPPLIER_PM,w.CUSTOMER_PM,w.VIEWER],readOnlyRoles:[w.VIEWER]},deliverables:{id:"deliverables",path:"/deliverables",icon:St,label:"Deliverables",allowedRoles:[w.ADMIN,w.SUPPLIER_PM,w.CUSTOMER_PM,w.CONTRIBUTOR,w.VIEWER],readOnlyRoles:[w.VIEWER]},kpis:{id:"kpis",path:"/kpis",icon:dt,label:"KPIs",allowedRoles:[w.ADMIN,w.SUPPLIER_PM,w.CUSTOMER_PM,w.VIEWER],readOnlyRoles:[w.VIEWER,w.CUSTOMER_PM]},qualityStandards:{id:"qualityStandards",path:"/quality-standards",icon:Ve,label:"Quality Standards",allowedRoles:[w.ADMIN,w.SUPPLIER_PM,w.CUSTOMER_PM,w.VIEWER],readOnlyRoles:[w.VIEWER,w.CUSTOMER_PM]},raid:{id:"raid",path:"/raid",icon:Ea,label:"RAID Log",allowedRoles:[w.ADMIN,w.SUPPLIER_PM,w.CUSTOMER_PM,w.VIEWER],readOnlyRoles:[w.VIEWER]},resources:{id:"resources",path:"/resources",icon:tr,label:"Resources",allowedRoles:[w.ADMIN,w.SUPPLIER_PM],readOnlyRoles:[]},timesheets:{id:"timesheets",path:"/timesheets",icon:_e,label:"Timesheets",allowedRoles:[w.ADMIN,w.SUPPLIER_PM,w.CUSTOMER_PM,w.CONTRIBUTOR],readOnlyRoles:[]},expenses:{id:"expenses",path:"/expenses",icon:mt,label:"Expenses",allowedRoles:[w.ADMIN,w.SUPPLIER_PM,w.CUSTOMER_PM,w.CONTRIBUTOR],readOnlyRoles:[]},billing:{id:"billing",path:"/billing",icon:sr,label:"Billing",allowedRoles:[w.ADMIN,w.SUPPLIER_PM],readOnlyRoles:[]},partners:{id:"partners",path:"/partners",icon:er,label:"Partners",allowedRoles:[w.ADMIN,w.SUPPLIER_PM],readOnlyRoles:[]},users:{id:"users",path:"/users",icon:Ca,label:"Users",allowedRoles:[w.ADMIN,w.SUPPLIER_PM],readOnlyRoles:[w.SUPPLIER_PM]},settings:{id:"settings",path:"/settings",icon:ja,label:"Settings",allowedRoles:[w.ADMIN,w.SUPPLIER_PM],readOnlyRoles:[]},auditLog:{id:"auditLog",path:"/audit-log",icon:Sa,label:"Audit Log",allowedRoles:[w.ADMIN,w.SUPPLIER_PM],readOnlyRoles:[]},deletedItems:{id:"deletedItems",path:"/deleted-items",icon:_a,label:"Deleted Items",allowedRoles:[w.ADMIN,w.SUPPLIER_PM],readOnlyRoles:[]},calendar:{id:"calendar",path:"/calendar",icon:xa,label:"Calendar",allowedRoles:[w.ADMIN,w.SUPPLIER_PM,w.CUSTOMER_PM,w.CONTRIBUTOR,w.VIEWER],readOnlyRoles:[w.VIEWER]},variations:{id:"variations",path:"/variations",icon:va,label:"Variations",allowedRoles:[w.ADMIN,w.SUPPLIER_PM,w.CUSTOMER_PM],readOnlyRoles:[w.CUSTOMER_PM]}},Et={[w.ADMIN]:["workflowSummary","dashboard","reports","gantt","milestones","deliverables","variations","kpis","qualityStandards","raid","resources","calendar","timesheets","expenses","billing","partners","users","settings","auditLog","deletedItems"],[w.SUPPLIER_PM]:["workflowSummary","dashboard","reports","gantt","milestones","deliverables","variations","kpis","qualityStandards","raid","resources","calendar","timesheets","expenses","billing","partners","users","settings","auditLog","deletedItems"],[w.CUSTOMER_PM]:["workflowSummary","dashboard","reports","gantt","milestones","deliverables","variations","kpis","qualityStandards","raid","calendar","timesheets","expenses"],[w.CONTRIBUTOR]:["workflowSummary","calendar","timesheets","expenses","deliverables"],[w.VIEWER]:["dashboard","gantt","milestones","deliverables","kpis","qualityStandards","raid","calendar"]};function Hi(n){return(Et[n]||Et[w.VIEWER]).map(e=>Pt[e]?.path).filter(Boolean)}function Ws(n){return(Et[n]||Et[w.VIEWER]).map(e=>Pt[e]).filter(e=>e&&e.allowedRoles.includes(n))}function kr(n,t){const e=Pt[t];return e?e.readOnlyRoles?.includes(n)||!1:!0}function Yi(n){return n!==w.VIEWER}function Gi(n){return Object.values(Pt).find(t=>t.path===n)||null}function Ki(n){return Gi(n)?.id||null}function Qi(n,t){const e=Ws(n);if(!t||!Array.isArray(t)||t.length===0)return e;const r={};e.forEach(i=>{r[i.path]=i});const a=[];return t.forEach(i=>{r[i]&&(a.push(r[i]),delete r[i])}),Object.values(r).forEach(i=>{a.push(i)}),a}function Xi(n,t){if(!t||t.length===0)return!0;const e=Hi(n);return t.length!==e.length?!1:t.every((r,a)=>r===e[a])}const Rr={[w.ADMIN]:{label:"Administrator",shortLabel:"Admin",color:"#7c3aed",bg:"#f3e8ff",description:"Full system access"},[w.SUPPLIER_PM]:{label:"Supplier PM",shortLabel:"Supplier PM",color:"#059669",bg:"#d1fae5",description:"Manage resources, partners, and invoices"},[w.CUSTOMER_PM]:{label:"Customer PM",shortLabel:"Customer PM",color:"#d97706",bg:"#fef3c7",description:"Approve timesheets and validate expenses"},[w.CONTRIBUTOR]:{label:"Contributor",shortLabel:"Contributor",color:"#2563eb",bg:"#dbeafe",description:"Submit timesheets and expenses"},[w.VIEWER]:{label:"Viewer",shortLabel:"Viewer",color:"#64748b",bg:"#f1f5f9",description:"Read-only access to reports"}};function Ji(n){return Rr[n]||Rr[w.VIEWER]}function Zi({children:n}){const t=Zt(),e=ke(),{showSuccess:r,showError:a}=ns(),{user:i,profile:o,role:c,signOut:l}=Ee(),{effectiveRole:d,isImpersonating:h,effectiveRoleConfig:m}=Dt(),[p,y]=u.useState(!0),[b,g]=u.useState(null),[_,v]=u.useState(null),[E,S]=u.useState(null),x=u.useRef(null),k=u.useMemo(()=>Ji(d),[d]),C=u.useMemo(()=>o&&(o.full_name||o.email||i?.email)||"User",[o,i]),R=u.useMemo(()=>{if(!o)return"U";if(o.full_name){const O=o.full_name.split(" ");return O.length>=2?O[0][0]+O[O.length-1][0]:o.full_name[0].toUpperCase()}return C[0].toUpperCase()},[o,C]);u.useEffect(()=>{o?.nav_order&&Array.isArray(o.nav_order)&&g(o.nav_order)},[o]);async function M(){await l(),e("/login")}const T=u.useMemo(()=>Yi(d),[d]),I=u.useMemo(()=>b&&!Xi(d,b),[d,b]),j=u.useMemo(()=>{const O=Ws(d);return b&&b.length>0?Qi(d,b):O},[d,b]),A=u.useMemo(()=>{const O=Ki(t.pathname);return O?kr(d,O):!1},[d,t.pathname]);function U(O,re){T&&(x.current=O.target,v(re),setTimeout(()=>{x.current&&(x.current.style.opacity="0.5")},0))}function ae(O,re){T&&re!==_&&S(re)}function ee(O){T&&O.preventDefault()}function ie(){if(T){if(x.current&&(x.current.style.opacity="1"),_!==null&&E!==null&&_!==E){const O=[...j],re=O[_];O.splice(_,1),O.splice(E,0,re);const we=O.map(ue=>ue.path);g(we),je(we)}v(null),S(null),x.current=null}}async function je(O){if(i)try{const{error:re}=await f.from("profiles").update({nav_order:O}).eq("id",i.id);re&&a("Failed to save menu order")}catch{a("Failed to save menu order")}}async function Ie(){if(i)try{const{error:O}=await f.from("profiles").update({nav_order:null}).eq("id",i.id);if(O){a("Failed to reset menu order");return}g(null),r("Menu order reset to default")}catch{a("Failed to reset menu order")}}return s.jsxs("div",{style:{display:"flex",minHeight:"100vh",backgroundColor:"#f8fafc"},children:[s.jsxs("aside",{style:{width:p?"260px":"70px",backgroundColor:"white",borderRight:"1px solid #e2e8f0",transition:"width 0.3s ease",display:"flex",flexDirection:"column",position:"fixed",height:"100vh",zIndex:50},children:[s.jsxs("div",{style:{padding:"1rem",borderBottom:"1px solid #e2e8f0",display:"flex",alignItems:"center",justifyContent:"space-between"},children:[p&&s.jsxs("div",{children:[s.jsx("h2",{style:{margin:0,fontSize:"1.125rem",fontWeight:"700",color:"#0f172a"},children:"AMSF001"}),s.jsx("span",{style:{fontSize:"0.75rem",color:"#64748b"},children:"Project Tracker"})]}),s.jsx("button",{onClick:()=>y(!p),style:{padding:"0.5rem",borderRadius:"6px",border:"none",backgroundColor:"#f1f5f9",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"},children:p?s.jsx(be,{size:20}):s.jsx(Aa,{size:20})})]}),s.jsx("nav",{style:{flex:1,padding:"0.5rem",overflowY:"auto"},children:j.map((O,re)=>{const we=O.icon,ue=t.pathname===O.path||O.path!=="/dashboard"&&t.pathname.startsWith(O.path),Ce=_===re,N=E===re,J=kr(d,O.id);return s.jsx("div",{draggable:T,onDragStart:L=>U(L,re),onDragEnter:L=>ae(L,re),onDragOver:ee,onDragEnd:ie,style:{position:"relative",marginBottom:"0.25rem",borderTop:N&&_>re?"2px solid #10b981":"2px solid transparent",borderBottom:N&&_<re?"2px solid #10b981":"2px solid transparent",transition:"border-color 0.15s ease"},children:s.jsxs(Ft,{to:O.path,style:{display:"flex",alignItems:"center",gap:"0.75rem",padding:p?"0.75rem 1rem":"0.75rem",borderRadius:"8px",textDecoration:"none",color:ue?"#10b981":"#64748b",backgroundColor:ue?"#f0fdf4":Ce?"#f1f5f9":"transparent",fontWeight:ue?"600":"500",justifyContent:p?"flex-start":"center",transition:"all 0.15s ease",cursor:T?"grab":"pointer"},children:[p&&T&&s.jsx(Ta,{size:14,style:{color:"#cbd5e1",marginRight:"-0.25rem",flexShrink:0}}),s.jsx(we,{size:20}),p&&s.jsx("span",{style:{flex:1},children:O.label}),p&&J&&s.jsx("span",{style:{fontSize:"0.6rem",padding:"0.125rem 0.375rem",backgroundColor:"#f1f5f9",color:"#64748b",borderRadius:"4px",fontWeight:"500"},children:"VIEW"})]})},O.path)})}),p&&T&&I&&s.jsx("div",{style:{padding:"0.5rem 1rem",borderTop:"1px solid #e2e8f0"},children:s.jsxs("button",{onClick:Ie,style:{width:"100%",display:"flex",alignItems:"center",justifyContent:"center",gap:"0.5rem",padding:"0.5rem",backgroundColor:"#f8fafc",color:"#64748b",border:"1px solid #e2e8f0",borderRadius:"6px",cursor:"pointer",fontSize:"0.75rem",fontWeight:"500",transition:"all 0.15s ease"},onMouseEnter:O=>{O.currentTarget.style.backgroundColor="#f1f5f9",O.currentTarget.style.color="#475569"},onMouseLeave:O=>{O.currentTarget.style.backgroundColor="#f8fafc",O.currentTarget.style.color="#64748b"},children:[s.jsx(rr,{size:14}),"Reset Menu Order"]})}),s.jsx("div",{style:{padding:"1rem",borderTop:"1px solid #e2e8f0",backgroundColor:"#f8fafc"},children:s.jsxs("button",{onClick:M,style:{width:"100%",display:"flex",alignItems:"center",justifyContent:p?"flex-start":"center",gap:"0.75rem",padding:"0.75rem",backgroundColor:"#fef2f2",color:"#ef4444",border:"none",borderRadius:"8px",cursor:"pointer",fontWeight:"500"},children:[s.jsx(Da,{size:20}),p&&s.jsx("span",{children:"Logout"})]})})]}),s.jsxs("main",{style:{flex:1,marginLeft:p?"260px":"70px",transition:"margin-left 0.3s ease",minHeight:"100vh",display:"flex",flexDirection:"column"},children:[s.jsxs("header",{style:{padding:"0.75rem 1.5rem",backgroundColor:"white",borderBottom:"1px solid #e2e8f0",display:"flex",justifyContent:"flex-end",alignItems:"center",gap:"1rem",position:"sticky",top:0,zIndex:40},children:[s.jsx(li,{}),s.jsx(ii,{}),s.jsxs(Ft,{to:"/account",style:{display:"flex",alignItems:"center",gap:"0.75rem",paddingRight:"1rem",borderRight:"1px solid #e2e8f0",textDecoration:"none",cursor:"pointer",borderRadius:"8px",padding:"0.5rem 1rem 0.5rem 0.75rem",marginRight:"0",transition:"background-color 0.15s ease"},onMouseEnter:O=>O.currentTarget.style.backgroundColor="#f8fafc",onMouseLeave:O=>O.currentTarget.style.backgroundColor="transparent",children:[s.jsxs("div",{style:{textAlign:"right"},children:[s.jsxs("div",{style:{fontWeight:"600",fontSize:"0.875rem",color:"#1e293b"},children:[C,h&&s.jsx(oi,{})]}),s.jsx("span",{style:{display:"inline-block",padding:"0.125rem 0.5rem",backgroundColor:k.bg,color:k.color,borderRadius:"4px",fontSize:"0.65rem",fontWeight:"600",textTransform:"uppercase",letterSpacing:"0.025em"},children:k.shortLabel})]}),s.jsx("div",{style:{width:"36px",height:"36px",borderRadius:"50%",backgroundColor:k.color,display:"flex",alignItems:"center",justifyContent:"center",color:"white",fontWeight:"600",fontSize:"0.8rem"},children:R})]}),s.jsx(ni,{})]}),A&&s.jsxs("div",{style:{padding:"0.5rem 1.5rem",backgroundColor:"#f1f5f9",borderBottom:"1px solid #e2e8f0",display:"flex",alignItems:"center",gap:"0.5rem",fontSize:"0.875rem",color:"#64748b"},children:[s.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[s.jsx("circle",{cx:"12",cy:"12",r:"10"}),s.jsx("line",{x1:"12",y1:"16",x2:"12",y2:"12"}),s.jsx("line",{x1:"12",y1:"8",x2:"12.01",y2:"8"})]}),s.jsx("span",{children:"You have read-only access to this page"})]}),s.jsx("div",{style:{flex:1},children:n})]})]})}const Us={minLength:12};function eo(n){const t={length:n.length>=Us.minLength,uppercase:/[A-Z]/.test(n),lowercase:/[a-z]/.test(n),number:/[0-9]/.test(n),special:/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(n)},e=Object.values(t).every(Boolean);let r="weak";const a=Object.values(t).filter(Boolean).length;return a>=3&&(r="fair"),a>=4&&n.length>=14&&(r="good"),a===5&&n.length>=16&&(r="strong"),{checks:t,allPassed:e,strength:r}}function to({onSuccess:n,userEmail:t}){const[e,r]=u.useState(""),[a,i]=u.useState(""),[o,c]=u.useState(!1),[l,d]=u.useState(!1),[h,m]=u.useState(!1),[p,y]=u.useState(null),b=eo(e),g=e===a&&e.length>0,_={weak:"#ef4444",fair:"#f59e0b",good:"#22c55e",strong:"#059669"},v={weak:"Weak",fair:"Fair",good:"Good",strong:"Strong"};async function E(S){if(S.preventDefault(),!b.allPassed){y("Please meet all password requirements");return}if(!g){y("Passwords do not match");return}m(!0),y(null);try{const{error:x}=await f.auth.updateUser({password:e});if(x)throw x;const{data:{user:k}}=await f.auth.getUser();if(k){const{error:C}=await f.from("profiles").update({must_change_password:!1,updated_at:new Date().toISOString()}).eq("id",k.id)}n&&n()}catch(x){y(x.message||"Failed to update password")}finally{m(!1)}}return s.jsx("div",{className:"auth-container",children:s.jsxs("div",{className:"auth-box",style:{maxWidth:"440px"},children:[s.jsxs("div",{className:"auth-logo",children:[s.jsx(Pa,{size:40,style:{color:"var(--primary)",marginBottom:"0.5rem"}}),s.jsx("h1",{className:"auth-title",children:"Set Your Password"}),s.jsx("p",{className:"auth-subtitle",children:"For security, please create a strong password before continuing"})]}),t&&s.jsxs("div",{style:{padding:"0.75rem",background:"#f1f5f9",borderRadius:"0.5rem",marginBottom:"1.5rem",textAlign:"center",fontSize:"0.875rem",color:"#475569"},children:["Logged in as: ",s.jsx("strong",{children:t})]}),s.jsxs("form",{onSubmit:E,children:[s.jsxs("div",{className:"form-group",children:[s.jsx("label",{className:"form-label",htmlFor:"password",children:"New Password"}),s.jsxs("div",{style:{position:"relative"},children:[s.jsx("input",{id:"password",className:"form-input",type:o?"text":"password",placeholder:"Enter new password",value:e,onChange:S=>r(S.target.value),style:{paddingRight:"2.5rem"},required:!0}),s.jsx("button",{type:"button",onClick:()=>c(!o),style:{position:"absolute",right:"0.75rem",top:"50%",transform:"translateY(-50%)",background:"none",border:"none",cursor:"pointer",color:"#64748b",padding:"0.25rem"},children:o?s.jsx(hr,{size:18}):s.jsx(jt,{size:18})})]})]}),e.length>0&&s.jsxs("div",{style:{marginBottom:"1rem"},children:[s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"0.5rem"},children:[s.jsx("span",{style:{fontSize:"0.75rem",color:"#64748b"},children:"Password Strength"}),s.jsx("span",{style:{fontSize:"0.75rem",fontWeight:"600",color:_[b.strength]},children:v[b.strength]})]}),s.jsx("div",{style:{height:"4px",background:"#e2e8f0",borderRadius:"2px",overflow:"hidden"},children:s.jsx("div",{style:{height:"100%",width:b.strength==="weak"?"25%":b.strength==="fair"?"50%":b.strength==="good"?"75%":"100%",background:_[b.strength],transition:"all 0.3s ease"}})})]}),s.jsxs("div",{style:{background:"#f8fafc",borderRadius:"0.5rem",padding:"0.75rem",marginBottom:"1rem"},children:[s.jsx("div",{style:{fontSize:"0.75rem",color:"#64748b",marginBottom:"0.5rem"},children:"Password Requirements:"}),[{key:"length",label:`At least ${Us.minLength} characters`},{key:"uppercase",label:"One uppercase letter (A-Z)"},{key:"lowercase",label:"One lowercase letter (a-z)"},{key:"number",label:"One number (0-9)"},{key:"special",label:"One special character (!@#$%...)"}].map(({key:S,label:x})=>s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",fontSize:"0.8rem",color:b.checks[S]?"#059669":"#94a3b8",marginBottom:"0.25rem"},children:[b.checks[S]?s.jsx(Ue,{size:14,style:{color:"#059669"}}):s.jsx(be,{size:14,style:{color:"#cbd5e1"}}),x]},S))]}),s.jsxs("div",{className:"form-group",children:[s.jsx("label",{className:"form-label",htmlFor:"confirmPassword",children:"Confirm Password"}),s.jsxs("div",{style:{position:"relative"},children:[s.jsx("input",{id:"confirmPassword",className:"form-input",type:l?"text":"password",placeholder:"Confirm new password",value:a,onChange:S=>i(S.target.value),style:{paddingRight:"2.5rem",borderColor:a.length>0?g?"#22c55e":"#ef4444":void 0},required:!0}),s.jsx("button",{type:"button",onClick:()=>d(!l),style:{position:"absolute",right:"0.75rem",top:"50%",transform:"translateY(-50%)",background:"none",border:"none",cursor:"pointer",color:"#64748b",padding:"0.25rem"},children:l?s.jsx(hr,{size:18}):s.jsx(jt,{size:18})})]}),a.length>0&&!g&&s.jsxs("div",{style:{fontSize:"0.75rem",color:"#ef4444",marginTop:"0.25rem",display:"flex",alignItems:"center",gap:"0.25rem"},children:[s.jsx(be,{size:12})," Passwords do not match"]}),g&&s.jsxs("div",{style:{fontSize:"0.75rem",color:"#22c55e",marginTop:"0.25rem",display:"flex",alignItems:"center",gap:"0.25rem"},children:[s.jsx(Ue,{size:12})," Passwords match"]})]}),p&&s.jsxs("div",{style:{padding:"0.75rem",background:"#fee2e2",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#991b1b"},children:[s.jsx(gt,{size:20}),s.jsx("span",{style:{fontSize:"0.875rem"},children:p})]}),s.jsx("button",{type:"submit",className:"btn btn-primary",disabled:h||!b.allPassed||!g,style:{width:"100%",justifyContent:"center",opacity:!b.allPassed||!g?.5:1},children:h?"Updating...":"Set Password & Continue"})]}),s.jsx("div",{style:{marginTop:"1.5rem",paddingTop:"1rem",borderTop:"1px solid #e2e8f0",textAlign:"center",fontSize:"0.75rem",color:"#94a3b8"},children:"This password will be used to access your account. Choose something memorable but secure."})]})})}function ro(){const n=ke(),[t]=ta(),[e,r]=u.useState(!1),[a,i]=u.useState(""),[o,c]=u.useState(""),[l,d]=u.useState(null),[h,m]=u.useState(null),[p,y]=u.useState(!1),[b,g]=u.useState(!1),[_,v]=u.useState(!1),[E,S]=u.useState(!1);u.useEffect(()=>{t.get("expired")==="true"&&(S(!0),window.history.replaceState({},document.title,"/login")),f.auth.getSession().then(({data:{session:T}})=>{T&&n("/dashboard",{replace:!0})});const{data:{subscription:M}}=f.auth.onAuthStateChange((T,I)=>{T==="SIGNED_IN"&&I&&n("/dashboard",{replace:!0})});return()=>M.unsubscribe()},[n,t]);const x=async M=>{M.preventDefault(),r(!0),d(null),m(null),S(!1);try{if(p){const{error:T}=await f.auth.signUp({email:a,password:o,options:{data:{full_name:a.split("@")[0]}}});if(T)throw T;m("Check your email for confirmation link!")}else{const{error:T}=await f.auth.signInWithPassword({email:a,password:o});if(T)throw T}}catch(T){d(T.message)}finally{r(!1)}},k=async M=>{if(M.preventDefault(),!a){d("Please enter your email address");return}r(!0),d(null),m(null);try{const{error:T}=await f.auth.resetPasswordForEmail(a,{redirectTo:`${window.location.origin}/reset-password`});if(T)throw T;m("Password reset email sent! Check your inbox.")}catch(T){d(T.message)}finally{r(!1)}},C=async M=>{if(M.preventDefault(),!a){d("Please enter your email address");return}r(!0),d(null),m(null);try{const{error:T}=await f.auth.resend({type:"signup",email:a});if(T)throw T;m("Verification email resent! Check your inbox.")}catch(T){d(T.message)}finally{r(!1)}},R=()=>{g(!1),v(!1),d(null),m(null),S(!1)};return b?s.jsx("div",{className:"auth-container",children:s.jsxs("div",{className:"auth-box",children:[s.jsxs("div",{className:"auth-logo",children:[s.jsx(Ma,{size:40,style:{color:"var(--primary)",marginBottom:"0.5rem"}}),s.jsx("h1",{className:"auth-title",children:"Reset Password"}),s.jsx("p",{className:"auth-subtitle",children:"Enter your email to receive a reset link"})]}),s.jsxs("form",{onSubmit:k,children:[s.jsxs("div",{className:"form-group",children:[s.jsx("label",{className:"form-label",htmlFor:"email",children:"Email Address"}),s.jsx("input",{id:"email",className:"form-input",type:"email",placeholder:"you@example.com",value:a,onChange:M=>i(M.target.value),required:!0})]}),l&&s.jsxs("div",{style:{padding:"0.75rem",background:"#fee2e2",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#991b1b"},children:[s.jsx(gt,{size:20}),s.jsx("span",{style:{fontSize:"0.875rem"},children:l})]}),h&&s.jsxs("div",{style:{padding:"0.75rem",background:"#dcfce7",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#166534"},children:[s.jsx(Bt,{size:20}),s.jsx("span",{style:{fontSize:"0.875rem"},children:h})]}),s.jsx("button",{type:"submit",className:"btn btn-primary",disabled:e,style:{width:"100%",justifyContent:"center"},children:e?"Sending...":"Send Reset Link"})]}),s.jsx("div",{style:{marginTop:"1.5rem",textAlign:"center"},children:s.jsx("button",{onClick:R,style:{background:"none",border:"none",color:"var(--primary)",cursor:"pointer",fontSize:"0.875rem"},children:"â† Back to Sign In"})})]})}):_?s.jsx("div",{className:"auth-container",children:s.jsxs("div",{className:"auth-box",children:[s.jsxs("div",{className:"auth-logo",children:[s.jsx(Me,{size:40,style:{color:"var(--primary)",marginBottom:"0.5rem"}}),s.jsx("h1",{className:"auth-title",children:"Resend Verification"}),s.jsx("p",{className:"auth-subtitle",children:"Enter your email to resend the verification link"})]}),s.jsxs("form",{onSubmit:C,children:[s.jsxs("div",{className:"form-group",children:[s.jsx("label",{className:"form-label",htmlFor:"email",children:"Email Address"}),s.jsx("input",{id:"email",className:"form-input",type:"email",placeholder:"you@example.com",value:a,onChange:M=>i(M.target.value),required:!0})]}),l&&s.jsxs("div",{style:{padding:"0.75rem",background:"#fee2e2",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#991b1b"},children:[s.jsx(gt,{size:20}),s.jsx("span",{style:{fontSize:"0.875rem"},children:l})]}),h&&s.jsxs("div",{style:{padding:"0.75rem",background:"#dcfce7",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#166534"},children:[s.jsx(Bt,{size:20}),s.jsx("span",{style:{fontSize:"0.875rem"},children:h})]}),s.jsx("button",{type:"submit",className:"btn btn-primary",disabled:e,style:{width:"100%",justifyContent:"center"},children:e?"Sending...":"Resend Verification Email"})]}),s.jsx("div",{style:{marginTop:"1.5rem",textAlign:"center"},children:s.jsx("button",{onClick:R,style:{background:"none",border:"none",color:"var(--primary)",cursor:"pointer",fontSize:"0.875rem"},children:"â† Back to Sign In"})})]})}):s.jsx("div",{className:"auth-container",children:s.jsxs("div",{className:"auth-box",children:[s.jsxs("div",{className:"auth-logo",children:[s.jsx("h1",{className:"auth-title",children:"AMSF001 Tracker"}),s.jsx("p",{className:"auth-subtitle",children:"Network Architecture Services Project"})]}),E&&s.jsxs("div",{style:{padding:"0.75rem",background:"#fef3c7",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#92400e",border:"1px solid #fcd34d"},children:[s.jsx(_e,{size:20}),s.jsx("span",{style:{fontSize:"0.875rem"},children:"Your session has expired. Please sign in again."})]}),s.jsxs("form",{onSubmit:x,children:[s.jsxs("div",{className:"form-group",children:[s.jsx("label",{className:"form-label",htmlFor:"email",children:"Email Address"}),s.jsx("input",{id:"email",className:"form-input",type:"email",placeholder:"you@example.com",value:a,onChange:M=>i(M.target.value),required:!0})]}),s.jsxs("div",{className:"form-group",children:[s.jsx("label",{className:"form-label",htmlFor:"password",children:"Password"}),s.jsx("input",{id:"password",className:"form-input",type:"password",placeholder:"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢",value:o,onChange:M=>c(M.target.value),required:!0})]}),l&&s.jsxs("div",{style:{padding:"0.75rem",background:"#fee2e2",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#991b1b"},children:[s.jsx(gt,{size:20}),s.jsx("span",{style:{fontSize:"0.875rem"},children:l})]}),h&&s.jsxs("div",{style:{padding:"0.75rem",background:"#dcfce7",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#166534"},children:[s.jsx(Bt,{size:20}),s.jsx("span",{style:{fontSize:"0.875rem"},children:h})]}),s.jsx("button",{type:"submit",className:"btn btn-primary",disabled:e,style:{width:"100%",justifyContent:"center"},children:e?"Loading...":p?"Sign Up":"Sign In"})]}),!p&&s.jsx("div",{style:{marginTop:"1rem",textAlign:"center"},children:s.jsx("button",{onClick:()=>{g(!0),d(null),m(null),S(!1)},style:{background:"none",border:"none",color:"#64748b",cursor:"pointer",fontSize:"0.85rem",textDecoration:"underline"},children:"Forgot your password?"})}),s.jsx("div",{style:{marginTop:"1rem",textAlign:"center"},children:s.jsx("button",{onClick:()=>{y(!p),d(null),m(null),S(!1)},style:{background:"none",border:"none",color:"var(--primary)",cursor:"pointer",fontSize:"0.875rem"},children:p?"Already have an account? Sign In":"Don't have an account? Sign Up"})}),s.jsxs("div",{style:{marginTop:"1.5rem",paddingTop:"1rem",borderTop:"1px solid #e2e8f0",textAlign:"center"},children:[s.jsx("p",{style:{fontSize:"0.8rem",color:"#64748b",marginBottom:"0.5rem"},children:"Haven't received your verification email?"}),s.jsxs("button",{onClick:()=>{v(!0),d(null),m(null),S(!1)},style:{background:"none",border:"none",color:"var(--primary)",cursor:"pointer",fontSize:"0.85rem",display:"inline-flex",alignItems:"center",gap:"0.25rem"},children:[s.jsx(Me,{size:14})," Resend Verification Email"]})]})]})})}const so={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function ao(n){return n==null?"":typeof n!="string"?String(n):n.replace(/[&<>"'`=\/]/g,t=>so[t])}function cr(n,t={}){const{maxLength:e=1e4,trim:r=!0,normalizeWhitespace:a=!0}=t;if(n==null)return"";typeof n!="string"&&(n=String(n));let i=n;return i=i.replace(/\0/g,""),i=i.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,""),r&&(i=i.trim()),a&&(i=i.replace(/[ \t]+/g," ")),i.length>e&&(i=i.substring(0,e)),i}function kt(n,t=255){return n==null?"":(typeof n!="string"&&(n=String(n)),cr(n,{maxLength:t}).replace(/[\r\n]/g," ").replace(/\s+/g," ").trim())}function Vs(n,t=1e4){return n==null?"":(typeof n!="string"&&(n=String(n)),cr(n,{maxLength:t,normalizeWhitespace:!1}).replace(/\r\n/g,`
`).replace(/\r/g,`
`).replace(/\n{3,}/g,`

`).trim())}function zs(n){return n?kt(n,254).toLowerCase():""}function Mt(n,t={}){const{min:e=-1/0,max:r=1/0,decimals:a=2}=t;if(n==null||n==="")return null;let i=String(n).replace(/[^0-9.\-]/g,""),o=parseFloat(i);return isNaN(o)?null:(o=Math.max(e,Math.min(r,o)),o=Math.round(o*Math.pow(10,a))/Math.pow(10,a),o)}function no(n){const t=Mt(n,{min:0,decimals:2});return t!==null?Math.round(t*100)/100:null}function io(n){const t=Mt(n,{min:0,max:24,decimals:1});return t===null?null:Math.round(t*2)/2}function oo(n){return Mt(n,{min:0,max:100,decimals:1})}function lo(n){if(!n)return null;const t=String(n).trim();return/^(javascript|data|vbscript):/i.test(t)?null:/^(https?:\/\/|\/|#)/i.test(t)?t:`https://${t}`}function co(n,t={}){if(!n||typeof n!="object")return n;const e={...n};for(const[r,a]of Object.entries(t)){if(e[r]===void 0)continue;const{type:i="text",maxLength:o}=a;switch(i){case"singleLine":e[r]=kt(e[r],o);break;case"multiLine":e[r]=Vs(e[r],o);break;case"email":e[r]=zs(e[r]);break;case"number":e[r]=Mt(e[r],a);break;case"currency":e[r]=no(e[r]);break;case"hours":e[r]=io(e[r]);break;case"percentage":e[r]=oo(e[r]);break;case"url":e[r]=lo(e[r]);break;case"html":e[r]=ao(e[r]);break;default:e[r]=cr(e[r],{maxLength:o})}}return e}const uo={timesheet:{description:{type:"multiLine",maxLength:2e3},hours_worked:{type:"hours"}},expense:{reason:{type:"multiLine",maxLength:2e3},amount:{type:"currency"}},resource:{name:{type:"singleLine",maxLength:100},email:{type:"email"},role:{type:"singleLine",maxLength:100},notes:{type:"multiLine",maxLength:5e3}},partner:{name:{type:"singleLine",maxLength:200},contact_name:{type:"singleLine",maxLength:100},contact_email:{type:"email"},notes:{type:"multiLine",maxLength:5e3}},milestone:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3}},deliverable:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3}},kpi:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3},target_value:{type:"number",decimals:2},actual_value:{type:"number",decimals:2}},qualityStandard:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3},target_value:{type:"percentage"}}};function Ar(n,t){const e=uo[n];return e?co(t,e):t}class he{constructor(t,e={}){this.tableName=t,this.supportsSoftDelete=e.supportsSoftDelete!==!1,this.sanitizeConfig=e.sanitizeConfig||null}getSoftDeleteFilter(){return this.supportsSoftDelete?"is_deleted.is.null,is_deleted.eq.false":null}async getAll(t,e={}){try{let r=e.select||"*";const a=this.supportsSoftDelete&&!e.includeDeleted;a&&r!=="*"&&!r.includes("is_deleted")&&(r=`${r}, is_deleted`);let i=f.from(this.tableName).select(r).eq("project_id",t);e.filters&&Array.isArray(e.filters)&&e.filters.forEach(d=>{const{column:h,operator:m,value:p}=d;switch(m){case"eq":i=i.eq(h,p);break;case"neq":i=i.neq(h,p);break;case"gt":i=i.gt(h,p);break;case"gte":i=i.gte(h,p);break;case"lt":i=i.lt(h,p);break;case"lte":i=i.lte(h,p);break;case"like":i=i.like(h,p);break;case"ilike":i=i.ilike(h,p);break;case"in":i=i.in(h,p);break;case"is":i=i.is(h,p);break;default:i=i.eq(h,p)}}),e.orderBy&&(i=i.order(e.orderBy.column,{ascending:e.orderBy.ascending??!0}));const{data:o,error:c}=await i;if(c)throw c;let l=o||[];return a&&(l=l.filter(d=>d.is_deleted!==!0)),l}catch(r){throw r}}async getDeleted(t){if(!this.supportsSoftDelete)return[];try{const{data:e,error:r}=await f.from(this.tableName).select("*").eq("project_id",t).eq("is_deleted",!0).order("deleted_at",{ascending:!1});if(r)throw r;return e||[]}catch(e){throw e}}async getById(t,e={}){try{let r=e.select||"*";const a=this.supportsSoftDelete&&!e.includeDeleted;a&&r!=="*"&&!r.includes("is_deleted")&&(r=`${r}, is_deleted`);let i=f.from(this.tableName).select(r).eq("id",t);const{data:o,error:c}=await i.limit(1);if(c)throw c;const l=o&&o.length>0?o[0]:null;return l&&a&&l.is_deleted===!0?null:l}catch(r){throw r}}async create(t){try{if(!t.project_id)throw new Error("project_id is required");let e=t;this.sanitizeConfig&&(e=Ar(this.sanitizeConfig,t)),this.supportsSoftDelete&&(delete e.is_deleted,delete e.deleted_at,delete e.deleted_by);const{data:r,error:a}=await f.from(this.tableName).insert(e).select();if(a)throw a;if(!r||r.length===0)throw new Error("Failed to create record - no data returned");return r[0]}catch(e){throw e}}async update(t,e){try{let r=e;this.sanitizeConfig&&(r=Ar(this.sanitizeConfig,e));const a={...r,updated_at:new Date().toISOString()};delete a.is_deleted,delete a.deleted_at,delete a.deleted_by;const{data:i,error:o}=await f.from(this.tableName).update(a).eq("id",t).select();if(o)throw o;if(!i||i.length===0)throw new Error(`No record found with id: ${t}`);return i[0]}catch(r){throw r}}async delete(t,e=null){try{if(this.supportsSoftDelete){const{error:r}=await f.from(this.tableName).update({is_deleted:!0,deleted_at:new Date().toISOString(),deleted_by:e}).eq("id",t);if(r)throw r}else{const{error:r}=await f.from(this.tableName).delete().eq("id",t);if(r)throw r}return!0}catch(r){throw r}}async hardDelete(t){try{const{error:e}=await f.from(this.tableName).delete().eq("id",t);if(e)throw e;return!0}catch(e){throw e}}async restore(t){if(!this.supportsSoftDelete)throw new Error("This entity does not support soft delete");try{const{data:e,error:r}=await f.from(this.tableName).update({is_deleted:!1,deleted_at:null,deleted_by:null}).eq("id",t).select();if(r)throw r;if(!e||e.length===0)throw new Error(`No record found with id: ${t}`);return e[0]}catch(e){throw e}}async exists(t){try{const{data:e,error:r}=await f.from(this.tableName).select("id, is_deleted").eq("id",t).limit(1);if(r)throw r;if(!e||e.length===0)return!1;const a=e[0];return!(this.supportsSoftDelete&&a.is_deleted===!0)}catch(e){throw e}}async count(t,e=[]){try{let r=f.from(this.tableName).select("id, is_deleted").eq("project_id",t);e.forEach(c=>{const{column:l,operator:d,value:h}=c;d==="eq"?r=r.eq(l,h):d==="in"&&(r=r.in(l,h))});const{data:a,error:i}=await r;if(i)throw i;let o=a||[];return this.supportsSoftDelete&&(o=o.filter(c=>c.is_deleted!==!0)),o.length}catch(r){throw r}}}const Ne=new Map,mo=5*60*1e3,ho=100;function bt(n,t,e=""){return`${n}:${t}${e?`:${e}`:""}`}function wt(n){const t=Ne.get(n);if(!t)return null;const e=Date.now();return e-t.timestamp>t.ttl?(Ne.delete(n),null):(t.accessCount++,t.lastAccess=e,t.data)}function vt(n,t,e=mo){Ne.size>=ho&&po(),Ne.set(n,{data:t,timestamp:Date.now(),ttl:e,accessCount:1,lastAccess:Date.now()})}function Pe(n){for(const t of Ne.keys())t.startsWith(`${n}:`)&&Ne.delete(t)}function po(){const n=Array.from(Ne.entries()).sort((e,r)=>e[1].lastAccess-r[1].lastAccess),t=Math.ceil(n.length*.2);for(let e=0;e<t;e++)Ne.delete(n[e][0])}const xt={LONG:15*60*1e3},Be="partners";class fo extends he{constructor(){super("partners")}async getAll(t,e=!1){const r=bt(Be,t,"all");if(!e){const i=wt(r);if(i)return i}const a=await super.getAll(t,{orderBy:{column:"name",ascending:!0}});return vt(r,a,xt.LONG),a}async getActive(t){const e=bt(Be,t,"active"),r=wt(e);if(r)return r;const a=await super.getAll(t,{filters:[{column:"is_active",operator:"eq",value:!0}],orderBy:{column:"name",ascending:!0}});return vt(e,a,xt.LONG),a}async getWithResources(t){try{const{data:e,error:r}=await f.from("partners").select(`
          *,
          resources (
            id,
            name,
            sell_price,
            cost_price,
            is_active
          )
        `).eq("id",t).limit(1);if(r)throw r;return e?.[0]||null}catch(e){throw e}}async getSummary(t){try{const{data:e,error:r}=await f.from("partners").select(`
          id,
          name,
          contact_name,
          contact_email,
          payment_terms,
          is_active,
          created_at
        `).eq("project_id",t).order("name",{ascending:!0});if(r)throw r;return e||[]}catch(e){throw e}}async create(t){if(!t.name?.trim())throw new Error("Partner name is required");if(await this.findByName(t.project_id,t.name))throw new Error(`Partner "${t.name}" already exists`);const r=await super.create({...t,name:t.name.trim(),is_active:t.is_active??!0,payment_terms:t.payment_terms||"Net 30"});return Pe(Be),r}async update(t,e){const r=await super.update(t,e);return Pe(Be),r}async delete(t,e=null){const r=await super.delete(t,e);return Pe(Be),r}async findByName(t,e){try{const{data:r,error:a}=await f.from("partners").select("*").eq("project_id",t).ilike("name",e.trim()).limit(1);if(a)throw a;return r?.[0]||null}catch(r){throw r}}async toggleActive(t){const e=await this.getById(t);if(!e)throw new Error("Partner not found");const r=await this.update(t,{is_active:!e.is_active});return Pe(Be),r}async getForSelect(t,e=!0){const r=bt(Be,t,`select-${e}`),a=wt(r);if(a)return a;const o=(e?await this.getActive(t):await this.getAll(t)).map(c=>({value:c.id,label:c.name}));return vt(r,o,xt.LONG),o}async getDependencyCounts(t){try{const{data:e,error:r}=await f.from("resources").select("id").eq("partner_id",t).or("is_deleted.is.null,is_deleted.eq.false");if(r)throw r;const a=e?.map(d=>d.id)||[];let i=0,o=0;if(a.length>0){const{count:d,error:h}=await f.from("timesheets").select("*",{count:"exact",head:!0}).in("resource_id",a).or("is_deleted.is.null,is_deleted.eq.false");if(h)throw h;i=d||0;const{count:m,error:p}=await f.from("expenses").select("*",{count:"exact",head:!0}).in("resource_id",a).or("is_deleted.is.null,is_deleted.eq.false");if(p)throw p;o=m||0}const{count:c,error:l}=await f.from("partner_invoices").select("*",{count:"exact",head:!0}).eq("partner_id",t).or("is_deleted.is.null,is_deleted.eq.false");if(l)throw l;return{resourceCount:e?.length||0,timesheetCount:i,expenseCount:o,invoiceCount:c||0,canDelete:!e?.length&&!c}}catch(e){throw e}}}const Mc=new fo,tt="resources";class go extends he{constructor(){super("resources",{sanitizeConfig:"resource",supportsSoftDelete:!0})}sanitizeData(t){const e={...t};return e.name&&(e.name=kt(e.name,100)),e.role&&(e.role=kt(e.role,100)),e.email&&(e.email=zs(e.email)),e.notes&&(e.notes=Vs(e.notes,5e3)),e}async getAll(t,e={}){const{includePartner:r=!0,activeOnly:a=!1,showTestUsers:i=!0,includeDeleted:o=!1}=e;let c="*";r&&(c="*, partner:partners(id, name, is_active)");let l=f.from(this.tableName).select(c).eq("project_id",t).order("name");o||(l=l.or("is_deleted.is.null,is_deleted.eq.false")),a&&(l=l.eq("is_active",!0)),i||(l=l.or("is_test_content.is.null,is_test_content.eq.false"));const{data:d,error:h}=await l;if(h)throw h;return d||[]}async getAllFiltered(t,e=!0){return this.getAll(t,{showTestUsers:e,includePartner:!0})}async getById(t){const{data:e,error:r}=await f.from(this.tableName).select("*, partner:partners(id, name, contact_name, contact_email, is_active)").eq("id",t).or("is_deleted.is.null,is_deleted.eq.false").single();if(r)throw r;return e}async getByType(t,e){const{data:r,error:a}=await f.from(this.tableName).select("*, partner:partners(id, name)").eq("project_id",t).eq("resource_type",e).or("is_deleted.is.null,is_deleted.eq.false").order("name");if(a)throw a;return r||[]}async getByPartner(t){const{data:e,error:r}=await f.from(this.tableName).select("*").eq("partner_id",t).or("is_deleted.is.null,is_deleted.eq.false").order("name");if(r)throw r;return e||[]}async getWithTimesheetSummary(t){const e=await this.getById(t);if(!e)return null;const{data:r,error:a}=await f.from("timesheets").select("id, hours_worked, hours, status, was_rejected, date").eq("resource_id",t).or("is_deleted.is.null,is_deleted.eq.false");let i=0,o=0,c=0;return r&&r.forEach(l=>{const d=parseFloat(l.hours_worked||l.hours||0);i+=d,l.status==="Approved"?o+=d:l.status==="Submitted"&&!l.was_rejected&&(c+=d)}),{...e,timesheetSummary:{totalEntries:r?.length||0,totalHours:i,approvedHours:o,pendingHours:c,daysWorked:Ze(i)}}}async create(t){const e=this.sanitizeData(t);if(!e.name?.trim())throw new Error("Resource name is required");if(!e.project_id)throw new Error("Project ID is required");if(!e.email?.trim())throw new Error("Email is required");e.resource_type==="internal"&&(e.partner_id=null);const{data:r,error:a}=await f.from(this.tableName).insert([e]).select("*, partner:partners(id, name)").single();if(a)throw a;return Pe(tt),r}async update(t,e){const r=this.sanitizeData(e);r.resource_type==="internal"&&(r.partner_id=null),r.updated_at=new Date().toISOString();const{data:a,error:i}=await f.from(this.tableName).update(r).eq("id",t).select("*, partner:partners(id, name)").single();if(i)throw i;return Pe(tt),a}async delete(t,e=null){const{data:r,error:a}=await f.from(this.tableName).update({is_deleted:!0,deleted_at:new Date().toISOString(),deleted_by:e}).eq("id",t).select().single();if(a)throw a;return Pe(tt),r}async restore(t){const{data:e,error:r}=await f.from(this.tableName).update({is_deleted:!1,deleted_at:null,deleted_by:null}).eq("id",t).select().single();if(r)throw r;return Pe(tt),e}async linkToPartner(t,e){const r={partner_id:e,resource_type:e?"third_party":"internal",updated_at:new Date().toISOString()};return this.update(t,r)}async toggleActive(t){const e=await this.getById(t);if(!e)throw new Error("Resource not found");return this.update(t,{is_active:!e.is_active})}async getForSelect(t){const e=bt(tt,t,"select"),r=wt(e);if(r)return r;const{data:a,error:i}=await f.from(this.tableName).select("id, name, resource_type, role").eq("project_id",t).or("is_deleted.is.null,is_deleted.eq.false").order("name");if(i)throw i;const o=a||[];return vt(e,o,xt.LONG),o}calculateMargin(t,e){if(!t||t===0||!e)return{percent:null,amount:null,status:"unknown"};const r=(t-e)/t*100,a=t-e;let i="critical";return r>=25?i="good":r>=10&&(i="low"),{percent:r,amount:a,status:i}}async getUtilization(t){const e=await this.getWithTimesheetSummary(t);if(!e)return null;const r=e.days_allocated||0,a=e.timesheetSummary.daysWorked,i=Math.max(0,r-a),o=r>0?a/r*100:0;return{resourceId:t,resourceName:e.name,daysAllocated:r,daysUsed:a,remaining:i,utilizationPercent:o,totalValue:(e.sell_price||0)*r,valueUsed:(e.sell_price||0)*a}}async getSummary(t){const e=await this.getAll(t,{includePartner:!1});return{total:e.length,internal:e.filter(r=>r.resource_type==="internal").length,thirdParty:e.filter(r=>r.resource_type==="third_party").length,active:e.filter(r=>r.is_active).length,totalBudget:e.reduce((r,a)=>r+(a.sell_price||0)*(a.days_allocated||0),0)}}async getProfileByEmail(t){try{const{data:e,error:r}=await this.supabase.from("profiles").select("id, email, full_name, role").eq("email",t).single();if(r){if(r.code==="PGRST116")return null;throw r}return e}catch(e){throw e}}async getAllWithTestFilter(t,e=[]){try{const r=await this.getAll(t,{orderBy:{column:"name",ascending:!0}});return e&&e.length>0?r.filter(a=>!a.user_id||!e.includes(a.user_id)):r}catch(r){throw r}}async getDependencyCounts(t){try{const[e,r]=await Promise.all([this.supabase.from("timesheets").select("id",{count:"exact",head:!0}).eq("resource_id",t).or("is_deleted.is.null,is_deleted.eq.false"),this.supabase.from("expenses").select("id",{count:"exact",head:!0}).eq("resource_id",t).or("is_deleted.is.null,is_deleted.eq.false")]);return{timesheetCount:e.count||0,expenseCount:r.count||0,canDelete:(e.count||0)===0&&(r.count||0)===0}}catch(e){throw e}}}const Nc=new go;class yo extends he{constructor(){super("timesheets",{supportsSoftDelete:!0,sanitizeConfig:"timesheet"})}async getAll(t,e={}){return super.getAll(t,{...e,select:e.select||`
      *,
      resources(id, name, email, sell_price, cost_price),
      milestones(id, milestone_ref, name)
    `,orderBy:e.orderBy||{column:"date",ascending:!1}})}async getAllFiltered(t,e=!1){try{let r=f.from(this.tableName).select(`
          *,
          resources(id, name, email, sell_price, cost_price),
          milestones(id, milestone_ref, name)
        `).eq("project_id",t).order("date",{ascending:!1});this.supportsSoftDelete&&(r=r.or(this.getSoftDeleteFilter())),e||(r=r.or("is_test_content.is.null,is_test_content.eq.false"));const{data:a,error:i}=await r;if(i)throw i;return a||[]}catch(r){throw r}}async getByResource(t,e={}){try{let r=f.from(this.tableName).select("*, milestones(id, milestone_ref, name)").eq("resource_id",t).order("date",{ascending:!1});this.supportsSoftDelete&&(r=r.or(this.getSoftDeleteFilter())),e.start&&(r=r.gte("date",e.start)),e.end&&(r=r.lte("date",e.end)),e.status&&(r=r.eq("status",e.status));const{data:a,error:i}=await r;if(i)throw i;return a||[]}catch(r){throw r}}async getByPartner(t,e={}){try{const{data:r}=await f.from("resources").select("id, name, cost_price").eq("partner_id",t).or("is_deleted.is.null,is_deleted.eq.false");if(!r||r.length===0)return[];const a=r.map(l=>l.id);let i=f.from(this.tableName).select("*, resources(id, name, cost_price), milestones(id, milestone_ref, name)").in("resource_id",a).order("date",{ascending:!1});this.supportsSoftDelete&&(i=i.or(this.getSoftDeleteFilter())),e.start&&(i=i.gte("date",e.start)),e.end&&(i=i.lte("date",e.end)),e.status&&(i=i.eq("status",e.status));const{data:o,error:c}=await i;if(c)throw c;return o||[]}catch(r){throw r}}async getApprovedForInvoice(t,e){if(!e.start||!e.end)throw new Error("Date range (start and end) is required for invoice queries");return this.getByPartner(t,{...e,status:"Approved"})}async getSummary(t,e={}){try{const r=await this.getAll(t,e),a={totalHours:0,totalDays:0,approvedHours:0,pendingHours:0,draftHours:0,rejectedHours:0,totalCost:0,approvedCost:0,byStatus:{Draft:{count:0,hours:0},Submitted:{count:0,hours:0},Approved:{count:0,hours:0},Rejected:{count:0,hours:0}},byMilestone:{},count:r.length};return r.forEach(i=>{const o=parseFloat(i.hours_worked||i.hours||0),c=i.resources?.cost_price||0,l=Sr(o,c);switch(a.totalHours+=o,a.totalCost+=l,a.byStatus[i.status]&&(a.byStatus[i.status].count++,a.byStatus[i.status].hours+=o),i.status){case"Approved":a.approvedHours+=o,a.approvedCost+=l;break;case"Submitted":i.was_rejected||(a.pendingHours+=o);break;case"Draft":a.draftHours+=o;break;case"Rejected":a.rejectedHours+=o;break}if(i.milestone_id){const d=i.milestones?.milestone_ref||"Unknown";a.byMilestone[i.milestone_id]||(a.byMilestone[i.milestone_id]={ref:d,name:i.milestones?.name||"Unknown",hours:0,cost:0}),a.byMilestone[i.milestone_id].hours+=o,a.byMilestone[i.milestone_id].cost+=l}}),a.totalDays=Ze(a.totalHours),a}catch(r){throw r}}async create(t){if(!t.resource_id)throw new Error("resource_id is required");if(!t.date)throw new Error("date is required");const e=parseFloat(t.hours_worked||t.hours||0);if(!e||e<=0)throw new Error("hours must be greater than 0");const r={...t,hours_worked:e,hours:e,date:t.date||t.work_date,work_date:t.work_date||t.date,description:t.description||t.comments||"",comments:t.comments||t.description||"",status:t.status||"Draft"};return super.create(r)}async submit(t){return this.update(t,{status:"Submitted"})}async validate(t){return this.update(t,{status:"Approved"})}async approve(t){return this.validate(t)}async reject(t,e=null){const r={status:"Rejected",was_rejected:!0};return e&&(r.rejection_reason=e),this.update(t,r)}calculateCost(t,e){return Sr(t,e)}calculateBillable(t,e){return or(t,e)}}const Fs=new yo;class bo extends he{constructor(){super("expenses",{supportsSoftDelete:!0,sanitizeConfig:"expense"})}async getAll(t,e={}){return super.getAll(t,{...e,select:e.select||"*, expense_files(*)",orderBy:e.orderBy||{column:"expense_date",ascending:!1}})}async getAllFiltered(t,e=!1){try{let r=f.from(this.tableName).select("*, expense_files(*)").eq("project_id",t).order("expense_date",{ascending:!1});const{data:a,error:i}=await r;if(i)throw i;let o=a||[];return this.supportsSoftDelete&&(o=o.filter(c=>c.is_deleted!==!0)),e||(o=o.filter(c=>c.is_test_content!==!0)),o}catch(r){throw r}}async getByResource(t,e={}){try{let r=f.from(this.tableName).select("*, expense_files(*)").eq("resource_id",t).order("expense_date",{ascending:!1});e.start&&(r=r.gte("expense_date",e.start)),e.end&&(r=r.lte("expense_date",e.end));const{data:a,error:i}=await r;if(i)throw i;let o=a||[];return this.supportsSoftDelete&&(o=o.filter(c=>c.is_deleted!==!0)),o}catch(r){throw r}}async getByPartner(t,e={}){try{const{data:r}=await f.from("resources").select("id").eq("partner_id",t);if(!r||r.length===0)return[];const a=r.map(d=>d.id);let i=f.from(this.tableName).select("*, expense_files(*)").in("resource_id",a).order("expense_date",{ascending:!1});e.start&&(i=i.gte("expense_date",e.start)),e.end&&(i=i.lte("expense_date",e.end)),e.procurementMethod&&(i=i.eq("procurement_method",e.procurementMethod));const{data:o,error:c}=await i;if(c)throw c;let l=o||[];return this.supportsSoftDelete&&(l=l.filter(d=>d.is_deleted!==!0)),l}catch(r){throw r}}async getPartnerProcuredForInvoice(t,e){if(!e.start||!e.end)throw new Error("Date range (start and end) is required for invoice queries");return this.getByPartner(t,{...e,procurementMethod:"partner"})}async getSummary(t,e={}){try{const r=await this.getAll(t,e),a={total:0,chargeable:0,nonChargeable:0,supplierProcured:0,partnerProcured:0,byCategory:{Travel:0,Accommodation:0,Sustenance:0},byStatus:{Draft:0,Submitted:0,Approved:0,Rejected:0,Paid:0},count:r.length};return r.forEach(i=>{const o=parseFloat(i.amount||0);a.total+=o,i.chargeable_to_customer!==!1?a.chargeable+=o:a.nonChargeable+=o,i.procurement_method==="partner"?a.partnerProcured+=o:a.supplierProcured+=o,a.byCategory[i.category]!==void 0&&(a.byCategory[i.category]+=o),a.byStatus[i.status]!==void 0&&(a.byStatus[i.status]+=o)}),a}catch(r){throw r}}async create(t){if(!t.resource_id)throw new Error("resource_id is required");if(!t.category)throw new Error("category is required");if(!t.amount||t.amount<=0)throw new Error("amount must be greater than 0");const e={...t,status:t.status||"Draft",chargeable_to_customer:t.chargeable_to_customer??!0,procurement_method:t.procurement_method||"supplier"};return super.create(e)}async createMany(t){if(!t||t.length===0)return[];try{const e=t.map(i=>{if(!i.resource_id)throw new Error("resource_id is required for all expenses");if(!i.category)throw new Error("category is required for all expenses");if(!i.amount||i.amount<=0)throw new Error("amount must be greater than 0 for all expenses");return{...i,status:i.status||"Draft",chargeable_to_customer:i.chargeable_to_customer??!0,procurement_method:i.procurement_method||"supplier"}}),{data:r,error:a}=await f.from(this.tableName).insert(e).select();if(a)throw a;return r||[]}catch(e){throw e}}async submit(t){return this.update(t,{status:"Submitted"})}async validate(t){return this.update(t,{status:"Approved"})}async approve(t){return this.validate(t)}async reject(t,e=null){const r={status:"Rejected"};return e&&(r.rejection_reason=e),this.update(t,r)}async markPaid(t){return this.update(t,{status:"Paid"})}async uploadReceipt(t,e,r){try{const a=`${t}/${Date.now()}-${e.name}`,{error:i}=await f.storage.from("receipts").upload(a,e);if(i)throw i;const{data:o,error:c}=await f.from("expense_files").insert({expense_id:t,file_name:e.name,file_path:a,file_size:e.size,file_type:e.type,uploaded_by:r}).select();if(c)throw c;return o?.[0]}catch(a){throw a}}async downloadReceipt(t){try{const{data:e,error:r}=await f.storage.from("receipts").download(t);if(r)throw r;return e}catch(e){throw e}}}const Hs=new bo;class wo extends he{constructor(){super("partner_invoices")}async getAll(t,e={}){return super.getAll(t,{...e,select:e.select||"*, partners(name)",orderBy:e.orderBy||{column:"invoice_date",ascending:!1}})}async getByPartner(t,e={}){try{let r=f.from(this.tableName).select("*").eq("partner_id",t).order("invoice_date",{ascending:!1});e.status&&(r=r.eq("status",e.status));const{data:a,error:i}=await r;if(i)throw i;return a||[]}catch(r){throw r}}async getWithLines(t){try{const{data:e,error:r}=await f.from(this.tableName).select("*, partners(name, contact_name, contact_email, payment_terms)").eq("id",t).limit(1);if(r)throw r;const a=e?.[0];if(!a)return null;const{data:i,error:o}=await f.from("partner_invoice_lines").select("*").eq("invoice_id",t).order("line_type",{ascending:!0}).order("resource_name",{ascending:!0}).order("line_date",{ascending:!0});if(o)throw o;const c={timesheets:(i||[]).filter(l=>l.line_type==="timesheet"),supplierExpenses:(i||[]).filter(l=>l.line_type==="supplier_expense"),partnerExpenses:(i||[]).filter(l=>l.line_type==="expense")};return{...a,lines:i||[],groupedLines:c}}catch(e){throw e}}async generateInvoiceNumber(t){try{const r=`INV-${new Date().getFullYear()}-`,{data:a,error:i}=await f.from(this.tableName).select("invoice_number").eq("project_id",t).like("invoice_number",`${r}%`).order("invoice_number",{ascending:!1}).limit(1);if(i)throw i;let o=1;if(a&&a.length>0){const c=a[0].invoice_number,l=parseInt(c.replace(r,""),10);isNaN(l)||(o=l+1)}return`${r}${String(o).padStart(3,"0")}`}catch(e){throw e}}async generateInvoice(t){const{projectId:e,partnerId:r,periodStart:a,periodEnd:i,createdBy:o,notes:c,includeSubmitted:l=!0,invoiceType:d="combined"}=t,h=d==="combined"||d==="timesheets",m=d==="combined"||d==="expenses";try{const{data:p,error:y}=await f.from("resources").select("id, name, cost_price").eq("partner_id",r);if(y)throw y;if(!p||p.length===0)throw new Error("No resources linked to this partner");const b=p.map(N=>N.id),g={};p.forEach(N=>{g[N.id]=N});let _=[];if(h){const N=l?["Approved","Submitted"]:["Approved"],{data:J,error:L}=await f.from("timesheets").select("id, date, hours_worked, hours, status, resource_id").in("resource_id",b).gte("date",a).lte("date",i).in("status",N);if(L)throw L;_=J||[]}let v=[];if(m){const{data:N,error:J}=await f.from("expenses").select("id, expense_date, category, reason, amount, resource_id, resource_name, procurement_method, chargeable_to_customer, status").in("resource_id",b).gte("expense_date",a).lte("expense_date",i).in("status",["Approved","Submitted","Paid"]);if(J)throw J;v=N||[]}const E=(v||[]).filter(N=>N.procurement_method==="partner"||!N.procurement_method),S=(v||[]).filter(N=>N.procurement_method==="supplier");let x=0,k=0;const C=[],R={};(_||[]).forEach(N=>{R[N.resource_id]||(R[N.resource_id]=[]),R[N.resource_id].push(N)}),Object.keys(R).forEach(N=>{const J=g[N];R[N].forEach(F=>{const Oe=parseFloat(F.hours_worked||F.hours||0),et=J?.cost_price||0,ht=Ze(Oe),G=ht*et;x+=G,k+=G,C.push({line_type:"timesheet",timesheet_id:F.id,expense_id:null,description:`${J?.name||"Unknown"} - ${Oe}h (${ht.toFixed(2)} days)`,quantity:Oe,unit_price:et,line_total:G,resource_name:J?.name,line_date:F.date,hours:Oe,cost_price:et,source_status:F.status,chargeable_to_customer:!0,procurement_method:null,expense_category:null})})});let M=0,T=0,I=0;const j=[];E.forEach(N=>{const J=parseFloat(N.amount||0);M+=J,N.chargeable_to_customer?T+=J:I+=J,j.push({line_type:"expense",timesheet_id:null,expense_id:N.id,description:`${N.resource_name} - ${N.category}: ${N.reason}`,quantity:1,unit_price:J,line_total:J,resource_name:N.resource_name,line_date:N.expense_date,hours:null,cost_price:null,source_status:N.status,chargeable_to_customer:N.chargeable_to_customer,procurement_method:"partner",expense_category:N.category})});let A=0,U=0,ae=0;const ee=[];S.forEach(N=>{const J=parseFloat(N.amount||0);A+=J,N.chargeable_to_customer?U+=J:ae+=J,ee.push({line_type:"supplier_expense",timesheet_id:null,expense_id:N.id,description:`${N.resource_name} - ${N.category}: ${N.reason}`,quantity:1,unit_price:J,line_total:J,resource_name:N.resource_name,line_date:N.expense_date,hours:null,cost_price:null,source_status:N.status,chargeable_to_customer:N.chargeable_to_customer,procurement_method:"supplier",expense_category:N.category})});const ie=x+M,je=k+T+U,Ie=I+ae,O=await this.generateInvoiceNumber(e),re=d==="timesheets"?"Timesheets Only":d==="expenses"?"Expenses Only":"Combined (Timesheets & Expenses)",{data:we,error:ue}=await f.from(this.tableName).insert({project_id:e,partner_id:r,invoice_number:O,invoice_date:new Date().toISOString().split("T")[0],period_start:a,period_end:i,timesheet_total:x,expense_total:M,supplier_expense_total:A,invoice_total:ie,chargeable_total:je,non_chargeable_total:Ie,status:"Draft",notes:c||`Invoice Type: ${re}`,created_by:o,invoice_type:d}).select().single();if(ue)throw ue;const Ce=[...C,...j,...ee].map(N=>({...N,invoice_id:we.id}));if(Ce.length>0){const{error:N}=await f.from("partner_invoice_lines").insert(Ce);if(N)throw N}return this.getWithLines(we.id)}catch(p){throw p}}async updateStatus(t,e){const r={status:e};return e==="Sent"?r.sent_at=new Date().toISOString():e==="Paid"&&(r.paid_at=new Date().toISOString()),this.update(t,r)}async markSent(t){return this.updateStatus(t,"Sent")}async markPaid(t){return this.updateStatus(t,"Paid")}async cancel(t){return this.updateStatus(t,"Cancelled")}async getPartnerStats(t){try{const{data:e,error:r}=await f.from(this.tableName).select("status, invoice_total").eq("partner_id",t);if(r)throw r;const a={total:0,draft:0,sent:0,paid:0,cancelled:0,count:e?.length||0};return(e||[]).forEach(i=>{const o=parseFloat(i.invoice_total||0);switch(a.total+=o,i.status){case"Draft":a.draft+=o;break;case"Sent":a.sent+=o;break;case"Paid":a.paid+=o;break;case"Cancelled":a.cancelled+=o;break}}),a}catch(e){throw e}}}const Ic=new wo;class vo extends he{constructor(){super("milestones",{supportsSoftDelete:!0,sanitizeConfig:"milestone"})}async getAllWithStats(t){try{const e=await this.getAll(t,{orderBy:{column:"start_date",ascending:!0}}),{data:r}=await f.from("timesheets").select("milestone_id, hours_worked").eq("project_id",t).not("milestone_id","is",null).or("is_deleted.is.null,is_deleted.eq.false"),a={};return(r||[]).forEach(i=>{a[i.milestone_id]||(a[i.milestone_id]=0),a[i.milestone_id]+=parseFloat(i.hours_worked||0)}),e.map(i=>({...i,logged_hours:a[i.id]||0,logged_days:Ze(a[i.id]||0)}))}catch(e){throw e}}async getWithDeliverables(t){try{const{data:e,error:r}=await f.from(this.tableName).select("*").eq("id",t).or(this.getSoftDeleteFilter()).limit(1);if(r)throw r;const a=e?.[0],{data:i,error:o}=await f.from("deliverables").select("*").eq("milestone_id",t).or("is_deleted.is.null,is_deleted.eq.false").order("due_date",{ascending:!0});if(o)throw o;return{...a,deliverables:i||[]}}catch(e){throw e}}async getByStatus(t,e){return this.getAll(t,{filters:[{column:"status",operator:"eq",value:e}],orderBy:{column:"start_date",ascending:!0}})}async getUpcoming(t,e=30){try{const r=new Date().toISOString().split("T")[0],a=new Date;a.setDate(a.getDate()+e);const i=a.toISOString().split("T")[0];let o=f.from(this.tableName).select("*").eq("project_id",t).gte("end_date",r).lte("end_date",i).neq("status","Completed").order("end_date",{ascending:!0});this.supportsSoftDelete&&(o=o.or(this.getSoftDeleteFilter()));const{data:c,error:l}=await o;if(l)throw l;return c||[]}catch(r){throw r}}async updateStatus(t,e){return this.update(t,{status:e})}async updateCompletion(t,e){const r={completion_percentage:e};return e>=100&&(r.status="Completed"),this.update(t,r)}async getSummary(t){try{const e=await this.getAll(t),r={total:e.length,completed:0,inProgress:0,notStarted:0,overdue:0,upcoming:0},a=new Date().toISOString().split("T")[0],i=new Date;i.setDate(i.getDate()+7);const o=i.toISOString().split("T")[0];return e.forEach(c=>{c.status==="Completed"?r.completed++:c.status==="In Progress"?(r.inProgress++,c.end_date<a&&r.overdue++):c.status==="Not Started"&&(r.notStarted++,c.start_date<=o&&r.upcoming++)}),r}catch(e){throw e}}async getCertificates(t){try{const{data:e,error:r}=await f.from("milestone_certificates").select("*").eq("project_id",t).order("created_at",{ascending:!1});if(r)throw r;return e||[]}catch(e){throw e}}async getCertificateByMilestoneId(t){try{const{data:e,error:r}=await f.from("milestone_certificates").select("*").eq("milestone_id",t).limit(1);if(r)throw r;return e?.[0]||null}catch(e){throw e}}async createCertificate(t){try{const{data:e,error:r}=await f.from("milestone_certificates").insert([t]).select();if(r)throw r;return e?.[0]}catch(e){throw e}}async updateCertificate(t,e){try{const{data:r,error:a}=await f.from("milestone_certificates").update(e).eq("id",t).select();if(a)throw a;return r?.[0]}catch(r){throw r}}async signCertificate(t,e,r,a){try{const{data:i,error:o}=await f.from("milestone_certificates").select("*").eq("id",t).limit(1);if(o)throw o;const c=i?.[0];if(!c)throw new Error("Certificate not found");const l=new Date().toISOString(),d={};if(e==="supplier")d.supplier_pm_id=r,d.supplier_pm_name=a,d.supplier_pm_signed_at=l,d.status=c.customer_pm_signed_at?"Signed":"Pending Customer Signature";else if(e==="customer")d.customer_pm_id=r,d.customer_pm_name=a,d.customer_pm_signed_at=l,d.status=c.supplier_pm_signed_at?"Signed":"Pending Supplier Signature";else throw new Error('Invalid signer role. Must be "supplier" or "customer".');const{data:h,error:m}=await f.from("milestone_certificates").update(d).eq("id",t).select();if(m)throw m;return h?.[0]}catch(i){throw i}}async signBaseline(t,e,r,a){try{const i=await this.getById(t);if(!i)throw new Error("Milestone not found");const o=new Date().toISOString(),c={};if(e==="supplier")c.baseline_supplier_pm_id=r,c.baseline_supplier_pm_name=a,c.baseline_supplier_pm_signed_at=o,i.baseline_customer_pm_signed_at&&(c.baseline_locked=!0);else if(e==="customer")c.baseline_customer_pm_id=r,c.baseline_customer_pm_name=a,c.baseline_customer_pm_signed_at=o,i.baseline_supplier_pm_signed_at&&(c.baseline_locked=!0);else throw new Error('Invalid signer role. Must be "supplier" or "customer".');return await this.update(t,c)}catch(i){throw i}}async resetBaseline(t){try{return await this.update(t,{baseline_locked:!1,baseline_supplier_pm_id:null,baseline_supplier_pm_name:null,baseline_supplier_pm_signed_at:null,baseline_customer_pm_id:null,baseline_customer_pm_name:null,baseline_customer_pm_signed_at:null})}catch(e){throw e}}async getBillableMilestones(t){try{const e=await this.getAll(t,{filters:[{column:"billable",operator:"gt",value:0}],orderBy:{column:"milestone_ref",ascending:!0}}),r=e.map(o=>o.id),{data:a}=await f.from("milestone_certificates").select("milestone_id, status").eq("project_id",t),i={};if((a||[]).forEach(o=>{(!i[o.milestone_id]||o.status==="Signed")&&(i[o.milestone_id]=o.status)}),r.length>0){const{data:o}=await f.from("deliverables").select("milestone_id, due_date").in("milestone_id",r).or("is_deleted.is.null,is_deleted.eq.false"),c={};return(o||[]).forEach(l=>{l.due_date&&(!c[l.milestone_id]||l.due_date>c[l.milestone_id])&&(c[l.milestone_id]=l.due_date)}),e.map(l=>({...l,expected_date:c[l.id]||l.forecast_end_date||l.end_date,certificate_status:i[l.id]||null,ready_to_bill:i[l.id]==="Signed"}))}return e.map(o=>({...o,expected_date:o.forecast_end_date||o.end_date,certificate_status:i[o.id]||null,ready_to_bill:i[o.id]==="Signed"}))}catch(e){throw e}}}const Ke=new vo;class xo extends he{constructor(){super("deliverables",{supportsSoftDelete:!0,sanitizeConfig:"deliverable"})}async getAllWithMilestones(t){return this.getAll(t,{select:"*, milestones(name, milestone_ref)",orderBy:{column:"due_date",ascending:!0}})}async getByMilestone(t){try{let e=f.from(this.tableName).select("*").eq("milestone_id",t).order("due_date",{ascending:!0});this.supportsSoftDelete&&(e=e.or(this.getSoftDeleteFilter()));const{data:r,error:a}=await e;if(a)throw a;return r||[]}catch(e){throw e}}async getByStatus(t,e){return this.getAll(t,{filters:[{column:"status",operator:"eq",value:e}],orderBy:{column:"due_date",ascending:!0}})}async getOverdue(t){try{const e=new Date().toISOString().split("T")[0];let r=f.from(this.tableName).select("*, milestones(name)").eq("project_id",t).lt("due_date",e).not("status","in",'("Delivered","Cancelled")').order("due_date",{ascending:!0});this.supportsSoftDelete&&(r=r.or(this.getSoftDeleteFilter()));const{data:a,error:i}=await r;if(i)throw i;return a||[]}catch(e){throw e}}async getUpcoming(t,e=14){try{const r=new Date().toISOString().split("T")[0],a=new Date;a.setDate(a.getDate()+e);const i=a.toISOString().split("T")[0];let o=f.from(this.tableName).select("*, milestones(name)").eq("project_id",t).gte("due_date",r).lte("due_date",i).not("status","eq","Delivered").order("due_date",{ascending:!0});this.supportsSoftDelete&&(o=o.or(this.getSoftDeleteFilter()));const{data:c,error:l}=await o;if(l)throw l;return c||[]}catch(r){throw r}}async updateStatus(t,e,r){const a={status:e};return e==="Submitted"?(a.submitted_date=new Date().toISOString(),a.submitted_by=r):e==="Delivered"&&(a.delivered_date=new Date().toISOString(),a.delivered_by=r),this.update(t,a)}async submit(t,e){return this.updateStatus(t,"Submitted",e)}async markDelivered(t,e){return this.updateStatus(t,"Delivered",e)}async reject(t,e){return this.update(t,{status:"Rejected",rejection_reason:e})}async getSummary(t){try{const e=await this.getAll(t),r=new Date().toISOString().split("T")[0],a={total:e.length,delivered:0,inProgress:0,notStarted:0,overdue:0,dueThisWeek:0},i=new Date;i.setDate(i.getDate()+7);const o=i.toISOString().split("T")[0];return e.forEach(c=>{c.status==="Delivered"?a.delivered++:c.status==="In Progress"?(a.inProgress++,c.due_date<r?a.overdue++:c.due_date<=o&&a.dueThisWeek++):(c.status==="Not Started"||c.status==="Draft")&&(a.notStarted++,c.due_date<r&&a.overdue++)}),a}catch(e){throw e}}async getAllWithRelations(t,e=!1){try{let r=f.from("deliverables").select(`
          *,
          milestones(milestone_ref, name),
          deliverable_kpis(kpi_id, kpis(kpi_ref, name)),
          deliverable_quality_standards(quality_standard_id, quality_standards(qs_ref, name))
        `).eq("project_id",t).or("is_deleted.is.null,is_deleted.eq.false").order("deliverable_ref");e||(r=r.or("is_test_content.is.null,is_test_content.eq.false"));const{data:a,error:i}=await r;if(i)throw i;return a||[]}catch(r){throw r}}async syncKPILinks(t,e=[]){try{const{error:r}=await f.from("deliverable_kpis").delete().eq("deliverable_id",t);if(r)throw r;if(e.length>0){const a=e.map(o=>({deliverable_id:t,kpi_id:o})),{error:i}=await f.from("deliverable_kpis").insert(a);if(i)throw i}return!0}catch(r){throw r}}async syncQSLinks(t,e=[]){try{const{error:r}=await f.from("deliverable_quality_standards").delete().eq("deliverable_id",t);if(r)throw r;if(e.length>0){const a=e.map(o=>({deliverable_id:t,quality_standard_id:o})),{error:i}=await f.from("deliverable_quality_standards").insert(a);if(i)throw i}return!0}catch(r){throw r}}async upsertKPIAssessments(t,e,r){try{const a=e.map(o=>({deliverable_id:t,kpi_id:o.kpiId,criteria_met:o.criteriaMet,assessed_at:new Date().toISOString(),assessed_by:r})),{error:i}=await f.from("deliverable_kpi_assessments").upsert(a,{onConflict:"deliverable_id,kpi_id"});if(i)throw i;return!0}catch(a){throw a}}async upsertQSAssessments(t,e,r){try{const a=e.map(o=>({deliverable_id:t,quality_standard_id:o.qsId,criteria_met:o.criteriaMet,assessed_at:new Date().toISOString(),assessed_by:r})),{error:i}=await f.from("deliverable_qs_assessments").upsert(a,{onConflict:"deliverable_id,quality_standard_id"});if(i)throw i;return!0}catch(a){throw a}}async signDeliverable(t,e,r,a){try{const i=await this.getById(t);if(!i)throw new Error("Deliverable not found");const o={},c=new Date().toISOString();if(e==="supplier")o.supplier_pm_id=r,o.supplier_pm_name=a,o.supplier_pm_signed_at=c;else if(e==="customer")o.customer_pm_id=r,o.customer_pm_name=a,o.customer_pm_signed_at=c;else throw new Error("Invalid signer role");const l=e==="supplier"||i.supplier_pm_signed_at,d=e==="customer"||i.customer_pm_signed_at;return l&&d?(o.sign_off_status="Signed",o.status="Delivered",o.progress=100,o.delivered_date=c,o.delivered_by=r):l?o.sign_off_status="Awaiting Customer":d&&(o.sign_off_status="Awaiting Supplier"),await this.update(t,o)}catch(i){throw i}}async resetSignatures(t){try{const e={supplier_pm_id:null,supplier_pm_name:null,supplier_pm_signed_at:null,customer_pm_id:null,customer_pm_name:null,customer_pm_signed_at:null,sign_off_status:"Not Signed",status:"Review Complete"};return await this.update(t,e)}catch(e){throw e}}}const Ys=new xo;class _o extends he{constructor(){super("kpis")}async getAllWithStatus(t){try{return(await this.getAll(t,{orderBy:{column:"name",ascending:!0}})).map(r=>({...r,rag_status:this.calculateRAG(r)}))}catch(e){throw e}}calculateRAG(t){if(!t.target_value||t.actual_value===null||t.actual_value===void 0)return"Unknown";const e=parseFloat(t.actual_value),r=parseFloat(t.target_value),a=parseFloat(t.threshold_amber||10);return t.trend==="higher_better"?e>=r?"Green":e>=r*(1-a/100)?"Amber":"Red":e<=r?"Green":e<=r*(1+a/100)?"Amber":"Red"}async getByRAGStatus(t,e){try{return(await this.getAllWithStatus(t)).filter(a=>a.rag_status===e)}catch(r){throw r}}async getNeedingAttention(t){try{return(await this.getAllWithStatus(t)).filter(r=>r.rag_status==="Amber"||r.rag_status==="Red")}catch(e){throw e}}async updateActualValue(t,e){return this.update(t,{actual_value:e,last_updated:new Date().toISOString()})}async getHistory(t,e=12){try{const{data:r,error:a}=await f.from("kpi_history").select("*").eq("kpi_id",t).order("recorded_at",{ascending:!1}).limit(e);if(a)throw a;return r||[]}catch{return[]}}async getSummary(t){try{const e=await this.getAllWithStatus(t);return{total:e.length,green:e.filter(r=>r.rag_status==="Green").length,amber:e.filter(r=>r.rag_status==="Amber").length,red:e.filter(r=>r.rag_status==="Red").length,unknown:e.filter(r=>r.rag_status==="Unknown").length}}catch(e){throw e}}async getAssessments(t){try{const{data:e,error:r}=await f.from("deliverable_kpi_assessments").select(`
          kpi_id,
          criteria_met,
          deliverables!inner(id, status, is_deleted, project_id)
        `).eq("deliverables.project_id",t);return r?await this.getAssessmentsFallback(t):(e||[]).filter(i=>i.deliverables?.is_deleted!==!0&&le.deliverables.contributeToKPIs.includes(i.deliverables?.status))}catch{return[]}}async getAssessmentsFallback(t){try{const{data:e,error:r}=await f.from("deliverable_kpi_assessments").select("kpi_id, criteria_met, deliverable_id");if(r)throw r;const{data:a,error:i}=await f.from("deliverables").select("id, status, is_deleted").eq("project_id",t);if(i)throw i;const o=new Set((a||[]).filter(l=>l.is_deleted!==!0&&le.deliverables.contributeToKPIs.includes(l.status)).map(l=>l.id));return(e||[]).filter(l=>o.has(l.deliverable_id))}catch{return[]}}}const So=new _o;class jo extends he{constructor(){super("quality_standards")}async getAllWithStatus(t){try{return(await this.getAll(t,{orderBy:{column:"name",ascending:!0}})).map(r=>({...r,compliance_status:this.calculateCompliance(r)}))}catch(e){throw e}}calculateCompliance(t){if(t.actual_value===null||t.actual_value===void 0)return"Not Measured";const e=parseFloat(t.actual_value),r=parseFloat(t.target_value||0);return e>=r?"Compliant":e>=r*.9?"Near Compliant":"Non-Compliant"}async getNonCompliant(t){try{return(await this.getAllWithStatus(t)).filter(r=>r.compliance_status==="Non-Compliant")}catch(e){throw e}}async updateMeasurement(t,e,r){return this.update(t,{actual_value:e,measurement_notes:r,last_measured:new Date().toISOString()})}async getSummary(t){try{const e=await this.getAllWithStatus(t);return{total:e.length,compliant:e.filter(r=>r.compliance_status==="Compliant").length,nearCompliant:e.filter(r=>r.compliance_status==="Near Compliant").length,nonCompliant:e.filter(r=>r.compliance_status==="Non-Compliant").length,notMeasured:e.filter(r=>r.compliance_status==="Not Measured").length}}catch(e){throw e}}async getAssessments(t){try{const{data:e,error:r}=await f.from("deliverable_qs_assessments").select(`
          quality_standard_id,
          criteria_met,
          deliverables!inner(id, status, is_deleted, project_id)
        `).eq("deliverables.project_id",t);return r?await this.getAssessmentsFallback(t):(e||[]).filter(i=>i.deliverables?.is_deleted!==!0&&le.deliverables.contributeToQS.includes(i.deliverables?.status))}catch{return[]}}async getAssessmentsFallback(t){try{const{data:e,error:r}=await f.from("deliverable_qs_assessments").select("quality_standard_id, criteria_met, deliverable_id");if(r)throw r;const{data:a,error:i}=await f.from("deliverables").select("id, status, is_deleted").eq("project_id",t);if(i)throw i;const o=new Set((a||[]).filter(l=>l.is_deleted!==!0&&le.deliverables.contributeToQS.includes(l.status)).map(l=>l.id));return(e||[]).filter(l=>o.has(l.deliverable_id))}catch{return[]}}async getAllWithCalculatedValues(t){try{const e=await this.getAll(t,{orderBy:{column:"qs_ref",ascending:!0}}),r=await this.getAssessments(t),a={};return r.forEach(i=>{a[i.quality_standard_id]||(a[i.quality_standard_id]={total:0,met:0}),a[i.quality_standard_id].total++,i.criteria_met&&a[i.quality_standard_id].met++}),e.map(i=>{const o=a[i.id],c=o&&o.total>0?Math.round(o.met/o.total*100):0,l=i.target||100,d=c>=l;return{...i,calculatedValue:c,assessmentCount:o?.total||0,assessmentsMet:o?.met||0,isAchieved:d}})}catch(e){throw e}}}const Co=new jo;class Eo extends he{constructor(){super("standards",{supportsSoftDelete:!1,sanitizeConfig:"standard"})}async getAll(t){return super.getAll(t,{orderBy:{column:"standard_ref",ascending:!0}})}async getByStatus(t,e){return super.getAll(t,{filters:[{column:"status",operator:"eq",value:e}],orderBy:{column:"standard_ref",ascending:!0}})}async getByCategory(t,e){return super.getAll(t,{filters:[{column:"category",operator:"eq",value:e}],orderBy:{column:"standard_ref",ascending:!0}})}async getSummary(t){try{const e=await this.getAll(t);return{total:e.length,completed:e.filter(r=>r.status==="Completed").length,inProgress:e.filter(r=>r.status==="In Progress").length,notStarted:e.filter(r=>!r.status||r.status==="Not Started").length}}catch(e){throw e}}}new Eo;const ko={version:"2.0",widgets:{"progress-hero":{visible:!0,x:0,y:0,w:12,h:2,minW:6,minH:2,maxH:3},"budget-summary":{visible:!1,x:0,y:2,w:6,h:2,minW:4,minH:2,maxH:3},"pmo-tracking":{visible:!1,x:6,y:2,w:6,h:2,minW:6,minH:2,maxH:4},"stats-grid":{visible:!0,x:0,y:2,w:12,h:2,minW:8,minH:2,maxH:3},certificates:{visible:!1,x:0,y:4,w:12,h:2,minW:6,minH:2,maxH:3},"milestones-list":{visible:!0,x:0,y:4,w:12,h:4,minW:8,minH:3,maxH:6},"kpis-category":{visible:!1,x:0,y:8,w:6,h:3,minW:4,minH:3,maxH:5},"quality-standards":{visible:!1,x:6,y:8,w:6,h:3,minW:4,minH:3,maxH:5}}};({...ko});class Ro extends he{constructor(){super("raid_items",{supportsSoftDelete:!0,sanitizeConfig:"raid_items"})}async getAllWithRelations(t,e={}){try{let r=f.from("raid_items").select(`
          *,
          owner:resources!raid_items_owner_id_fkey(id, name, email),
          milestone:milestones!raid_items_milestone_id_fkey(id, name, milestone_ref)
        `).eq("project_id",t);e.category&&(r=r.eq("category",e.category)),e.status&&(Array.isArray(e.status)?r=r.in("status",e.status):r=r.eq("status",e.status)),e.severity&&(r=r.eq("severity",e.severity));const a=e.orderBy?.column||"raid_ref",i=e.orderBy?.ascending??!0;r=r.order(a,{ascending:i});const{data:o,error:c}=await r;if(c)throw c;let l=o||[];return e.includeDeleted||(l=l.filter(d=>d.is_deleted!==!0)),l}catch(r){throw r}}async getGroupedByCategory(t){try{const e=await this.getAllWithRelations(t);return{risks:e.filter(r=>r.category==="Risk"),assumptions:e.filter(r=>r.category==="Assumption"),issues:e.filter(r=>r.category==="Issue"),dependencies:e.filter(r=>r.category==="Dependency")}}catch(e){throw e}}async getSummary(t){try{const e=await this.getAll(t),r={total:e.length,byCategory:{Risk:{total:0,open:0,highSeverity:0},Assumption:{total:0,open:0,highSeverity:0},Issue:{total:0,open:0,highSeverity:0},Dependency:{total:0,open:0,highSeverity:0}},byStatus:{Open:0,"In Progress":0,Closed:0,Accepted:0,Mitigated:0},bySeverity:{High:0,Medium:0,Low:0},highPriorityItems:[]};return e.forEach(a=>{r.byCategory[a.category]&&(r.byCategory[a.category].total++,(a.status==="Open"||a.status==="In Progress")&&r.byCategory[a.category].open++,a.severity==="High"&&r.byCategory[a.category].highSeverity++),r.byStatus.hasOwnProperty(a.status)&&r.byStatus[a.status]++,a.severity&&r.bySeverity.hasOwnProperty(a.severity)&&r.bySeverity[a.severity]++,a.severity==="High"&&(a.status==="Open"||a.status==="In Progress")&&r.highPriorityItems.push({id:a.id,raid_ref:a.raid_ref,category:a.category,title:a.title,description:a.description?.substring(0,100)+"..."})}),r}catch(e){throw e}}async getNextRef(t,e){try{const r=this.getCategoryPrefix(e),{data:a,error:i}=await f.from("raid_items").select("raid_ref").eq("project_id",t).ilike("raid_ref",`${r}%`).order("raid_ref",{ascending:!1}).limit(1);if(i)throw i;if(!a||a.length===0)return`${r}001`;const o=a[0].raid_ref,l=((parseInt(o.replace(r,""),10)||0)+1).toString().padStart(3,"0");return`${r}${l}`}catch(r){throw r}}getCategoryPrefix(t){return{Risk:"R",Assumption:"A",Issue:"I",Dependency:"D"}[t]||"X"}async createWithAutoRef(t){try{return t.raid_ref||(t.raid_ref=await this.getNextRef(t.project_id,t.category)),await this.create(t)}catch(e){throw e}}async updateStatus(t,e,r=null){try{const a={status:e};return["Closed","Accepted","Mitigated"].includes(e)?(a.closed_date=new Date().toISOString().split("T")[0],r&&(a.resolution=r)):a.closed_date=null,await this.update(t,a)}catch(a){throw a}}async getOverdue(t){try{const e=new Date().toISOString().split("T")[0],{data:r,error:a}=await f.from("raid_items").select("*").eq("project_id",t).in("status",["Open","In Progress"]).lt("due_date",e).order("due_date",{ascending:!0});if(a)throw a;return(r||[]).filter(i=>i.is_deleted!==!0)}catch(e){throw e}}async getByMilestone(t){try{const{data:e,error:r}=await f.from("raid_items").select("*").eq("milestone_id",t).order("raid_ref",{ascending:!0});if(r)throw r;return(e||[]).filter(a=>a.is_deleted!==!0)}catch(e){throw e}}async getByOwner(t){try{const{data:e,error:r}=await f.from("raid_items").select("*").eq("owner_id",t).order("raid_ref",{ascending:!0});if(r)throw r;return(e||[]).filter(a=>a.is_deleted!==!0)}catch(e){throw e}}async bulkUpdateStatus(t,e){const r={success:0,failed:0,errors:[]};for(const a of t)try{await this.updateStatus(a,e),r.success++}catch(i){r.failed++,r.errors.push({id:a,error:i.message})}return r}}const Oc=new Ro,H={DRAFT:"draft",SUBMITTED:"submitted",AWAITING_CUSTOMER:"awaiting_customer",AWAITING_SUPPLIER:"awaiting_supplier",APPROVED:"approved",APPLIED:"applied",REJECTED:"rejected"},rt={SCOPE_EXTENSION:"scope_extension",SCOPE_REDUCTION:"scope_reduction",TIME_EXTENSION:"time_extension",COST_ADJUSTMENT:"cost_adjustment",COMBINED:"combined"},Lc={[H.DRAFT]:{label:"Draft",color:"#8e8e93",bgColor:"rgba(142, 142, 147, 0.12)",description:"Being authored"},[H.SUBMITTED]:{label:"Submitted",color:"#007aff",bgColor:"rgba(0, 122, 255, 0.1)",description:"Ready for review"},[H.AWAITING_CUSTOMER]:{label:"Awaiting Customer",color:"#ff9500",bgColor:"rgba(255, 149, 0, 0.1)",description:"Supplier signed, awaiting customer"},[H.AWAITING_SUPPLIER]:{label:"Awaiting Supplier",color:"#ff9500",bgColor:"rgba(255, 149, 0, 0.1)",description:"Customer signed, awaiting supplier"},[H.APPROVED]:{label:"Approved",color:"#34c759",bgColor:"rgba(52, 199, 89, 0.1)",description:"Both parties signed"},[H.APPLIED]:{label:"Applied",color:"#0d9488",bgColor:"rgba(13, 148, 136, 0.1)",description:"Changes applied to baselines"},[H.REJECTED]:{label:"Rejected",color:"#ff3b30",bgColor:"rgba(255, 59, 48, 0.1)",description:"Rejected by a party"}},Bc={[rt.SCOPE_EXTENSION]:{label:"Scope Extension",description:"Additional work beyond original scope",icon:"expand"},[rt.SCOPE_REDUCTION]:{label:"Scope Reduction",description:"Removal of work from original scope",icon:"shrink"},[rt.TIME_EXTENSION]:{label:"Time Extension",description:"Schedule adjustment without scope change",icon:"clock"},[rt.COST_ADJUSTMENT]:{label:"Cost Adjustment",description:"Price change without scope/time change",icon:"pound"},[rt.COMBINED]:{label:"Combined",description:"Multiple impact types",icon:"layers"}};class Ao extends he{constructor(){super("variations",{supportsSoftDelete:!0,sanitizeConfig:"variation"})}async getAllWithStats(t){try{const e=await this.getAll(t,{orderBy:{column:"created_at",ascending:!1}}),r=e.map(a=>a.id);if(r.length>0){const{data:a}=await f.from("variation_milestones").select("variation_id").in("variation_id",r),i={};return(a||[]).forEach(o=>{i[o.variation_id]=(i[o.variation_id]||0)+1}),e.map(o=>({...o,milestone_count:i[o.id]||0}))}return e.map(a=>({...a,milestone_count:0}))}catch(e){throw e}}async getWithDetails(t){try{const e=await this.getById(t);if(!e)return null;const{data:r}=await f.from("variation_milestones").select(`
          *,
          milestone:milestones(id, milestone_ref, name, billable, baseline_start_date, baseline_end_date)
        `).eq("variation_id",t),{data:a}=await f.from("variation_deliverables").select(`
          *,
          deliverable:deliverables(id, deliverable_ref, name)
        `).eq("variation_id",t);let i=null,o=null,c=null;if(e.supplier_signed_by){const{data:l}=await f.from("profiles").select("id, full_name, email").eq("id",e.supplier_signed_by).limit(1);i=l?.[0]}if(e.customer_signed_by){const{data:l}=await f.from("profiles").select("id, full_name, email").eq("id",e.customer_signed_by).limit(1);o=l?.[0]}if(e.rejected_by){const{data:l}=await f.from("profiles").select("id, full_name, email").eq("id",e.rejected_by).limit(1);c=l?.[0]}return{...e,affected_milestones:r||[],deliverable_changes:a||[],supplier_signer:i,customer_signer:o,rejector:c}}catch(e){throw e}}async createVariation(t,e,r){try{const{data:a,error:i}=await f.rpc("generate_variation_ref",{p_project_id:t});if(i){const c=(await this.getAll(t)).length+1;e.variation_ref=`VAR-${String(c).padStart(3,"0")}`}else e.variation_ref=a;return await this.create({project_id:t,...e,status:H.DRAFT,form_step:1,created_by:r})}catch(a){throw a}}async saveFormProgress(t,e,r){try{return await this.update(t,{form_data:e,form_step:r})}catch(a){throw a}}async addAffectedMilestone(t,e){try{const{data:r,error:a}=await f.from("variation_milestones").insert({variation_id:t,...e}).select();if(a)throw a;return r?.[0]}catch(r){throw r}}async updateAffectedMilestone(t,e){try{const{data:r,error:a}=await f.from("variation_milestones").update(e).eq("id",t).select();if(a)throw a;return r?.[0]}catch(r){throw r}}async removeAffectedMilestone(t){try{const{error:e}=await f.from("variation_milestones").delete().eq("id",t);if(e)throw e;return!0}catch(e){throw e}}async clearAffectedMilestones(t){try{const{error:e}=await f.from("variation_milestones").delete().eq("variation_id",t);if(e)throw e;return!0}catch(e){throw e}}async addDeliverableChange(t,e){try{const{data:r,error:a}=await f.from("variation_deliverables").insert({variation_id:t,...e}).select();if(a)throw a;return r?.[0]}catch(r){throw r}}async removeDeliverableChange(t){try{const{error:e}=await f.from("variation_deliverables").delete().eq("id",t);if(e)throw e;return!0}catch(e){throw e}}async submitForApproval(t,e){try{const{data:r}=await f.from("variation_milestones").select("*").eq("variation_id",t);let a=0,i=0;return(r||[]).forEach(o=>{const c=(o.new_baseline_cost||0)-(o.original_baseline_cost||0);if(a+=c,o.original_baseline_end&&o.new_baseline_end){const l=new Date(o.original_baseline_end),d=new Date(o.new_baseline_end),h=Math.round((d-l)/(1e3*60*60*24));i+=h}}),await this.update(t,{status:H.SUBMITTED,impact_summary:e,total_cost_impact:a,total_days_impact:i})}catch(r){throw r}}async signVariation(t,e,r){try{const a=await this.getById(t);if(!a)throw new Error("Variation not found");const i=new Date().toISOString(),o={};if(e==="supplier")o.supplier_signed_by=r,o.supplier_signed_at=i,a.customer_signed_at?o.status=H.APPROVED:o.status=H.AWAITING_CUSTOMER;else if(e==="customer")o.customer_signed_by=r,o.customer_signed_at=i,a.supplier_signed_at?o.status=H.APPROVED:o.status=H.AWAITING_SUPPLIER;else throw new Error("Invalid signer role");return await this.update(t,o)}catch(a){throw a}}async rejectVariation(t,e,r){try{return await this.update(t,{status:H.REJECTED,rejected_by:e,rejected_at:new Date().toISOString(),rejection_reason:r})}catch(a){throw a}}async applyVariation(t){try{const e=await this.getWithDetails(t);if(!e)throw new Error("Variation not found");if(e.status!==H.APPROVED)throw new Error("Variation must be approved before applying");for(const i of e.affected_milestones)if(i.milestone_id){const{error:o}=await f.from("milestones").update({baseline_start_date:i.new_baseline_start,baseline_end_date:i.new_baseline_end,billable:i.new_baseline_cost}).eq("id",i.milestone_id);if(o)throw o;const c=await this.getCurrentBaselineVersion(i.milestone_id),{error:l}=await f.from("milestone_baseline_versions").insert({milestone_id:i.milestone_id,version:c+1,variation_id:t,baseline_start_date:i.new_baseline_start,baseline_end_date:i.new_baseline_end,baseline_billable:i.new_baseline_cost,supplier_signed_by:e.supplier_signed_by,supplier_signed_at:e.supplier_signed_at,customer_signed_by:e.customer_signed_by,customer_signed_at:e.customer_signed_at});if(l)throw l;await this.updateAffectedMilestone(i.id,{baseline_version_before:c||1,baseline_version_after:c+1})}const r=`${e.project_id?.substring(0,8)||"PROJ"}-${e.variation_ref}-CERT`,a={variation_ref:e.variation_ref,title:e.title,type:e.variation_type,description:e.description,reason:e.reason,impact_summary:e.impact_summary,total_cost_impact:e.total_cost_impact,total_days_impact:e.total_days_impact,affected_milestones:e.affected_milestones,deliverable_changes:e.deliverable_changes,supplier_signed_by:e.supplier_signed_by,supplier_signed_at:e.supplier_signed_at,customer_signed_by:e.customer_signed_by,customer_signed_at:e.customer_signed_at,applied_at:new Date().toISOString()};return await this.update(t,{status:H.APPLIED,applied_at:new Date().toISOString(),certificate_number:r,certificate_data:a})}catch(e){throw e}}async getCurrentBaselineVersion(t){try{const{data:e,error:r}=await f.from("milestone_baseline_versions").select("version").eq("milestone_id",t).order("version",{ascending:!1}).limit(1);if(r)throw r;return e?.[0]?.version||0}catch{return 0}}async getMilestoneBaselineHistory(t){try{const{data:e,error:r}=await f.from("milestone_baseline_versions").select(`
          *,
          variation:variations(variation_ref, title)
        `).eq("milestone_id",t).order("version",{ascending:!0});if(r)throw r;return e||[]}catch(e){throw e}}async getVariationsForMilestone(t){try{const{data:e,error:r}=await f.from("variation_milestones").select(`
          *,
          variation:variations(*)
        `).eq("milestone_id",t);if(r)throw r;return(e||[]).map(a=>a.variation).filter(Boolean)}catch(e){throw e}}async hasPendingVariation(t){try{const{data:e,error:r}=await f.from("variation_milestones").select("variation_id, variations!inner(status)").eq("milestone_id",t).in("variations.status",[H.DRAFT,H.SUBMITTED,H.AWAITING_CUSTOMER,H.AWAITING_SUPPLIER,H.APPROVED]).limit(1);if(r)throw r;return(e||[]).length>0}catch{return!1}}async getSummary(t){try{const e=await this.getAll(t),r={total:e.length,draft:0,pending:0,approved:0,applied:0,rejected:0,totalCostImpact:0,totalDaysImpact:0};return e.forEach(a=>{switch(a.status){case H.DRAFT:r.draft++;break;case H.SUBMITTED:case H.AWAITING_CUSTOMER:case H.AWAITING_SUPPLIER:r.pending++;break;case H.APPROVED:r.approved++;break;case H.APPLIED:r.applied++,r.totalCostImpact+=a.total_cost_impact||0,r.totalDaysImpact+=a.total_days_impact||0;break;case H.REJECTED:r.rejected++;break}}),r}catch(e){throw e}}async getMilestonesWithDependencies(t){try{const{data:e,error:r}=await f.from("milestones").select("*").eq("project_id",t).or("is_deleted.is.null,is_deleted.eq.false").order("start_date",{ascending:!0});if(r)throw r;const a=e||[];return a.map((i,o)=>{const c=[],l=[];return a.forEach((d,h)=>{d.id!==i.id&&(d.end_date&&i.start_date&&d.end_date<=i.start_date&&c.push(d.milestone_ref),i.end_date&&d.start_date&&i.end_date<=d.start_date&&l.push(d.milestone_ref))}),{...i,dependencies:c,dependents:l}})}catch(e){throw e}}async deleteDraftVariation(t){try{const e=await this.getById(t);if(!e)throw new Error("Variation not found");if(![H.DRAFT,H.SUBMITTED,H.REJECTED].includes(e.status))throw new Error("Only draft, submitted, or rejected variations can be deleted. Approved or applied variations cannot be deleted.");const{error:a}=await f.from("variation_milestones").delete().eq("variation_id",t),{error:i}=await f.from("variation_deliverables").delete().eq("variation_id",t),{error:o}=await f.from("variations").delete().eq("id",t);if(o)throw o;return!0}catch(e){throw e}}}const qc=new Ao,st={VARIATION_CR:"variation_cr",VARIATION_CERTIFICATE:"variation_certificate",INVOICE:"invoice",DELIVERABLE_CERTIFICATE:"deliverable_certificate",MILESTONE_CERTIFICATE:"milestone_certificate"};class To extends he{constructor(){super("document_templates",{supportsSoftDelete:!0,sanitizeConfig:null})}async getTemplatesForProject(t,e={}){try{const r=[];return e.templateType&&r.push({column:"template_type",operator:"eq",value:e.templateType}),e.activeOnly!==!1&&r.push({column:"is_active",operator:"eq",value:!0}),await this.getAll(t,{filters:r,orderBy:{column:"name",ascending:!0}})}catch(r){throw r}}async getTemplateById(t){try{return await this.getById(t)}catch(e){throw e}}async getDefaultTemplate(t,e){try{const{data:r,error:a}=await f.from(this.tableName).select("*").eq("project_id",t).eq("template_type",e).eq("is_default",!0).eq("is_active",!0).neq("is_deleted",!0).limit(1);if(a)throw a;if(r&&r.length>0)return r[0];const{data:i,error:o}=await f.from(this.tableName).select("*").eq("project_id",t).eq("template_type",e).eq("is_active",!0).neq("is_deleted",!0).order("created_at",{ascending:!0}).limit(1);if(o)throw o;return i?.[0]||null}catch(r){throw r}}async createTemplate(t,e){try{const r=this.validateTemplateDefinition(t.template_definition);if(!r.valid)throw new Error(`Invalid template definition: ${r.errors.join(", ")}`);return t.is_default&&await this.unsetDefaultTemplates(t.project_id,t.template_type),await this.create({...t,created_by:e,version:1})}catch(r){throw r}}async updateTemplate(t,e,r){try{const a=await this.getById(t);if(!a)throw new Error("Template not found");if(a.is_system&&e.template_definition)throw new Error("Cannot modify system template definition");if(e.template_definition){const i=this.validateTemplateDefinition(e.template_definition);if(!i.valid)throw new Error(`Invalid template definition: ${i.errors.join(", ")}`);e.version=(a.version||1)+1}return e.is_default&&!a.is_default&&await this.unsetDefaultTemplates(a.project_id,a.template_type),await this.update(t,e)}catch(a){throw a}}async deleteTemplate(t,e){try{const r=await this.getById(t);if(!r)throw new Error("Template not found");if(r.is_system)throw new Error("Cannot delete system template");return await this.delete(t,e)}catch(r){throw r}}async unsetDefaultTemplates(t,e){try{const{error:r}=await f.from(this.tableName).update({is_default:!1}).eq("project_id",t).eq("template_type",e).eq("is_default",!0);if(r)throw r}catch(r){throw r}}async setAsDefault(t){try{const e=await this.getById(t);if(!e)throw new Error("Template not found");return await this.unsetDefaultTemplates(e.project_id,e.template_type),await this.update(t,{is_default:!0})}catch(e){throw e}}async exportTemplate(t){try{const e=await this.getById(t);if(!e)throw new Error("Template not found");return{export_version:"1.0",exported_at:new Date().toISOString(),template:{name:e.name,code:e.code,description:e.description,template_type:e.template_type,template_definition:e.template_definition,output_formats:e.output_formats,default_output_format:e.default_output_format,logo_base64:e.logo_base64,logo_mime_type:e.logo_mime_type,primary_color:e.primary_color,secondary_color:e.secondary_color,font_family:e.font_family,header_left:e.header_left,header_center:e.header_center,header_right:e.header_right,footer_left:e.footer_left,footer_center:e.footer_center,footer_right:e.footer_right}}}catch(e){throw e}}async importTemplate(t,e,r){try{if(!e.template||!e.template.template_definition)throw new Error("Invalid import format: missing template definition");const a=e.template,o=await this.checkCodeExists(t,a.code)?`${a.code}_imported_${Date.now()}`:a.code;return await this.createTemplate({project_id:t,name:`${a.name} (Imported)`,code:o,description:a.description,template_type:a.template_type,template_definition:a.template_definition,output_formats:a.output_formats||["html","docx"],default_output_format:a.default_output_format||"html",logo_base64:a.logo_base64,logo_mime_type:a.logo_mime_type,primary_color:a.primary_color||"#8B0000",secondary_color:a.secondary_color||"#1a1a1a",font_family:a.font_family||"Arial",header_left:a.header_left,header_center:a.header_center,header_right:a.header_right,footer_left:a.footer_left,footer_center:a.footer_center,footer_right:a.footer_right,imported_at:new Date().toISOString(),imported_by:r,is_active:!0,is_default:!1,is_system:!1},r)}catch(a){throw a}}async duplicateTemplate(t,e,r){try{const a=await this.getById(t);if(!a)throw new Error("Source template not found");const i=`${a.code}_copy`,c=await this.checkCodeExists(e,i)?`${i}_${Date.now()}`:i;return await this.createTemplate({project_id:e,name:`${a.name} (Copy)`,code:c,description:a.description,template_type:a.template_type,template_definition:a.template_definition,output_formats:a.output_formats,default_output_format:a.default_output_format,logo_base64:a.logo_base64,logo_mime_type:a.logo_mime_type,primary_color:a.primary_color,secondary_color:a.secondary_color,font_family:a.font_family,header_left:a.header_left,header_center:a.header_center,header_right:a.header_right,footer_left:a.footer_left,footer_center:a.footer_center,footer_right:a.footer_right,source_project_id:a.project_id,source_template_id:a.id,is_active:!0,is_default:!1,is_system:!1},r)}catch(a){throw a}}validateTemplateDefinition(t){const e=[];return t?(t.metadata?(t.metadata.schema_version||e.push("metadata.schema_version is required"),t.metadata.template_code||e.push("metadata.template_code is required")):e.push("metadata section is required"),!t.sections||!Array.isArray(t.sections)?e.push("sections array is required"):t.sections.length===0?e.push("At least one section is required"):t.sections.forEach((r,a)=>{r.type||e.push(`Section ${a+1} is missing type`)}),{valid:e.length===0,errors:e}):(e.push("Template definition is required"),{valid:!1,errors:e})}validateFieldSources(t,e){const r=[],a=this.getValidSourcesForType(e);if(!t.sections)return{valid:!0,warnings:["No sections to validate"]};const i=c=>{const l=[];if(typeof c!="object"||c===null)return l;c.source&&typeof c.source=="string"&&l.push(c.source);for(const d of Object.keys(c))typeof c[d]=="object"&&l.push(...i(c[d]));return l};return i(t.sections).forEach(c=>{const l=c.split(".")[0];!a.includes(l)&&!c.startsWith("computed.")&&!c.startsWith("template.")&&r.push(`Unknown source root: ${l} in "${c}"`)}),{valid:!0,warnings:r}}getValidSourcesForType(t){const e=["project","template","computed"];switch(t){case st.VARIATION_CR:case st.VARIATION_CERTIFICATE:return[...e,"variation"];case st.INVOICE:return[...e,"invoice","partner"];case st.DELIVERABLE_CERTIFICATE:return[...e,"deliverable"];case st.MILESTONE_CERTIFICATE:return[...e,"milestone"];default:return e}}async checkCodeExists(t,e){try{const{data:r,error:a}=await f.from(this.tableName).select("id").eq("project_id",t).eq("code",e).neq("is_deleted",!0).limit(1);if(a)throw a;return r&&r.length>0}catch{return!1}}}const $c=new To,at={LAST_MONTH:"lastMonth",LAST_QUARTER:"lastQuarter",LAST_6_MONTHS:"last6Months",YEAR_TO_DATE:"yearToDate",CUSTOM:"custom"},Do={[at.LAST_MONTH]:{label:"Last Month",description:"Previous calendar month"},[at.LAST_QUARTER]:{label:"Last Quarter",description:"Previous 3 months"},[at.LAST_6_MONTHS]:{label:"Last 6 Months",description:"Previous 6 months"},[at.YEAR_TO_DATE]:{label:"Year to Date",description:"From January 1st to now"},[at.CUSTOM]:{label:"Custom Range",description:"Specify custom date range"}};class Po extends he{constructor(){super("report_templates",{supportsSoftDelete:!0,sanitizeConfig:null})}async getTemplatesForProject(t,e={}){try{const r=[];e.reportType&&r.push({column:"report_type",operator:"eq",value:e.reportType}),e.activeOnly!==!1&&r.push({column:"is_active",operator:"eq",value:!0});const a=await this.getAll(t,{filters:r,orderBy:{column:"name",ascending:!0}});return e.includeSystem===!1?a.filter(i=>!i.is_system):a}catch(r){throw r}}async getTemplateById(t){try{return await this.getById(t)}catch(e){throw e}}async getDefaultTemplate(t,e){try{const{data:r,error:a}=await f.from(this.tableName).select("*").eq("project_id",t).eq("report_type",e).eq("is_default",!0).eq("is_active",!0).eq("is_deleted",!1).limit(1);if(a)throw a;if(r&&r.length>0)return r[0];const{data:i,error:o}=await f.from(this.tableName).select("*").eq("project_id",t).eq("report_type",e).eq("is_active",!0).eq("is_deleted",!1).order("created_at",{ascending:!0}).limit(1);if(o)throw o;return i?.[0]||null}catch(r){throw r}}async createTemplate(t,e){try{const r=this.validateTemplateDefinition(t.template_definition);if(!r.valid)throw new Error(`Invalid template definition: ${r.errors.join(", ")}`);return t.is_default&&await this.unsetDefaultTemplates(t.project_id,t.report_type),await this.create({...t,created_by:e,version:1})}catch(r){throw r}}async updateTemplate(t,e,r){try{const a=await this.getById(t);if(!a)throw new Error("Template not found");if(a.is_system&&e.template_definition)throw new Error("Cannot modify system template definition");if(e.template_definition){const i=this.validateTemplateDefinition(e.template_definition);if(!i.valid)throw new Error(`Invalid template definition: ${i.errors.join(", ")}`);e.version=(a.version||1)+1}return e.is_default&&!a.is_default&&await this.unsetDefaultTemplates(a.project_id,a.report_type),await this.update(t,{...e,updated_by:r,updated_at:new Date().toISOString()})}catch(a){throw a}}async deleteTemplate(t,e){try{const r=await this.getById(t);if(!r)throw new Error("Template not found");if(r.is_system)throw new Error("Cannot delete system template");return await this.delete(t,e)}catch(r){throw r}}async unsetDefaultTemplates(t,e){try{const{error:r}=await f.from(this.tableName).update({is_default:!1}).eq("project_id",t).eq("report_type",e).eq("is_default",!0);if(r)throw r}catch(r){throw r}}async setAsDefault(t){try{const e=await this.getById(t);if(!e)throw new Error("Template not found");return await this.unsetDefaultTemplates(e.project_id,e.report_type),await this.update(t,{is_default:!0})}catch(e){throw e}}async duplicateTemplate(t,e,r){try{const a=await this.getById(t);if(!a)throw new Error("Source template not found");const i=`${a.code}_copy`,c=await this.checkCodeExists(e,i)?`${i}_${Date.now()}`:i;return await this.createTemplate({project_id:e,name:`${a.name} (Copy)`,code:c,description:a.description,report_type:a.report_type,template_definition:a.template_definition,default_parameters:a.default_parameters,is_active:!0,is_default:!1,is_system:!1},r)}catch(a){throw a}}async logGeneration(t){try{const{data:e,error:r}=await f.from("report_generations").insert({project_id:t.projectId,template_id:t.templateId||null,report_name:t.reportName,report_type:t.reportType,parameters_used:t.parameters,sections_used:t.sections,output_html:t.outputHtml,generation_time_ms:t.generationTimeMs,sections_count:t.sectionsCount,data_rows_count:t.dataRowsCount||0,ai_assisted:t.aiAssisted||!1,ai_tokens_used:t.aiTokensUsed||0,generated_by:t.userId}).select().single();if(r)throw r;return e}catch{return null}}async getGenerationHistory(t,e={}){try{let r=f.from("report_generations").select(`
          *,
          template:template_id (name, code),
          generated_by_profile:generated_by (full_name, email)
        `).eq("project_id",t).order("generated_at",{ascending:!1}).limit(e.limit||50);e.reportType&&(r=r.eq("report_type",e.reportType));const{data:a,error:i}=await r;if(i)throw i;return a||[]}catch(r){throw r}}validateTemplateDefinition(t){const e=[];return t?(t.metadata&&t.metadata.title&&typeof t.metadata.title!="string"&&e.push("metadata.title must be a string"),!t.sections||!Array.isArray(t.sections)?e.push("sections array is required"):t.sections.length===0||t.sections.forEach((r,a)=>{r.type||e.push(`Section ${a+1} is missing type`),r.id||e.push(`Section ${a+1} is missing id`)}),t.parameters&&!Array.isArray(t.parameters)&&e.push("parameters must be an array"),{valid:e.length===0,errors:e}):(e.push("Template definition is required"),{valid:!1,errors:e})}isValidSectionType(t){return["milestone_summary","deliverable_summary","kpi_performance","quality_standards","budget_analysis","raid_summary","timesheet_summary","expense_summary","forward_look","lessons_learned","executive_summary","custom_text","cover_page","table_of_contents"].includes(t)}async checkCodeExists(t,e){try{const{data:r,error:a}=await f.from(this.tableName).select("id").eq("project_id",t).eq("code",e).eq("is_deleted",!1).limit(1);if(a)throw a;return r&&r.length>0}catch{return!1}}async generateUniqueCode(t,e){try{let r=e.toLowerCase().replace(/[^a-z0-9\s]/g,"").replace(/\s+/g,"_").substring(0,50),a=r,i=1;for(;await this.checkCodeExists(t,a);)if(a=`${r}_${i}`,i++,i>100){a=`${r}_${Date.now()}`;break}return a}catch{return`report_${Date.now()}`}}getSectionCount(t){return!t||!t.sections?0:t.sections.length}createEmptyDefinition(t="New Report"){return{metadata:{title:t,subtitle:"{{project.name}}",generatedAt:"{{generated.date}}",generatedBy:"{{generated.by}}"},parameters:[{id:"reportingPeriod",type:"select",label:"Reporting Period",default:"lastMonth",options:Object.entries(Do).map(([e,r])=>({value:e,label:r.label}))}],sections:[]}}mergeParameters(t={},e={}){return{...t,...e}}}new Po;const B={MILESTONE_SUMMARY:"milestone_summary",DELIVERABLE_SUMMARY:"deliverable_summary",KPI_PERFORMANCE:"kpi_performance",QUALITY_STANDARDS:"quality_standards",BUDGET_ANALYSIS:"budget_analysis",RAID_SUMMARY:"raid_summary",TIMESHEET_SUMMARY:"timesheet_summary",EXPENSE_SUMMARY:"expense_summary",FORWARD_LOOK:"forward_look",UPCOMING_MILESTONES:"upcoming_milestones",UPCOMING_DELIVERABLES:"upcoming_deliverables",EXECUTIVE_SUMMARY:"executive_summary",LESSONS_LEARNED:"lessons_learned",CUSTOM_TEXT:"custom_text",RESOURCE_SUMMARY:"resource_summary"},ce={BACKWARD:"backward",FORWARD:"forward",CONTENT:"content"},de={METRICS_SERVICE:"metricsService",RAID_SERVICE:"raidService",CUSTOM_QUERY:"customQuery",USER_INPUT:"userInput",AI_GENERATED:"aiGenerated"},P={SELECT:"select",MULTI_SELECT:"multiSelect",BOOLEAN:"boolean",NUMBER:"number",TEXT:"text",TEXTAREA:"textarea"},Mo={[B.MILESTONE_SUMMARY]:{type:B.MILESTONE_SUMMARY,name:"Milestone Summary",description:"Overview of milestone status and progress during the reporting period",icon:ar,category:ce.BACKWARD,dataSource:de.METRICS_SERVICE,dataMethod:"getMilestoneMetrics",defaultConfig:{includeChart:!0,statusFilter:["all"],showBudget:!0,showProgress:!0,sortBy:"milestone_ref"},configSchema:{includeChart:{type:P.BOOLEAN,label:"Include Progress Chart",description:"Show visual milestone status breakdown",default:!0},statusFilter:{type:P.MULTI_SELECT,label:"Status Filter",description:"Which milestone statuses to include",options:[{value:"all",label:"All Statuses"},{value:"Completed",label:"Completed"},{value:"In Progress",label:"In Progress"},{value:"Not Started",label:"Not Started"},{value:"On Hold",label:"On Hold"}],default:["all"]},showBudget:{type:P.BOOLEAN,label:"Show Budget Allocation",description:"Display budget values per milestone",default:!0,roleRestriction:["admin","supplier_pm"]},showProgress:{type:P.BOOLEAN,label:"Show Progress Percentage",description:"Display completion percentage",default:!0},sortBy:{type:P.SELECT,label:"Sort By",options:[{value:"milestone_ref",label:"Milestone Reference"},{value:"status",label:"Status"},{value:"progress",label:"Progress"}],default:"milestone_ref"}}},[B.DELIVERABLE_SUMMARY]:{type:B.DELIVERABLE_SUMMARY,name:"Deliverable Summary",description:"Status of deliverables completed and in progress during the period",icon:pr,category:ce.BACKWARD,dataSource:de.METRICS_SERVICE,dataMethod:"getDeliverableMetrics",defaultConfig:{includeChart:!0,statusFilter:["all"],groupByMilestone:!1,highlightOverdue:!0,sortBy:"deliverable_ref"},configSchema:{includeChart:{type:P.BOOLEAN,label:"Include Status Chart",description:"Show visual deliverable status breakdown",default:!0},statusFilter:{type:P.MULTI_SELECT,label:"Status Filter",options:[{value:"all",label:"All Statuses"},{value:"Delivered",label:"Delivered"},{value:"In Review",label:"In Review"},{value:"Submitted",label:"Submitted"},{value:"Draft",label:"Draft"}],default:["all"]},groupByMilestone:{type:P.BOOLEAN,label:"Group by Milestone",description:"Organise deliverables under their parent milestone",default:!1},highlightOverdue:{type:P.BOOLEAN,label:"Highlight Overdue",description:"Emphasise deliverables past their due date",default:!0},sortBy:{type:P.SELECT,label:"Sort By",options:[{value:"deliverable_ref",label:"Deliverable Reference"},{value:"due_date",label:"Due Date"},{value:"status",label:"Status"}],default:"deliverable_ref"}}},[B.KPI_PERFORMANCE]:{type:B.KPI_PERFORMANCE,name:"KPI Performance",description:"Key Performance Indicator achievement against targets",icon:dt,category:ce.BACKWARD,dataSource:de.METRICS_SERVICE,dataMethod:"getKPIMetrics",defaultConfig:{includeChart:!0,showRAG:!0,groupByCategory:!0,includeTarget:!0,sortBy:"kpi_ref"},configSchema:{includeChart:{type:P.BOOLEAN,label:"Include Performance Chart",description:"Show visual KPI performance indicators",default:!0},showRAG:{type:P.BOOLEAN,label:"Show RAG Status",description:"Display Red/Amber/Green indicators",default:!0},groupByCategory:{type:P.BOOLEAN,label:"Group by Category",description:"Organise KPIs by their category",default:!0},includeTarget:{type:P.BOOLEAN,label:"Show Target Values",description:"Display target alongside actual",default:!0},sortBy:{type:P.SELECT,label:"Sort By",options:[{value:"kpi_ref",label:"KPI Reference"},{value:"category",label:"Category"},{value:"performance",label:"Performance (Low to High)"},{value:"ragStatus",label:"RAG Status"}],default:"kpi_ref"}}},[B.QUALITY_STANDARDS]:{type:B.QUALITY_STANDARDS,name:"Quality Standards",description:"Compliance status against defined quality standards",icon:Ve,category:ce.BACKWARD,dataSource:de.METRICS_SERVICE,dataMethod:"getQualityStandardMetrics",defaultConfig:{includeChart:!0,showAssessmentCount:!0,sortBy:"qs_ref"},configSchema:{includeChart:{type:P.BOOLEAN,label:"Include Compliance Chart",description:"Show visual compliance summary",default:!0},showAssessmentCount:{type:P.BOOLEAN,label:"Show Assessment Details",description:"Display number of assessments per standard",default:!0},sortBy:{type:P.SELECT,label:"Sort By",options:[{value:"qs_ref",label:"QS Reference"},{value:"compliance",label:"Compliance Rate"}],default:"qs_ref"}}},[B.BUDGET_ANALYSIS]:{type:B.BUDGET_ANALYSIS,name:"Budget Analysis",description:"Budget utilisation, spend breakdown, and variance analysis",icon:La,category:ce.BACKWARD,dataSource:de.METRICS_SERVICE,dataMethod:"getAllDashboardMetrics",roleRestriction:["admin","supplier_pm"],defaultConfig:{includeChart:!0,showPMOvsDelivery:!0,showByMilestone:!0,showVariance:!0},configSchema:{includeChart:{type:P.BOOLEAN,label:"Include Budget Chart",description:"Show visual budget breakdown",default:!0},showPMOvsDelivery:{type:P.BOOLEAN,label:"Show PMO vs Delivery Split",description:"Break down spend by PMO and delivery resources",default:!0},showByMilestone:{type:P.BOOLEAN,label:"Show Spend by Milestone",description:"Display spend breakdown per milestone",default:!0},showVariance:{type:P.BOOLEAN,label:"Show Variance Analysis",description:"Compare budget vs actual with variance",default:!0}}},[B.RAID_SUMMARY]:{type:B.RAID_SUMMARY,name:"RAID Summary",description:"Risks, Assumptions, Issues, and Dependencies overview",icon:Qe,category:ce.BACKWARD,dataSource:de.RAID_SERVICE,dataMethod:"getSummary",defaultConfig:{categories:["Risk","Assumption","Issue","Dependency"],statusFilter:["Open","In Progress"],severityFilter:["all"],includeChart:!0,showDetails:!0,maxItems:10},configSchema:{categories:{type:P.MULTI_SELECT,label:"RAID Categories",description:"Which categories to include",options:[{value:"Risk",label:"Risks"},{value:"Assumption",label:"Assumptions"},{value:"Issue",label:"Issues"},{value:"Dependency",label:"Dependencies"}],default:["Risk","Assumption","Issue","Dependency"]},statusFilter:{type:P.MULTI_SELECT,label:"Status Filter",options:[{value:"Open",label:"Open"},{value:"In Progress",label:"In Progress"},{value:"Closed",label:"Closed"},{value:"Accepted",label:"Accepted"},{value:"Mitigated",label:"Mitigated"}],default:["Open","In Progress"]},severityFilter:{type:P.MULTI_SELECT,label:"Severity Filter",options:[{value:"all",label:"All Severities"},{value:"High",label:"High"},{value:"Medium",label:"Medium"},{value:"Low",label:"Low"}],default:["all"]},includeChart:{type:P.BOOLEAN,label:"Include RAID Chart",description:"Show visual RAID summary",default:!0},showDetails:{type:P.BOOLEAN,label:"Show Item Details",description:"Include description and owner for each item",default:!0},maxItems:{type:P.NUMBER,label:"Maximum Items",description:"Limit number of items shown (0 for all)",default:10,min:0,max:100}}},[B.TIMESHEET_SUMMARY]:{type:B.TIMESHEET_SUMMARY,name:"Timesheet Summary",description:"Time tracking summary and resource utilisation",icon:_e,category:ce.BACKWARD,dataSource:de.METRICS_SERVICE,dataMethod:"getTimesheetMetrics",roleRestriction:["admin","supplier_pm"],defaultConfig:{includeChart:!0,showByResource:!0,showByMilestone:!0,statusFilter:["Submitted","Validated","Approved"]},configSchema:{includeChart:{type:P.BOOLEAN,label:"Include Hours Chart",description:"Show visual timesheet breakdown",default:!0},showByResource:{type:P.BOOLEAN,label:"Show Hours by Resource",description:"Break down hours per resource",default:!0},showByMilestone:{type:P.BOOLEAN,label:"Show Hours by Milestone",description:"Break down hours per milestone",default:!0},statusFilter:{type:P.MULTI_SELECT,label:"Status Filter",options:[{value:"Draft",label:"Draft"},{value:"Submitted",label:"Submitted"},{value:"Validated",label:"Validated"},{value:"Approved",label:"Approved"}],default:["Submitted","Validated","Approved"]}}},[B.EXPENSE_SUMMARY]:{type:B.EXPENSE_SUMMARY,name:"Expense Summary",description:"Expense breakdown by category and chargeable status",icon:mt,category:ce.BACKWARD,dataSource:de.METRICS_SERVICE,dataMethod:"getExpenseMetrics",roleRestriction:["admin","supplier_pm"],defaultConfig:{includeChart:!0,showByCategory:!0,showChargeableBreakdown:!0,statusFilter:["Submitted","Approved","Paid"]},configSchema:{includeChart:{type:P.BOOLEAN,label:"Include Expense Chart",description:"Show visual expense breakdown",default:!0},showByCategory:{type:P.BOOLEAN,label:"Show by Category",description:"Break down expenses by category",default:!0},showChargeableBreakdown:{type:P.BOOLEAN,label:"Show Chargeable Split",description:"Separate chargeable and non-chargeable",default:!0},statusFilter:{type:P.MULTI_SELECT,label:"Status Filter",options:[{value:"Draft",label:"Draft"},{value:"Submitted",label:"Submitted"},{value:"Approved",label:"Approved"},{value:"Paid",label:"Paid"}],default:["Submitted","Approved","Paid"]}}},[B.FORWARD_LOOK]:{type:B.FORWARD_LOOK,name:"Forward Look",description:"Combined view of upcoming milestones, deliverables, and dependencies",icon:Oa,category:ce.FORWARD,dataSource:de.CUSTOM_QUERY,defaultConfig:{lookAheadPeriod:"3months",includeMilestones:!0,includeDeliverables:!0,includeDependencies:!0,includeResources:!1},configSchema:{lookAheadPeriod:{type:P.SELECT,label:"Look-Ahead Period",description:"How far ahead to look",options:[{value:"1month",label:"Next Month"},{value:"3months",label:"Next 3 Months"},{value:"6months",label:"Next 6 Months"},{value:"custom",label:"Custom Period"}],default:"3months"},includeMilestones:{type:P.BOOLEAN,label:"Include Milestones",description:"Show upcoming milestones",default:!0},includeDeliverables:{type:P.BOOLEAN,label:"Include Deliverables",description:"Show upcoming deliverables",default:!0},includeDependencies:{type:P.BOOLEAN,label:"Include Dependencies",description:"Show blocking dependencies",default:!0},includeResources:{type:P.BOOLEAN,label:"Include Resource Requirements",description:"Show resource allocation needs",default:!1}}},[B.UPCOMING_MILESTONES]:{type:B.UPCOMING_MILESTONES,name:"Upcoming Milestones",description:"Milestones scheduled for completion in the upcoming period",icon:Wr,category:ce.FORWARD,dataSource:de.CUSTOM_QUERY,defaultConfig:{lookAheadPeriod:"3months",includeInProgress:!0,showDependencies:!1},configSchema:{lookAheadPeriod:{type:P.SELECT,label:"Look-Ahead Period",options:[{value:"1month",label:"Next Month"},{value:"3months",label:"Next 3 Months"},{value:"6months",label:"Next 6 Months"}],default:"3months"},includeInProgress:{type:P.BOOLEAN,label:"Include In Progress",description:"Include milestones already in progress",default:!0},showDependencies:{type:P.BOOLEAN,label:"Show Dependencies",description:"Display related dependencies",default:!1}}},[B.UPCOMING_DELIVERABLES]:{type:B.UPCOMING_DELIVERABLES,name:"Upcoming Deliverables",description:"Deliverables due in the upcoming period",icon:pr,category:ce.FORWARD,dataSource:de.CUSTOM_QUERY,defaultConfig:{lookAheadPeriod:"1month",groupByMilestone:!0,highlightOverdue:!0},configSchema:{lookAheadPeriod:{type:P.SELECT,label:"Look-Ahead Period",options:[{value:"1week",label:"Next Week"},{value:"2weeks",label:"Next 2 Weeks"},{value:"1month",label:"Next Month"},{value:"3months",label:"Next 3 Months"}],default:"1month"},groupByMilestone:{type:P.BOOLEAN,label:"Group by Milestone",description:"Organise by parent milestone",default:!0},highlightOverdue:{type:P.BOOLEAN,label:"Highlight Overdue",description:"Emphasise overdue deliverables",default:!0}}},[B.EXECUTIVE_SUMMARY]:{type:B.EXECUTIVE_SUMMARY,name:"Executive Summary",description:"High-level project summary (AI-assisted or manual)",icon:Je,category:ce.CONTENT,dataSource:de.AI_GENERATED,defaultConfig:{autoGenerate:!1,maxLength:500,tone:"professional",includeHighlights:!0,includeChallenges:!0,includeNextSteps:!0,content:""},configSchema:{autoGenerate:{type:P.BOOLEAN,label:"AI-Generate Summary",description:"Let AI create the summary based on report data",default:!1},content:{type:P.TEXTAREA,label:"Summary Content",description:"Write or edit the executive summary",placeholder:"Enter executive summary or use AI to generate...",rows:8,aiAssist:!0,showWhen:{autoGenerate:!1}},tone:{type:P.SELECT,label:"Tone",description:"Writing style for AI generation",options:[{value:"professional",label:"Professional"},{value:"concise",label:"Concise & Direct"},{value:"detailed",label:"Detailed & Thorough"}],default:"professional",showWhen:{autoGenerate:!0}},maxLength:{type:P.NUMBER,label:"Maximum Words",description:"Target word count for AI summary",default:500,min:100,max:2e3,showWhen:{autoGenerate:!0}},includeHighlights:{type:P.BOOLEAN,label:"Include Highlights",description:"Mention key achievements",default:!0,showWhen:{autoGenerate:!0}},includeChallenges:{type:P.BOOLEAN,label:"Include Challenges",description:"Address issues and blockers",default:!0,showWhen:{autoGenerate:!0}},includeNextSteps:{type:P.BOOLEAN,label:"Include Next Steps",description:"Outline upcoming priorities",default:!0,showWhen:{autoGenerate:!0}}}},[B.LESSONS_LEARNED]:{type:B.LESSONS_LEARNED,name:"Lessons Learned",description:"Key learnings and recommendations from the reporting period",icon:Ia,category:ce.CONTENT,dataSource:de.USER_INPUT,defaultConfig:{format:"structured",categories:["Process","Technical","Communication","Resource"],content:[],aiSuggest:!1},configSchema:{format:{type:P.SELECT,label:"Format",options:[{value:"structured",label:"Structured (Category + Lesson + Recommendation)"},{value:"freeform",label:"Free-form Text"}],default:"structured"},content:{type:P.TEXTAREA,label:"Lessons Learned Content",description:"Enter lessons learned or use AI to help identify them",placeholder:"Enter lessons learned...",rows:10,aiAssist:!0,showWhen:{format:"freeform"}},aiSuggest:{type:P.BOOLEAN,label:"AI Suggestions",description:"Get AI suggestions based on project data",default:!1}}},[B.CUSTOM_TEXT]:{type:B.CUSTOM_TEXT,name:"Custom Section",description:"Add custom content with your own heading and text",icon:Na,category:ce.CONTENT,dataSource:de.USER_INPUT,defaultConfig:{heading:"Custom Section",content:"",headingLevel:2},configSchema:{heading:{type:P.TEXT,label:"Section Heading",description:"Title for this section",placeholder:"Enter section heading...",default:"Custom Section"},headingLevel:{type:P.SELECT,label:"Heading Level",options:[{value:2,label:"Heading 2 (Standard)"},{value:3,label:"Heading 3 (Subsection)"},{value:4,label:"Heading 4 (Minor)"}],default:2},content:{type:P.TEXTAREA,label:"Content",description:"Section content (supports basic formatting)",placeholder:"Enter section content...",rows:10,aiAssist:!0}}},[B.RESOURCE_SUMMARY]:{type:B.RESOURCE_SUMMARY,name:"Resource Summary",description:"Team composition and resource allocation overview",icon:tr,category:ce.CONTENT,dataSource:de.METRICS_SERVICE,dataMethod:"getResourceMetrics",roleRestriction:["admin","supplier_pm"],defaultConfig:{includeChart:!0,showAllocation:!0,showUtilisation:!0,groupByRole:!0},configSchema:{includeChart:{type:P.BOOLEAN,label:"Include Resource Chart",description:"Show visual resource breakdown",default:!0},showAllocation:{type:P.BOOLEAN,label:"Show Allocation",description:"Display days allocated per resource",default:!0},showUtilisation:{type:P.BOOLEAN,label:"Show Utilisation",description:"Display utilisation percentage",default:!0},groupByRole:{type:P.BOOLEAN,label:"Group by Role",description:"Organise resources by role type",default:!0}}}};function nt(n){return Mo[n]||null}function Se(n){const t=Object.prototype.toString.call(n);return n instanceof Date||typeof n=="object"&&t==="[object Date]"?new n.constructor(+n):typeof n=="number"||t==="[object Number]"||typeof n=="string"||t==="[object String]"?new Date(n):new Date(NaN)}function ze(n,t){return n instanceof Date?new n.constructor(t):new Date(t)}const Gs=6048e5,No=864e5;let Io={};function Nt(){return Io}function ut(n,t){const e=Nt(),r=t?.weekStartsOn??t?.locale?.options?.weekStartsOn??e.weekStartsOn??e.locale?.options?.weekStartsOn??0,a=Se(n),i=a.getDay(),o=(i<r?7:0)+i-r;return a.setDate(a.getDate()-o),a.setHours(0,0,0,0),a}function Rt(n){return ut(n,{weekStartsOn:1})}function Ks(n){const t=Se(n),e=t.getFullYear(),r=ze(n,0);r.setFullYear(e+1,0,4),r.setHours(0,0,0,0);const a=Rt(r),i=ze(n,0);i.setFullYear(e,0,4),i.setHours(0,0,0,0);const o=Rt(i);return t.getTime()>=a.getTime()?e+1:t.getTime()>=o.getTime()?e:e-1}function Tr(n){const t=Se(n);return t.setHours(0,0,0,0),t}function Dr(n){const t=Se(n),e=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds(),t.getMilliseconds()));return e.setUTCFullYear(t.getFullYear()),+n-+e}function Oo(n,t){const e=Tr(n),r=Tr(t),a=+e-Dr(e),i=+r-Dr(r);return Math.round((a-i)/No)}function Lo(n){const t=Ks(n),e=ze(n,0);return e.setFullYear(t,0,4),e.setHours(0,0,0,0),Rt(e)}function Bo(n){return n instanceof Date||typeof n=="object"&&Object.prototype.toString.call(n)==="[object Date]"}function qo(n){if(!Bo(n)&&typeof n!="number")return!1;const t=Se(n);return!isNaN(Number(t))}function $o(n){const t=Se(n),e=ze(n,0);return e.setFullYear(t.getFullYear(),0,1),e.setHours(0,0,0,0),e}const Wo={lessThanXSeconds:{one:"less than a second",other:"less than {{count}} seconds"},xSeconds:{one:"1 second",other:"{{count}} seconds"},halfAMinute:"half a minute",lessThanXMinutes:{one:"less than a minute",other:"less than {{count}} minutes"},xMinutes:{one:"1 minute",other:"{{count}} minutes"},aboutXHours:{one:"about 1 hour",other:"about {{count}} hours"},xHours:{one:"1 hour",other:"{{count}} hours"},xDays:{one:"1 day",other:"{{count}} days"},aboutXWeeks:{one:"about 1 week",other:"about {{count}} weeks"},xWeeks:{one:"1 week",other:"{{count}} weeks"},aboutXMonths:{one:"about 1 month",other:"about {{count}} months"},xMonths:{one:"1 month",other:"{{count}} months"},aboutXYears:{one:"about 1 year",other:"about {{count}} years"},xYears:{one:"1 year",other:"{{count}} years"},overXYears:{one:"over 1 year",other:"over {{count}} years"},almostXYears:{one:"almost 1 year",other:"almost {{count}} years"}},Uo=(n,t,e)=>{let r;const a=Wo[n];return typeof a=="string"?r=a:t===1?r=a.one:r=a.other.replace("{{count}}",t.toString()),e?.addSuffix?e.comparison&&e.comparison>0?"in "+r:r+" ago":r};function zt(n){return(t={})=>{const e=t.width?String(t.width):n.defaultWidth;return n.formats[e]||n.formats[n.defaultWidth]}}const Vo={full:"EEEE, MMMM do, y",long:"MMMM do, y",medium:"MMM d, y",short:"MM/dd/yyyy"},zo={full:"h:mm:ss a zzzz",long:"h:mm:ss a z",medium:"h:mm:ss a",short:"h:mm a"},Fo={full:"{{date}} 'at' {{time}}",long:"{{date}} 'at' {{time}}",medium:"{{date}}, {{time}}",short:"{{date}}, {{time}}"},Ho={date:zt({formats:Vo,defaultWidth:"full"}),time:zt({formats:zo,defaultWidth:"full"}),dateTime:zt({formats:Fo,defaultWidth:"full"})},Yo={lastWeek:"'last' eeee 'at' p",yesterday:"'yesterday at' p",today:"'today at' p",tomorrow:"'tomorrow at' p",nextWeek:"eeee 'at' p",other:"P"},Go=(n,t,e,r)=>Yo[n];function it(n){return(t,e)=>{const r=e?.context?String(e.context):"standalone";let a;if(r==="formatting"&&n.formattingValues){const o=n.defaultFormattingWidth||n.defaultWidth,c=e?.width?String(e.width):o;a=n.formattingValues[c]||n.formattingValues[o]}else{const o=n.defaultWidth,c=e?.width?String(e.width):n.defaultWidth;a=n.values[c]||n.values[o]}const i=n.argumentCallback?n.argumentCallback(t):t;return a[i]}}const Ko={narrow:["B","A"],abbreviated:["BC","AD"],wide:["Before Christ","Anno Domini"]},Qo={narrow:["1","2","3","4"],abbreviated:["Q1","Q2","Q3","Q4"],wide:["1st quarter","2nd quarter","3rd quarter","4th quarter"]},Xo={narrow:["J","F","M","A","M","J","J","A","S","O","N","D"],abbreviated:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],wide:["January","February","March","April","May","June","July","August","September","October","November","December"]},Jo={narrow:["S","M","T","W","T","F","S"],short:["Su","Mo","Tu","We","Th","Fr","Sa"],abbreviated:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],wide:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]},Zo={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"}},el={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"}},tl=(n,t)=>{const e=Number(n),r=e%100;if(r>20||r<10)switch(r%10){case 1:return e+"st";case 2:return e+"nd";case 3:return e+"rd"}return e+"th"},rl={ordinalNumber:tl,era:it({values:Ko,defaultWidth:"wide"}),quarter:it({values:Qo,defaultWidth:"wide",argumentCallback:n=>n-1}),month:it({values:Xo,defaultWidth:"wide"}),day:it({values:Jo,defaultWidth:"wide"}),dayPeriod:it({values:Zo,defaultWidth:"wide",formattingValues:el,defaultFormattingWidth:"wide"})};function ot(n){return(t,e={})=>{const r=e.width,a=r&&n.matchPatterns[r]||n.matchPatterns[n.defaultMatchWidth],i=t.match(a);if(!i)return null;const o=i[0],c=r&&n.parsePatterns[r]||n.parsePatterns[n.defaultParseWidth],l=Array.isArray(c)?al(c,m=>m.test(o)):sl(c,m=>m.test(o));let d;d=n.valueCallback?n.valueCallback(l):l,d=e.valueCallback?e.valueCallback(d):d;const h=t.slice(o.length);return{value:d,rest:h}}}function sl(n,t){for(const e in n)if(Object.prototype.hasOwnProperty.call(n,e)&&t(n[e]))return e}function al(n,t){for(let e=0;e<n.length;e++)if(t(n[e]))return e}function nl(n){return(t,e={})=>{const r=t.match(n.matchPattern);if(!r)return null;const a=r[0],i=t.match(n.parsePattern);if(!i)return null;let o=n.valueCallback?n.valueCallback(i[0]):i[0];o=e.valueCallback?e.valueCallback(o):o;const c=t.slice(a.length);return{value:o,rest:c}}}const il=/^(\d+)(th|st|nd|rd)?/i,ol=/\d+/i,ll={narrow:/^(b|a)/i,abbreviated:/^(b\.?\s?c\.?|b\.?\s?c\.?\s?e\.?|a\.?\s?d\.?|c\.?\s?e\.?)/i,wide:/^(before christ|before common era|anno domini|common era)/i},cl={any:[/^b/i,/^(a|c)/i]},dl={narrow:/^[1234]/i,abbreviated:/^q[1234]/i,wide:/^[1234](th|st|nd|rd)? quarter/i},ul={any:[/1/i,/2/i,/3/i,/4/i]},ml={narrow:/^[jfmasond]/i,abbreviated:/^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)/i,wide:/^(january|february|march|april|may|june|july|august|september|october|november|december)/i},hl={narrow:[/^j/i,/^f/i,/^m/i,/^a/i,/^m/i,/^j/i,/^j/i,/^a/i,/^s/i,/^o/i,/^n/i,/^d/i],any:[/^ja/i,/^f/i,/^mar/i,/^ap/i,/^may/i,/^jun/i,/^jul/i,/^au/i,/^s/i,/^o/i,/^n/i,/^d/i]},pl={narrow:/^[smtwf]/i,short:/^(su|mo|tu|we|th|fr|sa)/i,abbreviated:/^(sun|mon|tue|wed|thu|fri|sat)/i,wide:/^(sunday|monday|tuesday|wednesday|thursday|friday|saturday)/i},fl={narrow:[/^s/i,/^m/i,/^t/i,/^w/i,/^t/i,/^f/i,/^s/i],any:[/^su/i,/^m/i,/^tu/i,/^w/i,/^th/i,/^f/i,/^sa/i]},gl={narrow:/^(a|p|mi|n|(in the|at) (morning|afternoon|evening|night))/i,any:/^([ap]\.?\s?m\.?|midnight|noon|(in the|at) (morning|afternoon|evening|night))/i},yl={any:{am:/^a/i,pm:/^p/i,midnight:/^mi/i,noon:/^no/i,morning:/morning/i,afternoon:/afternoon/i,evening:/evening/i,night:/night/i}},bl={ordinalNumber:nl({matchPattern:il,parsePattern:ol,valueCallback:n=>parseInt(n,10)}),era:ot({matchPatterns:ll,defaultMatchWidth:"wide",parsePatterns:cl,defaultParseWidth:"any"}),quarter:ot({matchPatterns:dl,defaultMatchWidth:"wide",parsePatterns:ul,defaultParseWidth:"any",valueCallback:n=>n+1}),month:ot({matchPatterns:ml,defaultMatchWidth:"wide",parsePatterns:hl,defaultParseWidth:"any"}),day:ot({matchPatterns:pl,defaultMatchWidth:"wide",parsePatterns:fl,defaultParseWidth:"any"}),dayPeriod:ot({matchPatterns:gl,defaultMatchWidth:"any",parsePatterns:yl,defaultParseWidth:"any"})},wl={code:"en-US",formatDistance:Uo,formatLong:Ho,formatRelative:Go,localize:rl,match:bl,options:{weekStartsOn:0,firstWeekContainsDate:1}};function vl(n){const t=Se(n);return Oo(t,$o(t))+1}function xl(n){const t=Se(n),e=+Rt(t)-+Lo(t);return Math.round(e/Gs)+1}function Qs(n,t){const e=Se(n),r=e.getFullYear(),a=Nt(),i=t?.firstWeekContainsDate??t?.locale?.options?.firstWeekContainsDate??a.firstWeekContainsDate??a.locale?.options?.firstWeekContainsDate??1,o=ze(n,0);o.setFullYear(r+1,0,i),o.setHours(0,0,0,0);const c=ut(o,t),l=ze(n,0);l.setFullYear(r,0,i),l.setHours(0,0,0,0);const d=ut(l,t);return e.getTime()>=c.getTime()?r+1:e.getTime()>=d.getTime()?r:r-1}function _l(n,t){const e=Nt(),r=t?.firstWeekContainsDate??t?.locale?.options?.firstWeekContainsDate??e.firstWeekContainsDate??e.locale?.options?.firstWeekContainsDate??1,a=Qs(n,t),i=ze(n,0);return i.setFullYear(a,0,r),i.setHours(0,0,0,0),ut(i,t)}function Sl(n,t){const e=Se(n),r=+ut(e,t)-+_l(e,t);return Math.round(r/Gs)+1}function Q(n,t){const e=n<0?"-":"",r=Math.abs(n).toString().padStart(t,"0");return e+r}const Te={y(n,t){const e=n.getFullYear(),r=e>0?e:1-e;return Q(t==="yy"?r%100:r,t.length)},M(n,t){const e=n.getMonth();return t==="M"?String(e+1):Q(e+1,2)},d(n,t){return Q(n.getDate(),t.length)},a(n,t){const e=n.getHours()/12>=1?"pm":"am";switch(t){case"a":case"aa":return e.toUpperCase();case"aaa":return e;case"aaaaa":return e[0];case"aaaa":default:return e==="am"?"a.m.":"p.m."}},h(n,t){return Q(n.getHours()%12||12,t.length)},H(n,t){return Q(n.getHours(),t.length)},m(n,t){return Q(n.getMinutes(),t.length)},s(n,t){return Q(n.getSeconds(),t.length)},S(n,t){const e=t.length,r=n.getMilliseconds(),a=Math.trunc(r*Math.pow(10,e-3));return Q(a,t.length)}},Ye={midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},Pr={G:function(n,t,e){const r=n.getFullYear()>0?1:0;switch(t){case"G":case"GG":case"GGG":return e.era(r,{width:"abbreviated"});case"GGGGG":return e.era(r,{width:"narrow"});case"GGGG":default:return e.era(r,{width:"wide"})}},y:function(n,t,e){if(t==="yo"){const r=n.getFullYear(),a=r>0?r:1-r;return e.ordinalNumber(a,{unit:"year"})}return Te.y(n,t)},Y:function(n,t,e,r){const a=Qs(n,r),i=a>0?a:1-a;if(t==="YY"){const o=i%100;return Q(o,2)}return t==="Yo"?e.ordinalNumber(i,{unit:"year"}):Q(i,t.length)},R:function(n,t){const e=Ks(n);return Q(e,t.length)},u:function(n,t){const e=n.getFullYear();return Q(e,t.length)},Q:function(n,t,e){const r=Math.ceil((n.getMonth()+1)/3);switch(t){case"Q":return String(r);case"QQ":return Q(r,2);case"Qo":return e.ordinalNumber(r,{unit:"quarter"});case"QQQ":return e.quarter(r,{width:"abbreviated",context:"formatting"});case"QQQQQ":return e.quarter(r,{width:"narrow",context:"formatting"});case"QQQQ":default:return e.quarter(r,{width:"wide",context:"formatting"})}},q:function(n,t,e){const r=Math.ceil((n.getMonth()+1)/3);switch(t){case"q":return String(r);case"qq":return Q(r,2);case"qo":return e.ordinalNumber(r,{unit:"quarter"});case"qqq":return e.quarter(r,{width:"abbreviated",context:"standalone"});case"qqqqq":return e.quarter(r,{width:"narrow",context:"standalone"});case"qqqq":default:return e.quarter(r,{width:"wide",context:"standalone"})}},M:function(n,t,e){const r=n.getMonth();switch(t){case"M":case"MM":return Te.M(n,t);case"Mo":return e.ordinalNumber(r+1,{unit:"month"});case"MMM":return e.month(r,{width:"abbreviated",context:"formatting"});case"MMMMM":return e.month(r,{width:"narrow",context:"formatting"});case"MMMM":default:return e.month(r,{width:"wide",context:"formatting"})}},L:function(n,t,e){const r=n.getMonth();switch(t){case"L":return String(r+1);case"LL":return Q(r+1,2);case"Lo":return e.ordinalNumber(r+1,{unit:"month"});case"LLL":return e.month(r,{width:"abbreviated",context:"standalone"});case"LLLLL":return e.month(r,{width:"narrow",context:"standalone"});case"LLLL":default:return e.month(r,{width:"wide",context:"standalone"})}},w:function(n,t,e,r){const a=Sl(n,r);return t==="wo"?e.ordinalNumber(a,{unit:"week"}):Q(a,t.length)},I:function(n,t,e){const r=xl(n);return t==="Io"?e.ordinalNumber(r,{unit:"week"}):Q(r,t.length)},d:function(n,t,e){return t==="do"?e.ordinalNumber(n.getDate(),{unit:"date"}):Te.d(n,t)},D:function(n,t,e){const r=vl(n);return t==="Do"?e.ordinalNumber(r,{unit:"dayOfYear"}):Q(r,t.length)},E:function(n,t,e){const r=n.getDay();switch(t){case"E":case"EE":case"EEE":return e.day(r,{width:"abbreviated",context:"formatting"});case"EEEEE":return e.day(r,{width:"narrow",context:"formatting"});case"EEEEEE":return e.day(r,{width:"short",context:"formatting"});case"EEEE":default:return e.day(r,{width:"wide",context:"formatting"})}},e:function(n,t,e,r){const a=n.getDay(),i=(a-r.weekStartsOn+8)%7||7;switch(t){case"e":return String(i);case"ee":return Q(i,2);case"eo":return e.ordinalNumber(i,{unit:"day"});case"eee":return e.day(a,{width:"abbreviated",context:"formatting"});case"eeeee":return e.day(a,{width:"narrow",context:"formatting"});case"eeeeee":return e.day(a,{width:"short",context:"formatting"});case"eeee":default:return e.day(a,{width:"wide",context:"formatting"})}},c:function(n,t,e,r){const a=n.getDay(),i=(a-r.weekStartsOn+8)%7||7;switch(t){case"c":return String(i);case"cc":return Q(i,t.length);case"co":return e.ordinalNumber(i,{unit:"day"});case"ccc":return e.day(a,{width:"abbreviated",context:"standalone"});case"ccccc":return e.day(a,{width:"narrow",context:"standalone"});case"cccccc":return e.day(a,{width:"short",context:"standalone"});case"cccc":default:return e.day(a,{width:"wide",context:"standalone"})}},i:function(n,t,e){const r=n.getDay(),a=r===0?7:r;switch(t){case"i":return String(a);case"ii":return Q(a,t.length);case"io":return e.ordinalNumber(a,{unit:"day"});case"iii":return e.day(r,{width:"abbreviated",context:"formatting"});case"iiiii":return e.day(r,{width:"narrow",context:"formatting"});case"iiiiii":return e.day(r,{width:"short",context:"formatting"});case"iiii":default:return e.day(r,{width:"wide",context:"formatting"})}},a:function(n,t,e){const a=n.getHours()/12>=1?"pm":"am";switch(t){case"a":case"aa":return e.dayPeriod(a,{width:"abbreviated",context:"formatting"});case"aaa":return e.dayPeriod(a,{width:"abbreviated",context:"formatting"}).toLowerCase();case"aaaaa":return e.dayPeriod(a,{width:"narrow",context:"formatting"});case"aaaa":default:return e.dayPeriod(a,{width:"wide",context:"formatting"})}},b:function(n,t,e){const r=n.getHours();let a;switch(r===12?a=Ye.noon:r===0?a=Ye.midnight:a=r/12>=1?"pm":"am",t){case"b":case"bb":return e.dayPeriod(a,{width:"abbreviated",context:"formatting"});case"bbb":return e.dayPeriod(a,{width:"abbreviated",context:"formatting"}).toLowerCase();case"bbbbb":return e.dayPeriod(a,{width:"narrow",context:"formatting"});case"bbbb":default:return e.dayPeriod(a,{width:"wide",context:"formatting"})}},B:function(n,t,e){const r=n.getHours();let a;switch(r>=17?a=Ye.evening:r>=12?a=Ye.afternoon:r>=4?a=Ye.morning:a=Ye.night,t){case"B":case"BB":case"BBB":return e.dayPeriod(a,{width:"abbreviated",context:"formatting"});case"BBBBB":return e.dayPeriod(a,{width:"narrow",context:"formatting"});case"BBBB":default:return e.dayPeriod(a,{width:"wide",context:"formatting"})}},h:function(n,t,e){if(t==="ho"){let r=n.getHours()%12;return r===0&&(r=12),e.ordinalNumber(r,{unit:"hour"})}return Te.h(n,t)},H:function(n,t,e){return t==="Ho"?e.ordinalNumber(n.getHours(),{unit:"hour"}):Te.H(n,t)},K:function(n,t,e){const r=n.getHours()%12;return t==="Ko"?e.ordinalNumber(r,{unit:"hour"}):Q(r,t.length)},k:function(n,t,e){let r=n.getHours();return r===0&&(r=24),t==="ko"?e.ordinalNumber(r,{unit:"hour"}):Q(r,t.length)},m:function(n,t,e){return t==="mo"?e.ordinalNumber(n.getMinutes(),{unit:"minute"}):Te.m(n,t)},s:function(n,t,e){return t==="so"?e.ordinalNumber(n.getSeconds(),{unit:"second"}):Te.s(n,t)},S:function(n,t){return Te.S(n,t)},X:function(n,t,e){const r=n.getTimezoneOffset();if(r===0)return"Z";switch(t){case"X":return Nr(r);case"XXXX":case"XX":return $e(r);case"XXXXX":case"XXX":default:return $e(r,":")}},x:function(n,t,e){const r=n.getTimezoneOffset();switch(t){case"x":return Nr(r);case"xxxx":case"xx":return $e(r);case"xxxxx":case"xxx":default:return $e(r,":")}},O:function(n,t,e){const r=n.getTimezoneOffset();switch(t){case"O":case"OO":case"OOO":return"GMT"+Mr(r,":");case"OOOO":default:return"GMT"+$e(r,":")}},z:function(n,t,e){const r=n.getTimezoneOffset();switch(t){case"z":case"zz":case"zzz":return"GMT"+Mr(r,":");case"zzzz":default:return"GMT"+$e(r,":")}},t:function(n,t,e){const r=Math.trunc(n.getTime()/1e3);return Q(r,t.length)},T:function(n,t,e){const r=n.getTime();return Q(r,t.length)}};function Mr(n,t=""){const e=n>0?"-":"+",r=Math.abs(n),a=Math.trunc(r/60),i=r%60;return i===0?e+String(a):e+String(a)+t+Q(i,2)}function Nr(n,t){return n%60===0?(n>0?"-":"+")+Q(Math.abs(n)/60,2):$e(n,t)}function $e(n,t=""){const e=n>0?"-":"+",r=Math.abs(n),a=Q(Math.trunc(r/60),2),i=Q(r%60,2);return e+a+t+i}const Ir=(n,t)=>{switch(n){case"P":return t.date({width:"short"});case"PP":return t.date({width:"medium"});case"PPP":return t.date({width:"long"});case"PPPP":default:return t.date({width:"full"})}},Xs=(n,t)=>{switch(n){case"p":return t.time({width:"short"});case"pp":return t.time({width:"medium"});case"ppp":return t.time({width:"long"});case"pppp":default:return t.time({width:"full"})}},jl=(n,t)=>{const e=n.match(/(P+)(p+)?/)||[],r=e[1],a=e[2];if(!a)return Ir(n,t);let i;switch(r){case"P":i=t.dateTime({width:"short"});break;case"PP":i=t.dateTime({width:"medium"});break;case"PPP":i=t.dateTime({width:"long"});break;case"PPPP":default:i=t.dateTime({width:"full"});break}return i.replace("{{date}}",Ir(r,t)).replace("{{time}}",Xs(a,t))},Cl={p:Xs,P:jl},El=/^D+$/,kl=/^Y+$/,Rl=["D","DD","YY","YYYY"];function Al(n){return El.test(n)}function Tl(n){return kl.test(n)}function Dl(n,t,e){const r=Pl(n,t,e);if(Rl.includes(n))throw new RangeError(r)}function Pl(n,t,e){const r=n[0]==="Y"?"years":"days of the month";return`Use \`${n.toLowerCase()}\` instead of \`${n}\` (in \`${t}\`) for formatting ${r} to the input \`${e}\`; see: https://github.com/date-fns/date-fns/blob/master/docs/unicodeTokens.md`}const Ml=/[yYQqMLwIdDecihHKkms]o|(\w)\1*|''|'(''|[^'])+('|$)|./g,Nl=/P+p+|P+|p+|''|'(''|[^'])+('|$)|./g,Il=/^'([^]*?)'?$/,Ol=/''/g,Ll=/[a-zA-Z]/;function Ge(n,t,e){const r=Nt(),a=r.locale??wl,i=r.firstWeekContainsDate??r.locale?.options?.firstWeekContainsDate??1,o=r.weekStartsOn??r.locale?.options?.weekStartsOn??0,c=Se(n);if(!qo(c))throw new RangeError("Invalid time value");let l=t.match(Nl).map(h=>{const m=h[0];if(m==="p"||m==="P"){const p=Cl[m];return p(h,a.formatLong)}return h}).join("").match(Ml).map(h=>{if(h==="''")return{isToken:!1,value:"'"};const m=h[0];if(m==="'")return{isToken:!1,value:Bl(h)};if(Pr[m])return{isToken:!0,value:h};if(m.match(Ll))throw new RangeError("Format string contains an unescaped latin alphabet character `"+m+"`");return{isToken:!1,value:h}});a.localize.preprocessor&&(l=a.localize.preprocessor(c,l));const d={firstWeekContainsDate:i,weekStartsOn:o,locale:a};return l.map(h=>{if(!h.isToken)return h.value;const m=h.value;(Tl(m)||Al(m))&&Dl(m,t,String(n));const p=Pr[m[0]];return p(c,m,a.localize,d)}).join("")}function Bl(n){const t=n.match(Il);return t?t[1].replace(Ol,"'"):n}const V={primary:"#3B82F6",success:"#22C55E",warning:"#F59E0B",danger:"#EF4444",neutral:"#6B7280",purple:"#8B5CF6",cyan:"#06B6D4",pink:"#EC4899",indigo:"#6366F1",teal:"#14B8A6"},xe={Completed:V.success,Delivered:V.success,"In Progress":V.primary,"In Review":V.warning,Submitted:V.warning,"Not Started":V.neutral,Draft:V.neutral,"On Hold":V.warning,Green:V.success,Amber:V.warning,Red:V.danger,Open:V.danger,Closed:V.success,Mitigated:V.success,Accepted:V.primary,High:V.danger,Medium:V.warning,Low:V.success};class ql{constructor(){this.defaultStyles=this.getDefaultStyles()}renderReport(t,e,r){const a=[],i=t.template_definition?.sections||[],o=this.buildReportContext(t,r);let c="";t.template_definition?.metadata?.includeCoverPage!==!1&&(c=this.renderCoverPage(t,o));let l="";t.template_definition?.metadata?.includeTableOfContents&&(l=this.renderTableOfContents(i,e));const d=i.map((m,p)=>{try{const y=e.get(m.id);return y?y.success?y.data?.restricted?this.renderRestrictedSection(m,y.data.message):this.renderSection(m,y.data,o):(a.push(`Section ${p+1} (${m.type}): ${y.error}`),this.renderErrorSection(m,y.error)):(a.push(`Section ${p+1} (${m.type}): No data available`),this.renderEmptySection(m))}catch(y){return a.push(`Section ${p+1} (${m.type}): ${y.message}`),this.renderErrorSection(m,y.message)}}).join(`
`);return{html:this.wrapDocument(c+l+d,t,o),warnings:a}}renderSection(t,e,r){if(!nt(t.type))return`<!-- Unknown section type: ${t.type} -->`;switch(t.type){case B.MILESTONE_SUMMARY:return this.renderMilestoneSummary(t,e,r);case B.DELIVERABLE_SUMMARY:return this.renderDeliverableSummary(t,e,r);case B.KPI_PERFORMANCE:return this.renderKPIPerformance(t,e,r);case B.QUALITY_STANDARDS:return this.renderQualityStandards(t,e,r);case B.BUDGET_ANALYSIS:return this.renderBudgetAnalysis(t,e,r);case B.RAID_SUMMARY:return this.renderRAIDSummary(t,e,r);case B.TIMESHEET_SUMMARY:return this.renderTimesheetSummary(t,e,r);case B.EXPENSE_SUMMARY:return this.renderExpenseSummary(t,e,r);case B.FORWARD_LOOK:return this.renderForwardLook(t,e,r);case B.UPCOMING_MILESTONES:return this.renderUpcomingMilestones(t,e,r);case B.UPCOMING_DELIVERABLES:return this.renderUpcomingDeliverables(t,e,r);case B.EXECUTIVE_SUMMARY:return this.renderExecutiveSummary(t,e,r);case B.LESSONS_LEARNED:return this.renderLessonsLearned(t,e,r);case B.CUSTOM_TEXT:return this.renderCustomText(t,e,r);case B.RESOURCE_SUMMARY:return this.renderResourceSummary(t,e,r);default:return`<!-- Unhandled section type: ${t.type} -->`}}renderMilestoneSummary(t,e,r){const{summary:a,items:i,config:o}=e;let c=this.renderSectionHeader("Milestone Summary",t,e.dateRange);if(c+=this.renderSummaryCards([{label:"Total",value:a.total,color:"neutral"},{label:"Completed",value:a.completed,color:"success"},{label:"In Progress",value:a.inProgress,color:"primary"},{label:"Not Started",value:a.notStarted,color:"neutral"}]),o.includeChart&&i.length>0&&(c+=this.renderDonutChart("Milestone Status",[{label:"Completed",value:a.completed,color:xe.Completed},{label:"In Progress",value:a.inProgress,color:xe["In Progress"]},{label:"Not Started",value:a.notStarted,color:xe["Not Started"]}])),i.length>0){const l=[{key:"ref",header:"Ref",width:"10%"},{key:"name",header:"Milestone",width:o.showBudget?"40%":"50%"},{key:"status",header:"Status",width:"15%",format:"status"},{key:"progress",header:"Progress",width:o.showBudget?"15%":"25%",format:"percent"}];o.showBudget&&l.push({key:"budget",header:"Budget",width:"20%",format:"currency"}),c+=this.renderTable(i,l)}else c+=this.renderEmptyMessage("No milestones found");return this.wrapSection(c)}renderDeliverableSummary(t,e,r){const{summary:a,items:i,config:o}=e;let c=this.renderSectionHeader("Deliverable Summary",t,e.dateRange);if(c+=this.renderSummaryCards([{label:"Total",value:a.total,color:"neutral"},{label:"Delivered",value:a.delivered,color:"success"},{label:"In Progress",value:a.inProgress,color:"primary"},{label:"Overdue",value:a.overdue,color:"danger"}]),o.includeChart&&i.length>0&&(c+=this.renderDonutChart("Deliverable Status",[{label:"Delivered",value:a.delivered,color:xe.Delivered},{label:"In Progress",value:a.inProgress,color:xe["In Progress"]},{label:"Not Started",value:a.notStarted,color:xe["Not Started"]}])),i.length>0){const l=i.map(d=>({...d,statusClass:d.isOverdue?"overdue":""}));c+=this.renderTable(l,[{key:"ref",header:"Ref",width:"10%"},{key:"name",header:"Deliverable",width:"45%"},{key:"status",header:"Status",width:"15%",format:"status"},{key:"dueDate",header:"Due Date",width:"15%",format:"date"}],{highlightOverdue:o.highlightOverdue})}else c+=this.renderEmptyMessage("No deliverables found");return this.wrapSection(c)}renderKPIPerformance(t,e,r){const{summary:a,items:i,config:o,byCategory:c}=e;let l=this.renderSectionHeader("KPI Performance",t,e.dateRange);if(l+=this.renderSummaryCards([{label:"Total KPIs",value:a.total,color:"neutral"},{label:"Achieved",value:a.achieved,color:"success"},{label:"At Risk",value:a.atRisk,color:"warning"},{label:"Below Target",value:a.failing,color:"danger"}]),o.includeChart&&i.length>0&&(l+=this.renderDonutChart("KPI Achievement",[{label:"Achieved",value:a.achieved,color:xe.Green},{label:"At Risk",value:a.atRisk,color:xe.Amber},{label:"Below Target",value:a.failing,color:xe.Red}])),i.length>0){const d=[{key:"ref",header:"Ref",width:"10%"},{key:"name",header:"KPI",width:"35%"}];o.includeTarget&&d.push({key:"target",header:"Target",width:"12%",format:"percent"}),d.push({key:"actual",header:"Actual",width:"12%",format:"percent"}),o.showRAG&&d.push({key:"ragStatus",header:"RAG",width:"10%",format:"rag"}),d.push({key:"assessmentCount",header:"Assessments",width:"12%"}),l+=this.renderTable(i,d)}else l+=this.renderEmptyMessage("No KPIs defined");return this.wrapSection(l)}renderQualityStandards(t,e,r){const{summary:a,items:i,config:o}=e;let c=this.renderSectionHeader("Quality Standards",t,e.dateRange);if(c+=this.renderSummaryCards([{label:"Total Standards",value:a.total,color:"neutral"},{label:"Achieved",value:a.achieved,color:"success"},{label:"Partial",value:a.partial,color:"warning"},{label:"Not Met",value:a.notMet,color:"danger"}]),o.includeChart&&i.length>0&&(c+=this.renderDonutChart("Compliance Status",[{label:"Achieved",value:a.achieved,color:V.success},{label:"Partial",value:a.partial,color:V.warning},{label:"Not Met",value:a.notMet,color:V.danger}])),i.length>0){const l=[{key:"ref",header:"Ref",width:"10%"},{key:"name",header:"Quality Standard",width:"40%"},{key:"target",header:"Target",width:"12%",format:"percent"},{key:"actual",header:"Actual",width:"12%",format:"percent"}];o.showAssessmentCount&&l.push({key:"assessmentCount",header:"Assessments",width:"12%"}),c+=this.renderTable(i,l)}else c+=this.renderEmptyMessage("No quality standards defined");return this.wrapSection(c)}renderBudgetAnalysis(t,e,r){const{summary:a,pmoVsDelivery:i,byMilestone:o,config:c}=e;let l=this.renderSectionHeader("Budget Analysis",t,e.dateRange);return l+=`
      <div class="budget-overview">
        <div class="budget-row">
          <div class="budget-item">
            <span class="budget-label">Total Budget</span>
            <span class="budget-value">${this.formatCurrency(a.totalBudget)}</span>
          </div>
          <div class="budget-item">
            <span class="budget-label">Total Spend</span>
            <span class="budget-value">${this.formatCurrency(a.totalSpend)}</span>
          </div>
          <div class="budget-item ${a.variance>=0?"positive":"negative"}">
            <span class="budget-label">Variance</span>
            <span class="budget-value">${this.formatCurrency(a.variance)}</span>
          </div>
          <div class="budget-item">
            <span class="budget-label">Utilisation</span>
            <span class="budget-value">${a.utilizationPercent}%</span>
          </div>
        </div>
      </div>
    `,c.includeChart&&(l+=this.renderBarChart("Budget vs Spend",[{label:"Budget",value:a.totalBudget,color:V.primary},{label:"Spend",value:a.totalSpend,color:V.success}])),c.showPMOvsDelivery&&i&&(l+=`
        <h4 class="subsection-title">PMO vs Delivery Split</h4>
        <div class="two-column">
          <div class="column">
            <h5>PMO</h5>
            <div class="mini-stats">
              <div>Budget: ${this.formatCurrency(i.pmo.budget)}</div>
              <div>Spend: ${this.formatCurrency(i.pmo.spend)}</div>
              <div class="${i.pmo.variance>=0?"positive":"negative"}">
                Variance: ${this.formatCurrency(i.pmo.variance)}
              </div>
            </div>
          </div>
          <div class="column">
            <h5>Delivery</h5>
            <div class="mini-stats">
              <div>Budget: ${this.formatCurrency(i.delivery.budget)}</div>
              <div>Spend: ${this.formatCurrency(i.delivery.spend)}</div>
              <div class="${i.delivery.variance>=0?"positive":"negative"}">
                Variance: ${this.formatCurrency(i.delivery.variance)}
              </div>
            </div>
          </div>
        </div>
      `),c.showByMilestone&&o&&o.length>0&&(l+='<h4 class="subsection-title">Spend by Milestone</h4>',l+=this.renderTable(o,[{key:"ref",header:"Ref",width:"10%"},{key:"name",header:"Milestone",width:"40%"},{key:"budget",header:"Budget",width:"16%",format:"currency"},{key:"spend",header:"Spend",width:"16%",format:"currency"},{key:"variance",header:"Variance",width:"18%",format:"currencyVariance"}])),this.wrapSection(l)}renderRAIDSummary(t,e,r){const{summary:a,items:i,byCategory:o,config:c}=e;let l=this.renderSectionHeader("RAID Summary",t,e.dateRange);if(l+=this.renderSummaryCards([{label:"Risks",value:`${a.byCategory.Risk?.open||0} open`,color:"danger"},{label:"Assumptions",value:`${a.byCategory.Assumption?.open||0} open`,color:"warning"},{label:"Issues",value:`${a.byCategory.Issue?.open||0} open`,color:"danger"},{label:"Dependencies",value:`${a.byCategory.Dependency?.open||0} open`,color:"primary"}]),c.includeChart&&(l+=this.renderDonutChart("RAID by Category",[{label:"Risks",value:a.byCategory.Risk?.total||0,color:V.danger},{label:"Assumptions",value:a.byCategory.Assumption?.total||0,color:V.warning},{label:"Issues",value:a.byCategory.Issue?.total||0,color:V.purple},{label:"Dependencies",value:a.byCategory.Dependency?.total||0,color:V.primary}])),i.length>0){const d=[{key:"ref",header:"Ref",width:"8%"},{key:"category",header:"Category",width:"12%"},{key:"title",header:"Title",width:c.showDetails?"30%":"45%"},{key:"severity",header:"Severity",width:"10%",format:"severity"},{key:"status",header:"Status",width:"10%",format:"status"}];if(c.showDetails){const h=i.map(m=>({...m,ownerName:m.owner?.name||"â€”"}));d.push({key:"ownerName",header:"Owner",width:"15%"}),l+=this.renderTable(h,d)}else l+=this.renderTable(i,d)}else l+=this.renderEmptyMessage("No RAID items found");return this.wrapSection(l)}renderTimesheetSummary(t,e,r){const{summary:a,byResource:i,byMilestone:o,config:c}=e;let l=this.renderSectionHeader("Timesheet Summary",t,e.dateRange);return l+=this.renderSummaryCards([{label:"Total Hours",value:this.formatNumber(a.totalHours),color:"primary"},{label:"Total Spend",value:this.formatCurrency(a.totalSpend),color:"success"},{label:"PMO Spend",value:this.formatCurrency(a.pmoSpend),color:"neutral"},{label:"Delivery Spend",value:this.formatCurrency(a.deliverySpend),color:"neutral"}]),c.includeChart&&(l+=this.renderBarChart("Spend Breakdown",[{label:"PMO",value:a.pmoSpend,color:V.primary},{label:"Delivery",value:a.deliverySpend,color:V.success}])),l+=`
      <div class="stats-row">
        <span>Valid Entries: ${a.validEntries}</span>
        <span>Draft Entries: ${a.draftEntries}</span>
      </div>
    `,this.wrapSection(l)}renderExpenseSummary(t,e,r){const{summary:a,byCategory:i,chargeableBreakdown:o,config:c}=e;let l=this.renderSectionHeader("Expense Summary",t,e.dateRange);if(l+=this.renderSummaryCards([{label:"Total Expenses",value:this.formatCurrency(a.totalAmount),color:"primary"},{label:"Chargeable",value:this.formatCurrency(a.chargeableAmount),color:"success"},{label:"Non-Chargeable",value:this.formatCurrency(a.nonChargeableAmount),color:"neutral"},{label:"Entries",value:a.validEntries,color:"neutral"}]),c.includeChart&&i&&i.length>0){const d=i.slice(0,6).map((h,m)=>({label:h.category,value:h.amount,color:Object.values(V)[m%Object.keys(V).length]}));l+=this.renderDonutChart("Expenses by Category",d)}return c.showByCategory&&i&&i.length>0&&(l+='<h4 class="subsection-title">Breakdown by Category</h4>',l+=this.renderTable(i,[{key:"category",header:"Category",width:"60%"},{key:"amount",header:"Amount",width:"40%",format:"currency"}])),this.wrapSection(l)}renderForwardLook(t,e,r){const{lookAheadRange:a,milestones:i,deliverables:o,dependencies:c,summary:l,config:d}=e;let h=this.renderSectionHeader("Forward Look",t,null,`Looking ahead: ${a.label}`);if(h+=this.renderSummaryCards([{label:"Upcoming Milestones",value:l.milestonesCount,color:"primary"},{label:"Upcoming Deliverables",value:l.deliverablesCount,color:"success"},{label:"Open Dependencies",value:l.dependenciesCount,color:"warning"},{label:"High Priority",value:l.highPriorityDependencies,color:"danger"}]),d.includeMilestones&&i.length>0&&(h+='<h4 class="subsection-title">Upcoming Milestones</h4>',h+=this.renderTable(i,[{key:"milestone_ref",header:"Ref",width:"10%"},{key:"name",header:"Milestone",width:"50%"},{key:"status",header:"Status",width:"20%",format:"status"},{key:"due_date",header:"Due Date",width:"20%",format:"date"}])),d.includeDeliverables&&o.length>0&&(h+='<h4 class="subsection-title">Upcoming Deliverables</h4>',h+=this.renderTable(o,[{key:"deliverable_ref",header:"Ref",width:"10%"},{key:"name",header:"Deliverable",width:"50%"},{key:"status",header:"Status",width:"20%",format:"status"},{key:"due_date",header:"Due Date",width:"20%",format:"date"}])),d.includeDependencies&&c.length>0){h+='<h4 class="subsection-title">Blocking Dependencies</h4>';const m=c.map(p=>({...p,milestoneName:p.milestone?.name||"â€”"}));h+=this.renderTable(m,[{key:"raid_ref",header:"Ref",width:"10%"},{key:"title",header:"Dependency",width:"40%"},{key:"severity",header:"Severity",width:"15%",format:"severity"},{key:"milestoneName",header:"Milestone",width:"20%"},{key:"status",header:"Status",width:"15%",format:"status"}])}return this.wrapSection(h)}renderUpcomingMilestones(t,e,r){const{lookAheadRange:a,items:i,summary:o,config:c}=e;let l=this.renderSectionHeader("Upcoming Milestones",t,null,`Period: ${a.label}`);if(l+=this.renderSummaryCards([{label:"Total Upcoming",value:o.total,color:"primary"},{label:"Not Started",value:o.notStarted,color:"neutral"},{label:"In Progress",value:o.inProgress,color:"success"},{label:"With Dependencies",value:o.withBlockingDeps,color:"warning"}]),i.length>0){const d=[{key:"milestone_ref",header:"Ref",width:"10%"},{key:"name",header:"Milestone",width:"45%"},{key:"status",header:"Status",width:"15%",format:"status"},{key:"due_date",header:"Due Date",width:"15%",format:"date"},{key:"progress",header:"Progress",width:"15%",format:"percent"}];l+=this.renderTable(i,d),c.showDependencies&&i.forEach(h=>{h.dependencies&&h.dependencies.length>0&&(l+=`
              <div class="dependency-list">
                <strong>${h.milestone_ref}</strong> has ${h.dependencies.length} blocking dependencies:
                <ul>
                  ${h.dependencies.map(m=>`<li>${m.raid_ref}: ${m.title}</li>`).join("")}
                </ul>
              </div>
            `)})}else l+=this.renderEmptyMessage("No upcoming milestones in this period");return this.wrapSection(l)}renderUpcomingDeliverables(t,e,r){const{lookAheadRange:a,items:i,groupedByMilestone:o,summary:c,config:l}=e;let d=this.renderSectionHeader("Upcoming Deliverables",t,null,`Period: ${a.label}`);return d+=this.renderSummaryCards([{label:"Total Due",value:c.total,color:"primary"},{label:"Overdue",value:c.overdue,color:"danger"},{label:"Due This Week",value:c.dueThisWeek,color:"warning"}]),l.groupByMilestone&&o?Object.entries(o).forEach(([h,m])=>{const p=m.milestone?.name||"Unassigned";d+=`<h4 class="subsection-title">${m.milestone?.milestone_ref||""} ${p}</h4>`,d+=this.renderTable(m.deliverables,[{key:"deliverable_ref",header:"Ref",width:"12%"},{key:"name",header:"Deliverable",width:"48%"},{key:"status",header:"Status",width:"20%",format:"status"},{key:"due_date",header:"Due",width:"20%",format:"date"}],{highlightOverdue:l.highlightOverdue})}):i.length>0?d+=this.renderTable(i,[{key:"deliverable_ref",header:"Ref",width:"10%"},{key:"name",header:"Deliverable",width:"45%"},{key:"status",header:"Status",width:"15%",format:"status"},{key:"due_date",header:"Due Date",width:"15%",format:"date"}],{highlightOverdue:l.highlightOverdue}):d+=this.renderEmptyMessage("No deliverables due in this period"),this.wrapSection(d)}renderExecutiveSummary(t,e,r){let a=this.renderSectionHeader("Executive Summary",t);const i=t.config?.content||e.content||"";return i?a+=`<div class="executive-summary-content">${this.sanitizeHtml(i)}</div>`:a+=this.renderEmptyMessage("No executive summary provided"),this.wrapSection(a)}renderLessonsLearned(t,e,r){let a=this.renderSectionHeader("Lessons Learned",t);const i=t.config?.content,o=t.config?.format||"freeform";return Array.isArray(i)&&i.length>0&&o==="structured"?(a+='<div class="lessons-list">',i.forEach((c,l)=>{a+=`
          <div class="lesson-item">
            <div class="lesson-header">
              <span class="lesson-number">${l+1}</span>
              <span class="lesson-category">${c.category||"General"}</span>
            </div>
            <div class="lesson-content">
              <p><strong>Lesson:</strong> ${this.sanitizeHtml(c.lesson||"")}</p>
              ${c.recommendation?`<p><strong>Recommendation:</strong> ${this.sanitizeHtml(c.recommendation)}</p>`:""}
            </div>
          </div>
        `}),a+="</div>"):typeof i=="string"&&i?a+=`<div class="lessons-content">${this.sanitizeHtml(i)}</div>`:a+=this.renderEmptyMessage("No lessons learned recorded"),this.wrapSection(a)}renderCustomText(t,e,r){const a=t.config?.heading||"Custom Section",i=t.config?.headingLevel||2,o=t.config?.content||"";let c="";const l=`h${i}`;return c+=`<${l} class="section-title">${this.sanitizeHtml(a)}</${l}>`,o&&(c+=`<div class="custom-content">${this.sanitizeHtml(o)}</div>`),this.wrapSection(c)}renderResourceSummary(t,e,r){const{summary:a,items:i,byRole:o,config:c}=e;let l=this.renderSectionHeader("Resource Summary",t,e.dateRange);if(l+=this.renderSummaryCards([{label:"Total Resources",value:a.total,color:"primary"},{label:"PMO",value:a.pmoCount,color:"neutral"},{label:"Delivery",value:a.deliveryCount,color:"success"},{label:"Total Budget",value:this.formatCurrency(a.totalBudget),color:"primary"}]),c.includeChart&&(l+=this.renderDonutChart("Resource Split",[{label:"PMO",value:a.pmoCount,color:V.primary},{label:"Delivery",value:a.deliveryCount,color:V.success}])),c.groupByRole&&o)Object.entries(o).forEach(([d,h])=>{l+=`<h4 class="subsection-title">${d}</h4>`;const m=[{key:"name",header:"Name",width:"40%"}];c.showAllocation&&m.push({key:"daysAllocated",header:"Days Allocated",width:"20%"}),m.push({key:"budget",header:"Budget",width:"25%",format:"currency"}),l+=this.renderTable(h,m)});else if(i.length>0){const d=[{key:"name",header:"Name",width:"35%"},{key:"role",header:"Role",width:"25%"}];c.showAllocation&&d.push({key:"daysAllocated",header:"Days",width:"15%"}),d.push({key:"budget",header:"Budget",width:"25%",format:"currency"}),l+=this.renderTable(i,d)}else l+=this.renderEmptyMessage("No resources assigned");return this.wrapSection(l)}renderSectionHeader(t,e,r=null,a=null){let i=`<h2 class="section-title">${t}</h2>`;return r&&(i+=`<p class="section-period">Reporting Period: ${r.label}</p>`),a&&(i+=`<p class="section-subtitle">${a}</p>`),i}renderSummaryCards(t){return`<div class="summary-cards">${t.map(r=>`
        <div class="summary-card ${r.color||"neutral"}">
          <div class="card-value">${r.value}</div>
          <div class="card-label">${r.label}</div>
        </div>
      `).join("")}</div>`}renderTable(t,e,r={}){if(!t||t.length===0)return this.renderEmptyMessage("No data available");const a=e.map(o=>`<th style="width: ${o.width||"auto"}">${o.header}</th>`).join(""),i=t.map(o=>{const c=r.highlightOverdue&&o.isOverdue?"overdue-row":"",l=e.map(d=>{let h=o[d.key];return h=this.formatCellValue(h,d.format),`<td>${h}</td>`}).join("");return`<tr class="${c}">${l}</tr>`}).join("");return`
      <table class="data-table">
        <thead><tr>${a}</tr></thead>
        <tbody>${i}</tbody>
      </table>
    `}renderDonutChart(t,e){const r=e.reduce((p,y)=>p+(y.value||0),0);if(r===0)return"";const a=120,i=25,o=(a-i)/2,c=2*Math.PI*o,l=a/2;let d=0;const h=e.filter(p=>p.value>0).map(p=>{const b=p.value/r*c,g=c-d;return d+=b,`
        <circle
          cx="${l}" cy="${l}" r="${o}"
          fill="none"
          stroke="${p.color}"
          stroke-width="${i}"
          stroke-dasharray="${b} ${c-b}"
          stroke-dashoffset="${g}"
          transform="rotate(-90 ${l} ${l})"
        />
      `}).join(""),m=e.filter(p=>p.value>0).map(p=>`
      <div class="legend-item">
        <span class="legend-color" style="background: ${p.color}"></span>
        <span class="legend-label">${p.label}: ${p.value}</span>
      </div>
    `).join("");return`
      <div class="chart-container">
        <h4 class="chart-title">${t}</h4>
        <div class="chart-wrapper">
          <svg width="${a}" height="${a}" viewBox="0 0 ${a} ${a}">
            ${h}
            <text x="${l}" y="${l}" text-anchor="middle" dominant-baseline="middle" class="chart-center-text">
              ${r}
            </text>
          </svg>
          <div class="chart-legend">${m}</div>
        </div>
      </div>
    `}renderBarChart(t,e){const r=Math.max(...e.map(i=>i.value||0));if(r===0)return"";const a=e.map(i=>{const o=i.value/r*100;return`
        <div class="bar-row">
          <div class="bar-label">${i.label}</div>
          <div class="bar-track">
            <div class="bar-fill" style="width: ${o}%; background: ${i.color}"></div>
          </div>
          <div class="bar-value">${this.formatCurrency(i.value)}</div>
        </div>
      `}).join("");return`
      <div class="bar-chart-container">
        <h4 class="chart-title">${t}</h4>
        <div class="bar-chart">${a}</div>
      </div>
    `}wrapSection(t){return`<section class="report-section">${t}</section>`}renderEmptySection(t){const e=nt(t.type);return this.wrapSection(`
      <h2 class="section-title">${e?.name||t.type}</h2>
      <p class="empty-message">No data available for this section</p>
    `)}renderErrorSection(t,e){const r=nt(t.type);return this.wrapSection(`
      <h2 class="section-title">${r?.name||t.type}</h2>
      <p class="error-message">Error loading section: ${e}</p>
    `)}renderRestrictedSection(t,e){const r=nt(t.type);return this.wrapSection(`
      <h2 class="section-title">${r?.name||t.type}</h2>
      <p class="restricted-message">${e||"You do not have permission to view this section"}</p>
    `)}renderEmptyMessage(t){return`<p class="empty-message">${t}</p>`}renderCoverPage(t,e){const r=t.template_definition?.metadata||{},a=r.title||t.name||"Project Report",i=this.resolveTemplateVariables(r.subtitle,e)||e.project?.name||"";return`
      <div class="cover-page">
        <div class="cover-content">
          <h1 class="cover-title">${a}</h1>
          ${i?`<h2 class="cover-subtitle">${i}</h2>`:""}
          <div class="cover-meta">
            <p>Generated: ${Ge(new Date,"dd MMMM yyyy")}</p>
            ${e.user?.full_name?`<p>By: ${e.user.full_name}</p>`:""}
          </div>
        </div>
      </div>
      <div class="page-break"></div>
    `}renderTableOfContents(t,e){return`
      <div class="table-of-contents">
        <h2>Contents</h2>
        <ol>${t.map((a,i)=>{const o=nt(a.type),c=a.name||o?.name||a.type;return`<li><a href="#section-${i}">${c}</a></li>`}).join("")}</ol>
      </div>
      <div class="page-break"></div>
    `}wrapDocument(t,e,r){const i=(e.template_definition?.metadata||{}).title||e.name||"Report",o=this.getReportStyles();return`
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${i}</title>
  <style>${o}</style>
</head>
<body>
  <div class="report-container">
    ${t}
  </div>
  <footer class="report-footer">
    <p>Generated on ${Ge(new Date,"dd MMMM yyyy")} at ${Ge(new Date,"HH:mm")}</p>
  </footer>
</body>
</html>
    `.trim()}buildReportContext(t,e){return{...e,generated:{date:Ge(new Date,"dd MMMM yyyy"),time:Ge(new Date,"HH:mm"),by:e.user?.full_name||"System"},template:{name:t.name,type:t.report_type}}}formatCellValue(t,e){if(t==null)return"â€”";switch(e){case"date":return this.formatDate(t);case"currency":return this.formatCurrency(t);case"currencyVariance":return this.formatCurrencyVariance(t);case"percent":return`${t}%`;case"status":return this.formatStatus(t);case"rag":return this.formatRAG(t);case"severity":return this.formatSeverity(t);default:return String(t)}}formatDate(t){if(!t)return"â€”";try{const e=typeof t=="string"?new Date(t):t;return Ge(e,"dd MMM yyyy")}catch{return t}}formatCurrency(t){return`Â£${(parseFloat(t)||0).toLocaleString("en-GB",{minimumFractionDigits:0,maximumFractionDigits:0})}`}formatCurrencyVariance(t){const e=parseFloat(t)||0,r=e>=0?"+":"";return`<span class="${e>=0?"positive":"negative"}">${r}Â£${Math.abs(e).toLocaleString("en-GB",{minimumFractionDigits:0,maximumFractionDigits:0})}</span>`}formatNumber(t){return(parseFloat(t)||0).toLocaleString("en-GB",{minimumFractionDigits:0,maximumFractionDigits:1})}formatStatus(t){return`<span class="status-badge" style="background: ${xe[t]||V.neutral}">${t}</span>`}formatRAG(t){return`<span class="rag-indicator" style="background: ${{Green:"#22C55E",Amber:"#F59E0B",Red:"#EF4444"}[t]||V.neutral}">${t}</span>`}formatSeverity(t){return`<span class="severity-badge" style="background: ${xe[t]||V.neutral}">${t}</span>`}resolveTemplateVariables(t,e){return!t||typeof t!="string"?t:t.replace(/\{\{(\w+)\.(\w+)\}\}/g,(r,a,i)=>e[a]?.[i]||r)}sanitizeHtml(t){return t?String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/\n/g,"<br>"):""}getReportStyles(){return`
      /* Base Styles */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        font-size: 12px;
        line-height: 1.5;
        color: #1f2937;
        background: #fff;
      }
      
      .report-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
      }
      
      /* Cover Page */
      .cover-page {
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
      }
      
      .cover-title {
        font-size: 32px;
        font-weight: 700;
        color: #111827;
        margin-bottom: 16px;
      }
      
      .cover-subtitle {
        font-size: 20px;
        font-weight: 400;
        color: #6b7280;
        margin-bottom: 32px;
      }
      
      .cover-meta {
        font-size: 14px;
        color: #9ca3af;
      }
      
      /* Table of Contents */
      .table-of-contents {
        padding: 20px 0;
      }
      
      .table-of-contents h2 {
        font-size: 24px;
        margin-bottom: 20px;
        color: #111827;
      }
      
      .table-of-contents ol {
        padding-left: 24px;
      }
      
      .table-of-contents li {
        margin-bottom: 8px;
      }
      
      .table-of-contents a {
        color: #3b82f6;
        text-decoration: none;
      }
      
      /* Section Styles */
      .report-section {
        margin-bottom: 40px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e5e7eb;
        page-break-inside: avoid;
      }
      
      .section-title {
        font-size: 20px;
        font-weight: 600;
        color: #111827;
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 2px solid #3b82f6;
      }
      
      .section-period,
      .section-subtitle {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 16px;
      }
      
      .subsection-title {
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        margin: 20px 0 12px;
      }
      
      /* Summary Cards */
      .summary-cards {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }
      
      .summary-card {
        flex: 1;
        min-width: 120px;
        padding: 12px 16px;
        background: #f9fafb;
        border-radius: 8px;
        text-align: center;
      }
      
      .summary-card.success { background: #f0fdf4; }
      .summary-card.danger { background: #fef2f2; }
      .summary-card.warning { background: #fffbeb; }
      .summary-card.primary { background: #eff6ff; }
      
      .card-value {
        font-size: 24px;
        font-weight: 700;
        color: #111827;
      }
      
      .summary-card.success .card-value { color: #16a34a; }
      .summary-card.danger .card-value { color: #dc2626; }
      .summary-card.warning .card-value { color: #d97706; }
      .summary-card.primary .card-value { color: #2563eb; }
      
      .card-label {
        font-size: 11px;
        color: #6b7280;
        margin-top: 4px;
      }
      
      /* Data Tables */
      .data-table {
        width: 100%;
        border-collapse: collapse;
        margin: 16px 0;
        font-size: 11px;
      }
      
      .data-table th {
        background: #f3f4f6;
        padding: 10px 12px;
        text-align: left;
        font-weight: 600;
        color: #374151;
        border-bottom: 2px solid #e5e7eb;
      }
      
      .data-table td {
        padding: 10px 12px;
        border-bottom: 1px solid #e5e7eb;
        vertical-align: top;
      }
      
      .data-table tr:hover {
        background: #f9fafb;
      }
      
      .data-table .overdue-row {
        background: #fef2f2;
      }
      
      /* Status Badges */
      .status-badge,
      .rag-indicator,
      .severity-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 600;
        color: white;
      }
      
      /* Charts */
      .chart-container {
        margin: 20px 0;
        padding: 16px;
        background: #f9fafb;
        border-radius: 8px;
      }
      
      .chart-title {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 12px;
        color: #374151;
      }
      
      .chart-wrapper {
        display: flex;
        align-items: center;
        gap: 24px;
      }
      
      .chart-legend {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      
      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 11px;
      }
      
      .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 2px;
      }
      
      .chart-center-text {
        font-size: 18px;
        font-weight: 700;
        fill: #374151;
      }
      
      /* Bar Chart */
      .bar-chart-container {
        margin: 20px 0;
      }
      
      .bar-chart {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      
      .bar-row {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .bar-label {
        width: 80px;
        font-size: 11px;
        color: #6b7280;
      }
      
      .bar-track {
        flex: 1;
        height: 20px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
      }
      
      .bar-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.3s;
      }
      
      .bar-value {
        width: 100px;
        text-align: right;
        font-size: 11px;
        font-weight: 600;
      }
      
      /* Budget Section */
      .budget-overview {
        margin-bottom: 20px;
      }
      
      .budget-row {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
      }
      
      .budget-item {
        flex: 1;
        min-width: 150px;
        padding: 16px;
        background: #f9fafb;
        border-radius: 8px;
      }
      
      .budget-label {
        display: block;
        font-size: 11px;
        color: #6b7280;
        margin-bottom: 4px;
      }
      
      .budget-value {
        display: block;
        font-size: 20px;
        font-weight: 700;
        color: #111827;
      }
      
      .budget-item.positive .budget-value { color: #16a34a; }
      .budget-item.negative .budget-value { color: #dc2626; }
      
      .positive { color: #16a34a; }
      .negative { color: #dc2626; }
      
      /* Two Column Layout */
      .two-column {
        display: flex;
        gap: 24px;
        margin: 16px 0;
      }
      
      .column {
        flex: 1;
        padding: 16px;
        background: #f9fafb;
        border-radius: 8px;
      }
      
      .column h5 {
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 12px;
        color: #374151;
      }
      
      .mini-stats {
        font-size: 12px;
        line-height: 1.8;
      }
      
      /* Stats Row */
      .stats-row {
        display: flex;
        gap: 24px;
        padding: 12px 16px;
        background: #f9fafb;
        border-radius: 8px;
        margin-top: 16px;
        font-size: 12px;
        color: #6b7280;
      }
      
      /* Content Sections */
      .executive-summary-content,
      .lessons-content,
      .custom-content {
        padding: 16px;
        background: #f9fafb;
        border-radius: 8px;
        line-height: 1.7;
      }
      
      .lessons-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      
      .lesson-item {
        padding: 16px;
        background: #f9fafb;
        border-radius: 8px;
        border-left: 4px solid #3b82f6;
      }
      
      .lesson-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
      }
      
      .lesson-number {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        background: #3b82f6;
        color: white;
        border-radius: 50%;
        font-size: 12px;
        font-weight: 600;
      }
      
      .lesson-category {
        font-size: 11px;
        color: #6b7280;
        background: #e5e7eb;
        padding: 2px 8px;
        border-radius: 4px;
      }
      
      .lesson-content p {
        margin-bottom: 8px;
      }
      
      /* Dependencies */
      .dependency-list {
        margin: 12px 0;
        padding: 12px 16px;
        background: #fffbeb;
        border-radius: 8px;
        font-size: 11px;
      }
      
      .dependency-list ul {
        margin-top: 8px;
        padding-left: 20px;
      }
      
      /* Messages */
      .empty-message,
      .error-message,
      .restricted-message {
        padding: 20px;
        text-align: center;
        color: #6b7280;
        font-style: italic;
        background: #f9fafb;
        border-radius: 8px;
      }
      
      .error-message {
        background: #fef2f2;
        color: #dc2626;
      }
      
      .restricted-message {
        background: #fffbeb;
        color: #d97706;
      }
      
      /* Footer */
      .report-footer {
        margin-top: 40px;
        padding-top: 20px;
        border-top: 1px solid #e5e7eb;
        text-align: center;
        font-size: 10px;
        color: #9ca3af;
      }
      
      /* Page Break */
      .page-break {
        page-break-after: always;
      }
      
      /* Print Styles */
      @media print {
        body {
          font-size: 10pt;
          color: #000;
        }
        
        .report-container {
          max-width: none;
          padding: 0;
        }
        
        .report-section {
          page-break-inside: avoid;
        }
        
        .summary-cards {
          break-inside: avoid;
        }
        
        .data-table {
          page-break-inside: auto;
        }
        
        .data-table tr {
          page-break-inside: avoid;
        }
        
        .chart-container {
          page-break-inside: avoid;
        }
        
        .cover-page {
          page-break-after: always;
        }
        
        .table-of-contents {
          page-break-after: always;
        }
        
        .summary-card,
        .budget-item,
        .column {
          background: #f5f5f5 !important;
          -webkit-print-color-adjust: exact;
          print-color-adjust: exact;
        }
        
        .status-badge,
        .rag-indicator,
        .severity-badge {
          -webkit-print-color-adjust: exact;
          print-color-adjust: exact;
        }
        
        @page {
          size: A4;
          margin: 15mm;
        }
      }
    `}getDefaultStyles(){return this.getReportStyles()}}new ql;function $l({refreshTrigger:n}){const t=ke(),{projectId:e}=ye(),[r,a]=u.useState(!0),[i,o]=u.useState({total:0,approved:0,awaitingSignatures:0,awaitingCertificate:0,inProgress:0}),c=u.useCallback(async()=>{if(e){a(!0);try{const d=await Ke.getAll(e,{orderBy:{column:"milestone_ref",ascending:!0}}),h=d.map(E=>E.id);let m={};h.length>0&&(await Ys.getAll(e,{filters:[{column:"milestone_id",operator:"in",value:h}],select:"id, milestone_id, status"})||[]).forEach(S=>{m[S.milestone_id]||(m[S.milestone_id]=[]),m[S.milestone_id].push(S)});const p=await Ke.getCertificates(e),y={};p.forEach(E=>{y[E.milestone_id]=E});let b=0,g=0,_=0,v=0;d.forEach(E=>{const S=m[E.id]||[],x=S.length>0&&S.every(C=>C.status==="Delivered"),k=y[E.id];k&&k.status==="Signed"?b++:k?g++:x?_++:v++}),o({total:d.length,approved:b,awaitingSignatures:g,awaitingCertificate:_,inProgress:v})}catch{}finally{a(!1)}}},[e]);u.useEffect(()=>{c()},[c,n]);const l=()=>{t("/milestones")};return r?s.jsx(Xe,{rows:4}):s.jsxs("div",{className:"dashboard-widget",onClick:l,children:[s.jsxs("div",{className:"widget-header",children:[s.jsx("div",{className:"widget-icon",children:s.jsx(ar,{size:20})}),s.jsx("span",{className:"widget-title",children:"Milestones"}),s.jsxs("span",{className:"widget-total",children:[i.total," Total"]})]}),s.jsxs("div",{className:"widget-breakdown",children:[s.jsxs("div",{className:"widget-row",children:[s.jsx("div",{className:"widget-row-icon approved",children:s.jsx(We,{size:16})}),s.jsx("span",{className:"widget-row-label",children:"Approved (Signed)"}),s.jsx("span",{className:"widget-row-value",children:i.approved})]}),s.jsxs("div",{className:"widget-row",children:[s.jsx("div",{className:"widget-row-icon pending",children:s.jsx(_e,{size:16})}),s.jsx("span",{className:"widget-row-label",children:"Awaiting Signatures"}),s.jsx("span",{className:"widget-row-value",children:i.awaitingSignatures})]}),s.jsxs("div",{className:"widget-row",children:[s.jsx("div",{className:"widget-row-icon awaiting",children:s.jsx(Je,{size:16})}),s.jsx("span",{className:"widget-row-label",children:"Awaiting Certificate"}),s.jsx("span",{className:"widget-row-value",children:i.awaitingCertificate})]}),s.jsxs("div",{className:"widget-row",children:[s.jsx("div",{className:"widget-row-icon progress",children:s.jsx(zr,{size:16})}),s.jsx("span",{className:"widget-row-label",children:"In Progress"}),s.jsx("span",{className:"widget-row-value",children:i.inProgress})]})]})]})}function Wl({refreshTrigger:n}){const t=ke(),{projectId:e}=ye(),{showTestUsers:r}=ts(),[a,i]=u.useState(!0),[o,c]=u.useState({total:0,delivered:0,reviewComplete:0,awaitingReview:0,returned:0,inProgress:0,notStarted:0}),l=u.useCallback(async()=>{if(e){i(!0);try{const h=await Ys.getAllWithRelations(e,r);let m=0,p=0,y=0,b=0,g=0,_=0;h.forEach(v=>{switch(v.status){case"Delivered":m++;break;case"Review Complete":p++;break;case"Submitted for Review":y++;break;case"Returned for More Work":b++;break;case"In Progress":g++;break;case"Not Started":default:_++;break}}),c({total:h.length,delivered:m,reviewComplete:p,awaitingReview:y,returned:b,inProgress:g,notStarted:_})}catch{}finally{i(!1)}}},[e,r]);u.useEffect(()=>{l()},[l,n]);const d=()=>{t("/deliverables")};return a?s.jsx(Xe,{rows:6}):s.jsxs("div",{className:"dashboard-widget",onClick:d,children:[s.jsxs("div",{className:"widget-header",children:[s.jsx("div",{className:"widget-icon",style:{background:"rgba(34, 197, 94, 0.1)",color:"#22c55e"},children:s.jsx(St,{size:20})}),s.jsx("span",{className:"widget-title",children:"Deliverables"}),s.jsxs("span",{className:"widget-total",children:[o.total," Total"]})]}),s.jsxs("div",{className:"widget-breakdown",children:[s.jsxs("div",{className:"widget-row",children:[s.jsx("div",{className:"widget-row-icon approved",children:s.jsx(We,{size:16})}),s.jsx("span",{className:"widget-row-label",children:"Delivered"}),s.jsx("span",{className:"widget-row-value",children:o.delivered})]}),s.jsxs("div",{className:"widget-row",children:[s.jsx("div",{className:"widget-row-icon",style:{background:"rgba(37, 99, 235, 0.1)",color:"#2563eb"},children:s.jsx(Ba,{size:16})}),s.jsx("span",{className:"widget-row-label",children:"Review Complete"}),s.jsx("span",{className:"widget-row-value",children:o.reviewComplete})]}),s.jsxs("div",{className:"widget-row",children:[s.jsx("div",{className:"widget-row-icon pending",children:s.jsx(_e,{size:16})}),s.jsx("span",{className:"widget-row-label",children:"Awaiting Review"}),s.jsx("span",{className:"widget-row-value",children:o.awaitingReview})]}),s.jsxs("div",{className:"widget-row",children:[s.jsx("div",{className:"widget-row-icon",style:{background:"rgba(220, 38, 38, 0.1)",color:"#dc2626"},children:s.jsx(rr,{size:16})}),s.jsx("span",{className:"widget-row-label",children:"Returned"}),s.jsx("span",{className:"widget-row-value",children:o.returned})]}),s.jsxs("div",{className:"widget-row",children:[s.jsx("div",{className:"widget-row-icon",style:{background:"rgba(79, 70, 229, 0.1)",color:"#4f46e5"},children:s.jsx(Me,{size:16})}),s.jsx("span",{className:"widget-row-label",children:"In Progress"}),s.jsx("span",{className:"widget-row-value",children:o.inProgress})]}),s.jsxs("div",{className:"widget-row",children:[s.jsx("div",{className:"widget-row-icon progress",children:s.jsx(zr,{size:16})}),s.jsx("span",{className:"widget-row-label",children:"Not Started"}),s.jsx("span",{className:"widget-row-value",children:o.notStarted})]})]})]})}function Ul({refreshTrigger:n}){const t=ke(),{projectId:e}=ye(),[r,a]=u.useState(!0),[i,o]=u.useState({submittedCount:0,submittedValue:0,validatedCount:0,validatedValue:0}),c=u.useCallback(async()=>{if(e){a(!0);try{const p=(await Fs.getAll(e,{select:`
          id, hours_worked, hours, status, is_deleted,
          resources(id, sell_price)
        `})||[]).filter(v=>v.is_deleted!==!0);let y=0,b=0,g=0,_=0;p.forEach(v=>{const E=parseFloat(v.hours_worked||v.hours||0),S=v.resources?.sell_price||0,x=or(E,S);switch(v.status){case"Submitted":y++,b+=x;break;case"Validated":case"Approved":g++,_+=x;break}}),o({submittedCount:y,submittedValue:b,validatedCount:g,validatedValue:_})}catch{}finally{a(!1)}}},[e]);u.useEffect(()=>{c()},[c,n]);const l=()=>{t("/timesheets")},d=m=>`Â£${Math.round(m).toLocaleString()}`;if(r)return s.jsx(Xe,{rows:2});const h=i.submittedCount+i.validatedCount;return s.jsxs("div",{className:"dashboard-widget",onClick:l,children:[s.jsxs("div",{className:"widget-header",children:[s.jsx("div",{className:"widget-icon",style:{background:"rgba(59, 130, 246, 0.1)",color:"#3b82f6"},children:s.jsx(_e,{size:20})}),s.jsx("span",{className:"widget-title",children:"Timesheets"}),s.jsxs("span",{className:"widget-total",children:[h," Active"]})]}),s.jsxs("div",{className:"widget-breakdown",children:[s.jsxs("div",{className:"widget-row",children:[s.jsx("div",{className:"widget-row-icon pending",children:s.jsx($r,{size:16})}),s.jsx("span",{className:"widget-row-label",children:"Submitted"}),s.jsx("span",{className:"widget-row-value",children:i.submittedCount}),s.jsx("span",{className:"widget-row-secondary",children:d(i.submittedValue)})]}),s.jsxs("div",{className:"widget-row",children:[s.jsx("div",{className:"widget-row-icon approved",children:s.jsx(We,{size:16})}),s.jsx("span",{className:"widget-row-label",children:"Validated"}),s.jsx("span",{className:"widget-row-value",children:i.validatedCount}),s.jsx("span",{className:"widget-row-secondary",children:d(i.validatedValue)})]})]})]})}function Vl({refreshTrigger:n}){const t=ke(),{projectId:e}=ye(),[r,a]=u.useState(!0),[i,o]=u.useState({awaitingValue:0,validatedTotal:0,chargeableValue:0,nonChargeableValue:0}),c=u.useCallback(async()=>{if(e){a(!0);try{const m=(await Hs.getAll(e,{select:"id, amount, status, chargeable_to_customer, is_deleted"})||[]).filter(_=>_.is_deleted!==!0);let p=0,y=0,b=0,g=0;m.forEach(_=>{const v=parseFloat(_.amount||0);switch(_.status){case"Submitted":p+=v;break;case"Validated":case"Approved":y+=v,_.chargeable_to_customer!==!1?b+=v:g+=v;break}}),o({awaitingValue:p,validatedTotal:y,chargeableValue:b,nonChargeableValue:g})}catch{}finally{a(!1)}}},[e]);u.useEffect(()=>{c()},[c,n]);const l=()=>{t("/expenses")},d=h=>`Â£${Math.round(h).toLocaleString()}`;return r?s.jsx(Xe,{rows:4}):s.jsxs("div",{className:"dashboard-widget",onClick:l,children:[s.jsxs("div",{className:"widget-header",children:[s.jsx("div",{className:"widget-icon",style:{background:"rgba(168, 85, 247, 0.1)",color:"#a855f7"},children:s.jsx(mt,{size:20})}),s.jsx("span",{className:"widget-title",children:"Expenses"}),s.jsxs("span",{className:"widget-total",children:[d(i.validatedTotal)," Validated"]})]}),s.jsxs("div",{className:"widget-breakdown",children:[s.jsxs("div",{className:"widget-row",children:[s.jsx("div",{className:"widget-row-icon pending",children:s.jsx(_e,{size:16})}),s.jsx("span",{className:"widget-row-label",children:"Awaiting Validation"}),s.jsx("span",{className:"widget-row-value",children:d(i.awaitingValue)})]}),s.jsxs("div",{className:"widget-row",children:[s.jsx("div",{className:"widget-row-icon approved",children:s.jsx(We,{size:16})}),s.jsx("span",{className:"widget-row-label",children:"Validated Total"}),s.jsx("span",{className:"widget-row-value",children:d(i.validatedTotal)})]}),s.jsxs("div",{className:"widget-row",style:{paddingLeft:"1.5rem"},children:[s.jsx("div",{className:"widget-row-icon",style:{background:"rgba(34, 197, 94, 0.1)",color:"#22c55e"},children:s.jsx(qa,{size:16})}),s.jsx("span",{className:"widget-row-label",children:"â†³ Chargeable"}),s.jsx("span",{className:"widget-row-value",children:d(i.chargeableValue)})]}),s.jsxs("div",{className:"widget-row",style:{paddingLeft:"1.5rem"},children:[s.jsx("div",{className:"widget-row-icon",style:{background:"rgba(107, 114, 128, 0.1)",color:"#6b7280"},children:s.jsx(er,{size:16})}),s.jsx("span",{className:"widget-row-label",children:"â†³ Non-Chargeable"}),s.jsx("span",{className:"widget-row-value",children:d(i.nonChargeableValue)})]})]})]})}function zl(){const{user:n}=Ee();let t="viewer",e="viewer",r=!1;try{const l=Dt();t=l.effectiveRole||"viewer",e=l.actualRole||"viewer",r=l.isImpersonating||!1}catch{const d=Ee();t=d.role||"viewer",e=d.role||"viewer"}const a=n?.id||null,i=t,o=(l,d)=>D(i,l,d);return{userRole:i,actualRole:e,isImpersonating:r,currentUserId:a,can:o,hasPermission:o,PERMISSION_MATRIX:Jr,canAddTimesheet:ds(i),canAddTimesheetForOthers:lr(i),canApproveTimesheets:yt(i),canApproveTimesheet:yt(i),canAddExpense:Jt(i),canAddExpenseForOthers:us(i),canValidateChargeableExpenses:ms(i),canValidateNonChargeableExpenses:hs(i),canCreateMilestone:ps(i),canEditMilestone:fs(i),canDeleteMilestone:gs(i),canUseGantt:ys(i),canEditBilling:gi(i),canCreateDeliverable:bs(i),canEditDeliverable:ws(i),canDeleteDeliverable:vs(i),canReviewDeliverable:xs(i),canSubmitDeliverable:yi(i),canManageKPIs:_s(i),canAddKPI:wi(i),canEditKPI:vi(i),canDeleteKPI:xi(i),canManageQualityStandards:Ss(i),canAddQualityStandard:_i(i),canEditQualityStandard:Si(i),canDeleteQualityStandard:ji(i),canManageResources:js(i),canAddResource:Ci(i),canEditResource:Ei(i),canDeleteResource:Cs(i),canSeeCostPrice:Es(i),canSeeResourceType:ki(i),canSeeMargins:ks(i),canViewPartners:Rs(i),canManagePartners:As(i),canAddPartner:Ri(i),canEditPartner:Ai(i),canDeletePartner:Ti(i),canCreateVariation:Di(i),canEditVariation:Pi(i),canDeleteVariation:Mi(i),canSubmitVariation:Ni(i),canSignVariationAsSupplier:Ii(i),canSignVariationAsCustomer:Oi(i),canRejectVariation:Li(i),canSignAsSupplier:Ts(i),canSignAsCustomer:Ds(i),canCreateCertificate:Bi(i),canAccessSettings:Ps(i),canEditSettings:qi(i),canManageUsers:Ms(i),canViewUsers:$i(i),canViewWorkflowSummary:Ns(i),canGenerateCustomerInvoice:Is(i),canGenerateThirdPartyInvoice:Os(i),canViewMarginReports:Wi(i),canAccessReports:Ui(i),canEditTimesheet:l=>di(i,l,a),canDeleteTimesheet:l=>ui(i,l,a),canSubmitTimesheet:l=>mi(i,l,a),canValidateTimesheet:l=>l.status!=="Submitted"?!1:yt(i),canSubmitExpense:l=>l.status!=="Draft"&&l.status!=="Rejected"?!1:Xt(i,[w.ADMIN,w.SUPPLIER_PM])?!0:l.created_by===a&&Jt(i),canValidateExpense:l=>hi(i,l),canEditExpense:l=>pi(i,l,a),canDeleteExpense:l=>fi(i,l,a),canUpdateDeliverableStatus:l=>bi(i,l,a),getAvailableResources:l=>Ls(i,l,a),getCurrentUserResource:l=>Vi(l,a),getDefaultResource:l=>Bs(i,l,a),getDefaultResourceId:l=>zi(i,l,a),getPermissionSummary:()=>Fi(i),getRoleConfig:()=>qs(i),getRoleLabel:()=>$s(i),ROLES:w,ROLE_OPTIONS:_n,hasRole:l=>Xt(i,l),isFullAdmin:ci(i)}}function Fl({editable:n=!1,fullPage:t=!1,refreshTrigger:e}){const r=ke(),{projectId:a}=ye(),{canEditBilling:i}=zl(),{showSuccess:o,showError:c}=ns(),l=n&&i,[d,h]=u.useState(!0),[m,p]=u.useState([]),[y,b]=u.useState(null),[g,_]=u.useState(""),v=u.useCallback(async()=>{if(a){h(!0);try{const j=await Ke.getBillableMilestones(a);p(j||[])}catch{}finally{h(!1)}}},[a]);u.useEffect(()=>{v()},[v,e]);const E=j=>{!t&&!j.target.closest("button, input, a")&&r("/billing")},S=async(j,A)=>{if(l)try{const U=!j[A];await Ke.update(j.id,{[A]:U}),p(ae=>ae.map(ee=>ee.id===j.id?{...ee,[A]:U}:ee)),o(`${A==="is_billed"?"Billed":"Received"} status updated`)}catch{c("Failed to update status")}},x=j=>{l&&(b(j.id),_(j.purchase_order||""))},k=async j=>{try{await Ke.update(j.id,{purchase_order:g}),p(A=>A.map(U=>U.id===j.id?{...U,purchase_order:g}:U)),b(null),o("PO number updated")}catch{c("Failed to update PO number")}},C=j=>new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP",minimumFractionDigits:0,maximumFractionDigits:0}).format(j),R=j=>j?new Date(j).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"}):"â€”",M=m.reduce((j,A)=>j+(A.billable||0),0),T=m.filter(j=>j.is_billed).reduce((j,A)=>j+(A.billable||0),0),I=m.filter(j=>j.is_received).reduce((j,A)=>j+(A.billable||0),0);return d?s.jsx(ct,{}):s.jsxs("div",{className:"dashboard-widget billing-widget",style:{cursor:t?"default":"pointer"},onClick:E,children:[s.jsxs("div",{className:"widget-header",children:[s.jsx("div",{className:"widget-icon",style:{backgroundColor:"#dcfce7",color:"#16a34a"},children:s.jsx(sr,{size:20})}),s.jsx("span",{className:"widget-title",children:"Billing"}),s.jsxs("span",{className:"widget-total",children:[C(M)," Total"]})]}),s.jsxs("div",{style:{display:"flex",gap:"1.5rem",padding:"0.75rem 1rem",backgroundColor:"#f8fafc",borderRadius:"8px",marginBottom:"0.75rem",fontSize:"0.875rem"},children:[s.jsxs("div",{children:[s.jsx("span",{style:{color:"#64748b"},children:"Billed: "}),s.jsx("span",{style:{fontWeight:"600",color:"#16a34a"},children:C(T)})]}),s.jsxs("div",{children:[s.jsx("span",{style:{color:"#64748b"},children:"Received: "}),s.jsx("span",{style:{fontWeight:"600",color:"#2563eb"},children:C(I)})]}),s.jsxs("div",{children:[s.jsx("span",{style:{color:"#64748b"},children:"Outstanding: "}),s.jsx("span",{style:{fontWeight:"600",color:"#dc2626"},children:C(M-I)})]})]}),s.jsx("div",{style:{overflowX:"auto"},children:s.jsxs("table",{style:{width:"100%",fontSize:"0.8125rem",borderCollapse:"collapse"},children:[s.jsx("thead",{children:s.jsxs("tr",{style:{borderBottom:"1px solid #e2e8f0"},children:[s.jsx("th",{style:{textAlign:"left",padding:"0.5rem 0.25rem",fontWeight:"600",color:"#64748b"},children:"Milestone"}),s.jsx("th",{style:{textAlign:"right",padding:"0.5rem 0.25rem",fontWeight:"600",color:"#64748b"},children:"Amount"}),s.jsx("th",{style:{textAlign:"center",padding:"0.5rem 0.25rem",fontWeight:"600",color:"#64748b"},children:"Expected"}),s.jsx("th",{style:{textAlign:"center",padding:"0.5rem 0.25rem",fontWeight:"600",color:"#64748b"},children:"Ready"}),s.jsx("th",{style:{textAlign:"center",padding:"0.5rem 0.25rem",fontWeight:"600",color:"#64748b"},children:"Billed"}),s.jsx("th",{style:{textAlign:"center",padding:"0.5rem 0.25rem",fontWeight:"600",color:"#64748b"},children:"Received"}),s.jsx("th",{style:{textAlign:"left",padding:"0.5rem 0.25rem",fontWeight:"600",color:"#64748b"},children:"PO Number"})]})}),s.jsx("tbody",{children:m.map(j=>s.jsxs("tr",{style:{borderBottom:"1px solid #f1f5f9",backgroundColor:j.is_received?"#f0fdf4":"transparent"},children:[s.jsxs("td",{style:{padding:"0.625rem 0.25rem"},children:[t?s.jsx(Ft,{to:`/milestones/${j.id}`,style:{textDecoration:"none"},onClick:A=>A.stopPropagation(),children:s.jsx("div",{style:{fontWeight:"500",color:"#3b82f6"},children:j.milestone_ref})}):s.jsx("div",{style:{fontWeight:"500"},children:j.milestone_ref}),s.jsx("div",{style:{fontSize:"0.75rem",color:"#64748b",maxWidth:"200px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:j.name})]}),s.jsx("td",{style:{textAlign:"right",padding:"0.625rem 0.25rem",fontWeight:"600"},children:C(j.billable)}),s.jsx("td",{style:{textAlign:"center",padding:"0.625rem 0.25rem",color:"#64748b"},children:s.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"0.25rem"},children:[s.jsx(ft,{size:12}),R(j.expected_date)]})}),s.jsx("td",{style:{textAlign:"center",padding:"0.625rem 0.25rem"},children:s.jsxs("div",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.125rem 0.5rem",borderRadius:"4px",fontSize:"0.75rem",fontWeight:"600",backgroundColor:j.ready_to_bill?"#dcfce7":"#fef3c7",color:j.ready_to_bill?"#16a34a":"#d97706"},title:j.certificate_status||"No certificate",children:[s.jsx(Ve,{size:12}),j.ready_to_bill?"Yes":"No"]})}),s.jsx("td",{style:{textAlign:"center",padding:"0.625rem 0.25rem"},children:s.jsx("button",{onClick:A=>{A.stopPropagation(),S(j,"is_billed")},disabled:!l,style:{width:"28px",height:"28px",borderRadius:"6px",border:"none",cursor:l?"pointer":"default",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:j.is_billed?"#dcfce7":"#f1f5f9",color:j.is_billed?"#16a34a":"#94a3b8"},children:j.is_billed?s.jsx(Ue,{size:16}):s.jsx(be,{size:16})})}),s.jsx("td",{style:{textAlign:"center",padding:"0.625rem 0.25rem"},children:s.jsx("button",{onClick:A=>{A.stopPropagation(),S(j,"is_received")},disabled:!l,style:{width:"28px",height:"28px",borderRadius:"6px",border:"none",cursor:l?"pointer":"default",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:j.is_received?"#dbeafe":"#f1f5f9",color:j.is_received?"#2563eb":"#94a3b8"},children:j.is_received?s.jsx(Ue,{size:16}):s.jsx(be,{size:16})})}),s.jsx("td",{style:{padding:"0.625rem 0.25rem"},children:y===j.id?s.jsxs("div",{style:{display:"flex",gap:"0.25rem"},onClick:A=>A.stopPropagation(),children:[s.jsx("input",{type:"text",value:g,onChange:A=>_(A.target.value),onKeyDown:A=>A.key==="Enter"&&k(j),style:{width:"100px",padding:"0.25rem 0.5rem",fontSize:"0.75rem",border:"1px solid #e2e8f0",borderRadius:"4px"},autoFocus:!0}),s.jsx("button",{onClick:()=>k(j),style:{padding:"0.25rem 0.5rem",fontSize:"0.75rem",backgroundColor:"#16a34a",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:"Save"})]}):s.jsxs("div",{onClick:A=>{A.stopPropagation(),l&&x(j)},style:{padding:"0.25rem 0.5rem",fontSize:"0.75rem",color:j.purchase_order?"#1e293b":"#94a3b8",cursor:l?"pointer":"default",borderRadius:"4px",backgroundColor:l?"#f8fafc":"transparent",display:"flex",alignItems:"center",gap:"0.25rem"},children:[s.jsx(Je,{size:12}),j.purchase_order||(l?"Add PO":"â€”")]})})]},j.id))})]})}),m.length===0&&s.jsx("div",{style:{textAlign:"center",padding:"2rem",color:"#64748b"},children:"No billable milestones found"})]})}function Hl({refreshTrigger:n}){const{projectId:t}=ye(),[e,r]=u.useState(!0),[a,i]=u.useState({totalBillable:0,timesheetsPending:0,timesheetsValidated:0,timesheetsTotal:0,gap:0,expensesPendingChargeable:0,expensesPendingNonChargeable:0,expensesValidatedChargeable:0,expensesValidatedNonChargeable:0,expensesTotalPending:0,expensesTotalValidated:0,expensesTotalChargeable:0,expensesTotalNonChargeable:0,pmoTimesheets:0,pmoPercentage:0}),o=u.useCallback(async()=>{if(t){r(!0);try{const h=(await Ke.getAll(t,{select:"id, billable"})||[]).reduce((T,I)=>T+(parseFloat(I.billable)||0),0),p=(await Fs.getAll(t,{select:`
          id, hours_worked, hours, status, is_deleted,
          resources(id, sell_price, role)
        `})||[]).filter(T=>T.is_deleted!==!0);let y=0,b=0,g=0;p.forEach(T=>{const I=parseFloat(T.hours_worked||T.hours||0),j=T.resources?.sell_price||0,A=or(I,j),U=lt(T.resources?.role);switch(T.status){case"Submitted":y+=A,U&&(g+=A);break;case"Validated":case"Approved":b+=A,U&&(g+=A);break}});const _=y+b,v=h-_,E=_>0?g/_*100:0,x=(await Hs.getAll(t,{select:"id, amount, status, chargeable_to_customer, is_deleted"})||[]).filter(T=>T.is_deleted!==!0);let k=0,C=0,R=0,M=0;x.forEach(T=>{const I=parseFloat(T.amount||0),j=T.chargeable_to_customer!==!1;switch(T.status){case"Submitted":j?k+=I:C+=I;break;case"Validated":case"Approved":j?R+=I:M+=I;break}}),i({totalBillable:h,timesheetsPending:y,timesheetsValidated:b,timesheetsTotal:_,gap:v,expensesPendingChargeable:k,expensesPendingNonChargeable:C,expensesValidatedChargeable:R,expensesValidatedNonChargeable:M,expensesTotalPending:k+C,expensesTotalValidated:R+M,expensesTotalChargeable:k+R,expensesTotalNonChargeable:C+M,pmoTimesheets:g,pmoPercentage:E})}catch{}finally{r(!1)}}},[t]);u.useEffect(()=>{o()},[o,n]);const c=d=>{const m=`Â£${Math.abs(Math.round(d)).toLocaleString()}`;return d<0?`-${m}`:m};if(e)return s.jsx(ct,{});const l=a.gap<0;return s.jsxs("div",{className:"dashboard-widget finance-widget",children:[s.jsxs("div",{className:"widget-header",children:[s.jsx("div",{className:"widget-icon",style:{background:"rgba(16, 185, 129, 0.1)",color:"#10b981"},children:s.jsx(sr,{size:20})}),s.jsx("span",{className:"widget-title",children:"Finance"})]}),s.jsxs("div",{className:"finance-content",children:[s.jsx("div",{className:"finance-section finance-billable",children:s.jsxs("div",{className:"finance-row finance-row-large",children:[s.jsx("span",{className:"finance-label",children:"Total Billable"}),s.jsx("span",{className:"finance-value",children:c(a.totalBillable)})]})}),s.jsxs("div",{className:"finance-section",children:[s.jsx("div",{className:"finance-section-header",children:"Timesheets"}),s.jsxs("div",{className:"finance-row",children:[s.jsx(_e,{size:14,className:"finance-icon pending"}),s.jsx("span",{className:"finance-label",children:"Pending Validation"}),s.jsx("span",{className:"finance-value",children:c(a.timesheetsPending)})]}),s.jsxs("div",{className:"finance-row",children:[s.jsx(We,{size:14,className:"finance-icon approved"}),s.jsx("span",{className:"finance-label",children:"Validated"}),s.jsx("span",{className:"finance-value",children:c(a.timesheetsValidated)})]}),s.jsxs("div",{className:"finance-row finance-row-total",children:[s.jsx("span",{className:"finance-label",children:"Total"}),s.jsx("span",{className:"finance-value",children:c(a.timesheetsTotal)})]}),s.jsxs("div",{className:`finance-row finance-row-gap ${l?"negative":"positive"}`,children:[l?s.jsx($a,{size:14,className:"finance-icon"}):s.jsx(dt,{size:14,className:"finance-icon"}),s.jsx("span",{className:"finance-label",children:"Gap vs Billable"}),s.jsx("span",{className:"finance-value",children:c(a.gap)})]})]}),s.jsxs("div",{className:"finance-section",children:[s.jsx("div",{className:"finance-section-header",children:"Expenses"}),s.jsxs("div",{className:"finance-expenses-grid",children:[s.jsx("div",{className:"finance-expenses-header"}),s.jsx("div",{className:"finance-expenses-header",children:"Chargeable"}),s.jsx("div",{className:"finance-expenses-header",children:"Non-Chg"}),s.jsx("div",{className:"finance-expenses-header",children:"Total"}),s.jsxs("div",{className:"finance-expenses-label",children:[s.jsx(_e,{size:12,className:"finance-icon pending"}),"Pending"]}),s.jsx("div",{className:"finance-expenses-value",children:c(a.expensesPendingChargeable)}),s.jsx("div",{className:"finance-expenses-value",children:c(a.expensesPendingNonChargeable)}),s.jsx("div",{className:"finance-expenses-value finance-expenses-total",children:c(a.expensesTotalPending)}),s.jsxs("div",{className:"finance-expenses-label",children:[s.jsx(We,{size:12,className:"finance-icon approved"}),"Validated"]}),s.jsx("div",{className:"finance-expenses-value",children:c(a.expensesValidatedChargeable)}),s.jsx("div",{className:"finance-expenses-value",children:c(a.expensesValidatedNonChargeable)}),s.jsx("div",{className:"finance-expenses-value finance-expenses-total",children:c(a.expensesTotalValidated)}),s.jsx("div",{className:"finance-expenses-label finance-expenses-total-label",children:"Total"}),s.jsx("div",{className:"finance-expenses-value finance-expenses-total",children:c(a.expensesTotalChargeable)}),s.jsx("div",{className:"finance-expenses-value finance-expenses-total",children:c(a.expensesTotalNonChargeable)}),s.jsx("div",{className:"finance-expenses-value finance-expenses-grand-total",children:c(a.expensesTotalChargeable+a.expensesTotalNonChargeable)})]})]}),s.jsxs("div",{className:"finance-section",children:[s.jsx("div",{className:"finance-section-header",children:"PMO Overhead"}),s.jsxs("div",{className:"finance-row",children:[s.jsx("span",{className:"finance-label",children:"PMO Timesheets"}),s.jsx("span",{className:"finance-value",children:c(a.pmoTimesheets)})]}),s.jsxs("div",{className:"finance-row",children:[s.jsx("span",{className:"finance-label",children:"% of Total Timesheets"}),s.jsxs("span",{className:"finance-value",children:[a.pmoPercentage.toFixed(1),"%"]})]}),s.jsx("div",{className:"finance-pmo-bar",children:s.jsx("div",{className:"finance-pmo-bar-fill",style:{width:`${Math.min(a.pmoPercentage,100)}%`}})})]})]})]})}function Yl({refreshTrigger:n}){const t=ke(),{projectId:e}=ye(),[r,a]=u.useState(!0),[i,o]=u.useState([]),c=u.useCallback(async()=>{if(e){a(!0);try{const l=await So.getAll(e,{orderBy:{column:"kpi_ref",ascending:!0}}),{data:d}=await f.from("deliverables").select(`
          id, status, is_deleted,
          deliverable_kpis(kpi_id)
        `).eq("project_id",e).or("is_deleted.is.null,is_deleted.eq.false"),{data:h}=await f.from("deliverable_kpi_assessments").select("kpi_id, deliverable_id, criteria_met"),m={};(h||[]).forEach(y=>{const b=`${y.deliverable_id}-${y.kpi_id}`;m[b]=y.criteria_met});const p=l.map(y=>{const b=(d||[]).filter(C=>C.deliverable_kpis?.some(R=>R.kpi_id===y.id)),g=b.length,_=b.filter(C=>C.status==="Submitted for Review").length,v=b.filter(C=>C.status==="Delivered").length;let E=0,S=0;b.filter(C=>C.status==="Delivered").forEach(C=>{const R=`${C.id}-${y.id}`;m[R]===!0?E++:m[R]===!1&&S++});const x=E+S,k=x>0?Math.round(E/x*100):null;return{id:y.id,ref:y.kpi_ref,name:y.name,total:g,submitted:_,validated:v,passed:E,failed:S,passRate:k}});o(p)}catch{}finally{a(!1)}}},[e]);return u.useEffect(()=>{c()},[c,n]),r?s.jsxs("div",{className:"metrics-cards-row",children:[s.jsxs("div",{className:"metrics-cards-header",children:[s.jsx(dt,{size:18}),s.jsx("span",{children:"KPI Metrics"})]}),s.jsx("div",{className:"metrics-cards-container",children:[1,2,3,4,5].map(l=>s.jsx(ir,{},l))})]}):i.length===0?null:s.jsxs("div",{className:"metrics-cards-row",children:[s.jsxs("div",{className:"metrics-cards-header",children:[s.jsx(dt,{size:18}),s.jsx("span",{children:"KPI Metrics"})]}),s.jsx("div",{className:"metrics-cards-container",children:i.map(l=>s.jsxs("div",{className:"metrics-card kpi-card",onClick:()=>t(`/kpis/${l.id}`),children:[s.jsxs("div",{className:"metrics-card-header",children:[s.jsx("span",{className:"metrics-card-ref",children:l.ref}),s.jsx("span",{className:"metrics-card-name",title:l.name,children:l.name})]}),s.jsxs("div",{className:"metrics-card-stats",children:[s.jsxs("div",{className:"metrics-stat",children:[s.jsx("span",{className:"metrics-stat-value",children:l.total}),s.jsx("span",{className:"metrics-stat-label",children:"Deliverables"})]}),s.jsxs("div",{className:"metrics-stat",children:[s.jsx("span",{className:"metrics-stat-value",children:l.submitted}),s.jsx("span",{className:"metrics-stat-label",children:"Submitted"})]}),s.jsxs("div",{className:"metrics-stat",children:[s.jsx("span",{className:"metrics-stat-value",children:l.validated}),s.jsx("span",{className:"metrics-stat-label",children:"Validated"})]})]}),s.jsx("div",{className:"metrics-card-passrate",children:l.passRate!==null?s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"passrate-bar",style:{background:`linear-gradient(to right, #16a34a ${l.passRate}%, #dc2626 ${l.passRate}%)`}}),s.jsxs("div",{className:"passrate-values",children:[s.jsxs("span",{className:"passrate-pass",children:[l.passed," Yes"]}),s.jsxs("span",{className:"passrate-percent",children:[l.passRate,"%"]}),s.jsxs("span",{className:"passrate-fail",children:[l.failed," No"]})]})]}):s.jsx("div",{className:"passrate-none",children:"No assessments yet"})})]},l.id))})]})}function Gl({refreshTrigger:n}){const t=ke(),{projectId:e}=ye(),[r,a]=u.useState(!0),[i,o]=u.useState([]),c=u.useCallback(async()=>{if(e){a(!0);try{const l=await Co.getAll(e,{orderBy:{column:"qs_ref",ascending:!0}}),{data:d}=await f.from("deliverables").select(`
          id, status, is_deleted,
          deliverable_quality_standards(quality_standard_id)
        `).eq("project_id",e).or("is_deleted.is.null,is_deleted.eq.false"),{data:h}=await f.from("deliverable_qs_assessments").select("quality_standard_id, deliverable_id, criteria_met"),m={};(h||[]).forEach(y=>{const b=`${y.deliverable_id}-${y.quality_standard_id}`;m[b]=y.criteria_met});const p=l.map(y=>{const b=(d||[]).filter(C=>C.deliverable_quality_standards?.some(R=>R.quality_standard_id===y.id)),g=b.length,_=b.filter(C=>C.status==="Submitted for Review").length,v=b.filter(C=>C.status==="Delivered").length;let E=0,S=0;b.filter(C=>C.status==="Delivered").forEach(C=>{const R=`${C.id}-${y.id}`;m[R]===!0?E++:m[R]===!1&&S++});const x=E+S,k=x>0?Math.round(E/x*100):null;return{id:y.id,ref:y.qs_ref,name:y.name,total:g,submitted:_,validated:v,passed:E,failed:S,passRate:k}});o(p)}catch{}finally{a(!1)}}},[e]);return u.useEffect(()=>{c()},[c,n]),r?s.jsxs("div",{className:"metrics-cards-row",children:[s.jsxs("div",{className:"metrics-cards-header",children:[s.jsx(Ve,{size:18}),s.jsx("span",{children:"Quality Standards Metrics"})]}),s.jsx("div",{className:"metrics-cards-container",children:[1,2,3,4,5].map(l=>s.jsx(ir,{},l))})]}):i.length===0?null:s.jsxs("div",{className:"metrics-cards-row",children:[s.jsxs("div",{className:"metrics-cards-header",children:[s.jsx(Ve,{size:18}),s.jsx("span",{children:"Quality Standards Metrics"})]}),s.jsx("div",{className:"metrics-cards-container",children:i.map(l=>s.jsxs("div",{className:"metrics-card qs-card",onClick:()=>t(`/quality-standards/${l.id}`),children:[s.jsxs("div",{className:"metrics-card-header",children:[s.jsx("span",{className:"metrics-card-ref",children:l.ref}),s.jsx("span",{className:"metrics-card-name",title:l.name,children:l.name})]}),s.jsxs("div",{className:"metrics-card-stats",children:[s.jsxs("div",{className:"metrics-stat",children:[s.jsx("span",{className:"metrics-stat-value",children:l.total}),s.jsx("span",{className:"metrics-stat-label",children:"Deliverables"})]}),s.jsxs("div",{className:"metrics-stat",children:[s.jsx("span",{className:"metrics-stat-value",children:l.submitted}),s.jsx("span",{className:"metrics-stat-label",children:"Submitted"})]}),s.jsxs("div",{className:"metrics-stat",children:[s.jsx("span",{className:"metrics-stat-value",children:l.validated}),s.jsx("span",{className:"metrics-stat-label",children:"Validated"})]})]}),s.jsx("div",{className:"metrics-card-passrate",children:l.passRate!==null?s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"passrate-bar",style:{background:`linear-gradient(to right, #16a34a ${l.passRate}%, #dc2626 ${l.passRate}%)`}}),s.jsxs("div",{className:"passrate-values",children:[s.jsxs("span",{className:"passrate-pass",children:[l.passed," Yes"]}),s.jsxs("span",{className:"passrate-percent",children:[l.passRate,"%"]}),s.jsxs("span",{className:"passrate-fail",children:[l.failed," No"]})]})]}):s.jsx("div",{className:"passrate-none",children:"No assessments yet"})})]},l.id))})]})}function Kl(){const{projectName:n,projectRef:t}=ye(),{user:e}=Ee(),[r,a]=u.useState(0),[i,o]=u.useState(!1),c=()=>{const d=new Date().getHours();return d<12?"Good morning":d<18?"Good afternoon":"Good evening"},l=u.useCallback(()=>{o(!0),a(d=>d+1),setTimeout(()=>o(!1),1e3)},[]);return s.jsxs("div",{className:"dashboard",children:[s.jsx("div",{className:"dashboard-header",children:s.jsxs("div",{className:"dashboard-header-content",children:[s.jsxs("div",{children:[s.jsx("h1",{className:"dashboard-title",children:c()}),s.jsxs("p",{className:"dashboard-subtitle",children:[t," â€¢ ",n]})]}),s.jsxs("button",{className:"dashboard-refresh-btn",onClick:l,disabled:i,title:"Refresh all data",children:[s.jsx(Me,{size:18,className:i?"spinning":""}),"Refresh"]})]})}),s.jsxs("div",{className:"dashboard-content",children:[s.jsxs("div",{className:"dashboard-widgets",children:[s.jsx($l,{refreshTrigger:r}),s.jsx(Wl,{refreshTrigger:r}),s.jsx(Ul,{refreshTrigger:r}),s.jsx(Vl,{refreshTrigger:r})]}),s.jsx(Yl,{refreshTrigger:r}),s.jsx(Gl,{refreshTrigger:r}),s.jsxs("div",{className:"dashboard-widgets-row",children:[s.jsx(Fl,{editable:!1,refreshTrigger:r}),s.jsx(Hl,{refreshTrigger:r})]})]})]})}const Ql=u.lazy(()=>X(()=>import("./ResetPassword-B215VcLd.js"),__vite__mapDeps([0,1,2,3]))),Xl=u.lazy(()=>X(()=>import("./MobileChat-DIfs3btc.js"),__vite__mapDeps([4,1,2,3,5]))),Jl=u.lazy(()=>X(()=>import("./Milestones-BwBqUi2d.js"),__vite__mapDeps([6,1,7,2,8,9,10,3,11]))),Zl=u.lazy(()=>X(()=>import("./MilestoneDetail-DCo1s97Q.js"),__vite__mapDeps([12,1,7,2,13,8,9,10,3,14]))),ec=u.lazy(()=>X(()=>import("./Gantt-BcTpt6T-.js"),__vite__mapDeps([15,1,2,3]))),tc=u.lazy(()=>X(()=>import("./Deliverables-DEmSmvd_.js"),__vite__mapDeps([16,1,10,2,7,8,13,3,17]))),rc=u.lazy(()=>X(()=>import("./Resources-bmKIikKg.js"),__vite__mapDeps([18,1,19,2,7,3,20]))),sc=u.lazy(()=>X(()=>import("./ResourceDetail-DlRPSAmv.js"),__vite__mapDeps([21,1,19,2,22,23,3]))),ac=u.lazy(()=>X(()=>import("./Partners-D0iBZAYI.js"),__vite__mapDeps([24,1,2,3,25]))),nc=u.lazy(()=>X(()=>import("./PartnerDetail-5SNtC8vI.js"),__vite__mapDeps([26,1,22,2,23,3]))),ic=u.lazy(()=>X(()=>import("./Timesheets-gQ93gjEK.js"),__vite__mapDeps([27,1,7,2,28,22,3,29]))),oc=u.lazy(()=>X(()=>import("./Expenses-CdNu6wWI.js"),__vite__mapDeps([30,1,7,2,28,3,31]))),lc=u.lazy(()=>X(()=>import("./KPIs-DjDSS_OL.js"),__vite__mapDeps([32,1,7,2,3,33]))),cc=u.lazy(()=>X(()=>import("./KPIDetail-BvZx_JQl.js"),__vite__mapDeps([34,1,2,3]))),dc=u.lazy(()=>X(()=>import("./QualityStandards-Big5QTZZ.js"),__vite__mapDeps([35,1,7,2,3,36]))),uc=u.lazy(()=>X(()=>import("./QualityStandardDetail-CPyIeTqJ.js"),__vite__mapDeps([37,1,2,3]))),mc=u.lazy(()=>X(()=>import("./RaidLog-CKA-G02n.js"),__vite__mapDeps([38,1,7,2,3,39]))),hc=u.lazy(()=>X(()=>import("./Reports-Dg_48irU.js"),__vite__mapDeps([40,2,1,3]))),pc=u.lazy(()=>X(()=>import("./Billing-8gIitAbb.js"),__vite__mapDeps([41,1,42,2,3]))),fc=u.lazy(()=>X(()=>import("./Users-A2064qKa.js"),__vite__mapDeps([43,1,7,2,3,44]))),gc=u.lazy(()=>X(()=>import("./Settings-BKz6uizZ.js"),__vite__mapDeps([45,1,42,2,3]))),yc=u.lazy(()=>X(()=>import("./AccountSettings-BsBeCrG3.js"),__vite__mapDeps([46,1,42,2,3]))),bc=u.lazy(()=>X(()=>import("./WorkflowSummary-B5-B3-Ag.js"),__vite__mapDeps([47,1,23,42,2,3]))),wc=u.lazy(()=>X(()=>import("./AuditLog-BgjvO8T9.js"),__vite__mapDeps([48,1,42,2,3]))),vc=u.lazy(()=>X(()=>import("./DeletedItems-jwwOsCNd.js"),__vite__mapDeps([49,1,42,7,2,3]))),xc=u.lazy(()=>X(()=>import("./Calendar-B4n8SQQ4.js"),__vite__mapDeps([50,1,2,3,51]))),_c=u.lazy(()=>X(()=>import("./Variations-BwwwVu6V.js"),__vite__mapDeps([52,1,7,2,8,3,53]))),Sc=u.lazy(()=>X(()=>import("./VariationDetail-CtR8Ki6X.js"),__vite__mapDeps([54,1,7,2,8,10,22,3,55]))),Or=u.lazy(()=>X(()=>import("./VariationForm-CwvEmUJS.js"),__vite__mapDeps([56,1,8,2,3,57])));function jc(){return s.jsx("div",{className:"page-container",children:s.jsx(qe,{type:"page"})})}function K({children:n}){const{user:t,isLoading:e,mustChangePassword:r,clearMustChangePassword:a,profile:i}=Ee();return e?s.jsx(Ct,{message:"Loading...",size:"large",fullPage:!0}):t?r?s.jsx(to,{userEmail:t?.email,onSuccess:a}):s.jsx(Zi,{children:s.jsx(u.Suspense,{fallback:s.jsx(jc,{}),children:n||s.jsx(aa,{})})}):s.jsx(_t,{to:"/login",replace:!0})}function Cc(){const{user:n,isLoading:t}=Ee();return t?s.jsx(Ct,{message:"Loading...",size:"large",fullPage:!0}):n?s.jsx(u.Suspense,{fallback:s.jsx(Ct,{message:"Loading chat...",size:"large",fullPage:!0}),children:s.jsx(Xl,{})}):s.jsx(_t,{to:"/login",replace:!0})}function Ec(){return s.jsx(ra,{children:s.jsx(Mn,{children:s.jsx(Wn,{children:s.jsx(wn,{children:s.jsx(vn,{children:s.jsx(jn,{children:s.jsx(Cn,{children:s.jsx(Fn,{children:s.jsx(kn,{children:s.jsx(Dn,{children:s.jsxs(Yn,{children:[s.jsxs(sa,{children:[s.jsx(z,{path:"/login",element:s.jsx(ro,{})}),s.jsx(z,{path:"/reset-password",element:s.jsx(u.Suspense,{fallback:s.jsx(Ct,{fullPage:!0}),children:s.jsx(Ql,{})})}),s.jsx(z,{path:"/chat",element:s.jsx(Cc,{})}),s.jsx(z,{path:"/",element:s.jsx(_t,{to:"/dashboard",replace:!0})}),s.jsx(z,{path:"/dashboard",element:s.jsx(K,{children:s.jsx(Kl,{})})}),s.jsx(z,{path:"/milestones",element:s.jsx(K,{children:s.jsx(Jl,{})})}),s.jsx(z,{path:"/milestones/:id",element:s.jsx(K,{children:s.jsx(Zl,{})})}),s.jsx(z,{path:"/gantt",element:s.jsx(K,{children:s.jsx(ec,{})})}),s.jsx(z,{path:"/deliverables",element:s.jsx(K,{children:s.jsx(tc,{})})}),s.jsx(z,{path:"/resources",element:s.jsx(K,{children:s.jsx(rc,{})})}),s.jsx(z,{path:"/resources/:id",element:s.jsx(K,{children:s.jsx(sc,{})})}),s.jsx(z,{path:"/partners",element:s.jsx(K,{children:s.jsx(ac,{})})}),s.jsx(z,{path:"/partners/:id",element:s.jsx(K,{children:s.jsx(nc,{})})}),s.jsx(z,{path:"/timesheets",element:s.jsx(K,{children:s.jsx(ic,{})})}),s.jsx(z,{path:"/expenses",element:s.jsx(K,{children:s.jsx(oc,{})})}),s.jsx(z,{path:"/kpis",element:s.jsx(K,{children:s.jsx(lc,{})})}),s.jsx(z,{path:"/kpis/:id",element:s.jsx(K,{children:s.jsx(cc,{})})}),s.jsx(z,{path:"/quality-standards",element:s.jsx(K,{children:s.jsx(dc,{})})}),s.jsx(z,{path:"/quality-standards/:id",element:s.jsx(K,{children:s.jsx(uc,{})})}),s.jsx(z,{path:"/raid",element:s.jsx(K,{children:s.jsx(mc,{})})}),s.jsx(z,{path:"/calendar",element:s.jsx(K,{children:s.jsx(xc,{})})}),s.jsx(z,{path:"/variations",element:s.jsx(K,{children:s.jsx(_c,{})})}),s.jsx(z,{path:"/variations/new",element:s.jsx(K,{children:s.jsx(Or,{})})}),s.jsx(z,{path:"/variations/:id",element:s.jsx(K,{children:s.jsx(Sc,{})})}),s.jsx(z,{path:"/variations/:id/edit",element:s.jsx(K,{children:s.jsx(Or,{})})}),s.jsx(z,{path:"/reports",element:s.jsx(K,{children:s.jsx(hc,{})})}),s.jsx(z,{path:"/billing",element:s.jsx(K,{children:s.jsx(pc,{})})}),s.jsx(z,{path:"/users",element:s.jsx(K,{children:s.jsx(fc,{})})}),s.jsx(z,{path:"/settings",element:s.jsx(K,{children:s.jsx(gc,{})})}),s.jsx(z,{path:"/account",element:s.jsx(K,{children:s.jsx(yc,{})})}),s.jsx(z,{path:"/workflow-summary",element:s.jsx(K,{children:s.jsx(bc,{})})}),s.jsx(z,{path:"/audit-log",element:s.jsx(K,{children:s.jsx(wc,{})})}),s.jsx(z,{path:"/deleted-items",element:s.jsx(K,{children:s.jsx(vc,{})})}),s.jsx(z,{path:"*",element:s.jsx(_t,{to:"/dashboard",replace:!0})})]}),s.jsx(ei,{}),s.jsx(si,{}),s.jsx(ai,{}),s.jsx(an,{}),s.jsx(pn,{})]})})})})})})})})})})})}Yt.createRoot(document.getElementById("root")).render(s.jsx(At.StrictMode,{children:s.jsx(Ec,{})}));export{$c as A,Fl as B,st as C,Ct as L,Lc as S,Bc as T,le as V,ye as a,Pn as b,ns as c,zl as d,Ys as e,ts as f,Pc as g,vr as h,Ze as i,s as j,So as k,Hs as l,Ke as m,Sr as n,Ic as o,Mc as p,Co as q,Nc as r,f as s,Fs as t,Ee as u,or as v,Oc as w,qc as x,H as y,rt as z};
