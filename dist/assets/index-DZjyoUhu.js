const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ResetPassword-CXeVclGm.js","assets/vendor-react-JFEV0ROX.js","assets/vendor-icons-CiBQmrAI.js","assets/vendor-supabase-DgEUAXvv.js","assets/Milestones-Dj9Aanz7.js","assets/usePermissions-CeYhrlnU.js","assets/StatCard-pBjX5Jn0.js","assets/PageHeader-BxUOSgWa.js","assets/ConfirmDialog-2LN_73OE.js","assets/MilestoneDetail-1kDkyBWI.js","assets/Gantt-B1qLLkXW.js","assets/Deliverables-D7_4pG7k.js","assets/Resources-BB3JcB58.js","assets/ResourceDetail-DMYvORYu.js","assets/Partners-YaiHQXb8.js","assets/PartnerDetail-DOYNOx_p.js","assets/Timesheets-3kIogsfq.js","assets/Expenses-BBcq49j7.js","assets/Expenses-OWLTi329.css","assets/KPIs-IwCf2YUp.js","assets/KPIDetail-CGzYo3wV.js","assets/QualityStandards-Bi2qE737.js","assets/QualityStandardDetail-BZrfu2kw.js","assets/Reports-FaTKbOda.js","assets/Users-DpD_2mH7.js","assets/Settings-CSe2Unvi.js","assets/AccountSettings-BnbzPYN4.js","assets/WorkflowSummary-LHrvexGJ.js","assets/AuditLog-DOkdm_xP.js","assets/DeletedItems-COyoE3Z2.js"])))=>i.map(i=>d[i]);
var At=Object.defineProperty;var Dt=(i,t,e)=>t in i?At(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var je=(i,t,e)=>Dt(i,typeof t!="symbol"?t+"":t,e);import{r as d,a as Mt,R as st,u as ae,b as Tt,L as We,c as qt,B as Ot,d as Lt,e as O,N as Ae,O as zt}from"./vendor-react-JFEV0ROX.js";import{c as Bt}from"./vendor-supabase-DgEUAXvv.js";import{A as at,R as ue,I as Ut,X as nt,C as he,a as oe,M as Wt,S as $t,B as Ce,D as Ft,T as Vt,U as Ht,b as Kt,c as it,d as Gt,L as Qt,e as ot,f as Yt,g as Ee,h as Xt,i as lt,F as Le,j as ge,k as te,l as Jt,H as Zt,m as er,n as tr,o as ct,p as rr,q as sr,P as De,r as Me,G as ar,s as nr,t as ir,u as or,v as lr,w as dt,x as cr,K as dr,y as ke,z as Re,E as ut,J as ur,N as hr}from"./vendor-icons-CiBQmrAI.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerPolicy&&(n.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?n.credentials="include":a.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(a){if(a.ep)return;a.ep=!0;const n=e(a);fetch(a.href,n)}})();var ht={exports:{}},we={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var mr=d,fr=Symbol.for("react.element"),gr=Symbol.for("react.fragment"),pr=Object.prototype.hasOwnProperty,yr=mr.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,wr={key:!0,ref:!0,__self:!0,__source:!0};function mt(i,t,e){var s,a={},n=null,o=null;e!==void 0&&(n=""+e),t.key!==void 0&&(n=""+t.key),t.ref!==void 0&&(o=t.ref);for(s in t)pr.call(t,s)&&!wr.hasOwnProperty(s)&&(a[s]=t[s]);if(i&&i.defaultProps)for(s in t=i.defaultProps,t)a[s]===void 0&&(a[s]=t[s]);return{$$typeof:fr,type:i,key:n,ref:o,props:a,_owner:yr.current}}we.Fragment=gr;we.jsx=mt;we.jsxs=mt;ht.exports=we;var r=ht.exports,Te={},$e=Mt;Te.createRoot=$e.createRoot,Te.hydrateRoot=$e.hydrateRoot;const xr="modulepreload",br=function(i){return"/"+i},Fe={},B=function(t,e,s){let a=Promise.resolve();if(e&&e.length>0){document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),c=o?.nonce||o?.getAttribute("nonce");a=Promise.allSettled(e.map(l=>{if(l=br(l),l in Fe)return;Fe[l]=!0;const h=l.endsWith(".css"),m=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${m}`))return;const g=document.createElement("link");if(g.rel=h?"stylesheet":xr,h||(g.as="script"),g.crossOrigin="",g.href=l,c&&g.setAttribute("nonce",c),document.head.appendChild(g),h)return new Promise((f,y)=>{g.addEventListener("load",f),g.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${l}`)))})}))}function n(o){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=o,window.dispatchEvent(c),!c.defaultPrevented)throw o}return a.then(o=>{for(const c of o||[])c.status==="rejected"&&n(c.reason);return t().catch(n)})};var Ve={},_r="@vercel/analytics",vr="1.6.0",Sr=()=>{window.va||(window.va=function(...t){(window.vaq=window.vaq||[]).push(t)})};function ft(){return typeof window<"u"}function gt(){try{const i="production"}catch{}return"production"}function jr(i="auto"){if(i==="auto"){window.vam=gt();return}window.vam=i}function Cr(){return(ft()?window.vam:gt())||"production"}function qe(){return Cr()==="development"}function Er(i){return i.scriptSrc?i.scriptSrc:qe()?"https://va.vercel-scripts.com/v1/script.debug.js":i.basePath?`${i.basePath}/insights/script.js`:"/_vercel/insights/script.js"}function kr(i={debug:!0}){var t;if(!ft())return;jr(i.mode),Sr(),i.beforeSend&&((t=window.va)==null||t.call(window,"beforeSend",i.beforeSend));const e=Er(i);if(document.head.querySelector(`script[src*="${e}"]`))return;const s=document.createElement("script");s.src=e,s.defer=!0,s.dataset.sdkn=_r+(i.framework?`/${i.framework}`:""),s.dataset.sdkv=vr,i.disableAutoTrack&&(s.dataset.disableAutoTrack="1"),i.endpoint?s.dataset.endpoint=i.endpoint:i.basePath&&(s.dataset.endpoint=`${i.basePath}/insights`),i.dsn&&(s.dataset.dsn=i.dsn),s.onerror=()=>{const a=qe()?"Please check if any ad blockers are enabled and try again.":"Be sure to enable Web Analytics for your project and deploy again. See https://vercel.com/docs/analytics/quickstart for more information."},qe()&&i.debug===!1&&(s.dataset.debug="false"),document.head.appendChild(s)}function Rr({route:i,path:t}){var e;(e=window.va)==null||e.call(window,"pageview",{route:i,path:t})}function Nr(){if(!(typeof process>"u"||typeof Ve>"u"))return Ve.REACT_APP_VERCEL_OBSERVABILITY_BASEPATH}function Pr(i){return d.useEffect(()=>{var t;i.beforeSend&&((t=window.va)==null||t.call(window,"beforeSend",i.beforeSend))},[i.beforeSend]),d.useEffect(()=>{kr({framework:i.framework||"react",basePath:i.basePath??Nr(),...i.route!==void 0&&{disableAutoTrack:!0},...i})},[]),d.useEffect(()=>{i.route&&i.path&&Rr({route:i.route,path:i.path})},[i.route,i.path]),null}var He={},Ir="@vercel/speed-insights",Ar="1.2.0",Dr=()=>{window.si||(window.si=function(...t){(window.siq=window.siq||[]).push(t)})};function Mr(){return typeof window<"u"}function Tr(){try{const i="production"}catch{}return"production"}function pt(){return Tr()==="development"}function qr(i){return i.scriptSrc?i.scriptSrc:pt()?"https://va.vercel-scripts.com/v1/speed-insights/script.debug.js":i.dsn?"https://va.vercel-scripts.com/v1/speed-insights/script.js":i.basePath?`${i.basePath}/speed-insights/script.js`:"/_vercel/speed-insights/script.js"}function Or(i={}){var t;if(!Mr()||i.route===null)return null;Dr();const e=qr(i);if(document.head.querySelector(`script[src*="${e}"]`))return null;i.beforeSend&&((t=window.si)==null||t.call(window,"beforeSend",i.beforeSend));const s=document.createElement("script");return s.src=e,s.defer=!0,s.dataset.sdkn=Ir+(i.framework?`/${i.framework}`:""),s.dataset.sdkv=Ar,i.sampleRate&&(s.dataset.sampleRate=i.sampleRate.toString()),i.route&&(s.dataset.route=i.route),i.endpoint?s.dataset.endpoint=i.endpoint:i.basePath&&(s.dataset.endpoint=`${i.basePath}/speed-insights/vitals`),i.dsn&&(s.dataset.dsn=i.dsn),pt()&&i.debug===!1&&(s.dataset.debug="false"),s.onerror=()=>{},document.head.appendChild(s),{setRoute:a=>{s.dataset.route=a??void 0}}}function Lr(){if(!(typeof process>"u"||typeof He>"u"))return He.REACT_APP_VERCEL_OBSERVABILITY_BASEPATH}function zr(i){d.useEffect(()=>{var e;i.beforeSend&&((e=window.si)==null||e.call(window,"beforeSend",i.beforeSend))},[i.beforeSend]);const t=d.useRef(null);return d.useEffect(()=>{if(t.current)i.route&&t.current(i.route);else{const e=Or({framework:i.framework??"react",basePath:i.basePath??Lr(),...i});e&&(t.current=e.setRoute)}},[i.route]),null}const Br=void 0,Ur=void 0;throw new Error("Missing Supabase environment variables");const p=Bt(Br,Ur),yt=d.createContext(null),Wr=60*1e3,$r=5*60*1e3;function Fr({children:i}){const[t,e]=d.useState(null),[s,a]=d.useState(null),[n,o]=d.useState(null),[c,l]=d.useState(!0),[h,m]=d.useState(null),[g,f]=d.useState(!1),y=d.useRef(null),x=d.useRef(Date.now()),u=d.useCallback(()=>{x.current=Date.now()},[]);async function b(S){if(!S){a(null),o(null);return}try{const{data:j,error:T}=await p.from("profiles").select("*").eq("id",S.id).single();if(T){m(T);return}a(j);const{data:A}=await p.from("resources").select("*").eq("user_id",S.id).maybeSingle();o(A),m(null)}catch(j){m(j)}}const k=d.useCallback(async()=>{try{const{data:{session:S},error:j}=await p.auth.getSession();if(j)return;if(!S){await M();return}const T=S.expires_at*1e3,A=Date.now(),P=T-A;if(P<=0)await M();else if(P<=$r){f(!0);const{data:V,error:J}=await p.auth.refreshSession();J||!V.session||f(!1)}else f(!1)}catch{}},[]);async function M(){e(null),a(null),o(null),f(!1),await p.auth.signOut();const S=window.location.pathname;S!=="/login"&&S!=="/register"&&(window.location.href="/login?expired=true")}const I=d.useCallback(()=>{y.current&&clearInterval(y.current),y.current=setInterval(()=>{k()},Wr);const S=()=>{document.visibilityState==="visible"&&k()};document.addEventListener("visibilitychange",S);const j=["mousedown","keydown","touchstart","scroll"];return j.forEach(T=>{document.addEventListener(T,u,{passive:!0})}),()=>{y.current&&clearInterval(y.current),document.removeEventListener("visibilitychange",S),j.forEach(T=>{document.removeEventListener(T,u)})}},[k,u]);d.useEffect(()=>{let S=!0,j=null;async function T(){try{const{data:{session:P},error:V}=await p.auth.getSession();V&&S&&m(V),S&&(e(P?.user??null),l(!1),P?.user&&(b(P.user),j=I()))}catch(P){S&&(m(P),l(!1))}}T();const{data:{subscription:A}}=p.auth.onAuthStateChange(async(P,V)=>{S&&(e(V?.user??null),l(!1),V?.user?(b(V.user),j&&j(),j=I()):(a(null),o(null),j&&(j(),j=null)),(P==="SIGNED_OUT"||P==="TOKEN_REFRESHED")&&f(!1))});return()=>{S=!1,A.unsubscribe(),j&&j()}},[I]);async function v(){try{await p.auth.signOut(),e(null),a(null),o(null),f(!1)}catch(S){m(S)}}async function C(){t&&await b(t)}async function R(){try{const{data:S,error:j}=await p.auth.refreshSession();return j?!1:S.session?(f(!1),!0):!1}catch{return!1}}const E={user:t,profile:s,role:s?.role||"viewer",linkedResource:n,isLoading:c,error:h,signOut:v,refreshUserData:C,refreshSession:R,isAuthenticated:!!t,sessionExpiring:g};return r.jsx(yt.Provider,{value:E,children:i})}function xe(){const i=d.useContext(yt);if(!i)throw new Error("useAuth must be used within an AuthProvider");return i}const wt=d.createContext(null);function Vr({children:i}){const[t,e]=d.useState(null),[s,a]=d.useState(!0),[n,o]=d.useState(null);d.useEffect(()=>{let m=!0;async function g(){try{const{data:f,error:y}=await p.from("projects").select("*").eq("reference","AMSF001").single();y?m&&o(y):m&&(e(f),o(null))}catch(f){m&&o(f)}finally{m&&a(!1)}}return g(),()=>{m=!1}},[]);async function c(m){a(!0),o(null);try{const{data:g,error:f}=await p.from("projects").select("*").eq("reference",m).single();f?o(f):e(g)}catch(g){o(g)}finally{a(!1)}}async function l(){if(t)try{const{data:m,error:g}=await p.from("projects").select("*").eq("id",t.id).single();g?o(g):e(m)}catch(m){o(m)}}const h={currentProject:t,projectId:t?.id||null,projectRef:t?.reference||null,projectName:t?.name||null,isLoading:s,error:n,switchProject:c,refreshProject:l};return r.jsx(wt.Provider,{value:h,children:i})}function ne(){const i=d.useContext(wt);if(!i)throw new Error("useProject must be used within a ProjectProvider");return i}const xt=d.createContext();function Hr({children:i}){const[t,e]=d.useState(!1),[s,a]=d.useState(null),[n,o]=d.useState([]);d.useEffect(()=>{c(),l()},[]);async function c(){const{data:{user:u}}=await p.auth.getUser();if(u){const{data:b}=await p.from("profiles").select("role").eq("id",u.id).single();b&&a(b.role)}}async function l(){const{data:u}=await p.from("profiles").select("id").eq("is_test_user",!0);u&&o(u.map(b=>b.id))}const h=s==="admin"||s==="supplier_pm";function m(){h&&e(u=>!u)}function g(u){return n.includes(u)}function f(u,b="user_id"){return!u||t?u:u.filter(k=>!n.includes(k[b]))}function y(u){return!u||t?u:u.filter(b=>!b.is_test_content)}const x={showTestUsers:t,setShowTestUsers:e,toggleTestUsers:m,canToggleTestUsers:h,testUserIds:n,isTestUser:g,filterTestContent:f,filterByTestFlag:y,userRole:s};return r.jsx(xt.Provider,{value:x,children:i})}function bt(){const i=d.useContext(xt);if(!i)throw new Error("useTestUsers must be used within a TestUserProvider");return i}const _t=d.createContext();function Kr(){return d.useContext(_t)}function Gr({children:i}){const[t,e]=d.useState([]),[s,a]=d.useState(0),[n,o]=d.useState(0),[c,l]=d.useState(!0),[h,m]=d.useState(null),[g,f]=d.useState(null),y=C=>["admin","supplier_pm","customer_pm"].includes(C),x=d.useCallback(async(C,R)=>{try{let E=[];if(y(R)){const{data:S}=await p.from("timesheets").select("id, hours_worked, hours, work_date, date").eq("status","Submitted"),{data:j}=await p.from("expenses").select("id, amount, category, reason, resource_name, chargeable_to_customer").eq("status","Submitted"),{data:T}=await p.from("deliverables").select("id, name, deliverable_ref").eq("status","Submitted"),{data:A}=await p.from("milestone_certificates").select("id, milestone_id").eq("status","Submitted");S&&S.forEach(P=>{E.push({id:`ts-${P.id}`,type:"timesheet",notification_type:"action",title:"Timesheet Submitted",message:`Timesheet (${P.hours_worked||P.hours||0}h) pending approval`,action_url:"/timesheets",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1})}),j&&j.forEach(P=>{const V=P.chargeable_to_customer!==!1;E.push({id:`exp-${P.id}`,type:"expense",notification_type:"action",title:"Expense Submitted",message:`${P.resource_name||"Unknown"} expense (Â£${parseFloat(P.amount||0).toFixed(2)}) pending validation`,action_url:"/expenses",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1,isChargeable:V})}),T&&T.forEach(P=>{E.push({id:`del-${P.id}`,type:"deliverable",notification_type:"action",title:"Deliverable Submitted",message:`${P.deliverable_ref}: ${P.name} pending review`,action_url:"/deliverables",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1})}),A&&A.forEach(P=>{E.push({id:`cert-${P.id}`,type:"certificate",notification_type:"action",title:"Certificate Submitted",message:"Milestone certificate pending approval",action_url:"/milestones",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1})})}else{const{data:S}=await p.from("timesheets").select("id, hours_worked, hours, work_date, date, resource_id").eq("status","Submitted").eq("user_id",C),{data:j}=await p.from("expenses").select("id, amount, category, reason, resource_name").eq("status","Submitted").eq("created_by",C);S&&S.forEach(T=>{E.push({id:`ts-${T.id}`,type:"timesheet",notification_type:"action",title:"Timesheet Submitted",message:`Your timesheet for ${T.hours_worked||T.hours||0}h is pending approval`,action_url:"/timesheets",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1})}),j&&j.forEach(T=>{E.push({id:`exp-${T.id}`,type:"expense",notification_type:"action",title:"Expense Submitted",message:`Your expense (Â£${parseFloat(T.amount||0).toFixed(2)}) is pending validation`,action_url:"/expenses",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1})})}return{count:E.length,items:E}}catch{return{count:0,items:[]}}},[]),u=d.useCallback(async()=>{try{const{data:{user:C}}=await p.auth.getUser();if(!C){e([]),a(0),o(0),l(!1);return}m(C.id);const{data:R}=await p.from("profiles").select("role").eq("id",C.id).single(),E=R?.role||"viewer";f(E);const{count:S,items:j}=await x(C.id,E);e(j),a(S),o(S)}catch{}finally{l(!1)}},[x]),b=d.useCallback(async C=>{e(R=>R.map(E=>E.id===C?{...E,is_read:!0}:E)),a(R=>Math.max(0,R-1))},[]),k=d.useCallback(async C=>{e(R=>R.map(E=>E.id===C?{...E,is_actioned:!0,is_read:!0}:E)),a(R=>Math.max(0,R-1)),o(R=>Math.max(0,R-1))},[]),M=d.useCallback(async()=>{e(C=>C.map(R=>({...R,is_read:!0}))),a(0)},[]),I=d.useCallback(async C=>{const R=t.find(E=>E.id===C);R&&(e(E=>E.filter(S=>S.id!==C)),R.is_read||a(E=>Math.max(0,E-1)),R.notification_type==="action"&&!R.is_actioned&&o(E=>Math.max(0,E-1)))},[t]);d.useEffect(()=>{u();const C=setInterval(()=>{u()},3e4);return()=>clearInterval(C)},[u]),d.useEffect(()=>{const{data:{subscription:C}}=p.auth.onAuthStateChange((R,E)=>{R==="SIGNED_IN"?u():R==="SIGNED_OUT"&&(e([]),a(0),o(0),m(null),f(null))});return()=>C.unsubscribe()},[u]);const v={notifications:t,unreadCount:s,actionCount:n,loading:c,fetchNotifications:u,markAsRead:b,markAsActioned:k,markAllAsRead:M,dismissNotification:I};return r.jsx(_t.Provider,{value:v,children:i})}const vt=d.createContext(null),ze="amsf-chat-history",Qr=50,Ne={maxRetries:2,baseDelayMs:1e3,retryableCodes:[429,503,504]};function Yr(){try{const i=localStorage.getItem(ze);if(i){const t=JSON.parse(i);return{messages:t.messages||[],tokenUsage:t.tokenUsage||{input:0,output:0,requests:0}}}}catch{}return{messages:[],tokenUsage:{input:0,output:0,requests:0}}}function Xr(i,t){try{const e=i.slice(-Qr);localStorage.setItem(ze,JSON.stringify({messages:e,tokenUsage:t,savedAt:new Date().toISOString()}))}catch{}}function Jr({children:i}){const{user:t,profile:e,linkedResource:s,role:a}=xe(),{projectId:n,projectName:o,projectRef:c,currentProject:l}=ne(),h=Yr(),[m,g]=d.useState(!1),[f,y]=d.useState(h.messages),[x,u]=d.useState(!1),[b,k]=d.useState(null),[M,I]=d.useState(0),[v,C]=d.useState(h.tokenUsage),R=d.useRef(null);d.useEffect(()=>{(f.length>0||v.requests>0)&&Xr(f,v)},[f,v]);const E=d.useCallback(()=>l?{id:n,reference:c||l?.reference,name:o||l?.name,description:l?.description||null}:null,[l,n,c,o]),S=d.useCallback(()=>({name:e?.full_name||t?.email?.split("@")[0]||"User",email:t?.email,role:a||e?.role||"unknown",linkedResourceName:s?.name||null,linkedResourceId:s?.id||null,partnerId:s?.partner_id||null,partnerName:s?.partners?.name||null}),[t,e,s,a]),j=async(W,$=1)=>{R.current=new AbortController;try{const D=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(W),signal:R.current.signal}),_=await D.json().catch(()=>({}));if(!D.ok){if(Ne.retryableCodes.includes(D.status)&&$<=Ne.maxRetries&&_.recoverable!==!1){const K=_.retryAfter?_.retryAfter*1e3:Ne.baseDelayMs*Math.pow(2,$-1);return I($),await new Promise(F=>setTimeout(F,K)),j(W,$+1)}throw new Error(_.error||`Request failed (${D.status})`)}return I(0),_}catch(D){throw D.name==="AbortError"?new Error("Request cancelled"):D}},T=d.useCallback(async W=>{if(!W.trim()||x)return;R.current&&R.current.abort();const $={role:"user",content:W.trim(),timestamp:new Date().toISOString()};y(D=>[...D,$]),u(!0),k(null),I(0);try{const D=E(),_=S(),L=[...f.slice(-9),$].map(F=>({role:F.role,content:F.content})),K=await j({messages:L,projectContext:D,userContext:_,projectId:n});K.usage&&C(F=>({input:F.input+(K.usage.input_tokens||0),output:F.output+(K.usage.output_tokens||0),requests:F.requests+1})),y(F=>[...F,{role:"assistant",content:K.message,toolsUsed:K.toolsUsed||!1,cached:K.cached||!1,timestamp:new Date().toISOString(),tokens:K.usage?{input:K.usage.input_tokens,output:K.usage.output_tokens}:null}])}catch(D){let _=D.message;D.message==="Request cancelled"?_=null:D.message.includes("Failed to fetch")&&(_="Unable to connect. Please check your internet connection."),_&&(k(_),y(L=>L.slice(0,-1)))}finally{u(!1),I(0)}},[f,x,E,S,n]),A=d.useCallback(()=>{R.current&&(R.current.abort(),u(!1),I(0))},[]),P=d.useCallback(()=>{A(),y([]),k(null),localStorage.removeItem(ze)},[A]),V=d.useCallback(()=>{P(),C({input:0,output:0,requests:0})},[P]),J=d.useCallback(()=>{g(W=>!W)},[]),ie=d.useCallback(()=>{k(null)},[]),N=d.useCallback(()=>{if(f.length===0)return null;const W=S(),$=E();let D=`# Chat Export

`;return D+=`**Exported:** ${new Date().toLocaleString("en-GB")}
`,D+=`**User:** ${W.name} (${W.role})
`,$&&(D+=`**Project:** ${$.name} (${$.reference})
`),D+=`**Messages:** ${f.length}
`,D+=`**Token Usage:** ${v.input.toLocaleString()} input / ${v.output.toLocaleString()} output

`,D+=`---

`,f.forEach((_,L)=>{const K=_.role==="user"?"ðŸ‘¤ You":"ðŸ¤– Assistant",F=_.timestamp?new Date(_.timestamp).toLocaleTimeString("en-GB"):"";D+=`### ${K}${F?` (${F})`:""}

`,D+=`${_.content}

`,_.toolsUsed&&(D+=`*ðŸ“Š Queried project data*

`),L<f.length-1&&(D+=`---

`)}),D},[f,v,S,E]),U=d.useCallback(()=>{const W=N();if(!W)return;const $=new Blob([W],{type:"text/markdown"}),D=URL.createObjectURL($),_=document.createElement("a");_.href=D,_.download=`chat-export-${new Date().toISOString().split("T")[0]}.md`,document.body.appendChild(_),_.click(),document.body.removeChild(_),URL.revokeObjectURL(D)},[N]),Z=d.useCallback(async W=>{try{return await navigator.clipboard.writeText(W),!0}catch{return!1}},[]),X={isOpen:m,setIsOpen:g,toggleChat:J,messages:f,isLoading:x,error:b,retryCount:M,tokenUsage:v,sendMessage:T,clearChat:P,resetAllStats:V,cancelRequest:A,dismissError:ie,exportChat:N,downloadChat:U,copyMessage:Z};return r.jsx(vt.Provider,{value:X,children:i})}function Zr(){const i=d.useContext(vt);if(!i)throw new Error("useChat must be used within a ChatProvider");return i}class es extends st.Component{constructor(e){super(e);je(this,"handleReload",()=>{window.location.reload()});je(this,"handleReset",()=>{this.setState({hasError:!1,error:null,errorInfo:null})});this.state={hasError:!1,error:null,errorInfo:null}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,s){this.setState({errorInfo:s})}render(){return this.state.hasError?this.props.fallback?this.props.fallback:r.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"3rem",backgroundColor:"#fef2f2",borderRadius:"12px",margin:"1rem",border:"1px solid #fecaca"},children:[r.jsx(at,{size:48,style:{color:"#dc2626",marginBottom:"1rem"}}),r.jsx("h2",{style:{color:"#991b1b",margin:"0 0 0.5rem 0",fontSize:"1.25rem",fontWeight:"600"},children:"Something went wrong"}),r.jsx("p",{style:{color:"#64748b",margin:"0 0 1.5rem 0",textAlign:"center",maxWidth:"400px"},children:this.state.error?.message||"An unexpected error occurred. Please try again."}),r.jsxs("div",{style:{display:"flex",gap:"0.75rem"},children:[r.jsx("button",{onClick:this.handleReset,style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.625rem 1.25rem",backgroundColor:"white",color:"#374151",border:"1px solid #d1d5db",borderRadius:"8px",cursor:"pointer",fontSize:"0.875rem",fontWeight:"500"},children:"Try Again"}),r.jsxs("button",{onClick:this.handleReload,style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.625rem 1.25rem",backgroundColor:"#3b82f6",color:"white",border:"none",borderRadius:"8px",cursor:"pointer",fontSize:"0.875rem",fontWeight:"500"},children:[r.jsx(ue,{size:16}),"Reload Page"]})]})]}):this.props.children}}function St({message:i,size:t="medium",fullPage:e=!1,className:s=""}){const a={small:"spinner-sm",medium:"",large:"spinner-lg"};return r.jsxs("div",{className:`loading-spinner ${s}`,style:e?{minHeight:"60vh"}:void 0,children:[r.jsx("div",{className:`spinner ${a[t]}`}),i&&r.jsx("p",{className:"loading-text",children:i})]})}const ts={background:"linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%)",backgroundSize:"200% 100%",animation:"shimmer 1.5s infinite"};function G({width:i="100%",height:t="1rem",style:e={},className:s=""}){return r.jsxs(r.Fragment,{children:[r.jsx("style",{children:`
        @keyframes shimmer {
          0% { background-position: 200% 0; }
          100% { background-position: -200% 0; }
        }
      `}),r.jsx("div",{className:s,style:{width:i,height:t,borderRadius:"4px",...ts,...e}})]})}function Oe({width:i="100%",lines:t=1}){return r.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"0.5rem"},children:Array.from({length:t}).map((e,s)=>r.jsx(G,{width:s===t-1&&t>1?"70%":i,height:"1rem"},s))})}function rs(){return r.jsxs("div",{style:{backgroundColor:"white",borderRadius:"12px",padding:"1.5rem",boxShadow:"0 1px 3px rgba(0,0,0,0.1)",display:"flex",alignItems:"center",gap:"1rem"},children:[r.jsx(G,{width:"48px",height:"48px",style:{borderRadius:"12px"}}),r.jsxs("div",{style:{flex:1},children:[r.jsx(G,{width:"60%",height:"0.875rem",style:{marginBottom:"0.5rem"}}),r.jsx(G,{width:"40%",height:"1.5rem"})]})]})}function ss({columns:i=6}){return r.jsx("tr",{children:Array.from({length:i}).map((t,e)=>r.jsx("td",{style:{padding:"0.75rem 1rem"},children:r.jsx(G,{width:e===0?"80%":e===i-1?"60px":"70%",height:"1rem"})},e))})}function Pe({hasHeader:i=!0}){return r.jsxs("div",{style:{backgroundColor:"white",borderRadius:"12px",padding:"1.5rem",boxShadow:"0 1px 3px rgba(0,0,0,0.1)"},children:[i&&r.jsx(G,{width:"40%",height:"1.5rem",style:{marginBottom:"1rem"}}),r.jsx(Oe,{lines:3})]})}function de({type:i="text",count:t=1,...e}){return(()=>{switch(i){case"text":return r.jsx(Oe,{...e});case"stat-card":case"stats":return r.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:"1rem"},children:Array.from({length:t}).map((a,n)=>r.jsx(rs,{},n))});case"table":return r.jsx("div",{className:"card",children:r.jsxs("table",{children:[r.jsx("thead",{children:r.jsx("tr",{children:Array.from({length:e.columns||6}).map((a,n)=>r.jsx("th",{style:{padding:"0.75rem 1rem"},children:r.jsx(G,{width:"60%",height:"0.875rem"})},n))})}),r.jsx("tbody",{children:Array.from({length:e.rows||5}).map((a,n)=>r.jsx(ss,{columns:e.columns||6},n))})]})});case"card":return r.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"1rem"},children:Array.from({length:t}).map((a,n)=>r.jsx(Pe,{...e},n))});case"page":return r.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"1.5rem"},children:[r.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[r.jsxs("div",{children:[r.jsx(G,{width:"200px",height:"1.75rem",style:{marginBottom:"0.5rem"}}),r.jsx(G,{width:"300px",height:"1rem"})]}),r.jsx(G,{width:"120px",height:"40px",style:{borderRadius:"8px"}})]}),r.jsx(de,{type:"stats",count:4}),r.jsx(de,{type:"table",rows:8,columns:6})]});case"detail":return r.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"1.5rem"},children:[r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"1rem"},children:[r.jsx(G,{width:"80px",height:"36px",style:{borderRadius:"8px"}}),r.jsx(G,{width:"250px",height:"1.75rem"})]}),r.jsx(de,{type:"stats",count:4}),r.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[r.jsx(Pe,{}),r.jsx(Pe,{})]}),r.jsx(de,{type:"table",rows:5,columns:5})]});default:return r.jsx(Oe,{...e})}})()}const Ke={success:{icon:he,bgColor:"#dcfce7",borderColor:"#86efac",textColor:"#166534",iconColor:"#16a34a"},error:{icon:nt,bgColor:"#fee2e2",borderColor:"#fecaca",textColor:"#991b1b",iconColor:"#dc2626"},warning:{icon:at,bgColor:"#fef3c7",borderColor:"#fde68a",textColor:"#92400e",iconColor:"#d97706"},info:{icon:Ut,bgColor:"#dbeafe",borderColor:"#93c5fd",textColor:"#1e40af",iconColor:"#3b82f6"}};function as({id:i,message:t,type:e="info",duration:s=4e3,onClose:a}){const n=Ke[e]||Ke.info,o=n.icon;return d.useEffect(()=>{if(s>0){const c=setTimeout(()=>{a(i)},s);return()=>clearTimeout(c)}},[i,s,a]),r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem",padding:"0.875rem 1rem",backgroundColor:n.bgColor,border:`1px solid ${n.borderColor}`,borderRadius:"8px",boxShadow:"0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)",minWidth:"300px",maxWidth:"450px",animation:"slideIn 0.3s ease-out"},children:[r.jsx(o,{size:20,style:{color:n.iconColor,flexShrink:0}}),r.jsx("span",{style:{color:n.textColor,fontSize:"0.875rem",fontWeight:"500",flex:1},children:t}),r.jsx("button",{onClick:()=>a(i),style:{background:"none",border:"none",cursor:"pointer",padding:"0.25rem",display:"flex",alignItems:"center",justifyContent:"center",color:n.textColor,opacity:.7,borderRadius:"4px"},onMouseEnter:c=>c.target.style.opacity=1,onMouseLeave:c=>c.target.style.opacity=.7,children:r.jsx(oe,{size:16})})]})}function ns({toasts:i,removeToast:t}){return i.length===0?null:r.jsxs("div",{style:{position:"fixed",top:"1rem",right:"1rem",zIndex:9999,display:"flex",flexDirection:"column",gap:"0.5rem"},children:[r.jsx("style",{children:`
          @keyframes slideIn {
            from {
              transform: translateX(100%);
              opacity: 0;
            }
            to {
              transform: translateX(0);
              opacity: 1;
            }
          }
        `}),i.map(e=>r.jsx(as,{id:e.id,message:e.message,type:e.type,duration:e.duration,onClose:t},e.id))]})}const jt=d.createContext(null),is=4e3;function os({children:i}){const[t,e]=d.useState([]),s=d.useCallback(m=>{e(g=>g.filter(f=>f.id!==m))},[]),a=d.useCallback((m,g="info",f=is)=>{const y=Date.now()+Math.random(),x={id:y,message:m,type:g,duration:f};return e(u=>[...u,x]),y},[]),n=d.useCallback((m,g)=>a(m,"success",g),[a]),o=d.useCallback((m,g)=>a(m,"error",g||6e3),[a]),c=d.useCallback((m,g)=>a(m,"warning",g),[a]),l=d.useCallback((m,g)=>a(m,"info",g),[a]),h={showToast:a,showSuccess:n,showError:o,showWarning:c,showInfo:l,removeToast:s};return r.jsxs(jt.Provider,{value:h,children:[i,r.jsx(ns,{toasts:t,removeToast:s})]})}function ls(){const i=d.useContext(jt);if(!i)throw new Error("useToast must be used within a ToastProvider");return i}const H={timesheets:{contributeToSpend:["Submitted","Validated","Approved"],excludeFromSpend:["Draft","Rejected"],completed:["Validated","Approved"]},expenses:{contributeToSpend:["Submitted","Validated","Approved"],excludeFromSpend:["Draft","Rejected"],completed:["Validated","Approved"]},deliverables:{contributeToKPIs:["Delivered"],contributeToQS:["Delivered"],inProgress:["In Progress","Submitted","Under Review"],completed:["Delivered"],notStarted:["Not Started","Draft"]},milestones:{completed:["Completed"],inProgress:["In Progress"],notStarted:["Not Started","Planned"]},kpis:{achieved:["Achieved","On Target"],atRisk:["At Risk","Amber"],failing:["Failing","Red","Off Target"]},qualityStandards:{achieved:["Achieved","Met"],partial:["Partial","In Progress"],notMet:["Not Met","Failed"]}},cs=["pmo","project manager","pm"];function fe(i){if(!i)return!1;const t=i.toLowerCase();return cs.some(e=>t.includes(e))}function Ge(i){return i?H.timesheets.contributeToSpend.includes(i):!1}function Qe(i){return i?H.expenses.contributeToSpend.includes(i):!1}const Ye={defaultTarget:90,amberThreshold:10,calculationMethod:"assessment_based"},ds={defaultTarget:100,calculationMethod:"assessment_based"},Ct={hoursPerDay:8,currency:"Â£",currencyCode:"GBP",decimalPlaces:2};function le(i){return(parseFloat(i)||0)/Ct.hoursPerDay}function Et(i,t){return le(i)*(parseFloat(t)||0)}function Xe(i,t){return le(i)*(parseFloat(t)||0)}class us{constructor(){this.cache=new Map,this.cacheTimeout=5e3}clearCache(){this.cache.clear()}getCached(t){const e=this.cache.get(t);return e&&Date.now()-e.timestamp<this.cacheTimeout?e.data:null}setCache(t,e){this.cache.set(t,{data:e,timestamp:Date.now()})}async getMilestoneMetrics(t){const e=`milestones_${t}`,s=this.getCached(e);if(s)return s;try{const{data:a,error:n}=await p.from("milestones").select("id, milestone_ref, name, status, progress, budget, percent_complete, is_deleted").eq("project_id",t).order("milestone_ref");if(n)throw n;const o=a?.filter(l=>l.is_deleted!==!0)||[],c={total:o.length,completed:o.filter(l=>H.milestones.completed.includes(l.status)).length,inProgress:o.filter(l=>H.milestones.inProgress.includes(l.status)).length,notStarted:o.filter(l=>H.milestones.notStarted.includes(l.status)).length,totalBudget:o.reduce((l,h)=>l+(h.budget||0),0),averageProgress:o.length>0?Math.round(o.reduce((l,h)=>l+(h.progress||0),0)/o.length):0,milestones:o};return this.setCache(e,c),c}catch(a){throw a}}async getDeliverableMetrics(t,e=!1){const s=`deliverables_${t}_${e}`,a=this.getCached(s);if(a)return a;try{const{data:n,error:o}=await p.from("deliverables").select("id, deliverable_ref, name, status, due_date, milestone_id, is_deleted, is_test_content").eq("project_id",t).order("deliverable_ref");if(o)throw o;let c=n?.filter(f=>f.is_deleted!==!0)||[];e||(c=c.filter(f=>f.is_test_content!==!0));const l=new Date().toISOString().split("T")[0],h=new Date;h.setDate(h.getDate()+7);const m=h.toISOString().split("T")[0],g={total:c.length,delivered:c.filter(f=>H.deliverables.completed.includes(f.status)).length,inProgress:c.filter(f=>H.deliverables.inProgress.includes(f.status)).length,notStarted:c.filter(f=>H.deliverables.notStarted.includes(f.status)).length,overdue:c.filter(f=>f.due_date<l&&!H.deliverables.completed.includes(f.status)).length,dueThisWeek:c.filter(f=>f.due_date>=l&&f.due_date<=m&&!H.deliverables.completed.includes(f.status)).length,deliverables:c};return g.completionPercent=g.total>0?Math.round(g.delivered/g.total*100):0,this.setCache(s,g),g}catch(n){throw n}}async getKPIMetrics(t){const e=`kpis_${t}`,s=this.getCached(e);if(s)return s;try{const{data:a,error:n}=await p.from("kpis").select("id, kpi_ref, name, category, target, current_value, is_deleted").eq("project_id",t).order("kpi_ref");if(n)throw n;const o=a?.filter(x=>x.is_deleted!==!0)||[],{data:c,error:l}=await p.from("deliverable_kpi_assessments").select(`
          kpi_id,
          criteria_met,
          deliverables!inner(id, status, is_deleted, project_id)
        `).eq("deliverables.project_id",t),h=c?.filter(x=>x.deliverables?.is_deleted!==!0&&H.deliverables.contributeToKPIs.includes(x.deliverables?.status))||[],m=new Map;h&&h.length>0&&h.forEach(x=>{m.has(x.kpi_id)||m.set(x.kpi_id,{total:0,met:0});const u=m.get(x.kpi_id);u.total++,x.criteria_met&&u.met++});const g=o.map(x=>{const u=m.get(x.id);let b=0;u&&u.total>0&&(b=Math.round(u.met/u.total*100));const k=x.target||Ye.defaultTarget,M=b>=k;return{...x,calculatedValue:b,assessmentCount:u?.total||0,assessmentsMet:u?.met||0,isAchieved:M,ragStatus:b>=k?"Green":b>=k*(1-Ye.amberThreshold/100)?"Amber":"Red"}}),f={};g.forEach(x=>{const u=x.category||"Other";f[u]||(f[u]=[]),f[u].push(x)});const y={total:o.length,achieved:g.filter(x=>x.isAchieved).length,atRisk:g.filter(x=>x.ragStatus==="Amber").length,failing:g.filter(x=>x.ragStatus==="Red").length,achievementPercent:o.length>0?Math.round(g.filter(x=>x.isAchieved).length/o.length*100):0,byCategory:f,kpis:g};return this.setCache(e,y),y}catch(a){throw a}}async getQualityStandardMetrics(t){const e=`qs_${t}`,s=this.getCached(e);if(s)return s;try{const{data:a,error:n}=await p.from("quality_standards").select("id, qs_ref, name, target, current_value, is_deleted").eq("project_id",t).order("qs_ref");if(n)throw n;const o=a?.filter(y=>y.is_deleted!==!0)||[],{data:c,error:l}=await p.from("deliverable_qs_assessments").select(`
          quality_standard_id,
          criteria_met,
          deliverables!inner(id, status, is_deleted, project_id)
        `).eq("deliverables.project_id",t),h=c?.filter(y=>y.deliverables?.is_deleted!==!0&&H.deliverables.contributeToQS.includes(y.deliverables?.status))||[],m=new Map;h&&h.length>0&&h.forEach(y=>{m.has(y.quality_standard_id)||m.set(y.quality_standard_id,{total:0,met:0});const x=m.get(y.quality_standard_id);x.total++,y.criteria_met&&x.met++});const g=o.map(y=>{const x=m.get(y.id);let u=0;x&&x.total>0&&(u=Math.round(x.met/x.total*100));const b=y.target||ds.defaultTarget,k=u>=b;return{...y,calculatedValue:u,assessmentCount:x?.total||0,assessmentsMet:x?.met||0,isAchieved:k}}),f={total:o.length,achieved:g.filter(y=>y.isAchieved).length,partial:g.filter(y=>y.calculatedValue>0&&!y.isAchieved).length,notMet:g.filter(y=>y.calculatedValue===0).length,achievementPercent:o.length>0?Math.round(g.filter(y=>y.isAchieved).length/o.length*100):0,qualityStandards:g};return this.setCache(e,f),f}catch(a){throw a}}async getTimesheetMetrics(t,e=!1){const s=`timesheets_${t}_${e}`,a=this.getCached(s);if(a)return a;try{const{data:n,error:o}=await p.from("timesheets").select(`
          id, date, hours_worked, hours, status, milestone_id, resource_id, is_deleted,
          resources(id, name, role, sell_price)
        `).eq("project_id",t);if(o)throw o;const c=n?.filter(u=>u.is_deleted!==!0)||[];let l=0,h=0,m=0,g=0;const f={},y={};c.forEach(u=>{const b=parseFloat(u.hours_worked||u.hours||0),k=u.resources,M=k?.sell_price||0,I=b/Ct.hoursPerDay*M;Ge(u.status)&&(l+=b,h+=I,fe(k?.role)?m+=I:g+=I,u.milestone_id&&(f[u.milestone_id]=(f[u.milestone_id]||0)+I),u.resource_id&&(y[u.resource_id]=(y[u.resource_id]||0)+I))});const x={totalEntries:c.length,validEntries:c.filter(u=>Ge(u.status)).length,draftEntries:c.filter(u=>u.status==="Draft").length,rejectedEntries:c.filter(u=>u.status==="Rejected").length,totalHours:l,totalSpend:h,pmoSpend:m,deliverySpend:g,spendByMilestone:f,spendByResource:y};return this.setCache(s,x),x}catch(n){throw n}}async getExpenseMetrics(t,e=!1){const s=`expenses_${t}_${e}`,a=this.getCached(s);if(a)return a;try{const{data:n,error:o}=await p.from("expenses").select("id, expense_date, amount, status, category, chargeable_to_customer, procurement_method, is_deleted").eq("project_id",t);if(o)throw o;const c=n?.filter(y=>y.is_deleted!==!0)||[];let l=0,h=0,m=0;const g={};c.forEach(y=>{const x=parseFloat(y.amount||0);if(Qe(y.status)){l+=x,y.chargeable_to_customer?h+=x:m+=x;const u=y.category||"Other";g[u]=(g[u]||0)+x}});const f={totalEntries:c.length,validEntries:c.filter(y=>Qe(y.status)).length,draftEntries:c.filter(y=>y.status==="Draft").length,rejectedEntries:c.filter(y=>y.status==="Rejected").length,totalAmount:l,chargeableAmount:h,nonChargeableAmount:m,byCategory:g};return this.setCache(s,f),f}catch(n){throw n}}async getResourceMetrics(t){const e=`resources_${t}`,s=this.getCached(e);if(s)return s;try{const{data:a,error:n}=await p.from("resources").select("id, name, role, sell_price, days_allocated, is_deleted").eq("project_id",t);if(n)throw n;const o=a?.filter(m=>m.is_deleted!==!0)||[];let c=0,l=0;o.forEach(m=>{const g=(m.sell_price||0)*(m.days_allocated||0);fe(m.role)?c+=g:l+=g});const h={total:o.length,pmoCount:o.filter(m=>fe(m.role)).length,deliveryCount:o.filter(m=>!fe(m.role)).length,pmoBudget:c,deliveryBudget:l,totalBudget:c+l,resources:o};return this.setCache(e,h),h}catch(a){throw a}}async getCertificateMetrics(t){const e=`certificates_${t}`,s=this.getCached(e);if(s)return s;try{const{data:a,error:n}=await p.from("milestone_certificates").select("id, milestone_id, status").eq("project_id",t);if(n)throw n;const o=await this.getMilestoneMetrics(t),c={total:a?.length||0,signed:a?.filter(l=>l.status==="Signed").length||0,pending:a?.filter(l=>l.status==="Pending Customer Signature"||l.status==="Pending Supplier Signature").length||0,awaitingGeneration:Math.max(0,o.completed-(a?.length||0))};return this.setCache(e,c),c}catch(a){throw a}}async getAllDashboardMetrics(t,e={}){const{includeTestContent:s=!1}=e;try{const[a,n,o,c,l,h,m,g]=await Promise.all([this.getMilestoneMetrics(t),this.getDeliverableMetrics(t,s),this.getKPIMetrics(t),this.getQualityStandardMetrics(t),this.getTimesheetMetrics(t,s),this.getExpenseMetrics(t,s),this.getResourceMetrics(t),this.getCertificateMetrics(t)]),f={totalBudget:a.totalBudget,timesheetSpend:l.totalSpend,expenseSpend:h.totalAmount,totalSpend:l.totalSpend+h.totalAmount,pmoBudget:m.pmoBudget,pmoSpend:l.pmoSpend,deliveryBudget:m.deliveryBudget,deliverySpend:l.deliverySpend,utilizationPercent:a.totalBudget>0?Math.round((l.totalSpend+h.totalAmount)/a.totalBudget*100):0},y={...l.spendByMilestone};return Object.entries(h.byMilestone).forEach(([x,u])=>{y[x]=(y[x]||0)+u}),{milestones:a,deliverables:n,kpis:o,qualityStandards:c,timesheets:l,expenses:h,resources:m,certificates:g,budget:f,milestoneSpend:y,projectProgress:a.averageProgress,lastUpdated:new Date().toISOString()}}catch(a){throw a}}}const Q=new us,kt=d.createContext(null);function hs({children:i}){const{projectId:t}=ne(),{showTestUsers:e}=bt(),[s,a]=d.useState(null),[n,o]=d.useState(!0),[c,l]=d.useState(null),[h,m]=d.useState(null),g=d.useCallback(async(x=!1)=>{if(!t){a(null),o(!1);return}x&&Q.clearCache(),o(!0),l(null);try{const u=await Q.getAllDashboardMetrics(t,{includeTestContent:e});a(u),m(new Date)}catch(u){l(u.message||"Failed to load metrics")}finally{o(!1)}},[t,e]),f=d.useCallback(async x=>{if(t)try{let u;switch(x){case"milestones":u=await Q.getMilestoneMetrics(t),a(b=>b?{...b,milestones:u}:null);break;case"deliverables":u=await Q.getDeliverableMetrics(t,e),a(b=>b?{...b,deliverables:u}:null);break;case"kpis":u=await Q.getKPIMetrics(t),a(b=>b?{...b,kpis:u}:null);break;case"qualityStandards":u=await Q.getQualityStandardMetrics(t),a(b=>b?{...b,qualityStandards:u}:null);break;case"timesheets":u=await Q.getTimesheetMetrics(t,e),a(b=>b?{...b,timesheets:u}:null);break;case"expenses":u=await Q.getExpenseMetrics(t,e),a(b=>b?{...b,expenses:u}:null);break;case"resources":u=await Q.getResourceMetrics(t),a(b=>b?{...b,resources:u}:null);break;case"certificates":u=await Q.getCertificateMetrics(t),a(b=>b?{...b,certificates:u}:null);break;default:await g(!0)}m(new Date)}catch{}},[t,e,g]);d.useEffect(()=>{g()},[g]);const y=d.useMemo(()=>({metrics:s,milestones:s?.milestones||null,deliverables:s?.deliverables||null,kpis:s?.kpis||null,qualityStandards:s?.qualityStandards||null,timesheets:s?.timesheets||null,expenses:s?.expenses||null,resources:s?.resources||null,certificates:s?.certificates||null,billable:s?.billable||null,milestoneSpend:s?.milestoneSpend||{},projectProgress:s?.projectProgress||0,loading:n,error:c,lastRefresh:h,refreshMetrics:()=>g(!0),refreshCategory:f,clearCache:()=>Q.clearCache()}),[s,n,c,h,g,f]);return r.jsx(kt.Provider,{value:y,children:i})}function Ra(){const i=d.useContext(kt);if(!i)throw new Error("useMetrics must be used within a MetricsProvider");return i}function ms(){const{isOpen:i,toggleChat:t,messages:e,isLoading:s,error:a,retryCount:n,tokenUsage:o,sendMessage:c,clearChat:l,cancelRequest:h,dismissError:m,downloadChat:g,copyMessage:f}=Zr(),[y,x]=d.useState(""),[u,b]=d.useState(null),[k,M]=d.useState(!1),I=d.useRef(null),v=d.useRef(null);d.useEffect(()=>{I.current?.scrollIntoView({behavior:"smooth"})},[e]),d.useEffect(()=>{i&&setTimeout(()=>v.current?.focus(),100)},[i]),d.useEffect(()=>{if(u!==null){const A=setTimeout(()=>b(null),2e3);return()=>clearTimeout(A)}},[u]);const C=A=>{A.preventDefault(),y.trim()&&!s&&(c(y),x(""))},R=A=>{A.key==="Enter"&&!A.shiftKey&&(A.preventDefault(),C(A))},E=async(A,P)=>{await f(A)&&b(P)},S={role:"assistant",content:`Hello! I'm your Project Assistant. I can query your project data and help you understand what's happening. Try asking:

â€¢ **"What do I need to do?"** - See your pending actions
â€¢ **"Show my timesheets this month"** - Query your time entries
â€¢ **"What milestones are at risk?"** - Check project progress
â€¢ **"What's the budget status?"** - View spend vs forecast
â€¢ **"What can my role do?"** - Understand your permissions

All data is scoped to your role, so just ask naturally!`},j=e.length===0?[S]:e,T=(o.input*.25/1e6+o.output*1.25/1e6).toFixed(4);return r.jsxs(r.Fragment,{children:[r.jsx("button",{className:`chat-toggle-btn ${i?"chat-open":""}`,onClick:t,"aria-label":i?"Close chat":"Open AI assistant",children:i?r.jsx(oe,{size:24}):r.jsxs(r.Fragment,{children:[r.jsx(Wt,{size:24}),r.jsx($t,{className:"chat-sparkle",size:12})]})}),r.jsxs("div",{className:`chat-panel ${i?"chat-panel-open":""}`,children:[r.jsxs("div",{className:"chat-header",children:[r.jsxs("div",{className:"chat-header-title",children:[r.jsx(Ce,{size:20}),r.jsx("span",{children:"Project Assistant"})]}),r.jsxs("div",{className:"chat-header-actions",children:[e.length>0&&r.jsxs(r.Fragment,{children:[r.jsx("button",{className:"chat-action-btn",onClick:g,title:"Export chat as Markdown",children:r.jsx(Ft,{size:16})}),r.jsx("button",{className:"chat-action-btn",onClick:l,title:"Clear chat",children:r.jsx(Vt,{size:16})})]}),r.jsx("button",{className:"chat-close-btn",onClick:t,"aria-label":"Close chat",children:r.jsx(oe,{size:20})})]})]}),r.jsxs("div",{className:"chat-messages",children:[j.map((A,P)=>r.jsxs("div",{className:`chat-message ${A.role==="user"?"chat-message-user":"chat-message-assistant"}`,children:[r.jsx("div",{className:"chat-message-avatar",children:A.role==="user"?r.jsx(Ht,{size:16}):r.jsx(Ce,{size:16})}),r.jsxs("div",{className:"chat-message-content",children:[r.jsx(fs,{content:A.content}),r.jsxs("div",{className:"chat-message-actions",children:[A.toolsUsed&&r.jsx("span",{className:"chat-tools-indicator",title:"Queried project data",children:r.jsx(Kt,{size:12})}),r.jsx("button",{className:"chat-copy-btn",onClick:()=>E(A.content,P),title:u===P?"Copied!":"Copy message",children:u===P?r.jsx(it,{size:12,className:"chat-copy-success"}):r.jsx(Gt,{size:12})})]})]})]},P)),s&&r.jsxs("div",{className:"chat-message chat-message-assistant",children:[r.jsx("div",{className:"chat-message-avatar",children:r.jsx(Ce,{size:16})}),r.jsxs("div",{className:"chat-message-content chat-typing",children:[n>0?r.jsxs(r.Fragment,{children:[r.jsx(ue,{className:"chat-typing-icon",size:16}),r.jsxs("span",{children:["Retrying (",n,"/2)..."]})]}):r.jsxs(r.Fragment,{children:[r.jsx(Qt,{className:"chat-typing-icon",size:16}),r.jsx("span",{children:"Querying data..."})]}),r.jsx("button",{className:"chat-cancel-btn",onClick:h,title:"Cancel request",children:r.jsx(nt,{size:14})})]})]}),a&&r.jsxs("div",{className:"chat-error",children:[r.jsx("span",{children:a}),r.jsx("button",{className:"chat-error-dismiss",onClick:m,title:"Dismiss",children:r.jsx(oe,{size:14})})]}),r.jsx("div",{ref:I})]}),r.jsxs("form",{className:"chat-input-form",onSubmit:C,children:[r.jsx("textarea",{ref:v,className:"chat-input",value:y,onChange:A=>x(A.target.value),onKeyDown:R,placeholder:"Ask me anything about the project...",rows:1,disabled:s}),r.jsx("button",{type:"submit",className:"chat-send-btn",disabled:!y.trim()||s,"aria-label":"Send message",children:r.jsx(ot,{size:18})})]}),r.jsxs("div",{className:"chat-footer",children:[r.jsx("button",{className:"chat-stats-toggle",onClick:()=>M(!k),title:"Toggle usage stats",children:r.jsx(Yt,{size:12})}),k?r.jsxs("div",{className:"chat-stats",children:[r.jsxs("span",{title:"Total requests",children:[o.requests," req"]}),r.jsx("span",{className:"chat-stats-divider",children:"â€¢"}),r.jsxs("span",{title:"Input tokens",children:[o.input.toLocaleString()," in"]}),r.jsx("span",{className:"chat-stats-divider",children:"â€¢"}),r.jsxs("span",{title:"Output tokens",children:[o.output.toLocaleString()," out"]}),r.jsx("span",{className:"chat-stats-divider",children:"â€¢"}),r.jsxs("span",{title:"Estimated cost",children:["$",T]})]}):r.jsx("span",{children:"Powered by Claude AI"})]})]})]})}function fs({content:i}){const t=i.split(`
`);return r.jsx("div",{className:"chat-message-text",children:t.map((e,s)=>{if(e.startsWith("â€¢ ")||e.startsWith("- ")){const a=e.substring(2);return r.jsxs("div",{className:"chat-bullet",children:[r.jsx("span",{className:"chat-bullet-dot",children:"â€¢"}),r.jsx("span",{dangerouslySetInnerHTML:{__html:Je(a)}})]},s)}return e.trim()===""?r.jsx("div",{className:"chat-line-break"},s):r.jsx("p",{dangerouslySetInnerHTML:{__html:Je(e)}},s)})})}function Je(i){return i.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>")}function gs(){const[i,t]=d.useState(!1),e=d.useRef(null),s=ae(),{notifications:a,unreadCount:n,actionCount:o,loading:c,markAsRead:l,markAsActioned:h,markAllAsRead:m,dismissNotification:g}=Kr();d.useEffect(()=>{function v(C){e.current&&!e.current.contains(C.target)&&t(!1)}return document.addEventListener("mousedown",v),()=>document.removeEventListener("mousedown",v)},[]);const f=v=>{switch(v){case"timesheet":return r.jsx(te,{size:16});case"expense":return r.jsx(ge,{size:16});case"deliverable":return r.jsx(Le,{size:16});case"certificate":return r.jsx(lt,{size:16});default:return r.jsx(Ee,{size:16})}},y=v=>v.notification_type==="action"?v.is_actioned?"#10b981":"#f59e0b":"#3b82f6",x=async v=>{v.is_read||await l(v.id),v.action_url&&(s(v.action_url),t(!1))},u=async(v,C)=>{v.stopPropagation(),await h(C.id),C.action_url&&(s(C.action_url),t(!1))},b=async(v,C)=>{v.stopPropagation(),await g(C.id)},k=v=>{const C=new Date(v),E=new Date-C,S=Math.floor(E/6e4),j=Math.floor(E/36e5),T=Math.floor(E/864e5);return S<1?"Just now":S<60?`${S}m ago`:j<24?`${j}h ago`:T<7?`${T}d ago`:C.toLocaleDateString("en-GB",{day:"numeric",month:"short"})},M=a.slice(0,10),I=a.filter(v=>v.notification_type==="action"&&!v.is_actioned);return r.jsxs("div",{className:"notification-bell-container",ref:e,style:{position:"relative"},children:[r.jsxs("button",{onClick:()=>t(!i),style:{position:"relative",background:"none",border:"none",cursor:"pointer",padding:"8px",borderRadius:"8px",display:"flex",alignItems:"center",justifyContent:"center",transition:"background-color 0.2s",backgroundColor:i?"#f1f5f9":"transparent"},onMouseEnter:v=>v.target.style.backgroundColor="#f1f5f9",onMouseLeave:v=>v.target.style.backgroundColor=i?"#f1f5f9":"transparent",title:`${o} actions pending`,children:[r.jsx(Ee,{size:22,color:"#64748b"}),(n>0||o>0)&&r.jsx("span",{style:{position:"absolute",top:"2px",right:"2px",backgroundColor:o>0?"#ef4444":"#3b82f6",color:"white",fontSize:"11px",fontWeight:"600",minWidth:"18px",height:"18px",borderRadius:"9px",display:"flex",alignItems:"center",justifyContent:"center",padding:"0 4px"},children:o>0?o:n})]}),i&&r.jsxs("div",{style:{position:"absolute",top:"100%",right:0,marginTop:"8px",width:"380px",maxHeight:"500px",backgroundColor:"white",borderRadius:"12px",boxShadow:"0 10px 40px rgba(0,0,0,0.15)",border:"1px solid #e2e8f0",zIndex:1e3,overflow:"hidden"},children:[r.jsxs("div",{style:{padding:"16px",borderBottom:"1px solid #e2e8f0",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[r.jsxs("div",{children:[r.jsx("h3",{style:{margin:0,fontSize:"16px",fontWeight:"600"},children:"Notifications"}),o>0&&r.jsxs("p",{style:{margin:"4px 0 0",fontSize:"13px",color:"#f59e0b"},children:[o," action",o!==1?"s":""," required"]})]}),n>0&&r.jsx("button",{onClick:m,style:{background:"none",border:"none",color:"#3b82f6",fontSize:"13px",cursor:"pointer",padding:"4px 8px",borderRadius:"4px"},children:"Mark all read"})]}),I.length>0&&r.jsxs("div",{style:{padding:"12px 16px",backgroundColor:"#fffbeb",borderBottom:"1px solid #fef3c7"},children:[r.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"8px"},children:[r.jsx("div",{style:{width:"8px",height:"8px",borderRadius:"50%",backgroundColor:"#f59e0b",animation:"pulse 2s infinite"}}),r.jsx("span",{style:{fontWeight:"600",fontSize:"13px",color:"#92400e"},children:"Actions Requiring Attention"})]}),r.jsxs("button",{onClick:()=>{s("/workflow-summary"),t(!1)},style:{width:"100%",padding:"8px 12px",backgroundColor:"#f59e0b",color:"white",border:"none",borderRadius:"6px",cursor:"pointer",fontSize:"13px",fontWeight:"500",display:"flex",alignItems:"center",justifyContent:"center",gap:"6px"},children:["View Workflow Summary",r.jsx(Xt,{size:16})]})]}),r.jsx("div",{style:{maxHeight:"350px",overflowY:"auto"},children:c?r.jsx("div",{style:{padding:"32px",textAlign:"center",color:"#64748b"},children:"Loading..."}):M.length===0?r.jsxs("div",{style:{padding:"32px",textAlign:"center",color:"#64748b"},children:[r.jsx(Ee,{size:32,style:{marginBottom:"8px",opacity:.5}}),r.jsx("p",{style:{margin:0},children:"No notifications"})]}):M.map(v=>r.jsx("div",{onClick:()=>x(v),style:{padding:"12px 16px",borderBottom:"1px solid #f1f5f9",cursor:"pointer",backgroundColor:v.is_read?"white":"#f8fafc",transition:"background-color 0.15s"},onMouseEnter:C=>C.currentTarget.style.backgroundColor="#f1f5f9",onMouseLeave:C=>C.currentTarget.style.backgroundColor=v.is_read?"white":"#f8fafc",children:r.jsxs("div",{style:{display:"flex",gap:"12px"},children:[r.jsx("div",{style:{width:"36px",height:"36px",borderRadius:"8px",backgroundColor:v.notification_type==="action"&&!v.is_actioned?"#fef3c7":"#f1f5f9",display:"flex",alignItems:"center",justifyContent:"center",color:y(v),flexShrink:0},children:f(v.category)}),r.jsxs("div",{style:{flex:1,minWidth:0},children:[r.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",gap:"8px"},children:[r.jsx("span",{style:{fontWeight:v.is_read?"400":"600",fontSize:"14px",color:"#1e293b"},children:v.title}),r.jsx("span",{style:{fontSize:"12px",color:"#94a3b8",flexShrink:0},children:k(v.created_at)})]}),r.jsx("p",{style:{margin:"4px 0 0",fontSize:"13px",color:"#64748b",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:v.message}),r.jsxs("div",{style:{marginTop:"8px",display:"flex",gap:"8px"},children:[v.notification_type==="action"&&!v.is_actioned&&v.action_label&&r.jsx("button",{onClick:C=>u(C,v),style:{padding:"4px 12px",fontSize:"12px",fontWeight:"500",backgroundColor:"#3b82f6",color:"white",border:"none",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",gap:"4px"},children:v.action_label}),v.notification_type==="info"&&r.jsxs("button",{onClick:C=>b(C,v),style:{padding:"4px 8px",fontSize:"12px",backgroundColor:"transparent",color:"#64748b",border:"1px solid #e2e8f0",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",gap:"4px"},children:[r.jsx(oe,{size:12}),"Dismiss"]}),v.is_actioned&&r.jsxs("span",{style:{padding:"4px 8px",fontSize:"12px",color:"#10b981",display:"flex",alignItems:"center",gap:"4px"},children:[r.jsx(it,{size:12}),"Completed"]})]})]})]})},v.id))}),a.length>10&&r.jsx("div",{style:{padding:"12px 16px",borderTop:"1px solid #e2e8f0",textAlign:"center"},children:r.jsx("button",{onClick:()=>{s("/workflow-summary"),t(!1)},style:{background:"none",border:"none",color:"#3b82f6",fontSize:"13px",fontWeight:"500",cursor:"pointer"},children:"View all notifications"})})]}),r.jsx("style",{children:`
        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.5; }
        }
      `})]})}const w={ADMIN:"admin",SUPPLIER_PM:"supplier_pm",CUSTOMER_PM:"customer_pm",CONTRIBUTOR:"contributor",VIEWER:"viewer"},ps=[w.ADMIN,w.SUPPLIER_PM,w.CUSTOMER_PM,w.CONTRIBUTOR,w.VIEWER],re=ps,ee=[w.ADMIN,w.SUPPLIER_PM,w.CUSTOMER_PM],q=[w.ADMIN,w.SUPPLIER_PM],ce=[w.ADMIN,w.CUSTOMER_PM],se=[w.ADMIN,w.SUPPLIER_PM,w.CONTRIBUTOR],Ie=[w.ADMIN],ys={timesheets:{view:re,create:se,createForOthers:q,edit:se,delete:q,submit:se,approve:ce},expenses:{view:re,create:se,createForOthers:q,edit:se,delete:q,submit:se,validateChargeable:ce,validateNonChargeable:q},milestones:{view:re,create:q,edit:q,delete:Ie,useGantt:q},deliverables:{view:re,create:[...ee,w.CONTRIBUTOR],edit:[...ee,w.CONTRIBUTOR],delete:q,submit:se,review:ce,markDelivered:ce},kpis:{view:re,create:q,edit:q,delete:q,manage:q},qualityStandards:{view:re,create:q,edit:q,delete:q,manage:q},resources:{view:re,create:q,edit:q,delete:Ie,manage:q,seeCostPrice:q,seeResourceType:q,seeMargins:q},partners:{view:q,create:q,edit:q,delete:q,manage:q},certificates:{view:ee,create:ee,signAsSupplier:q,signAsCustomer:ce},invoices:{view:ee,generateCustomer:ee,generateThirdParty:q,viewMargins:q},settings:{access:q,edit:q},users:{view:q,manage:Ie},reports:{access:ee,viewWorkflowSummary:ee}};function Na(i,t,e){const s=ys[t];if(!s)return!1;const a=s[e];return a?a.includes(i):!1}const ws={[w.ADMIN]:{label:"Admin",color:"#7c3aed",bg:"#f3e8ff"},[w.SUPPLIER_PM]:{label:"Supplier PM",color:"#059669",bg:"#d1fae5"},[w.CUSTOMER_PM]:{label:"Customer PM",color:"#d97706",bg:"#fef3c7"},[w.CONTRIBUTOR]:{label:"Contributor",color:"#2563eb",bg:"#dbeafe"},[w.VIEWER]:{label:"Viewer",color:"#64748b",bg:"#f1f5f9"}},Pa=Object.entries(ws).map(([i,t])=>({value:i,...t})),be={workflowSummary:{id:"workflowSummary",path:"/workflow-summary",icon:ir,label:"Workflow Summary",allowedRoles:[w.ADMIN,w.SUPPLIER_PM,w.CUSTOMER_PM,w.CONTRIBUTOR],readOnlyRoles:[]},dashboard:{id:"dashboard",path:"/dashboard",icon:nr,label:"Dashboard",allowedRoles:[w.ADMIN,w.SUPPLIER_PM,w.CUSTOMER_PM,w.VIEWER],readOnlyRoles:[w.VIEWER]},reports:{id:"reports",path:"/reports",icon:Le,label:"Reports",allowedRoles:[w.ADMIN,w.SUPPLIER_PM,w.CUSTOMER_PM],readOnlyRoles:[]},gantt:{id:"gantt",path:"/gantt",icon:ar,label:"Gantt Chart",allowedRoles:[w.ADMIN,w.SUPPLIER_PM,w.CUSTOMER_PM,w.VIEWER],readOnlyRoles:[w.VIEWER,w.CUSTOMER_PM]},milestones:{id:"milestones",path:"/milestones",icon:Me,label:"Milestones",allowedRoles:[w.ADMIN,w.SUPPLIER_PM,w.CUSTOMER_PM,w.VIEWER],readOnlyRoles:[w.VIEWER]},deliverables:{id:"deliverables",path:"/deliverables",icon:De,label:"Deliverables",allowedRoles:[w.ADMIN,w.SUPPLIER_PM,w.CUSTOMER_PM,w.CONTRIBUTOR,w.VIEWER],readOnlyRoles:[w.VIEWER]},kpis:{id:"kpis",path:"/kpis",icon:sr,label:"KPIs",allowedRoles:[w.ADMIN,w.SUPPLIER_PM,w.CUSTOMER_PM,w.VIEWER],readOnlyRoles:[w.VIEWER,w.CUSTOMER_PM]},qualityStandards:{id:"qualityStandards",path:"/quality-standards",icon:lt,label:"Quality Standards",allowedRoles:[w.ADMIN,w.SUPPLIER_PM,w.CUSTOMER_PM,w.VIEWER],readOnlyRoles:[w.VIEWER,w.CUSTOMER_PM]},resources:{id:"resources",path:"/resources",icon:rr,label:"Resources",allowedRoles:[w.ADMIN,w.SUPPLIER_PM],readOnlyRoles:[]},timesheets:{id:"timesheets",path:"/timesheets",icon:te,label:"Timesheets",allowedRoles:[w.ADMIN,w.SUPPLIER_PM,w.CUSTOMER_PM,w.CONTRIBUTOR],readOnlyRoles:[]},expenses:{id:"expenses",path:"/expenses",icon:ge,label:"Expenses",allowedRoles:[w.ADMIN,w.SUPPLIER_PM,w.CUSTOMER_PM,w.CONTRIBUTOR],readOnlyRoles:[]},partners:{id:"partners",path:"/partners",icon:ct,label:"Partners",allowedRoles:[w.ADMIN,w.SUPPLIER_PM],readOnlyRoles:[]},users:{id:"users",path:"/users",icon:tr,label:"Users",allowedRoles:[w.ADMIN,w.SUPPLIER_PM],readOnlyRoles:[w.SUPPLIER_PM]},settings:{id:"settings",path:"/settings",icon:er,label:"Settings",allowedRoles:[w.ADMIN,w.SUPPLIER_PM],readOnlyRoles:[]},auditLog:{id:"auditLog",path:"/audit-log",icon:Zt,label:"Audit Log",allowedRoles:[w.ADMIN,w.SUPPLIER_PM],readOnlyRoles:[]},deletedItems:{id:"deletedItems",path:"/deleted-items",icon:Jt,label:"Deleted Items",allowedRoles:[w.ADMIN,w.SUPPLIER_PM],readOnlyRoles:[]}},pe={[w.ADMIN]:["workflowSummary","dashboard","reports","gantt","milestones","deliverables","kpis","qualityStandards","resources","timesheets","expenses","partners","users","settings","auditLog","deletedItems"],[w.SUPPLIER_PM]:["workflowSummary","dashboard","reports","gantt","milestones","deliverables","kpis","qualityStandards","resources","timesheets","expenses","partners","users","settings","auditLog","deletedItems"],[w.CUSTOMER_PM]:["workflowSummary","dashboard","reports","gantt","milestones","deliverables","kpis","qualityStandards","timesheets","expenses"],[w.CONTRIBUTOR]:["workflowSummary","timesheets","expenses","deliverables"],[w.VIEWER]:["dashboard","gantt","milestones","deliverables","kpis","qualityStandards"]};function xs(i){return(pe[i]||pe[w.VIEWER]).map(e=>be[e]?.path).filter(Boolean)}function Rt(i){return(pe[i]||pe[w.VIEWER]).map(e=>be[e]).filter(e=>e&&e.allowedRoles.includes(i))}function Ze(i,t){const e=be[t];return e?e.readOnlyRoles?.includes(i)||!1:!0}function bs(i){return i!==w.VIEWER}function _s(i){return Object.values(be).find(t=>t.path===i)||null}function vs(i){return _s(i)?.id||null}function Ss(i,t){const e=Rt(i);if(!t||!Array.isArray(t)||t.length===0)return e;const s={};e.forEach(n=>{s[n.path]=n});const a=[];return t.forEach(n=>{s[n]&&(a.push(s[n]),delete s[n])}),Object.values(s).forEach(n=>{a.push(n)}),a}function js(i,t){if(!t||t.length===0)return!0;const e=xs(i);return t.length!==e.length?!1:t.every((s,a)=>s===e[a])}const et={[w.ADMIN]:{label:"Administrator",shortLabel:"Admin",color:"#7c3aed",bg:"#f3e8ff",description:"Full system access"},[w.SUPPLIER_PM]:{label:"Supplier PM",shortLabel:"Supplier PM",color:"#059669",bg:"#d1fae5",description:"Manage resources, partners, and invoices"},[w.CUSTOMER_PM]:{label:"Customer PM",shortLabel:"Customer PM",color:"#d97706",bg:"#fef3c7",description:"Approve timesheets and validate expenses"},[w.CONTRIBUTOR]:{label:"Contributor",shortLabel:"Contributor",color:"#2563eb",bg:"#dbeafe",description:"Submit timesheets and expenses"},[w.VIEWER]:{label:"Viewer",shortLabel:"Viewer",color:"#64748b",bg:"#f1f5f9",description:"Read-only access to reports"}};function Cs(i){return et[i]||et[w.VIEWER]}function Es({children:i}){const t=Tt(),e=ae(),{showSuccess:s,showError:a}=ls(),{user:n,profile:o,role:c,signOut:l}=xe(),[h,m]=d.useState(!0),[g,f]=d.useState(null),[y,x]=d.useState(null),[u,b]=d.useState(null),k=d.useRef(null),M=d.useMemo(()=>Cs(c),[c]),I=d.useMemo(()=>o&&(o.full_name||o.email||n?.email)||"User",[o,n]),v=d.useMemo(()=>{if(!o)return"U";if(o.full_name){const N=o.full_name.split(" ");return N.length>=2?N[0][0]+N[N.length-1][0]:o.full_name[0].toUpperCase()}return I[0].toUpperCase()},[o,I]);d.useEffect(()=>{o?.nav_order&&Array.isArray(o.nav_order)&&f(o.nav_order)},[o]);async function C(){await l(),e("/login")}const R=d.useMemo(()=>bs(c),[c]),E=d.useMemo(()=>g&&!js(c,g),[c,g]),S=d.useMemo(()=>{const N=Rt(c);return g&&g.length>0?Ss(c,g):N},[c,g]),j=d.useMemo(()=>{const N=vs(t.pathname);return N?Ze(c,N):!1},[c,t.pathname]);function T(N,U){R&&(k.current=N.target,x(U),setTimeout(()=>{k.current&&(k.current.style.opacity="0.5")},0))}function A(N,U){R&&U!==y&&b(U)}function P(N){R&&N.preventDefault()}function V(){if(R){if(k.current&&(k.current.style.opacity="1"),y!==null&&u!==null&&y!==u){const N=[...S],U=N[y];N.splice(y,1),N.splice(u,0,U);const Z=N.map(X=>X.path);f(Z),J(Z)}x(null),b(null),k.current=null}}async function J(N){if(n)try{const{error:U}=await p.from("profiles").update({nav_order:N}).eq("id",n.id);U&&a("Failed to save menu order")}catch{a("Failed to save menu order")}}async function ie(){if(n)try{const{error:N}=await p.from("profiles").update({nav_order:null}).eq("id",n.id);if(N){a("Failed to reset menu order");return}f(null),s("Menu order reset to default")}catch{a("Failed to reset menu order")}}return r.jsxs("div",{style:{display:"flex",minHeight:"100vh",backgroundColor:"#f8fafc"},children:[r.jsxs("aside",{style:{width:h?"260px":"70px",backgroundColor:"white",borderRight:"1px solid #e2e8f0",transition:"width 0.3s ease",display:"flex",flexDirection:"column",position:"fixed",height:"100vh",zIndex:50},children:[r.jsxs("div",{style:{padding:"1rem",borderBottom:"1px solid #e2e8f0",display:"flex",alignItems:"center",justifyContent:"space-between"},children:[h&&r.jsxs("div",{children:[r.jsx("h2",{style:{margin:0,fontSize:"1.125rem",fontWeight:"700",color:"#0f172a"},children:"AMSF001"}),r.jsx("span",{style:{fontSize:"0.75rem",color:"#64748b"},children:"Project Tracker"})]}),r.jsx("button",{onClick:()=>m(!h),style:{padding:"0.5rem",borderRadius:"6px",border:"none",backgroundColor:"#f1f5f9",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"},children:h?r.jsx(oe,{size:20}):r.jsx(or,{size:20})})]}),r.jsx("nav",{style:{flex:1,padding:"0.5rem",overflowY:"auto"},children:S.map((N,U)=>{const Z=N.icon,X=t.pathname===N.path||N.path!=="/dashboard"&&t.pathname.startsWith(N.path),W=y===U,$=u===U,D=Ze(c,N.id);return r.jsx("div",{draggable:R,onDragStart:_=>T(_,U),onDragEnter:_=>A(_,U),onDragOver:P,onDragEnd:V,style:{position:"relative",marginBottom:"0.25rem",borderTop:$&&y>U?"2px solid #10b981":"2px solid transparent",borderBottom:$&&y<U?"2px solid #10b981":"2px solid transparent",transition:"border-color 0.15s ease"},children:r.jsxs(We,{to:N.path,style:{display:"flex",alignItems:"center",gap:"0.75rem",padding:h?"0.75rem 1rem":"0.75rem",borderRadius:"8px",textDecoration:"none",color:X?"#10b981":"#64748b",backgroundColor:X?"#f0fdf4":W?"#f1f5f9":"transparent",fontWeight:X?"600":"500",justifyContent:h?"flex-start":"center",transition:"all 0.15s ease",cursor:R?"grab":"pointer"},children:[h&&R&&r.jsx(lr,{size:14,style:{color:"#cbd5e1",marginRight:"-0.25rem",flexShrink:0}}),r.jsx(Z,{size:20}),h&&r.jsx("span",{style:{flex:1},children:N.label}),h&&D&&r.jsx("span",{style:{fontSize:"0.6rem",padding:"0.125rem 0.375rem",backgroundColor:"#f1f5f9",color:"#64748b",borderRadius:"4px",fontWeight:"500"},children:"VIEW"})]})},N.path)})}),h&&R&&E&&r.jsx("div",{style:{padding:"0.5rem 1rem",borderTop:"1px solid #e2e8f0"},children:r.jsxs("button",{onClick:ie,style:{width:"100%",display:"flex",alignItems:"center",justifyContent:"center",gap:"0.5rem",padding:"0.5rem",backgroundColor:"#f8fafc",color:"#64748b",border:"1px solid #e2e8f0",borderRadius:"6px",cursor:"pointer",fontSize:"0.75rem",fontWeight:"500",transition:"all 0.15s ease"},onMouseEnter:N=>{N.currentTarget.style.backgroundColor="#f1f5f9",N.currentTarget.style.color="#475569"},onMouseLeave:N=>{N.currentTarget.style.backgroundColor="#f8fafc",N.currentTarget.style.color="#64748b"},children:[r.jsx(dt,{size:14}),"Reset Menu Order"]})}),r.jsx("div",{style:{padding:"1rem",borderTop:"1px solid #e2e8f0",backgroundColor:"#f8fafc"},children:r.jsxs("button",{onClick:C,style:{width:"100%",display:"flex",alignItems:"center",justifyContent:h?"flex-start":"center",gap:"0.75rem",padding:"0.75rem",backgroundColor:"#fef2f2",color:"#ef4444",border:"none",borderRadius:"8px",cursor:"pointer",fontWeight:"500"},children:[r.jsx(cr,{size:20}),h&&r.jsx("span",{children:"Logout"})]})})]}),r.jsxs("main",{style:{flex:1,marginLeft:h?"260px":"70px",transition:"margin-left 0.3s ease",minHeight:"100vh",display:"flex",flexDirection:"column"},children:[r.jsxs("header",{style:{padding:"0.75rem 1.5rem",backgroundColor:"white",borderBottom:"1px solid #e2e8f0",display:"flex",justifyContent:"flex-end",alignItems:"center",gap:"1rem",position:"sticky",top:0,zIndex:40},children:[r.jsxs(We,{to:"/account",style:{display:"flex",alignItems:"center",gap:"0.75rem",paddingRight:"1rem",borderRight:"1px solid #e2e8f0",textDecoration:"none",cursor:"pointer",borderRadius:"8px",padding:"0.5rem 1rem 0.5rem 0.75rem",marginRight:"0",transition:"background-color 0.15s ease"},onMouseEnter:N=>N.currentTarget.style.backgroundColor="#f8fafc",onMouseLeave:N=>N.currentTarget.style.backgroundColor="transparent",children:[r.jsxs("div",{style:{textAlign:"right"},children:[r.jsx("div",{style:{fontWeight:"600",fontSize:"0.875rem",color:"#1e293b"},children:I}),r.jsx("span",{style:{display:"inline-block",padding:"0.125rem 0.5rem",backgroundColor:M.bg,color:M.color,borderRadius:"4px",fontSize:"0.65rem",fontWeight:"600",textTransform:"uppercase",letterSpacing:"0.025em"},children:M.shortLabel})]}),r.jsx("div",{style:{width:"36px",height:"36px",borderRadius:"50%",backgroundColor:M.color,display:"flex",alignItems:"center",justifyContent:"center",color:"white",fontWeight:"600",fontSize:"0.8rem"},children:v})]}),r.jsx(gs,{})]}),j&&r.jsxs("div",{style:{padding:"0.5rem 1.5rem",backgroundColor:"#f1f5f9",borderBottom:"1px solid #e2e8f0",display:"flex",alignItems:"center",gap:"0.5rem",fontSize:"0.875rem",color:"#64748b"},children:[r.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[r.jsx("circle",{cx:"12",cy:"12",r:"10"}),r.jsx("line",{x1:"12",y1:"16",x2:"12",y2:"12"}),r.jsx("line",{x1:"12",y1:"8",x2:"12.01",y2:"8"})]}),r.jsx("span",{children:"You have read-only access to this page"})]}),r.jsx("div",{style:{flex:1},children:i})]})]})}function ks(){const i=ae(),[t]=qt(),[e,s]=d.useState(!1),[a,n]=d.useState(""),[o,c]=d.useState(""),[l,h]=d.useState(null),[m,g]=d.useState(null),[f,y]=d.useState(!1),[x,u]=d.useState(!1),[b,k]=d.useState(!1),[M,I]=d.useState(!1);d.useEffect(()=>{t.get("expired")==="true"&&(I(!0),window.history.replaceState({},document.title,"/login")),p.auth.getSession().then(({data:{session:j}})=>{j&&i("/dashboard",{replace:!0})});const{data:{subscription:S}}=p.auth.onAuthStateChange((j,T)=>{j==="SIGNED_IN"&&T&&i("/dashboard",{replace:!0})});return()=>S.unsubscribe()},[i,t]);const v=async S=>{S.preventDefault(),s(!0),h(null),g(null),I(!1);try{if(f){const{error:j}=await p.auth.signUp({email:a,password:o,options:{data:{full_name:a.split("@")[0]}}});if(j)throw j;g("Check your email for confirmation link!")}else{const{error:j}=await p.auth.signInWithPassword({email:a,password:o});if(j)throw j}}catch(j){h(j.message)}finally{s(!1)}},C=async S=>{if(S.preventDefault(),!a){h("Please enter your email address");return}s(!0),h(null),g(null);try{const{error:j}=await p.auth.resetPasswordForEmail(a,{redirectTo:`${window.location.origin}/reset-password`});if(j)throw j;g("Password reset email sent! Check your inbox.")}catch(j){h(j.message)}finally{s(!1)}},R=async S=>{if(S.preventDefault(),!a){h("Please enter your email address");return}s(!0),h(null),g(null);try{const{error:j}=await p.auth.resend({type:"signup",email:a});if(j)throw j;g("Verification email resent! Check your inbox.")}catch(j){h(j.message)}finally{s(!1)}},E=()=>{u(!1),k(!1),h(null),g(null),I(!1)};return x?r.jsx("div",{className:"auth-container",children:r.jsxs("div",{className:"auth-box",children:[r.jsxs("div",{className:"auth-logo",children:[r.jsx(dr,{size:40,style:{color:"var(--primary)",marginBottom:"0.5rem"}}),r.jsx("h1",{className:"auth-title",children:"Reset Password"}),r.jsx("p",{className:"auth-subtitle",children:"Enter your email to receive a reset link"})]}),r.jsxs("form",{onSubmit:C,children:[r.jsxs("div",{className:"form-group",children:[r.jsx("label",{className:"form-label",htmlFor:"email",children:"Email Address"}),r.jsx("input",{id:"email",className:"form-input",type:"email",placeholder:"you@example.com",value:a,onChange:S=>n(S.target.value),required:!0})]}),l&&r.jsxs("div",{style:{padding:"0.75rem",background:"#fee2e2",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#991b1b"},children:[r.jsx(ke,{size:20}),r.jsx("span",{style:{fontSize:"0.875rem"},children:l})]}),m&&r.jsxs("div",{style:{padding:"0.75rem",background:"#dcfce7",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#166534"},children:[r.jsx(Re,{size:20}),r.jsx("span",{style:{fontSize:"0.875rem"},children:m})]}),r.jsx("button",{type:"submit",className:"btn btn-primary",disabled:e,style:{width:"100%",justifyContent:"center"},children:e?"Sending...":"Send Reset Link"})]}),r.jsx("div",{style:{marginTop:"1.5rem",textAlign:"center"},children:r.jsx("button",{onClick:E,style:{background:"none",border:"none",color:"var(--primary)",cursor:"pointer",fontSize:"0.875rem"},children:"â† Back to Sign In"})})]})}):b?r.jsx("div",{className:"auth-container",children:r.jsxs("div",{className:"auth-box",children:[r.jsxs("div",{className:"auth-logo",children:[r.jsx(ue,{size:40,style:{color:"var(--primary)",marginBottom:"0.5rem"}}),r.jsx("h1",{className:"auth-title",children:"Resend Verification"}),r.jsx("p",{className:"auth-subtitle",children:"Enter your email to resend the verification link"})]}),r.jsxs("form",{onSubmit:R,children:[r.jsxs("div",{className:"form-group",children:[r.jsx("label",{className:"form-label",htmlFor:"email",children:"Email Address"}),r.jsx("input",{id:"email",className:"form-input",type:"email",placeholder:"you@example.com",value:a,onChange:S=>n(S.target.value),required:!0})]}),l&&r.jsxs("div",{style:{padding:"0.75rem",background:"#fee2e2",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#991b1b"},children:[r.jsx(ke,{size:20}),r.jsx("span",{style:{fontSize:"0.875rem"},children:l})]}),m&&r.jsxs("div",{style:{padding:"0.75rem",background:"#dcfce7",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#166534"},children:[r.jsx(Re,{size:20}),r.jsx("span",{style:{fontSize:"0.875rem"},children:m})]}),r.jsx("button",{type:"submit",className:"btn btn-primary",disabled:e,style:{width:"100%",justifyContent:"center"},children:e?"Sending...":"Resend Verification Email"})]}),r.jsx("div",{style:{marginTop:"1.5rem",textAlign:"center"},children:r.jsx("button",{onClick:E,style:{background:"none",border:"none",color:"var(--primary)",cursor:"pointer",fontSize:"0.875rem"},children:"â† Back to Sign In"})})]})}):r.jsx("div",{className:"auth-container",children:r.jsxs("div",{className:"auth-box",children:[r.jsxs("div",{className:"auth-logo",children:[r.jsx("h1",{className:"auth-title",children:"AMSF001 Tracker"}),r.jsx("p",{className:"auth-subtitle",children:"Network Architecture Services Project"})]}),M&&r.jsxs("div",{style:{padding:"0.75rem",background:"#fef3c7",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#92400e",border:"1px solid #fcd34d"},children:[r.jsx(te,{size:20}),r.jsx("span",{style:{fontSize:"0.875rem"},children:"Your session has expired. Please sign in again."})]}),r.jsxs("form",{onSubmit:v,children:[r.jsxs("div",{className:"form-group",children:[r.jsx("label",{className:"form-label",htmlFor:"email",children:"Email Address"}),r.jsx("input",{id:"email",className:"form-input",type:"email",placeholder:"you@example.com",value:a,onChange:S=>n(S.target.value),required:!0})]}),r.jsxs("div",{className:"form-group",children:[r.jsx("label",{className:"form-label",htmlFor:"password",children:"Password"}),r.jsx("input",{id:"password",className:"form-input",type:"password",placeholder:"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢",value:o,onChange:S=>c(S.target.value),required:!0})]}),l&&r.jsxs("div",{style:{padding:"0.75rem",background:"#fee2e2",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#991b1b"},children:[r.jsx(ke,{size:20}),r.jsx("span",{style:{fontSize:"0.875rem"},children:l})]}),m&&r.jsxs("div",{style:{padding:"0.75rem",background:"#dcfce7",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#166534"},children:[r.jsx(Re,{size:20}),r.jsx("span",{style:{fontSize:"0.875rem"},children:m})]}),r.jsx("button",{type:"submit",className:"btn btn-primary",disabled:e,style:{width:"100%",justifyContent:"center"},children:e?"Loading...":f?"Sign Up":"Sign In"})]}),!f&&r.jsx("div",{style:{marginTop:"1rem",textAlign:"center"},children:r.jsx("button",{onClick:()=>{u(!0),h(null),g(null),I(!1)},style:{background:"none",border:"none",color:"#64748b",cursor:"pointer",fontSize:"0.85rem",textDecoration:"underline"},children:"Forgot your password?"})}),r.jsx("div",{style:{marginTop:"1rem",textAlign:"center"},children:r.jsx("button",{onClick:()=>{y(!f),h(null),g(null),I(!1)},style:{background:"none",border:"none",color:"var(--primary)",cursor:"pointer",fontSize:"0.875rem"},children:f?"Already have an account? Sign In":"Don't have an account? Sign Up"})}),r.jsxs("div",{style:{marginTop:"1.5rem",paddingTop:"1rem",borderTop:"1px solid #e2e8f0",textAlign:"center"},children:[r.jsx("p",{style:{fontSize:"0.8rem",color:"#64748b",marginBottom:"0.5rem"},children:"Haven't received your verification email?"}),r.jsxs("button",{onClick:()=>{k(!0),h(null),g(null),I(!1)},style:{background:"none",border:"none",color:"var(--primary)",cursor:"pointer",fontSize:"0.85rem",display:"inline-flex",alignItems:"center",gap:"0.25rem"},children:[r.jsx(ue,{size:14})," Resend Verification Email"]})]})]})})}const Rs={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function Ns(i){return i==null?"":typeof i!="string"?String(i):i.replace(/[&<>"'`=\/]/g,t=>Rs[t])}function Be(i,t={}){const{maxLength:e=1e4,trim:s=!0,normalizeWhitespace:a=!0}=t;if(i==null)return"";typeof i!="string"&&(i=String(i));let n=i;return n=n.replace(/\0/g,""),n=n.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,""),s&&(n=n.trim()),a&&(n=n.replace(/[ \t]+/g," ")),n.length>e&&(n=n.substring(0,e)),n}function ye(i,t=255){return i==null?"":(typeof i!="string"&&(i=String(i)),Be(i,{maxLength:t}).replace(/[\r\n]/g," ").replace(/\s+/g," ").trim())}function Nt(i,t=1e4){return i==null?"":(typeof i!="string"&&(i=String(i)),Be(i,{maxLength:t,normalizeWhitespace:!1}).replace(/\r\n/g,`
`).replace(/\r/g,`
`).replace(/\n{3,}/g,`

`).trim())}function Pt(i){return i?ye(i,254).toLowerCase():""}function _e(i,t={}){const{min:e=-1/0,max:s=1/0,decimals:a=2}=t;if(i==null||i==="")return null;let n=String(i).replace(/[^0-9.\-]/g,""),o=parseFloat(n);return isNaN(o)?null:(o=Math.max(e,Math.min(s,o)),o=Math.round(o*Math.pow(10,a))/Math.pow(10,a),o)}function Ps(i){const t=_e(i,{min:0,decimals:2});return t!==null?Math.round(t*100)/100:null}function Is(i){const t=_e(i,{min:0,max:24,decimals:1});return t===null?null:Math.round(t*2)/2}function As(i){return _e(i,{min:0,max:100,decimals:1})}function Ds(i){if(!i)return null;const t=String(i).trim();return/^(javascript|data|vbscript):/i.test(t)?null:/^(https?:\/\/|\/|#)/i.test(t)?t:`https://${t}`}function Ms(i,t={}){if(!i||typeof i!="object")return i;const e={...i};for(const[s,a]of Object.entries(t)){if(e[s]===void 0)continue;const{type:n="text",maxLength:o}=a;switch(n){case"singleLine":e[s]=ye(e[s],o);break;case"multiLine":e[s]=Nt(e[s],o);break;case"email":e[s]=Pt(e[s]);break;case"number":e[s]=_e(e[s],a);break;case"currency":e[s]=Ps(e[s]);break;case"hours":e[s]=Is(e[s]);break;case"percentage":e[s]=As(e[s]);break;case"url":e[s]=Ds(e[s]);break;case"html":e[s]=Ns(e[s]);break;default:e[s]=Be(e[s],{maxLength:o})}}return e}const Ts={timesheet:{description:{type:"multiLine",maxLength:2e3},hours_worked:{type:"hours"}},expense:{reason:{type:"multiLine",maxLength:2e3},amount:{type:"currency"}},resource:{name:{type:"singleLine",maxLength:100},email:{type:"email"},role:{type:"singleLine",maxLength:100},notes:{type:"multiLine",maxLength:5e3}},partner:{name:{type:"singleLine",maxLength:200},contact_name:{type:"singleLine",maxLength:100},contact_email:{type:"email"},notes:{type:"multiLine",maxLength:5e3}},milestone:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3}},deliverable:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3}},kpi:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3},target_value:{type:"number",decimals:2},actual_value:{type:"number",decimals:2}},qualityStandard:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3},target_value:{type:"percentage"}}};function tt(i,t){const e=Ts[i];return e?Ms(t,e):t}class Y{constructor(t,e={}){this.tableName=t,this.supportsSoftDelete=e.supportsSoftDelete!==!1,this.sanitizeConfig=e.sanitizeConfig||null}getSoftDeleteFilter(){return this.supportsSoftDelete?"is_deleted.is.null,is_deleted.eq.false":null}async getAll(t,e={}){try{let s=e.select||"*";const a=this.supportsSoftDelete&&!e.includeDeleted;a&&s!=="*"&&!s.includes("is_deleted")&&(s=`${s}, is_deleted`);let n=p.from(this.tableName).select(s).eq("project_id",t);e.filters&&Array.isArray(e.filters)&&e.filters.forEach(h=>{const{column:m,operator:g,value:f}=h;switch(g){case"eq":n=n.eq(m,f);break;case"neq":n=n.neq(m,f);break;case"gt":n=n.gt(m,f);break;case"gte":n=n.gte(m,f);break;case"lt":n=n.lt(m,f);break;case"lte":n=n.lte(m,f);break;case"like":n=n.like(m,f);break;case"ilike":n=n.ilike(m,f);break;case"in":n=n.in(m,f);break;case"is":n=n.is(m,f);break;default:n=n.eq(m,f)}}),e.orderBy&&(n=n.order(e.orderBy.column,{ascending:e.orderBy.ascending??!0}));const{data:o,error:c}=await n;if(c)throw c;let l=o||[];return a&&(l=l.filter(h=>h.is_deleted!==!0)),l}catch(s){throw s}}async getDeleted(t){if(!this.supportsSoftDelete)return[];try{const{data:e,error:s}=await p.from(this.tableName).select("*").eq("project_id",t).eq("is_deleted",!0).order("deleted_at",{ascending:!1});if(s)throw s;return e||[]}catch(e){throw e}}async getById(t,e={}){try{let s=e.select||"*";const a=this.supportsSoftDelete&&!e.includeDeleted;a&&s!=="*"&&!s.includes("is_deleted")&&(s=`${s}, is_deleted`);let n=p.from(this.tableName).select(s).eq("id",t);const{data:o,error:c}=await n.limit(1);if(c)throw c;const l=o&&o.length>0?o[0]:null;return l&&a&&l.is_deleted===!0?null:l}catch(s){throw s}}async create(t){try{if(!t.project_id)throw new Error("project_id is required");let e=t;this.sanitizeConfig&&(e=tt(this.sanitizeConfig,t)),this.supportsSoftDelete&&(delete e.is_deleted,delete e.deleted_at,delete e.deleted_by);const{data:s,error:a}=await p.from(this.tableName).insert(e).select();if(a)throw a;if(!s||s.length===0)throw new Error("Failed to create record - no data returned");return s[0]}catch(e){throw e}}async update(t,e){try{let s=e;this.sanitizeConfig&&(s=tt(this.sanitizeConfig,e));const a={...s,updated_at:new Date().toISOString()};delete a.is_deleted,delete a.deleted_at,delete a.deleted_by;const{data:n,error:o}=await p.from(this.tableName).update(a).eq("id",t).select();if(o)throw o;if(!n||n.length===0)throw new Error(`No record found with id: ${t}`);return n[0]}catch(s){throw s}}async delete(t,e=null){try{if(this.supportsSoftDelete){const{error:s}=await p.from(this.tableName).update({is_deleted:!0,deleted_at:new Date().toISOString(),deleted_by:e}).eq("id",t);if(s)throw s}else{const{error:s}=await p.from(this.tableName).delete().eq("id",t);if(s)throw s}return!0}catch(s){throw s}}async hardDelete(t){try{const{error:e}=await p.from(this.tableName).delete().eq("id",t);if(e)throw e;return!0}catch(e){throw e}}async restore(t){if(!this.supportsSoftDelete)throw new Error("This entity does not support soft delete");try{const{data:e,error:s}=await p.from(this.tableName).update({is_deleted:!1,deleted_at:null,deleted_by:null}).eq("id",t).select();if(s)throw s;if(!e||e.length===0)throw new Error(`No record found with id: ${t}`);return e[0]}catch(e){throw e}}async exists(t){try{const{data:e,error:s}=await p.from(this.tableName).select("id, is_deleted").eq("id",t).limit(1);if(s)throw s;if(!e||e.length===0)return!1;const a=e[0];return!(this.supportsSoftDelete&&a.is_deleted===!0)}catch(e){throw e}}async count(t,e=[]){try{let s=p.from(this.tableName).select("id, is_deleted").eq("project_id",t);e.forEach(c=>{const{column:l,operator:h,value:m}=c;h==="eq"?s=s.eq(l,m):h==="in"&&(s=s.in(l,m))});const{data:a,error:n}=await s;if(n)throw n;let o=a||[];return this.supportsSoftDelete&&(o=o.filter(c=>c.is_deleted!==!0)),o.length}catch(s){throw s}}}class qs extends Y{constructor(){super("partners")}async getAll(t){return super.getAll(t,{orderBy:{column:"name",ascending:!0}})}async getActive(t){return super.getAll(t,{filters:[{column:"is_active",operator:"eq",value:!0}],orderBy:{column:"name",ascending:!0}})}async getWithResources(t){try{const{data:e,error:s}=await p.from("partners").select(`
          *,
          resources (
            id,
            name,
            sell_price,
            cost_price,
            is_active
          )
        `).eq("id",t).limit(1);if(s)throw s;return e?.[0]||null}catch(e){throw e}}async getSummary(t){try{const{data:e,error:s}=await p.from("partners").select(`
          id,
          name,
          contact_name,
          contact_email,
          payment_terms,
          is_active,
          created_at
        `).eq("project_id",t).order("name",{ascending:!0});if(s)throw s;return e||[]}catch(e){throw e}}async create(t){if(!t.name?.trim())throw new Error("Partner name is required");if(await this.findByName(t.project_id,t.name))throw new Error(`Partner "${t.name}" already exists`);return super.create({...t,name:t.name.trim(),is_active:t.is_active??!0,payment_terms:t.payment_terms||"Net 30"})}async findByName(t,e){try{const{data:s,error:a}=await p.from("partners").select("*").eq("project_id",t).ilike("name",e.trim()).limit(1);if(a)throw a;return s?.[0]||null}catch(s){throw s}}async toggleActive(t){const e=await this.getById(t);if(!e)throw new Error("Partner not found");return this.update(t,{is_active:!e.is_active})}async getForSelect(t,e=!0){return(e?await this.getActive(t):await this.getAll(t)).map(a=>({value:a.id,label:a.name}))}async getDependencyCounts(t){try{const{data:e,error:s}=await p.from("resources").select("id").eq("partner_id",t).or("is_deleted.is.null,is_deleted.eq.false");if(s)throw s;const a=e?.map(h=>h.id)||[];let n=0,o=0;if(a.length>0){const{count:h,error:m}=await p.from("timesheets").select("*",{count:"exact",head:!0}).in("resource_id",a).or("is_deleted.is.null,is_deleted.eq.false");if(m)throw m;n=h||0;const{count:g,error:f}=await p.from("expenses").select("*",{count:"exact",head:!0}).in("resource_id",a).or("is_deleted.is.null,is_deleted.eq.false");if(f)throw f;o=g||0}const{count:c,error:l}=await p.from("partner_invoices").select("*",{count:"exact",head:!0}).eq("partner_id",t).or("is_deleted.is.null,is_deleted.eq.false");if(l)throw l;return{resourceCount:e?.length||0,timesheetCount:n,expenseCount:o,invoiceCount:c||0,canDelete:!e?.length&&!c}}catch(e){throw e}}}const Ia=new qs;class Os extends Y{constructor(){super("resources",{sanitizeConfig:"resource",supportsSoftDelete:!0})}sanitizeData(t){const e={...t};return e.name&&(e.name=ye(e.name,100)),e.role&&(e.role=ye(e.role,100)),e.email&&(e.email=Pt(e.email)),e.notes&&(e.notes=Nt(e.notes,5e3)),e}async getAll(t,e={}){const{includePartner:s=!0,activeOnly:a=!1,showTestUsers:n=!0,includeDeleted:o=!1}=e;let c="*";s&&(c="*, partner:partners(id, name, is_active)");let l=p.from(this.tableName).select(c).eq("project_id",t).order("name");o||(l=l.or("is_deleted.is.null,is_deleted.eq.false")),a&&(l=l.eq("is_active",!0)),n||(l=l.or("is_test_content.is.null,is_test_content.eq.false"));const{data:h,error:m}=await l;if(m)throw m;return h||[]}async getAllFiltered(t,e=!0){return this.getAll(t,{showTestUsers:e,includePartner:!0})}async getById(t){const{data:e,error:s}=await p.from(this.tableName).select("*, partner:partners(id, name, contact_name, contact_email, is_active)").eq("id",t).or("is_deleted.is.null,is_deleted.eq.false").single();if(s)throw s;return e}async getByType(t,e){const{data:s,error:a}=await p.from(this.tableName).select("*, partner:partners(id, name)").eq("project_id",t).eq("resource_type",e).or("is_deleted.is.null,is_deleted.eq.false").order("name");if(a)throw a;return s||[]}async getByPartner(t){const{data:e,error:s}=await p.from(this.tableName).select("*").eq("partner_id",t).or("is_deleted.is.null,is_deleted.eq.false").order("name");if(s)throw s;return e||[]}async getWithTimesheetSummary(t){const e=await this.getById(t);if(!e)return null;const{data:s,error:a}=await p.from("timesheets").select("id, hours_worked, hours, status, was_rejected, date").eq("resource_id",t).or("is_deleted.is.null,is_deleted.eq.false");let n=0,o=0,c=0;return s&&s.forEach(l=>{const h=parseFloat(l.hours_worked||l.hours||0);n+=h,l.status==="Approved"?o+=h:l.status==="Submitted"&&!l.was_rejected&&(c+=h)}),{...e,timesheetSummary:{totalEntries:s?.length||0,totalHours:n,approvedHours:o,pendingHours:c,daysWorked:le(n)}}}async create(t){const e=this.sanitizeData(t);if(!e.name?.trim())throw new Error("Resource name is required");if(!e.project_id)throw new Error("Project ID is required");if(!e.email?.trim())throw new Error("Email is required");e.resource_type==="internal"&&(e.partner_id=null);const{data:s,error:a}=await p.from(this.tableName).insert([e]).select("*, partner:partners(id, name)").single();if(a)throw a;return s}async update(t,e){const s=this.sanitizeData(e);s.resource_type==="internal"&&(s.partner_id=null),s.updated_at=new Date().toISOString();const{data:a,error:n}=await p.from(this.tableName).update(s).eq("id",t).select("*, partner:partners(id, name)").single();if(n)throw n;return a}async delete(t,e=null){const{data:s,error:a}=await p.from(this.tableName).update({is_deleted:!0,deleted_at:new Date().toISOString(),deleted_by:e}).eq("id",t).select().single();if(a)throw a;return s}async restore(t){const{data:e,error:s}=await p.from(this.tableName).update({is_deleted:!1,deleted_at:null,deleted_by:null}).eq("id",t).select().single();if(s)throw s;return e}async linkToPartner(t,e){const s={partner_id:e,resource_type:e?"third_party":"internal",updated_at:new Date().toISOString()};return this.update(t,s)}async toggleActive(t){const e=await this.getById(t);if(!e)throw new Error("Resource not found");return this.update(t,{is_active:!e.is_active})}async getForSelect(t){const{data:e,error:s}=await p.from(this.tableName).select("id, name, resource_type, role").eq("project_id",t).or("is_deleted.is.null,is_deleted.eq.false").order("name");if(s)throw s;return e||[]}calculateMargin(t,e){if(!t||t===0||!e)return{percent:null,amount:null,status:"unknown"};const s=(t-e)/t*100,a=t-e;let n="critical";return s>=25?n="good":s>=10&&(n="low"),{percent:s,amount:a,status:n}}async getUtilization(t){const e=await this.getWithTimesheetSummary(t);if(!e)return null;const s=e.days_allocated||0,a=e.timesheetSummary.daysWorked,n=Math.max(0,s-a),o=s>0?a/s*100:0;return{resourceId:t,resourceName:e.name,daysAllocated:s,daysUsed:a,remaining:n,utilizationPercent:o,totalValue:(e.sell_price||0)*s,valueUsed:(e.sell_price||0)*a}}async getSummary(t){const e=await this.getAll(t,{includePartner:!1});return{total:e.length,internal:e.filter(s=>s.resource_type==="internal").length,thirdParty:e.filter(s=>s.resource_type==="third_party").length,active:e.filter(s=>s.is_active).length,totalBudget:e.reduce((s,a)=>s+(a.sell_price||0)*(a.days_allocated||0),0)}}async getProfileByEmail(t){try{const{data:e,error:s}=await this.supabase.from("profiles").select("id, email, full_name, role").eq("email",t).single();if(s){if(s.code==="PGRST116")return null;throw s}return e}catch(e){throw e}}async getAllWithTestFilter(t,e=[]){try{const s=await this.getAll(t,{orderBy:{column:"name",ascending:!0}});return e&&e.length>0?s.filter(a=>!a.user_id||!e.includes(a.user_id)):s}catch(s){throw s}}async getDependencyCounts(t){try{const[e,s]=await Promise.all([this.supabase.from("timesheets").select("id",{count:"exact",head:!0}).eq("resource_id",t).or("is_deleted.is.null,is_deleted.eq.false"),this.supabase.from("expenses").select("id",{count:"exact",head:!0}).eq("resource_id",t).or("is_deleted.is.null,is_deleted.eq.false")]);return{timesheetCount:e.count||0,expenseCount:s.count||0,canDelete:(e.count||0)===0&&(s.count||0)===0}}catch(e){throw e}}}const Aa=new Os;class Ls extends Y{constructor(){super("timesheets",{supportsSoftDelete:!0,sanitizeConfig:"timesheet"})}async getAll(t,e={}){return super.getAll(t,{...e,select:e.select||`
      *,
      resources(id, name, email, sell_price, cost_price),
      milestones(id, milestone_ref, name)
    `,orderBy:e.orderBy||{column:"date",ascending:!1}})}async getAllFiltered(t,e=!1){try{let s=p.from(this.tableName).select(`
          *,
          resources(id, name, email, sell_price, cost_price),
          milestones(id, milestone_ref, name)
        `).eq("project_id",t).order("date",{ascending:!1});this.supportsSoftDelete&&(s=s.or(this.getSoftDeleteFilter())),e||(s=s.or("is_test_content.is.null,is_test_content.eq.false"));const{data:a,error:n}=await s;if(n)throw n;return a||[]}catch(s){throw s}}async getByResource(t,e={}){try{let s=p.from(this.tableName).select("*, milestones(id, milestone_ref, name)").eq("resource_id",t).order("date",{ascending:!1});this.supportsSoftDelete&&(s=s.or(this.getSoftDeleteFilter())),e.start&&(s=s.gte("date",e.start)),e.end&&(s=s.lte("date",e.end)),e.status&&(s=s.eq("status",e.status));const{data:a,error:n}=await s;if(n)throw n;return a||[]}catch(s){throw s}}async getByPartner(t,e={}){try{const{data:s}=await p.from("resources").select("id, name, cost_price").eq("partner_id",t).or("is_deleted.is.null,is_deleted.eq.false");if(!s||s.length===0)return[];const a=s.map(l=>l.id);let n=p.from(this.tableName).select("*, resources(id, name, cost_price), milestones(id, milestone_ref, name)").in("resource_id",a).order("date",{ascending:!1});this.supportsSoftDelete&&(n=n.or(this.getSoftDeleteFilter())),e.start&&(n=n.gte("date",e.start)),e.end&&(n=n.lte("date",e.end)),e.status&&(n=n.eq("status",e.status));const{data:o,error:c}=await n;if(c)throw c;return o||[]}catch(s){throw s}}async getApprovedForInvoice(t,e){if(!e.start||!e.end)throw new Error("Date range (start and end) is required for invoice queries");return this.getByPartner(t,{...e,status:"Approved"})}async getSummary(t,e={}){try{const s=await this.getAll(t,e),a={totalHours:0,totalDays:0,approvedHours:0,pendingHours:0,draftHours:0,rejectedHours:0,totalCost:0,approvedCost:0,byStatus:{Draft:{count:0,hours:0},Submitted:{count:0,hours:0},Approved:{count:0,hours:0},Rejected:{count:0,hours:0}},byMilestone:{},count:s.length};return s.forEach(n=>{const o=parseFloat(n.hours_worked||n.hours||0),c=n.resources?.cost_price||0,l=Xe(o,c);switch(a.totalHours+=o,a.totalCost+=l,a.byStatus[n.status]&&(a.byStatus[n.status].count++,a.byStatus[n.status].hours+=o),n.status){case"Approved":a.approvedHours+=o,a.approvedCost+=l;break;case"Submitted":n.was_rejected||(a.pendingHours+=o);break;case"Draft":a.draftHours+=o;break;case"Rejected":a.rejectedHours+=o;break}if(n.milestone_id){const h=n.milestones?.milestone_ref||"Unknown";a.byMilestone[n.milestone_id]||(a.byMilestone[n.milestone_id]={ref:h,name:n.milestones?.name||"Unknown",hours:0,cost:0}),a.byMilestone[n.milestone_id].hours+=o,a.byMilestone[n.milestone_id].cost+=l}}),a.totalDays=le(a.totalHours),a}catch(s){throw s}}async create(t){if(!t.resource_id)throw new Error("resource_id is required");if(!t.date)throw new Error("date is required");const e=parseFloat(t.hours_worked||t.hours||0);if(!e||e<=0)throw new Error("hours must be greater than 0");const s={...t,hours_worked:e,hours:e,date:t.date||t.work_date,work_date:t.work_date||t.date,description:t.description||t.comments||"",comments:t.comments||t.description||"",status:t.status||"Draft"};return super.create(s)}async submit(t){return this.update(t,{status:"Submitted"})}async validate(t){return this.update(t,{status:"Approved"})}async approve(t){return this.validate(t)}async reject(t,e=null){const s={status:"Rejected",was_rejected:!0};return e&&(s.rejection_reason=e),this.update(t,s)}calculateCost(t,e){return Xe(t,e)}calculateBillable(t,e){return Et(t,e)}}const zs=new Ls;class Bs extends Y{constructor(){super("expenses",{supportsSoftDelete:!0,sanitizeConfig:"expense"})}async getAll(t,e={}){return super.getAll(t,{...e,select:e.select||"*, expense_files(*)",orderBy:e.orderBy||{column:"expense_date",ascending:!1}})}async getAllFiltered(t,e=!1){try{let s=p.from(this.tableName).select("*, expense_files(*)").eq("project_id",t).order("expense_date",{ascending:!1});const{data:a,error:n}=await s;if(n)throw n;let o=a||[];return this.supportsSoftDelete&&(o=o.filter(c=>c.is_deleted!==!0)),e||(o=o.filter(c=>c.is_test_content!==!0)),o}catch(s){throw s}}async getByResource(t,e={}){try{let s=p.from(this.tableName).select("*, expense_files(*)").eq("resource_id",t).order("expense_date",{ascending:!1});e.start&&(s=s.gte("expense_date",e.start)),e.end&&(s=s.lte("expense_date",e.end));const{data:a,error:n}=await s;if(n)throw n;let o=a||[];return this.supportsSoftDelete&&(o=o.filter(c=>c.is_deleted!==!0)),o}catch(s){throw s}}async getByPartner(t,e={}){try{const{data:s}=await p.from("resources").select("id").eq("partner_id",t);if(!s||s.length===0)return[];const a=s.map(h=>h.id);let n=p.from(this.tableName).select("*, expense_files(*)").in("resource_id",a).order("expense_date",{ascending:!1});e.start&&(n=n.gte("expense_date",e.start)),e.end&&(n=n.lte("expense_date",e.end)),e.procurementMethod&&(n=n.eq("procurement_method",e.procurementMethod));const{data:o,error:c}=await n;if(c)throw c;let l=o||[];return this.supportsSoftDelete&&(l=l.filter(h=>h.is_deleted!==!0)),l}catch(s){throw s}}async getPartnerProcuredForInvoice(t,e){if(!e.start||!e.end)throw new Error("Date range (start and end) is required for invoice queries");return this.getByPartner(t,{...e,procurementMethod:"partner"})}async getSummary(t,e={}){try{const s=await this.getAll(t,e),a={total:0,chargeable:0,nonChargeable:0,supplierProcured:0,partnerProcured:0,byCategory:{Travel:0,Accommodation:0,Sustenance:0},byStatus:{Draft:0,Submitted:0,Approved:0,Rejected:0,Paid:0},count:s.length};return s.forEach(n=>{const o=parseFloat(n.amount||0);a.total+=o,n.chargeable_to_customer!==!1?a.chargeable+=o:a.nonChargeable+=o,n.procurement_method==="partner"?a.partnerProcured+=o:a.supplierProcured+=o,a.byCategory[n.category]!==void 0&&(a.byCategory[n.category]+=o),a.byStatus[n.status]!==void 0&&(a.byStatus[n.status]+=o)}),a}catch(s){throw s}}async create(t){if(!t.resource_id)throw new Error("resource_id is required");if(!t.category)throw new Error("category is required");if(!t.amount||t.amount<=0)throw new Error("amount must be greater than 0");const e={...t,status:t.status||"Draft",chargeable_to_customer:t.chargeable_to_customer??!0,procurement_method:t.procurement_method||"supplier"};return super.create(e)}async createMany(t){if(!t||t.length===0)return[];try{const e=t.map(n=>{if(!n.resource_id)throw new Error("resource_id is required for all expenses");if(!n.category)throw new Error("category is required for all expenses");if(!n.amount||n.amount<=0)throw new Error("amount must be greater than 0 for all expenses");return{...n,status:n.status||"Draft",chargeable_to_customer:n.chargeable_to_customer??!0,procurement_method:n.procurement_method||"supplier"}}),{data:s,error:a}=await p.from(this.tableName).insert(e).select();if(a)throw a;return s||[]}catch(e){throw e}}async submit(t){return this.update(t,{status:"Submitted"})}async validate(t){return this.update(t,{status:"Approved"})}async approve(t){return this.validate(t)}async reject(t,e=null){const s={status:"Rejected"};return e&&(s.rejection_reason=e),this.update(t,s)}async markPaid(t){return this.update(t,{status:"Paid"})}async uploadReceipt(t,e,s){try{const a=`${t}/${Date.now()}-${e.name}`,{error:n}=await p.storage.from("receipts").upload(a,e);if(n)throw n;const{data:o,error:c}=await p.from("expense_files").insert({expense_id:t,file_name:e.name,file_path:a,file_size:e.size,file_type:e.type,uploaded_by:s}).select();if(c)throw c;return o?.[0]}catch(a){throw a}}async downloadReceipt(t){try{const{data:e,error:s}=await p.storage.from("receipts").download(t);if(s)throw s;return e}catch(e){throw e}}}const Us=new Bs;class Ws extends Y{constructor(){super("partner_invoices")}async getAll(t,e={}){return super.getAll(t,{...e,select:e.select||"*, partners(name)",orderBy:e.orderBy||{column:"invoice_date",ascending:!1}})}async getByPartner(t,e={}){try{let s=p.from(this.tableName).select("*").eq("partner_id",t).order("invoice_date",{ascending:!1});e.status&&(s=s.eq("status",e.status));const{data:a,error:n}=await s;if(n)throw n;return a||[]}catch(s){throw s}}async getWithLines(t){try{const{data:e,error:s}=await p.from(this.tableName).select("*, partners(name, contact_name, contact_email, payment_terms)").eq("id",t).limit(1);if(s)throw s;const a=e?.[0];if(!a)return null;const{data:n,error:o}=await p.from("partner_invoice_lines").select("*").eq("invoice_id",t).order("line_type",{ascending:!0}).order("resource_name",{ascending:!0}).order("line_date",{ascending:!0});if(o)throw o;const c={timesheets:(n||[]).filter(l=>l.line_type==="timesheet"),supplierExpenses:(n||[]).filter(l=>l.line_type==="supplier_expense"),partnerExpenses:(n||[]).filter(l=>l.line_type==="expense")};return{...a,lines:n||[],groupedLines:c}}catch(e){throw e}}async generateInvoiceNumber(t){try{const s=`INV-${new Date().getFullYear()}-`,{data:a,error:n}=await p.from(this.tableName).select("invoice_number").eq("project_id",t).like("invoice_number",`${s}%`).order("invoice_number",{ascending:!1}).limit(1);if(n)throw n;let o=1;if(a&&a.length>0){const c=a[0].invoice_number,l=parseInt(c.replace(s,""),10);isNaN(l)||(o=l+1)}return`${s}${String(o).padStart(3,"0")}`}catch(e){throw e}}async generateInvoice(t){const{projectId:e,partnerId:s,periodStart:a,periodEnd:n,createdBy:o,notes:c,includeSubmitted:l=!0}=t;try{const{data:h,error:m}=await p.from("resources").select("id, name, cost_price").eq("partner_id",s);if(m)throw m;if(!h||h.length===0)throw new Error("No resources linked to this partner");const g=h.map(_=>_.id),f={};h.forEach(_=>{f[_.id]=_});const y=l?["Approved","Submitted"]:["Approved"],{data:x,error:u}=await p.from("timesheets").select("id, date, hours_worked, hours, status, resource_id").in("resource_id",g).gte("date",a).lte("date",n).in("status",y);if(u)throw u;const{data:b,error:k}=await p.from("expenses").select("id, expense_date, category, reason, amount, resource_id, resource_name, procurement_method, chargeable_to_customer, status").in("resource_id",g).gte("expense_date",a).lte("expense_date",n).in("status",["Approved","Submitted","Paid"]);if(k)throw k;const M=(b||[]).filter(_=>_.procurement_method==="partner"||!_.procurement_method),I=(b||[]).filter(_=>_.procurement_method==="supplier");let v=0,C=0;const R=[],E={};(x||[]).forEach(_=>{E[_.resource_id]||(E[_.resource_id]=[]),E[_.resource_id].push(_)}),Object.keys(E).forEach(_=>{const L=f[_];E[_].forEach(F=>{const me=parseFloat(F.hours_worked||F.hours||0),ve=L?.cost_price||0,Ue=le(me),Se=Ue*ve;v+=Se,C+=Se,R.push({line_type:"timesheet",timesheet_id:F.id,expense_id:null,description:`${L?.name||"Unknown"} - ${me}h (${Ue.toFixed(2)} days)`,quantity:me,unit_price:ve,line_total:Se,resource_name:L?.name,line_date:F.date,hours:me,cost_price:ve,source_status:F.status,chargeable_to_customer:!0,procurement_method:null,expense_category:null})})});let S=0,j=0,T=0;const A=[];M.forEach(_=>{const L=parseFloat(_.amount||0);S+=L,_.chargeable_to_customer?j+=L:T+=L,A.push({line_type:"expense",timesheet_id:null,expense_id:_.id,description:`${_.resource_name} - ${_.category}: ${_.reason}`,quantity:1,unit_price:L,line_total:L,resource_name:_.resource_name,line_date:_.expense_date,hours:null,cost_price:null,source_status:_.status,chargeable_to_customer:_.chargeable_to_customer,procurement_method:"partner",expense_category:_.category})});let P=0,V=0,J=0;const ie=[];I.forEach(_=>{const L=parseFloat(_.amount||0);P+=L,_.chargeable_to_customer?V+=L:J+=L,ie.push({line_type:"supplier_expense",timesheet_id:null,expense_id:_.id,description:`${_.resource_name} - ${_.category}: ${_.reason}`,quantity:1,unit_price:L,line_total:L,resource_name:_.resource_name,line_date:_.expense_date,hours:null,cost_price:null,source_status:_.status,chargeable_to_customer:_.chargeable_to_customer,procurement_method:"supplier",expense_category:_.category})});const N=v+S,U=C+j+V,Z=T+J,X=await this.generateInvoiceNumber(e),{data:W,error:$}=await p.from(this.tableName).insert({project_id:e,partner_id:s,invoice_number:X,invoice_date:new Date().toISOString().split("T")[0],period_start:a,period_end:n,timesheet_total:v,expense_total:S,supplier_expense_total:P,invoice_total:N,chargeable_total:U,non_chargeable_total:Z,status:"Draft",notes:c||null,created_by:o}).select().single();if($)throw $;const D=[...R,...A,...ie].map(_=>({..._,invoice_id:W.id}));if(D.length>0){const{error:_}=await p.from("partner_invoice_lines").insert(D);if(_)throw _}return this.getWithLines(W.id)}catch(h){throw h}}async updateStatus(t,e){const s={status:e};return e==="Sent"?s.sent_at=new Date().toISOString():e==="Paid"&&(s.paid_at=new Date().toISOString()),this.update(t,s)}async markSent(t){return this.updateStatus(t,"Sent")}async markPaid(t){return this.updateStatus(t,"Paid")}async cancel(t){return this.updateStatus(t,"Cancelled")}async getPartnerStats(t){try{const{data:e,error:s}=await p.from(this.tableName).select("status, invoice_total").eq("partner_id",t);if(s)throw s;const a={total:0,draft:0,sent:0,paid:0,cancelled:0,count:e?.length||0};return(e||[]).forEach(n=>{const o=parseFloat(n.invoice_total||0);switch(a.total+=o,n.status){case"Draft":a.draft+=o;break;case"Sent":a.sent+=o;break;case"Paid":a.paid+=o;break;case"Cancelled":a.cancelled+=o;break}}),a}catch(e){throw e}}}const Da=new Ws;class $s extends Y{constructor(){super("milestones",{supportsSoftDelete:!0,sanitizeConfig:"milestone"})}async getAllWithStats(t){try{const e=await this.getAll(t,{orderBy:{column:"start_date",ascending:!0}}),{data:s}=await p.from("timesheets").select("milestone_id, hours_worked").eq("project_id",t).not("milestone_id","is",null).or("is_deleted.is.null,is_deleted.eq.false"),a={};return(s||[]).forEach(n=>{a[n.milestone_id]||(a[n.milestone_id]=0),a[n.milestone_id]+=parseFloat(n.hours_worked||0)}),e.map(n=>({...n,logged_hours:a[n.id]||0,logged_days:le(a[n.id]||0)}))}catch(e){throw e}}async getWithDeliverables(t){try{const{data:e,error:s}=await p.from(this.tableName).select("*").eq("id",t).or(this.getSoftDeleteFilter()).limit(1);if(s)throw s;const a=e?.[0],{data:n,error:o}=await p.from("deliverables").select("*").eq("milestone_id",t).or("is_deleted.is.null,is_deleted.eq.false").order("due_date",{ascending:!0});if(o)throw o;return{...a,deliverables:n||[]}}catch(e){throw e}}async getByStatus(t,e){return this.getAll(t,{filters:[{column:"status",operator:"eq",value:e}],orderBy:{column:"start_date",ascending:!0}})}async getUpcoming(t,e=30){try{const s=new Date().toISOString().split("T")[0],a=new Date;a.setDate(a.getDate()+e);const n=a.toISOString().split("T")[0];let o=p.from(this.tableName).select("*").eq("project_id",t).gte("end_date",s).lte("end_date",n).neq("status","Completed").order("end_date",{ascending:!0});this.supportsSoftDelete&&(o=o.or(this.getSoftDeleteFilter()));const{data:c,error:l}=await o;if(l)throw l;return c||[]}catch(s){throw s}}async updateStatus(t,e){return this.update(t,{status:e})}async updateCompletion(t,e){const s={completion_percentage:e};return e>=100&&(s.status="Completed"),this.update(t,s)}async getSummary(t){try{const e=await this.getAll(t),s={total:e.length,completed:0,inProgress:0,notStarted:0,overdue:0,upcoming:0},a=new Date().toISOString().split("T")[0],n=new Date;n.setDate(n.getDate()+7);const o=n.toISOString().split("T")[0];return e.forEach(c=>{c.status==="Completed"?s.completed++:c.status==="In Progress"?(s.inProgress++,c.end_date<a&&s.overdue++):c.status==="Not Started"&&(s.notStarted++,c.start_date<=o&&s.upcoming++)}),s}catch(e){throw e}}async getCertificates(t){try{const{data:e,error:s}=await p.from("milestone_certificates").select("*").eq("project_id",t).order("created_at",{ascending:!1});if(s)throw s;return e||[]}catch(e){throw e}}async createCertificate(t){try{const{data:e,error:s}=await p.from("milestone_certificates").insert([t]).select();if(s)throw s;return e?.[0]}catch(e){throw e}}async updateCertificate(t,e){try{const{data:s,error:a}=await p.from("milestone_certificates").update(e).eq("id",t).select();if(a)throw a;return s?.[0]}catch(s){throw s}}}const rt=new $s;class Fs extends Y{constructor(){super("deliverables",{supportsSoftDelete:!0,sanitizeConfig:"deliverable"})}async getAllWithMilestones(t){return this.getAll(t,{select:"*, milestones(name, milestone_ref)",orderBy:{column:"due_date",ascending:!0}})}async getByMilestone(t){try{let e=p.from(this.tableName).select("*").eq("milestone_id",t).order("due_date",{ascending:!0});this.supportsSoftDelete&&(e=e.or(this.getSoftDeleteFilter()));const{data:s,error:a}=await e;if(a)throw a;return s||[]}catch(e){throw e}}async getByStatus(t,e){return this.getAll(t,{filters:[{column:"status",operator:"eq",value:e}],orderBy:{column:"due_date",ascending:!0}})}async getOverdue(t){try{const e=new Date().toISOString().split("T")[0];let s=p.from(this.tableName).select("*, milestones(name)").eq("project_id",t).lt("due_date",e).not("status","in",'("Delivered","Cancelled")').order("due_date",{ascending:!0});this.supportsSoftDelete&&(s=s.or(this.getSoftDeleteFilter()));const{data:a,error:n}=await s;if(n)throw n;return a||[]}catch(e){throw e}}async getUpcoming(t,e=14){try{const s=new Date().toISOString().split("T")[0],a=new Date;a.setDate(a.getDate()+e);const n=a.toISOString().split("T")[0];let o=p.from(this.tableName).select("*, milestones(name)").eq("project_id",t).gte("due_date",s).lte("due_date",n).not("status","eq","Delivered").order("due_date",{ascending:!0});this.supportsSoftDelete&&(o=o.or(this.getSoftDeleteFilter()));const{data:c,error:l}=await o;if(l)throw l;return c||[]}catch(s){throw s}}async updateStatus(t,e,s){const a={status:e};return e==="Submitted"?(a.submitted_date=new Date().toISOString(),a.submitted_by=s):e==="Delivered"&&(a.delivered_date=new Date().toISOString(),a.delivered_by=s),this.update(t,a)}async submit(t,e){return this.updateStatus(t,"Submitted",e)}async markDelivered(t,e){return this.updateStatus(t,"Delivered",e)}async reject(t,e){return this.update(t,{status:"Rejected",rejection_reason:e})}async getSummary(t){try{const e=await this.getAll(t),s=new Date().toISOString().split("T")[0],a={total:e.length,delivered:0,inProgress:0,notStarted:0,overdue:0,dueThisWeek:0},n=new Date;n.setDate(n.getDate()+7);const o=n.toISOString().split("T")[0];return e.forEach(c=>{c.status==="Delivered"?a.delivered++:c.status==="In Progress"?(a.inProgress++,c.due_date<s?a.overdue++:c.due_date<=o&&a.dueThisWeek++):(c.status==="Not Started"||c.status==="Draft")&&(a.notStarted++,c.due_date<s&&a.overdue++)}),a}catch(e){throw e}}async getAllWithRelations(t,e=!1){try{let s=p.from("deliverables").select(`
          *,
          milestones(milestone_ref, name),
          deliverable_kpis(kpi_id, kpis(kpi_ref, name)),
          deliverable_quality_standards(quality_standard_id, quality_standards(qs_ref, name))
        `).eq("project_id",t).or("is_deleted.is.null,is_deleted.eq.false").order("deliverable_ref");e||(s=s.or("is_test_content.is.null,is_test_content.eq.false"));const{data:a,error:n}=await s;if(n)throw n;return a||[]}catch(s){throw s}}async syncKPILinks(t,e=[]){try{const{error:s}=await p.from("deliverable_kpis").delete().eq("deliverable_id",t);if(s)throw s;if(e.length>0){const a=e.map(o=>({deliverable_id:t,kpi_id:o})),{error:n}=await p.from("deliverable_kpis").insert(a);if(n)throw n}return!0}catch(s){throw s}}async syncQSLinks(t,e=[]){try{const{error:s}=await p.from("deliverable_quality_standards").delete().eq("deliverable_id",t);if(s)throw s;if(e.length>0){const a=e.map(o=>({deliverable_id:t,quality_standard_id:o})),{error:n}=await p.from("deliverable_quality_standards").insert(a);if(n)throw n}return!0}catch(s){throw s}}async upsertKPIAssessments(t,e,s){try{const a=e.map(o=>({deliverable_id:t,kpi_id:o.kpiId,criteria_met:o.criteriaMet,assessed_at:new Date().toISOString(),assessed_by:s})),{error:n}=await p.from("deliverable_kpi_assessments").upsert(a,{onConflict:"deliverable_id,kpi_id"});if(n)throw n;return!0}catch(a){throw a}}async upsertQSAssessments(t,e,s){try{const a=e.map(o=>({deliverable_id:t,quality_standard_id:o.qsId,criteria_met:o.criteriaMet,assessed_at:new Date().toISOString(),assessed_by:s})),{error:n}=await p.from("deliverable_qs_assessments").upsert(a,{onConflict:"deliverable_id,quality_standard_id"});if(n)throw n;return!0}catch(a){throw a}}}const It=new Fs;class Vs extends Y{constructor(){super("kpis")}async getAllWithStatus(t){try{return(await this.getAll(t,{orderBy:{column:"name",ascending:!0}})).map(s=>({...s,rag_status:this.calculateRAG(s)}))}catch(e){throw e}}calculateRAG(t){if(!t.target_value||t.actual_value===null||t.actual_value===void 0)return"Unknown";const e=parseFloat(t.actual_value),s=parseFloat(t.target_value),a=parseFloat(t.threshold_amber||10);return t.trend==="higher_better"?e>=s?"Green":e>=s*(1-a/100)?"Amber":"Red":e<=s?"Green":e<=s*(1+a/100)?"Amber":"Red"}async getByRAGStatus(t,e){try{return(await this.getAllWithStatus(t)).filter(a=>a.rag_status===e)}catch(s){throw s}}async getNeedingAttention(t){try{return(await this.getAllWithStatus(t)).filter(s=>s.rag_status==="Amber"||s.rag_status==="Red")}catch(e){throw e}}async updateActualValue(t,e){return this.update(t,{actual_value:e,last_updated:new Date().toISOString()})}async getHistory(t,e=12){try{const{data:s,error:a}=await p.from("kpi_history").select("*").eq("kpi_id",t).order("recorded_at",{ascending:!1}).limit(e);if(a)throw a;return s||[]}catch{return[]}}async getSummary(t){try{const e=await this.getAllWithStatus(t);return{total:e.length,green:e.filter(s=>s.rag_status==="Green").length,amber:e.filter(s=>s.rag_status==="Amber").length,red:e.filter(s=>s.rag_status==="Red").length,unknown:e.filter(s=>s.rag_status==="Unknown").length}}catch(e){throw e}}async getAssessments(t){try{const{data:e,error:s}=await p.from("deliverable_kpi_assessments").select(`
          kpi_id,
          criteria_met,
          deliverables!inner(id, status, is_deleted, project_id)
        `).eq("deliverables.project_id",t);return s?await this.getAssessmentsFallback(t):(e||[]).filter(n=>n.deliverables?.is_deleted!==!0&&H.deliverables.contributeToKPIs.includes(n.deliverables?.status))}catch{return[]}}async getAssessmentsFallback(t){try{const{data:e,error:s}=await p.from("deliverable_kpi_assessments").select("kpi_id, criteria_met, deliverable_id");if(s)throw s;const{data:a,error:n}=await p.from("deliverables").select("id, status, is_deleted").eq("project_id",t);if(n)throw n;const o=new Set((a||[]).filter(l=>l.is_deleted!==!0&&H.deliverables.contributeToKPIs.includes(l.status)).map(l=>l.id));return(e||[]).filter(l=>o.has(l.deliverable_id))}catch{return[]}}}const Ma=new Vs;class Hs extends Y{constructor(){super("quality_standards")}async getAllWithStatus(t){try{return(await this.getAll(t,{orderBy:{column:"name",ascending:!0}})).map(s=>({...s,compliance_status:this.calculateCompliance(s)}))}catch(e){throw e}}calculateCompliance(t){if(t.actual_value===null||t.actual_value===void 0)return"Not Measured";const e=parseFloat(t.actual_value),s=parseFloat(t.target_value||0);return e>=s?"Compliant":e>=s*.9?"Near Compliant":"Non-Compliant"}async getNonCompliant(t){try{return(await this.getAllWithStatus(t)).filter(s=>s.compliance_status==="Non-Compliant")}catch(e){throw e}}async updateMeasurement(t,e,s){return this.update(t,{actual_value:e,measurement_notes:s,last_measured:new Date().toISOString()})}async getSummary(t){try{const e=await this.getAllWithStatus(t);return{total:e.length,compliant:e.filter(s=>s.compliance_status==="Compliant").length,nearCompliant:e.filter(s=>s.compliance_status==="Near Compliant").length,nonCompliant:e.filter(s=>s.compliance_status==="Non-Compliant").length,notMeasured:e.filter(s=>s.compliance_status==="Not Measured").length}}catch(e){throw e}}async getAssessments(t){try{const{data:e,error:s}=await p.from("deliverable_qs_assessments").select(`
          quality_standard_id,
          criteria_met,
          deliverables!inner(id, status, is_deleted, project_id)
        `).eq("deliverables.project_id",t);return s?await this.getAssessmentsFallback(t):(e||[]).filter(n=>n.deliverables?.is_deleted!==!0&&H.deliverables.contributeToQS.includes(n.deliverables?.status))}catch{return[]}}async getAssessmentsFallback(t){try{const{data:e,error:s}=await p.from("deliverable_qs_assessments").select("quality_standard_id, criteria_met, deliverable_id");if(s)throw s;const{data:a,error:n}=await p.from("deliverables").select("id, status, is_deleted").eq("project_id",t);if(n)throw n;const o=new Set((a||[]).filter(l=>l.is_deleted!==!0&&H.deliverables.contributeToQS.includes(l.status)).map(l=>l.id));return(e||[]).filter(l=>o.has(l.deliverable_id))}catch{return[]}}async getAllWithCalculatedValues(t){try{const e=await this.getAll(t,{orderBy:{column:"qs_ref",ascending:!0}}),s=await this.getAssessments(t),a={};return s.forEach(n=>{a[n.quality_standard_id]||(a[n.quality_standard_id]={total:0,met:0}),a[n.quality_standard_id].total++,n.criteria_met&&a[n.quality_standard_id].met++}),e.map(n=>{const o=a[n.id],c=o&&o.total>0?Math.round(o.met/o.total*100):0,l=n.target||100,h=c>=l;return{...n,calculatedValue:c,assessmentCount:o?.total||0,assessmentsMet:o?.met||0,isAchieved:h}})}catch(e){throw e}}}const Ta=new Hs;class Ks extends Y{constructor(){super("standards",{supportsSoftDelete:!1,sanitizeConfig:"standard"})}async getAll(t){return super.getAll(t,{orderBy:{column:"standard_ref",ascending:!0}})}async getByStatus(t,e){return super.getAll(t,{filters:[{column:"status",operator:"eq",value:e}],orderBy:{column:"standard_ref",ascending:!0}})}async getByCategory(t,e){return super.getAll(t,{filters:[{column:"category",operator:"eq",value:e}],orderBy:{column:"standard_ref",ascending:!0}})}async getSummary(t){try{const e=await this.getAll(t);return{total:e.length,completed:e.filter(s=>s.status==="Completed").length,inProgress:e.filter(s=>s.status==="In Progress").length,notStarted:e.filter(s=>!s.status||s.status==="Not Started").length}}catch(e){throw e}}}new Ks;const Gs={version:"2.0",widgets:{"progress-hero":{visible:!0,x:0,y:0,w:12,h:2,minW:6,minH:2,maxH:3},"budget-summary":{visible:!1,x:0,y:2,w:6,h:2,minW:4,minH:2,maxH:3},"pmo-tracking":{visible:!1,x:6,y:2,w:6,h:2,minW:6,minH:2,maxH:4},"stats-grid":{visible:!0,x:0,y:2,w:12,h:2,minW:8,minH:2,maxH:3},certificates:{visible:!1,x:0,y:4,w:12,h:2,minW:6,minH:2,maxH:3},"milestones-list":{visible:!0,x:0,y:4,w:12,h:4,minW:8,minH:3,maxH:6},"kpis-category":{visible:!1,x:0,y:8,w:6,h:3,minW:4,minH:3,maxH:5},"quality-standards":{visible:!1,x:6,y:8,w:6,h:3,minW:4,minH:3,maxH:5}}};({...Gs});function Qs(){const i=ae(),{projectId:t}=ne(),[e,s]=d.useState(!0),[a,n]=d.useState({total:0,approved:0,awaitingSignatures:0,awaitingCertificate:0,inProgress:0}),o=d.useCallback(async()=>{if(t){s(!0);try{const l=await rt.getAll(t,{orderBy:{column:"milestone_ref",ascending:!0}}),h=l.map(k=>k.id);let m={};h.length>0&&(await It.getAll(t,{filters:[{column:"milestone_id",operator:"in",value:h}],select:"id, milestone_id, status"})||[]).forEach(M=>{m[M.milestone_id]||(m[M.milestone_id]=[]),m[M.milestone_id].push(M)});const g=await rt.getCertificates(t),f={};g.forEach(k=>{f[k.milestone_id]=k});let y=0,x=0,u=0,b=0;l.forEach(k=>{const M=m[k.id]||[],I=M.length>0&&M.every(C=>C.status==="Delivered"),v=f[k.id];v&&v.status==="Signed"?y++:v?x++:I?u++:b++}),n({total:l.length,approved:y,awaitingSignatures:x,awaitingCertificate:u,inProgress:b})}catch{}finally{s(!1)}}},[t]);d.useEffect(()=>{o()},[o]);const c=()=>{i("/milestones")};return e?r.jsxs("div",{className:"dashboard-widget",onClick:c,children:[r.jsxs("div",{className:"widget-header",children:[r.jsx("div",{className:"widget-icon",children:r.jsx(Me,{size:20})}),r.jsx("span",{className:"widget-title",children:"Milestones"})]}),r.jsx("div",{className:"widget-loading",children:"Loading..."})]}):r.jsxs("div",{className:"dashboard-widget",onClick:c,children:[r.jsxs("div",{className:"widget-header",children:[r.jsx("div",{className:"widget-icon",children:r.jsx(Me,{size:20})}),r.jsx("span",{className:"widget-title",children:"Milestones"}),r.jsxs("span",{className:"widget-total",children:[a.total," Total"]})]}),r.jsxs("div",{className:"widget-breakdown",children:[r.jsxs("div",{className:"widget-row",children:[r.jsx("div",{className:"widget-row-icon approved",children:r.jsx(he,{size:16})}),r.jsx("span",{className:"widget-row-label",children:"Approved (Signed)"}),r.jsx("span",{className:"widget-row-value",children:a.approved})]}),r.jsxs("div",{className:"widget-row",children:[r.jsx("div",{className:"widget-row-icon pending",children:r.jsx(te,{size:16})}),r.jsx("span",{className:"widget-row-label",children:"Awaiting Signatures"}),r.jsx("span",{className:"widget-row-value",children:a.awaitingSignatures})]}),r.jsxs("div",{className:"widget-row",children:[r.jsx("div",{className:"widget-row-icon awaiting",children:r.jsx(Le,{size:16})}),r.jsx("span",{className:"widget-row-label",children:"Awaiting Certificate"}),r.jsx("span",{className:"widget-row-value",children:a.awaitingCertificate})]}),r.jsxs("div",{className:"widget-row",children:[r.jsx("div",{className:"widget-row-icon progress",children:r.jsx(ut,{size:16})}),r.jsx("span",{className:"widget-row-label",children:"In Progress"}),r.jsx("span",{className:"widget-row-value",children:a.inProgress})]})]})]})}function Ys(){const i=ae(),{projectId:t}=ne(),{showTestUsers:e}=bt(),[s,a]=d.useState(!0),[n,o]=d.useState({total:0,delivered:0,reviewComplete:0,awaitingReview:0,returned:0,inProgress:0,notStarted:0}),c=d.useCallback(async()=>{if(t){a(!0);try{const h=await It.getAllWithRelations(t,e);let m=0,g=0,f=0,y=0,x=0,u=0;h.forEach(b=>{switch(b.status){case"Delivered":m++;break;case"Review Complete":g++;break;case"Submitted for Review":f++;break;case"Returned for More Work":y++;break;case"In Progress":x++;break;case"Not Started":default:u++;break}}),o({total:h.length,delivered:m,reviewComplete:g,awaitingReview:f,returned:y,inProgress:x,notStarted:u})}catch{}finally{a(!1)}}},[t,e]);d.useEffect(()=>{c()},[c]);const l=()=>{i("/deliverables")};return s?r.jsxs("div",{className:"dashboard-widget",onClick:l,children:[r.jsxs("div",{className:"widget-header",children:[r.jsx("div",{className:"widget-icon",style:{background:"rgba(34, 197, 94, 0.1)",color:"#22c55e"},children:r.jsx(De,{size:20})}),r.jsx("span",{className:"widget-title",children:"Deliverables"})]}),r.jsx("div",{className:"widget-loading",children:"Loading..."})]}):r.jsxs("div",{className:"dashboard-widget",onClick:l,children:[r.jsxs("div",{className:"widget-header",children:[r.jsx("div",{className:"widget-icon",style:{background:"rgba(34, 197, 94, 0.1)",color:"#22c55e"},children:r.jsx(De,{size:20})}),r.jsx("span",{className:"widget-title",children:"Deliverables"}),r.jsxs("span",{className:"widget-total",children:[n.total," Total"]})]}),r.jsxs("div",{className:"widget-breakdown",children:[r.jsxs("div",{className:"widget-row",children:[r.jsx("div",{className:"widget-row-icon approved",children:r.jsx(he,{size:16})}),r.jsx("span",{className:"widget-row-label",children:"Delivered"}),r.jsx("span",{className:"widget-row-value",children:n.delivered})]}),r.jsxs("div",{className:"widget-row",children:[r.jsx("div",{className:"widget-row-icon",style:{background:"rgba(37, 99, 235, 0.1)",color:"#2563eb"},children:r.jsx(ur,{size:16})}),r.jsx("span",{className:"widget-row-label",children:"Review Complete"}),r.jsx("span",{className:"widget-row-value",children:n.reviewComplete})]}),r.jsxs("div",{className:"widget-row",children:[r.jsx("div",{className:"widget-row-icon pending",children:r.jsx(te,{size:16})}),r.jsx("span",{className:"widget-row-label",children:"Awaiting Review"}),r.jsx("span",{className:"widget-row-value",children:n.awaitingReview})]}),r.jsxs("div",{className:"widget-row",children:[r.jsx("div",{className:"widget-row-icon",style:{background:"rgba(220, 38, 38, 0.1)",color:"#dc2626"},children:r.jsx(dt,{size:16})}),r.jsx("span",{className:"widget-row-label",children:"Returned"}),r.jsx("span",{className:"widget-row-value",children:n.returned})]}),r.jsxs("div",{className:"widget-row",children:[r.jsx("div",{className:"widget-row-icon",style:{background:"rgba(79, 70, 229, 0.1)",color:"#4f46e5"},children:r.jsx(ue,{size:16})}),r.jsx("span",{className:"widget-row-label",children:"In Progress"}),r.jsx("span",{className:"widget-row-value",children:n.inProgress})]}),r.jsxs("div",{className:"widget-row",children:[r.jsx("div",{className:"widget-row-icon progress",children:r.jsx(ut,{size:16})}),r.jsx("span",{className:"widget-row-label",children:"Not Started"}),r.jsx("span",{className:"widget-row-value",children:n.notStarted})]})]})]})}function Xs(){const i=ae(),{projectId:t}=ne(),[e,s]=d.useState(!0),[a,n]=d.useState({submittedCount:0,submittedValue:0,validatedCount:0,validatedValue:0}),o=d.useCallback(async()=>{if(t){s(!0);try{const g=(await zs.getAll(t,{select:`
          id, hours_worked, hours, status, is_deleted,
          resources(id, sell_price)
        `})||[]).filter(b=>b.is_deleted!==!0);let f=0,y=0,x=0,u=0;g.forEach(b=>{const k=parseFloat(b.hours_worked||b.hours||0),M=b.resources?.sell_price||0,I=Et(k,M);switch(b.status){case"Submitted":f++,y+=I;break;case"Validated":case"Approved":x++,u+=I;break}}),n({submittedCount:f,submittedValue:y,validatedCount:x,validatedValue:u})}catch{}finally{s(!1)}}},[t]);d.useEffect(()=>{o()},[o]);const c=()=>{i("/timesheets")},l=m=>`Â£${Math.round(m).toLocaleString()}`;if(e)return r.jsxs("div",{className:"dashboard-widget",onClick:c,children:[r.jsxs("div",{className:"widget-header",children:[r.jsx("div",{className:"widget-icon",style:{background:"rgba(59, 130, 246, 0.1)",color:"#3b82f6"},children:r.jsx(te,{size:20})}),r.jsx("span",{className:"widget-title",children:"Timesheets"})]}),r.jsx("div",{className:"widget-loading",children:"Loading..."})]});const h=a.submittedCount+a.validatedCount;return r.jsxs("div",{className:"dashboard-widget",onClick:c,children:[r.jsxs("div",{className:"widget-header",children:[r.jsx("div",{className:"widget-icon",style:{background:"rgba(59, 130, 246, 0.1)",color:"#3b82f6"},children:r.jsx(te,{size:20})}),r.jsx("span",{className:"widget-title",children:"Timesheets"}),r.jsxs("span",{className:"widget-total",children:[h," Active"]})]}),r.jsxs("div",{className:"widget-breakdown",children:[r.jsxs("div",{className:"widget-row",children:[r.jsx("div",{className:"widget-row-icon pending",children:r.jsx(ot,{size:16})}),r.jsx("span",{className:"widget-row-label",children:"Submitted"}),r.jsx("span",{className:"widget-row-value",children:a.submittedCount}),r.jsx("span",{className:"widget-row-secondary",children:l(a.submittedValue)})]}),r.jsxs("div",{className:"widget-row",children:[r.jsx("div",{className:"widget-row-icon approved",children:r.jsx(he,{size:16})}),r.jsx("span",{className:"widget-row-label",children:"Validated"}),r.jsx("span",{className:"widget-row-value",children:a.validatedCount}),r.jsx("span",{className:"widget-row-secondary",children:l(a.validatedValue)})]})]})]})}function Js(){const i=ae(),{projectId:t}=ne(),[e,s]=d.useState(!0),[a,n]=d.useState({awaitingValue:0,validatedTotal:0,chargeableValue:0,nonChargeableValue:0}),o=d.useCallback(async()=>{if(t){s(!0);try{const m=(await Us.getAll(t,{select:"id, amount, status, chargeable_to_customer, is_deleted"})||[]).filter(u=>u.is_deleted!==!0);let g=0,f=0,y=0,x=0;m.forEach(u=>{const b=parseFloat(u.amount||0);switch(u.status){case"Submitted":g+=b;break;case"Validated":case"Approved":f+=b,u.chargeable_to_customer!==!1?y+=b:x+=b;break}}),n({awaitingValue:g,validatedTotal:f,chargeableValue:y,nonChargeableValue:x})}catch{}finally{s(!1)}}},[t]);d.useEffect(()=>{o()},[o]);const c=()=>{i("/expenses")},l=h=>`Â£${Math.round(h).toLocaleString()}`;return e?r.jsxs("div",{className:"dashboard-widget",onClick:c,children:[r.jsxs("div",{className:"widget-header",children:[r.jsx("div",{className:"widget-icon",style:{background:"rgba(168, 85, 247, 0.1)",color:"#a855f7"},children:r.jsx(ge,{size:20})}),r.jsx("span",{className:"widget-title",children:"Expenses"})]}),r.jsx("div",{className:"widget-loading",children:"Loading..."})]}):r.jsxs("div",{className:"dashboard-widget",onClick:c,children:[r.jsxs("div",{className:"widget-header",children:[r.jsx("div",{className:"widget-icon",style:{background:"rgba(168, 85, 247, 0.1)",color:"#a855f7"},children:r.jsx(ge,{size:20})}),r.jsx("span",{className:"widget-title",children:"Expenses"}),r.jsxs("span",{className:"widget-total",children:[l(a.validatedTotal)," Validated"]})]}),r.jsxs("div",{className:"widget-breakdown",children:[r.jsxs("div",{className:"widget-row",children:[r.jsx("div",{className:"widget-row-icon pending",children:r.jsx(te,{size:16})}),r.jsx("span",{className:"widget-row-label",children:"Awaiting Validation"}),r.jsx("span",{className:"widget-row-value",children:l(a.awaitingValue)})]}),r.jsxs("div",{className:"widget-row",children:[r.jsx("div",{className:"widget-row-icon approved",children:r.jsx(he,{size:16})}),r.jsx("span",{className:"widget-row-label",children:"Validated Total"}),r.jsx("span",{className:"widget-row-value",children:l(a.validatedTotal)})]}),r.jsxs("div",{className:"widget-row",style:{paddingLeft:"1.5rem"},children:[r.jsx("div",{className:"widget-row-icon",style:{background:"rgba(34, 197, 94, 0.1)",color:"#22c55e"},children:r.jsx(hr,{size:16})}),r.jsx("span",{className:"widget-row-label",children:"â†³ Chargeable"}),r.jsx("span",{className:"widget-row-value",children:l(a.chargeableValue)})]}),r.jsxs("div",{className:"widget-row",style:{paddingLeft:"1.5rem"},children:[r.jsx("div",{className:"widget-row-icon",style:{background:"rgba(107, 114, 128, 0.1)",color:"#6b7280"},children:r.jsx(ct,{size:16})}),r.jsx("span",{className:"widget-row-label",children:"â†³ Non-Chargeable"}),r.jsx("span",{className:"widget-row-value",children:l(a.nonChargeableValue)})]})]})]})}function Zs(){const{projectName:i,projectRef:t}=ne(),{user:e}=xe(),s=()=>{const a=new Date().getHours();return a<12?"Good morning":a<18?"Good afternoon":"Good evening"};return r.jsxs("div",{className:"dashboard",children:[r.jsx("div",{className:"dashboard-header",children:r.jsx("div",{className:"dashboard-header-content",children:r.jsxs("div",{children:[r.jsx("h1",{className:"dashboard-title",children:s()}),r.jsxs("p",{className:"dashboard-subtitle",children:[t," â€¢ ",i]})]})})}),r.jsx("div",{className:"dashboard-content",children:r.jsxs("div",{className:"dashboard-widgets",children:[r.jsx(Qs,{}),r.jsx(Ys,{}),r.jsx(Xs,{}),r.jsx(Js,{})]})})]})}const ea=d.lazy(()=>B(()=>import("./ResetPassword-CXeVclGm.js"),__vite__mapDeps([0,1,2,3]))),ta=d.lazy(()=>B(()=>import("./Milestones-Dj9Aanz7.js"),__vite__mapDeps([4,1,5,6,7,8,2,3]))),ra=d.lazy(()=>B(()=>import("./MilestoneDetail-1kDkyBWI.js"),__vite__mapDeps([9,1,2,3]))),sa=d.lazy(()=>B(()=>import("./Gantt-B1qLLkXW.js"),__vite__mapDeps([10,1,5,2,3]))),aa=d.lazy(()=>B(()=>import("./Deliverables-D7_4pG7k.js"),__vite__mapDeps([11,1,5,7,2,3]))),na=d.lazy(()=>B(()=>import("./Resources-BB3JcB58.js"),__vite__mapDeps([12,1,5,6,7,8,2,3]))),ia=d.lazy(()=>B(()=>import("./ResourceDetail-DMYvORYu.js"),__vite__mapDeps([13,1,5,6,2,3]))),oa=d.lazy(()=>B(()=>import("./Partners-YaiHQXb8.js"),__vite__mapDeps([14,1,5,6,7,8,2,3]))),la=d.lazy(()=>B(()=>import("./PartnerDetail-DOYNOx_p.js"),__vite__mapDeps([15,1,5,6,2,3]))),ca=d.lazy(()=>B(()=>import("./Timesheets-3kIogsfq.js"),__vite__mapDeps([16,1,5,6,7,8,2,3]))),da=d.lazy(()=>B(()=>import("./Expenses-BBcq49j7.js"),__vite__mapDeps([17,1,5,6,7,8,2,3,18]))),ua=d.lazy(()=>B(()=>import("./KPIs-IwCf2YUp.js"),__vite__mapDeps([19,1,5,6,7,8,2,3]))),ha=d.lazy(()=>B(()=>import("./KPIDetail-CGzYo3wV.js"),__vite__mapDeps([20,1,5,2,3]))),ma=d.lazy(()=>B(()=>import("./QualityStandards-Bi2qE737.js"),__vite__mapDeps([21,1,5,6,7,8,2,3]))),fa=d.lazy(()=>B(()=>import("./QualityStandardDetail-BZrfu2kw.js"),__vite__mapDeps([22,1,2,3]))),ga=d.lazy(()=>B(()=>import("./Reports-FaTKbOda.js"),__vite__mapDeps([23,2,1,3]))),pa=d.lazy(()=>B(()=>import("./Users-DpD_2mH7.js"),__vite__mapDeps([24,1,2,3]))),ya=d.lazy(()=>B(()=>import("./Settings-CSe2Unvi.js"),__vite__mapDeps([25,1,5,7,2,3]))),wa=d.lazy(()=>B(()=>import("./AccountSettings-BnbzPYN4.js"),__vite__mapDeps([26,1,7,2,3]))),xa=d.lazy(()=>B(()=>import("./WorkflowSummary-LHrvexGJ.js"),__vite__mapDeps([27,1,6,7,2,3]))),ba=d.lazy(()=>B(()=>import("./AuditLog-DOkdm_xP.js"),__vite__mapDeps([28,1,7,2,3]))),_a=d.lazy(()=>B(()=>import("./DeletedItems-COyoE3Z2.js"),__vite__mapDeps([29,1,7,8,2,3])));function va(){return r.jsx("div",{className:"page-container",children:r.jsx(de,{type:"page"})})}function z({children:i}){const{user:t,isLoading:e}=xe();return e?r.jsx(St,{message:"Loading...",size:"large",fullPage:!0}):t?r.jsx(Es,{children:r.jsx(d.Suspense,{fallback:r.jsx(va,{}),children:i||r.jsx(zt,{})})}):r.jsx(Ae,{to:"/login",replace:!0})}function Sa(){return r.jsx(Ot,{children:r.jsx(es,{children:r.jsx(os,{children:r.jsx(Fr,{children:r.jsx(Vr,{children:r.jsx(Hr,{children:r.jsx(hs,{children:r.jsx(Gr,{children:r.jsxs(Jr,{children:[r.jsxs(Lt,{children:[r.jsx(O,{path:"/login",element:r.jsx(ks,{})}),r.jsx(O,{path:"/reset-password",element:r.jsx(d.Suspense,{fallback:r.jsx(St,{fullPage:!0}),children:r.jsx(ea,{})})}),r.jsx(O,{path:"/",element:r.jsx(Ae,{to:"/dashboard",replace:!0})}),r.jsx(O,{path:"/dashboard",element:r.jsx(z,{children:r.jsx(Zs,{})})}),r.jsx(O,{path:"/milestones",element:r.jsx(z,{children:r.jsx(ta,{})})}),r.jsx(O,{path:"/milestones/:id",element:r.jsx(z,{children:r.jsx(ra,{})})}),r.jsx(O,{path:"/gantt",element:r.jsx(z,{children:r.jsx(sa,{})})}),r.jsx(O,{path:"/deliverables",element:r.jsx(z,{children:r.jsx(aa,{})})}),r.jsx(O,{path:"/resources",element:r.jsx(z,{children:r.jsx(na,{})})}),r.jsx(O,{path:"/resources/:id",element:r.jsx(z,{children:r.jsx(ia,{})})}),r.jsx(O,{path:"/partners",element:r.jsx(z,{children:r.jsx(oa,{})})}),r.jsx(O,{path:"/partners/:id",element:r.jsx(z,{children:r.jsx(la,{})})}),r.jsx(O,{path:"/timesheets",element:r.jsx(z,{children:r.jsx(ca,{})})}),r.jsx(O,{path:"/expenses",element:r.jsx(z,{children:r.jsx(da,{})})}),r.jsx(O,{path:"/kpis",element:r.jsx(z,{children:r.jsx(ua,{})})}),r.jsx(O,{path:"/kpis/:id",element:r.jsx(z,{children:r.jsx(ha,{})})}),r.jsx(O,{path:"/quality-standards",element:r.jsx(z,{children:r.jsx(ma,{})})}),r.jsx(O,{path:"/quality-standards/:id",element:r.jsx(z,{children:r.jsx(fa,{})})}),r.jsx(O,{path:"/reports",element:r.jsx(z,{children:r.jsx(ga,{})})}),r.jsx(O,{path:"/users",element:r.jsx(z,{children:r.jsx(pa,{})})}),r.jsx(O,{path:"/settings",element:r.jsx(z,{children:r.jsx(ya,{})})}),r.jsx(O,{path:"/account",element:r.jsx(z,{children:r.jsx(wa,{})})}),r.jsx(O,{path:"/workflow-summary",element:r.jsx(z,{children:r.jsx(xa,{})})}),r.jsx(O,{path:"/audit-log",element:r.jsx(z,{children:r.jsx(ba,{})})}),r.jsx(O,{path:"/deleted-items",element:r.jsx(z,{children:r.jsx(_a,{})})}),r.jsx(O,{path:"*",element:r.jsx(Ae,{to:"/dashboard",replace:!0})})]}),r.jsx(ms,{}),r.jsx(Pr,{}),r.jsx(zr,{})]})})})})})})})})})}Te.createRoot(document.getElementById("root")).render(r.jsx(st.StrictMode,{children:r.jsx(Sa,{})}));export{St as L,ys as P,ws as R,H as V,ne as a,ls as b,Ge as c,It as d,Et as e,bt as f,Ra as g,le as h,Us as i,r as j,Ma as k,Xe as l,rt as m,Da as n,Na as o,Ia as p,Ta as q,Aa as r,p as s,zs as t,xe as u,w as v,Pa as w};
