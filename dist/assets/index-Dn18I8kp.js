const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ResetPassword-DmlPSk0a.js","assets/vendor-react-JFEV0ROX.js","assets/vendor-icons-yzeFIsqS.js","assets/vendor-supabase-DgEUAXvv.js","assets/Milestones-CsnlZ2gr.js","assets/ConfirmDialog-D41ykVDo.js","assets/milestoneCalculations-DDt_Nnih.js","assets/Milestones-C3emWKZh.css","assets/MilestoneDetail-BFh9wJyM.js","assets/MilestoneDetail-BJQ8Lfzq.css","assets/Gantt-CsrW39Ay.js","assets/Deliverables-DlIhZSu5.js","assets/Deliverables-Sef4_T6Z.css","assets/Resources-CO9Nucwr.js","assets/Resources-DqwAz4oE.css","assets/ResourceDetail-BZ9IQbdE.js","assets/StatCard-DY6eM2Nb.js","assets/Partners-Opsvkhg4.js","assets/Partners-gm1Px_xW.css","assets/PartnerDetail-DLokerqy.js","assets/Timesheets-DnV__q2W.js","assets/Timesheets-CGkpTkzM.css","assets/Expenses-ottkEgAW.js","assets/Expenses-CkSEY-w5.css","assets/KPIs-BYTMBmD9.js","assets/KPIs-DqHNCrBk.css","assets/KPIDetail-hjDrx-eY.js","assets/QualityStandards-CcSOOW6h.js","assets/QualityStandards-BjfsOAnd.css","assets/QualityStandardDetail-CKndWTa8.js","assets/RaidLog-CQvPUyZt.js","assets/RaidLog-C9AnKyu_.css","assets/Reports-Bs0DAaV-.js","assets/Billing-CfTiYJcE.js","assets/PageHeader-Dat95Ijv.js","assets/Users-CDLU5cj8.js","assets/Users-DDv0gteh.css","assets/Settings-BqaQwEqk.js","assets/AccountSettings-DrZL_L1c.js","assets/WorkflowSummary-Djd7fDaY.js","assets/AuditLog-OVqY_VpL.js","assets/DeletedItems-DwdLjiBE.js"])))=>i.map(i=>d[i]);
var Or=Object.defineProperty;var qr=(n,r,t)=>r in n?Or(n,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[r]=t;var Fe=(n,r,t)=>qr(n,typeof r!="symbol"?r+"":r,t);import{r as d,a as Lr,R as Rt,u as ce,b as Br,L as Ze,c as zr,B as $r,d as Ur,e as z,N as et,O as Vr}from"./vendor-react-JFEV0ROX.js";import{c as Wr}from"./vendor-supabase-DgEUAXvv.js";import{A as Pt,R as Se,I as Fr,X as At,C as we,a as pe,M as Hr,S as Kr,B as He,D as Gr,T as Qr,U as Yr,Z as ft,b as Xr,c as Te,d as Jr,L as gt,e as It,f as Zr,g as Ke,h as es,i as Pe,F as ze,j as Oe,k as le,l as ts,H as rs,m as ss,n as as,o as Dt,P as Ae,p as ns,q as is,r as qe,s as tt,t as rt,G as os,u as ls,v as cs,w as ds,x as us,y as Mt,z as hs,K as ms,E as Ge,J as Qe,N as Tt,O as fs,Q as gs,V as ps,W as ys}from"./vendor-icons-yzeFIsqS.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(a){if(a.ep)return;a.ep=!0;const i=t(a);fetch(a.href,i)}})();var Ot={exports:{}},$e={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var xs=d,bs=Symbol.for("react.element"),ws=Symbol.for("react.fragment"),_s=Object.prototype.hasOwnProperty,vs=xs.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,Ss={key:!0,ref:!0,__self:!0,__source:!0};function qt(n,r,t){var s,a={},i=null,o=null;t!==void 0&&(i=""+t),r.key!==void 0&&(i=""+r.key),r.ref!==void 0&&(o=r.ref);for(s in r)_s.call(r,s)&&!Ss.hasOwnProperty(s)&&(a[s]=r[s]);if(n&&n.defaultProps)for(s in r=n.defaultProps,r)a[s]===void 0&&(a[s]=r[s]);return{$$typeof:bs,type:n,key:i,ref:o,props:a,_owner:vs.current}}$e.Fragment=ws;$e.jsx=qt;$e.jsxs=qt;Ot.exports=$e;var e=Ot.exports,st={},pt=Lr;st.createRoot=pt.createRoot,st.hydrateRoot=pt.hydrateRoot;const js="modulepreload",Cs=function(n){return"/"+n},yt={},W=function(r,t,s){let a=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),c=o?.nonce||o?.getAttribute("nonce");a=Promise.allSettled(t.map(l=>{if(l=Cs(l),l in yt)return;yt[l]=!0;const u=l.endsWith(".css"),f=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${f}`))return;const h=document.createElement("link");if(h.rel=u?"stylesheet":js,u||(h.as="script"),h.crossOrigin="",h.href=l,c&&h.setAttribute("nonce",c),document.head.appendChild(h),u)return new Promise((y,g)=>{h.addEventListener("load",y),h.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${l}`)))})}))}function i(o){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=o,window.dispatchEvent(c),!c.defaultPrevented)throw o}return a.then(o=>{for(const c of o||[])c.status==="rejected"&&i(c.reason);return r().catch(i)})};var xt={},Ns="@vercel/analytics",Es="1.6.0",ks=()=>{window.va||(window.va=function(...r){(window.vaq=window.vaq||[]).push(r)})};function Lt(){return typeof window<"u"}function Bt(){try{const n="production"}catch{}return"production"}function Rs(n="auto"){if(n==="auto"){window.vam=Bt();return}window.vam=n}function Ps(){return(Lt()?window.vam:Bt())||"production"}function at(){return Ps()==="development"}function As(n){return n.scriptSrc?n.scriptSrc:at()?"https://va.vercel-scripts.com/v1/script.debug.js":n.basePath?`${n.basePath}/insights/script.js`:"/_vercel/insights/script.js"}function Is(n={debug:!0}){var r;if(!Lt())return;Rs(n.mode),ks(),n.beforeSend&&((r=window.va)==null||r.call(window,"beforeSend",n.beforeSend));const t=As(n);if(document.head.querySelector(`script[src*="${t}"]`))return;const s=document.createElement("script");s.src=t,s.defer=!0,s.dataset.sdkn=Ns+(n.framework?`/${n.framework}`:""),s.dataset.sdkv=Es,n.disableAutoTrack&&(s.dataset.disableAutoTrack="1"),n.endpoint?s.dataset.endpoint=n.endpoint:n.basePath&&(s.dataset.endpoint=`${n.basePath}/insights`),n.dsn&&(s.dataset.dsn=n.dsn),s.onerror=()=>{const a=at()?"Please check if any ad blockers are enabled and try again.":"Be sure to enable Web Analytics for your project and deploy again. See https://vercel.com/docs/analytics/quickstart for more information."},at()&&n.debug===!1&&(s.dataset.debug="false"),document.head.appendChild(s)}function Ds({route:n,path:r}){var t;(t=window.va)==null||t.call(window,"pageview",{route:n,path:r})}function Ms(){if(!(typeof process>"u"||typeof xt>"u"))return xt.REACT_APP_VERCEL_OBSERVABILITY_BASEPATH}function Ts(n){return d.useEffect(()=>{var r;n.beforeSend&&((r=window.va)==null||r.call(window,"beforeSend",n.beforeSend))},[n.beforeSend]),d.useEffect(()=>{Is({framework:n.framework||"react",basePath:n.basePath??Ms(),...n.route!==void 0&&{disableAutoTrack:!0},...n})},[]),d.useEffect(()=>{n.route&&n.path&&Ds({route:n.route,path:n.path})},[n.route,n.path]),null}var bt={},Os="@vercel/speed-insights",qs="1.2.0",Ls=()=>{window.si||(window.si=function(...r){(window.siq=window.siq||[]).push(r)})};function Bs(){return typeof window<"u"}function zs(){try{const n="production"}catch{}return"production"}function zt(){return zs()==="development"}function $s(n){return n.scriptSrc?n.scriptSrc:zt()?"https://va.vercel-scripts.com/v1/speed-insights/script.debug.js":n.dsn?"https://va.vercel-scripts.com/v1/speed-insights/script.js":n.basePath?`${n.basePath}/speed-insights/script.js`:"/_vercel/speed-insights/script.js"}function Us(n={}){var r;if(!Bs()||n.route===null)return null;Ls();const t=$s(n);if(document.head.querySelector(`script[src*="${t}"]`))return null;n.beforeSend&&((r=window.si)==null||r.call(window,"beforeSend",n.beforeSend));const s=document.createElement("script");return s.src=t,s.defer=!0,s.dataset.sdkn=Os+(n.framework?`/${n.framework}`:""),s.dataset.sdkv=qs,n.sampleRate&&(s.dataset.sampleRate=n.sampleRate.toString()),n.route&&(s.dataset.route=n.route),n.endpoint?s.dataset.endpoint=n.endpoint:n.basePath&&(s.dataset.endpoint=`${n.basePath}/speed-insights/vitals`),n.dsn&&(s.dataset.dsn=n.dsn),zt()&&n.debug===!1&&(s.dataset.debug="false"),s.onerror=()=>{},document.head.appendChild(s),{setRoute:a=>{s.dataset.route=a??void 0}}}function Vs(){if(!(typeof process>"u"||typeof bt>"u"))return bt.REACT_APP_VERCEL_OBSERVABILITY_BASEPATH}function Ws(n){d.useEffect(()=>{var t;n.beforeSend&&((t=window.si)==null||t.call(window,"beforeSend",n.beforeSend))},[n.beforeSend]);const r=d.useRef(null);return d.useEffect(()=>{if(r.current)n.route&&r.current(n.route);else{const t=Us({framework:n.framework??"react",basePath:n.basePath??Vs(),...n});t&&(r.current=t.setRoute)}},[n.route]),null}const Fs=void 0,Hs=void 0;throw new Error("Missing Supabase environment variables");const p=Wr(Fs,Hs),$t=d.createContext(null),Ks=60*1e3,Gs=5*60*1e3;function Qs({children:n}){const[r,t]=d.useState(null),[s,a]=d.useState(null),[i,o]=d.useState(null),[c,l]=d.useState(!0),[u,f]=d.useState(null),[h,y]=d.useState(!1),g=d.useRef(null),b=d.useRef(Date.now()),m=d.useCallback(()=>{b.current=Date.now()},[]);async function w(N){if(!N){a(null),o(null);return}try{const{data:j,error:D}=await p.from("profiles").select("*").eq("id",N.id).single();if(D){f(D);return}a(j);const{data:C}=await p.from("resources").select("*").eq("user_id",N.id).maybeSingle();o(C),f(null)}catch(j){f(j)}}const R=d.useCallback(async()=>{try{const{data:{session:N},error:j}=await p.auth.getSession();if(j)return;if(!N){await M();return}const D=N.expires_at*1e3,C=Date.now(),_=D-C;if(_<=0)await M();else if(_<=Gs){y(!0);const{data:L,error:se}=await p.auth.refreshSession();se||!L.session||y(!1)}else y(!1)}catch{}},[]);async function M(){t(null),a(null),o(null),y(!1),await p.auth.signOut();const N=window.location.pathname;N!=="/login"&&N!=="/register"&&(window.location.href="/login?expired=true")}const A=d.useCallback(()=>{g.current&&clearInterval(g.current),g.current=setInterval(()=>{R()},Ks);const N=()=>{document.visibilityState==="visible"&&R()};document.addEventListener("visibilitychange",N);const j=["mousedown","keydown","touchstart","scroll"];return j.forEach(D=>{document.addEventListener(D,m,{passive:!0})}),()=>{g.current&&clearInterval(g.current),document.removeEventListener("visibilitychange",N),j.forEach(D=>{document.removeEventListener(D,m)})}},[R,m]);d.useEffect(()=>{let N=!0,j=null;async function D(){try{const{data:{session:_},error:L}=await p.auth.getSession();L&&N&&f(L),N&&(t(_?.user??null),l(!1),_?.user&&(w(_.user),j=A()))}catch(_){N&&(f(_),l(!1))}}D();const{data:{subscription:C}}=p.auth.onAuthStateChange(async(_,L)=>{N&&(t(L?.user??null),l(!1),L?.user?(w(L.user),j&&j(),j=A()):(a(null),o(null),j&&(j(),j=null)),(_==="SIGNED_OUT"||_==="TOKEN_REFRESHED")&&y(!1))});return()=>{N=!1,C.unsubscribe(),j&&j()}},[A]);async function S(){try{await p.auth.signOut(),t(null),a(null),o(null),y(!1)}catch(N){f(N)}}async function E(){r&&await w(r)}async function v(){try{const{data:N,error:j}=await p.auth.refreshSession();return j?!1:N.session?(y(!1),!0):!1}catch{return!1}}const k={user:r,profile:s,role:s?.role||"viewer",linkedResource:i,isLoading:c,error:u,signOut:S,refreshUserData:E,refreshSession:v,isAuthenticated:!!r,sessionExpiring:h};return e.jsx($t.Provider,{value:k,children:n})}function Ie(){const n=d.useContext($t);if(!n)throw new Error("useAuth must be used within an AuthProvider");return n}const Ut=d.createContext(null);function Ys({children:n}){const[r,t]=d.useState(null),[s,a]=d.useState(!0),[i,o]=d.useState(null);d.useEffect(()=>{let f=!0;async function h(){try{const{data:y,error:g}=await p.from("projects").select("*").eq("reference","AMSF001").single();g?f&&o(g):f&&(t(y),o(null))}catch(y){f&&o(y)}finally{f&&a(!1)}}return h(),()=>{f=!1}},[]);async function c(f){a(!0),o(null);try{const{data:h,error:y}=await p.from("projects").select("*").eq("reference",f).single();y?o(y):t(h)}catch(h){o(h)}finally{a(!1)}}async function l(){if(r)try{const{data:f,error:h}=await p.from("projects").select("*").eq("id",r.id).single();h?o(h):t(f)}catch(f){o(f)}}const u={currentProject:r,projectId:r?.id||null,projectRef:r?.reference||null,projectName:r?.name||null,isLoading:s,error:i,switchProject:c,refreshProject:l};return e.jsx(Ut.Provider,{value:u,children:n})}function ne(){const n=d.useContext(Ut);if(!n)throw new Error("useProject must be used within a ProjectProvider");return n}const Vt=d.createContext();function Xs({children:n}){const[r,t]=d.useState(!1),[s,a]=d.useState(null),[i,o]=d.useState([]);d.useEffect(()=>{c(),l()},[]);async function c(){const{data:{user:m}}=await p.auth.getUser();if(m){const{data:w}=await p.from("profiles").select("role").eq("id",m.id).single();w&&a(w.role)}}async function l(){const{data:m}=await p.from("profiles").select("id").eq("is_test_user",!0);m&&o(m.map(w=>w.id))}const u=s==="admin"||s==="supplier_pm";function f(){u&&t(m=>!m)}function h(m){return i.includes(m)}function y(m,w="user_id"){return!m||r?m:m.filter(R=>!i.includes(R[w]))}function g(m){return!m||r?m:m.filter(w=>!w.is_test_content)}const b={showTestUsers:r,setShowTestUsers:t,toggleTestUsers:f,canToggleTestUsers:u,testUserIds:i,isTestUser:h,filterTestContent:y,filterByTestFlag:g,userRole:s};return e.jsx(Vt.Provider,{value:b,children:n})}function Wt(){const n=d.useContext(Vt);if(!n)throw new Error("useTestUsers must be used within a TestUserProvider");return n}const Ft=d.createContext();function Js(){return d.useContext(Ft)}function Zs({children:n}){const[r,t]=d.useState([]),[s,a]=d.useState(0),[i,o]=d.useState(0),[c,l]=d.useState(!0),[u,f]=d.useState(null),[h,y]=d.useState(null),g=E=>["admin","supplier_pm","customer_pm"].includes(E),b=d.useCallback(async(E,v)=>{try{let k=[];if(g(v)){const{data:N}=await p.from("timesheets").select("id, hours_worked, hours, work_date, date").eq("status","Submitted"),{data:j}=await p.from("expenses").select("id, amount, category, reason, resource_name, chargeable_to_customer").eq("status","Submitted"),{data:D}=await p.from("deliverables").select("id, name, deliverable_ref").eq("status","Submitted"),{data:C}=await p.from("milestone_certificates").select("id, milestone_id").eq("status","Submitted");N&&N.forEach(_=>{k.push({id:`ts-${_.id}`,type:"timesheet",notification_type:"action",title:"Timesheet Submitted",message:`Timesheet (${_.hours_worked||_.hours||0}h) pending approval`,action_url:"/timesheets",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1})}),j&&j.forEach(_=>{const L=_.chargeable_to_customer!==!1;k.push({id:`exp-${_.id}`,type:"expense",notification_type:"action",title:"Expense Submitted",message:`${_.resource_name||"Unknown"} expense (Â£${parseFloat(_.amount||0).toFixed(2)}) pending validation`,action_url:"/expenses",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1,isChargeable:L})}),D&&D.forEach(_=>{k.push({id:`del-${_.id}`,type:"deliverable",notification_type:"action",title:"Deliverable Submitted",message:`${_.deliverable_ref}: ${_.name} pending review`,action_url:"/deliverables",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1})}),C&&C.forEach(_=>{k.push({id:`cert-${_.id}`,type:"certificate",notification_type:"action",title:"Certificate Submitted",message:"Milestone certificate pending approval",action_url:"/milestones",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1})})}else{const{data:N}=await p.from("timesheets").select("id, hours_worked, hours, work_date, date, resource_id").eq("status","Submitted").eq("user_id",E),{data:j}=await p.from("expenses").select("id, amount, category, reason, resource_name").eq("status","Submitted").eq("created_by",E);N&&N.forEach(D=>{k.push({id:`ts-${D.id}`,type:"timesheet",notification_type:"action",title:"Timesheet Submitted",message:`Your timesheet for ${D.hours_worked||D.hours||0}h is pending approval`,action_url:"/timesheets",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1})}),j&&j.forEach(D=>{k.push({id:`exp-${D.id}`,type:"expense",notification_type:"action",title:"Expense Submitted",message:`Your expense (Â£${parseFloat(D.amount||0).toFixed(2)}) is pending validation`,action_url:"/expenses",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1})})}return{count:k.length,items:k}}catch{return{count:0,items:[]}}},[]),m=d.useCallback(async()=>{try{const{data:{user:E}}=await p.auth.getUser();if(!E){t([]),a(0),o(0),l(!1);return}f(E.id);const{data:v}=await p.from("profiles").select("role").eq("id",E.id).single(),k=v?.role||"viewer";y(k);const{count:N,items:j}=await b(E.id,k);t(j),a(N),o(N)}catch{}finally{l(!1)}},[b]),w=d.useCallback(async E=>{t(v=>v.map(k=>k.id===E?{...k,is_read:!0}:k)),a(v=>Math.max(0,v-1))},[]),R=d.useCallback(async E=>{t(v=>v.map(k=>k.id===E?{...k,is_actioned:!0,is_read:!0}:k)),a(v=>Math.max(0,v-1)),o(v=>Math.max(0,v-1))},[]),M=d.useCallback(async()=>{t(E=>E.map(v=>({...v,is_read:!0}))),a(0)},[]),A=d.useCallback(async E=>{const v=r.find(k=>k.id===E);v&&(t(k=>k.filter(N=>N.id!==E)),v.is_read||a(k=>Math.max(0,k-1)),v.notification_type==="action"&&!v.is_actioned&&o(k=>Math.max(0,k-1)))},[r]);d.useEffect(()=>{m();const E=setInterval(()=>{m()},3e4);return()=>clearInterval(E)},[m]),d.useEffect(()=>{const{data:{subscription:E}}=p.auth.onAuthStateChange((v,k)=>{v==="SIGNED_IN"?m():v==="SIGNED_OUT"&&(t([]),a(0),o(0),f(null),y(null))});return()=>E.unsubscribe()},[m]);const S={notifications:r,unreadCount:s,actionCount:i,loading:c,fetchNotifications:m,markAsRead:w,markAsActioned:R,markAllAsRead:M,dismissNotification:A};return e.jsx(Ft.Provider,{value:S,children:n})}const Ht=d.createContext(null),ct="amsf-chat-history",ea=50,Ye={maxRetries:2,baseDelayMs:1e3,retryableCodes:[429,503,504]};function ta(){try{const n=localStorage.getItem(ct);if(n){const r=JSON.parse(n);return{messages:r.messages||[],tokenUsage:r.tokenUsage||{input:0,output:0,requests:0}}}}catch{}return{messages:[],tokenUsage:{input:0,output:0,requests:0}}}function ra(n,r){try{const t=n.slice(-ea);localStorage.setItem(ct,JSON.stringify({messages:t,tokenUsage:r,savedAt:new Date().toISOString()}))}catch{}}function sa({children:n}){const{user:r,profile:t,linkedResource:s,role:a}=Ie(),{projectId:i,projectName:o,projectRef:c,currentProject:l}=ne(),u=ta(),[f,h]=d.useState(!1),[y,g]=d.useState(u.messages),[b,m]=d.useState(!1),[w,R]=d.useState(null),[M,A]=d.useState(0),[S,E]=d.useState(u.tokenUsage),[v,k]=d.useState(null),[N,j]=d.useState(!1),D=d.useRef(null),C=d.useRef(null);d.useEffect(()=>{(y.length>0||S.requests>0)&&ra(y,S)},[y,S]),d.useEffect(()=>{if(!f||!i||C.current===i)return;(async()=>{j(!0);try{const $={email:r?.email,role:a||t?.role,linkedResourceId:s?.id,partnerId:s?.partner_id},O=await fetch("/api/chat-context",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:i,userContext:$})});if(O.ok){const q=await O.json();k(q.context),C.current=i}}catch{}finally{j(!1)}})()},[f,i,r?.email,a,t?.role,s?.id,s?.partner_id]);const _=d.useCallback(()=>l?{id:i,reference:c||l?.reference,name:o||l?.name,description:l?.description||null}:null,[l,i,c,o]),L=d.useCallback(()=>({name:t?.full_name||r?.email?.split("@")[0]||"User",email:r?.email,role:a||t?.role||"unknown",linkedResourceName:s?.name||null,linkedResourceId:s?.id||null,partnerId:s?.partner_id||null,partnerName:s?.partners?.name||null}),[r,t,s,a]),se=[{pattern:/^(what'?s?|how'?s?).*(budget|spend)/i,type:"budget"},{pattern:/budget.*(status|summary|overview)/i,type:"budget"},{pattern:/how much.*(spent|spend)/i,type:"budget"},{pattern:/^how many milestones/i,type:"milestoneCount"},{pattern:/milestone.*(count|total|how many)/i,type:"milestoneCount"},{pattern:/^how many deliverables/i,type:"deliverableCount"},{pattern:/deliverable.*(count|total|how many)/i,type:"deliverableCount"},{pattern:/^(what'?s?|how'?s?).*(pending|to.?do|actions?)/i,type:"pending"},{pattern:/what.*(need|should).*(do|action)/i,type:"pending"},{pattern:/^(project )?(status|overview|summary)$/i,type:"overview"},{pattern:/^how.*(project|things).*(going|doing)/i,type:"overview"}],oe=d.useCallback(U=>{if(!v)return null;const $=U.toLowerCase().trim();let O=null;for(const{pattern:Z,type:ee}of se)if(Z.test($)){O=ee;break}if(!O)return null;const q=v.budgetSummary,K=v.milestoneSummary,G=v.deliverableSummary,F=v.pendingActions,Y=v.timesheetSummary,J=Z=>`Â£${(Z||0).toLocaleString()}`;switch(O){case"budget":return`**Project Budget Overview:**

â€¢ **Total Budget:** ${J(q?.projectBudget)}
â€¢ **Milestone Billable:** ${J(q?.milestoneBillable)}
â€¢ **Actual Spend:** ${J(q?.actualSpend)}
â€¢ **Variance:** ${J(q?.variance)}
â€¢ **Budget Used:** ${q?.percentUsed||0}%

${q?.percentUsed>80?"âš ï¸ Budget utilisation is over 80%.":q?.percentUsed>50?"Budget is tracking normally.":"Budget utilisation is healthy."}`;case"milestoneCount":return`There are **${K?.total||0} milestones** in total:

â€¢ Completed: ${K?.byStatus?.completed||0}
â€¢ In Progress: ${K?.byStatus?.inProgress||0}
â€¢ At Risk: ${K?.byStatus?.atRisk||0}
â€¢ Not Started: ${K?.byStatus?.notStarted||0}`;case"deliverableCount":return`There are **${G?.total||0} deliverables** in total:

â€¢ Delivered: ${G?.byStatus?.delivered||0}
â€¢ Review Complete: ${G?.byStatus?.reviewComplete||0}
â€¢ Awaiting Review: ${G?.byStatus?.awaitingReview||0}
â€¢ In Progress: ${G?.byStatus?.inProgress||0}
â€¢ Not Started: ${G?.byStatus?.notStarted||0}`;case"pending":if(!((F?.draftTimesheets||0)>0||(F?.awaitingValidation||0)>0))return"âœ… **No pending actions!** You're all caught up.";let ee=`**Your Pending Actions:**

`;return F?.draftTimesheets>0&&(ee+=`â€¢ **${F.draftTimesheets}** draft timesheet(s) to submit
`),F?.awaitingValidation>0&&(ee+=`â€¢ **${F.awaitingValidation}** item(s) awaiting your validation
`),ee;case"overview":return`**Project Overview:**

**Budget:** ${J(q?.actualSpend)} of ${J(q?.milestoneBillable)} spent (${q?.percentUsed||0}%)

**Milestones:** ${K?.byStatus?.completed||0} completed, ${K?.byStatus?.inProgress||0} in progress${K?.byStatus?.atRisk>0?`, ${K.byStatus.atRisk} at risk`:""}

**Deliverables:** ${G?.byStatus?.delivered||0} delivered, ${G?.byStatus?.awaitingReview||0} awaiting review

**Timesheets:** ${Y?.totalHours||0} hours logged

Need more details on any of these? Just ask!`;default:return null}},[v]),T=async(U,$=1)=>{D.current=new AbortController;try{const O=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(U),signal:D.current.signal}),q=await O.json().catch(()=>({}));if(!O.ok){if(Ye.retryableCodes.includes(O.status)&&$<=Ye.maxRetries&&q.recoverable!==!1){const G=q.retryAfter?q.retryAfter*1e3:Ye.baseDelayMs*Math.pow(2,$-1);return A($),await new Promise(F=>setTimeout(F,G)),T(U,$+1)}throw new Error(q.error||`Request failed (${O.status})`)}return A(0),q}catch(O){throw O.name==="AbortError"?new Error("Request cancelled"):O}},H=[/budget|spend|cost|variance/i,/milestone.*(status|progress|summary|count|how many)/i,/deliverable.*(status|progress|summary|count|how many)/i,/timesheet.*(summary|total|hours|count|how many)/i,/expense.*(summary|total|amount|count|how many)/i,/pending|action|todo|to do|what.*(do|need)/i,/overview|summary|status|dashboard/i,/how.*(doing|going|progress)/i],he=[/specific|detail|list|show me|find|search/i,/filter|between|from|to|date|week|month|year/i,/resource|person|team member|who/i,/partner|supplier/i,/compare|versus|vs/i,/kpi|quality|standard/i,/\d+/],de=U=>{if(!v)return!1;for(const $ of he)if($.test(U))return!1;for(const $ of H)if($.test(U))return!0;return!1},_e=async(U,$)=>{D.current=new AbortController;const O=await fetch("/api/chat-stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(U),signal:D.current.signal});if(!O.ok)throw new Error("Streaming request failed");const q=O.body.getReader(),K=new TextDecoder;let G="";try{for(;;){const{done:F,value:Y}=await q.read();if(F)break;const J=K.decode(Y,{stream:!0});G+=J,$(G)}}finally{q.releaseLock()}return G},ye=d.useCallback(async U=>{if(!U.trim()||b)return;D.current&&D.current.abort();const $={role:"user",content:U.trim(),timestamp:new Date().toISOString()};g(O=>[...O,$]),m(!0),R(null),A(0);try{const O=oe(U.trim());if(O){await new Promise(Y=>setTimeout(Y,100)),g(Y=>[...Y,{role:"assistant",content:O,toolsUsed:!1,cached:!1,local:!0,timestamp:new Date().toISOString()}]),m(!1);return}const q=_(),K=L();if(de(U)){const Y=y.length+1;g(J=>[...J,{role:"assistant",content:"",toolsUsed:!1,streaming:!0,timestamp:new Date().toISOString()}]);try{const J=[...y.slice(-9),$].map(Z=>({role:Z.role,content:Z.content}));await _e({messages:J,userContext:K,projectContext:q,prefetchedContext:v},Z=>{g(ee=>{const ue=[...ee],We=ue.length-1;return ue[We]?.role==="assistant"&&(ue[We]={...ue[We],content:Z}),ue})}),g(Z=>{const ee=[...Z],ue=ee.length-1;return ee[ue]?.role==="assistant"&&(ee[ue]={...ee[ue],streaming:!1}),ee}),m(!1);return}catch{g(Z=>Z.slice(0,-1))}}const G=[...y.slice(-9),$].map(Y=>({role:Y.role,content:Y.content})),F=await T({messages:G,projectContext:q,userContext:K,projectId:i,prefetchedContext:v});F.usage&&E(Y=>({input:Y.input+(F.usage.input_tokens||0),output:Y.output+(F.usage.output_tokens||0),requests:Y.requests+1})),g(Y=>[...Y,{role:"assistant",content:F.message,toolsUsed:F.toolsUsed||!1,cached:F.cached||!1,timestamp:new Date().toISOString(),tokens:F.usage?{input:F.usage.input_tokens,output:F.usage.output_tokens}:null}])}catch(O){let q=O.message;O.message==="Request cancelled"?q=null:O.message.includes("Failed to fetch")&&(q="Unable to connect. Please check your internet connection."),q&&(R(q),g(K=>K.slice(0,-1)))}finally{m(!1),A(0)}},[y,b,_,L,i,v]),me=d.useCallback(()=>{D.current&&(D.current.abort(),m(!1),A(0))},[]),I=d.useCallback(()=>{me(),g([]),R(null),localStorage.removeItem(ct)},[me]),Q=d.useCallback(()=>{I(),E({input:0,output:0,requests:0})},[I]),mt=d.useCallback(()=>{h(U=>!U)},[]),xe=d.useCallback(()=>{R(null)},[]),fe=d.useCallback(()=>{if(y.length===0)return null;const U=L(),$=_();let O=`# Chat Export

`;return O+=`**Exported:** ${new Date().toLocaleString("en-GB")}
`,O+=`**User:** ${U.name} (${U.role})
`,$&&(O+=`**Project:** ${$.name} (${$.reference})
`),O+=`**Messages:** ${y.length}
`,O+=`**Token Usage:** ${S.input.toLocaleString()} input / ${S.output.toLocaleString()} output

`,O+=`---

`,y.forEach((q,K)=>{const G=q.role==="user"?"ðŸ‘¤ You":"ðŸ¤– Assistant",F=q.timestamp?new Date(q.timestamp).toLocaleTimeString("en-GB"):"";O+=`### ${G}${F?` (${F})`:""}

`,O+=`${q.content}

`,q.toolsUsed&&(O+=`*ðŸ“Š Queried project data*

`),K<y.length-1&&(O+=`---

`)}),O},[y,S,L,_]),Ce=d.useCallback(()=>{const U=fe();if(!U)return;const $=new Blob([U],{type:"text/markdown"}),O=URL.createObjectURL($),q=document.createElement("a");q.href=O,q.download=`chat-export-${new Date().toISOString().split("T")[0]}.md`,document.body.appendChild(q),q.click(),document.body.removeChild(q),URL.revokeObjectURL(O)},[fe]),De=d.useCallback(async U=>{try{return await navigator.clipboard.writeText(U),!0}catch{return!1}},[]),Ne={isOpen:f,setIsOpen:h,toggleChat:mt,messages:y,isLoading:b,isLoadingContext:N,error:w,retryCount:M,tokenUsage:S,sendMessage:ye,clearChat:I,resetAllStats:Q,cancelRequest:me,dismissError:xe,exportChat:fe,downloadChat:Ce,copyMessage:De};return e.jsx(Ht.Provider,{value:Ne,children:n})}function aa(){const n=d.useContext(Ht);if(!n)throw new Error("useChat must be used within a ChatProvider");return n}class na extends Rt.Component{constructor(t){super(t);Fe(this,"handleReload",()=>{window.location.reload()});Fe(this,"handleReset",()=>{this.setState({hasError:!1,error:null,errorInfo:null})});this.state={hasError:!1,error:null,errorInfo:null}}static getDerivedStateFromError(t){return{hasError:!0,error:t}}componentDidCatch(t,s){this.setState({errorInfo:s})}render(){return this.state.hasError?this.props.fallback?this.props.fallback:e.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"3rem",backgroundColor:"#fef2f2",borderRadius:"12px",margin:"1rem",border:"1px solid #fecaca"},children:[e.jsx(Pt,{size:48,style:{color:"#dc2626",marginBottom:"1rem"}}),e.jsx("h2",{style:{color:"#991b1b",margin:"0 0 0.5rem 0",fontSize:"1.25rem",fontWeight:"600"},children:"Something went wrong"}),e.jsx("p",{style:{color:"#64748b",margin:"0 0 1.5rem 0",textAlign:"center",maxWidth:"400px"},children:this.state.error?.message||"An unexpected error occurred. Please try again."}),e.jsxs("div",{style:{display:"flex",gap:"0.75rem"},children:[e.jsx("button",{onClick:this.handleReset,style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.625rem 1.25rem",backgroundColor:"white",color:"#374151",border:"1px solid #d1d5db",borderRadius:"8px",cursor:"pointer",fontSize:"0.875rem",fontWeight:"500"},children:"Try Again"}),e.jsxs("button",{onClick:this.handleReload,style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.625rem 1.25rem",backgroundColor:"#3b82f6",color:"white",border:"none",borderRadius:"8px",cursor:"pointer",fontSize:"0.875rem",fontWeight:"500"},children:[e.jsx(Se,{size:16}),"Reload Page"]})]})]}):this.props.children}}function Kt({message:n,size:r="medium",fullPage:t=!1,className:s=""}){const a={small:"spinner-sm",medium:"",large:"spinner-lg"};return e.jsxs("div",{className:`loading-spinner ${s}`,style:t?{minHeight:"60vh"}:void 0,children:[e.jsx("div",{className:`spinner ${a[r]}`}),n&&e.jsx("p",{className:"loading-text",children:n})]})}const ia={background:"linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%)",backgroundSize:"200% 100%",animation:"shimmer 1.5s infinite"};function re({width:n="100%",height:r="1rem",style:t={},className:s=""}){return e.jsxs(e.Fragment,{children:[e.jsx("style",{children:`
        @keyframes shimmer {
          0% { background-position: 200% 0; }
          100% { background-position: -200% 0; }
        }
      `}),e.jsx("div",{className:s,style:{width:n,height:r,borderRadius:"4px",...ia,...t}})]})}function nt({width:n="100%",lines:r=1}){return e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"0.5rem"},children:Array.from({length:r}).map((t,s)=>e.jsx(re,{width:s===r-1&&r>1?"70%":n,height:"1rem"},s))})}function oa(){return e.jsxs("div",{style:{backgroundColor:"white",borderRadius:"12px",padding:"1.5rem",boxShadow:"0 1px 3px rgba(0,0,0,0.1)",display:"flex",alignItems:"center",gap:"1rem"},children:[e.jsx(re,{width:"48px",height:"48px",style:{borderRadius:"12px"}}),e.jsxs("div",{style:{flex:1},children:[e.jsx(re,{width:"60%",height:"0.875rem",style:{marginBottom:"0.5rem"}}),e.jsx(re,{width:"40%",height:"1.5rem"})]})]})}function la({columns:n=6}){return e.jsx("tr",{children:Array.from({length:n}).map((r,t)=>e.jsx("td",{style:{padding:"0.75rem 1rem"},children:e.jsx(re,{width:t===0?"80%":t===n-1?"60px":"70%",height:"1rem"})},t))})}function Xe({hasHeader:n=!0}){return e.jsxs("div",{style:{backgroundColor:"white",borderRadius:"12px",padding:"1.5rem",boxShadow:"0 1px 3px rgba(0,0,0,0.1)"},children:[n&&e.jsx(re,{width:"40%",height:"1.5rem",style:{marginBottom:"1rem"}}),e.jsx(nt,{lines:3})]})}function ke({type:n="text",count:r=1,...t}){return(()=>{switch(n){case"text":return e.jsx(nt,{...t});case"stat-card":case"stats":return e.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:"1rem"},children:Array.from({length:r}).map((a,i)=>e.jsx(oa,{},i))});case"table":return e.jsx("div",{className:"card",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsx("tr",{children:Array.from({length:t.columns||6}).map((a,i)=>e.jsx("th",{style:{padding:"0.75rem 1rem"},children:e.jsx(re,{width:"60%",height:"0.875rem"})},i))})}),e.jsx("tbody",{children:Array.from({length:t.rows||5}).map((a,i)=>e.jsx(la,{columns:t.columns||6},i))})]})});case"card":return e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"1rem"},children:Array.from({length:r}).map((a,i)=>e.jsx(Xe,{...t},i))});case"page":return e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"1.5rem"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsx(re,{width:"200px",height:"1.75rem",style:{marginBottom:"0.5rem"}}),e.jsx(re,{width:"300px",height:"1rem"})]}),e.jsx(re,{width:"120px",height:"40px",style:{borderRadius:"8px"}})]}),e.jsx(ke,{type:"stats",count:4}),e.jsx(ke,{type:"table",rows:8,columns:6})]});case"detail":return e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"1.5rem"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"1rem"},children:[e.jsx(re,{width:"80px",height:"36px",style:{borderRadius:"8px"}}),e.jsx(re,{width:"250px",height:"1.75rem"})]}),e.jsx(ke,{type:"stats",count:4}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsx(Xe,{}),e.jsx(Xe,{})]}),e.jsx(ke,{type:"table",rows:5,columns:5})]});default:return e.jsx(nt,{...t})}})()}const wt={success:{icon:we,bgColor:"#dcfce7",borderColor:"#86efac",textColor:"#166534",iconColor:"#16a34a"},error:{icon:At,bgColor:"#fee2e2",borderColor:"#fecaca",textColor:"#991b1b",iconColor:"#dc2626"},warning:{icon:Pt,bgColor:"#fef3c7",borderColor:"#fde68a",textColor:"#92400e",iconColor:"#d97706"},info:{icon:Fr,bgColor:"#dbeafe",borderColor:"#93c5fd",textColor:"#1e40af",iconColor:"#3b82f6"}};function ca({id:n,message:r,type:t="info",duration:s=4e3,onClose:a}){const i=wt[t]||wt.info,o=i.icon;return d.useEffect(()=>{if(s>0){const c=setTimeout(()=>{a(n)},s);return()=>clearTimeout(c)}},[n,s,a]),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem",padding:"0.875rem 1rem",backgroundColor:i.bgColor,border:`1px solid ${i.borderColor}`,borderRadius:"8px",boxShadow:"0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)",minWidth:"300px",maxWidth:"450px",animation:"slideIn 0.3s ease-out"},children:[e.jsx(o,{size:20,style:{color:i.iconColor,flexShrink:0}}),e.jsx("span",{style:{color:i.textColor,fontSize:"0.875rem",fontWeight:"500",flex:1},children:r}),e.jsx("button",{onClick:()=>a(n),style:{background:"none",border:"none",cursor:"pointer",padding:"0.25rem",display:"flex",alignItems:"center",justifyContent:"center",color:i.textColor,opacity:.7,borderRadius:"4px"},onMouseEnter:c=>c.target.style.opacity=1,onMouseLeave:c=>c.target.style.opacity=.7,children:e.jsx(pe,{size:16})})]})}function da({toasts:n,removeToast:r}){return n.length===0?null:e.jsxs("div",{style:{position:"fixed",top:"1rem",right:"1rem",zIndex:9999,display:"flex",flexDirection:"column",gap:"0.5rem"},children:[e.jsx("style",{children:`
          @keyframes slideIn {
            from {
              transform: translateX(100%);
              opacity: 0;
            }
            to {
              transform: translateX(0);
              opacity: 1;
            }
          }
        `}),n.map(t=>e.jsx(ca,{id:t.id,message:t.message,type:t.type,duration:t.duration,onClose:r},t.id))]})}const Gt=d.createContext(null),ua=4e3;function ha({children:n}){const[r,t]=d.useState([]),s=d.useCallback(f=>{t(h=>h.filter(y=>y.id!==f))},[]),a=d.useCallback((f,h="info",y=ua)=>{const g=Date.now()+Math.random(),b={id:g,message:f,type:h,duration:y};return t(m=>[...m,b]),g},[]),i=d.useCallback((f,h)=>a(f,"success",h),[a]),o=d.useCallback((f,h)=>a(f,"error",h||6e3),[a]),c=d.useCallback((f,h)=>a(f,"warning",h),[a]),l=d.useCallback((f,h)=>a(f,"info",h),[a]),u={showToast:a,showSuccess:i,showError:o,showWarning:c,showInfo:l,removeToast:s};return e.jsxs(Gt.Provider,{value:u,children:[n,e.jsx(da,{toasts:r,removeToast:s})]})}function Qt(){const n=d.useContext(Gt);if(!n)throw new Error("useToast must be used within a ToastProvider");return n}const X={timesheets:{contributeToSpend:["Submitted","Validated","Approved"],excludeFromSpend:["Draft","Rejected"],completed:["Validated","Approved"]},expenses:{contributeToSpend:["Submitted","Validated","Approved"],excludeFromSpend:["Draft","Rejected"],completed:["Validated","Approved"]},deliverables:{contributeToKPIs:["Delivered"],contributeToQS:["Delivered"],inProgress:["In Progress","Submitted","Under Review"],completed:["Delivered"],notStarted:["Not Started","Draft"]},milestones:{completed:["Completed"],inProgress:["In Progress"],notStarted:["Not Started","Planned"]},kpis:{achieved:["Achieved","On Target"],atRisk:["At Risk","Amber"],failing:["Failing","Red","Off Target"]},qualityStandards:{achieved:["Achieved","Met"],partial:["Partial","In Progress"],notMet:["Not Met","Failed"]}},ma=["pmo","project manager","pm"];function Re(n){if(!n)return!1;const r=n.toLowerCase();return ma.some(t=>r.includes(t))}function _t(n){return n?X.timesheets.contributeToSpend.includes(n):!1}function vt(n){return n?X.expenses.contributeToSpend.includes(n):!1}const St={defaultTarget:90,amberThreshold:10,calculationMethod:"assessment_based"},fa={defaultTarget:100,calculationMethod:"assessment_based"},Yt={hoursPerDay:8,currency:"Â£",currencyCode:"GBP",decimalPlaces:2};function je(n){return(parseFloat(n)||0)/Yt.hoursPerDay}function dt(n,r){return je(n)*(parseFloat(r)||0)}function jt(n,r){return je(n)*(parseFloat(r)||0)}class ga{constructor(){this.cache=new Map,this.cacheTimeout=5e3}clearCache(){this.cache.clear()}getCached(r){const t=this.cache.get(r);return t&&Date.now()-t.timestamp<this.cacheTimeout?t.data:null}setCache(r,t){this.cache.set(r,{data:t,timestamp:Date.now()})}async getMilestoneMetrics(r){const t=`milestones_${r}`,s=this.getCached(t);if(s)return s;try{const{data:a,error:i}=await p.from("milestones").select("id, milestone_ref, name, status, progress, budget, percent_complete, is_deleted").eq("project_id",r).order("milestone_ref");if(i)throw i;const o=a?.filter(l=>l.is_deleted!==!0)||[],c={total:o.length,completed:o.filter(l=>X.milestones.completed.includes(l.status)).length,inProgress:o.filter(l=>X.milestones.inProgress.includes(l.status)).length,notStarted:o.filter(l=>X.milestones.notStarted.includes(l.status)).length,totalBudget:o.reduce((l,u)=>l+(u.budget||0),0),averageProgress:o.length>0?Math.round(o.reduce((l,u)=>l+(u.progress||0),0)/o.length):0,milestones:o};return this.setCache(t,c),c}catch(a){throw a}}async getDeliverableMetrics(r,t=!1){const s=`deliverables_${r}_${t}`,a=this.getCached(s);if(a)return a;try{const{data:i,error:o}=await p.from("deliverables").select("id, deliverable_ref, name, status, due_date, milestone_id, is_deleted, is_test_content").eq("project_id",r).order("deliverable_ref");if(o)throw o;let c=i?.filter(y=>y.is_deleted!==!0)||[];t||(c=c.filter(y=>y.is_test_content!==!0));const l=new Date().toISOString().split("T")[0],u=new Date;u.setDate(u.getDate()+7);const f=u.toISOString().split("T")[0],h={total:c.length,delivered:c.filter(y=>X.deliverables.completed.includes(y.status)).length,inProgress:c.filter(y=>X.deliverables.inProgress.includes(y.status)).length,notStarted:c.filter(y=>X.deliverables.notStarted.includes(y.status)).length,overdue:c.filter(y=>y.due_date<l&&!X.deliverables.completed.includes(y.status)).length,dueThisWeek:c.filter(y=>y.due_date>=l&&y.due_date<=f&&!X.deliverables.completed.includes(y.status)).length,deliverables:c};return h.completionPercent=h.total>0?Math.round(h.delivered/h.total*100):0,this.setCache(s,h),h}catch(i){throw i}}async getKPIMetrics(r){const t=`kpis_${r}`,s=this.getCached(t);if(s)return s;try{const{data:a,error:i}=await p.from("kpis").select("id, kpi_ref, name, category, target, current_value, is_deleted").eq("project_id",r).order("kpi_ref");if(i)throw i;const o=a?.filter(b=>b.is_deleted!==!0)||[],{data:c,error:l}=await p.from("deliverable_kpi_assessments").select(`
          kpi_id,
          criteria_met,
          deliverables!inner(id, status, is_deleted, project_id)
        `).eq("deliverables.project_id",r),u=c?.filter(b=>b.deliverables?.is_deleted!==!0&&X.deliverables.contributeToKPIs.includes(b.deliverables?.status))||[],f=new Map;u&&u.length>0&&u.forEach(b=>{f.has(b.kpi_id)||f.set(b.kpi_id,{total:0,met:0});const m=f.get(b.kpi_id);m.total++,b.criteria_met&&m.met++});const h=o.map(b=>{const m=f.get(b.id);let w=0;m&&m.total>0&&(w=Math.round(m.met/m.total*100));const R=b.target||St.defaultTarget,M=w>=R;return{...b,calculatedValue:w,assessmentCount:m?.total||0,assessmentsMet:m?.met||0,isAchieved:M,ragStatus:w>=R?"Green":w>=R*(1-St.amberThreshold/100)?"Amber":"Red"}}),y={};h.forEach(b=>{const m=b.category||"Other";y[m]||(y[m]=[]),y[m].push(b)});const g={total:o.length,achieved:h.filter(b=>b.isAchieved).length,atRisk:h.filter(b=>b.ragStatus==="Amber").length,failing:h.filter(b=>b.ragStatus==="Red").length,achievementPercent:o.length>0?Math.round(h.filter(b=>b.isAchieved).length/o.length*100):0,byCategory:y,kpis:h};return this.setCache(t,g),g}catch(a){throw a}}async getQualityStandardMetrics(r){const t=`qs_${r}`,s=this.getCached(t);if(s)return s;try{const{data:a,error:i}=await p.from("quality_standards").select("id, qs_ref, name, target, current_value, is_deleted").eq("project_id",r).order("qs_ref");if(i)throw i;const o=a?.filter(g=>g.is_deleted!==!0)||[],{data:c,error:l}=await p.from("deliverable_qs_assessments").select(`
          quality_standard_id,
          criteria_met,
          deliverables!inner(id, status, is_deleted, project_id)
        `).eq("deliverables.project_id",r),u=c?.filter(g=>g.deliverables?.is_deleted!==!0&&X.deliverables.contributeToQS.includes(g.deliverables?.status))||[],f=new Map;u&&u.length>0&&u.forEach(g=>{f.has(g.quality_standard_id)||f.set(g.quality_standard_id,{total:0,met:0});const b=f.get(g.quality_standard_id);b.total++,g.criteria_met&&b.met++});const h=o.map(g=>{const b=f.get(g.id);let m=0;b&&b.total>0&&(m=Math.round(b.met/b.total*100));const w=g.target||fa.defaultTarget,R=m>=w;return{...g,calculatedValue:m,assessmentCount:b?.total||0,assessmentsMet:b?.met||0,isAchieved:R}}),y={total:o.length,achieved:h.filter(g=>g.isAchieved).length,partial:h.filter(g=>g.calculatedValue>0&&!g.isAchieved).length,notMet:h.filter(g=>g.calculatedValue===0).length,achievementPercent:o.length>0?Math.round(h.filter(g=>g.isAchieved).length/o.length*100):0,qualityStandards:h};return this.setCache(t,y),y}catch(a){throw a}}async getTimesheetMetrics(r,t=!1){const s=`timesheets_${r}_${t}`,a=this.getCached(s);if(a)return a;try{const{data:i,error:o}=await p.from("timesheets").select(`
          id, date, hours_worked, hours, status, milestone_id, resource_id, is_deleted,
          resources(id, name, role, sell_price)
        `).eq("project_id",r);if(o)throw o;const c=i?.filter(m=>m.is_deleted!==!0)||[];let l=0,u=0,f=0,h=0;const y={},g={};c.forEach(m=>{const w=parseFloat(m.hours_worked||m.hours||0),R=m.resources,M=R?.sell_price||0,A=w/Yt.hoursPerDay*M;_t(m.status)&&(l+=w,u+=A,Re(R?.role)?f+=A:h+=A,m.milestone_id&&(y[m.milestone_id]=(y[m.milestone_id]||0)+A),m.resource_id&&(g[m.resource_id]=(g[m.resource_id]||0)+A))});const b={totalEntries:c.length,validEntries:c.filter(m=>_t(m.status)).length,draftEntries:c.filter(m=>m.status==="Draft").length,rejectedEntries:c.filter(m=>m.status==="Rejected").length,totalHours:l,totalSpend:u,pmoSpend:f,deliverySpend:h,spendByMilestone:y,spendByResource:g};return this.setCache(s,b),b}catch(i){throw i}}async getExpenseMetrics(r,t=!1){const s=`expenses_${r}_${t}`,a=this.getCached(s);if(a)return a;try{const{data:i,error:o}=await p.from("expenses").select("id, expense_date, amount, status, category, chargeable_to_customer, procurement_method, is_deleted").eq("project_id",r);if(o)throw o;const c=i?.filter(g=>g.is_deleted!==!0)||[];let l=0,u=0,f=0;const h={};c.forEach(g=>{const b=parseFloat(g.amount||0);if(vt(g.status)){l+=b,g.chargeable_to_customer?u+=b:f+=b;const m=g.category||"Other";h[m]=(h[m]||0)+b}});const y={totalEntries:c.length,validEntries:c.filter(g=>vt(g.status)).length,draftEntries:c.filter(g=>g.status==="Draft").length,rejectedEntries:c.filter(g=>g.status==="Rejected").length,totalAmount:l,chargeableAmount:u,nonChargeableAmount:f,byCategory:h};return this.setCache(s,y),y}catch(i){throw i}}async getResourceMetrics(r){const t=`resources_${r}`,s=this.getCached(t);if(s)return s;try{const{data:a,error:i}=await p.from("resources").select("id, name, role, sell_price, days_allocated, is_deleted").eq("project_id",r);if(i)throw i;const o=a?.filter(f=>f.is_deleted!==!0)||[];let c=0,l=0;o.forEach(f=>{const h=(f.sell_price||0)*(f.days_allocated||0);Re(f.role)?c+=h:l+=h});const u={total:o.length,pmoCount:o.filter(f=>Re(f.role)).length,deliveryCount:o.filter(f=>!Re(f.role)).length,pmoBudget:c,deliveryBudget:l,totalBudget:c+l,resources:o};return this.setCache(t,u),u}catch(a){throw a}}async getCertificateMetrics(r){const t=`certificates_${r}`,s=this.getCached(t);if(s)return s;try{const{data:a,error:i}=await p.from("milestone_certificates").select("id, milestone_id, status").eq("project_id",r);if(i)throw i;const o=await this.getMilestoneMetrics(r),c={total:a?.length||0,signed:a?.filter(l=>l.status==="Signed").length||0,pending:a?.filter(l=>l.status==="Pending Customer Signature"||l.status==="Pending Supplier Signature").length||0,awaitingGeneration:Math.max(0,o.completed-(a?.length||0))};return this.setCache(t,c),c}catch(a){throw a}}async getAllDashboardMetrics(r,t={}){const{includeTestContent:s=!1}=t;try{const[a,i,o,c,l,u,f,h]=await Promise.all([this.getMilestoneMetrics(r),this.getDeliverableMetrics(r,s),this.getKPIMetrics(r),this.getQualityStandardMetrics(r),this.getTimesheetMetrics(r,s),this.getExpenseMetrics(r,s),this.getResourceMetrics(r),this.getCertificateMetrics(r)]),y={totalBudget:a.totalBudget,timesheetSpend:l.totalSpend,expenseSpend:u.totalAmount,totalSpend:l.totalSpend+u.totalAmount,pmoBudget:f.pmoBudget,pmoSpend:l.pmoSpend,deliveryBudget:f.deliveryBudget,deliverySpend:l.deliverySpend,utilizationPercent:a.totalBudget>0?Math.round((l.totalSpend+u.totalAmount)/a.totalBudget*100):0},g={...l.spendByMilestone};return Object.entries(u.byMilestone).forEach(([b,m])=>{g[b]=(g[b]||0)+m}),{milestones:a,deliverables:i,kpis:o,qualityStandards:c,timesheets:l,expenses:u,resources:f,certificates:h,budget:y,milestoneSpend:g,projectProgress:a.averageProgress,lastUpdated:new Date().toISOString()}}catch(a){throw a}}}const ae=new ga,Xt=d.createContext(null);function pa({children:n}){const{projectId:r}=ne(),{showTestUsers:t}=Wt(),[s,a]=d.useState(null),[i,o]=d.useState(!0),[c,l]=d.useState(null),[u,f]=d.useState(null),h=d.useCallback(async(b=!1)=>{if(!r){a(null),o(!1);return}b&&ae.clearCache(),o(!0),l(null);try{const m=await ae.getAllDashboardMetrics(r,{includeTestContent:t});a(m),f(new Date)}catch(m){l(m.message||"Failed to load metrics")}finally{o(!1)}},[r,t]),y=d.useCallback(async b=>{if(r)try{let m;switch(b){case"milestones":m=await ae.getMilestoneMetrics(r),a(w=>w?{...w,milestones:m}:null);break;case"deliverables":m=await ae.getDeliverableMetrics(r,t),a(w=>w?{...w,deliverables:m}:null);break;case"kpis":m=await ae.getKPIMetrics(r),a(w=>w?{...w,kpis:m}:null);break;case"qualityStandards":m=await ae.getQualityStandardMetrics(r),a(w=>w?{...w,qualityStandards:m}:null);break;case"timesheets":m=await ae.getTimesheetMetrics(r,t),a(w=>w?{...w,timesheets:m}:null);break;case"expenses":m=await ae.getExpenseMetrics(r,t),a(w=>w?{...w,expenses:m}:null);break;case"resources":m=await ae.getResourceMetrics(r),a(w=>w?{...w,resources:m}:null);break;case"certificates":m=await ae.getCertificateMetrics(r),a(w=>w?{...w,certificates:m}:null);break;default:await h(!0)}f(new Date)}catch{}},[r,t,h]);d.useEffect(()=>{h()},[h]);const g=d.useMemo(()=>({metrics:s,milestones:s?.milestones||null,deliverables:s?.deliverables||null,kpis:s?.kpis||null,qualityStandards:s?.qualityStandards||null,timesheets:s?.timesheets||null,expenses:s?.expenses||null,resources:s?.resources||null,certificates:s?.certificates||null,billable:s?.billable||null,milestoneSpend:s?.milestoneSpend||{},projectProgress:s?.projectProgress||0,loading:i,error:c,lastRefresh:u,refreshMetrics:()=>h(!0),refreshCategory:y,clearCache:()=>ae.clearCache()}),[s,i,c,u,h,y]);return e.jsx(Xt.Provider,{value:g,children:n})}function pi(){const n=d.useContext(Xt);if(!n)throw new Error("useMetrics must be used within a MetricsProvider");return n}function ya(){const{isOpen:n,toggleChat:r,messages:t,isLoading:s,isLoadingContext:a,error:i,retryCount:o,tokenUsage:c,sendMessage:l,clearChat:u,cancelRequest:f,dismissError:h,downloadChat:y,copyMessage:g}=aa(),[b,m]=d.useState(""),[w,R]=d.useState(null),[M,A]=d.useState(!1),S=d.useRef(null),E=d.useRef(null);d.useEffect(()=>{S.current?.scrollIntoView({behavior:"smooth"})},[t]),d.useEffect(()=>{n&&setTimeout(()=>E.current?.focus(),100)},[n]),d.useEffect(()=>{if(w!==null){const _=setTimeout(()=>R(null),2e3);return()=>clearTimeout(_)}},[w]);const v=_=>{_.preventDefault(),b.trim()&&!s&&(l(b),m(""))},k=_=>{_.key==="Enter"&&!_.shiftKey&&(_.preventDefault(),v(_))},N=async(_,L)=>{await g(_)&&R(L)},j={role:"assistant",content:`Hello! I'm your Project Assistant. I can query your project data and help you understand what's happening. Try asking:

â€¢ **"What do I need to do?"** - See your pending actions
â€¢ **"Show my timesheets this month"** - Query your time entries
â€¢ **"What milestones are at risk?"** - Check project progress
â€¢ **"What's the budget status?"** - View spend vs forecast
â€¢ **"What can my role do?"** - Understand your permissions

All data is scoped to your role, so just ask naturally!`},D=t.length===0?[j]:t,C=(c.input*.25/1e6+c.output*1.25/1e6).toFixed(4);return e.jsxs(e.Fragment,{children:[e.jsx("button",{className:`chat-toggle-btn ${n?"chat-open":""}`,onClick:r,"aria-label":n?"Close chat":"Open AI assistant",children:n?e.jsx(pe,{size:24}):e.jsxs(e.Fragment,{children:[e.jsx(Hr,{size:24}),e.jsx(Kr,{className:"chat-sparkle",size:12})]})}),e.jsxs("div",{className:`chat-panel ${n?"chat-panel-open":""}`,children:[e.jsxs("div",{className:"chat-header",children:[e.jsxs("div",{className:"chat-header-title",children:[e.jsx(He,{size:20}),e.jsx("span",{children:"Project Assistant"})]}),e.jsxs("div",{className:"chat-header-actions",children:[t.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"chat-action-btn",onClick:y,title:"Export chat as Markdown",children:e.jsx(Gr,{size:16})}),e.jsx("button",{className:"chat-action-btn",onClick:u,title:"Clear chat",children:e.jsx(Qr,{size:16})})]}),e.jsx("button",{className:"chat-close-btn",onClick:r,"aria-label":"Close chat",children:e.jsx(pe,{size:20})})]})]}),e.jsxs("div",{className:"chat-messages",children:[D.map((_,L)=>e.jsxs("div",{className:`chat-message ${_.role==="user"?"chat-message-user":"chat-message-assistant"} ${_.streaming?"chat-message-streaming":""}`,children:[e.jsx("div",{className:"chat-message-avatar",children:_.role==="user"?e.jsx(Yr,{size:16}):e.jsx(He,{size:16})}),e.jsxs("div",{className:"chat-message-content",children:[e.jsx(xa,{content:_.content}),e.jsxs("div",{className:"chat-message-actions",children:[_.local&&e.jsx("span",{className:"chat-local-indicator",title:"Instant response from cached data",children:e.jsx(ft,{size:12})}),_.toolsUsed&&e.jsx("span",{className:"chat-tools-indicator",title:"Queried project data",children:e.jsx(Xr,{size:12})}),e.jsx("button",{className:"chat-copy-btn",onClick:()=>N(_.content,L),title:w===L?"Copied!":"Copy message",children:w===L?e.jsx(Te,{size:12,className:"chat-copy-success"}):e.jsx(Jr,{size:12})})]})]})]},L)),s&&e.jsxs("div",{className:"chat-message chat-message-assistant",children:[e.jsx("div",{className:"chat-message-avatar",children:e.jsx(He,{size:16})}),e.jsxs("div",{className:"chat-message-content chat-typing",children:[o>0?e.jsxs(e.Fragment,{children:[e.jsx(Se,{className:"chat-typing-icon",size:16}),e.jsxs("span",{children:["Retrying (",o,"/2)..."]})]}):e.jsxs(e.Fragment,{children:[e.jsx(gt,{className:"chat-typing-icon",size:16}),e.jsx("span",{children:"Querying data..."})]}),e.jsx("button",{className:"chat-cancel-btn",onClick:f,title:"Cancel request",children:e.jsx(At,{size:14})})]})]}),i&&e.jsxs("div",{className:"chat-error",children:[e.jsx("span",{children:i}),e.jsx("button",{className:"chat-error-dismiss",onClick:h,title:"Dismiss",children:e.jsx(pe,{size:14})})]}),e.jsx("div",{ref:S})]}),e.jsxs("form",{className:"chat-input-form",onSubmit:v,children:[e.jsx("textarea",{ref:E,className:"chat-input",value:b,onChange:_=>m(_.target.value),onKeyDown:k,placeholder:"Ask me anything about the project...",rows:1,disabled:s}),e.jsx("button",{type:"submit",className:"chat-send-btn",disabled:!b.trim()||s,"aria-label":"Send message",children:e.jsx(It,{size:18})})]}),e.jsxs("div",{className:"chat-footer",children:[e.jsx("button",{className:"chat-stats-toggle",onClick:()=>A(!M),title:"Toggle usage stats",children:e.jsx(Zr,{size:12})}),M?e.jsxs("div",{className:"chat-stats",children:[e.jsxs("span",{title:"Total requests",children:[c.requests," req"]}),e.jsx("span",{className:"chat-stats-divider",children:"â€¢"}),e.jsxs("span",{title:"Input tokens",children:[c.input.toLocaleString()," in"]}),e.jsx("span",{className:"chat-stats-divider",children:"â€¢"}),e.jsxs("span",{title:"Output tokens",children:[c.output.toLocaleString()," out"]}),e.jsx("span",{className:"chat-stats-divider",children:"â€¢"}),e.jsxs("span",{title:"Estimated cost",children:["$",C]})]}):a?e.jsxs("span",{className:"chat-context-loading",children:[e.jsx(gt,{size:12,className:"chat-context-spinner"}),"Loading context..."]}):e.jsxs("span",{className:"chat-context-ready",title:"Project data pre-loaded for faster responses",children:[e.jsx(ft,{size:12}),"Powered by Claude AI"]})]})]})]})}function xa({content:n}){const r=n.split(`
`);return e.jsx("div",{className:"chat-message-text",children:r.map((t,s)=>{if(t.startsWith("â€¢ ")||t.startsWith("- ")){const a=t.substring(2);return e.jsxs("div",{className:"chat-bullet",children:[e.jsx("span",{className:"chat-bullet-dot",children:"â€¢"}),e.jsx("span",{dangerouslySetInnerHTML:{__html:Ct(a)}})]},s)}return t.trim()===""?e.jsx("div",{className:"chat-line-break"},s):e.jsx("p",{dangerouslySetInnerHTML:{__html:Ct(t)}},s)})})}function Ct(n){return n.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>")}function ba(){const[n,r]=d.useState(!1),t=d.useRef(null),s=ce(),{notifications:a,unreadCount:i,actionCount:o,loading:c,markAsRead:l,markAsActioned:u,markAllAsRead:f,dismissNotification:h}=Js();d.useEffect(()=>{function S(E){t.current&&!t.current.contains(E.target)&&r(!1)}return document.addEventListener("mousedown",S),()=>document.removeEventListener("mousedown",S)},[]);const y=S=>{switch(S){case"timesheet":return e.jsx(le,{size:16});case"expense":return e.jsx(Oe,{size:16});case"deliverable":return e.jsx(ze,{size:16});case"certificate":return e.jsx(Pe,{size:16});default:return e.jsx(Ke,{size:16})}},g=S=>S.notification_type==="action"?S.is_actioned?"#10b981":"#f59e0b":"#3b82f6",b=async S=>{S.is_read||await l(S.id),S.action_url&&(s(S.action_url),r(!1))},m=async(S,E)=>{S.stopPropagation(),await u(E.id),E.action_url&&(s(E.action_url),r(!1))},w=async(S,E)=>{S.stopPropagation(),await h(E.id)},R=S=>{const E=new Date(S),k=new Date-E,N=Math.floor(k/6e4),j=Math.floor(k/36e5),D=Math.floor(k/864e5);return N<1?"Just now":N<60?`${N}m ago`:j<24?`${j}h ago`:D<7?`${D}d ago`:E.toLocaleDateString("en-GB",{day:"numeric",month:"short"})},M=a.slice(0,10),A=a.filter(S=>S.notification_type==="action"&&!S.is_actioned);return e.jsxs("div",{className:"notification-bell-container",ref:t,style:{position:"relative"},children:[e.jsxs("button",{onClick:()=>r(!n),style:{position:"relative",background:"none",border:"none",cursor:"pointer",padding:"8px",borderRadius:"8px",display:"flex",alignItems:"center",justifyContent:"center",transition:"background-color 0.2s",backgroundColor:n?"#f1f5f9":"transparent"},onMouseEnter:S=>S.target.style.backgroundColor="#f1f5f9",onMouseLeave:S=>S.target.style.backgroundColor=n?"#f1f5f9":"transparent",title:`${o} actions pending`,children:[e.jsx(Ke,{size:22,color:"#64748b"}),(i>0||o>0)&&e.jsx("span",{style:{position:"absolute",top:"2px",right:"2px",backgroundColor:o>0?"#ef4444":"#3b82f6",color:"white",fontSize:"11px",fontWeight:"600",minWidth:"18px",height:"18px",borderRadius:"9px",display:"flex",alignItems:"center",justifyContent:"center",padding:"0 4px"},children:o>0?o:i})]}),n&&e.jsxs("div",{style:{position:"absolute",top:"100%",right:0,marginTop:"8px",width:"380px",maxHeight:"500px",backgroundColor:"white",borderRadius:"12px",boxShadow:"0 10px 40px rgba(0,0,0,0.15)",border:"1px solid #e2e8f0",zIndex:1e3,overflow:"hidden"},children:[e.jsxs("div",{style:{padding:"16px",borderBottom:"1px solid #e2e8f0",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsx("h3",{style:{margin:0,fontSize:"16px",fontWeight:"600"},children:"Notifications"}),o>0&&e.jsxs("p",{style:{margin:"4px 0 0",fontSize:"13px",color:"#f59e0b"},children:[o," action",o!==1?"s":""," required"]})]}),i>0&&e.jsx("button",{onClick:f,style:{background:"none",border:"none",color:"#3b82f6",fontSize:"13px",cursor:"pointer",padding:"4px 8px",borderRadius:"4px"},children:"Mark all read"})]}),A.length>0&&e.jsxs("div",{style:{padding:"12px 16px",backgroundColor:"#fffbeb",borderBottom:"1px solid #fef3c7"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"8px"},children:[e.jsx("div",{style:{width:"8px",height:"8px",borderRadius:"50%",backgroundColor:"#f59e0b",animation:"pulse 2s infinite"}}),e.jsx("span",{style:{fontWeight:"600",fontSize:"13px",color:"#92400e"},children:"Actions Requiring Attention"})]}),e.jsxs("button",{onClick:()=>{s("/workflow-summary"),r(!1)},style:{width:"100%",padding:"8px 12px",backgroundColor:"#f59e0b",color:"white",border:"none",borderRadius:"6px",cursor:"pointer",fontSize:"13px",fontWeight:"500",display:"flex",alignItems:"center",justifyContent:"center",gap:"6px"},children:["View Workflow Summary",e.jsx(es,{size:16})]})]}),e.jsx("div",{style:{maxHeight:"350px",overflowY:"auto"},children:c?e.jsx("div",{style:{padding:"32px",textAlign:"center",color:"#64748b"},children:"Loading..."}):M.length===0?e.jsxs("div",{style:{padding:"32px",textAlign:"center",color:"#64748b"},children:[e.jsx(Ke,{size:32,style:{marginBottom:"8px",opacity:.5}}),e.jsx("p",{style:{margin:0},children:"No notifications"})]}):M.map(S=>e.jsx("div",{onClick:()=>b(S),style:{padding:"12px 16px",borderBottom:"1px solid #f1f5f9",cursor:"pointer",backgroundColor:S.is_read?"white":"#f8fafc",transition:"background-color 0.15s"},onMouseEnter:E=>E.currentTarget.style.backgroundColor="#f1f5f9",onMouseLeave:E=>E.currentTarget.style.backgroundColor=S.is_read?"white":"#f8fafc",children:e.jsxs("div",{style:{display:"flex",gap:"12px"},children:[e.jsx("div",{style:{width:"36px",height:"36px",borderRadius:"8px",backgroundColor:S.notification_type==="action"&&!S.is_actioned?"#fef3c7":"#f1f5f9",display:"flex",alignItems:"center",justifyContent:"center",color:g(S),flexShrink:0},children:y(S.category)}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",gap:"8px"},children:[e.jsx("span",{style:{fontWeight:S.is_read?"400":"600",fontSize:"14px",color:"#1e293b"},children:S.title}),e.jsx("span",{style:{fontSize:"12px",color:"#94a3b8",flexShrink:0},children:R(S.created_at)})]}),e.jsx("p",{style:{margin:"4px 0 0",fontSize:"13px",color:"#64748b",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:S.message}),e.jsxs("div",{style:{marginTop:"8px",display:"flex",gap:"8px"},children:[S.notification_type==="action"&&!S.is_actioned&&S.action_label&&e.jsx("button",{onClick:E=>m(E,S),style:{padding:"4px 12px",fontSize:"12px",fontWeight:"500",backgroundColor:"#3b82f6",color:"white",border:"none",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",gap:"4px"},children:S.action_label}),S.notification_type==="info"&&e.jsxs("button",{onClick:E=>w(E,S),style:{padding:"4px 8px",fontSize:"12px",backgroundColor:"transparent",color:"#64748b",border:"1px solid #e2e8f0",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",gap:"4px"},children:[e.jsx(pe,{size:12}),"Dismiss"]}),S.is_actioned&&e.jsxs("span",{style:{padding:"4px 8px",fontSize:"12px",color:"#10b981",display:"flex",alignItems:"center",gap:"4px"},children:[e.jsx(Te,{size:12}),"Completed"]})]})]})]})},S.id))}),a.length>10&&e.jsx("div",{style:{padding:"12px 16px",borderTop:"1px solid #e2e8f0",textAlign:"center"},children:e.jsx("button",{onClick:()=>{s("/workflow-summary"),r(!1)},style:{background:"none",border:"none",color:"#3b82f6",fontSize:"13px",fontWeight:"500",cursor:"pointer"},children:"View all notifications"})})]}),e.jsx("style",{children:`
        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.5; }
        }
      `})]})}const x={ADMIN:"admin",SUPPLIER_PM:"supplier_pm",CUSTOMER_PM:"customer_pm",CONTRIBUTOR:"contributor",VIEWER:"viewer"},wa=[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.CONTRIBUTOR,x.VIEWER],ge=wa,te=[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM],B=[x.ADMIN,x.SUPPLIER_PM],Ee=[x.ADMIN,x.CUSTOMER_PM],be=[x.ADMIN,x.SUPPLIER_PM,x.CONTRIBUTOR],Je=[x.ADMIN],Jt={timesheets:{view:ge,create:be,createForOthers:B,edit:be,delete:B,submit:be,approve:Ee},expenses:{view:ge,create:be,createForOthers:B,edit:be,delete:B,submit:be,validateChargeable:Ee,validateNonChargeable:B},milestones:{view:ge,create:B,edit:B,delete:Je,useGantt:B,editBilling:B},deliverables:{view:ge,create:[...te,x.CONTRIBUTOR],edit:[...te,x.CONTRIBUTOR],delete:B,submit:be,review:Ee,markDelivered:Ee},kpis:{view:ge,create:B,edit:B,delete:B,manage:B},qualityStandards:{view:ge,create:B,edit:B,delete:B,manage:B},raid:{view:ge,create:te,edit:te,delete:B,manage:te,updateStatus:te,assignOwner:te},resources:{view:ge,create:B,edit:B,delete:Je,manage:B,seeCostPrice:B,seeResourceType:B,seeMargins:B},partners:{view:B,create:B,edit:B,delete:B,manage:B},certificates:{view:te,create:te,signAsSupplier:B,signAsCustomer:Ee},invoices:{view:te,generateCustomer:te,generateThirdParty:B,viewMargins:B},settings:{access:B,edit:B},users:{view:B,manage:Je},reports:{access:te,viewWorkflowSummary:te}};function P(n,r,t){const s=Jt[r];if(!s)return!1;const a=s[t];return a?a.includes(n):!1}const it={[x.ADMIN]:{label:"Admin",color:"#7c3aed",bg:"#f3e8ff"},[x.SUPPLIER_PM]:{label:"Supplier PM",color:"#059669",bg:"#d1fae5"},[x.CUSTOMER_PM]:{label:"Customer PM",color:"#d97706",bg:"#fef3c7"},[x.CONTRIBUTOR]:{label:"Contributor",color:"#2563eb",bg:"#dbeafe"},[x.VIEWER]:{label:"Viewer",color:"#64748b",bg:"#f1f5f9"}},_a=Object.entries(it).map(([n,r])=>({value:n,...r}));function ot(n,r){return r.includes(n)}function va(n){return ot(n,[x.ADMIN,x.SUPPLIER_PM])}function Zt(n){return P(n,"timesheets","create")}function ut(n){return P(n,"timesheets","createForOthers")}function Me(n){return P(n,"timesheets","approve")}function Sa(n,r,t,s){if(P(n,"timesheets","createForOthers"))return!0;let a,i,o;return typeof r=="object"&&r!==null?(a=r.status,i=r.created_by||r.resource?.user_id,o=t):(a=r,i=t,o=s),i===o&&(a==="Draft"||a==="Rejected")}function ja(n,r,t,s){if(P(n,"timesheets","delete"))return!0;let a,i,o;return typeof r=="object"&&r!==null?(a=r.status,i=r.created_by||r.resource?.user_id,o=t):(a=r,i=t,o=s),i===o&&a==="Draft"}function Ca(n,r,t,s){let a,i,o;return typeof r=="object"&&r!==null?(a=r.status,i=r.created_by||r.resource?.user_id,o=t):(a=r,i=t,o=s),a!=="Draft"&&a!=="Rejected"?!1:P(n,"timesheets","createForOthers")?!0:i===o&&P(n,"timesheets","submit")}function lt(n){return P(n,"expenses","create")}function er(n){return P(n,"expenses","createForOthers")}function tr(n){return P(n,"expenses","validateChargeable")}function rr(n){return P(n,"expenses","validateNonChargeable")}function Na(n,r,t){let s,a;return typeof r=="object"&&r!==null?(s=r.status,a=r.chargeable||r.chargeable_to_customer):(s=r,a=t),s!=="Submitted"?!1:a?P(n,"expenses","validateChargeable"):P(n,"expenses","validateNonChargeable")}function Ea(n,r,t,s){if(P(n,"expenses","createForOthers"))return!0;let a,i,o;return typeof r=="object"&&r!==null?(a=r.status,i=r.created_by,o=t):(a=r,i=t,o=s),i===o&&(a==="Draft"||a==="Rejected")}function ka(n,r,t,s){if(P(n,"expenses","delete"))return!0;let a,i,o;return typeof r=="object"&&r!==null?(a=r.status,i=r.created_by,o=t):(a=r,i=t,o=s),i===o&&a==="Draft"}function sr(n){return P(n,"milestones","create")}function ar(n){return P(n,"milestones","edit")}function nr(n){return P(n,"milestones","delete")}function ir(n){return P(n,"milestones","useGantt")}function Ra(n){return P(n,"milestones","editBilling")}function or(n){return P(n,"deliverables","create")}function lr(n){return P(n,"deliverables","edit")}function cr(n){return P(n,"deliverables","delete")}function dr(n){return P(n,"deliverables","review")}function Pa(n){return P(n,"deliverables","submit")}function Aa(n,r,t){return P(n,"deliverables","edit")?!0:n===x.CONTRIBUTOR?r?.assigned_to===t||r?.resource?.user_id===t:!1}function ur(n){return P(n,"kpis","manage")}function Ia(n){return P(n,"kpis","create")}function Da(n){return P(n,"kpis","edit")}function Ma(n){return P(n,"kpis","delete")}function hr(n){return P(n,"qualityStandards","manage")}function Ta(n){return P(n,"qualityStandards","create")}function Oa(n){return P(n,"qualityStandards","edit")}function qa(n){return P(n,"qualityStandards","delete")}function mr(n){return P(n,"resources","manage")}function La(n){return P(n,"resources","create")}function Ba(n){return P(n,"resources","edit")}function fr(n){return P(n,"resources","delete")}function gr(n){return P(n,"resources","seeCostPrice")}function za(n){return P(n,"resources","seeResourceType")}function pr(n){return P(n,"resources","seeMargins")}function yr(n){return P(n,"partners","view")}function xr(n){return P(n,"partners","manage")}function $a(n){return P(n,"partners","create")}function Ua(n){return P(n,"partners","edit")}function Va(n){return P(n,"partners","delete")}function br(n){return P(n,"certificates","signAsSupplier")}function wr(n){return P(n,"certificates","signAsCustomer")}function Wa(n){return P(n,"certificates","create")}function _r(n){return P(n,"settings","access")}function Fa(n){return P(n,"settings","edit")}function vr(n){return P(n,"users","manage")}function Ha(n){return P(n,"users","view")}function Sr(n){return P(n,"reports","viewWorkflowSummary")}function jr(n){return P(n,"invoices","generateCustomer")}function Cr(n){return P(n,"invoices","generateThirdParty")}function Ka(n){return P(n,"invoices","viewMargins")}function Ga(n){return P(n,"reports","access")}function Nr(n,r,t){return!r||!Array.isArray(r)?[]:ut(n)?r:r.filter(s=>s.user_id===t)}function Qa(n,r){return!n||!Array.isArray(n)?null:n.find(t=>t.user_id===r)||null}function Er(n,r,t){const s=Nr(n,r,t);return s.length===0?null:s.find(i=>i.user_id===t)||s[0]}function Ya(n,r,t){return Er(n,r,t)?.id||null}function kr(n){return it[n]||it[x.VIEWER]}function Rr(n){return kr(n).label}function Xa(n){return{role:n,roleLabel:Rr(n),timesheets:{canAdd:Zt(n),canAddForOthers:ut(n),canApprove:Me(n)},expenses:{canAdd:lt(n),canAddForOthers:er(n),canValidateChargeable:tr(n),canValidateNonChargeable:rr(n)},milestones:{canCreate:sr(n),canEdit:ar(n),canDelete:nr(n),canUseGantt:ir(n)},deliverables:{canCreate:or(n),canEdit:lr(n),canDelete:cr(n),canReview:dr(n)},kpis:{canManage:ur(n)},qualityStandards:{canManage:hr(n)},resources:{canManage:mr(n),canDelete:fr(n),canSeeCostPrice:gr(n),canSeeMargins:pr(n)},partners:{canView:yr(n),canManage:xr(n)},certificates:{canSignAsSupplier:br(n),canSignAsCustomer:wr(n)},admin:{canAccessSettings:_r(n),canManageUsers:vr(n),canViewWorkflowSummary:Sr(n)},invoicing:{canGenerateCustomerInvoice:jr(n),canGenerateThirdPartyInvoice:Cr(n)}}}const Ue={workflowSummary:{id:"workflowSummary",path:"/workflow-summary",icon:cs,label:"Workflow Summary",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.CONTRIBUTOR],readOnlyRoles:[]},dashboard:{id:"dashboard",path:"/dashboard",icon:ls,label:"Dashboard",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.VIEWER],readOnlyRoles:[x.VIEWER]},reports:{id:"reports",path:"/reports",icon:ze,label:"Reports",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM],readOnlyRoles:[]},gantt:{id:"gantt",path:"/gantt",icon:os,label:"Gantt Chart",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.VIEWER],readOnlyRoles:[x.VIEWER,x.CUSTOMER_PM]},milestones:{id:"milestones",path:"/milestones",icon:rt,label:"Milestones",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.VIEWER],readOnlyRoles:[x.VIEWER]},deliverables:{id:"deliverables",path:"/deliverables",icon:tt,label:"Deliverables",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.CONTRIBUTOR,x.VIEWER],readOnlyRoles:[x.VIEWER]},kpis:{id:"kpis",path:"/kpis",icon:qe,label:"KPIs",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.VIEWER],readOnlyRoles:[x.VIEWER,x.CUSTOMER_PM]},qualityStandards:{id:"qualityStandards",path:"/quality-standards",icon:Pe,label:"Quality Standards",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.VIEWER],readOnlyRoles:[x.VIEWER,x.CUSTOMER_PM]},raid:{id:"raid",path:"/raid",icon:is,label:"RAID Log",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.VIEWER],readOnlyRoles:[x.VIEWER]},resources:{id:"resources",path:"/resources",icon:ns,label:"Resources",allowedRoles:[x.ADMIN,x.SUPPLIER_PM],readOnlyRoles:[]},timesheets:{id:"timesheets",path:"/timesheets",icon:le,label:"Timesheets",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.CONTRIBUTOR],readOnlyRoles:[]},expenses:{id:"expenses",path:"/expenses",icon:Oe,label:"Expenses",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.CONTRIBUTOR],readOnlyRoles:[]},billing:{id:"billing",path:"/billing",icon:Ae,label:"Billing",allowedRoles:[x.ADMIN,x.SUPPLIER_PM],readOnlyRoles:[]},partners:{id:"partners",path:"/partners",icon:Dt,label:"Partners",allowedRoles:[x.ADMIN,x.SUPPLIER_PM],readOnlyRoles:[]},users:{id:"users",path:"/users",icon:as,label:"Users",allowedRoles:[x.ADMIN,x.SUPPLIER_PM],readOnlyRoles:[x.SUPPLIER_PM]},settings:{id:"settings",path:"/settings",icon:ss,label:"Settings",allowedRoles:[x.ADMIN,x.SUPPLIER_PM],readOnlyRoles:[]},auditLog:{id:"auditLog",path:"/audit-log",icon:rs,label:"Audit Log",allowedRoles:[x.ADMIN,x.SUPPLIER_PM],readOnlyRoles:[]},deletedItems:{id:"deletedItems",path:"/deleted-items",icon:ts,label:"Deleted Items",allowedRoles:[x.ADMIN,x.SUPPLIER_PM],readOnlyRoles:[]}},Le={[x.ADMIN]:["workflowSummary","dashboard","reports","gantt","milestones","deliverables","kpis","qualityStandards","raid","resources","timesheets","expenses","billing","partners","users","settings","auditLog","deletedItems"],[x.SUPPLIER_PM]:["workflowSummary","dashboard","reports","gantt","milestones","deliverables","kpis","qualityStandards","raid","resources","timesheets","expenses","billing","partners","users","settings","auditLog","deletedItems"],[x.CUSTOMER_PM]:["workflowSummary","dashboard","reports","gantt","milestones","deliverables","kpis","qualityStandards","raid","timesheets","expenses"],[x.CONTRIBUTOR]:["workflowSummary","timesheets","expenses","deliverables"],[x.VIEWER]:["dashboard","gantt","milestones","deliverables","kpis","qualityStandards","raid"]};function Ja(n){return(Le[n]||Le[x.VIEWER]).map(t=>Ue[t]?.path).filter(Boolean)}function Pr(n){return(Le[n]||Le[x.VIEWER]).map(t=>Ue[t]).filter(t=>t&&t.allowedRoles.includes(n))}function Nt(n,r){const t=Ue[r];return t?t.readOnlyRoles?.includes(n)||!1:!0}function Za(n){return n!==x.VIEWER}function en(n){return Object.values(Ue).find(r=>r.path===n)||null}function tn(n){return en(n)?.id||null}function rn(n,r){const t=Pr(n);if(!r||!Array.isArray(r)||r.length===0)return t;const s={};t.forEach(i=>{s[i.path]=i});const a=[];return r.forEach(i=>{s[i]&&(a.push(s[i]),delete s[i])}),Object.values(s).forEach(i=>{a.push(i)}),a}function sn(n,r){if(!r||r.length===0)return!0;const t=Ja(n);return r.length!==t.length?!1:r.every((s,a)=>s===t[a])}const Et={[x.ADMIN]:{label:"Administrator",shortLabel:"Admin",color:"#7c3aed",bg:"#f3e8ff",description:"Full system access"},[x.SUPPLIER_PM]:{label:"Supplier PM",shortLabel:"Supplier PM",color:"#059669",bg:"#d1fae5",description:"Manage resources, partners, and invoices"},[x.CUSTOMER_PM]:{label:"Customer PM",shortLabel:"Customer PM",color:"#d97706",bg:"#fef3c7",description:"Approve timesheets and validate expenses"},[x.CONTRIBUTOR]:{label:"Contributor",shortLabel:"Contributor",color:"#2563eb",bg:"#dbeafe",description:"Submit timesheets and expenses"},[x.VIEWER]:{label:"Viewer",shortLabel:"Viewer",color:"#64748b",bg:"#f1f5f9",description:"Read-only access to reports"}};function an(n){return Et[n]||Et[x.VIEWER]}function nn({children:n}){const r=Br(),t=ce(),{showSuccess:s,showError:a}=Qt(),{user:i,profile:o,role:c,signOut:l}=Ie(),[u,f]=d.useState(!0),[h,y]=d.useState(null),[g,b]=d.useState(null),[m,w]=d.useState(null),R=d.useRef(null),M=d.useMemo(()=>an(c),[c]),A=d.useMemo(()=>o&&(o.full_name||o.email||i?.email)||"User",[o,i]),S=d.useMemo(()=>{if(!o)return"U";if(o.full_name){const T=o.full_name.split(" ");return T.length>=2?T[0][0]+T[T.length-1][0]:o.full_name[0].toUpperCase()}return A[0].toUpperCase()},[o,A]);d.useEffect(()=>{o?.nav_order&&Array.isArray(o.nav_order)&&y(o.nav_order)},[o]);async function E(){await l(),t("/login")}const v=d.useMemo(()=>Za(c),[c]),k=d.useMemo(()=>h&&!sn(c,h),[c,h]),N=d.useMemo(()=>{const T=Pr(c);return h&&h.length>0?rn(c,h):T},[c,h]),j=d.useMemo(()=>{const T=tn(r.pathname);return T?Nt(c,T):!1},[c,r.pathname]);function D(T,H){v&&(R.current=T.target,b(H),setTimeout(()=>{R.current&&(R.current.style.opacity="0.5")},0))}function C(T,H){v&&H!==g&&w(H)}function _(T){v&&T.preventDefault()}function L(){if(v){if(R.current&&(R.current.style.opacity="1"),g!==null&&m!==null&&g!==m){const T=[...N],H=T[g];T.splice(g,1),T.splice(m,0,H);const he=T.map(de=>de.path);y(he),se(he)}b(null),w(null),R.current=null}}async function se(T){if(i)try{const{error:H}=await p.from("profiles").update({nav_order:T}).eq("id",i.id);H&&a("Failed to save menu order")}catch{a("Failed to save menu order")}}async function oe(){if(i)try{const{error:T}=await p.from("profiles").update({nav_order:null}).eq("id",i.id);if(T){a("Failed to reset menu order");return}y(null),s("Menu order reset to default")}catch{a("Failed to reset menu order")}}return e.jsxs("div",{style:{display:"flex",minHeight:"100vh",backgroundColor:"#f8fafc"},children:[e.jsxs("aside",{style:{width:u?"260px":"70px",backgroundColor:"white",borderRight:"1px solid #e2e8f0",transition:"width 0.3s ease",display:"flex",flexDirection:"column",position:"fixed",height:"100vh",zIndex:50},children:[e.jsxs("div",{style:{padding:"1rem",borderBottom:"1px solid #e2e8f0",display:"flex",alignItems:"center",justifyContent:"space-between"},children:[u&&e.jsxs("div",{children:[e.jsx("h2",{style:{margin:0,fontSize:"1.125rem",fontWeight:"700",color:"#0f172a"},children:"AMSF001"}),e.jsx("span",{style:{fontSize:"0.75rem",color:"#64748b"},children:"Project Tracker"})]}),e.jsx("button",{onClick:()=>f(!u),style:{padding:"0.5rem",borderRadius:"6px",border:"none",backgroundColor:"#f1f5f9",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"},children:u?e.jsx(pe,{size:20}):e.jsx(ds,{size:20})})]}),e.jsx("nav",{style:{flex:1,padding:"0.5rem",overflowY:"auto"},children:N.map((T,H)=>{const he=T.icon,de=r.pathname===T.path||T.path!=="/dashboard"&&r.pathname.startsWith(T.path),_e=g===H,ye=m===H,me=Nt(c,T.id);return e.jsx("div",{draggable:v,onDragStart:I=>D(I,H),onDragEnter:I=>C(I,H),onDragOver:_,onDragEnd:L,style:{position:"relative",marginBottom:"0.25rem",borderTop:ye&&g>H?"2px solid #10b981":"2px solid transparent",borderBottom:ye&&g<H?"2px solid #10b981":"2px solid transparent",transition:"border-color 0.15s ease"},children:e.jsxs(Ze,{to:T.path,style:{display:"flex",alignItems:"center",gap:"0.75rem",padding:u?"0.75rem 1rem":"0.75rem",borderRadius:"8px",textDecoration:"none",color:de?"#10b981":"#64748b",backgroundColor:de?"#f0fdf4":_e?"#f1f5f9":"transparent",fontWeight:de?"600":"500",justifyContent:u?"flex-start":"center",transition:"all 0.15s ease",cursor:v?"grab":"pointer"},children:[u&&v&&e.jsx(us,{size:14,style:{color:"#cbd5e1",marginRight:"-0.25rem",flexShrink:0}}),e.jsx(he,{size:20}),u&&e.jsx("span",{style:{flex:1},children:T.label}),u&&me&&e.jsx("span",{style:{fontSize:"0.6rem",padding:"0.125rem 0.375rem",backgroundColor:"#f1f5f9",color:"#64748b",borderRadius:"4px",fontWeight:"500"},children:"VIEW"})]})},T.path)})}),u&&v&&k&&e.jsx("div",{style:{padding:"0.5rem 1rem",borderTop:"1px solid #e2e8f0"},children:e.jsxs("button",{onClick:oe,style:{width:"100%",display:"flex",alignItems:"center",justifyContent:"center",gap:"0.5rem",padding:"0.5rem",backgroundColor:"#f8fafc",color:"#64748b",border:"1px solid #e2e8f0",borderRadius:"6px",cursor:"pointer",fontSize:"0.75rem",fontWeight:"500",transition:"all 0.15s ease"},onMouseEnter:T=>{T.currentTarget.style.backgroundColor="#f1f5f9",T.currentTarget.style.color="#475569"},onMouseLeave:T=>{T.currentTarget.style.backgroundColor="#f8fafc",T.currentTarget.style.color="#64748b"},children:[e.jsx(Mt,{size:14}),"Reset Menu Order"]})}),e.jsx("div",{style:{padding:"1rem",borderTop:"1px solid #e2e8f0",backgroundColor:"#f8fafc"},children:e.jsxs("button",{onClick:E,style:{width:"100%",display:"flex",alignItems:"center",justifyContent:u?"flex-start":"center",gap:"0.75rem",padding:"0.75rem",backgroundColor:"#fef2f2",color:"#ef4444",border:"none",borderRadius:"8px",cursor:"pointer",fontWeight:"500"},children:[e.jsx(hs,{size:20}),u&&e.jsx("span",{children:"Logout"})]})})]}),e.jsxs("main",{style:{flex:1,marginLeft:u?"260px":"70px",transition:"margin-left 0.3s ease",minHeight:"100vh",display:"flex",flexDirection:"column"},children:[e.jsxs("header",{style:{padding:"0.75rem 1.5rem",backgroundColor:"white",borderBottom:"1px solid #e2e8f0",display:"flex",justifyContent:"flex-end",alignItems:"center",gap:"1rem",position:"sticky",top:0,zIndex:40},children:[e.jsxs(Ze,{to:"/account",style:{display:"flex",alignItems:"center",gap:"0.75rem",paddingRight:"1rem",borderRight:"1px solid #e2e8f0",textDecoration:"none",cursor:"pointer",borderRadius:"8px",padding:"0.5rem 1rem 0.5rem 0.75rem",marginRight:"0",transition:"background-color 0.15s ease"},onMouseEnter:T=>T.currentTarget.style.backgroundColor="#f8fafc",onMouseLeave:T=>T.currentTarget.style.backgroundColor="transparent",children:[e.jsxs("div",{style:{textAlign:"right"},children:[e.jsx("div",{style:{fontWeight:"600",fontSize:"0.875rem",color:"#1e293b"},children:A}),e.jsx("span",{style:{display:"inline-block",padding:"0.125rem 0.5rem",backgroundColor:M.bg,color:M.color,borderRadius:"4px",fontSize:"0.65rem",fontWeight:"600",textTransform:"uppercase",letterSpacing:"0.025em"},children:M.shortLabel})]}),e.jsx("div",{style:{width:"36px",height:"36px",borderRadius:"50%",backgroundColor:M.color,display:"flex",alignItems:"center",justifyContent:"center",color:"white",fontWeight:"600",fontSize:"0.8rem"},children:S})]}),e.jsx(ba,{})]}),j&&e.jsxs("div",{style:{padding:"0.5rem 1.5rem",backgroundColor:"#f1f5f9",borderBottom:"1px solid #e2e8f0",display:"flex",alignItems:"center",gap:"0.5rem",fontSize:"0.875rem",color:"#64748b"},children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",y1:"16",x2:"12",y2:"12"}),e.jsx("line",{x1:"12",y1:"8",x2:"12.01",y2:"8"})]}),e.jsx("span",{children:"You have read-only access to this page"})]}),e.jsx("div",{style:{flex:1},children:n})]})]})}function on(){const n=ce(),[r]=zr(),[t,s]=d.useState(!1),[a,i]=d.useState(""),[o,c]=d.useState(""),[l,u]=d.useState(null),[f,h]=d.useState(null),[y,g]=d.useState(!1),[b,m]=d.useState(!1),[w,R]=d.useState(!1),[M,A]=d.useState(!1);d.useEffect(()=>{r.get("expired")==="true"&&(A(!0),window.history.replaceState({},document.title,"/login")),p.auth.getSession().then(({data:{session:j}})=>{j&&n("/dashboard",{replace:!0})});const{data:{subscription:N}}=p.auth.onAuthStateChange((j,D)=>{j==="SIGNED_IN"&&D&&n("/dashboard",{replace:!0})});return()=>N.unsubscribe()},[n,r]);const S=async N=>{N.preventDefault(),s(!0),u(null),h(null),A(!1);try{if(y){const{error:j}=await p.auth.signUp({email:a,password:o,options:{data:{full_name:a.split("@")[0]}}});if(j)throw j;h("Check your email for confirmation link!")}else{const{error:j}=await p.auth.signInWithPassword({email:a,password:o});if(j)throw j}}catch(j){u(j.message)}finally{s(!1)}},E=async N=>{if(N.preventDefault(),!a){u("Please enter your email address");return}s(!0),u(null),h(null);try{const{error:j}=await p.auth.resetPasswordForEmail(a,{redirectTo:`${window.location.origin}/reset-password`});if(j)throw j;h("Password reset email sent! Check your inbox.")}catch(j){u(j.message)}finally{s(!1)}},v=async N=>{if(N.preventDefault(),!a){u("Please enter your email address");return}s(!0),u(null),h(null);try{const{error:j}=await p.auth.resend({type:"signup",email:a});if(j)throw j;h("Verification email resent! Check your inbox.")}catch(j){u(j.message)}finally{s(!1)}},k=()=>{m(!1),R(!1),u(null),h(null),A(!1)};return b?e.jsx("div",{className:"auth-container",children:e.jsxs("div",{className:"auth-box",children:[e.jsxs("div",{className:"auth-logo",children:[e.jsx(ms,{size:40,style:{color:"var(--primary)",marginBottom:"0.5rem"}}),e.jsx("h1",{className:"auth-title",children:"Reset Password"}),e.jsx("p",{className:"auth-subtitle",children:"Enter your email to receive a reset link"})]}),e.jsxs("form",{onSubmit:E,children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",htmlFor:"email",children:"Email Address"}),e.jsx("input",{id:"email",className:"form-input",type:"email",placeholder:"you@example.com",value:a,onChange:N=>i(N.target.value),required:!0})]}),l&&e.jsxs("div",{style:{padding:"0.75rem",background:"#fee2e2",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#991b1b"},children:[e.jsx(Ge,{size:20}),e.jsx("span",{style:{fontSize:"0.875rem"},children:l})]}),f&&e.jsxs("div",{style:{padding:"0.75rem",background:"#dcfce7",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#166534"},children:[e.jsx(Qe,{size:20}),e.jsx("span",{style:{fontSize:"0.875rem"},children:f})]}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:t,style:{width:"100%",justifyContent:"center"},children:t?"Sending...":"Send Reset Link"})]}),e.jsx("div",{style:{marginTop:"1.5rem",textAlign:"center"},children:e.jsx("button",{onClick:k,style:{background:"none",border:"none",color:"var(--primary)",cursor:"pointer",fontSize:"0.875rem"},children:"â† Back to Sign In"})})]})}):w?e.jsx("div",{className:"auth-container",children:e.jsxs("div",{className:"auth-box",children:[e.jsxs("div",{className:"auth-logo",children:[e.jsx(Se,{size:40,style:{color:"var(--primary)",marginBottom:"0.5rem"}}),e.jsx("h1",{className:"auth-title",children:"Resend Verification"}),e.jsx("p",{className:"auth-subtitle",children:"Enter your email to resend the verification link"})]}),e.jsxs("form",{onSubmit:v,children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",htmlFor:"email",children:"Email Address"}),e.jsx("input",{id:"email",className:"form-input",type:"email",placeholder:"you@example.com",value:a,onChange:N=>i(N.target.value),required:!0})]}),l&&e.jsxs("div",{style:{padding:"0.75rem",background:"#fee2e2",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#991b1b"},children:[e.jsx(Ge,{size:20}),e.jsx("span",{style:{fontSize:"0.875rem"},children:l})]}),f&&e.jsxs("div",{style:{padding:"0.75rem",background:"#dcfce7",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#166534"},children:[e.jsx(Qe,{size:20}),e.jsx("span",{style:{fontSize:"0.875rem"},children:f})]}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:t,style:{width:"100%",justifyContent:"center"},children:t?"Sending...":"Resend Verification Email"})]}),e.jsx("div",{style:{marginTop:"1.5rem",textAlign:"center"},children:e.jsx("button",{onClick:k,style:{background:"none",border:"none",color:"var(--primary)",cursor:"pointer",fontSize:"0.875rem"},children:"â† Back to Sign In"})})]})}):e.jsx("div",{className:"auth-container",children:e.jsxs("div",{className:"auth-box",children:[e.jsxs("div",{className:"auth-logo",children:[e.jsx("h1",{className:"auth-title",children:"AMSF001 Tracker"}),e.jsx("p",{className:"auth-subtitle",children:"Network Architecture Services Project"})]}),M&&e.jsxs("div",{style:{padding:"0.75rem",background:"#fef3c7",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#92400e",border:"1px solid #fcd34d"},children:[e.jsx(le,{size:20}),e.jsx("span",{style:{fontSize:"0.875rem"},children:"Your session has expired. Please sign in again."})]}),e.jsxs("form",{onSubmit:S,children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",htmlFor:"email",children:"Email Address"}),e.jsx("input",{id:"email",className:"form-input",type:"email",placeholder:"you@example.com",value:a,onChange:N=>i(N.target.value),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",htmlFor:"password",children:"Password"}),e.jsx("input",{id:"password",className:"form-input",type:"password",placeholder:"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢",value:o,onChange:N=>c(N.target.value),required:!0})]}),l&&e.jsxs("div",{style:{padding:"0.75rem",background:"#fee2e2",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#991b1b"},children:[e.jsx(Ge,{size:20}),e.jsx("span",{style:{fontSize:"0.875rem"},children:l})]}),f&&e.jsxs("div",{style:{padding:"0.75rem",background:"#dcfce7",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#166534"},children:[e.jsx(Qe,{size:20}),e.jsx("span",{style:{fontSize:"0.875rem"},children:f})]}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:t,style:{width:"100%",justifyContent:"center"},children:t?"Loading...":y?"Sign Up":"Sign In"})]}),!y&&e.jsx("div",{style:{marginTop:"1rem",textAlign:"center"},children:e.jsx("button",{onClick:()=>{m(!0),u(null),h(null),A(!1)},style:{background:"none",border:"none",color:"#64748b",cursor:"pointer",fontSize:"0.85rem",textDecoration:"underline"},children:"Forgot your password?"})}),e.jsx("div",{style:{marginTop:"1rem",textAlign:"center"},children:e.jsx("button",{onClick:()=>{g(!y),u(null),h(null),A(!1)},style:{background:"none",border:"none",color:"var(--primary)",cursor:"pointer",fontSize:"0.875rem"},children:y?"Already have an account? Sign In":"Don't have an account? Sign Up"})}),e.jsxs("div",{style:{marginTop:"1.5rem",paddingTop:"1rem",borderTop:"1px solid #e2e8f0",textAlign:"center"},children:[e.jsx("p",{style:{fontSize:"0.8rem",color:"#64748b",marginBottom:"0.5rem"},children:"Haven't received your verification email?"}),e.jsxs("button",{onClick:()=>{R(!0),u(null),h(null),A(!1)},style:{background:"none",border:"none",color:"var(--primary)",cursor:"pointer",fontSize:"0.85rem",display:"inline-flex",alignItems:"center",gap:"0.25rem"},children:[e.jsx(Se,{size:14})," Resend Verification Email"]})]})]})})}const ln={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function cn(n){return n==null?"":typeof n!="string"?String(n):n.replace(/[&<>"'`=\/]/g,r=>ln[r])}function ht(n,r={}){const{maxLength:t=1e4,trim:s=!0,normalizeWhitespace:a=!0}=r;if(n==null)return"";typeof n!="string"&&(n=String(n));let i=n;return i=i.replace(/\0/g,""),i=i.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,""),s&&(i=i.trim()),a&&(i=i.replace(/[ \t]+/g," ")),i.length>t&&(i=i.substring(0,t)),i}function Be(n,r=255){return n==null?"":(typeof n!="string"&&(n=String(n)),ht(n,{maxLength:r}).replace(/[\r\n]/g," ").replace(/\s+/g," ").trim())}function Ar(n,r=1e4){return n==null?"":(typeof n!="string"&&(n=String(n)),ht(n,{maxLength:r,normalizeWhitespace:!1}).replace(/\r\n/g,`
`).replace(/\r/g,`
`).replace(/\n{3,}/g,`

`).trim())}function Ir(n){return n?Be(n,254).toLowerCase():""}function Ve(n,r={}){const{min:t=-1/0,max:s=1/0,decimals:a=2}=r;if(n==null||n==="")return null;let i=String(n).replace(/[^0-9.\-]/g,""),o=parseFloat(i);return isNaN(o)?null:(o=Math.max(t,Math.min(s,o)),o=Math.round(o*Math.pow(10,a))/Math.pow(10,a),o)}function dn(n){const r=Ve(n,{min:0,decimals:2});return r!==null?Math.round(r*100)/100:null}function un(n){const r=Ve(n,{min:0,max:24,decimals:1});return r===null?null:Math.round(r*2)/2}function hn(n){return Ve(n,{min:0,max:100,decimals:1})}function mn(n){if(!n)return null;const r=String(n).trim();return/^(javascript|data|vbscript):/i.test(r)?null:/^(https?:\/\/|\/|#)/i.test(r)?r:`https://${r}`}function fn(n,r={}){if(!n||typeof n!="object")return n;const t={...n};for(const[s,a]of Object.entries(r)){if(t[s]===void 0)continue;const{type:i="text",maxLength:o}=a;switch(i){case"singleLine":t[s]=Be(t[s],o);break;case"multiLine":t[s]=Ar(t[s],o);break;case"email":t[s]=Ir(t[s]);break;case"number":t[s]=Ve(t[s],a);break;case"currency":t[s]=dn(t[s]);break;case"hours":t[s]=un(t[s]);break;case"percentage":t[s]=hn(t[s]);break;case"url":t[s]=mn(t[s]);break;case"html":t[s]=cn(t[s]);break;default:t[s]=ht(t[s],{maxLength:o})}}return t}const gn={timesheet:{description:{type:"multiLine",maxLength:2e3},hours_worked:{type:"hours"}},expense:{reason:{type:"multiLine",maxLength:2e3},amount:{type:"currency"}},resource:{name:{type:"singleLine",maxLength:100},email:{type:"email"},role:{type:"singleLine",maxLength:100},notes:{type:"multiLine",maxLength:5e3}},partner:{name:{type:"singleLine",maxLength:200},contact_name:{type:"singleLine",maxLength:100},contact_email:{type:"email"},notes:{type:"multiLine",maxLength:5e3}},milestone:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3}},deliverable:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3}},kpi:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3},target_value:{type:"number",decimals:2},actual_value:{type:"number",decimals:2}},qualityStandard:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3},target_value:{type:"percentage"}}};function kt(n,r){const t=gn[n];return t?fn(r,t):r}class ie{constructor(r,t={}){this.tableName=r,this.supportsSoftDelete=t.supportsSoftDelete!==!1,this.sanitizeConfig=t.sanitizeConfig||null}getSoftDeleteFilter(){return this.supportsSoftDelete?"is_deleted.is.null,is_deleted.eq.false":null}async getAll(r,t={}){try{let s=t.select||"*";const a=this.supportsSoftDelete&&!t.includeDeleted;a&&s!=="*"&&!s.includes("is_deleted")&&(s=`${s}, is_deleted`);let i=p.from(this.tableName).select(s).eq("project_id",r);t.filters&&Array.isArray(t.filters)&&t.filters.forEach(u=>{const{column:f,operator:h,value:y}=u;switch(h){case"eq":i=i.eq(f,y);break;case"neq":i=i.neq(f,y);break;case"gt":i=i.gt(f,y);break;case"gte":i=i.gte(f,y);break;case"lt":i=i.lt(f,y);break;case"lte":i=i.lte(f,y);break;case"like":i=i.like(f,y);break;case"ilike":i=i.ilike(f,y);break;case"in":i=i.in(f,y);break;case"is":i=i.is(f,y);break;default:i=i.eq(f,y)}}),t.orderBy&&(i=i.order(t.orderBy.column,{ascending:t.orderBy.ascending??!0}));const{data:o,error:c}=await i;if(c)throw c;let l=o||[];return a&&(l=l.filter(u=>u.is_deleted!==!0)),l}catch(s){throw s}}async getDeleted(r){if(!this.supportsSoftDelete)return[];try{const{data:t,error:s}=await p.from(this.tableName).select("*").eq("project_id",r).eq("is_deleted",!0).order("deleted_at",{ascending:!1});if(s)throw s;return t||[]}catch(t){throw t}}async getById(r,t={}){try{let s=t.select||"*";const a=this.supportsSoftDelete&&!t.includeDeleted;a&&s!=="*"&&!s.includes("is_deleted")&&(s=`${s}, is_deleted`);let i=p.from(this.tableName).select(s).eq("id",r);const{data:o,error:c}=await i.limit(1);if(c)throw c;const l=o&&o.length>0?o[0]:null;return l&&a&&l.is_deleted===!0?null:l}catch(s){throw s}}async create(r){try{if(!r.project_id)throw new Error("project_id is required");let t=r;this.sanitizeConfig&&(t=kt(this.sanitizeConfig,r)),this.supportsSoftDelete&&(delete t.is_deleted,delete t.deleted_at,delete t.deleted_by);const{data:s,error:a}=await p.from(this.tableName).insert(t).select();if(a)throw a;if(!s||s.length===0)throw new Error("Failed to create record - no data returned");return s[0]}catch(t){throw t}}async update(r,t){try{let s=t;this.sanitizeConfig&&(s=kt(this.sanitizeConfig,t));const a={...s,updated_at:new Date().toISOString()};delete a.is_deleted,delete a.deleted_at,delete a.deleted_by;const{data:i,error:o}=await p.from(this.tableName).update(a).eq("id",r).select();if(o)throw o;if(!i||i.length===0)throw new Error(`No record found with id: ${r}`);return i[0]}catch(s){throw s}}async delete(r,t=null){try{if(this.supportsSoftDelete){const{error:s}=await p.from(this.tableName).update({is_deleted:!0,deleted_at:new Date().toISOString(),deleted_by:t}).eq("id",r);if(s)throw s}else{const{error:s}=await p.from(this.tableName).delete().eq("id",r);if(s)throw s}return!0}catch(s){throw s}}async hardDelete(r){try{const{error:t}=await p.from(this.tableName).delete().eq("id",r);if(t)throw t;return!0}catch(t){throw t}}async restore(r){if(!this.supportsSoftDelete)throw new Error("This entity does not support soft delete");try{const{data:t,error:s}=await p.from(this.tableName).update({is_deleted:!1,deleted_at:null,deleted_by:null}).eq("id",r).select();if(s)throw s;if(!t||t.length===0)throw new Error(`No record found with id: ${r}`);return t[0]}catch(t){throw t}}async exists(r){try{const{data:t,error:s}=await p.from(this.tableName).select("id, is_deleted").eq("id",r).limit(1);if(s)throw s;if(!t||t.length===0)return!1;const a=t[0];return!(this.supportsSoftDelete&&a.is_deleted===!0)}catch(t){throw t}}async count(r,t=[]){try{let s=p.from(this.tableName).select("id, is_deleted").eq("project_id",r);t.forEach(c=>{const{column:l,operator:u,value:f}=c;u==="eq"?s=s.eq(l,f):u==="in"&&(s=s.in(l,f))});const{data:a,error:i}=await s;if(i)throw i;let o=a||[];return this.supportsSoftDelete&&(o=o.filter(c=>c.is_deleted!==!0)),o.length}catch(s){throw s}}}class pn extends ie{constructor(){super("partners")}async getAll(r){return super.getAll(r,{orderBy:{column:"name",ascending:!0}})}async getActive(r){return super.getAll(r,{filters:[{column:"is_active",operator:"eq",value:!0}],orderBy:{column:"name",ascending:!0}})}async getWithResources(r){try{const{data:t,error:s}=await p.from("partners").select(`
          *,
          resources (
            id,
            name,
            sell_price,
            cost_price,
            is_active
          )
        `).eq("id",r).limit(1);if(s)throw s;return t?.[0]||null}catch(t){throw t}}async getSummary(r){try{const{data:t,error:s}=await p.from("partners").select(`
          id,
          name,
          contact_name,
          contact_email,
          payment_terms,
          is_active,
          created_at
        `).eq("project_id",r).order("name",{ascending:!0});if(s)throw s;return t||[]}catch(t){throw t}}async create(r){if(!r.name?.trim())throw new Error("Partner name is required");if(await this.findByName(r.project_id,r.name))throw new Error(`Partner "${r.name}" already exists`);return super.create({...r,name:r.name.trim(),is_active:r.is_active??!0,payment_terms:r.payment_terms||"Net 30"})}async findByName(r,t){try{const{data:s,error:a}=await p.from("partners").select("*").eq("project_id",r).ilike("name",t.trim()).limit(1);if(a)throw a;return s?.[0]||null}catch(s){throw s}}async toggleActive(r){const t=await this.getById(r);if(!t)throw new Error("Partner not found");return this.update(r,{is_active:!t.is_active})}async getForSelect(r,t=!0){return(t?await this.getActive(r):await this.getAll(r)).map(a=>({value:a.id,label:a.name}))}async getDependencyCounts(r){try{const{data:t,error:s}=await p.from("resources").select("id").eq("partner_id",r).or("is_deleted.is.null,is_deleted.eq.false");if(s)throw s;const a=t?.map(u=>u.id)||[];let i=0,o=0;if(a.length>0){const{count:u,error:f}=await p.from("timesheets").select("*",{count:"exact",head:!0}).in("resource_id",a).or("is_deleted.is.null,is_deleted.eq.false");if(f)throw f;i=u||0;const{count:h,error:y}=await p.from("expenses").select("*",{count:"exact",head:!0}).in("resource_id",a).or("is_deleted.is.null,is_deleted.eq.false");if(y)throw y;o=h||0}const{count:c,error:l}=await p.from("partner_invoices").select("*",{count:"exact",head:!0}).eq("partner_id",r).or("is_deleted.is.null,is_deleted.eq.false");if(l)throw l;return{resourceCount:t?.length||0,timesheetCount:i,expenseCount:o,invoiceCount:c||0,canDelete:!t?.length&&!c}}catch(t){throw t}}}const yi=new pn;class yn extends ie{constructor(){super("resources",{sanitizeConfig:"resource",supportsSoftDelete:!0})}sanitizeData(r){const t={...r};return t.name&&(t.name=Be(t.name,100)),t.role&&(t.role=Be(t.role,100)),t.email&&(t.email=Ir(t.email)),t.notes&&(t.notes=Ar(t.notes,5e3)),t}async getAll(r,t={}){const{includePartner:s=!0,activeOnly:a=!1,showTestUsers:i=!0,includeDeleted:o=!1}=t;let c="*";s&&(c="*, partner:partners(id, name, is_active)");let l=p.from(this.tableName).select(c).eq("project_id",r).order("name");o||(l=l.or("is_deleted.is.null,is_deleted.eq.false")),a&&(l=l.eq("is_active",!0)),i||(l=l.or("is_test_content.is.null,is_test_content.eq.false"));const{data:u,error:f}=await l;if(f)throw f;return u||[]}async getAllFiltered(r,t=!0){return this.getAll(r,{showTestUsers:t,includePartner:!0})}async getById(r){const{data:t,error:s}=await p.from(this.tableName).select("*, partner:partners(id, name, contact_name, contact_email, is_active)").eq("id",r).or("is_deleted.is.null,is_deleted.eq.false").single();if(s)throw s;return t}async getByType(r,t){const{data:s,error:a}=await p.from(this.tableName).select("*, partner:partners(id, name)").eq("project_id",r).eq("resource_type",t).or("is_deleted.is.null,is_deleted.eq.false").order("name");if(a)throw a;return s||[]}async getByPartner(r){const{data:t,error:s}=await p.from(this.tableName).select("*").eq("partner_id",r).or("is_deleted.is.null,is_deleted.eq.false").order("name");if(s)throw s;return t||[]}async getWithTimesheetSummary(r){const t=await this.getById(r);if(!t)return null;const{data:s,error:a}=await p.from("timesheets").select("id, hours_worked, hours, status, was_rejected, date").eq("resource_id",r).or("is_deleted.is.null,is_deleted.eq.false");let i=0,o=0,c=0;return s&&s.forEach(l=>{const u=parseFloat(l.hours_worked||l.hours||0);i+=u,l.status==="Approved"?o+=u:l.status==="Submitted"&&!l.was_rejected&&(c+=u)}),{...t,timesheetSummary:{totalEntries:s?.length||0,totalHours:i,approvedHours:o,pendingHours:c,daysWorked:je(i)}}}async create(r){const t=this.sanitizeData(r);if(!t.name?.trim())throw new Error("Resource name is required");if(!t.project_id)throw new Error("Project ID is required");if(!t.email?.trim())throw new Error("Email is required");t.resource_type==="internal"&&(t.partner_id=null);const{data:s,error:a}=await p.from(this.tableName).insert([t]).select("*, partner:partners(id, name)").single();if(a)throw a;return s}async update(r,t){const s=this.sanitizeData(t);s.resource_type==="internal"&&(s.partner_id=null),s.updated_at=new Date().toISOString();const{data:a,error:i}=await p.from(this.tableName).update(s).eq("id",r).select("*, partner:partners(id, name)").single();if(i)throw i;return a}async delete(r,t=null){const{data:s,error:a}=await p.from(this.tableName).update({is_deleted:!0,deleted_at:new Date().toISOString(),deleted_by:t}).eq("id",r).select().single();if(a)throw a;return s}async restore(r){const{data:t,error:s}=await p.from(this.tableName).update({is_deleted:!1,deleted_at:null,deleted_by:null}).eq("id",r).select().single();if(s)throw s;return t}async linkToPartner(r,t){const s={partner_id:t,resource_type:t?"third_party":"internal",updated_at:new Date().toISOString()};return this.update(r,s)}async toggleActive(r){const t=await this.getById(r);if(!t)throw new Error("Resource not found");return this.update(r,{is_active:!t.is_active})}async getForSelect(r){const{data:t,error:s}=await p.from(this.tableName).select("id, name, resource_type, role").eq("project_id",r).or("is_deleted.is.null,is_deleted.eq.false").order("name");if(s)throw s;return t||[]}calculateMargin(r,t){if(!r||r===0||!t)return{percent:null,amount:null,status:"unknown"};const s=(r-t)/r*100,a=r-t;let i="critical";return s>=25?i="good":s>=10&&(i="low"),{percent:s,amount:a,status:i}}async getUtilization(r){const t=await this.getWithTimesheetSummary(r);if(!t)return null;const s=t.days_allocated||0,a=t.timesheetSummary.daysWorked,i=Math.max(0,s-a),o=s>0?a/s*100:0;return{resourceId:r,resourceName:t.name,daysAllocated:s,daysUsed:a,remaining:i,utilizationPercent:o,totalValue:(t.sell_price||0)*s,valueUsed:(t.sell_price||0)*a}}async getSummary(r){const t=await this.getAll(r,{includePartner:!1});return{total:t.length,internal:t.filter(s=>s.resource_type==="internal").length,thirdParty:t.filter(s=>s.resource_type==="third_party").length,active:t.filter(s=>s.is_active).length,totalBudget:t.reduce((s,a)=>s+(a.sell_price||0)*(a.days_allocated||0),0)}}async getProfileByEmail(r){try{const{data:t,error:s}=await this.supabase.from("profiles").select("id, email, full_name, role").eq("email",r).single();if(s){if(s.code==="PGRST116")return null;throw s}return t}catch(t){throw t}}async getAllWithTestFilter(r,t=[]){try{const s=await this.getAll(r,{orderBy:{column:"name",ascending:!0}});return t&&t.length>0?s.filter(a=>!a.user_id||!t.includes(a.user_id)):s}catch(s){throw s}}async getDependencyCounts(r){try{const[t,s]=await Promise.all([this.supabase.from("timesheets").select("id",{count:"exact",head:!0}).eq("resource_id",r).or("is_deleted.is.null,is_deleted.eq.false"),this.supabase.from("expenses").select("id",{count:"exact",head:!0}).eq("resource_id",r).or("is_deleted.is.null,is_deleted.eq.false")]);return{timesheetCount:t.count||0,expenseCount:s.count||0,canDelete:(t.count||0)===0&&(s.count||0)===0}}catch(t){throw t}}}const xi=new yn;class xn extends ie{constructor(){super("timesheets",{supportsSoftDelete:!0,sanitizeConfig:"timesheet"})}async getAll(r,t={}){return super.getAll(r,{...t,select:t.select||`
      *,
      resources(id, name, email, sell_price, cost_price),
      milestones(id, milestone_ref, name)
    `,orderBy:t.orderBy||{column:"date",ascending:!1}})}async getAllFiltered(r,t=!1){try{let s=p.from(this.tableName).select(`
          *,
          resources(id, name, email, sell_price, cost_price),
          milestones(id, milestone_ref, name)
        `).eq("project_id",r).order("date",{ascending:!1});this.supportsSoftDelete&&(s=s.or(this.getSoftDeleteFilter())),t||(s=s.or("is_test_content.is.null,is_test_content.eq.false"));const{data:a,error:i}=await s;if(i)throw i;return a||[]}catch(s){throw s}}async getByResource(r,t={}){try{let s=p.from(this.tableName).select("*, milestones(id, milestone_ref, name)").eq("resource_id",r).order("date",{ascending:!1});this.supportsSoftDelete&&(s=s.or(this.getSoftDeleteFilter())),t.start&&(s=s.gte("date",t.start)),t.end&&(s=s.lte("date",t.end)),t.status&&(s=s.eq("status",t.status));const{data:a,error:i}=await s;if(i)throw i;return a||[]}catch(s){throw s}}async getByPartner(r,t={}){try{const{data:s}=await p.from("resources").select("id, name, cost_price").eq("partner_id",r).or("is_deleted.is.null,is_deleted.eq.false");if(!s||s.length===0)return[];const a=s.map(l=>l.id);let i=p.from(this.tableName).select("*, resources(id, name, cost_price), milestones(id, milestone_ref, name)").in("resource_id",a).order("date",{ascending:!1});this.supportsSoftDelete&&(i=i.or(this.getSoftDeleteFilter())),t.start&&(i=i.gte("date",t.start)),t.end&&(i=i.lte("date",t.end)),t.status&&(i=i.eq("status",t.status));const{data:o,error:c}=await i;if(c)throw c;return o||[]}catch(s){throw s}}async getApprovedForInvoice(r,t){if(!t.start||!t.end)throw new Error("Date range (start and end) is required for invoice queries");return this.getByPartner(r,{...t,status:"Approved"})}async getSummary(r,t={}){try{const s=await this.getAll(r,t),a={totalHours:0,totalDays:0,approvedHours:0,pendingHours:0,draftHours:0,rejectedHours:0,totalCost:0,approvedCost:0,byStatus:{Draft:{count:0,hours:0},Submitted:{count:0,hours:0},Approved:{count:0,hours:0},Rejected:{count:0,hours:0}},byMilestone:{},count:s.length};return s.forEach(i=>{const o=parseFloat(i.hours_worked||i.hours||0),c=i.resources?.cost_price||0,l=jt(o,c);switch(a.totalHours+=o,a.totalCost+=l,a.byStatus[i.status]&&(a.byStatus[i.status].count++,a.byStatus[i.status].hours+=o),i.status){case"Approved":a.approvedHours+=o,a.approvedCost+=l;break;case"Submitted":i.was_rejected||(a.pendingHours+=o);break;case"Draft":a.draftHours+=o;break;case"Rejected":a.rejectedHours+=o;break}if(i.milestone_id){const u=i.milestones?.milestone_ref||"Unknown";a.byMilestone[i.milestone_id]||(a.byMilestone[i.milestone_id]={ref:u,name:i.milestones?.name||"Unknown",hours:0,cost:0}),a.byMilestone[i.milestone_id].hours+=o,a.byMilestone[i.milestone_id].cost+=l}}),a.totalDays=je(a.totalHours),a}catch(s){throw s}}async create(r){if(!r.resource_id)throw new Error("resource_id is required");if(!r.date)throw new Error("date is required");const t=parseFloat(r.hours_worked||r.hours||0);if(!t||t<=0)throw new Error("hours must be greater than 0");const s={...r,hours_worked:t,hours:t,date:r.date||r.work_date,work_date:r.work_date||r.date,description:r.description||r.comments||"",comments:r.comments||r.description||"",status:r.status||"Draft"};return super.create(s)}async submit(r){return this.update(r,{status:"Submitted"})}async validate(r){return this.update(r,{status:"Approved"})}async approve(r){return this.validate(r)}async reject(r,t=null){const s={status:"Rejected",was_rejected:!0};return t&&(s.rejection_reason=t),this.update(r,s)}calculateCost(r,t){return jt(r,t)}calculateBillable(r,t){return dt(r,t)}}const Dr=new xn;class bn extends ie{constructor(){super("expenses",{supportsSoftDelete:!0,sanitizeConfig:"expense"})}async getAll(r,t={}){return super.getAll(r,{...t,select:t.select||"*, expense_files(*)",orderBy:t.orderBy||{column:"expense_date",ascending:!1}})}async getAllFiltered(r,t=!1){try{let s=p.from(this.tableName).select("*, expense_files(*)").eq("project_id",r).order("expense_date",{ascending:!1});const{data:a,error:i}=await s;if(i)throw i;let o=a||[];return this.supportsSoftDelete&&(o=o.filter(c=>c.is_deleted!==!0)),t||(o=o.filter(c=>c.is_test_content!==!0)),o}catch(s){throw s}}async getByResource(r,t={}){try{let s=p.from(this.tableName).select("*, expense_files(*)").eq("resource_id",r).order("expense_date",{ascending:!1});t.start&&(s=s.gte("expense_date",t.start)),t.end&&(s=s.lte("expense_date",t.end));const{data:a,error:i}=await s;if(i)throw i;let o=a||[];return this.supportsSoftDelete&&(o=o.filter(c=>c.is_deleted!==!0)),o}catch(s){throw s}}async getByPartner(r,t={}){try{const{data:s}=await p.from("resources").select("id").eq("partner_id",r);if(!s||s.length===0)return[];const a=s.map(u=>u.id);let i=p.from(this.tableName).select("*, expense_files(*)").in("resource_id",a).order("expense_date",{ascending:!1});t.start&&(i=i.gte("expense_date",t.start)),t.end&&(i=i.lte("expense_date",t.end)),t.procurementMethod&&(i=i.eq("procurement_method",t.procurementMethod));const{data:o,error:c}=await i;if(c)throw c;let l=o||[];return this.supportsSoftDelete&&(l=l.filter(u=>u.is_deleted!==!0)),l}catch(s){throw s}}async getPartnerProcuredForInvoice(r,t){if(!t.start||!t.end)throw new Error("Date range (start and end) is required for invoice queries");return this.getByPartner(r,{...t,procurementMethod:"partner"})}async getSummary(r,t={}){try{const s=await this.getAll(r,t),a={total:0,chargeable:0,nonChargeable:0,supplierProcured:0,partnerProcured:0,byCategory:{Travel:0,Accommodation:0,Sustenance:0},byStatus:{Draft:0,Submitted:0,Approved:0,Rejected:0,Paid:0},count:s.length};return s.forEach(i=>{const o=parseFloat(i.amount||0);a.total+=o,i.chargeable_to_customer!==!1?a.chargeable+=o:a.nonChargeable+=o,i.procurement_method==="partner"?a.partnerProcured+=o:a.supplierProcured+=o,a.byCategory[i.category]!==void 0&&(a.byCategory[i.category]+=o),a.byStatus[i.status]!==void 0&&(a.byStatus[i.status]+=o)}),a}catch(s){throw s}}async create(r){if(!r.resource_id)throw new Error("resource_id is required");if(!r.category)throw new Error("category is required");if(!r.amount||r.amount<=0)throw new Error("amount must be greater than 0");const t={...r,status:r.status||"Draft",chargeable_to_customer:r.chargeable_to_customer??!0,procurement_method:r.procurement_method||"supplier"};return super.create(t)}async createMany(r){if(!r||r.length===0)return[];try{const t=r.map(i=>{if(!i.resource_id)throw new Error("resource_id is required for all expenses");if(!i.category)throw new Error("category is required for all expenses");if(!i.amount||i.amount<=0)throw new Error("amount must be greater than 0 for all expenses");return{...i,status:i.status||"Draft",chargeable_to_customer:i.chargeable_to_customer??!0,procurement_method:i.procurement_method||"supplier"}}),{data:s,error:a}=await p.from(this.tableName).insert(t).select();if(a)throw a;return s||[]}catch(t){throw t}}async submit(r){return this.update(r,{status:"Submitted"})}async validate(r){return this.update(r,{status:"Approved"})}async approve(r){return this.validate(r)}async reject(r,t=null){const s={status:"Rejected"};return t&&(s.rejection_reason=t),this.update(r,s)}async markPaid(r){return this.update(r,{status:"Paid"})}async uploadReceipt(r,t,s){try{const a=`${r}/${Date.now()}-${t.name}`,{error:i}=await p.storage.from("receipts").upload(a,t);if(i)throw i;const{data:o,error:c}=await p.from("expense_files").insert({expense_id:r,file_name:t.name,file_path:a,file_size:t.size,file_type:t.type,uploaded_by:s}).select();if(c)throw c;return o?.[0]}catch(a){throw a}}async downloadReceipt(r){try{const{data:t,error:s}=await p.storage.from("receipts").download(r);if(s)throw s;return t}catch(t){throw t}}}const Mr=new bn;class wn extends ie{constructor(){super("partner_invoices")}async getAll(r,t={}){return super.getAll(r,{...t,select:t.select||"*, partners(name)",orderBy:t.orderBy||{column:"invoice_date",ascending:!1}})}async getByPartner(r,t={}){try{let s=p.from(this.tableName).select("*").eq("partner_id",r).order("invoice_date",{ascending:!1});t.status&&(s=s.eq("status",t.status));const{data:a,error:i}=await s;if(i)throw i;return a||[]}catch(s){throw s}}async getWithLines(r){try{const{data:t,error:s}=await p.from(this.tableName).select("*, partners(name, contact_name, contact_email, payment_terms)").eq("id",r).limit(1);if(s)throw s;const a=t?.[0];if(!a)return null;const{data:i,error:o}=await p.from("partner_invoice_lines").select("*").eq("invoice_id",r).order("line_type",{ascending:!0}).order("resource_name",{ascending:!0}).order("line_date",{ascending:!0});if(o)throw o;const c={timesheets:(i||[]).filter(l=>l.line_type==="timesheet"),supplierExpenses:(i||[]).filter(l=>l.line_type==="supplier_expense"),partnerExpenses:(i||[]).filter(l=>l.line_type==="expense")};return{...a,lines:i||[],groupedLines:c}}catch(t){throw t}}async generateInvoiceNumber(r){try{const s=`INV-${new Date().getFullYear()}-`,{data:a,error:i}=await p.from(this.tableName).select("invoice_number").eq("project_id",r).like("invoice_number",`${s}%`).order("invoice_number",{ascending:!1}).limit(1);if(i)throw i;let o=1;if(a&&a.length>0){const c=a[0].invoice_number,l=parseInt(c.replace(s,""),10);isNaN(l)||(o=l+1)}return`${s}${String(o).padStart(3,"0")}`}catch(t){throw t}}async generateInvoice(r){const{projectId:t,partnerId:s,periodStart:a,periodEnd:i,createdBy:o,notes:c,includeSubmitted:l=!0}=r;try{const{data:u,error:f}=await p.from("resources").select("id, name, cost_price").eq("partner_id",s);if(f)throw f;if(!u||u.length===0)throw new Error("No resources linked to this partner");const h=u.map(I=>I.id),y={};u.forEach(I=>{y[I.id]=I});const g=l?["Approved","Submitted"]:["Approved"],{data:b,error:m}=await p.from("timesheets").select("id, date, hours_worked, hours, status, resource_id").in("resource_id",h).gte("date",a).lte("date",i).in("status",g);if(m)throw m;const{data:w,error:R}=await p.from("expenses").select("id, expense_date, category, reason, amount, resource_id, resource_name, procurement_method, chargeable_to_customer, status").in("resource_id",h).gte("expense_date",a).lte("expense_date",i).in("status",["Approved","Submitted","Paid"]);if(R)throw R;const M=(w||[]).filter(I=>I.procurement_method==="partner"||!I.procurement_method),A=(w||[]).filter(I=>I.procurement_method==="supplier");let S=0,E=0;const v=[],k={};(b||[]).forEach(I=>{k[I.resource_id]||(k[I.resource_id]=[]),k[I.resource_id].push(I)}),Object.keys(k).forEach(I=>{const Q=y[I];k[I].forEach(xe=>{const fe=parseFloat(xe.hours_worked||xe.hours||0),Ce=Q?.cost_price||0,De=je(fe),Ne=De*Ce;S+=Ne,E+=Ne,v.push({line_type:"timesheet",timesheet_id:xe.id,expense_id:null,description:`${Q?.name||"Unknown"} - ${fe}h (${De.toFixed(2)} days)`,quantity:fe,unit_price:Ce,line_total:Ne,resource_name:Q?.name,line_date:xe.date,hours:fe,cost_price:Ce,source_status:xe.status,chargeable_to_customer:!0,procurement_method:null,expense_category:null})})});let N=0,j=0,D=0;const C=[];M.forEach(I=>{const Q=parseFloat(I.amount||0);N+=Q,I.chargeable_to_customer?j+=Q:D+=Q,C.push({line_type:"expense",timesheet_id:null,expense_id:I.id,description:`${I.resource_name} - ${I.category}: ${I.reason}`,quantity:1,unit_price:Q,line_total:Q,resource_name:I.resource_name,line_date:I.expense_date,hours:null,cost_price:null,source_status:I.status,chargeable_to_customer:I.chargeable_to_customer,procurement_method:"partner",expense_category:I.category})});let _=0,L=0,se=0;const oe=[];A.forEach(I=>{const Q=parseFloat(I.amount||0);_+=Q,I.chargeable_to_customer?L+=Q:se+=Q,oe.push({line_type:"supplier_expense",timesheet_id:null,expense_id:I.id,description:`${I.resource_name} - ${I.category}: ${I.reason}`,quantity:1,unit_price:Q,line_total:Q,resource_name:I.resource_name,line_date:I.expense_date,hours:null,cost_price:null,source_status:I.status,chargeable_to_customer:I.chargeable_to_customer,procurement_method:"supplier",expense_category:I.category})});const T=S+N,H=E+j+L,he=D+se,de=await this.generateInvoiceNumber(t),{data:_e,error:ye}=await p.from(this.tableName).insert({project_id:t,partner_id:s,invoice_number:de,invoice_date:new Date().toISOString().split("T")[0],period_start:a,period_end:i,timesheet_total:S,expense_total:N,supplier_expense_total:_,invoice_total:T,chargeable_total:H,non_chargeable_total:he,status:"Draft",notes:c||null,created_by:o}).select().single();if(ye)throw ye;const me=[...v,...C,...oe].map(I=>({...I,invoice_id:_e.id}));if(me.length>0){const{error:I}=await p.from("partner_invoice_lines").insert(me);if(I)throw I}return this.getWithLines(_e.id)}catch(u){throw u}}async updateStatus(r,t){const s={status:t};return t==="Sent"?s.sent_at=new Date().toISOString():t==="Paid"&&(s.paid_at=new Date().toISOString()),this.update(r,s)}async markSent(r){return this.updateStatus(r,"Sent")}async markPaid(r){return this.updateStatus(r,"Paid")}async cancel(r){return this.updateStatus(r,"Cancelled")}async getPartnerStats(r){try{const{data:t,error:s}=await p.from(this.tableName).select("status, invoice_total").eq("partner_id",r);if(s)throw s;const a={total:0,draft:0,sent:0,paid:0,cancelled:0,count:t?.length||0};return(t||[]).forEach(i=>{const o=parseFloat(i.invoice_total||0);switch(a.total+=o,i.status){case"Draft":a.draft+=o;break;case"Sent":a.sent+=o;break;case"Paid":a.paid+=o;break;case"Cancelled":a.cancelled+=o;break}}),a}catch(t){throw t}}}const bi=new wn;class _n extends ie{constructor(){super("milestones",{supportsSoftDelete:!0,sanitizeConfig:"milestone"})}async getAllWithStats(r){try{const t=await this.getAll(r,{orderBy:{column:"start_date",ascending:!0}}),{data:s}=await p.from("timesheets").select("milestone_id, hours_worked").eq("project_id",r).not("milestone_id","is",null).or("is_deleted.is.null,is_deleted.eq.false"),a={};return(s||[]).forEach(i=>{a[i.milestone_id]||(a[i.milestone_id]=0),a[i.milestone_id]+=parseFloat(i.hours_worked||0)}),t.map(i=>({...i,logged_hours:a[i.id]||0,logged_days:je(a[i.id]||0)}))}catch(t){throw t}}async getWithDeliverables(r){try{const{data:t,error:s}=await p.from(this.tableName).select("*").eq("id",r).or(this.getSoftDeleteFilter()).limit(1);if(s)throw s;const a=t?.[0],{data:i,error:o}=await p.from("deliverables").select("*").eq("milestone_id",r).or("is_deleted.is.null,is_deleted.eq.false").order("due_date",{ascending:!0});if(o)throw o;return{...a,deliverables:i||[]}}catch(t){throw t}}async getByStatus(r,t){return this.getAll(r,{filters:[{column:"status",operator:"eq",value:t}],orderBy:{column:"start_date",ascending:!0}})}async getUpcoming(r,t=30){try{const s=new Date().toISOString().split("T")[0],a=new Date;a.setDate(a.getDate()+t);const i=a.toISOString().split("T")[0];let o=p.from(this.tableName).select("*").eq("project_id",r).gte("end_date",s).lte("end_date",i).neq("status","Completed").order("end_date",{ascending:!0});this.supportsSoftDelete&&(o=o.or(this.getSoftDeleteFilter()));const{data:c,error:l}=await o;if(l)throw l;return c||[]}catch(s){throw s}}async updateStatus(r,t){return this.update(r,{status:t})}async updateCompletion(r,t){const s={completion_percentage:t};return t>=100&&(s.status="Completed"),this.update(r,s)}async getSummary(r){try{const t=await this.getAll(r),s={total:t.length,completed:0,inProgress:0,notStarted:0,overdue:0,upcoming:0},a=new Date().toISOString().split("T")[0],i=new Date;i.setDate(i.getDate()+7);const o=i.toISOString().split("T")[0];return t.forEach(c=>{c.status==="Completed"?s.completed++:c.status==="In Progress"?(s.inProgress++,c.end_date<a&&s.overdue++):c.status==="Not Started"&&(s.notStarted++,c.start_date<=o&&s.upcoming++)}),s}catch(t){throw t}}async getCertificates(r){try{const{data:t,error:s}=await p.from("milestone_certificates").select("*").eq("project_id",r).order("created_at",{ascending:!1});if(s)throw s;return t||[]}catch(t){throw t}}async getCertificateByMilestoneId(r){try{const{data:t,error:s}=await p.from("milestone_certificates").select("*").eq("milestone_id",r).limit(1);if(s)throw s;return t?.[0]||null}catch(t){throw t}}async createCertificate(r){try{const{data:t,error:s}=await p.from("milestone_certificates").insert([r]).select();if(s)throw s;return t?.[0]}catch(t){throw t}}async updateCertificate(r,t){try{const{data:s,error:a}=await p.from("milestone_certificates").update(t).eq("id",r).select();if(a)throw a;return s?.[0]}catch(s){throw s}}async signCertificate(r,t,s,a){try{const{data:i,error:o}=await p.from("milestone_certificates").select("*").eq("id",r).limit(1);if(o)throw o;const c=i?.[0];if(!c)throw new Error("Certificate not found");const l=new Date().toISOString(),u={};if(t==="supplier")u.supplier_pm_id=s,u.supplier_pm_name=a,u.supplier_pm_signed_at=l,u.status=c.customer_pm_signed_at?"Signed":"Pending Customer Signature";else if(t==="customer")u.customer_pm_id=s,u.customer_pm_name=a,u.customer_pm_signed_at=l,u.status=c.supplier_pm_signed_at?"Signed":"Pending Supplier Signature";else throw new Error('Invalid signer role. Must be "supplier" or "customer".');const{data:f,error:h}=await p.from("milestone_certificates").update(u).eq("id",r).select();if(h)throw h;return f?.[0]}catch(i){throw i}}async signBaseline(r,t,s,a){try{const i=await this.getById(r);if(!i)throw new Error("Milestone not found");const o=new Date().toISOString(),c={};if(t==="supplier")c.baseline_supplier_pm_id=s,c.baseline_supplier_pm_name=a,c.baseline_supplier_pm_signed_at=o,i.baseline_customer_pm_signed_at&&(c.baseline_locked=!0);else if(t==="customer")c.baseline_customer_pm_id=s,c.baseline_customer_pm_name=a,c.baseline_customer_pm_signed_at=o,i.baseline_supplier_pm_signed_at&&(c.baseline_locked=!0);else throw new Error('Invalid signer role. Must be "supplier" or "customer".');return await this.update(r,c)}catch(i){throw i}}async resetBaseline(r){try{return await this.update(r,{baseline_locked:!1,baseline_supplier_pm_id:null,baseline_supplier_pm_name:null,baseline_supplier_pm_signed_at:null,baseline_customer_pm_id:null,baseline_customer_pm_name:null,baseline_customer_pm_signed_at:null})}catch(t){throw t}}async getBillableMilestones(r){try{const t=await this.getAll(r,{filters:[{column:"billable",operator:"gt",value:0}],orderBy:{column:"milestone_ref",ascending:!0}}),s=t.map(o=>o.id),{data:a}=await p.from("milestone_certificates").select("milestone_id, status").eq("project_id",r),i={};if((a||[]).forEach(o=>{(!i[o.milestone_id]||o.status==="Signed")&&(i[o.milestone_id]=o.status)}),s.length>0){const{data:o}=await p.from("deliverables").select("milestone_id, due_date").in("milestone_id",s).or("is_deleted.is.null,is_deleted.eq.false"),c={};return(o||[]).forEach(l=>{l.due_date&&(!c[l.milestone_id]||l.due_date>c[l.milestone_id])&&(c[l.milestone_id]=l.due_date)}),t.map(l=>({...l,expected_date:c[l.id]||l.forecast_end_date||l.end_date,certificate_status:i[l.id]||null,ready_to_bill:i[l.id]==="Signed"}))}return t.map(o=>({...o,expected_date:o.forecast_end_date||o.end_date,certificate_status:i[o.id]||null,ready_to_bill:i[o.id]==="Signed"}))}catch(t){throw t}}}const ve=new _n;class vn extends ie{constructor(){super("deliverables",{supportsSoftDelete:!0,sanitizeConfig:"deliverable"})}async getAllWithMilestones(r){return this.getAll(r,{select:"*, milestones(name, milestone_ref)",orderBy:{column:"due_date",ascending:!0}})}async getByMilestone(r){try{let t=p.from(this.tableName).select("*").eq("milestone_id",r).order("due_date",{ascending:!0});this.supportsSoftDelete&&(t=t.or(this.getSoftDeleteFilter()));const{data:s,error:a}=await t;if(a)throw a;return s||[]}catch(t){throw t}}async getByStatus(r,t){return this.getAll(r,{filters:[{column:"status",operator:"eq",value:t}],orderBy:{column:"due_date",ascending:!0}})}async getOverdue(r){try{const t=new Date().toISOString().split("T")[0];let s=p.from(this.tableName).select("*, milestones(name)").eq("project_id",r).lt("due_date",t).not("status","in",'("Delivered","Cancelled")').order("due_date",{ascending:!0});this.supportsSoftDelete&&(s=s.or(this.getSoftDeleteFilter()));const{data:a,error:i}=await s;if(i)throw i;return a||[]}catch(t){throw t}}async getUpcoming(r,t=14){try{const s=new Date().toISOString().split("T")[0],a=new Date;a.setDate(a.getDate()+t);const i=a.toISOString().split("T")[0];let o=p.from(this.tableName).select("*, milestones(name)").eq("project_id",r).gte("due_date",s).lte("due_date",i).not("status","eq","Delivered").order("due_date",{ascending:!0});this.supportsSoftDelete&&(o=o.or(this.getSoftDeleteFilter()));const{data:c,error:l}=await o;if(l)throw l;return c||[]}catch(s){throw s}}async updateStatus(r,t,s){const a={status:t};return t==="Submitted"?(a.submitted_date=new Date().toISOString(),a.submitted_by=s):t==="Delivered"&&(a.delivered_date=new Date().toISOString(),a.delivered_by=s),this.update(r,a)}async submit(r,t){return this.updateStatus(r,"Submitted",t)}async markDelivered(r,t){return this.updateStatus(r,"Delivered",t)}async reject(r,t){return this.update(r,{status:"Rejected",rejection_reason:t})}async getSummary(r){try{const t=await this.getAll(r),s=new Date().toISOString().split("T")[0],a={total:t.length,delivered:0,inProgress:0,notStarted:0,overdue:0,dueThisWeek:0},i=new Date;i.setDate(i.getDate()+7);const o=i.toISOString().split("T")[0];return t.forEach(c=>{c.status==="Delivered"?a.delivered++:c.status==="In Progress"?(a.inProgress++,c.due_date<s?a.overdue++:c.due_date<=o&&a.dueThisWeek++):(c.status==="Not Started"||c.status==="Draft")&&(a.notStarted++,c.due_date<s&&a.overdue++)}),a}catch(t){throw t}}async getAllWithRelations(r,t=!1){try{let s=p.from("deliverables").select(`
          *,
          milestones(milestone_ref, name),
          deliverable_kpis(kpi_id, kpis(kpi_ref, name)),
          deliverable_quality_standards(quality_standard_id, quality_standards(qs_ref, name))
        `).eq("project_id",r).or("is_deleted.is.null,is_deleted.eq.false").order("deliverable_ref");t||(s=s.or("is_test_content.is.null,is_test_content.eq.false"));const{data:a,error:i}=await s;if(i)throw i;return a||[]}catch(s){throw s}}async syncKPILinks(r,t=[]){try{const{error:s}=await p.from("deliverable_kpis").delete().eq("deliverable_id",r);if(s)throw s;if(t.length>0){const a=t.map(o=>({deliverable_id:r,kpi_id:o})),{error:i}=await p.from("deliverable_kpis").insert(a);if(i)throw i}return!0}catch(s){throw s}}async syncQSLinks(r,t=[]){try{const{error:s}=await p.from("deliverable_quality_standards").delete().eq("deliverable_id",r);if(s)throw s;if(t.length>0){const a=t.map(o=>({deliverable_id:r,quality_standard_id:o})),{error:i}=await p.from("deliverable_quality_standards").insert(a);if(i)throw i}return!0}catch(s){throw s}}async upsertKPIAssessments(r,t,s){try{const a=t.map(o=>({deliverable_id:r,kpi_id:o.kpiId,criteria_met:o.criteriaMet,assessed_at:new Date().toISOString(),assessed_by:s})),{error:i}=await p.from("deliverable_kpi_assessments").upsert(a,{onConflict:"deliverable_id,kpi_id"});if(i)throw i;return!0}catch(a){throw a}}async upsertQSAssessments(r,t,s){try{const a=t.map(o=>({deliverable_id:r,quality_standard_id:o.qsId,criteria_met:o.criteriaMet,assessed_at:new Date().toISOString(),assessed_by:s})),{error:i}=await p.from("deliverable_qs_assessments").upsert(a,{onConflict:"deliverable_id,quality_standard_id"});if(i)throw i;return!0}catch(a){throw a}}}const Tr=new vn;class Sn extends ie{constructor(){super("kpis")}async getAllWithStatus(r){try{return(await this.getAll(r,{orderBy:{column:"name",ascending:!0}})).map(s=>({...s,rag_status:this.calculateRAG(s)}))}catch(t){throw t}}calculateRAG(r){if(!r.target_value||r.actual_value===null||r.actual_value===void 0)return"Unknown";const t=parseFloat(r.actual_value),s=parseFloat(r.target_value),a=parseFloat(r.threshold_amber||10);return r.trend==="higher_better"?t>=s?"Green":t>=s*(1-a/100)?"Amber":"Red":t<=s?"Green":t<=s*(1+a/100)?"Amber":"Red"}async getByRAGStatus(r,t){try{return(await this.getAllWithStatus(r)).filter(a=>a.rag_status===t)}catch(s){throw s}}async getNeedingAttention(r){try{return(await this.getAllWithStatus(r)).filter(s=>s.rag_status==="Amber"||s.rag_status==="Red")}catch(t){throw t}}async updateActualValue(r,t){return this.update(r,{actual_value:t,last_updated:new Date().toISOString()})}async getHistory(r,t=12){try{const{data:s,error:a}=await p.from("kpi_history").select("*").eq("kpi_id",r).order("recorded_at",{ascending:!1}).limit(t);if(a)throw a;return s||[]}catch{return[]}}async getSummary(r){try{const t=await this.getAllWithStatus(r);return{total:t.length,green:t.filter(s=>s.rag_status==="Green").length,amber:t.filter(s=>s.rag_status==="Amber").length,red:t.filter(s=>s.rag_status==="Red").length,unknown:t.filter(s=>s.rag_status==="Unknown").length}}catch(t){throw t}}async getAssessments(r){try{const{data:t,error:s}=await p.from("deliverable_kpi_assessments").select(`
          kpi_id,
          criteria_met,
          deliverables!inner(id, status, is_deleted, project_id)
        `).eq("deliverables.project_id",r);return s?await this.getAssessmentsFallback(r):(t||[]).filter(i=>i.deliverables?.is_deleted!==!0&&X.deliverables.contributeToKPIs.includes(i.deliverables?.status))}catch{return[]}}async getAssessmentsFallback(r){try{const{data:t,error:s}=await p.from("deliverable_kpi_assessments").select("kpi_id, criteria_met, deliverable_id");if(s)throw s;const{data:a,error:i}=await p.from("deliverables").select("id, status, is_deleted").eq("project_id",r);if(i)throw i;const o=new Set((a||[]).filter(l=>l.is_deleted!==!0&&X.deliverables.contributeToKPIs.includes(l.status)).map(l=>l.id));return(t||[]).filter(l=>o.has(l.deliverable_id))}catch{return[]}}}const jn=new Sn;class Cn extends ie{constructor(){super("quality_standards")}async getAllWithStatus(r){try{return(await this.getAll(r,{orderBy:{column:"name",ascending:!0}})).map(s=>({...s,compliance_status:this.calculateCompliance(s)}))}catch(t){throw t}}calculateCompliance(r){if(r.actual_value===null||r.actual_value===void 0)return"Not Measured";const t=parseFloat(r.actual_value),s=parseFloat(r.target_value||0);return t>=s?"Compliant":t>=s*.9?"Near Compliant":"Non-Compliant"}async getNonCompliant(r){try{return(await this.getAllWithStatus(r)).filter(s=>s.compliance_status==="Non-Compliant")}catch(t){throw t}}async updateMeasurement(r,t,s){return this.update(r,{actual_value:t,measurement_notes:s,last_measured:new Date().toISOString()})}async getSummary(r){try{const t=await this.getAllWithStatus(r);return{total:t.length,compliant:t.filter(s=>s.compliance_status==="Compliant").length,nearCompliant:t.filter(s=>s.compliance_status==="Near Compliant").length,nonCompliant:t.filter(s=>s.compliance_status==="Non-Compliant").length,notMeasured:t.filter(s=>s.compliance_status==="Not Measured").length}}catch(t){throw t}}async getAssessments(r){try{const{data:t,error:s}=await p.from("deliverable_qs_assessments").select(`
          quality_standard_id,
          criteria_met,
          deliverables!inner(id, status, is_deleted, project_id)
        `).eq("deliverables.project_id",r);return s?await this.getAssessmentsFallback(r):(t||[]).filter(i=>i.deliverables?.is_deleted!==!0&&X.deliverables.contributeToQS.includes(i.deliverables?.status))}catch{return[]}}async getAssessmentsFallback(r){try{const{data:t,error:s}=await p.from("deliverable_qs_assessments").select("quality_standard_id, criteria_met, deliverable_id");if(s)throw s;const{data:a,error:i}=await p.from("deliverables").select("id, status, is_deleted").eq("project_id",r);if(i)throw i;const o=new Set((a||[]).filter(l=>l.is_deleted!==!0&&X.deliverables.contributeToQS.includes(l.status)).map(l=>l.id));return(t||[]).filter(l=>o.has(l.deliverable_id))}catch{return[]}}async getAllWithCalculatedValues(r){try{const t=await this.getAll(r,{orderBy:{column:"qs_ref",ascending:!0}}),s=await this.getAssessments(r),a={};return s.forEach(i=>{a[i.quality_standard_id]||(a[i.quality_standard_id]={total:0,met:0}),a[i.quality_standard_id].total++,i.criteria_met&&a[i.quality_standard_id].met++}),t.map(i=>{const o=a[i.id],c=o&&o.total>0?Math.round(o.met/o.total*100):0,l=i.target||100,u=c>=l;return{...i,calculatedValue:c,assessmentCount:o?.total||0,assessmentsMet:o?.met||0,isAchieved:u}})}catch(t){throw t}}}const Nn=new Cn;class En extends ie{constructor(){super("standards",{supportsSoftDelete:!1,sanitizeConfig:"standard"})}async getAll(r){return super.getAll(r,{orderBy:{column:"standard_ref",ascending:!0}})}async getByStatus(r,t){return super.getAll(r,{filters:[{column:"status",operator:"eq",value:t}],orderBy:{column:"standard_ref",ascending:!0}})}async getByCategory(r,t){return super.getAll(r,{filters:[{column:"category",operator:"eq",value:t}],orderBy:{column:"standard_ref",ascending:!0}})}async getSummary(r){try{const t=await this.getAll(r);return{total:t.length,completed:t.filter(s=>s.status==="Completed").length,inProgress:t.filter(s=>s.status==="In Progress").length,notStarted:t.filter(s=>!s.status||s.status==="Not Started").length}}catch(t){throw t}}}new En;const kn={version:"2.0",widgets:{"progress-hero":{visible:!0,x:0,y:0,w:12,h:2,minW:6,minH:2,maxH:3},"budget-summary":{visible:!1,x:0,y:2,w:6,h:2,minW:4,minH:2,maxH:3},"pmo-tracking":{visible:!1,x:6,y:2,w:6,h:2,minW:6,minH:2,maxH:4},"stats-grid":{visible:!0,x:0,y:2,w:12,h:2,minW:8,minH:2,maxH:3},certificates:{visible:!1,x:0,y:4,w:12,h:2,minW:6,minH:2,maxH:3},"milestones-list":{visible:!0,x:0,y:4,w:12,h:4,minW:8,minH:3,maxH:6},"kpis-category":{visible:!1,x:0,y:8,w:6,h:3,minW:4,minH:3,maxH:5},"quality-standards":{visible:!1,x:6,y:8,w:6,h:3,minW:4,minH:3,maxH:5}}};({...kn});class Rn extends ie{constructor(){super("raid_items",{supportsSoftDelete:!0,sanitizeConfig:"raid_items"})}async getAllWithRelations(r,t={}){try{let s=p.from("raid_items").select(`
          *,
          owner:resources!raid_items_owner_id_fkey(id, name, email),
          milestone:milestones!raid_items_milestone_id_fkey(id, name, milestone_ref)
        `).eq("project_id",r);t.category&&(s=s.eq("category",t.category)),t.status&&(Array.isArray(t.status)?s=s.in("status",t.status):s=s.eq("status",t.status)),t.severity&&(s=s.eq("severity",t.severity));const a=t.orderBy?.column||"raid_ref",i=t.orderBy?.ascending??!0;s=s.order(a,{ascending:i});const{data:o,error:c}=await s;if(c)throw c;let l=o||[];return t.includeDeleted||(l=l.filter(u=>u.is_deleted!==!0)),l}catch(s){throw s}}async getGroupedByCategory(r){try{const t=await this.getAllWithRelations(r);return{risks:t.filter(s=>s.category==="Risk"),assumptions:t.filter(s=>s.category==="Assumption"),issues:t.filter(s=>s.category==="Issue"),dependencies:t.filter(s=>s.category==="Dependency")}}catch(t){throw t}}async getSummary(r){try{const t=await this.getAll(r),s={total:t.length,byCategory:{Risk:{total:0,open:0,highSeverity:0},Assumption:{total:0,open:0,highSeverity:0},Issue:{total:0,open:0,highSeverity:0},Dependency:{total:0,open:0,highSeverity:0}},byStatus:{Open:0,"In Progress":0,Closed:0,Accepted:0,Mitigated:0},bySeverity:{High:0,Medium:0,Low:0},highPriorityItems:[]};return t.forEach(a=>{s.byCategory[a.category]&&(s.byCategory[a.category].total++,(a.status==="Open"||a.status==="In Progress")&&s.byCategory[a.category].open++,a.severity==="High"&&s.byCategory[a.category].highSeverity++),s.byStatus.hasOwnProperty(a.status)&&s.byStatus[a.status]++,a.severity&&s.bySeverity.hasOwnProperty(a.severity)&&s.bySeverity[a.severity]++,a.severity==="High"&&(a.status==="Open"||a.status==="In Progress")&&s.highPriorityItems.push({id:a.id,raid_ref:a.raid_ref,category:a.category,title:a.title,description:a.description?.substring(0,100)+"..."})}),s}catch(t){throw t}}async getNextRef(r,t){try{const s=this.getCategoryPrefix(t),{data:a,error:i}=await p.from("raid_items").select("raid_ref").eq("project_id",r).ilike("raid_ref",`${s}%`).order("raid_ref",{ascending:!1}).limit(1);if(i)throw i;if(!a||a.length===0)return`${s}001`;const o=a[0].raid_ref,l=((parseInt(o.replace(s,""),10)||0)+1).toString().padStart(3,"0");return`${s}${l}`}catch(s){throw s}}getCategoryPrefix(r){return{Risk:"R",Assumption:"A",Issue:"I",Dependency:"D"}[r]||"X"}async createWithAutoRef(r){try{return r.raid_ref||(r.raid_ref=await this.getNextRef(r.project_id,r.category)),await this.create(r)}catch(t){throw t}}async updateStatus(r,t,s=null){try{const a={status:t};return["Closed","Accepted","Mitigated"].includes(t)?(a.closed_date=new Date().toISOString().split("T")[0],s&&(a.resolution=s)):a.closed_date=null,await this.update(r,a)}catch(a){throw a}}async getOverdue(r){try{const t=new Date().toISOString().split("T")[0],{data:s,error:a}=await p.from("raid_items").select("*").eq("project_id",r).in("status",["Open","In Progress"]).lt("due_date",t).order("due_date",{ascending:!0});if(a)throw a;return(s||[]).filter(i=>i.is_deleted!==!0)}catch(t){throw t}}async getByMilestone(r){try{const{data:t,error:s}=await p.from("raid_items").select("*").eq("milestone_id",r).order("raid_ref",{ascending:!0});if(s)throw s;return(t||[]).filter(a=>a.is_deleted!==!0)}catch(t){throw t}}async getByOwner(r){try{const{data:t,error:s}=await p.from("raid_items").select("*").eq("owner_id",r).order("raid_ref",{ascending:!0});if(s)throw s;return(t||[]).filter(a=>a.is_deleted!==!0)}catch(t){throw t}}async bulkUpdateStatus(r,t){const s={success:0,failed:0,errors:[]};for(const a of r)try{await this.updateStatus(a,t),s.success++}catch(i){s.failed++,s.errors.push({id:a,error:i.message})}return s}}const wi=new Rn;function Pn({refreshTrigger:n}){const r=ce(),{projectId:t}=ne(),[s,a]=d.useState(!0),[i,o]=d.useState({total:0,approved:0,awaitingSignatures:0,awaitingCertificate:0,inProgress:0}),c=d.useCallback(async()=>{if(t){a(!0);try{const u=await ve.getAll(t,{orderBy:{column:"milestone_ref",ascending:!0}}),f=u.map(M=>M.id);let h={};f.length>0&&(await Tr.getAll(t,{filters:[{column:"milestone_id",operator:"in",value:f}],select:"id, milestone_id, status"})||[]).forEach(A=>{h[A.milestone_id]||(h[A.milestone_id]=[]),h[A.milestone_id].push(A)});const y=await ve.getCertificates(t),g={};y.forEach(M=>{g[M.milestone_id]=M});let b=0,m=0,w=0,R=0;u.forEach(M=>{const A=h[M.id]||[],S=A.length>0&&A.every(v=>v.status==="Delivered"),E=g[M.id];E&&E.status==="Signed"?b++:E?m++:S?w++:R++}),o({total:u.length,approved:b,awaitingSignatures:m,awaitingCertificate:w,inProgress:R})}catch{}finally{a(!1)}}},[t]);d.useEffect(()=>{c()},[c,n]);const l=()=>{r("/milestones")};return s?e.jsxs("div",{className:"dashboard-widget",onClick:l,children:[e.jsxs("div",{className:"widget-header",children:[e.jsx("div",{className:"widget-icon",children:e.jsx(rt,{size:20})}),e.jsx("span",{className:"widget-title",children:"Milestones"})]}),e.jsx("div",{className:"widget-loading",children:"Loading..."})]}):e.jsxs("div",{className:"dashboard-widget",onClick:l,children:[e.jsxs("div",{className:"widget-header",children:[e.jsx("div",{className:"widget-icon",children:e.jsx(rt,{size:20})}),e.jsx("span",{className:"widget-title",children:"Milestones"}),e.jsxs("span",{className:"widget-total",children:[i.total," Total"]})]}),e.jsxs("div",{className:"widget-breakdown",children:[e.jsxs("div",{className:"widget-row",children:[e.jsx("div",{className:"widget-row-icon approved",children:e.jsx(we,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"Approved (Signed)"}),e.jsx("span",{className:"widget-row-value",children:i.approved})]}),e.jsxs("div",{className:"widget-row",children:[e.jsx("div",{className:"widget-row-icon pending",children:e.jsx(le,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"Awaiting Signatures"}),e.jsx("span",{className:"widget-row-value",children:i.awaitingSignatures})]}),e.jsxs("div",{className:"widget-row",children:[e.jsx("div",{className:"widget-row-icon awaiting",children:e.jsx(ze,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"Awaiting Certificate"}),e.jsx("span",{className:"widget-row-value",children:i.awaitingCertificate})]}),e.jsxs("div",{className:"widget-row",children:[e.jsx("div",{className:"widget-row-icon progress",children:e.jsx(Tt,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"In Progress"}),e.jsx("span",{className:"widget-row-value",children:i.inProgress})]})]})]})}function An({refreshTrigger:n}){const r=ce(),{projectId:t}=ne(),{showTestUsers:s}=Wt(),[a,i]=d.useState(!0),[o,c]=d.useState({total:0,delivered:0,reviewComplete:0,awaitingReview:0,returned:0,inProgress:0,notStarted:0}),l=d.useCallback(async()=>{if(t){i(!0);try{const f=await Tr.getAllWithRelations(t,s);let h=0,y=0,g=0,b=0,m=0,w=0;f.forEach(R=>{switch(R.status){case"Delivered":h++;break;case"Review Complete":y++;break;case"Submitted for Review":g++;break;case"Returned for More Work":b++;break;case"In Progress":m++;break;case"Not Started":default:w++;break}}),c({total:f.length,delivered:h,reviewComplete:y,awaitingReview:g,returned:b,inProgress:m,notStarted:w})}catch{}finally{i(!1)}}},[t,s]);d.useEffect(()=>{l()},[l,n]);const u=()=>{r("/deliverables")};return a?e.jsxs("div",{className:"dashboard-widget",onClick:u,children:[e.jsxs("div",{className:"widget-header",children:[e.jsx("div",{className:"widget-icon",style:{background:"rgba(34, 197, 94, 0.1)",color:"#22c55e"},children:e.jsx(tt,{size:20})}),e.jsx("span",{className:"widget-title",children:"Deliverables"})]}),e.jsx("div",{className:"widget-loading",children:"Loading..."})]}):e.jsxs("div",{className:"dashboard-widget",onClick:u,children:[e.jsxs("div",{className:"widget-header",children:[e.jsx("div",{className:"widget-icon",style:{background:"rgba(34, 197, 94, 0.1)",color:"#22c55e"},children:e.jsx(tt,{size:20})}),e.jsx("span",{className:"widget-title",children:"Deliverables"}),e.jsxs("span",{className:"widget-total",children:[o.total," Total"]})]}),e.jsxs("div",{className:"widget-breakdown",children:[e.jsxs("div",{className:"widget-row",children:[e.jsx("div",{className:"widget-row-icon approved",children:e.jsx(we,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"Delivered"}),e.jsx("span",{className:"widget-row-value",children:o.delivered})]}),e.jsxs("div",{className:"widget-row",children:[e.jsx("div",{className:"widget-row-icon",style:{background:"rgba(37, 99, 235, 0.1)",color:"#2563eb"},children:e.jsx(fs,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"Review Complete"}),e.jsx("span",{className:"widget-row-value",children:o.reviewComplete})]}),e.jsxs("div",{className:"widget-row",children:[e.jsx("div",{className:"widget-row-icon pending",children:e.jsx(le,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"Awaiting Review"}),e.jsx("span",{className:"widget-row-value",children:o.awaitingReview})]}),e.jsxs("div",{className:"widget-row",children:[e.jsx("div",{className:"widget-row-icon",style:{background:"rgba(220, 38, 38, 0.1)",color:"#dc2626"},children:e.jsx(Mt,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"Returned"}),e.jsx("span",{className:"widget-row-value",children:o.returned})]}),e.jsxs("div",{className:"widget-row",children:[e.jsx("div",{className:"widget-row-icon",style:{background:"rgba(79, 70, 229, 0.1)",color:"#4f46e5"},children:e.jsx(Se,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"In Progress"}),e.jsx("span",{className:"widget-row-value",children:o.inProgress})]}),e.jsxs("div",{className:"widget-row",children:[e.jsx("div",{className:"widget-row-icon progress",children:e.jsx(Tt,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"Not Started"}),e.jsx("span",{className:"widget-row-value",children:o.notStarted})]})]})]})}function In({refreshTrigger:n}){const r=ce(),{projectId:t}=ne(),[s,a]=d.useState(!0),[i,o]=d.useState({submittedCount:0,submittedValue:0,validatedCount:0,validatedValue:0}),c=d.useCallback(async()=>{if(t){a(!0);try{const y=(await Dr.getAll(t,{select:`
          id, hours_worked, hours, status, is_deleted,
          resources(id, sell_price)
        `})||[]).filter(R=>R.is_deleted!==!0);let g=0,b=0,m=0,w=0;y.forEach(R=>{const M=parseFloat(R.hours_worked||R.hours||0),A=R.resources?.sell_price||0,S=dt(M,A);switch(R.status){case"Submitted":g++,b+=S;break;case"Validated":case"Approved":m++,w+=S;break}}),o({submittedCount:g,submittedValue:b,validatedCount:m,validatedValue:w})}catch{}finally{a(!1)}}},[t]);d.useEffect(()=>{c()},[c,n]);const l=()=>{r("/timesheets")},u=h=>`Â£${Math.round(h).toLocaleString()}`;if(s)return e.jsxs("div",{className:"dashboard-widget",onClick:l,children:[e.jsxs("div",{className:"widget-header",children:[e.jsx("div",{className:"widget-icon",style:{background:"rgba(59, 130, 246, 0.1)",color:"#3b82f6"},children:e.jsx(le,{size:20})}),e.jsx("span",{className:"widget-title",children:"Timesheets"})]}),e.jsx("div",{className:"widget-loading",children:"Loading..."})]});const f=i.submittedCount+i.validatedCount;return e.jsxs("div",{className:"dashboard-widget",onClick:l,children:[e.jsxs("div",{className:"widget-header",children:[e.jsx("div",{className:"widget-icon",style:{background:"rgba(59, 130, 246, 0.1)",color:"#3b82f6"},children:e.jsx(le,{size:20})}),e.jsx("span",{className:"widget-title",children:"Timesheets"}),e.jsxs("span",{className:"widget-total",children:[f," Active"]})]}),e.jsxs("div",{className:"widget-breakdown",children:[e.jsxs("div",{className:"widget-row",children:[e.jsx("div",{className:"widget-row-icon pending",children:e.jsx(It,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"Submitted"}),e.jsx("span",{className:"widget-row-value",children:i.submittedCount}),e.jsx("span",{className:"widget-row-secondary",children:u(i.submittedValue)})]}),e.jsxs("div",{className:"widget-row",children:[e.jsx("div",{className:"widget-row-icon approved",children:e.jsx(we,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"Validated"}),e.jsx("span",{className:"widget-row-value",children:i.validatedCount}),e.jsx("span",{className:"widget-row-secondary",children:u(i.validatedValue)})]})]})]})}function Dn({refreshTrigger:n}){const r=ce(),{projectId:t}=ne(),[s,a]=d.useState(!0),[i,o]=d.useState({awaitingValue:0,validatedTotal:0,chargeableValue:0,nonChargeableValue:0}),c=d.useCallback(async()=>{if(t){a(!0);try{const h=(await Mr.getAll(t,{select:"id, amount, status, chargeable_to_customer, is_deleted"})||[]).filter(w=>w.is_deleted!==!0);let y=0,g=0,b=0,m=0;h.forEach(w=>{const R=parseFloat(w.amount||0);switch(w.status){case"Submitted":y+=R;break;case"Validated":case"Approved":g+=R,w.chargeable_to_customer!==!1?b+=R:m+=R;break}}),o({awaitingValue:y,validatedTotal:g,chargeableValue:b,nonChargeableValue:m})}catch{}finally{a(!1)}}},[t]);d.useEffect(()=>{c()},[c,n]);const l=()=>{r("/expenses")},u=f=>`Â£${Math.round(f).toLocaleString()}`;return s?e.jsxs("div",{className:"dashboard-widget",onClick:l,children:[e.jsxs("div",{className:"widget-header",children:[e.jsx("div",{className:"widget-icon",style:{background:"rgba(168, 85, 247, 0.1)",color:"#a855f7"},children:e.jsx(Oe,{size:20})}),e.jsx("span",{className:"widget-title",children:"Expenses"})]}),e.jsx("div",{className:"widget-loading",children:"Loading..."})]}):e.jsxs("div",{className:"dashboard-widget",onClick:l,children:[e.jsxs("div",{className:"widget-header",children:[e.jsx("div",{className:"widget-icon",style:{background:"rgba(168, 85, 247, 0.1)",color:"#a855f7"},children:e.jsx(Oe,{size:20})}),e.jsx("span",{className:"widget-title",children:"Expenses"}),e.jsxs("span",{className:"widget-total",children:[u(i.validatedTotal)," Validated"]})]}),e.jsxs("div",{className:"widget-breakdown",children:[e.jsxs("div",{className:"widget-row",children:[e.jsx("div",{className:"widget-row-icon pending",children:e.jsx(le,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"Awaiting Validation"}),e.jsx("span",{className:"widget-row-value",children:u(i.awaitingValue)})]}),e.jsxs("div",{className:"widget-row",children:[e.jsx("div",{className:"widget-row-icon approved",children:e.jsx(we,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"Validated Total"}),e.jsx("span",{className:"widget-row-value",children:u(i.validatedTotal)})]}),e.jsxs("div",{className:"widget-row",style:{paddingLeft:"1.5rem"},children:[e.jsx("div",{className:"widget-row-icon",style:{background:"rgba(34, 197, 94, 0.1)",color:"#22c55e"},children:e.jsx(gs,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"â†³ Chargeable"}),e.jsx("span",{className:"widget-row-value",children:u(i.chargeableValue)})]}),e.jsxs("div",{className:"widget-row",style:{paddingLeft:"1.5rem"},children:[e.jsx("div",{className:"widget-row-icon",style:{background:"rgba(107, 114, 128, 0.1)",color:"#6b7280"},children:e.jsx(Dt,{size:16})}),e.jsx("span",{className:"widget-row-label",children:"â†³ Non-Chargeable"}),e.jsx("span",{className:"widget-row-value",children:u(i.nonChargeableValue)})]})]})]})}function Mn(){const{user:n,role:r}=Ie(),t=n?.id||null,s=(i,o)=>P(r,i,o);return{userRole:r,currentUserId:t,can:s,hasPermission:s,PERMISSION_MATRIX:Jt,canAddTimesheet:Zt(r),canAddTimesheetForOthers:ut(r),canApproveTimesheets:Me(r),canApproveTimesheet:Me(r),canAddExpense:lt(r),canAddExpenseForOthers:er(r),canValidateChargeableExpenses:tr(r),canValidateNonChargeableExpenses:rr(r),canCreateMilestone:sr(r),canEditMilestone:ar(r),canDeleteMilestone:nr(r),canUseGantt:ir(r),canEditBilling:Ra(r),canCreateDeliverable:or(r),canEditDeliverable:lr(r),canDeleteDeliverable:cr(r),canReviewDeliverable:dr(r),canSubmitDeliverable:Pa(r),canManageKPIs:ur(r),canAddKPI:Ia(r),canEditKPI:Da(r),canDeleteKPI:Ma(r),canManageQualityStandards:hr(r),canAddQualityStandard:Ta(r),canEditQualityStandard:Oa(r),canDeleteQualityStandard:qa(r),canManageResources:mr(r),canAddResource:La(r),canEditResource:Ba(r),canDeleteResource:fr(r),canSeeCostPrice:gr(r),canSeeResourceType:za(r),canSeeMargins:pr(r),canViewPartners:yr(r),canManagePartners:xr(r),canAddPartner:$a(r),canEditPartner:Ua(r),canDeletePartner:Va(r),canSignAsSupplier:br(r),canSignAsCustomer:wr(r),canCreateCertificate:Wa(r),canAccessSettings:_r(r),canEditSettings:Fa(r),canManageUsers:vr(r),canViewUsers:Ha(r),canViewWorkflowSummary:Sr(r),canGenerateCustomerInvoice:jr(r),canGenerateThirdPartyInvoice:Cr(r),canViewMarginReports:Ka(r),canAccessReports:Ga(r),canEditTimesheet:i=>Sa(r,i,t),canDeleteTimesheet:i=>ja(r,i,t),canSubmitTimesheet:i=>Ca(r,i,t),canValidateTimesheet:i=>i.status!=="Submitted"?!1:Me(r),canSubmitExpense:i=>i.status!=="Draft"&&i.status!=="Rejected"?!1:ot(r,[x.ADMIN,x.SUPPLIER_PM])?!0:i.created_by===t&&lt(r),canValidateExpense:i=>Na(r,i),canEditExpense:i=>Ea(r,i,t),canDeleteExpense:i=>ka(r,i,t),canUpdateDeliverableStatus:i=>Aa(r,i,t),getAvailableResources:i=>Nr(r,i,t),getCurrentUserResource:i=>Qa(i,t),getDefaultResource:i=>Er(r,i,t),getDefaultResourceId:i=>Ya(r,i,t),getPermissionSummary:()=>Xa(r),getRoleConfig:()=>kr(r),getRoleLabel:()=>Rr(r),ROLES:x,ROLE_OPTIONS:_a,hasRole:i=>ot(r,i),isFullAdmin:va(r)}}function Tn({editable:n=!1,fullPage:r=!1,refreshTrigger:t}){const s=ce(),{projectId:a}=ne(),{canEditBilling:i}=Mn(),{showSuccess:o,showError:c}=Qt(),l=n&&i,[u,f]=d.useState(!0),[h,y]=d.useState([]),[g,b]=d.useState(null),[m,w]=d.useState(""),R=d.useCallback(async()=>{if(a){f(!0);try{const C=await ve.getBillableMilestones(a);y(C||[])}catch{}finally{f(!1)}}},[a]);d.useEffect(()=>{R()},[R,t]);const M=C=>{!r&&!C.target.closest("button, input, a")&&s("/billing")},A=async(C,_)=>{if(l)try{const L=!C[_];await ve.update(C.id,{[_]:L}),y(se=>se.map(oe=>oe.id===C.id?{...oe,[_]:L}:oe)),o(`${_==="is_billed"?"Billed":"Received"} status updated`)}catch{c("Failed to update status")}},S=C=>{l&&(b(C.id),w(C.purchase_order||""))},E=async C=>{try{await ve.update(C.id,{purchase_order:m}),y(_=>_.map(L=>L.id===C.id?{...L,purchase_order:m}:L)),b(null),o("PO number updated")}catch{c("Failed to update PO number")}},v=C=>new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP",minimumFractionDigits:0,maximumFractionDigits:0}).format(C),k=C=>C?new Date(C).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"}):"â€”",N=h.reduce((C,_)=>C+(_.billable||0),0),j=h.filter(C=>C.is_billed).reduce((C,_)=>C+(_.billable||0),0),D=h.filter(C=>C.is_received).reduce((C,_)=>C+(_.billable||0),0);return u?e.jsxs("div",{className:"dashboard-widget billing-widget",children:[e.jsxs("div",{className:"widget-header",children:[e.jsx("div",{className:"widget-icon",style:{backgroundColor:"#dcfce7",color:"#16a34a"},children:e.jsx(Ae,{size:20})}),e.jsx("span",{className:"widget-title",children:"Billing"})]}),e.jsx("div",{className:"widget-loading",children:"Loading..."})]}):e.jsxs("div",{className:"dashboard-widget billing-widget",style:{cursor:r?"default":"pointer"},onClick:M,children:[e.jsxs("div",{className:"widget-header",children:[e.jsx("div",{className:"widget-icon",style:{backgroundColor:"#dcfce7",color:"#16a34a"},children:e.jsx(Ae,{size:20})}),e.jsx("span",{className:"widget-title",children:"Billing"}),e.jsxs("span",{className:"widget-total",children:[v(N)," Total"]})]}),e.jsxs("div",{style:{display:"flex",gap:"1.5rem",padding:"0.75rem 1rem",backgroundColor:"#f8fafc",borderRadius:"8px",marginBottom:"0.75rem",fontSize:"0.875rem"},children:[e.jsxs("div",{children:[e.jsx("span",{style:{color:"#64748b"},children:"Billed: "}),e.jsx("span",{style:{fontWeight:"600",color:"#16a34a"},children:v(j)})]}),e.jsxs("div",{children:[e.jsx("span",{style:{color:"#64748b"},children:"Received: "}),e.jsx("span",{style:{fontWeight:"600",color:"#2563eb"},children:v(D)})]}),e.jsxs("div",{children:[e.jsx("span",{style:{color:"#64748b"},children:"Outstanding: "}),e.jsx("span",{style:{fontWeight:"600",color:"#dc2626"},children:v(N-D)})]})]}),e.jsx("div",{style:{overflowX:"auto"},children:e.jsxs("table",{style:{width:"100%",fontSize:"0.8125rem",borderCollapse:"collapse"},children:[e.jsx("thead",{children:e.jsxs("tr",{style:{borderBottom:"1px solid #e2e8f0"},children:[e.jsx("th",{style:{textAlign:"left",padding:"0.5rem 0.25rem",fontWeight:"600",color:"#64748b"},children:"Milestone"}),e.jsx("th",{style:{textAlign:"right",padding:"0.5rem 0.25rem",fontWeight:"600",color:"#64748b"},children:"Amount"}),e.jsx("th",{style:{textAlign:"center",padding:"0.5rem 0.25rem",fontWeight:"600",color:"#64748b"},children:"Expected"}),e.jsx("th",{style:{textAlign:"center",padding:"0.5rem 0.25rem",fontWeight:"600",color:"#64748b"},children:"Ready"}),e.jsx("th",{style:{textAlign:"center",padding:"0.5rem 0.25rem",fontWeight:"600",color:"#64748b"},children:"Billed"}),e.jsx("th",{style:{textAlign:"center",padding:"0.5rem 0.25rem",fontWeight:"600",color:"#64748b"},children:"Received"}),e.jsx("th",{style:{textAlign:"left",padding:"0.5rem 0.25rem",fontWeight:"600",color:"#64748b"},children:"PO Number"})]})}),e.jsx("tbody",{children:h.map(C=>e.jsxs("tr",{style:{borderBottom:"1px solid #f1f5f9",backgroundColor:C.is_received?"#f0fdf4":"transparent"},children:[e.jsxs("td",{style:{padding:"0.625rem 0.25rem"},children:[r?e.jsx(Ze,{to:`/milestones/${C.id}`,style:{textDecoration:"none"},onClick:_=>_.stopPropagation(),children:e.jsx("div",{style:{fontWeight:"500",color:"#3b82f6"},children:C.milestone_ref})}):e.jsx("div",{style:{fontWeight:"500"},children:C.milestone_ref}),e.jsx("div",{style:{fontSize:"0.75rem",color:"#64748b",maxWidth:"200px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:C.name})]}),e.jsx("td",{style:{textAlign:"right",padding:"0.625rem 0.25rem",fontWeight:"600"},children:v(C.billable)}),e.jsx("td",{style:{textAlign:"center",padding:"0.625rem 0.25rem",color:"#64748b"},children:e.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"0.25rem"},children:[e.jsx(ps,{size:12}),k(C.expected_date)]})}),e.jsx("td",{style:{textAlign:"center",padding:"0.625rem 0.25rem"},children:e.jsxs("div",{style:{display:"inline-flex",alignItems:"center",gap:"0.25rem",padding:"0.125rem 0.5rem",borderRadius:"4px",fontSize:"0.75rem",fontWeight:"600",backgroundColor:C.ready_to_bill?"#dcfce7":"#fef3c7",color:C.ready_to_bill?"#16a34a":"#d97706"},title:C.certificate_status||"No certificate",children:[e.jsx(Pe,{size:12}),C.ready_to_bill?"Yes":"No"]})}),e.jsx("td",{style:{textAlign:"center",padding:"0.625rem 0.25rem"},children:e.jsx("button",{onClick:_=>{_.stopPropagation(),A(C,"is_billed")},disabled:!l,style:{width:"28px",height:"28px",borderRadius:"6px",border:"none",cursor:l?"pointer":"default",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:C.is_billed?"#dcfce7":"#f1f5f9",color:C.is_billed?"#16a34a":"#94a3b8"},children:C.is_billed?e.jsx(Te,{size:16}):e.jsx(pe,{size:16})})}),e.jsx("td",{style:{textAlign:"center",padding:"0.625rem 0.25rem"},children:e.jsx("button",{onClick:_=>{_.stopPropagation(),A(C,"is_received")},disabled:!l,style:{width:"28px",height:"28px",borderRadius:"6px",border:"none",cursor:l?"pointer":"default",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:C.is_received?"#dbeafe":"#f1f5f9",color:C.is_received?"#2563eb":"#94a3b8"},children:C.is_received?e.jsx(Te,{size:16}):e.jsx(pe,{size:16})})}),e.jsx("td",{style:{padding:"0.625rem 0.25rem"},children:g===C.id?e.jsxs("div",{style:{display:"flex",gap:"0.25rem"},onClick:_=>_.stopPropagation(),children:[e.jsx("input",{type:"text",value:m,onChange:_=>w(_.target.value),onKeyDown:_=>_.key==="Enter"&&E(C),style:{width:"100px",padding:"0.25rem 0.5rem",fontSize:"0.75rem",border:"1px solid #e2e8f0",borderRadius:"4px"},autoFocus:!0}),e.jsx("button",{onClick:()=>E(C),style:{padding:"0.25rem 0.5rem",fontSize:"0.75rem",backgroundColor:"#16a34a",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:"Save"})]}):e.jsxs("div",{onClick:_=>{_.stopPropagation(),l&&S(C)},style:{padding:"0.25rem 0.5rem",fontSize:"0.75rem",color:C.purchase_order?"#1e293b":"#94a3b8",cursor:l?"pointer":"default",borderRadius:"4px",backgroundColor:l?"#f8fafc":"transparent",display:"flex",alignItems:"center",gap:"0.25rem"},children:[e.jsx(ze,{size:12}),C.purchase_order||(l?"Add PO":"â€”")]})})]},C.id))})]})}),h.length===0&&e.jsx("div",{style:{textAlign:"center",padding:"2rem",color:"#64748b"},children:"No billable milestones found"})]})}function On({refreshTrigger:n}){const{projectId:r}=ne(),[t,s]=d.useState(!0),[a,i]=d.useState({totalBillable:0,timesheetsPending:0,timesheetsValidated:0,timesheetsTotal:0,gap:0,expensesPendingChargeable:0,expensesPendingNonChargeable:0,expensesValidatedChargeable:0,expensesValidatedNonChargeable:0,expensesTotalPending:0,expensesTotalValidated:0,expensesTotalChargeable:0,expensesTotalNonChargeable:0,pmoTimesheets:0,pmoPercentage:0}),o=d.useCallback(async()=>{if(r){s(!0);try{const f=(await ve.getAll(r,{select:"id, billable"})||[]).reduce((j,D)=>j+(parseFloat(D.billable)||0),0),y=(await Dr.getAll(r,{select:`
          id, hours_worked, hours, status, is_deleted,
          resources(id, sell_price, role)
        `})||[]).filter(j=>j.is_deleted!==!0);let g=0,b=0,m=0;y.forEach(j=>{const D=parseFloat(j.hours_worked||j.hours||0),C=j.resources?.sell_price||0,_=dt(D,C),L=Re(j.resources?.role);switch(j.status){case"Submitted":g+=_,L&&(m+=_);break;case"Validated":case"Approved":b+=_,L&&(m+=_);break}});const w=g+b,R=f-w,M=w>0?m/w*100:0,S=(await Mr.getAll(r,{select:"id, amount, status, chargeable_to_customer, is_deleted"})||[]).filter(j=>j.is_deleted!==!0);let E=0,v=0,k=0,N=0;S.forEach(j=>{const D=parseFloat(j.amount||0),C=j.chargeable_to_customer!==!1;switch(j.status){case"Submitted":C?E+=D:v+=D;break;case"Validated":case"Approved":C?k+=D:N+=D;break}}),i({totalBillable:f,timesheetsPending:g,timesheetsValidated:b,timesheetsTotal:w,gap:R,expensesPendingChargeable:E,expensesPendingNonChargeable:v,expensesValidatedChargeable:k,expensesValidatedNonChargeable:N,expensesTotalPending:E+v,expensesTotalValidated:k+N,expensesTotalChargeable:E+k,expensesTotalNonChargeable:v+N,pmoTimesheets:m,pmoPercentage:M})}catch{}finally{s(!1)}}},[r]);d.useEffect(()=>{o()},[o,n]);const c=u=>{const h=`Â£${Math.abs(Math.round(u)).toLocaleString()}`;return u<0?`-${h}`:h};if(t)return e.jsxs("div",{className:"dashboard-widget finance-widget",children:[e.jsxs("div",{className:"widget-header",children:[e.jsx("div",{className:"widget-icon",style:{background:"rgba(16, 185, 129, 0.1)",color:"#10b981"},children:e.jsx(Ae,{size:20})}),e.jsx("span",{className:"widget-title",children:"Finance"})]}),e.jsx("div",{className:"widget-loading",children:"Loading..."})]});const l=a.gap<0;return e.jsxs("div",{className:"dashboard-widget finance-widget",children:[e.jsxs("div",{className:"widget-header",children:[e.jsx("div",{className:"widget-icon",style:{background:"rgba(16, 185, 129, 0.1)",color:"#10b981"},children:e.jsx(Ae,{size:20})}),e.jsx("span",{className:"widget-title",children:"Finance"})]}),e.jsxs("div",{className:"finance-content",children:[e.jsx("div",{className:"finance-section finance-billable",children:e.jsxs("div",{className:"finance-row finance-row-large",children:[e.jsx("span",{className:"finance-label",children:"Total Billable"}),e.jsx("span",{className:"finance-value",children:c(a.totalBillable)})]})}),e.jsxs("div",{className:"finance-section",children:[e.jsx("div",{className:"finance-section-header",children:"Timesheets"}),e.jsxs("div",{className:"finance-row",children:[e.jsx(le,{size:14,className:"finance-icon pending"}),e.jsx("span",{className:"finance-label",children:"Pending Validation"}),e.jsx("span",{className:"finance-value",children:c(a.timesheetsPending)})]}),e.jsxs("div",{className:"finance-row",children:[e.jsx(we,{size:14,className:"finance-icon approved"}),e.jsx("span",{className:"finance-label",children:"Validated"}),e.jsx("span",{className:"finance-value",children:c(a.timesheetsValidated)})]}),e.jsxs("div",{className:"finance-row finance-row-total",children:[e.jsx("span",{className:"finance-label",children:"Total"}),e.jsx("span",{className:"finance-value",children:c(a.timesheetsTotal)})]}),e.jsxs("div",{className:`finance-row finance-row-gap ${l?"negative":"positive"}`,children:[l?e.jsx(ys,{size:14,className:"finance-icon"}):e.jsx(qe,{size:14,className:"finance-icon"}),e.jsx("span",{className:"finance-label",children:"Gap vs Billable"}),e.jsx("span",{className:"finance-value",children:c(a.gap)})]})]}),e.jsxs("div",{className:"finance-section",children:[e.jsx("div",{className:"finance-section-header",children:"Expenses"}),e.jsxs("div",{className:"finance-expenses-grid",children:[e.jsx("div",{className:"finance-expenses-header"}),e.jsx("div",{className:"finance-expenses-header",children:"Chargeable"}),e.jsx("div",{className:"finance-expenses-header",children:"Non-Chg"}),e.jsx("div",{className:"finance-expenses-header",children:"Total"}),e.jsxs("div",{className:"finance-expenses-label",children:[e.jsx(le,{size:12,className:"finance-icon pending"}),"Pending"]}),e.jsx("div",{className:"finance-expenses-value",children:c(a.expensesPendingChargeable)}),e.jsx("div",{className:"finance-expenses-value",children:c(a.expensesPendingNonChargeable)}),e.jsx("div",{className:"finance-expenses-value finance-expenses-total",children:c(a.expensesTotalPending)}),e.jsxs("div",{className:"finance-expenses-label",children:[e.jsx(we,{size:12,className:"finance-icon approved"}),"Validated"]}),e.jsx("div",{className:"finance-expenses-value",children:c(a.expensesValidatedChargeable)}),e.jsx("div",{className:"finance-expenses-value",children:c(a.expensesValidatedNonChargeable)}),e.jsx("div",{className:"finance-expenses-value finance-expenses-total",children:c(a.expensesTotalValidated)}),e.jsx("div",{className:"finance-expenses-label finance-expenses-total-label",children:"Total"}),e.jsx("div",{className:"finance-expenses-value finance-expenses-total",children:c(a.expensesTotalChargeable)}),e.jsx("div",{className:"finance-expenses-value finance-expenses-total",children:c(a.expensesTotalNonChargeable)}),e.jsx("div",{className:"finance-expenses-value finance-expenses-grand-total",children:c(a.expensesTotalChargeable+a.expensesTotalNonChargeable)})]})]}),e.jsxs("div",{className:"finance-section",children:[e.jsx("div",{className:"finance-section-header",children:"PMO Overhead"}),e.jsxs("div",{className:"finance-row",children:[e.jsx("span",{className:"finance-label",children:"PMO Timesheets"}),e.jsx("span",{className:"finance-value",children:c(a.pmoTimesheets)})]}),e.jsxs("div",{className:"finance-row",children:[e.jsx("span",{className:"finance-label",children:"% of Total Timesheets"}),e.jsxs("span",{className:"finance-value",children:[a.pmoPercentage.toFixed(1),"%"]})]}),e.jsx("div",{className:"finance-pmo-bar",children:e.jsx("div",{className:"finance-pmo-bar-fill",style:{width:`${Math.min(a.pmoPercentage,100)}%`}})})]})]})]})}function qn({refreshTrigger:n}){const r=ce(),{projectId:t}=ne(),[s,a]=d.useState(!0),[i,o]=d.useState([]),c=d.useCallback(async()=>{if(t){a(!0);try{const l=await jn.getAll(t,{orderBy:{column:"kpi_ref",ascending:!0}}),{data:u}=await p.from("deliverables").select(`
          id, status, is_deleted,
          deliverable_kpis(kpi_id)
        `).eq("project_id",t).or("is_deleted.is.null,is_deleted.eq.false"),{data:f}=await p.from("deliverable_kpi_assessments").select("kpi_id, deliverable_id, criteria_met"),h={};(f||[]).forEach(g=>{const b=`${g.deliverable_id}-${g.kpi_id}`;h[b]=g.criteria_met});const y=l.map(g=>{const b=(u||[]).filter(v=>v.deliverable_kpis?.some(k=>k.kpi_id===g.id)),m=b.length,w=b.filter(v=>v.status==="Submitted for Review").length,R=b.filter(v=>v.status==="Delivered").length;let M=0,A=0;b.filter(v=>v.status==="Delivered").forEach(v=>{const k=`${v.id}-${g.id}`;h[k]===!0?M++:h[k]===!1&&A++});const S=M+A,E=S>0?Math.round(M/S*100):null;return{id:g.id,ref:g.kpi_ref,name:g.name,total:m,submitted:w,validated:R,passed:M,failed:A,passRate:E}});o(y)}catch{}finally{a(!1)}}},[t]);return d.useEffect(()=>{c()},[c,n]),s?e.jsxs("div",{className:"metrics-cards-row",children:[e.jsxs("div",{className:"metrics-cards-header",children:[e.jsx(qe,{size:18}),e.jsx("span",{children:"KPI Metrics"})]}),e.jsx("div",{className:"metrics-cards-loading",children:"Loading KPIs..."})]}):i.length===0?null:e.jsxs("div",{className:"metrics-cards-row",children:[e.jsxs("div",{className:"metrics-cards-header",children:[e.jsx(qe,{size:18}),e.jsx("span",{children:"KPI Metrics"})]}),e.jsx("div",{className:"metrics-cards-container",children:i.map(l=>e.jsxs("div",{className:"metrics-card kpi-card",onClick:()=>r(`/kpis/${l.id}`),children:[e.jsxs("div",{className:"metrics-card-header",children:[e.jsx("span",{className:"metrics-card-ref",children:l.ref}),e.jsx("span",{className:"metrics-card-name",title:l.name,children:l.name})]}),e.jsxs("div",{className:"metrics-card-stats",children:[e.jsxs("div",{className:"metrics-stat",children:[e.jsx("span",{className:"metrics-stat-value",children:l.total}),e.jsx("span",{className:"metrics-stat-label",children:"Deliverables"})]}),e.jsxs("div",{className:"metrics-stat",children:[e.jsx("span",{className:"metrics-stat-value",children:l.submitted}),e.jsx("span",{className:"metrics-stat-label",children:"Submitted"})]}),e.jsxs("div",{className:"metrics-stat",children:[e.jsx("span",{className:"metrics-stat-value",children:l.validated}),e.jsx("span",{className:"metrics-stat-label",children:"Validated"})]})]}),e.jsx("div",{className:"metrics-card-passrate",children:l.passRate!==null?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"passrate-bar",style:{background:`linear-gradient(to right, #16a34a ${l.passRate}%, #dc2626 ${l.passRate}%)`}}),e.jsxs("div",{className:"passrate-values",children:[e.jsxs("span",{className:"passrate-pass",children:[l.passed," Yes"]}),e.jsxs("span",{className:"passrate-percent",children:[l.passRate,"%"]}),e.jsxs("span",{className:"passrate-fail",children:[l.failed," No"]})]})]}):e.jsx("div",{className:"passrate-none",children:"No assessments yet"})})]},l.id))})]})}function Ln({refreshTrigger:n}){const r=ce(),{projectId:t}=ne(),[s,a]=d.useState(!0),[i,o]=d.useState([]),c=d.useCallback(async()=>{if(t){a(!0);try{const l=await Nn.getAll(t,{orderBy:{column:"qs_ref",ascending:!0}}),{data:u}=await p.from("deliverables").select(`
          id, status, is_deleted,
          deliverable_quality_standards(quality_standard_id)
        `).eq("project_id",t).or("is_deleted.is.null,is_deleted.eq.false"),{data:f}=await p.from("deliverable_qs_assessments").select("quality_standard_id, deliverable_id, criteria_met"),h={};(f||[]).forEach(g=>{const b=`${g.deliverable_id}-${g.quality_standard_id}`;h[b]=g.criteria_met});const y=l.map(g=>{const b=(u||[]).filter(v=>v.deliverable_quality_standards?.some(k=>k.quality_standard_id===g.id)),m=b.length,w=b.filter(v=>v.status==="Submitted for Review").length,R=b.filter(v=>v.status==="Delivered").length;let M=0,A=0;b.filter(v=>v.status==="Delivered").forEach(v=>{const k=`${v.id}-${g.id}`;h[k]===!0?M++:h[k]===!1&&A++});const S=M+A,E=S>0?Math.round(M/S*100):null;return{id:g.id,ref:g.qs_ref,name:g.name,total:m,submitted:w,validated:R,passed:M,failed:A,passRate:E}});o(y)}catch{}finally{a(!1)}}},[t]);return d.useEffect(()=>{c()},[c,n]),s?e.jsxs("div",{className:"metrics-cards-row",children:[e.jsxs("div",{className:"metrics-cards-header",children:[e.jsx(Pe,{size:18}),e.jsx("span",{children:"Quality Standards Metrics"})]}),e.jsx("div",{className:"metrics-cards-loading",children:"Loading Quality Standards..."})]}):i.length===0?null:e.jsxs("div",{className:"metrics-cards-row",children:[e.jsxs("div",{className:"metrics-cards-header",children:[e.jsx(Pe,{size:18}),e.jsx("span",{children:"Quality Standards Metrics"})]}),e.jsx("div",{className:"metrics-cards-container",children:i.map(l=>e.jsxs("div",{className:"metrics-card qs-card",onClick:()=>r(`/quality-standards/${l.id}`),children:[e.jsxs("div",{className:"metrics-card-header",children:[e.jsx("span",{className:"metrics-card-ref",children:l.ref}),e.jsx("span",{className:"metrics-card-name",title:l.name,children:l.name})]}),e.jsxs("div",{className:"metrics-card-stats",children:[e.jsxs("div",{className:"metrics-stat",children:[e.jsx("span",{className:"metrics-stat-value",children:l.total}),e.jsx("span",{className:"metrics-stat-label",children:"Deliverables"})]}),e.jsxs("div",{className:"metrics-stat",children:[e.jsx("span",{className:"metrics-stat-value",children:l.submitted}),e.jsx("span",{className:"metrics-stat-label",children:"Submitted"})]}),e.jsxs("div",{className:"metrics-stat",children:[e.jsx("span",{className:"metrics-stat-value",children:l.validated}),e.jsx("span",{className:"metrics-stat-label",children:"Validated"})]})]}),e.jsx("div",{className:"metrics-card-passrate",children:l.passRate!==null?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"passrate-bar",style:{background:`linear-gradient(to right, #16a34a ${l.passRate}%, #dc2626 ${l.passRate}%)`}}),e.jsxs("div",{className:"passrate-values",children:[e.jsxs("span",{className:"passrate-pass",children:[l.passed," Yes"]}),e.jsxs("span",{className:"passrate-percent",children:[l.passRate,"%"]}),e.jsxs("span",{className:"passrate-fail",children:[l.failed," No"]})]})]}):e.jsx("div",{className:"passrate-none",children:"No assessments yet"})})]},l.id))})]})}function Bn(){const{projectName:n,projectRef:r}=ne(),{user:t}=Ie(),[s,a]=d.useState(0),[i,o]=d.useState(!1),c=()=>{const u=new Date().getHours();return u<12?"Good morning":u<18?"Good afternoon":"Good evening"},l=d.useCallback(()=>{o(!0),a(u=>u+1),setTimeout(()=>o(!1),1e3)},[]);return e.jsxs("div",{className:"dashboard",children:[e.jsx("div",{className:"dashboard-header",children:e.jsxs("div",{className:"dashboard-header-content",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"dashboard-title",children:c()}),e.jsxs("p",{className:"dashboard-subtitle",children:[r," â€¢ ",n]})]}),e.jsxs("button",{className:"dashboard-refresh-btn",onClick:l,disabled:i,title:"Refresh all data",children:[e.jsx(Se,{size:18,className:i?"spinning":""}),"Refresh"]})]})}),e.jsxs("div",{className:"dashboard-content",children:[e.jsxs("div",{className:"dashboard-widgets",children:[e.jsx(Pn,{refreshTrigger:s}),e.jsx(An,{refreshTrigger:s}),e.jsx(In,{refreshTrigger:s}),e.jsx(Dn,{refreshTrigger:s})]}),e.jsx(qn,{refreshTrigger:s}),e.jsx(Ln,{refreshTrigger:s}),e.jsxs("div",{className:"dashboard-widgets-row",children:[e.jsx(Tn,{editable:!1,refreshTrigger:s}),e.jsx(On,{refreshTrigger:s})]})]})]})}const zn=d.lazy(()=>W(()=>import("./ResetPassword-DmlPSk0a.js"),__vite__mapDeps([0,1,2,3]))),$n=d.lazy(()=>W(()=>import("./Milestones-CsnlZ2gr.js"),__vite__mapDeps([4,1,5,2,6,3,7]))),Un=d.lazy(()=>W(()=>import("./MilestoneDetail-BFh9wJyM.js"),__vite__mapDeps([8,1,5,2,6,3,9]))),Vn=d.lazy(()=>W(()=>import("./Gantt-CsrW39Ay.js"),__vite__mapDeps([10,1,2,3]))),Wn=d.lazy(()=>W(()=>import("./Deliverables-DlIhZSu5.js"),__vite__mapDeps([11,1,2,3,12]))),Fn=d.lazy(()=>W(()=>import("./Resources-CO9Nucwr.js"),__vite__mapDeps([13,1,5,2,3,14]))),Hn=d.lazy(()=>W(()=>import("./ResourceDetail-BZ9IQbdE.js"),__vite__mapDeps([15,1,16,2,3]))),Kn=d.lazy(()=>W(()=>import("./Partners-Opsvkhg4.js"),__vite__mapDeps([17,1,2,3,18]))),Gn=d.lazy(()=>W(()=>import("./PartnerDetail-DLokerqy.js"),__vite__mapDeps([19,1,16,2,3]))),Qn=d.lazy(()=>W(()=>import("./Timesheets-DnV__q2W.js"),__vite__mapDeps([20,1,5,2,3,21]))),Yn=d.lazy(()=>W(()=>import("./Expenses-ottkEgAW.js"),__vite__mapDeps([22,1,5,2,3,23]))),Xn=d.lazy(()=>W(()=>import("./KPIs-BYTMBmD9.js"),__vite__mapDeps([24,1,5,2,3,25]))),Jn=d.lazy(()=>W(()=>import("./KPIDetail-hjDrx-eY.js"),__vite__mapDeps([26,1,2,3]))),Zn=d.lazy(()=>W(()=>import("./QualityStandards-CcSOOW6h.js"),__vite__mapDeps([27,1,5,2,3,28]))),ei=d.lazy(()=>W(()=>import("./QualityStandardDetail-CKndWTa8.js"),__vite__mapDeps([29,1,2,3]))),ti=d.lazy(()=>W(()=>import("./RaidLog-CQvPUyZt.js"),__vite__mapDeps([30,1,5,2,3,31]))),ri=d.lazy(()=>W(()=>import("./Reports-Bs0DAaV-.js"),__vite__mapDeps([32,2,1,3]))),si=d.lazy(()=>W(()=>import("./Billing-CfTiYJcE.js"),__vite__mapDeps([33,1,34,2,3]))),ai=d.lazy(()=>W(()=>import("./Users-CDLU5cj8.js"),__vite__mapDeps([35,1,2,3,36]))),ni=d.lazy(()=>W(()=>import("./Settings-BqaQwEqk.js"),__vite__mapDeps([37,1,34,2,3]))),ii=d.lazy(()=>W(()=>import("./AccountSettings-DrZL_L1c.js"),__vite__mapDeps([38,1,34,2,3]))),oi=d.lazy(()=>W(()=>import("./WorkflowSummary-Djd7fDaY.js"),__vite__mapDeps([39,1,16,34,2,3]))),li=d.lazy(()=>W(()=>import("./AuditLog-OVqY_VpL.js"),__vite__mapDeps([40,1,34,2,3]))),ci=d.lazy(()=>W(()=>import("./DeletedItems-DwdLjiBE.js"),__vite__mapDeps([41,1,34,5,2,3])));function di(){return e.jsx("div",{className:"page-container",children:e.jsx(ke,{type:"page"})})}function V({children:n}){const{user:r,isLoading:t}=Ie();return t?e.jsx(Kt,{message:"Loading...",size:"large",fullPage:!0}):r?e.jsx(nn,{children:e.jsx(d.Suspense,{fallback:e.jsx(di,{}),children:n||e.jsx(Vr,{})})}):e.jsx(et,{to:"/login",replace:!0})}function ui(){return e.jsx($r,{children:e.jsx(na,{children:e.jsx(ha,{children:e.jsx(Qs,{children:e.jsx(Ys,{children:e.jsx(Xs,{children:e.jsx(pa,{children:e.jsx(Zs,{children:e.jsxs(sa,{children:[e.jsxs(Ur,{children:[e.jsx(z,{path:"/login",element:e.jsx(on,{})}),e.jsx(z,{path:"/reset-password",element:e.jsx(d.Suspense,{fallback:e.jsx(Kt,{fullPage:!0}),children:e.jsx(zn,{})})}),e.jsx(z,{path:"/",element:e.jsx(et,{to:"/dashboard",replace:!0})}),e.jsx(z,{path:"/dashboard",element:e.jsx(V,{children:e.jsx(Bn,{})})}),e.jsx(z,{path:"/milestones",element:e.jsx(V,{children:e.jsx($n,{})})}),e.jsx(z,{path:"/milestones/:id",element:e.jsx(V,{children:e.jsx(Un,{})})}),e.jsx(z,{path:"/gantt",element:e.jsx(V,{children:e.jsx(Vn,{})})}),e.jsx(z,{path:"/deliverables",element:e.jsx(V,{children:e.jsx(Wn,{})})}),e.jsx(z,{path:"/resources",element:e.jsx(V,{children:e.jsx(Fn,{})})}),e.jsx(z,{path:"/resources/:id",element:e.jsx(V,{children:e.jsx(Hn,{})})}),e.jsx(z,{path:"/partners",element:e.jsx(V,{children:e.jsx(Kn,{})})}),e.jsx(z,{path:"/partners/:id",element:e.jsx(V,{children:e.jsx(Gn,{})})}),e.jsx(z,{path:"/timesheets",element:e.jsx(V,{children:e.jsx(Qn,{})})}),e.jsx(z,{path:"/expenses",element:e.jsx(V,{children:e.jsx(Yn,{})})}),e.jsx(z,{path:"/kpis",element:e.jsx(V,{children:e.jsx(Xn,{})})}),e.jsx(z,{path:"/kpis/:id",element:e.jsx(V,{children:e.jsx(Jn,{})})}),e.jsx(z,{path:"/quality-standards",element:e.jsx(V,{children:e.jsx(Zn,{})})}),e.jsx(z,{path:"/quality-standards/:id",element:e.jsx(V,{children:e.jsx(ei,{})})}),e.jsx(z,{path:"/raid",element:e.jsx(V,{children:e.jsx(ti,{})})}),e.jsx(z,{path:"/reports",element:e.jsx(V,{children:e.jsx(ri,{})})}),e.jsx(z,{path:"/billing",element:e.jsx(V,{children:e.jsx(si,{})})}),e.jsx(z,{path:"/users",element:e.jsx(V,{children:e.jsx(ai,{})})}),e.jsx(z,{path:"/settings",element:e.jsx(V,{children:e.jsx(ni,{})})}),e.jsx(z,{path:"/account",element:e.jsx(V,{children:e.jsx(ii,{})})}),e.jsx(z,{path:"/workflow-summary",element:e.jsx(V,{children:e.jsx(oi,{})})}),e.jsx(z,{path:"/audit-log",element:e.jsx(V,{children:e.jsx(li,{})})}),e.jsx(z,{path:"/deleted-items",element:e.jsx(V,{children:e.jsx(ci,{})})}),e.jsx(z,{path:"*",element:e.jsx(et,{to:"/dashboard",replace:!0})})]}),e.jsx(ya,{}),e.jsx(Ts,{}),e.jsx(Ws,{})]})})})})})})})})})}st.createRoot(document.getElementById("root")).render(e.jsx(Rt.StrictMode,{children:e.jsx(ui,{})}));export{Tn as B,Kt as L,X as V,ne as a,Qt as b,Mn as c,Tr as d,Wt as e,pi as f,_t as g,je as h,Mr as i,e as j,jn as k,jt as l,ve as m,bi as n,dt as o,yi as p,Nn as q,xi as r,p as s,Dr as t,Ie as u,wi as v};
