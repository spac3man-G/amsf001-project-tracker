const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ResetPassword-CdBU1SJh.js","assets/vendor-react-JFEV0ROX.js","assets/vendor-icons-BZZethZ5.js","assets/vendor-supabase-DgEUAXvv.js","assets/Milestones-CGCxJKkh.js","assets/usePermissions-R5xloTk0.js","assets/StatCard-tq6sJKiO.js","assets/PageHeader-M8U7kzer.js","assets/ConfirmDialog-fKyY4CL7.js","assets/MilestoneDetail-ssUMKHn7.js","assets/Gantt-B3kSsT83.js","assets/Deliverables-Onh9cwqN.js","assets/Resources-ZmdLJvMq.js","assets/ResourceDetail-DRRp9WXV.js","assets/Partners-BRJN0d28.js","assets/PartnerDetail-Cpd9LN68.js","assets/Timesheets-Bfc3Z6r2.js","assets/Expenses-D2y62zcy.js","assets/Expenses-OWLTi329.css","assets/KPIs-BG_sFrqm.js","assets/KPIDetail-ChJwcBu9.js","assets/QualityStandards-C_LGsVj2.js","assets/QualityStandardDetail-C57KQdg_.js","assets/Reports-B7kl1Ax3.js","assets/Users-D2N1w36E.js","assets/Settings-BuJpAY47.js","assets/AccountSettings-45PUGSdf.js","assets/WorkflowSummary-BKZhDxGI.js","assets/AuditLog-BARhvGhb.js","assets/DeletedItems-BnPkjVxW.js"])))=>i.map(i=>d[i]);
var jt=Object.defineProperty;var Nt=(i,r,t)=>r in i?jt(i,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[r]=t;var we=(i,r,t)=>Nt(i,typeof r!="symbol"?r+"":r,t);import{r as d,a as Ct,R as tt,u as Oe,b as kt,L as Q,c as Et,B as Rt,d as Pt,e as O,N as Pe,O as It}from"./vendor-react-JFEV0ROX.js";import{c as At}from"./vendor-supabase-DgEUAXvv.js";import{A as rt,R as ue,I as Mt,X as st,C as Dt,a as ne,M as Tt,S as qt,B as Se,D as Ot,T as Lt,U as zt,b as Bt,c as at,d as Ut,L as $t,e as Wt,f as Ie,g as je,h as Ft,i as he,F as nt,j as it,k as le,l as Vt,H as Ht,m as Kt,n as Gt,o as Qt,p as Yt,q as Ae,P as Me,r as Xt,G as Jt,s as Zt,t as er,u as tr,v as rr,w as sr,x as ar,K as nr,y as Ne,z as Ce,E as $e,J as ir,N as or,O as lr}from"./vendor-icons-BZZethZ5.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerPolicy&&(n.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?n.credentials="include":a.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(a){if(a.ep)return;a.ep=!0;const n=t(a);fetch(a.href,n)}})();var ot={exports:{}},ge={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var cr=d,dr=Symbol.for("react.element"),ur=Symbol.for("react.fragment"),hr=Object.prototype.hasOwnProperty,mr=cr.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,fr={key:!0,ref:!0,__self:!0,__source:!0};function lt(i,r,t){var s,a={},n=null,o=null;t!==void 0&&(n=""+t),r.key!==void 0&&(n=""+r.key),r.ref!==void 0&&(o=r.ref);for(s in r)hr.call(r,s)&&!fr.hasOwnProperty(s)&&(a[s]=r[s]);if(i&&i.defaultProps)for(s in r=i.defaultProps,r)a[s]===void 0&&(a[s]=r[s]);return{$$typeof:dr,type:i,key:n,ref:o,props:a,_owner:mr.current}}ge.Fragment=ur;ge.jsx=lt;ge.jsxs=lt;ot.exports=ge;var e=ot.exports,De={},We=Ct;De.createRoot=We.createRoot,De.hydrateRoot=We.hydrateRoot;const pr="modulepreload",gr=function(i){return"/"+i},Fe={},B=function(r,t,s){let a=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),c=o?.nonce||o?.getAttribute("nonce");a=Promise.allSettled(t.map(l=>{if(l=gr(l),l in Fe)return;Fe[l]=!0;const h=l.endsWith(".css"),f=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${f}`))return;const g=document.createElement("link");if(g.rel=h?"stylesheet":pr,h||(g.as="script"),g.crossOrigin="",g.href=l,c&&g.setAttribute("nonce",c),document.head.appendChild(g),h)return new Promise((p,b)=>{g.addEventListener("load",p),g.addEventListener("error",()=>b(new Error(`Unable to preload CSS for ${l}`)))})}))}function n(o){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=o,window.dispatchEvent(c),!c.defaultPrevented)throw o}return a.then(o=>{for(const c of o||[])c.status==="rejected"&&n(c.reason);return r().catch(n)})};var Ve={},yr="@vercel/analytics",xr="1.6.0",br=()=>{window.va||(window.va=function(...r){(window.vaq=window.vaq||[]).push(r)})};function ct(){return typeof window<"u"}function dt(){try{const i="production"}catch{}return"production"}function _r(i="auto"){if(i==="auto"){window.vam=dt();return}window.vam=i}function vr(){return(ct()?window.vam:dt())||"production"}function Te(){return vr()==="development"}function wr(i){return i.scriptSrc?i.scriptSrc:Te()?"https://va.vercel-scripts.com/v1/script.debug.js":i.basePath?`${i.basePath}/insights/script.js`:"/_vercel/insights/script.js"}function Sr(i={debug:!0}){var r;if(!ct())return;_r(i.mode),br(),i.beforeSend&&((r=window.va)==null||r.call(window,"beforeSend",i.beforeSend));const t=wr(i);if(document.head.querySelector(`script[src*="${t}"]`))return;const s=document.createElement("script");s.src=t,s.defer=!0,s.dataset.sdkn=yr+(i.framework?`/${i.framework}`:""),s.dataset.sdkv=xr,i.disableAutoTrack&&(s.dataset.disableAutoTrack="1"),i.endpoint?s.dataset.endpoint=i.endpoint:i.basePath&&(s.dataset.endpoint=`${i.basePath}/insights`),i.dsn&&(s.dataset.dsn=i.dsn),s.onerror=()=>{const a=Te()?"Please check if any ad blockers are enabled and try again.":"Be sure to enable Web Analytics for your project and deploy again. See https://vercel.com/docs/analytics/quickstart for more information."},Te()&&i.debug===!1&&(s.dataset.debug="false"),document.head.appendChild(s)}function jr({route:i,path:r}){var t;(t=window.va)==null||t.call(window,"pageview",{route:i,path:r})}function Nr(){if(!(typeof process>"u"||typeof Ve>"u"))return Ve.REACT_APP_VERCEL_OBSERVABILITY_BASEPATH}function Cr(i){return d.useEffect(()=>{var r;i.beforeSend&&((r=window.va)==null||r.call(window,"beforeSend",i.beforeSend))},[i.beforeSend]),d.useEffect(()=>{Sr({framework:i.framework||"react",basePath:i.basePath??Nr(),...i.route!==void 0&&{disableAutoTrack:!0},...i})},[]),d.useEffect(()=>{i.route&&i.path&&jr({route:i.route,path:i.path})},[i.route,i.path]),null}var He={},kr="@vercel/speed-insights",Er="1.2.0",Rr=()=>{window.si||(window.si=function(...r){(window.siq=window.siq||[]).push(r)})};function Pr(){return typeof window<"u"}function Ir(){try{const i="production"}catch{}return"production"}function ut(){return Ir()==="development"}function Ar(i){return i.scriptSrc?i.scriptSrc:ut()?"https://va.vercel-scripts.com/v1/speed-insights/script.debug.js":i.dsn?"https://va.vercel-scripts.com/v1/speed-insights/script.js":i.basePath?`${i.basePath}/speed-insights/script.js`:"/_vercel/speed-insights/script.js"}function Mr(i={}){var r;if(!Pr()||i.route===null)return null;Rr();const t=Ar(i);if(document.head.querySelector(`script[src*="${t}"]`))return null;i.beforeSend&&((r=window.si)==null||r.call(window,"beforeSend",i.beforeSend));const s=document.createElement("script");return s.src=t,s.defer=!0,s.dataset.sdkn=kr+(i.framework?`/${i.framework}`:""),s.dataset.sdkv=Er,i.sampleRate&&(s.dataset.sampleRate=i.sampleRate.toString()),i.route&&(s.dataset.route=i.route),i.endpoint?s.dataset.endpoint=i.endpoint:i.basePath&&(s.dataset.endpoint=`${i.basePath}/speed-insights/vitals`),i.dsn&&(s.dataset.dsn=i.dsn),ut()&&i.debug===!1&&(s.dataset.debug="false"),s.onerror=()=>{},document.head.appendChild(s),{setRoute:a=>{s.dataset.route=a??void 0}}}function Dr(){if(!(typeof process>"u"||typeof He>"u"))return He.REACT_APP_VERCEL_OBSERVABILITY_BASEPATH}function Tr(i){d.useEffect(()=>{var t;i.beforeSend&&((t=window.si)==null||t.call(window,"beforeSend",i.beforeSend))},[i.beforeSend]);const r=d.useRef(null);return d.useEffect(()=>{if(r.current)i.route&&r.current(i.route);else{const t=Mr({framework:i.framework??"react",basePath:i.basePath??Dr(),...i});t&&(r.current=t.setRoute)}},[i.route]),null}const qr=void 0,Or=void 0;throw new Error("Missing Supabase environment variables");const m=At(qr,Or),ht=d.createContext(null),Lr=60*1e3,zr=5*60*1e3;function Br({children:i}){const[r,t]=d.useState(null),[s,a]=d.useState(null),[n,o]=d.useState(null),[c,l]=d.useState(!0),[h,f]=d.useState(null),[g,p]=d.useState(!1),b=d.useRef(null),_=d.useRef(Date.now()),u=d.useCallback(()=>{_.current=Date.now()},[]);async function j(y){if(!y){a(null),o(null);return}try{const{data:v,error:A}=await m.from("profiles").select("*").eq("id",y.id).single();if(A){f(A);return}a(v);const{data:M}=await m.from("resources").select("*").eq("user_id",y.id).maybeSingle();o(M),f(null)}catch(v){f(v)}}const R=d.useCallback(async()=>{try{const{data:{session:y},error:v}=await m.auth.getSession();if(v)return;if(!y){await q();return}const A=y.expires_at*1e3,M=Date.now(),I=A-M;if(I<=0)await q();else if(I<=zr){p(!0);const{data:U,error:X}=await m.auth.refreshSession();X||!U.session||p(!1)}else p(!1)}catch{}},[]);async function q(){t(null),a(null),o(null),p(!1),await m.auth.signOut();const y=window.location.pathname;y!=="/login"&&y!=="/register"&&(window.location.href="/login?expired=true")}const P=d.useCallback(()=>{b.current&&clearInterval(b.current),b.current=setInterval(()=>{R()},Lr);const y=()=>{document.visibilityState==="visible"&&R()};document.addEventListener("visibilitychange",y);const v=["mousedown","keydown","touchstart","scroll"];return v.forEach(A=>{document.addEventListener(A,u,{passive:!0})}),()=>{b.current&&clearInterval(b.current),document.removeEventListener("visibilitychange",y),v.forEach(A=>{document.removeEventListener(A,u)})}},[R,u]);d.useEffect(()=>{let y=!0,v=null;async function A(){try{const{data:{session:I},error:U}=await m.auth.getSession();U&&y&&f(U),y&&(t(I?.user??null),l(!1),I?.user&&(j(I.user),v=P()))}catch(I){y&&(f(I),l(!1))}}A();const{data:{subscription:M}}=m.auth.onAuthStateChange(async(I,U)=>{y&&(t(U?.user??null),l(!1),U?.user?(j(U.user),v&&v(),v=P()):(a(null),o(null),v&&(v(),v=null)),(I==="SIGNED_OUT"||I==="TOKEN_REFRESHED")&&p(!1))});return()=>{y=!1,M.unsubscribe(),v&&v()}},[P]);async function w(){try{await m.auth.signOut(),t(null),a(null),o(null),p(!1)}catch(y){f(y)}}async function N(){r&&await j(r)}async function k(){try{const{data:y,error:v}=await m.auth.refreshSession();return v?!1:y.session?(p(!1),!0):!1}catch{return!1}}const C={user:r,profile:s,role:s?.role||"viewer",linkedResource:n,isLoading:c,error:h,signOut:w,refreshUserData:N,refreshSession:k,isAuthenticated:!!r,sessionExpiring:g};return e.jsx(ht.Provider,{value:C,children:i})}function ye(){const i=d.useContext(ht);if(!i)throw new Error("useAuth must be used within an AuthProvider");return i}const mt=d.createContext(null);function Ur({children:i}){const[r,t]=d.useState(null),[s,a]=d.useState(!0),[n,o]=d.useState(null);d.useEffect(()=>{let f=!0;async function g(){try{const{data:p,error:b}=await m.from("projects").select("*").eq("reference","AMSF001").single();b?f&&o(b):f&&(t(p),o(null))}catch(p){f&&o(p)}finally{f&&a(!1)}}return g(),()=>{f=!1}},[]);async function c(f){a(!0),o(null);try{const{data:g,error:p}=await m.from("projects").select("*").eq("reference",f).single();p?o(p):t(g)}catch(g){o(g)}finally{a(!1)}}async function l(){if(r)try{const{data:f,error:g}=await m.from("projects").select("*").eq("id",r.id).single();g?o(g):t(f)}catch(f){o(f)}}const h={currentProject:r,projectId:r?.id||null,projectRef:r?.reference||null,projectName:r?.name||null,isLoading:s,error:n,switchProject:c,refreshProject:l};return e.jsx(mt.Provider,{value:h,children:i})}function Le(){const i=d.useContext(mt);if(!i)throw new Error("useProject must be used within a ProjectProvider");return i}const ft=d.createContext();function $r({children:i}){const[r,t]=d.useState(!1),[s,a]=d.useState(null),[n,o]=d.useState([]);d.useEffect(()=>{c(),l()},[]);async function c(){const{data:{user:u}}=await m.auth.getUser();if(u){const{data:j}=await m.from("profiles").select("role").eq("id",u.id).single();j&&a(j.role)}}async function l(){const{data:u}=await m.from("profiles").select("id").eq("is_test_user",!0);u&&o(u.map(j=>j.id))}const h=s==="admin"||s==="supplier_pm";function f(){h&&t(u=>!u)}function g(u){return n.includes(u)}function p(u,j="user_id"){return!u||r?u:u.filter(R=>!n.includes(R[j]))}function b(u){return!u||r?u:u.filter(j=>!j.is_test_content)}const _={showTestUsers:r,setShowTestUsers:t,toggleTestUsers:f,canToggleTestUsers:h,testUserIds:n,isTestUser:g,filterTestContent:p,filterByTestFlag:b,userRole:s};return e.jsx(ft.Provider,{value:_,children:i})}function pt(){const i=d.useContext(ft);if(!i)throw new Error("useTestUsers must be used within a TestUserProvider");return i}const gt=d.createContext();function Wr(){return d.useContext(gt)}function Fr({children:i}){const[r,t]=d.useState([]),[s,a]=d.useState(0),[n,o]=d.useState(0),[c,l]=d.useState(!0),[h,f]=d.useState(null),[g,p]=d.useState(null),b=N=>["admin","supplier_pm","customer_pm"].includes(N),_=d.useCallback(async(N,k)=>{try{let C=[];if(b(k)){const{data:y}=await m.from("timesheets").select("id, hours_worked, hours, work_date, date").eq("status","Submitted"),{data:v}=await m.from("expenses").select("id, amount, category, reason, resource_name, chargeable_to_customer").eq("status","Submitted"),{data:A}=await m.from("deliverables").select("id, name, deliverable_ref").eq("status","Submitted"),{data:M}=await m.from("milestone_certificates").select("id, milestone_id").eq("status","Submitted");y&&y.forEach(I=>{C.push({id:`ts-${I.id}`,type:"timesheet",notification_type:"action",title:"Timesheet Submitted",message:`Timesheet (${I.hours_worked||I.hours||0}h) pending approval`,action_url:"/timesheets",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1})}),v&&v.forEach(I=>{const U=I.chargeable_to_customer!==!1;C.push({id:`exp-${I.id}`,type:"expense",notification_type:"action",title:"Expense Submitted",message:`${I.resource_name||"Unknown"} expense (Â£${parseFloat(I.amount||0).toFixed(2)}) pending validation`,action_url:"/expenses",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1,isChargeable:U})}),A&&A.forEach(I=>{C.push({id:`del-${I.id}`,type:"deliverable",notification_type:"action",title:"Deliverable Submitted",message:`${I.deliverable_ref}: ${I.name} pending review`,action_url:"/deliverables",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1})}),M&&M.forEach(I=>{C.push({id:`cert-${I.id}`,type:"certificate",notification_type:"action",title:"Certificate Submitted",message:"Milestone certificate pending approval",action_url:"/milestones",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1})})}else{const{data:y}=await m.from("timesheets").select("id, hours_worked, hours, work_date, date, resource_id").eq("status","Submitted").eq("user_id",N),{data:v}=await m.from("expenses").select("id, amount, category, reason, resource_name").eq("status","Submitted").eq("created_by",N);y&&y.forEach(A=>{C.push({id:`ts-${A.id}`,type:"timesheet",notification_type:"action",title:"Timesheet Submitted",message:`Your timesheet for ${A.hours_worked||A.hours||0}h is pending approval`,action_url:"/timesheets",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1})}),v&&v.forEach(A=>{C.push({id:`exp-${A.id}`,type:"expense",notification_type:"action",title:"Expense Submitted",message:`Your expense (Â£${parseFloat(A.amount||0).toFixed(2)}) is pending validation`,action_url:"/expenses",created_at:new Date().toISOString(),is_read:!1,is_actioned:!1})})}return{count:C.length,items:C}}catch{return{count:0,items:[]}}},[]),u=d.useCallback(async()=>{try{const{data:{user:N}}=await m.auth.getUser();if(!N){t([]),a(0),o(0),l(!1);return}f(N.id);const{data:k}=await m.from("profiles").select("role").eq("id",N.id).single(),C=k?.role||"viewer";p(C);const{count:y,items:v}=await _(N.id,C);t(v),a(y),o(y)}catch{}finally{l(!1)}},[_]),j=d.useCallback(async N=>{t(k=>k.map(C=>C.id===N?{...C,is_read:!0}:C)),a(k=>Math.max(0,k-1))},[]),R=d.useCallback(async N=>{t(k=>k.map(C=>C.id===N?{...C,is_actioned:!0,is_read:!0}:C)),a(k=>Math.max(0,k-1)),o(k=>Math.max(0,k-1))},[]),q=d.useCallback(async()=>{t(N=>N.map(k=>({...k,is_read:!0}))),a(0)},[]),P=d.useCallback(async N=>{const k=r.find(C=>C.id===N);k&&(t(C=>C.filter(y=>y.id!==N)),k.is_read||a(C=>Math.max(0,C-1)),k.notification_type==="action"&&!k.is_actioned&&o(C=>Math.max(0,C-1)))},[r]);d.useEffect(()=>{u();const N=setInterval(()=>{u()},3e4);return()=>clearInterval(N)},[u]),d.useEffect(()=>{const{data:{subscription:N}}=m.auth.onAuthStateChange((k,C)=>{k==="SIGNED_IN"?u():k==="SIGNED_OUT"&&(t([]),a(0),o(0),f(null),p(null))});return()=>N.unsubscribe()},[u]);const w={notifications:r,unreadCount:s,actionCount:n,loading:c,fetchNotifications:u,markAsRead:j,markAsActioned:R,markAllAsRead:q,dismissNotification:P};return e.jsx(gt.Provider,{value:w,children:i})}const yt=d.createContext(null),ze="amsf-chat-history",Vr=50,ke={maxRetries:2,baseDelayMs:1e3,retryableCodes:[429,503,504]};function Hr(){try{const i=localStorage.getItem(ze);if(i){const r=JSON.parse(i);return{messages:r.messages||[],tokenUsage:r.tokenUsage||{input:0,output:0,requests:0}}}}catch{}return{messages:[],tokenUsage:{input:0,output:0,requests:0}}}function Kr(i,r){try{const t=i.slice(-Vr);localStorage.setItem(ze,JSON.stringify({messages:t,tokenUsage:r,savedAt:new Date().toISOString()}))}catch{}}function Gr({children:i}){const{user:r,profile:t,linkedResource:s,role:a}=ye(),{projectId:n,projectName:o,projectRef:c,currentProject:l}=Le(),h=Hr(),[f,g]=d.useState(!1),[p,b]=d.useState(h.messages),[_,u]=d.useState(!1),[j,R]=d.useState(null),[q,P]=d.useState(0),[w,N]=d.useState(h.tokenUsage),k=d.useRef(null);d.useEffect(()=>{(p.length>0||w.requests>0)&&Kr(p,w)},[p,w]);const C=d.useCallback(()=>l?{id:n,reference:c||l?.reference,name:o||l?.name,description:l?.description||null}:null,[l,n,c,o]),y=d.useCallback(()=>({name:t?.full_name||r?.email?.split("@")[0]||"User",email:r?.email,role:a||t?.role||"unknown",linkedResourceName:s?.name||null,linkedResourceId:s?.id||null,partnerId:s?.partner_id||null,partnerName:s?.partners?.name||null}),[r,t,s,a]),v=async(W,F=1)=>{k.current=new AbortController;try{const D=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(W),signal:k.current.signal}),S=await D.json().catch(()=>({}));if(!D.ok){if(ke.retryableCodes.includes(D.status)&&F<=ke.maxRetries&&S.recoverable!==!1){const K=S.retryAfter?S.retryAfter*1e3:ke.baseDelayMs*Math.pow(2,F-1);return P(F),await new Promise(V=>setTimeout(V,K)),v(W,F+1)}throw new Error(S.error||`Request failed (${D.status})`)}return P(0),S}catch(D){throw D.name==="AbortError"?new Error("Request cancelled"):D}},A=d.useCallback(async W=>{if(!W.trim()||_)return;k.current&&k.current.abort();const F={role:"user",content:W.trim(),timestamp:new Date().toISOString()};b(D=>[...D,F]),u(!0),R(null),P(0);try{const D=C(),S=y(),L=[...p.slice(-9),F].map(V=>({role:V.role,content:V.content})),K=await v({messages:L,projectContext:D,userContext:S,projectId:n});K.usage&&N(V=>({input:V.input+(K.usage.input_tokens||0),output:V.output+(K.usage.output_tokens||0),requests:V.requests+1})),b(V=>[...V,{role:"assistant",content:K.message,toolsUsed:K.toolsUsed||!1,cached:K.cached||!1,timestamp:new Date().toISOString(),tokens:K.usage?{input:K.usage.input_tokens,output:K.usage.output_tokens}:null}])}catch(D){let S=D.message;D.message==="Request cancelled"?S=null:D.message.includes("Failed to fetch")&&(S="Unable to connect. Please check your internet connection."),S&&(R(S),b(L=>L.slice(0,-1)))}finally{u(!1),P(0)}},[p,_,C,y,n]),M=d.useCallback(()=>{k.current&&(k.current.abort(),u(!1),P(0))},[]),I=d.useCallback(()=>{M(),b([]),R(null),localStorage.removeItem(ze)},[M]),U=d.useCallback(()=>{I(),N({input:0,output:0,requests:0})},[I]),X=d.useCallback(()=>{g(W=>!W)},[]),ae=d.useCallback(()=>{R(null)},[]),E=d.useCallback(()=>{if(p.length===0)return null;const W=y(),F=C();let D=`# Chat Export

`;return D+=`**Exported:** ${new Date().toLocaleString("en-GB")}
`,D+=`**User:** ${W.name} (${W.role})
`,F&&(D+=`**Project:** ${F.name} (${F.reference})
`),D+=`**Messages:** ${p.length}
`,D+=`**Token Usage:** ${w.input.toLocaleString()} input / ${w.output.toLocaleString()} output

`,D+=`---

`,p.forEach((S,L)=>{const K=S.role==="user"?"ðŸ‘¤ You":"ðŸ¤– Assistant",V=S.timestamp?new Date(S.timestamp).toLocaleTimeString("en-GB"):"";D+=`### ${K}${V?` (${V})`:""}

`,D+=`${S.content}

`,S.toolsUsed&&(D+=`*ðŸ“Š Queried project data*

`),L<p.length-1&&(D+=`---

`)}),D},[p,w,y,C]),$=d.useCallback(()=>{const W=E();if(!W)return;const F=new Blob([W],{type:"text/markdown"}),D=URL.createObjectURL(F),S=document.createElement("a");S.href=D,S.download=`chat-export-${new Date().toISOString().split("T")[0]}.md`,document.body.appendChild(S),S.click(),document.body.removeChild(S),URL.revokeObjectURL(D)},[E]),ee=d.useCallback(async W=>{try{return await navigator.clipboard.writeText(W),!0}catch{return!1}},[]),Z={isOpen:f,setIsOpen:g,toggleChat:X,messages:p,isLoading:_,error:j,retryCount:q,tokenUsage:w,sendMessage:A,clearChat:I,resetAllStats:U,cancelRequest:M,dismissError:ae,exportChat:E,downloadChat:$,copyMessage:ee};return e.jsx(yt.Provider,{value:Z,children:i})}function Qr(){const i=d.useContext(yt);if(!i)throw new Error("useChat must be used within a ChatProvider");return i}class Yr extends tt.Component{constructor(t){super(t);we(this,"handleReload",()=>{window.location.reload()});we(this,"handleReset",()=>{this.setState({hasError:!1,error:null,errorInfo:null})});this.state={hasError:!1,error:null,errorInfo:null}}static getDerivedStateFromError(t){return{hasError:!0,error:t}}componentDidCatch(t,s){this.setState({errorInfo:s})}render(){return this.state.hasError?this.props.fallback?this.props.fallback:e.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"3rem",backgroundColor:"#fef2f2",borderRadius:"12px",margin:"1rem",border:"1px solid #fecaca"},children:[e.jsx(rt,{size:48,style:{color:"#dc2626",marginBottom:"1rem"}}),e.jsx("h2",{style:{color:"#991b1b",margin:"0 0 0.5rem 0",fontSize:"1.25rem",fontWeight:"600"},children:"Something went wrong"}),e.jsx("p",{style:{color:"#64748b",margin:"0 0 1.5rem 0",textAlign:"center",maxWidth:"400px"},children:this.state.error?.message||"An unexpected error occurred. Please try again."}),e.jsxs("div",{style:{display:"flex",gap:"0.75rem"},children:[e.jsx("button",{onClick:this.handleReset,style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.625rem 1.25rem",backgroundColor:"white",color:"#374151",border:"1px solid #d1d5db",borderRadius:"8px",cursor:"pointer",fontSize:"0.875rem",fontWeight:"500"},children:"Try Again"}),e.jsxs("button",{onClick:this.handleReload,style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.625rem 1.25rem",backgroundColor:"#3b82f6",color:"white",border:"none",borderRadius:"8px",cursor:"pointer",fontSize:"0.875rem",fontWeight:"500"},children:[e.jsx(ue,{size:16}),"Reload Page"]})]})]}):this.props.children}}function me({message:i,size:r="medium",fullPage:t=!1,className:s=""}){const a={small:"spinner-sm",medium:"",large:"spinner-lg"};return e.jsxs("div",{className:`loading-spinner ${s}`,style:t?{minHeight:"60vh"}:void 0,children:[e.jsx("div",{className:`spinner ${a[r]}`}),i&&e.jsx("p",{className:"loading-text",children:i})]})}const Xr={background:"linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%)",backgroundSize:"200% 100%",animation:"shimmer 1.5s infinite"};function Y({width:i="100%",height:r="1rem",style:t={},className:s=""}){return e.jsxs(e.Fragment,{children:[e.jsx("style",{children:`
        @keyframes shimmer {
          0% { background-position: 200% 0; }
          100% { background-position: -200% 0; }
        }
      `}),e.jsx("div",{className:s,style:{width:i,height:r,borderRadius:"4px",...Xr,...t}})]})}function qe({width:i="100%",lines:r=1}){return e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"0.5rem"},children:Array.from({length:r}).map((t,s)=>e.jsx(Y,{width:s===r-1&&r>1?"70%":i,height:"1rem"},s))})}function Jr(){return e.jsxs("div",{style:{backgroundColor:"white",borderRadius:"12px",padding:"1.5rem",boxShadow:"0 1px 3px rgba(0,0,0,0.1)",display:"flex",alignItems:"center",gap:"1rem"},children:[e.jsx(Y,{width:"48px",height:"48px",style:{borderRadius:"12px"}}),e.jsxs("div",{style:{flex:1},children:[e.jsx(Y,{width:"60%",height:"0.875rem",style:{marginBottom:"0.5rem"}}),e.jsx(Y,{width:"40%",height:"1.5rem"})]})]})}function Zr({columns:i=6}){return e.jsx("tr",{children:Array.from({length:i}).map((r,t)=>e.jsx("td",{style:{padding:"0.75rem 1rem"},children:e.jsx(Y,{width:t===0?"80%":t===i-1?"60px":"70%",height:"1rem"})},t))})}function Ee({hasHeader:i=!0}){return e.jsxs("div",{style:{backgroundColor:"white",borderRadius:"12px",padding:"1.5rem",boxShadow:"0 1px 3px rgba(0,0,0,0.1)"},children:[i&&e.jsx(Y,{width:"40%",height:"1.5rem",style:{marginBottom:"1rem"}}),e.jsx(qe,{lines:3})]})}function oe({type:i="text",count:r=1,...t}){return(()=>{switch(i){case"text":return e.jsx(qe,{...t});case"stat-card":case"stats":return e.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:"1rem"},children:Array.from({length:r}).map((a,n)=>e.jsx(Jr,{},n))});case"table":return e.jsx("div",{className:"card",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsx("tr",{children:Array.from({length:t.columns||6}).map((a,n)=>e.jsx("th",{style:{padding:"0.75rem 1rem"},children:e.jsx(Y,{width:"60%",height:"0.875rem"})},n))})}),e.jsx("tbody",{children:Array.from({length:t.rows||5}).map((a,n)=>e.jsx(Zr,{columns:t.columns||6},n))})]})});case"card":return e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"1rem"},children:Array.from({length:r}).map((a,n)=>e.jsx(Ee,{...t},n))});case"page":return e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"1.5rem"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsx(Y,{width:"200px",height:"1.75rem",style:{marginBottom:"0.5rem"}}),e.jsx(Y,{width:"300px",height:"1rem"})]}),e.jsx(Y,{width:"120px",height:"40px",style:{borderRadius:"8px"}})]}),e.jsx(oe,{type:"stats",count:4}),e.jsx(oe,{type:"table",rows:8,columns:6})]});case"detail":return e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"1.5rem"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"1rem"},children:[e.jsx(Y,{width:"80px",height:"36px",style:{borderRadius:"8px"}}),e.jsx(Y,{width:"250px",height:"1.75rem"})]}),e.jsx(oe,{type:"stats",count:4}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem"},children:[e.jsx(Ee,{}),e.jsx(Ee,{})]}),e.jsx(oe,{type:"table",rows:5,columns:5})]});default:return e.jsx(qe,{...t})}})()}const Ke={success:{icon:Dt,bgColor:"#dcfce7",borderColor:"#86efac",textColor:"#166534",iconColor:"#16a34a"},error:{icon:st,bgColor:"#fee2e2",borderColor:"#fecaca",textColor:"#991b1b",iconColor:"#dc2626"},warning:{icon:rt,bgColor:"#fef3c7",borderColor:"#fde68a",textColor:"#92400e",iconColor:"#d97706"},info:{icon:Mt,bgColor:"#dbeafe",borderColor:"#93c5fd",textColor:"#1e40af",iconColor:"#3b82f6"}};function es({id:i,message:r,type:t="info",duration:s=4e3,onClose:a}){const n=Ke[t]||Ke.info,o=n.icon;return d.useEffect(()=>{if(s>0){const c=setTimeout(()=>{a(i)},s);return()=>clearTimeout(c)}},[i,s,a]),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.75rem",padding:"0.875rem 1rem",backgroundColor:n.bgColor,border:`1px solid ${n.borderColor}`,borderRadius:"8px",boxShadow:"0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)",minWidth:"300px",maxWidth:"450px",animation:"slideIn 0.3s ease-out"},children:[e.jsx(o,{size:20,style:{color:n.iconColor,flexShrink:0}}),e.jsx("span",{style:{color:n.textColor,fontSize:"0.875rem",fontWeight:"500",flex:1},children:r}),e.jsx("button",{onClick:()=>a(i),style:{background:"none",border:"none",cursor:"pointer",padding:"0.25rem",display:"flex",alignItems:"center",justifyContent:"center",color:n.textColor,opacity:.7,borderRadius:"4px"},onMouseEnter:c=>c.target.style.opacity=1,onMouseLeave:c=>c.target.style.opacity=.7,children:e.jsx(ne,{size:16})})]})}function ts({toasts:i,removeToast:r}){return i.length===0?null:e.jsxs("div",{style:{position:"fixed",top:"1rem",right:"1rem",zIndex:9999,display:"flex",flexDirection:"column",gap:"0.5rem"},children:[e.jsx("style",{children:`
          @keyframes slideIn {
            from {
              transform: translateX(100%);
              opacity: 0;
            }
            to {
              transform: translateX(0);
              opacity: 1;
            }
          }
        `}),i.map(t=>e.jsx(es,{id:t.id,message:t.message,type:t.type,duration:t.duration,onClose:r},t.id))]})}const xt=d.createContext(null),rs=4e3;function ss({children:i}){const[r,t]=d.useState([]),s=d.useCallback(f=>{t(g=>g.filter(p=>p.id!==f))},[]),a=d.useCallback((f,g="info",p=rs)=>{const b=Date.now()+Math.random(),_={id:b,message:f,type:g,duration:p};return t(u=>[...u,_]),b},[]),n=d.useCallback((f,g)=>a(f,"success",g),[a]),o=d.useCallback((f,g)=>a(f,"error",g||6e3),[a]),c=d.useCallback((f,g)=>a(f,"warning",g),[a]),l=d.useCallback((f,g)=>a(f,"info",g),[a]),h={showToast:a,showSuccess:n,showError:o,showWarning:c,showInfo:l,removeToast:s};return e.jsxs(xt.Provider,{value:h,children:[i,e.jsx(ts,{toasts:r,removeToast:s})]})}function as(){const i=d.useContext(xt);if(!i)throw new Error("useToast must be used within a ToastProvider");return i}const H={timesheets:{contributeToSpend:["Submitted","Validated","Approved"],excludeFromSpend:["Draft","Rejected"],completed:["Validated","Approved"]},expenses:{contributeToSpend:["Submitted","Validated","Approved"],excludeFromSpend:["Draft","Rejected"],completed:["Validated","Approved"]},deliverables:{contributeToKPIs:["Delivered"],contributeToQS:["Delivered"],inProgress:["In Progress","Submitted","Under Review"],completed:["Delivered"],notStarted:["Not Started","Draft"]},milestones:{completed:["Completed"],inProgress:["In Progress"],notStarted:["Not Started","Planned"]},kpis:{achieved:["Achieved","On Target"],atRisk:["At Risk","Amber"],failing:["Failing","Red","Off Target"]},qualityStandards:{achieved:["Achieved","Met"],partial:["Partial","In Progress"],notMet:["Not Met","Failed"]}},ns=["pmo","project manager","pm"];function de(i){if(!i)return!1;const r=i.toLowerCase();return ns.some(t=>r.includes(t))}function Ge(i){return i?H.timesheets.contributeToSpend.includes(i):!1}function Qe(i){return i?H.expenses.contributeToSpend.includes(i):!1}const Ye={defaultTarget:90,amberThreshold:10,calculationMethod:"assessment_based"},is={defaultTarget:100,calculationMethod:"assessment_based"},bt={hoursPerDay:8,currency:"Â£",decimalPlaces:2};class os{constructor(){this.cache=new Map,this.cacheTimeout=5e3}clearCache(){this.cache.clear()}getCached(r){const t=this.cache.get(r);return t&&Date.now()-t.timestamp<this.cacheTimeout?t.data:null}setCache(r,t){this.cache.set(r,{data:t,timestamp:Date.now()})}async getMilestoneMetrics(r){const t=`milestones_${r}`,s=this.getCached(t);if(s)return s;try{const{data:a,error:n}=await m.from("milestones").select("id, milestone_ref, name, status, progress, budget, percent_complete, is_deleted").eq("project_id",r).order("milestone_ref");if(n)throw n;const o=a?.filter(l=>l.is_deleted!==!0)||[],c={total:o.length,completed:o.filter(l=>H.milestones.completed.includes(l.status)).length,inProgress:o.filter(l=>H.milestones.inProgress.includes(l.status)).length,notStarted:o.filter(l=>H.milestones.notStarted.includes(l.status)).length,totalBudget:o.reduce((l,h)=>l+(h.budget||0),0),averageProgress:o.length>0?Math.round(o.reduce((l,h)=>l+(h.progress||0),0)/o.length):0,milestones:o};return this.setCache(t,c),c}catch(a){throw a}}async getDeliverableMetrics(r,t=!1){const s=`deliverables_${r}_${t}`,a=this.getCached(s);if(a)return a;try{const{data:n,error:o}=await m.from("deliverables").select("id, deliverable_ref, name, status, due_date, milestone_id, is_deleted, is_test_content").eq("project_id",r).order("deliverable_ref");if(o)throw o;let c=n?.filter(p=>p.is_deleted!==!0)||[];t||(c=c.filter(p=>p.is_test_content!==!0));const l=new Date().toISOString().split("T")[0],h=new Date;h.setDate(h.getDate()+7);const f=h.toISOString().split("T")[0],g={total:c.length,delivered:c.filter(p=>H.deliverables.completed.includes(p.status)).length,inProgress:c.filter(p=>H.deliverables.inProgress.includes(p.status)).length,notStarted:c.filter(p=>H.deliverables.notStarted.includes(p.status)).length,overdue:c.filter(p=>p.due_date<l&&!H.deliverables.completed.includes(p.status)).length,dueThisWeek:c.filter(p=>p.due_date>=l&&p.due_date<=f&&!H.deliverables.completed.includes(p.status)).length,deliverables:c};return g.completionPercent=g.total>0?Math.round(g.delivered/g.total*100):0,this.setCache(s,g),g}catch(n){throw n}}async getKPIMetrics(r){const t=`kpis_${r}`,s=this.getCached(t);if(s)return s;try{const{data:a,error:n}=await m.from("kpis").select("id, kpi_ref, name, category, target, current_value, is_deleted").eq("project_id",r).order("kpi_ref");if(n)throw n;const o=a?.filter(_=>_.is_deleted!==!0)||[],{data:c,error:l}=await m.from("deliverable_kpi_assessments").select(`
          kpi_id,
          criteria_met,
          deliverables!inner(id, status, is_deleted, project_id)
        `).eq("deliverables.project_id",r),h=c?.filter(_=>_.deliverables?.is_deleted!==!0&&H.deliverables.contributeToKPIs.includes(_.deliverables?.status))||[],f=new Map;h&&h.length>0&&h.forEach(_=>{f.has(_.kpi_id)||f.set(_.kpi_id,{total:0,met:0});const u=f.get(_.kpi_id);u.total++,_.criteria_met&&u.met++});const g=o.map(_=>{const u=f.get(_.id);let j=0;u&&u.total>0&&(j=Math.round(u.met/u.total*100));const R=_.target||Ye.defaultTarget,q=j>=R;return{..._,calculatedValue:j,assessmentCount:u?.total||0,assessmentsMet:u?.met||0,isAchieved:q,ragStatus:j>=R?"Green":j>=R*(1-Ye.amberThreshold/100)?"Amber":"Red"}}),p={};g.forEach(_=>{const u=_.category||"Other";p[u]||(p[u]=[]),p[u].push(_)});const b={total:o.length,achieved:g.filter(_=>_.isAchieved).length,atRisk:g.filter(_=>_.ragStatus==="Amber").length,failing:g.filter(_=>_.ragStatus==="Red").length,achievementPercent:o.length>0?Math.round(g.filter(_=>_.isAchieved).length/o.length*100):0,byCategory:p,kpis:g};return this.setCache(t,b),b}catch(a){throw a}}async getQualityStandardMetrics(r){const t=`qs_${r}`,s=this.getCached(t);if(s)return s;try{const{data:a,error:n}=await m.from("quality_standards").select("id, qs_ref, name, category, target, current_value, is_deleted").eq("project_id",r).order("qs_ref");if(n)throw n;const o=a?.filter(b=>b.is_deleted!==!0)||[],{data:c,error:l}=await m.from("deliverable_qs_assessments").select(`
          quality_standard_id,
          criteria_met,
          deliverables!inner(id, status, is_deleted, project_id)
        `).eq("deliverables.project_id",r),h=c?.filter(b=>b.deliverables?.is_deleted!==!0&&H.deliverables.contributeToQS.includes(b.deliverables?.status))||[],f=new Map;h&&h.length>0&&h.forEach(b=>{f.has(b.quality_standard_id)||f.set(b.quality_standard_id,{total:0,met:0});const _=f.get(b.quality_standard_id);_.total++,b.criteria_met&&_.met++});const g=o.map(b=>{const _=f.get(b.id);let u=0;_&&_.total>0&&(u=Math.round(_.met/_.total*100));const j=b.target||is.defaultTarget,R=u>=j;return{...b,calculatedValue:u,assessmentCount:_?.total||0,assessmentsMet:_?.met||0,isAchieved:R}}),p={total:o.length,achieved:g.filter(b=>b.isAchieved).length,partial:g.filter(b=>b.calculatedValue>0&&!b.isAchieved).length,notMet:g.filter(b=>b.calculatedValue===0).length,achievementPercent:o.length>0?Math.round(g.filter(b=>b.isAchieved).length/o.length*100):0,qualityStandards:g};return this.setCache(t,p),p}catch(a){throw a}}async getTimesheetMetrics(r,t=!1){const s=`timesheets_${r}_${t}`,a=this.getCached(s);if(a)return a;try{const{data:n,error:o}=await m.from("timesheets").select(`
          id, date, hours_worked, hours, status, milestone_id, resource_id, is_deleted,
          resources(id, name, role, daily_rate)
        `).eq("project_id",r);if(o)throw o;const c=n?.filter(u=>u.is_deleted!==!0)||[];let l=0,h=0,f=0,g=0;const p={},b={};c.forEach(u=>{const j=parseFloat(u.hours_worked||u.hours||0),R=u.resources,q=R?.daily_rate||0,P=j/bt.hoursPerDay*q;Ge(u.status)&&(l+=j,h+=P,de(R?.role)?f+=P:g+=P,u.milestone_id&&(p[u.milestone_id]=(p[u.milestone_id]||0)+P),u.resource_id&&(b[u.resource_id]=(b[u.resource_id]||0)+P))});const _={totalEntries:c.length,validEntries:c.filter(u=>Ge(u.status)).length,draftEntries:c.filter(u=>u.status==="Draft").length,rejectedEntries:c.filter(u=>u.status==="Rejected").length,totalHours:l,totalSpend:h,pmoSpend:f,deliverySpend:g,spendByMilestone:p,spendByResource:b};return this.setCache(s,_),_}catch(n){throw n}}async getExpenseMetrics(r,t=!1){const s=`expenses_${r}_${t}`,a=this.getCached(s);if(a)return a;try{const{data:n,error:o}=await m.from("expenses").select("id, date, amount, status, category, milestone_id, chargeable_to_customer, procurement_method, is_deleted").eq("project_id",r);if(o)throw o;const c=n?.filter(_=>_.is_deleted!==!0)||[];let l=0,h=0,f=0;const g={},p={};c.forEach(_=>{const u=parseFloat(_.amount||0);if(Qe(_.status)){l+=u,_.chargeable_to_customer?h+=u:f+=u;const j=_.category||"Other";g[j]=(g[j]||0)+u,_.milestone_id&&(p[_.milestone_id]=(p[_.milestone_id]||0)+u)}});const b={totalEntries:c.length,validEntries:c.filter(_=>Qe(_.status)).length,draftEntries:c.filter(_=>_.status==="Draft").length,rejectedEntries:c.filter(_=>_.status==="Rejected").length,totalAmount:l,chargeableAmount:h,nonChargeableAmount:f,byCategory:g,byMilestone:p};return this.setCache(s,b),b}catch(n){throw n}}async getResourceMetrics(r){const t=`resources_${r}`,s=this.getCached(t);if(s)return s;try{const{data:a,error:n}=await m.from("resources").select("id, name, role, daily_rate, days_allocated, is_deleted").eq("project_id",r);if(n)throw n;const o=a?.filter(f=>f.is_deleted!==!0)||[];let c=0,l=0;o.forEach(f=>{const g=(f.daily_rate||0)*(f.days_allocated||0);de(f.role)?c+=g:l+=g});const h={total:o.length,pmoCount:o.filter(f=>de(f.role)).length,deliveryCount:o.filter(f=>!de(f.role)).length,pmoBudget:c,deliveryBudget:l,totalBudget:c+l,resources:o};return this.setCache(t,h),h}catch(a){throw a}}async getCertificateMetrics(r){const t=`certificates_${r}`,s=this.getCached(t);if(s)return s;try{const{data:a,error:n}=await m.from("milestone_certificates").select("id, milestone_id, status").eq("project_id",r);if(n)throw n;const o=await this.getMilestoneMetrics(r),c={total:a?.length||0,signed:a?.filter(l=>l.status==="Signed").length||0,pending:a?.filter(l=>l.status==="Pending Customer Signature"||l.status==="Pending Supplier Signature").length||0,awaitingGeneration:Math.max(0,o.completed-(a?.length||0))};return this.setCache(t,c),c}catch(a){throw a}}async getAllDashboardMetrics(r,t={}){const{includeTestContent:s=!1}=t;try{const[a,n,o,c,l,h,f,g]=await Promise.all([this.getMilestoneMetrics(r),this.getDeliverableMetrics(r,s),this.getKPIMetrics(r),this.getQualityStandardMetrics(r),this.getTimesheetMetrics(r,s),this.getExpenseMetrics(r,s),this.getResourceMetrics(r),this.getCertificateMetrics(r)]),p={totalBudget:a.totalBudget,timesheetSpend:l.totalSpend,expenseSpend:h.totalAmount,totalSpend:l.totalSpend+h.totalAmount,pmoBudget:f.pmoBudget,pmoSpend:l.pmoSpend,deliveryBudget:f.deliveryBudget,deliverySpend:l.deliverySpend,utilizationPercent:a.totalBudget>0?Math.round((l.totalSpend+h.totalAmount)/a.totalBudget*100):0},b={...l.spendByMilestone};return Object.entries(h.byMilestone).forEach(([_,u])=>{b[_]=(b[_]||0)+u}),{milestones:a,deliverables:n,kpis:o,qualityStandards:c,timesheets:l,expenses:h,resources:f,certificates:g,budget:p,milestoneSpend:b,projectProgress:a.averageProgress,lastUpdated:new Date().toISOString()}}catch(a){throw a}}}const G=new os,_t=d.createContext(null);function ls({children:i}){const{projectId:r}=Le(),{showTestUsers:t}=pt(),[s,a]=d.useState(null),[n,o]=d.useState(!0),[c,l]=d.useState(null),[h,f]=d.useState(null),g=d.useCallback(async(_=!1)=>{if(!r){a(null),o(!1);return}_&&G.clearCache(),o(!0),l(null);try{const u=await G.getAllDashboardMetrics(r,{includeTestContent:t});a(u),f(new Date)}catch(u){l(u.message||"Failed to load metrics")}finally{o(!1)}},[r,t]),p=d.useCallback(async _=>{if(r)try{let u;switch(_){case"milestones":u=await G.getMilestoneMetrics(r),a(j=>j?{...j,milestones:u}:null);break;case"deliverables":u=await G.getDeliverableMetrics(r,t),a(j=>j?{...j,deliverables:u}:null);break;case"kpis":u=await G.getKPIMetrics(r),a(j=>j?{...j,kpis:u}:null);break;case"qualityStandards":u=await G.getQualityStandardMetrics(r),a(j=>j?{...j,qualityStandards:u}:null);break;case"timesheets":u=await G.getTimesheetMetrics(r,t),a(j=>j?{...j,timesheets:u}:null);break;case"expenses":u=await G.getExpenseMetrics(r,t),a(j=>j?{...j,expenses:u}:null);break;case"resources":u=await G.getResourceMetrics(r),a(j=>j?{...j,resources:u}:null);break;case"certificates":u=await G.getCertificateMetrics(r),a(j=>j?{...j,certificates:u}:null);break;default:await g(!0)}f(new Date)}catch{}},[r,t,g]);d.useEffect(()=>{g()},[g]);const b=d.useMemo(()=>({metrics:s,milestones:s?.milestones||null,deliverables:s?.deliverables||null,kpis:s?.kpis||null,qualityStandards:s?.qualityStandards||null,timesheets:s?.timesheets||null,expenses:s?.expenses||null,resources:s?.resources||null,certificates:s?.certificates||null,budget:s?.budget||null,milestoneSpend:s?.milestoneSpend||{},projectProgress:s?.projectProgress||0,loading:n,error:c,lastRefresh:h,refreshMetrics:()=>g(!0),refreshCategory:p,clearCache:()=>G.clearCache()}),[s,n,c,h,g,p]);return e.jsx(_t.Provider,{value:b,children:i})}function xa(){const i=d.useContext(_t);if(!i)throw new Error("useMetrics must be used within a MetricsProvider");return i}function cs(){const{isOpen:i,toggleChat:r,messages:t,isLoading:s,error:a,retryCount:n,tokenUsage:o,sendMessage:c,clearChat:l,cancelRequest:h,dismissError:f,downloadChat:g,copyMessage:p}=Qr(),[b,_]=d.useState(""),[u,j]=d.useState(null),[R,q]=d.useState(!1),P=d.useRef(null),w=d.useRef(null);d.useEffect(()=>{P.current?.scrollIntoView({behavior:"smooth"})},[t]),d.useEffect(()=>{i&&setTimeout(()=>w.current?.focus(),100)},[i]),d.useEffect(()=>{if(u!==null){const M=setTimeout(()=>j(null),2e3);return()=>clearTimeout(M)}},[u]);const N=M=>{M.preventDefault(),b.trim()&&!s&&(c(b),_(""))},k=M=>{M.key==="Enter"&&!M.shiftKey&&(M.preventDefault(),N(M))},C=async(M,I)=>{await p(M)&&j(I)},y={role:"assistant",content:`Hello! I'm your Project Assistant. I can query your project data and help you understand what's happening. Try asking:

â€¢ **"What do I need to do?"** - See your pending actions
â€¢ **"Show my timesheets this month"** - Query your time entries
â€¢ **"What milestones are at risk?"** - Check project progress
â€¢ **"What's the budget status?"** - View spend vs forecast
â€¢ **"What can my role do?"** - Understand your permissions

All data is scoped to your role, so just ask naturally!`},v=t.length===0?[y]:t,A=(o.input*.25/1e6+o.output*1.25/1e6).toFixed(4);return e.jsxs(e.Fragment,{children:[e.jsx("button",{className:`chat-toggle-btn ${i?"chat-open":""}`,onClick:r,"aria-label":i?"Close chat":"Open AI assistant",children:i?e.jsx(ne,{size:24}):e.jsxs(e.Fragment,{children:[e.jsx(Tt,{size:24}),e.jsx(qt,{className:"chat-sparkle",size:12})]})}),e.jsxs("div",{className:`chat-panel ${i?"chat-panel-open":""}`,children:[e.jsxs("div",{className:"chat-header",children:[e.jsxs("div",{className:"chat-header-title",children:[e.jsx(Se,{size:20}),e.jsx("span",{children:"Project Assistant"})]}),e.jsxs("div",{className:"chat-header-actions",children:[t.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"chat-action-btn",onClick:g,title:"Export chat as Markdown",children:e.jsx(Ot,{size:16})}),e.jsx("button",{className:"chat-action-btn",onClick:l,title:"Clear chat",children:e.jsx(Lt,{size:16})})]}),e.jsx("button",{className:"chat-close-btn",onClick:r,"aria-label":"Close chat",children:e.jsx(ne,{size:20})})]})]}),e.jsxs("div",{className:"chat-messages",children:[v.map((M,I)=>e.jsxs("div",{className:`chat-message ${M.role==="user"?"chat-message-user":"chat-message-assistant"}`,children:[e.jsx("div",{className:"chat-message-avatar",children:M.role==="user"?e.jsx(zt,{size:16}):e.jsx(Se,{size:16})}),e.jsxs("div",{className:"chat-message-content",children:[e.jsx(ds,{content:M.content}),e.jsxs("div",{className:"chat-message-actions",children:[M.toolsUsed&&e.jsx("span",{className:"chat-tools-indicator",title:"Queried project data",children:e.jsx(Bt,{size:12})}),e.jsx("button",{className:"chat-copy-btn",onClick:()=>C(M.content,I),title:u===I?"Copied!":"Copy message",children:u===I?e.jsx(at,{size:12,className:"chat-copy-success"}):e.jsx(Ut,{size:12})})]})]})]},I)),s&&e.jsxs("div",{className:"chat-message chat-message-assistant",children:[e.jsx("div",{className:"chat-message-avatar",children:e.jsx(Se,{size:16})}),e.jsxs("div",{className:"chat-message-content chat-typing",children:[n>0?e.jsxs(e.Fragment,{children:[e.jsx(ue,{className:"chat-typing-icon",size:16}),e.jsxs("span",{children:["Retrying (",n,"/2)..."]})]}):e.jsxs(e.Fragment,{children:[e.jsx($t,{className:"chat-typing-icon",size:16}),e.jsx("span",{children:"Querying data..."})]}),e.jsx("button",{className:"chat-cancel-btn",onClick:h,title:"Cancel request",children:e.jsx(st,{size:14})})]})]}),a&&e.jsxs("div",{className:"chat-error",children:[e.jsx("span",{children:a}),e.jsx("button",{className:"chat-error-dismiss",onClick:f,title:"Dismiss",children:e.jsx(ne,{size:14})})]}),e.jsx("div",{ref:P})]}),e.jsxs("form",{className:"chat-input-form",onSubmit:N,children:[e.jsx("textarea",{ref:w,className:"chat-input",value:b,onChange:M=>_(M.target.value),onKeyDown:k,placeholder:"Ask me anything about the project...",rows:1,disabled:s}),e.jsx("button",{type:"submit",className:"chat-send-btn",disabled:!b.trim()||s,"aria-label":"Send message",children:e.jsx(Wt,{size:18})})]}),e.jsxs("div",{className:"chat-footer",children:[e.jsx("button",{className:"chat-stats-toggle",onClick:()=>q(!R),title:"Toggle usage stats",children:e.jsx(Ie,{size:12})}),R?e.jsxs("div",{className:"chat-stats",children:[e.jsxs("span",{title:"Total requests",children:[o.requests," req"]}),e.jsx("span",{className:"chat-stats-divider",children:"â€¢"}),e.jsxs("span",{title:"Input tokens",children:[o.input.toLocaleString()," in"]}),e.jsx("span",{className:"chat-stats-divider",children:"â€¢"}),e.jsxs("span",{title:"Output tokens",children:[o.output.toLocaleString()," out"]}),e.jsx("span",{className:"chat-stats-divider",children:"â€¢"}),e.jsxs("span",{title:"Estimated cost",children:["$",A]})]}):e.jsx("span",{children:"Powered by Claude AI"})]})]})]})}function ds({content:i}){const r=i.split(`
`);return e.jsx("div",{className:"chat-message-text",children:r.map((t,s)=>{if(t.startsWith("â€¢ ")||t.startsWith("- ")){const a=t.substring(2);return e.jsxs("div",{className:"chat-bullet",children:[e.jsx("span",{className:"chat-bullet-dot",children:"â€¢"}),e.jsx("span",{dangerouslySetInnerHTML:{__html:Xe(a)}})]},s)}return t.trim()===""?e.jsx("div",{className:"chat-line-break"},s):e.jsx("p",{dangerouslySetInnerHTML:{__html:Xe(t)}},s)})})}function Xe(i){return i.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>")}function us(){const[i,r]=d.useState(!1),t=d.useRef(null),s=Oe(),{notifications:a,unreadCount:n,actionCount:o,loading:c,markAsRead:l,markAsActioned:h,markAllAsRead:f,dismissNotification:g}=Wr();d.useEffect(()=>{function w(N){t.current&&!t.current.contains(N.target)&&r(!1)}return document.addEventListener("mousedown",w),()=>document.removeEventListener("mousedown",w)},[]);const p=w=>{switch(w){case"timesheet":return e.jsx(le,{size:16});case"expense":return e.jsx(it,{size:16});case"deliverable":return e.jsx(nt,{size:16});case"certificate":return e.jsx(he,{size:16});default:return e.jsx(je,{size:16})}},b=w=>w.notification_type==="action"?w.is_actioned?"#10b981":"#f59e0b":"#3b82f6",_=async w=>{w.is_read||await l(w.id),w.action_url&&(s(w.action_url),r(!1))},u=async(w,N)=>{w.stopPropagation(),await h(N.id),N.action_url&&(s(N.action_url),r(!1))},j=async(w,N)=>{w.stopPropagation(),await g(N.id)},R=w=>{const N=new Date(w),C=new Date-N,y=Math.floor(C/6e4),v=Math.floor(C/36e5),A=Math.floor(C/864e5);return y<1?"Just now":y<60?`${y}m ago`:v<24?`${v}h ago`:A<7?`${A}d ago`:N.toLocaleDateString("en-GB",{day:"numeric",month:"short"})},q=a.slice(0,10),P=a.filter(w=>w.notification_type==="action"&&!w.is_actioned);return e.jsxs("div",{className:"notification-bell-container",ref:t,style:{position:"relative"},children:[e.jsxs("button",{onClick:()=>r(!i),style:{position:"relative",background:"none",border:"none",cursor:"pointer",padding:"8px",borderRadius:"8px",display:"flex",alignItems:"center",justifyContent:"center",transition:"background-color 0.2s",backgroundColor:i?"#f1f5f9":"transparent"},onMouseEnter:w=>w.target.style.backgroundColor="#f1f5f9",onMouseLeave:w=>w.target.style.backgroundColor=i?"#f1f5f9":"transparent",title:`${o} actions pending`,children:[e.jsx(je,{size:22,color:"#64748b"}),(n>0||o>0)&&e.jsx("span",{style:{position:"absolute",top:"2px",right:"2px",backgroundColor:o>0?"#ef4444":"#3b82f6",color:"white",fontSize:"11px",fontWeight:"600",minWidth:"18px",height:"18px",borderRadius:"9px",display:"flex",alignItems:"center",justifyContent:"center",padding:"0 4px"},children:o>0?o:n})]}),i&&e.jsxs("div",{style:{position:"absolute",top:"100%",right:0,marginTop:"8px",width:"380px",maxHeight:"500px",backgroundColor:"white",borderRadius:"12px",boxShadow:"0 10px 40px rgba(0,0,0,0.15)",border:"1px solid #e2e8f0",zIndex:1e3,overflow:"hidden"},children:[e.jsxs("div",{style:{padding:"16px",borderBottom:"1px solid #e2e8f0",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsx("h3",{style:{margin:0,fontSize:"16px",fontWeight:"600"},children:"Notifications"}),o>0&&e.jsxs("p",{style:{margin:"4px 0 0",fontSize:"13px",color:"#f59e0b"},children:[o," action",o!==1?"s":""," required"]})]}),n>0&&e.jsx("button",{onClick:f,style:{background:"none",border:"none",color:"#3b82f6",fontSize:"13px",cursor:"pointer",padding:"4px 8px",borderRadius:"4px"},children:"Mark all read"})]}),P.length>0&&e.jsxs("div",{style:{padding:"12px 16px",backgroundColor:"#fffbeb",borderBottom:"1px solid #fef3c7"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"8px"},children:[e.jsx("div",{style:{width:"8px",height:"8px",borderRadius:"50%",backgroundColor:"#f59e0b",animation:"pulse 2s infinite"}}),e.jsx("span",{style:{fontWeight:"600",fontSize:"13px",color:"#92400e"},children:"Actions Requiring Attention"})]}),e.jsxs("button",{onClick:()=>{s("/workflow-summary"),r(!1)},style:{width:"100%",padding:"8px 12px",backgroundColor:"#f59e0b",color:"white",border:"none",borderRadius:"6px",cursor:"pointer",fontSize:"13px",fontWeight:"500",display:"flex",alignItems:"center",justifyContent:"center",gap:"6px"},children:["View Workflow Summary",e.jsx(Ft,{size:16})]})]}),e.jsx("div",{style:{maxHeight:"350px",overflowY:"auto"},children:c?e.jsx("div",{style:{padding:"32px",textAlign:"center",color:"#64748b"},children:"Loading..."}):q.length===0?e.jsxs("div",{style:{padding:"32px",textAlign:"center",color:"#64748b"},children:[e.jsx(je,{size:32,style:{marginBottom:"8px",opacity:.5}}),e.jsx("p",{style:{margin:0},children:"No notifications"})]}):q.map(w=>e.jsx("div",{onClick:()=>_(w),style:{padding:"12px 16px",borderBottom:"1px solid #f1f5f9",cursor:"pointer",backgroundColor:w.is_read?"white":"#f8fafc",transition:"background-color 0.15s"},onMouseEnter:N=>N.currentTarget.style.backgroundColor="#f1f5f9",onMouseLeave:N=>N.currentTarget.style.backgroundColor=w.is_read?"white":"#f8fafc",children:e.jsxs("div",{style:{display:"flex",gap:"12px"},children:[e.jsx("div",{style:{width:"36px",height:"36px",borderRadius:"8px",backgroundColor:w.notification_type==="action"&&!w.is_actioned?"#fef3c7":"#f1f5f9",display:"flex",alignItems:"center",justifyContent:"center",color:b(w),flexShrink:0},children:p(w.category)}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",gap:"8px"},children:[e.jsx("span",{style:{fontWeight:w.is_read?"400":"600",fontSize:"14px",color:"#1e293b"},children:w.title}),e.jsx("span",{style:{fontSize:"12px",color:"#94a3b8",flexShrink:0},children:R(w.created_at)})]}),e.jsx("p",{style:{margin:"4px 0 0",fontSize:"13px",color:"#64748b",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:w.message}),e.jsxs("div",{style:{marginTop:"8px",display:"flex",gap:"8px"},children:[w.notification_type==="action"&&!w.is_actioned&&w.action_label&&e.jsx("button",{onClick:N=>u(N,w),style:{padding:"4px 12px",fontSize:"12px",fontWeight:"500",backgroundColor:"#3b82f6",color:"white",border:"none",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",gap:"4px"},children:w.action_label}),w.notification_type==="info"&&e.jsxs("button",{onClick:N=>j(N,w),style:{padding:"4px 8px",fontSize:"12px",backgroundColor:"transparent",color:"#64748b",border:"1px solid #e2e8f0",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",gap:"4px"},children:[e.jsx(ne,{size:12}),"Dismiss"]}),w.is_actioned&&e.jsxs("span",{style:{padding:"4px 8px",fontSize:"12px",color:"#10b981",display:"flex",alignItems:"center",gap:"4px"},children:[e.jsx(at,{size:12}),"Completed"]})]})]})]})},w.id))}),a.length>10&&e.jsx("div",{style:{padding:"12px 16px",borderTop:"1px solid #e2e8f0",textAlign:"center"},children:e.jsx("button",{onClick:()=>{s("/workflow-summary"),r(!1)},style:{background:"none",border:"none",color:"#3b82f6",fontSize:"13px",fontWeight:"500",cursor:"pointer"},children:"View all notifications"})})]}),e.jsx("style",{children:`
        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.5; }
        }
      `})]})}const x={ADMIN:"admin",SUPPLIER_PM:"supplier_pm",CUSTOMER_PM:"customer_pm",CONTRIBUTOR:"contributor",VIEWER:"viewer"},hs=[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.CONTRIBUTOR,x.VIEWER],re=hs,te=[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM],T=[x.ADMIN,x.SUPPLIER_PM],ie=[x.ADMIN,x.CUSTOMER_PM],se=[x.ADMIN,x.SUPPLIER_PM,x.CONTRIBUTOR],Re=[x.ADMIN],ms={timesheets:{view:re,create:se,createForOthers:T,edit:se,delete:T,submit:se,approve:ie},expenses:{view:re,create:se,createForOthers:T,edit:se,delete:T,submit:se,validateChargeable:ie,validateNonChargeable:T},milestones:{view:re,create:T,edit:T,delete:Re,useGantt:T},deliverables:{view:re,create:[...te,x.CONTRIBUTOR],edit:[...te,x.CONTRIBUTOR],delete:T,submit:se,review:ie,markDelivered:ie},kpis:{view:re,create:T,edit:T,delete:T,manage:T},qualityStandards:{view:re,create:T,edit:T,delete:T,manage:T},resources:{view:re,create:T,edit:T,delete:Re,manage:T,seeCostPrice:T,seeResourceType:T,seeMargins:T},partners:{view:T,create:T,edit:T,delete:T,manage:T},certificates:{view:te,create:te,signAsSupplier:T,signAsCustomer:ie},invoices:{view:te,generateCustomer:te,generateThirdParty:T,viewMargins:T},settings:{access:T,edit:T},users:{view:T,manage:Re},reports:{access:te,viewWorkflowSummary:te}};function ba(i,r,t){const s=ms[r];if(!s)return!1;const a=s[t];return a?a.includes(i):!1}const fs={[x.ADMIN]:{label:"Admin",color:"#7c3aed",bg:"#f3e8ff"},[x.SUPPLIER_PM]:{label:"Supplier PM",color:"#059669",bg:"#d1fae5"},[x.CUSTOMER_PM]:{label:"Customer PM",color:"#d97706",bg:"#fef3c7"},[x.CONTRIBUTOR]:{label:"Contributor",color:"#2563eb",bg:"#dbeafe"},[x.VIEWER]:{label:"Viewer",color:"#64748b",bg:"#f1f5f9"}},_a=Object.entries(fs).map(([i,r])=>({value:i,...r})),xe={workflowSummary:{id:"workflowSummary",path:"/workflow-summary",icon:er,label:"Workflow Summary",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.CONTRIBUTOR],readOnlyRoles:[]},dashboard:{id:"dashboard",path:"/dashboard",icon:Zt,label:"Dashboard",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.VIEWER],readOnlyRoles:[x.VIEWER]},reports:{id:"reports",path:"/reports",icon:nt,label:"Reports",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM],readOnlyRoles:[]},gantt:{id:"gantt",path:"/gantt",icon:Jt,label:"Gantt Chart",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.VIEWER],readOnlyRoles:[x.VIEWER,x.CUSTOMER_PM]},milestones:{id:"milestones",path:"/milestones",icon:Xt,label:"Milestones",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.VIEWER],readOnlyRoles:[x.VIEWER]},deliverables:{id:"deliverables",path:"/deliverables",icon:Me,label:"Deliverables",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.CONTRIBUTOR,x.VIEWER],readOnlyRoles:[x.VIEWER]},kpis:{id:"kpis",path:"/kpis",icon:Ae,label:"KPIs",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.VIEWER],readOnlyRoles:[x.VIEWER,x.CUSTOMER_PM]},qualityStandards:{id:"qualityStandards",path:"/quality-standards",icon:he,label:"Quality Standards",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.VIEWER],readOnlyRoles:[x.VIEWER,x.CUSTOMER_PM]},resources:{id:"resources",path:"/resources",icon:Yt,label:"Resources",allowedRoles:[x.ADMIN,x.SUPPLIER_PM],readOnlyRoles:[]},timesheets:{id:"timesheets",path:"/timesheets",icon:le,label:"Timesheets",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.CONTRIBUTOR],readOnlyRoles:[]},expenses:{id:"expenses",path:"/expenses",icon:it,label:"Expenses",allowedRoles:[x.ADMIN,x.SUPPLIER_PM,x.CUSTOMER_PM,x.CONTRIBUTOR],readOnlyRoles:[]},partners:{id:"partners",path:"/partners",icon:Qt,label:"Partners",allowedRoles:[x.ADMIN,x.SUPPLIER_PM],readOnlyRoles:[]},users:{id:"users",path:"/users",icon:Gt,label:"Users",allowedRoles:[x.ADMIN,x.SUPPLIER_PM],readOnlyRoles:[x.SUPPLIER_PM]},settings:{id:"settings",path:"/settings",icon:Kt,label:"Settings",allowedRoles:[x.ADMIN,x.SUPPLIER_PM],readOnlyRoles:[]},auditLog:{id:"auditLog",path:"/audit-log",icon:Ht,label:"Audit Log",allowedRoles:[x.ADMIN,x.SUPPLIER_PM],readOnlyRoles:[]},deletedItems:{id:"deletedItems",path:"/deleted-items",icon:Vt,label:"Deleted Items",allowedRoles:[x.ADMIN,x.SUPPLIER_PM],readOnlyRoles:[]}},fe={[x.ADMIN]:["workflowSummary","dashboard","reports","gantt","milestones","deliverables","kpis","qualityStandards","resources","timesheets","expenses","partners","users","settings","auditLog","deletedItems"],[x.SUPPLIER_PM]:["workflowSummary","dashboard","reports","gantt","milestones","deliverables","kpis","qualityStandards","resources","timesheets","expenses","partners","users","settings","auditLog","deletedItems"],[x.CUSTOMER_PM]:["workflowSummary","dashboard","reports","gantt","milestones","deliverables","kpis","qualityStandards","timesheets","expenses"],[x.CONTRIBUTOR]:["workflowSummary","timesheets","expenses","deliverables"],[x.VIEWER]:["dashboard","gantt","milestones","deliverables","kpis","qualityStandards"]};function ps(i){return(fe[i]||fe[x.VIEWER]).map(t=>xe[t]?.path).filter(Boolean)}function vt(i){return(fe[i]||fe[x.VIEWER]).map(t=>xe[t]).filter(t=>t&&t.allowedRoles.includes(i))}function Je(i,r){const t=xe[r];return t?t.readOnlyRoles?.includes(i)||!1:!0}function gs(i){return i!==x.VIEWER}function ys(i){return Object.values(xe).find(r=>r.path===i)||null}function xs(i){return ys(i)?.id||null}function bs(i,r){const t=vt(i);if(!r||!Array.isArray(r)||r.length===0)return t;const s={};t.forEach(n=>{s[n.path]=n});const a=[];return r.forEach(n=>{s[n]&&(a.push(s[n]),delete s[n])}),Object.values(s).forEach(n=>{a.push(n)}),a}function _s(i,r){if(!r||r.length===0)return!0;const t=ps(i);return r.length!==t.length?!1:r.every((s,a)=>s===t[a])}const Ze={[x.ADMIN]:{label:"Administrator",shortLabel:"Admin",color:"#7c3aed",bg:"#f3e8ff",description:"Full system access"},[x.SUPPLIER_PM]:{label:"Supplier PM",shortLabel:"Supplier PM",color:"#059669",bg:"#d1fae5",description:"Manage resources, partners, and invoices"},[x.CUSTOMER_PM]:{label:"Customer PM",shortLabel:"Customer PM",color:"#d97706",bg:"#fef3c7",description:"Approve timesheets and validate expenses"},[x.CONTRIBUTOR]:{label:"Contributor",shortLabel:"Contributor",color:"#2563eb",bg:"#dbeafe",description:"Submit timesheets and expenses"},[x.VIEWER]:{label:"Viewer",shortLabel:"Viewer",color:"#64748b",bg:"#f1f5f9",description:"Read-only access to reports"}};function vs(i){return Ze[i]||Ze[x.VIEWER]}function ws({children:i}){const r=kt(),t=Oe(),{showSuccess:s,showError:a}=as(),{user:n,profile:o,role:c,signOut:l}=ye(),[h,f]=d.useState(!0),[g,p]=d.useState(null),[b,_]=d.useState(null),[u,j]=d.useState(null),R=d.useRef(null),q=d.useMemo(()=>vs(c),[c]),P=d.useMemo(()=>o&&(o.full_name||o.email||n?.email)||"User",[o,n]),w=d.useMemo(()=>{if(!o)return"U";if(o.full_name){const E=o.full_name.split(" ");return E.length>=2?E[0][0]+E[E.length-1][0]:o.full_name[0].toUpperCase()}return P[0].toUpperCase()},[o,P]);d.useEffect(()=>{o?.nav_order&&Array.isArray(o.nav_order)&&p(o.nav_order)},[o]);async function N(){await l(),t("/login")}const k=d.useMemo(()=>gs(c),[c]),C=d.useMemo(()=>g&&!_s(c,g),[c,g]),y=d.useMemo(()=>{const E=vt(c);return g&&g.length>0?bs(c,g):E},[c,g]),v=d.useMemo(()=>{const E=xs(r.pathname);return E?Je(c,E):!1},[c,r.pathname]);function A(E,$){k&&(R.current=E.target,_($),setTimeout(()=>{R.current&&(R.current.style.opacity="0.5")},0))}function M(E,$){k&&$!==b&&j($)}function I(E){k&&E.preventDefault()}function U(){if(k){if(R.current&&(R.current.style.opacity="1"),b!==null&&u!==null&&b!==u){const E=[...y],$=E[b];E.splice(b,1),E.splice(u,0,$);const ee=E.map(Z=>Z.path);p(ee),X(ee)}_(null),j(null),R.current=null}}async function X(E){if(n)try{const{error:$}=await m.from("profiles").update({nav_order:E}).eq("id",n.id);$&&a("Failed to save menu order")}catch{a("Failed to save menu order")}}async function ae(){if(n)try{const{error:E}=await m.from("profiles").update({nav_order:null}).eq("id",n.id);if(E){a("Failed to reset menu order");return}p(null),s("Menu order reset to default")}catch{a("Failed to reset menu order")}}return e.jsxs("div",{style:{display:"flex",minHeight:"100vh",backgroundColor:"#f8fafc"},children:[e.jsxs("aside",{style:{width:h?"260px":"70px",backgroundColor:"white",borderRight:"1px solid #e2e8f0",transition:"width 0.3s ease",display:"flex",flexDirection:"column",position:"fixed",height:"100vh",zIndex:50},children:[e.jsxs("div",{style:{padding:"1rem",borderBottom:"1px solid #e2e8f0",display:"flex",alignItems:"center",justifyContent:"space-between"},children:[h&&e.jsxs("div",{children:[e.jsx("h2",{style:{margin:0,fontSize:"1.125rem",fontWeight:"700",color:"#0f172a"},children:"AMSF001"}),e.jsx("span",{style:{fontSize:"0.75rem",color:"#64748b"},children:"Project Tracker"})]}),e.jsx("button",{onClick:()=>f(!h),style:{padding:"0.5rem",borderRadius:"6px",border:"none",backgroundColor:"#f1f5f9",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"},children:h?e.jsx(ne,{size:20}):e.jsx(tr,{size:20})})]}),e.jsx("nav",{style:{flex:1,padding:"0.5rem",overflowY:"auto"},children:y.map((E,$)=>{const ee=E.icon,Z=r.pathname===E.path||E.path!=="/dashboard"&&r.pathname.startsWith(E.path),W=b===$,F=u===$,D=Je(c,E.id);return e.jsx("div",{draggable:k,onDragStart:S=>A(S,$),onDragEnter:S=>M(S,$),onDragOver:I,onDragEnd:U,style:{position:"relative",marginBottom:"0.25rem",borderTop:F&&b>$?"2px solid #10b981":"2px solid transparent",borderBottom:F&&b<$?"2px solid #10b981":"2px solid transparent",transition:"border-color 0.15s ease"},children:e.jsxs(Q,{to:E.path,style:{display:"flex",alignItems:"center",gap:"0.75rem",padding:h?"0.75rem 1rem":"0.75rem",borderRadius:"8px",textDecoration:"none",color:Z?"#10b981":"#64748b",backgroundColor:Z?"#f0fdf4":W?"#f1f5f9":"transparent",fontWeight:Z?"600":"500",justifyContent:h?"flex-start":"center",transition:"all 0.15s ease",cursor:k?"grab":"pointer"},children:[h&&k&&e.jsx(rr,{size:14,style:{color:"#cbd5e1",marginRight:"-0.25rem",flexShrink:0}}),e.jsx(ee,{size:20}),h&&e.jsx("span",{style:{flex:1},children:E.label}),h&&D&&e.jsx("span",{style:{fontSize:"0.6rem",padding:"0.125rem 0.375rem",backgroundColor:"#f1f5f9",color:"#64748b",borderRadius:"4px",fontWeight:"500"},children:"VIEW"})]})},E.path)})}),h&&k&&C&&e.jsx("div",{style:{padding:"0.5rem 1rem",borderTop:"1px solid #e2e8f0"},children:e.jsxs("button",{onClick:ae,style:{width:"100%",display:"flex",alignItems:"center",justifyContent:"center",gap:"0.5rem",padding:"0.5rem",backgroundColor:"#f8fafc",color:"#64748b",border:"1px solid #e2e8f0",borderRadius:"6px",cursor:"pointer",fontSize:"0.75rem",fontWeight:"500",transition:"all 0.15s ease"},onMouseEnter:E=>{E.currentTarget.style.backgroundColor="#f1f5f9",E.currentTarget.style.color="#475569"},onMouseLeave:E=>{E.currentTarget.style.backgroundColor="#f8fafc",E.currentTarget.style.color="#64748b"},children:[e.jsx(sr,{size:14}),"Reset Menu Order"]})}),e.jsx("div",{style:{padding:"1rem",borderTop:"1px solid #e2e8f0",backgroundColor:"#f8fafc"},children:e.jsxs("button",{onClick:N,style:{width:"100%",display:"flex",alignItems:"center",justifyContent:h?"flex-start":"center",gap:"0.75rem",padding:"0.75rem",backgroundColor:"#fef2f2",color:"#ef4444",border:"none",borderRadius:"8px",cursor:"pointer",fontWeight:"500"},children:[e.jsx(ar,{size:20}),h&&e.jsx("span",{children:"Logout"})]})})]}),e.jsxs("main",{style:{flex:1,marginLeft:h?"260px":"70px",transition:"margin-left 0.3s ease",minHeight:"100vh",display:"flex",flexDirection:"column"},children:[e.jsxs("header",{style:{padding:"0.75rem 1.5rem",backgroundColor:"white",borderBottom:"1px solid #e2e8f0",display:"flex",justifyContent:"flex-end",alignItems:"center",gap:"1rem",position:"sticky",top:0,zIndex:40},children:[e.jsxs(Q,{to:"/account",style:{display:"flex",alignItems:"center",gap:"0.75rem",paddingRight:"1rem",borderRight:"1px solid #e2e8f0",textDecoration:"none",cursor:"pointer",borderRadius:"8px",padding:"0.5rem 1rem 0.5rem 0.75rem",marginRight:"0",transition:"background-color 0.15s ease"},onMouseEnter:E=>E.currentTarget.style.backgroundColor="#f8fafc",onMouseLeave:E=>E.currentTarget.style.backgroundColor="transparent",children:[e.jsxs("div",{style:{textAlign:"right"},children:[e.jsx("div",{style:{fontWeight:"600",fontSize:"0.875rem",color:"#1e293b"},children:P}),e.jsx("span",{style:{display:"inline-block",padding:"0.125rem 0.5rem",backgroundColor:q.bg,color:q.color,borderRadius:"4px",fontSize:"0.65rem",fontWeight:"600",textTransform:"uppercase",letterSpacing:"0.025em"},children:q.shortLabel})]}),e.jsx("div",{style:{width:"36px",height:"36px",borderRadius:"50%",backgroundColor:q.color,display:"flex",alignItems:"center",justifyContent:"center",color:"white",fontWeight:"600",fontSize:"0.8rem"},children:w})]}),e.jsx(us,{})]}),v&&e.jsxs("div",{style:{padding:"0.5rem 1.5rem",backgroundColor:"#f1f5f9",borderBottom:"1px solid #e2e8f0",display:"flex",alignItems:"center",gap:"0.5rem",fontSize:"0.875rem",color:"#64748b"},children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",y1:"16",x2:"12",y2:"12"}),e.jsx("line",{x1:"12",y1:"8",x2:"12.01",y2:"8"})]}),e.jsx("span",{children:"You have read-only access to this page"})]}),e.jsx("div",{style:{flex:1},children:i})]})]})}function Ss(){const i=Oe(),[r]=Et(),[t,s]=d.useState(!1),[a,n]=d.useState(""),[o,c]=d.useState(""),[l,h]=d.useState(null),[f,g]=d.useState(null),[p,b]=d.useState(!1),[_,u]=d.useState(!1),[j,R]=d.useState(!1),[q,P]=d.useState(!1);d.useEffect(()=>{r.get("expired")==="true"&&(P(!0),window.history.replaceState({},document.title,"/login")),m.auth.getSession().then(({data:{session:v}})=>{v&&i("/dashboard",{replace:!0})});const{data:{subscription:y}}=m.auth.onAuthStateChange((v,A)=>{v==="SIGNED_IN"&&A&&i("/dashboard",{replace:!0})});return()=>y.unsubscribe()},[i,r]);const w=async y=>{y.preventDefault(),s(!0),h(null),g(null),P(!1);try{if(p){const{error:v}=await m.auth.signUp({email:a,password:o,options:{data:{full_name:a.split("@")[0]}}});if(v)throw v;g("Check your email for confirmation link!")}else{const{error:v}=await m.auth.signInWithPassword({email:a,password:o});if(v)throw v}}catch(v){h(v.message)}finally{s(!1)}},N=async y=>{if(y.preventDefault(),!a){h("Please enter your email address");return}s(!0),h(null),g(null);try{const{error:v}=await m.auth.resetPasswordForEmail(a,{redirectTo:`${window.location.origin}/reset-password`});if(v)throw v;g("Password reset email sent! Check your inbox.")}catch(v){h(v.message)}finally{s(!1)}},k=async y=>{if(y.preventDefault(),!a){h("Please enter your email address");return}s(!0),h(null),g(null);try{const{error:v}=await m.auth.resend({type:"signup",email:a});if(v)throw v;g("Verification email resent! Check your inbox.")}catch(v){h(v.message)}finally{s(!1)}},C=()=>{u(!1),R(!1),h(null),g(null),P(!1)};return _?e.jsx("div",{className:"auth-container",children:e.jsxs("div",{className:"auth-box",children:[e.jsxs("div",{className:"auth-logo",children:[e.jsx(nr,{size:40,style:{color:"var(--primary)",marginBottom:"0.5rem"}}),e.jsx("h1",{className:"auth-title",children:"Reset Password"}),e.jsx("p",{className:"auth-subtitle",children:"Enter your email to receive a reset link"})]}),e.jsxs("form",{onSubmit:N,children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",htmlFor:"email",children:"Email Address"}),e.jsx("input",{id:"email",className:"form-input",type:"email",placeholder:"you@example.com",value:a,onChange:y=>n(y.target.value),required:!0})]}),l&&e.jsxs("div",{style:{padding:"0.75rem",background:"#fee2e2",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#991b1b"},children:[e.jsx(Ne,{size:20}),e.jsx("span",{style:{fontSize:"0.875rem"},children:l})]}),f&&e.jsxs("div",{style:{padding:"0.75rem",background:"#dcfce7",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#166534"},children:[e.jsx(Ce,{size:20}),e.jsx("span",{style:{fontSize:"0.875rem"},children:f})]}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:t,style:{width:"100%",justifyContent:"center"},children:t?"Sending...":"Send Reset Link"})]}),e.jsx("div",{style:{marginTop:"1.5rem",textAlign:"center"},children:e.jsx("button",{onClick:C,style:{background:"none",border:"none",color:"var(--primary)",cursor:"pointer",fontSize:"0.875rem"},children:"â† Back to Sign In"})})]})}):j?e.jsx("div",{className:"auth-container",children:e.jsxs("div",{className:"auth-box",children:[e.jsxs("div",{className:"auth-logo",children:[e.jsx(ue,{size:40,style:{color:"var(--primary)",marginBottom:"0.5rem"}}),e.jsx("h1",{className:"auth-title",children:"Resend Verification"}),e.jsx("p",{className:"auth-subtitle",children:"Enter your email to resend the verification link"})]}),e.jsxs("form",{onSubmit:k,children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",htmlFor:"email",children:"Email Address"}),e.jsx("input",{id:"email",className:"form-input",type:"email",placeholder:"you@example.com",value:a,onChange:y=>n(y.target.value),required:!0})]}),l&&e.jsxs("div",{style:{padding:"0.75rem",background:"#fee2e2",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#991b1b"},children:[e.jsx(Ne,{size:20}),e.jsx("span",{style:{fontSize:"0.875rem"},children:l})]}),f&&e.jsxs("div",{style:{padding:"0.75rem",background:"#dcfce7",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#166534"},children:[e.jsx(Ce,{size:20}),e.jsx("span",{style:{fontSize:"0.875rem"},children:f})]}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:t,style:{width:"100%",justifyContent:"center"},children:t?"Sending...":"Resend Verification Email"})]}),e.jsx("div",{style:{marginTop:"1.5rem",textAlign:"center"},children:e.jsx("button",{onClick:C,style:{background:"none",border:"none",color:"var(--primary)",cursor:"pointer",fontSize:"0.875rem"},children:"â† Back to Sign In"})})]})}):e.jsx("div",{className:"auth-container",children:e.jsxs("div",{className:"auth-box",children:[e.jsxs("div",{className:"auth-logo",children:[e.jsx("h1",{className:"auth-title",children:"AMSF001 Tracker"}),e.jsx("p",{className:"auth-subtitle",children:"Network Architecture Services Project"})]}),q&&e.jsxs("div",{style:{padding:"0.75rem",background:"#fef3c7",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#92400e",border:"1px solid #fcd34d"},children:[e.jsx(le,{size:20}),e.jsx("span",{style:{fontSize:"0.875rem"},children:"Your session has expired. Please sign in again."})]}),e.jsxs("form",{onSubmit:w,children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",htmlFor:"email",children:"Email Address"}),e.jsx("input",{id:"email",className:"form-input",type:"email",placeholder:"you@example.com",value:a,onChange:y=>n(y.target.value),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",htmlFor:"password",children:"Password"}),e.jsx("input",{id:"password",className:"form-input",type:"password",placeholder:"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢",value:o,onChange:y=>c(y.target.value),required:!0})]}),l&&e.jsxs("div",{style:{padding:"0.75rem",background:"#fee2e2",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#991b1b"},children:[e.jsx(Ne,{size:20}),e.jsx("span",{style:{fontSize:"0.875rem"},children:l})]}),f&&e.jsxs("div",{style:{padding:"0.75rem",background:"#dcfce7",borderRadius:"0.5rem",marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",color:"#166534"},children:[e.jsx(Ce,{size:20}),e.jsx("span",{style:{fontSize:"0.875rem"},children:f})]}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:t,style:{width:"100%",justifyContent:"center"},children:t?"Loading...":p?"Sign Up":"Sign In"})]}),!p&&e.jsx("div",{style:{marginTop:"1rem",textAlign:"center"},children:e.jsx("button",{onClick:()=>{u(!0),h(null),g(null),P(!1)},style:{background:"none",border:"none",color:"#64748b",cursor:"pointer",fontSize:"0.85rem",textDecoration:"underline"},children:"Forgot your password?"})}),e.jsx("div",{style:{marginTop:"1rem",textAlign:"center"},children:e.jsx("button",{onClick:()=>{b(!p),h(null),g(null),P(!1)},style:{background:"none",border:"none",color:"var(--primary)",cursor:"pointer",fontSize:"0.875rem"},children:p?"Already have an account? Sign In":"Don't have an account? Sign Up"})}),e.jsxs("div",{style:{marginTop:"1.5rem",paddingTop:"1rem",borderTop:"1px solid #e2e8f0",textAlign:"center"},children:[e.jsx("p",{style:{fontSize:"0.8rem",color:"#64748b",marginBottom:"0.5rem"},children:"Haven't received your verification email?"}),e.jsxs("button",{onClick:()=>{R(!0),h(null),g(null),P(!1)},style:{background:"none",border:"none",color:"var(--primary)",cursor:"pointer",fontSize:"0.85rem",display:"inline-flex",alignItems:"center",gap:"0.25rem"},children:[e.jsx(ue,{size:14})," Resend Verification Email"]})]})]})})}const js={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function Ns(i){return i==null?"":typeof i!="string"?String(i):i.replace(/[&<>"'`=\/]/g,r=>js[r])}function Be(i,r={}){const{maxLength:t=1e4,trim:s=!0,normalizeWhitespace:a=!0}=r;if(i==null)return"";typeof i!="string"&&(i=String(i));let n=i;return n=n.replace(/\0/g,""),n=n.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,""),s&&(n=n.trim()),a&&(n=n.replace(/[ \t]+/g," ")),n.length>t&&(n=n.substring(0,t)),n}function pe(i,r=255){return i==null?"":(typeof i!="string"&&(i=String(i)),Be(i,{maxLength:r}).replace(/[\r\n]/g," ").replace(/\s+/g," ").trim())}function wt(i,r=1e4){return i==null?"":(typeof i!="string"&&(i=String(i)),Be(i,{maxLength:r,normalizeWhitespace:!1}).replace(/\r\n/g,`
`).replace(/\r/g,`
`).replace(/\n{3,}/g,`

`).trim())}function St(i){return i?pe(i,254).toLowerCase():""}function be(i,r={}){const{min:t=-1/0,max:s=1/0,decimals:a=2}=r;if(i==null||i==="")return null;let n=String(i).replace(/[^0-9.\-]/g,""),o=parseFloat(n);return isNaN(o)?null:(o=Math.max(t,Math.min(s,o)),o=Math.round(o*Math.pow(10,a))/Math.pow(10,a),o)}function Cs(i){const r=be(i,{min:0,decimals:2});return r!==null?Math.round(r*100)/100:null}function ks(i){const r=be(i,{min:0,max:24,decimals:1});return r===null?null:Math.round(r*2)/2}function Es(i){return be(i,{min:0,max:100,decimals:1})}function Rs(i){if(!i)return null;const r=String(i).trim();return/^(javascript|data|vbscript):/i.test(r)?null:/^(https?:\/\/|\/|#)/i.test(r)?r:`https://${r}`}function Ps(i,r={}){if(!i||typeof i!="object")return i;const t={...i};for(const[s,a]of Object.entries(r)){if(t[s]===void 0)continue;const{type:n="text",maxLength:o}=a;switch(n){case"singleLine":t[s]=pe(t[s],o);break;case"multiLine":t[s]=wt(t[s],o);break;case"email":t[s]=St(t[s]);break;case"number":t[s]=be(t[s],a);break;case"currency":t[s]=Cs(t[s]);break;case"hours":t[s]=ks(t[s]);break;case"percentage":t[s]=Es(t[s]);break;case"url":t[s]=Rs(t[s]);break;case"html":t[s]=Ns(t[s]);break;default:t[s]=Be(t[s],{maxLength:o})}}return t}const Is={timesheet:{description:{type:"multiLine",maxLength:2e3},hours_worked:{type:"hours"}},expense:{reason:{type:"multiLine",maxLength:2e3},amount:{type:"currency"}},resource:{name:{type:"singleLine",maxLength:100},email:{type:"email"},role:{type:"singleLine",maxLength:100},notes:{type:"multiLine",maxLength:5e3}},partner:{name:{type:"singleLine",maxLength:200},contact_name:{type:"singleLine",maxLength:100},contact_email:{type:"email"},notes:{type:"multiLine",maxLength:5e3}},milestone:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3}},deliverable:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3}},kpi:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3},target_value:{type:"number",decimals:2},actual_value:{type:"number",decimals:2}},qualityStandard:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3},target_value:{type:"percentage"}}};function et(i,r){const t=Is[i];return t?Ps(r,t):r}class J{constructor(r,t={}){this.tableName=r,this.supportsSoftDelete=t.supportsSoftDelete!==!1,this.sanitizeConfig=t.sanitizeConfig||null}getSoftDeleteFilter(){return this.supportsSoftDelete?"is_deleted.is.null,is_deleted.eq.false":null}async getAll(r,t={}){try{let s=t.select||"*";const a=this.supportsSoftDelete&&!t.includeDeleted;a&&s!=="*"&&!s.includes("is_deleted")&&(s=`${s}, is_deleted`);let n=m.from(this.tableName).select(s).eq("project_id",r);t.filters&&Array.isArray(t.filters)&&t.filters.forEach(h=>{const{column:f,operator:g,value:p}=h;switch(g){case"eq":n=n.eq(f,p);break;case"neq":n=n.neq(f,p);break;case"gt":n=n.gt(f,p);break;case"gte":n=n.gte(f,p);break;case"lt":n=n.lt(f,p);break;case"lte":n=n.lte(f,p);break;case"like":n=n.like(f,p);break;case"ilike":n=n.ilike(f,p);break;case"in":n=n.in(f,p);break;case"is":n=n.is(f,p);break;default:n=n.eq(f,p)}}),t.orderBy&&(n=n.order(t.orderBy.column,{ascending:t.orderBy.ascending??!0}));const{data:o,error:c}=await n;if(c)throw c;let l=o||[];return a&&(l=l.filter(h=>h.is_deleted!==!0)),l}catch(s){throw s}}async getDeleted(r){if(!this.supportsSoftDelete)return[];try{const{data:t,error:s}=await m.from(this.tableName).select("*").eq("project_id",r).eq("is_deleted",!0).order("deleted_at",{ascending:!1});if(s)throw s;return t||[]}catch(t){throw t}}async getById(r,t={}){try{let s=t.select||"*";const a=this.supportsSoftDelete&&!t.includeDeleted;a&&s!=="*"&&!s.includes("is_deleted")&&(s=`${s}, is_deleted`);let n=m.from(this.tableName).select(s).eq("id",r);const{data:o,error:c}=await n.limit(1);if(c)throw c;const l=o&&o.length>0?o[0]:null;return l&&a&&l.is_deleted===!0?null:l}catch(s){throw s}}async create(r){try{if(!r.project_id)throw new Error("project_id is required");let t=r;this.sanitizeConfig&&(t=et(this.sanitizeConfig,r)),this.supportsSoftDelete&&(delete t.is_deleted,delete t.deleted_at,delete t.deleted_by);const{data:s,error:a}=await m.from(this.tableName).insert(t).select();if(a)throw a;if(!s||s.length===0)throw new Error("Failed to create record - no data returned");return s[0]}catch(t){throw t}}async update(r,t){try{let s=t;this.sanitizeConfig&&(s=et(this.sanitizeConfig,t));const a={...s,updated_at:new Date().toISOString()};delete a.is_deleted,delete a.deleted_at,delete a.deleted_by;const{data:n,error:o}=await m.from(this.tableName).update(a).eq("id",r).select();if(o)throw o;if(!n||n.length===0)throw new Error(`No record found with id: ${r}`);return n[0]}catch(s){throw s}}async delete(r,t=null){try{if(this.supportsSoftDelete){const{error:s}=await m.from(this.tableName).update({is_deleted:!0,deleted_at:new Date().toISOString(),deleted_by:t}).eq("id",r);if(s)throw s}else{const{error:s}=await m.from(this.tableName).delete().eq("id",r);if(s)throw s}return!0}catch(s){throw s}}async hardDelete(r){try{const{error:t}=await m.from(this.tableName).delete().eq("id",r);if(t)throw t;return!0}catch(t){throw t}}async restore(r){if(!this.supportsSoftDelete)throw new Error("This entity does not support soft delete");try{const{data:t,error:s}=await m.from(this.tableName).update({is_deleted:!1,deleted_at:null,deleted_by:null}).eq("id",r).select();if(s)throw s;if(!t||t.length===0)throw new Error(`No record found with id: ${r}`);return t[0]}catch(t){throw t}}async exists(r){try{const{data:t,error:s}=await m.from(this.tableName).select("id, is_deleted").eq("id",r).limit(1);if(s)throw s;if(!t||t.length===0)return!1;const a=t[0];return!(this.supportsSoftDelete&&a.is_deleted===!0)}catch(t){throw t}}async count(r,t=[]){try{let s=m.from(this.tableName).select("id, is_deleted").eq("project_id",r);t.forEach(c=>{const{column:l,operator:h,value:f}=c;h==="eq"?s=s.eq(l,f):h==="in"&&(s=s.in(l,f))});const{data:a,error:n}=await s;if(n)throw n;let o=a||[];return this.supportsSoftDelete&&(o=o.filter(c=>c.is_deleted!==!0)),o.length}catch(s){throw s}}}class As extends J{constructor(){super("partners")}async getAll(r){return super.getAll(r,{orderBy:{column:"name",ascending:!0}})}async getActive(r){return super.getAll(r,{filters:[{column:"is_active",operator:"eq",value:!0}],orderBy:{column:"name",ascending:!0}})}async getWithResources(r){try{const{data:t,error:s}=await m.from("partners").select(`
          *,
          resources (
            id,
            name,
            daily_rate,
            cost_price,
            is_active
          )
        `).eq("id",r).limit(1);if(s)throw s;return t?.[0]||null}catch(t){throw t}}async getSummary(r){try{const{data:t,error:s}=await m.from("partners").select(`
          id,
          name,
          contact_name,
          contact_email,
          payment_terms,
          is_active,
          created_at
        `).eq("project_id",r).order("name",{ascending:!0});if(s)throw s;return t||[]}catch(t){throw t}}async create(r){if(!r.name?.trim())throw new Error("Partner name is required");if(await this.findByName(r.project_id,r.name))throw new Error(`Partner "${r.name}" already exists`);return super.create({...r,name:r.name.trim(),is_active:r.is_active??!0,payment_terms:r.payment_terms||"Net 30"})}async findByName(r,t){try{const{data:s,error:a}=await m.from("partners").select("*").eq("project_id",r).ilike("name",t.trim()).limit(1);if(a)throw a;return s?.[0]||null}catch(s){throw s}}async toggleActive(r){const t=await this.getById(r);if(!t)throw new Error("Partner not found");return this.update(r,{is_active:!t.is_active})}async getForSelect(r,t=!0){return(t?await this.getActive(r):await this.getAll(r)).map(a=>({value:a.id,label:a.name}))}async getDependencyCounts(r){try{const{data:t,error:s}=await m.from("resources").select("id").eq("partner_id",r).or("is_deleted.is.null,is_deleted.eq.false");if(s)throw s;const a=t?.map(h=>h.id)||[];let n=0,o=0;if(a.length>0){const{count:h,error:f}=await m.from("timesheets").select("*",{count:"exact",head:!0}).in("resource_id",a).or("is_deleted.is.null,is_deleted.eq.false");if(f)throw f;n=h||0;const{count:g,error:p}=await m.from("expenses").select("*",{count:"exact",head:!0}).in("resource_id",a).or("is_deleted.is.null,is_deleted.eq.false");if(p)throw p;o=g||0}const{count:c,error:l}=await m.from("partner_invoices").select("*",{count:"exact",head:!0}).eq("partner_id",r).or("is_deleted.is.null,is_deleted.eq.false");if(l)throw l;return{resourceCount:t?.length||0,timesheetCount:n,expenseCount:o,invoiceCount:c||0,canDelete:!t?.length&&!c}}catch(t){throw t}}}const va=new As;class Ms extends J{constructor(){super("resources",{sanitizeConfig:"resource",supportsSoftDelete:!0})}sanitizeData(r){const t={...r};return t.name&&(t.name=pe(t.name,100)),t.role&&(t.role=pe(t.role,100)),t.email&&(t.email=St(t.email)),t.notes&&(t.notes=wt(t.notes,5e3)),t}async getAll(r,t={}){const{includePartner:s=!0,activeOnly:a=!1,showTestUsers:n=!0,includeDeleted:o=!1}=t;let c="*";s&&(c="*, partner:partners(id, name, is_active)");let l=m.from(this.tableName).select(c).eq("project_id",r).order("name");o||(l=l.or("is_deleted.is.null,is_deleted.eq.false")),a&&(l=l.eq("is_active",!0)),n||(l=l.or("is_test_content.is.null,is_test_content.eq.false"));const{data:h,error:f}=await l;if(f)throw f;return h||[]}async getAllFiltered(r,t=!0){return this.getAll(r,{showTestUsers:t,includePartner:!0})}async getById(r){const{data:t,error:s}=await m.from(this.tableName).select("*, partner:partners(id, name, contact_name, contact_email, is_active)").eq("id",r).or("is_deleted.is.null,is_deleted.eq.false").single();if(s)throw s;return t}async getByType(r,t){const{data:s,error:a}=await m.from(this.tableName).select("*, partner:partners(id, name)").eq("project_id",r).eq("resource_type",t).or("is_deleted.is.null,is_deleted.eq.false").order("name");if(a)throw a;return s||[]}async getByPartner(r){const{data:t,error:s}=await m.from(this.tableName).select("*").eq("partner_id",r).or("is_deleted.is.null,is_deleted.eq.false").order("name");if(s)throw s;return t||[]}async getWithTimesheetSummary(r){const t=await this.getById(r);if(!t)return null;const{data:s,error:a}=await m.from("timesheets").select("id, hours_worked, hours, status, was_rejected, date").eq("resource_id",r).or("is_deleted.is.null,is_deleted.eq.false");let n=0,o=0,c=0;return s&&s.forEach(l=>{const h=parseFloat(l.hours_worked||l.hours||0);n+=h,l.status==="Approved"?o+=h:l.status==="Submitted"&&!l.was_rejected&&(c+=h)}),{...t,timesheetSummary:{totalEntries:s?.length||0,totalHours:n,approvedHours:o,pendingHours:c,daysWorked:n/8}}}async create(r){const t=this.sanitizeData(r);if(!t.name?.trim())throw new Error("Resource name is required");if(!t.project_id)throw new Error("Project ID is required");if(!t.email?.trim())throw new Error("Email is required");t.resource_type==="internal"&&(t.partner_id=null);const{data:s,error:a}=await m.from(this.tableName).insert([t]).select("*, partner:partners(id, name)").single();if(a)throw a;return s}async update(r,t){const s=this.sanitizeData(t);s.resource_type==="internal"&&(s.partner_id=null),s.updated_at=new Date().toISOString();const{data:a,error:n}=await m.from(this.tableName).update(s).eq("id",r).select("*, partner:partners(id, name)").single();if(n)throw n;return a}async delete(r,t=null){const{data:s,error:a}=await m.from(this.tableName).update({is_deleted:!0,deleted_at:new Date().toISOString(),deleted_by:t}).eq("id",r).select().single();if(a)throw a;return s}async restore(r){const{data:t,error:s}=await m.from(this.tableName).update({is_deleted:!1,deleted_at:null,deleted_by:null}).eq("id",r).select().single();if(s)throw s;return t}async linkToPartner(r,t){const s={partner_id:t,resource_type:t?"third_party":"internal",updated_at:new Date().toISOString()};return this.update(r,s)}async toggleActive(r){const t=await this.getById(r);if(!t)throw new Error("Resource not found");return this.update(r,{is_active:!t.is_active})}async getForSelect(r){const{data:t,error:s}=await m.from(this.tableName).select("id, name, resource_type, role").eq("project_id",r).or("is_deleted.is.null,is_deleted.eq.false").order("name");if(s)throw s;return t||[]}calculateMargin(r,t){if(!r||r===0||!t)return{percent:null,amount:null,status:"unknown"};const s=(r-t)/r*100,a=r-t;let n="critical";return s>=25?n="good":s>=10&&(n="low"),{percent:s,amount:a,status:n}}async getUtilization(r){const t=await this.getWithTimesheetSummary(r);if(!t)return null;const s=t.days_allocated||0,a=t.timesheetSummary.daysWorked,n=Math.max(0,s-a),o=s>0?a/s*100:0;return{resourceId:r,resourceName:t.name,daysAllocated:s,daysUsed:a,remaining:n,utilizationPercent:o,totalValue:(t.daily_rate||0)*s,valueUsed:(t.daily_rate||0)*a}}async getSummary(r){const t=await this.getAll(r,{includePartner:!1});return{total:t.length,internal:t.filter(s=>s.resource_type==="internal").length,thirdParty:t.filter(s=>s.resource_type==="third_party").length,active:t.filter(s=>s.is_active).length,totalBudget:t.reduce((s,a)=>s+(a.daily_rate||0)*(a.days_allocated||0),0)}}async getProfileByEmail(r){try{const{data:t,error:s}=await this.supabase.from("profiles").select("id, email, full_name, role").eq("email",r).single();if(s){if(s.code==="PGRST116")return null;throw s}return t}catch(t){throw t}}async getAllWithTestFilter(r,t=[]){try{const s=await this.getAll(r,{orderBy:{column:"name",ascending:!0}});return t&&t.length>0?s.filter(a=>!a.user_id||!t.includes(a.user_id)):s}catch(s){throw s}}async getDependencyCounts(r){try{const[t,s]=await Promise.all([this.supabase.from("timesheets").select("id",{count:"exact",head:!0}).eq("resource_id",r).or("is_deleted.is.null,is_deleted.eq.false"),this.supabase.from("expenses").select("id",{count:"exact",head:!0}).eq("resource_id",r).or("is_deleted.is.null,is_deleted.eq.false")]);return{timesheetCount:t.count||0,expenseCount:s.count||0,canDelete:(t.count||0)===0&&(s.count||0)===0}}catch(t){throw t}}}const wa=new Ms;class Ds extends J{constructor(){super("timesheets",{supportsSoftDelete:!0,sanitizeConfig:"timesheet"})}async getAll(r,t={}){return super.getAll(r,{...t,select:t.select||`
      *,
      resources(id, name, email, daily_rate, cost_price),
      milestones(id, milestone_ref, name)
    `,orderBy:t.orderBy||{column:"date",ascending:!1}})}async getAllFiltered(r,t=!1){try{let s=m.from(this.tableName).select(`
          *,
          resources(id, name, email, daily_rate, cost_price),
          milestones(id, milestone_ref, name)
        `).eq("project_id",r).order("date",{ascending:!1});this.supportsSoftDelete&&(s=s.or(this.getSoftDeleteFilter())),t||(s=s.or("is_test_content.is.null,is_test_content.eq.false"));const{data:a,error:n}=await s;if(n)throw n;return a||[]}catch(s){throw s}}async getByResource(r,t={}){try{let s=m.from(this.tableName).select("*, milestones(id, milestone_ref, name)").eq("resource_id",r).order("date",{ascending:!1});this.supportsSoftDelete&&(s=s.or(this.getSoftDeleteFilter())),t.start&&(s=s.gte("date",t.start)),t.end&&(s=s.lte("date",t.end)),t.status&&(s=s.eq("status",t.status));const{data:a,error:n}=await s;if(n)throw n;return a||[]}catch(s){throw s}}async getByPartner(r,t={}){try{const{data:s}=await m.from("resources").select("id, name, cost_price").eq("partner_id",r).or("is_deleted.is.null,is_deleted.eq.false");if(!s||s.length===0)return[];const a=s.map(l=>l.id);let n=m.from(this.tableName).select("*, resources(id, name, cost_price), milestones(id, milestone_ref, name)").in("resource_id",a).order("date",{ascending:!1});this.supportsSoftDelete&&(n=n.or(this.getSoftDeleteFilter())),t.start&&(n=n.gte("date",t.start)),t.end&&(n=n.lte("date",t.end)),t.status&&(n=n.eq("status",t.status));const{data:o,error:c}=await n;if(c)throw c;return o||[]}catch(s){throw s}}async getApprovedForInvoice(r,t){if(!t.start||!t.end)throw new Error("Date range (start and end) is required for invoice queries");return this.getByPartner(r,{...t,status:"Approved"})}async getSummary(r,t={}){try{const s=await this.getAll(r,t),a={totalHours:0,totalDays:0,approvedHours:0,pendingHours:0,draftHours:0,rejectedHours:0,totalCost:0,approvedCost:0,byStatus:{Draft:{count:0,hours:0},Submitted:{count:0,hours:0},Approved:{count:0,hours:0},Rejected:{count:0,hours:0}},byMilestone:{},count:s.length};return s.forEach(n=>{const o=parseFloat(n.hours_worked||n.hours||0),c=n.resources?.cost_price||0,l=o/8*c;switch(a.totalHours+=o,a.totalCost+=l,a.byStatus[n.status]&&(a.byStatus[n.status].count++,a.byStatus[n.status].hours+=o),n.status){case"Approved":a.approvedHours+=o,a.approvedCost+=l;break;case"Submitted":n.was_rejected||(a.pendingHours+=o);break;case"Draft":a.draftHours+=o;break;case"Rejected":a.rejectedHours+=o;break}if(n.milestone_id){const h=n.milestones?.milestone_ref||"Unknown";a.byMilestone[n.milestone_id]||(a.byMilestone[n.milestone_id]={ref:h,name:n.milestones?.name||"Unknown",hours:0,cost:0}),a.byMilestone[n.milestone_id].hours+=o,a.byMilestone[n.milestone_id].cost+=l}}),a.totalDays=a.totalHours/8,a}catch(s){throw s}}async create(r){if(!r.resource_id)throw new Error("resource_id is required");if(!r.date)throw new Error("date is required");const t=parseFloat(r.hours_worked||r.hours||0);if(!t||t<=0)throw new Error("hours must be greater than 0");const s={...r,hours_worked:t,hours:t,date:r.date||r.work_date,work_date:r.work_date||r.date,description:r.description||r.comments||"",comments:r.comments||r.description||"",status:r.status||"Draft"};return super.create(s)}async submit(r){return this.update(r,{status:"Submitted"})}async validate(r){return this.update(r,{status:"Approved"})}async approve(r){return this.validate(r)}async reject(r,t=null){const s={status:"Rejected",was_rejected:!0};return t&&(s.rejection_reason=t),this.update(r,s)}calculateCost(r,t){return r/8*t}calculateBillable(r,t){return r/8*t}}const Sa=new Ds;class Ts extends J{constructor(){super("expenses",{supportsSoftDelete:!0,sanitizeConfig:"expense"})}async getAll(r,t={}){return super.getAll(r,{...t,select:t.select||"*, expense_files(*)",orderBy:t.orderBy||{column:"expense_date",ascending:!1}})}async getAllFiltered(r,t=!1){try{let s=m.from(this.tableName).select("*, expense_files(*), is_deleted, is_test_content").eq("project_id",r).order("expense_date",{ascending:!1});const{data:a,error:n}=await s;if(n)throw n;let o=a||[];return this.supportsSoftDelete&&(o=o.filter(c=>c.is_deleted!==!0)),t||(o=o.filter(c=>c.is_test_content!==!0)),o}catch(s){throw s}}async getByResource(r,t={}){try{let s=m.from(this.tableName).select("*, expense_files(*), is_deleted").eq("resource_id",r).order("expense_date",{ascending:!1});t.start&&(s=s.gte("expense_date",t.start)),t.end&&(s=s.lte("expense_date",t.end));const{data:a,error:n}=await s;if(n)throw n;let o=a||[];return this.supportsSoftDelete&&(o=o.filter(c=>c.is_deleted!==!0)),o}catch(s){throw s}}async getByPartner(r,t={}){try{const{data:s}=await m.from("resources").select("id").eq("partner_id",r);if(!s||s.length===0)return[];const a=s.map(h=>h.id);let n=m.from(this.tableName).select("*, expense_files(*), is_deleted").in("resource_id",a).order("expense_date",{ascending:!1});t.start&&(n=n.gte("expense_date",t.start)),t.end&&(n=n.lte("expense_date",t.end)),t.procurementMethod&&(n=n.eq("procurement_method",t.procurementMethod));const{data:o,error:c}=await n;if(c)throw c;let l=o||[];return this.supportsSoftDelete&&(l=l.filter(h=>h.is_deleted!==!0)),l}catch(s){throw s}}async getPartnerProcuredForInvoice(r,t){if(!t.start||!t.end)throw new Error("Date range (start and end) is required for invoice queries");return this.getByPartner(r,{...t,procurementMethod:"partner"})}async getSummary(r,t={}){try{const s=await this.getAll(r,t),a={total:0,chargeable:0,nonChargeable:0,supplierProcured:0,partnerProcured:0,byCategory:{Travel:0,Accommodation:0,Sustenance:0},byStatus:{Draft:0,Submitted:0,Approved:0,Rejected:0,Paid:0},count:s.length};return s.forEach(n=>{const o=parseFloat(n.amount||0);a.total+=o,n.chargeable_to_customer!==!1?a.chargeable+=o:a.nonChargeable+=o,n.procurement_method==="partner"?a.partnerProcured+=o:a.supplierProcured+=o,a.byCategory[n.category]!==void 0&&(a.byCategory[n.category]+=o),a.byStatus[n.status]!==void 0&&(a.byStatus[n.status]+=o)}),a}catch(s){throw s}}async create(r){if(!r.resource_id)throw new Error("resource_id is required");if(!r.category)throw new Error("category is required");if(!r.amount||r.amount<=0)throw new Error("amount must be greater than 0");const t={...r,status:r.status||"Draft",chargeable_to_customer:r.chargeable_to_customer??!0,procurement_method:r.procurement_method||"supplier"};return super.create(t)}async createMany(r){if(!r||r.length===0)return[];try{const t=r.map(n=>{if(!n.resource_id)throw new Error("resource_id is required for all expenses");if(!n.category)throw new Error("category is required for all expenses");if(!n.amount||n.amount<=0)throw new Error("amount must be greater than 0 for all expenses");return{...n,status:n.status||"Draft",chargeable_to_customer:n.chargeable_to_customer??!0,procurement_method:n.procurement_method||"supplier"}}),{data:s,error:a}=await m.from(this.tableName).insert(t).select();if(a)throw a;return s||[]}catch(t){throw t}}async submit(r){return this.update(r,{status:"Submitted"})}async validate(r){return this.update(r,{status:"Approved"})}async approve(r){return this.validate(r)}async reject(r,t=null){const s={status:"Rejected"};return t&&(s.rejection_reason=t),this.update(r,s)}async markPaid(r){return this.update(r,{status:"Paid"})}async uploadReceipt(r,t,s){try{const a=`${r}/${Date.now()}-${t.name}`,{error:n}=await m.storage.from("receipts").upload(a,t);if(n)throw n;const{data:o,error:c}=await m.from("expense_files").insert({expense_id:r,file_name:t.name,file_path:a,file_size:t.size,file_type:t.type,uploaded_by:s}).select();if(c)throw c;return o?.[0]}catch(a){throw a}}async downloadReceipt(r){try{const{data:t,error:s}=await m.storage.from("receipts").download(r);if(s)throw s;return t}catch(t){throw t}}}const ja=new Ts;class qs extends J{constructor(){super("partner_invoices")}async getAll(r,t={}){return super.getAll(r,{...t,select:t.select||"*, partners(name)",orderBy:t.orderBy||{column:"invoice_date",ascending:!1}})}async getByPartner(r,t={}){try{let s=m.from(this.tableName).select("*").eq("partner_id",r).order("invoice_date",{ascending:!1});t.status&&(s=s.eq("status",t.status));const{data:a,error:n}=await s;if(n)throw n;return a||[]}catch(s){throw s}}async getWithLines(r){try{const{data:t,error:s}=await m.from(this.tableName).select("*, partners(name, contact_name, contact_email, payment_terms)").eq("id",r).limit(1);if(s)throw s;const a=t?.[0];if(!a)return null;const{data:n,error:o}=await m.from("partner_invoice_lines").select("*").eq("invoice_id",r).order("line_type",{ascending:!0}).order("resource_name",{ascending:!0}).order("line_date",{ascending:!0});if(o)throw o;const c={timesheets:(n||[]).filter(l=>l.line_type==="timesheet"),supplierExpenses:(n||[]).filter(l=>l.line_type==="supplier_expense"),partnerExpenses:(n||[]).filter(l=>l.line_type==="expense")};return{...a,lines:n||[],groupedLines:c}}catch(t){throw t}}async generateInvoiceNumber(r){try{const s=`INV-${new Date().getFullYear()}-`,{data:a,error:n}=await m.from(this.tableName).select("invoice_number").eq("project_id",r).like("invoice_number",`${s}%`).order("invoice_number",{ascending:!1}).limit(1);if(n)throw n;let o=1;if(a&&a.length>0){const c=a[0].invoice_number,l=parseInt(c.replace(s,""),10);isNaN(l)||(o=l+1)}return`${s}${String(o).padStart(3,"0")}`}catch(t){throw t}}async generateInvoice(r){const{projectId:t,partnerId:s,periodStart:a,periodEnd:n,createdBy:o,notes:c,includeSubmitted:l=!0}=r;try{const{data:h,error:f}=await m.from("resources").select("id, name, cost_price").eq("partner_id",s);if(f)throw f;if(!h||h.length===0)throw new Error("No resources linked to this partner");const g=h.map(S=>S.id),p={};h.forEach(S=>{p[S.id]=S});const b=l?["Approved","Submitted"]:["Approved"],{data:_,error:u}=await m.from("timesheets").select("id, date, hours_worked, hours, status, resource_id").in("resource_id",g).gte("date",a).lte("date",n).in("status",b);if(u)throw u;const{data:j,error:R}=await m.from("expenses").select("id, expense_date, category, reason, amount, resource_id, resource_name, procurement_method, chargeable_to_customer, status").in("resource_id",g).gte("expense_date",a).lte("expense_date",n).in("status",["Approved","Submitted","Paid"]);if(R)throw R;const q=(j||[]).filter(S=>S.procurement_method==="partner"||!S.procurement_method),P=(j||[]).filter(S=>S.procurement_method==="supplier");let w=0,N=0;const k=[],C={};(_||[]).forEach(S=>{C[S.resource_id]||(C[S.resource_id]=[]),C[S.resource_id].push(S)}),Object.keys(C).forEach(S=>{const L=p[S];C[S].forEach(V=>{const ce=parseFloat(V.hours_worked||V.hours||0),_e=L?.cost_price||0,Ue=ce/8,ve=Ue*_e;w+=ve,N+=ve,k.push({line_type:"timesheet",timesheet_id:V.id,expense_id:null,description:`${L?.name||"Unknown"} - ${ce}h (${Ue.toFixed(2)} days)`,quantity:ce,unit_price:_e,line_total:ve,resource_name:L?.name,line_date:V.date,hours:ce,cost_price:_e,source_status:V.status,chargeable_to_customer:!0,procurement_method:null,expense_category:null})})});let y=0,v=0,A=0;const M=[];q.forEach(S=>{const L=parseFloat(S.amount||0);y+=L,S.chargeable_to_customer?v+=L:A+=L,M.push({line_type:"expense",timesheet_id:null,expense_id:S.id,description:`${S.resource_name} - ${S.category}: ${S.reason}`,quantity:1,unit_price:L,line_total:L,resource_name:S.resource_name,line_date:S.expense_date,hours:null,cost_price:null,source_status:S.status,chargeable_to_customer:S.chargeable_to_customer,procurement_method:"partner",expense_category:S.category})});let I=0,U=0,X=0;const ae=[];P.forEach(S=>{const L=parseFloat(S.amount||0);I+=L,S.chargeable_to_customer?U+=L:X+=L,ae.push({line_type:"supplier_expense",timesheet_id:null,expense_id:S.id,description:`${S.resource_name} - ${S.category}: ${S.reason}`,quantity:1,unit_price:L,line_total:L,resource_name:S.resource_name,line_date:S.expense_date,hours:null,cost_price:null,source_status:S.status,chargeable_to_customer:S.chargeable_to_customer,procurement_method:"supplier",expense_category:S.category})});const E=w+y,$=N+v+U,ee=A+X,Z=await this.generateInvoiceNumber(t),{data:W,error:F}=await m.from(this.tableName).insert({project_id:t,partner_id:s,invoice_number:Z,invoice_date:new Date().toISOString().split("T")[0],period_start:a,period_end:n,timesheet_total:w,expense_total:y,supplier_expense_total:I,invoice_total:E,chargeable_total:$,non_chargeable_total:ee,status:"Draft",notes:c||null,created_by:o}).select().single();if(F)throw F;const D=[...k,...M,...ae].map(S=>({...S,invoice_id:W.id}));if(D.length>0){const{error:S}=await m.from("partner_invoice_lines").insert(D);if(S)throw S}return this.getWithLines(W.id)}catch(h){throw h}}async updateStatus(r,t){const s={status:t};return t==="Sent"?s.sent_at=new Date().toISOString():t==="Paid"&&(s.paid_at=new Date().toISOString()),this.update(r,s)}async markSent(r){return this.updateStatus(r,"Sent")}async markPaid(r){return this.updateStatus(r,"Paid")}async cancel(r){return this.updateStatus(r,"Cancelled")}async getPartnerStats(r){try{const{data:t,error:s}=await m.from(this.tableName).select("status, invoice_total").eq("partner_id",r);if(s)throw s;const a={total:0,draft:0,sent:0,paid:0,cancelled:0,count:t?.length||0};return(t||[]).forEach(n=>{const o=parseFloat(n.invoice_total||0);switch(a.total+=o,n.status){case"Draft":a.draft+=o;break;case"Sent":a.sent+=o;break;case"Paid":a.paid+=o;break;case"Cancelled":a.cancelled+=o;break}}),a}catch(t){throw t}}}const Na=new qs;class Os extends J{constructor(){super("milestones",{supportsSoftDelete:!0,sanitizeConfig:"milestone"})}async getAllWithStats(r){try{const t=await this.getAll(r,{orderBy:{column:"start_date",ascending:!0}}),{data:s}=await m.from("timesheets").select("milestone_id, hours_worked").eq("project_id",r).not("milestone_id","is",null).or("is_deleted.is.null,is_deleted.eq.false"),a={};return(s||[]).forEach(n=>{a[n.milestone_id]||(a[n.milestone_id]=0),a[n.milestone_id]+=parseFloat(n.hours_worked||0)}),t.map(n=>({...n,logged_hours:a[n.id]||0,logged_days:(a[n.id]||0)/8}))}catch(t){throw t}}async getWithDeliverables(r){try{const{data:t,error:s}=await m.from(this.tableName).select("*").eq("id",r).or(this.getSoftDeleteFilter()).limit(1);if(s)throw s;const a=t?.[0],{data:n,error:o}=await m.from("deliverables").select("*").eq("milestone_id",r).or("is_deleted.is.null,is_deleted.eq.false").order("due_date",{ascending:!0});if(o)throw o;return{...a,deliverables:n||[]}}catch(t){throw t}}async getByStatus(r,t){return this.getAll(r,{filters:[{column:"status",operator:"eq",value:t}],orderBy:{column:"start_date",ascending:!0}})}async getUpcoming(r,t=30){try{const s=new Date().toISOString().split("T")[0],a=new Date;a.setDate(a.getDate()+t);const n=a.toISOString().split("T")[0];let o=m.from(this.tableName).select("*").eq("project_id",r).gte("end_date",s).lte("end_date",n).neq("status","Completed").order("end_date",{ascending:!0});this.supportsSoftDelete&&(o=o.or(this.getSoftDeleteFilter()));const{data:c,error:l}=await o;if(l)throw l;return c||[]}catch(s){throw s}}async updateStatus(r,t){return this.update(r,{status:t})}async updateCompletion(r,t){const s={completion_percentage:t};return t>=100&&(s.status="Completed"),this.update(r,s)}async getSummary(r){try{const t=await this.getAll(r),s={total:t.length,completed:0,inProgress:0,notStarted:0,overdue:0,upcoming:0},a=new Date().toISOString().split("T")[0],n=new Date;n.setDate(n.getDate()+7);const o=n.toISOString().split("T")[0];return t.forEach(c=>{c.status==="Completed"?s.completed++:c.status==="In Progress"?(s.inProgress++,c.end_date<a&&s.overdue++):c.status==="Not Started"&&(s.notStarted++,c.start_date<=o&&s.upcoming++)}),s}catch(t){throw t}}async getCertificates(r){try{const{data:t,error:s}=await m.from("milestone_certificates").select("*").eq("project_id",r).order("created_at",{ascending:!1});if(s)throw s;return t||[]}catch(t){throw t}}async createCertificate(r){try{const{data:t,error:s}=await m.from("milestone_certificates").insert([r]).select();if(s)throw s;return t?.[0]}catch(t){throw t}}async updateCertificate(r,t){try{const{data:s,error:a}=await m.from("milestone_certificates").update(t).eq("id",r).select();if(a)throw a;return s?.[0]}catch(s){throw s}}}const Ca=new Os;class Ls extends J{constructor(){super("deliverables",{supportsSoftDelete:!0,sanitizeConfig:"deliverable"})}async getAllWithMilestones(r){return this.getAll(r,{select:"*, milestones(name, milestone_ref)",orderBy:{column:"due_date",ascending:!0}})}async getByMilestone(r){try{let t=m.from(this.tableName).select("*").eq("milestone_id",r).order("due_date",{ascending:!0});this.supportsSoftDelete&&(t=t.or(this.getSoftDeleteFilter()));const{data:s,error:a}=await t;if(a)throw a;return s||[]}catch(t){throw t}}async getByStatus(r,t){return this.getAll(r,{filters:[{column:"status",operator:"eq",value:t}],orderBy:{column:"due_date",ascending:!0}})}async getOverdue(r){try{const t=new Date().toISOString().split("T")[0];let s=m.from(this.tableName).select("*, milestones(name)").eq("project_id",r).lt("due_date",t).not("status","in",'("Delivered","Cancelled")').order("due_date",{ascending:!0});this.supportsSoftDelete&&(s=s.or(this.getSoftDeleteFilter()));const{data:a,error:n}=await s;if(n)throw n;return a||[]}catch(t){throw t}}async getUpcoming(r,t=14){try{const s=new Date().toISOString().split("T")[0],a=new Date;a.setDate(a.getDate()+t);const n=a.toISOString().split("T")[0];let o=m.from(this.tableName).select("*, milestones(name)").eq("project_id",r).gte("due_date",s).lte("due_date",n).not("status","eq","Delivered").order("due_date",{ascending:!0});this.supportsSoftDelete&&(o=o.or(this.getSoftDeleteFilter()));const{data:c,error:l}=await o;if(l)throw l;return c||[]}catch(s){throw s}}async updateStatus(r,t,s){const a={status:t};return t==="Submitted"?(a.submitted_date=new Date().toISOString(),a.submitted_by=s):t==="Delivered"&&(a.delivered_date=new Date().toISOString(),a.delivered_by=s),this.update(r,a)}async submit(r,t){return this.updateStatus(r,"Submitted",t)}async markDelivered(r,t){return this.updateStatus(r,"Delivered",t)}async reject(r,t){return this.update(r,{status:"Rejected",rejection_reason:t})}async getSummary(r){try{const t=await this.getAll(r),s=new Date().toISOString().split("T")[0],a={total:t.length,delivered:0,inProgress:0,notStarted:0,overdue:0,dueThisWeek:0},n=new Date;n.setDate(n.getDate()+7);const o=n.toISOString().split("T")[0];return t.forEach(c=>{c.status==="Delivered"?a.delivered++:c.status==="In Progress"?(a.inProgress++,c.due_date<s?a.overdue++:c.due_date<=o&&a.dueThisWeek++):(c.status==="Not Started"||c.status==="Draft")&&(a.notStarted++,c.due_date<s&&a.overdue++)}),a}catch(t){throw t}}async getAllWithRelations(r,t=!1){try{let s=m.from("deliverables").select(`
          *,
          milestones(milestone_ref, name),
          deliverable_kpis(kpi_id, kpis(kpi_ref, name)),
          deliverable_quality_standards(quality_standard_id, quality_standards(qs_ref, name))
        `).eq("project_id",r).or("is_deleted.is.null,is_deleted.eq.false").order("deliverable_ref");t||(s=s.or("is_test_content.is.null,is_test_content.eq.false"));const{data:a,error:n}=await s;if(n)throw n;return a||[]}catch(s){throw s}}async syncKPILinks(r,t=[]){try{const{error:s}=await m.from("deliverable_kpis").delete().eq("deliverable_id",r);if(s)throw s;if(t.length>0){const a=t.map(o=>({deliverable_id:r,kpi_id:o})),{error:n}=await m.from("deliverable_kpis").insert(a);if(n)throw n}return!0}catch(s){throw s}}async syncQSLinks(r,t=[]){try{const{error:s}=await m.from("deliverable_quality_standards").delete().eq("deliverable_id",r);if(s)throw s;if(t.length>0){const a=t.map(o=>({deliverable_id:r,quality_standard_id:o})),{error:n}=await m.from("deliverable_quality_standards").insert(a);if(n)throw n}return!0}catch(s){throw s}}async upsertKPIAssessments(r,t,s){try{const a=t.map(o=>({deliverable_id:r,kpi_id:o.kpiId,criteria_met:o.criteriaMet,assessed_at:new Date().toISOString(),assessed_by:s})),{error:n}=await m.from("deliverable_kpi_assessments").upsert(a,{onConflict:"deliverable_id,kpi_id"});if(n)throw n;return!0}catch(a){throw a}}async upsertQSAssessments(r,t,s){try{const a=t.map(o=>({deliverable_id:r,quality_standard_id:o.qsId,criteria_met:o.criteriaMet,assessed_at:new Date().toISOString(),assessed_by:s})),{error:n}=await m.from("deliverable_qs_assessments").upsert(a,{onConflict:"deliverable_id,quality_standard_id"});if(n)throw n;return!0}catch(a){throw a}}}const ka=new Ls;class zs extends J{constructor(){super("kpis")}async getAllWithStatus(r){try{return(await this.getAll(r,{orderBy:{column:"name",ascending:!0}})).map(s=>({...s,rag_status:this.calculateRAG(s)}))}catch(t){throw t}}calculateRAG(r){if(!r.target_value||r.actual_value===null||r.actual_value===void 0)return"Unknown";const t=parseFloat(r.actual_value),s=parseFloat(r.target_value),a=parseFloat(r.threshold_amber||10);return r.trend==="higher_better"?t>=s?"Green":t>=s*(1-a/100)?"Amber":"Red":t<=s?"Green":t<=s*(1+a/100)?"Amber":"Red"}async getByRAGStatus(r,t){try{return(await this.getAllWithStatus(r)).filter(a=>a.rag_status===t)}catch(s){throw s}}async getNeedingAttention(r){try{return(await this.getAllWithStatus(r)).filter(s=>s.rag_status==="Amber"||s.rag_status==="Red")}catch(t){throw t}}async updateActualValue(r,t){return this.update(r,{actual_value:t,last_updated:new Date().toISOString()})}async getHistory(r,t=12){try{const{data:s,error:a}=await m.from("kpi_history").select("*").eq("kpi_id",r).order("recorded_at",{ascending:!1}).limit(t);if(a)throw a;return s||[]}catch{return[]}}async getSummary(r){try{const t=await this.getAllWithStatus(r);return{total:t.length,green:t.filter(s=>s.rag_status==="Green").length,amber:t.filter(s=>s.rag_status==="Amber").length,red:t.filter(s=>s.rag_status==="Red").length,unknown:t.filter(s=>s.rag_status==="Unknown").length}}catch(t){throw t}}async getAssessments(r){try{const{data:t,error:s}=await m.from("deliverable_kpi_assessments").select(`
          kpi_id,
          criteria_met,
          deliverables!inner(id, status, is_deleted, project_id)
        `).eq("deliverables.project_id",r);return s?await this.getAssessmentsFallback(r):(t||[]).filter(n=>n.deliverables?.is_deleted!==!0&&H.deliverables.contributeToKPIs.includes(n.deliverables?.status))}catch{return[]}}async getAssessmentsFallback(r){try{const{data:t,error:s}=await m.from("deliverable_kpi_assessments").select("kpi_id, criteria_met, deliverable_id");if(s)throw s;const{data:a,error:n}=await m.from("deliverables").select("id, status, is_deleted").eq("project_id",r);if(n)throw n;const o=new Set((a||[]).filter(l=>l.is_deleted!==!0&&H.deliverables.contributeToKPIs.includes(l.status)).map(l=>l.id));return(t||[]).filter(l=>o.has(l.deliverable_id))}catch{return[]}}}const Ea=new zs;class Bs extends J{constructor(){super("quality_standards")}async getAllWithStatus(r){try{return(await this.getAll(r,{orderBy:{column:"name",ascending:!0}})).map(s=>({...s,compliance_status:this.calculateCompliance(s)}))}catch(t){throw t}}calculateCompliance(r){if(r.actual_value===null||r.actual_value===void 0)return"Not Measured";const t=parseFloat(r.actual_value),s=parseFloat(r.target_value||0);return t>=s?"Compliant":t>=s*.9?"Near Compliant":"Non-Compliant"}async getNonCompliant(r){try{return(await this.getAllWithStatus(r)).filter(s=>s.compliance_status==="Non-Compliant")}catch(t){throw t}}async updateMeasurement(r,t,s){return this.update(r,{actual_value:t,measurement_notes:s,last_measured:new Date().toISOString()})}async getSummary(r){try{const t=await this.getAllWithStatus(r);return{total:t.length,compliant:t.filter(s=>s.compliance_status==="Compliant").length,nearCompliant:t.filter(s=>s.compliance_status==="Near Compliant").length,nonCompliant:t.filter(s=>s.compliance_status==="Non-Compliant").length,notMeasured:t.filter(s=>s.compliance_status==="Not Measured").length}}catch(t){throw t}}async getAssessments(r){try{const{data:t,error:s}=await m.from("deliverable_qs_assessments").select(`
          quality_standard_id,
          criteria_met,
          deliverables!inner(id, status, is_deleted, project_id)
        `).eq("deliverables.project_id",r);return s?await this.getAssessmentsFallback(r):(t||[]).filter(n=>n.deliverables?.is_deleted!==!0&&H.deliverables.contributeToQS.includes(n.deliverables?.status))}catch{return[]}}async getAssessmentsFallback(r){try{const{data:t,error:s}=await m.from("deliverable_qs_assessments").select("quality_standard_id, criteria_met, deliverable_id");if(s)throw s;const{data:a,error:n}=await m.from("deliverables").select("id, status, is_deleted").eq("project_id",r);if(n)throw n;const o=new Set((a||[]).filter(l=>l.is_deleted!==!0&&H.deliverables.contributeToQS.includes(l.status)).map(l=>l.id));return(t||[]).filter(l=>o.has(l.deliverable_id))}catch{return[]}}async getAllWithCalculatedValues(r){try{const t=await this.getAll(r,{orderBy:{column:"qs_ref",ascending:!0}}),s=await this.getAssessments(r),a={};return s.forEach(n=>{a[n.quality_standard_id]||(a[n.quality_standard_id]={total:0,met:0}),a[n.quality_standard_id].total++,n.criteria_met&&a[n.quality_standard_id].met++}),t.map(n=>{const o=a[n.id],c=o&&o.total>0?Math.round(o.met/o.total*100):0,l=n.target||100,h=c>=l;return{...n,calculatedValue:c,assessmentCount:o?.total||0,assessmentsMet:o?.met||0,isAchieved:h}})}catch(t){throw t}}}const Ra=new Bs;class Us extends J{constructor(){super("standards",{supportsSoftDelete:!1,sanitizeConfig:"standard"})}async getAll(r){return super.getAll(r,{orderBy:{column:"standard_ref",ascending:!0}})}async getByStatus(r,t){return super.getAll(r,{filters:[{column:"status",operator:"eq",value:t}],orderBy:{column:"standard_ref",ascending:!0}})}async getByCategory(r,t){return super.getAll(r,{filters:[{column:"category",operator:"eq",value:t}],orderBy:{column:"standard_ref",ascending:!0}})}async getSummary(r){try{const t=await this.getAll(r);return{total:t.length,completed:t.filter(s=>s.status==="Completed").length,inProgress:t.filter(s=>s.status==="In Progress").length,notStarted:t.filter(s=>!s.status||s.status==="Not Started").length}}catch(t){throw t}}}new Us;const $s={version:"2.0",widgets:{"progress-hero":{visible:!0,x:0,y:0,w:12,h:2,minW:6,minH:2,maxH:3},"budget-summary":{visible:!1,x:0,y:2,w:6,h:2,minW:4,minH:2,maxH:3},"pmo-tracking":{visible:!1,x:6,y:2,w:6,h:2,minW:6,minH:2,maxH:4},"stats-grid":{visible:!0,x:0,y:2,w:12,h:2,minW:8,minH:2,maxH:3},certificates:{visible:!1,x:0,y:4,w:12,h:2,minW:6,minH:2,maxH:3},"milestones-list":{visible:!0,x:0,y:4,w:12,h:4,minW:8,minH:3,maxH:6},"kpis-category":{visible:!1,x:0,y:8,w:6,h:3,minW:4,minH:3,maxH:5},"quality-standards":{visible:!1,x:6,y:8,w:6,h:3,minW:4,minH:3,maxH:5}}};({...$s});function Ws(){const{showTestUsers:i}=pt(),{projectId:r,projectName:t,projectRef:s}=Le(),{user:a,role:n}=ye(),[o,c]=d.useState(!0),[l,h]=d.useState(null),[f,g]=d.useState(null),p=d.useCallback(async()=>{if(r){c(!0),g(null);try{G.clearCache();const y=await G.getAllDashboardMetrics(r,{includeTestContent:i});h(y)}catch{g("Failed to load dashboard data")}finally{c(!1)}}},[r,i]);d.useEffect(()=>{p()},[p]);const b=y=>{const{currency:v}=bt;return y>=1e6?`${v}${(y/1e6).toFixed(1)}M`:y>=1e3?`${v}${Math.round(y/1e3)}k`:`${v}${Math.round(y)}`},_=()=>{const y=new Date().getHours();return y<12?"Good morning":y<18?"Good afternoon":"Good evening"};if(o)return e.jsx(me,{message:"Loading dashboard...",size:"large",fullPage:!0});if(f)return e.jsx("div",{className:"dashboard",children:e.jsxs("div",{className:"error-message",children:[e.jsx("p",{children:f}),e.jsx("button",{onClick:p,className:"btn btn-primary",children:"Retry"})]})});if(!l)return e.jsx(me,{message:"Preparing dashboard...",size:"large",fullPage:!0});const{milestones:u,deliverables:j,kpis:R,qualityStandards:q,budget:P,certificates:w,milestoneSpend:N,projectProgress:k}=l,C=Math.max(...u.milestones?.map(y=>y.budget||0)||[1],1);return e.jsxs("div",{className:"dashboard",children:[e.jsx("div",{className:"dashboard-header",children:e.jsx("div",{className:"dashboard-header-content",children:e.jsxs("div",{children:[e.jsx("h1",{className:"dashboard-title",children:_()}),e.jsxs("p",{className:"dashboard-subtitle",children:[s," â€¢ ",t]})]})})}),e.jsxs("div",{className:"dashboard-content",children:[e.jsxs("div",{className:"progress-ring-container",children:[e.jsxs("div",{className:"progress-ring-info",children:[e.jsxs("h2",{children:[k,"%"]}),e.jsx("p",{children:"Overall Project Progress"}),e.jsxs("p",{className:"detail",children:[u.completed," of ",u.total," milestones complete"]})]}),e.jsxs("div",{className:"progress-ring",children:[e.jsxs("svg",{width:"140",height:"140",viewBox:"0 0 140 140",children:[e.jsx("circle",{className:"progress-ring-bg",cx:"70",cy:"70",r:"58"}),e.jsx("circle",{className:"progress-ring-fill",cx:"70",cy:"70",r:"58",strokeDasharray:`${k*3.64} 364`})]}),e.jsxs("span",{className:"progress-ring-text",children:[k,"%"]})]})]}),e.jsxs("div",{className:"hero-metrics",children:[e.jsxs("div",{className:"hero-metric",children:[e.jsx("div",{className:"hero-metric-icon teal",children:e.jsx(le,{size:20})}),e.jsx("div",{className:"hero-metric-label",children:"Milestones"}),e.jsxs("div",{className:"hero-metric-value teal",children:[u.completed,"/",u.total]}),e.jsxs("div",{className:"hero-metric-subtext",children:[e.jsx($e,{size:14}),u.total>0?Math.round(u.completed/u.total*100):0,"% complete"]})]}),e.jsxs("div",{className:"hero-metric",children:[e.jsx("div",{className:"hero-metric-icon success",children:e.jsx(Me,{size:20})}),e.jsx("div",{className:"hero-metric-label",children:"Deliverables"}),e.jsxs("div",{className:"hero-metric-value success",children:[j.delivered,"/",j.total]}),e.jsxs("div",{className:"hero-metric-subtext",children:[e.jsx(Ae,{size:14}),j.completionPercent,"% delivered"]})]}),e.jsxs("div",{className:"hero-metric",children:[e.jsx("div",{className:"hero-metric-icon accent",children:e.jsx(ir,{size:20})}),e.jsx("div",{className:"hero-metric-label",children:"KPIs Achieved"}),e.jsxs("div",{className:"hero-metric-value accent",children:[R.achieved,"/",R.total]}),e.jsxs("div",{className:"hero-metric-subtext",children:[e.jsx(Ie,{size:14}),R.achievementPercent,"% on target"]})]}),e.jsxs("div",{className:"hero-metric",children:[e.jsx("div",{className:"hero-metric-icon purple",style:{background:"rgba(139, 92, 246, 0.1)",color:"#8b5cf6"},children:e.jsx(he,{size:20})}),e.jsx("div",{className:"hero-metric-label",children:"Quality Standards"}),e.jsxs("div",{className:"hero-metric-value",style:{color:"#8b5cf6"},children:[q.achieved,"/",q.total]}),e.jsxs("div",{className:"hero-metric-subtext",children:[e.jsx($e,{size:14}),q.achievementPercent,"% achieved"]})]})]}),(w.pending>0||w.awaitingGeneration>0)&&e.jsxs("div",{className:"certificates-banner",children:[e.jsxs("div",{className:"certificates-info",children:[e.jsx("div",{className:"certificates-icon",children:e.jsx(or,{size:24})}),e.jsxs("div",{className:"certificates-text",children:[e.jsx("h4",{children:"Milestone Certificates"}),e.jsx("p",{children:"Track completion certificates for billing milestones"})]})]}),e.jsxs("div",{className:"certificates-stats",children:[e.jsxs("div",{className:"cert-stat",children:[e.jsx("div",{className:"cert-stat-value signed",children:w.signed}),e.jsx("div",{className:"cert-stat-label",children:"Signed"})]}),e.jsxs("div",{className:"cert-stat",children:[e.jsx("div",{className:"cert-stat-value pending",children:w.pending}),e.jsx("div",{className:"cert-stat-label",children:"Pending"})]}),e.jsxs("div",{className:"cert-stat",children:[e.jsx("div",{className:"cert-stat-value awaiting",children:w.awaitingGeneration}),e.jsx("div",{className:"cert-stat-label",children:"Awaiting"})]})]}),e.jsxs(Q,{to:"/milestones",className:"certificates-action",children:["View Certificates ",e.jsx(lr,{size:14,style:{marginLeft:4,verticalAlign:"middle"}})]})]}),e.jsxs("div",{className:"card-grid",children:[e.jsx("div",{className:"card-span-6",children:e.jsxs("div",{className:"ds-card",children:[e.jsxs("div",{className:"ds-card-header",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"ds-card-title",children:"Budget Overview"}),e.jsxs("p",{className:"ds-card-subtitle",children:[P.utilizationPercent,"% of budget utilized"]})]}),e.jsx(Q,{to:"/reports",className:"ds-card-action",children:"View Reports â†’"})]}),e.jsxs("div",{className:"ds-card-body",children:[e.jsxs("div",{className:"budget-display",children:[e.jsxs("div",{className:"budget-item",children:[e.jsx("div",{className:"budget-item-label",children:"Total Budget"}),e.jsx("div",{className:"budget-item-value budget",children:b(P.totalBudget)})]}),e.jsxs("div",{className:"budget-item",children:[e.jsx("div",{className:"budget-item-label",children:"Spend to Date"}),e.jsx("div",{className:"budget-item-value spend",children:b(P.totalSpend)}),e.jsxs("div",{className:"budget-item-percent",children:[P.utilizationPercent,"% utilized"]})]})]}),e.jsx("div",{style:{marginTop:24},children:e.jsx("div",{className:"progress-bar",style:{height:8},children:e.jsx("div",{className:"progress-bar-fill teal",style:{width:`${Math.min(P.utilizationPercent,100)}%`}})})})]})]})}),e.jsx("div",{className:"card-span-6",children:e.jsxs("div",{className:"ds-card",children:[e.jsx("div",{className:"ds-card-header",children:e.jsxs("div",{children:[e.jsx("h3",{className:"ds-card-title",children:"PMO Cost Tracking"}),e.jsx("p",{className:"ds-card-subtitle",children:"Management vs delivery costs"})]})}),e.jsx("div",{className:"ds-card-body",children:e.jsxs("div",{className:"stat-tiles",children:[e.jsxs("div",{className:"stat-tile",children:[e.jsx("div",{className:"stat-tile-value",style:{color:"#f59e0b"},children:b(P.pmoBudget)}),e.jsx("div",{className:"stat-tile-label",children:"PMO Budget"})]}),e.jsxs("div",{className:"stat-tile",children:[e.jsx("div",{className:"stat-tile-value",style:{color:"#ea580c"},children:b(P.pmoSpend)}),e.jsx("div",{className:"stat-tile-label",children:"PMO Spend"})]}),e.jsxs("div",{className:"stat-tile",children:[e.jsx("div",{className:"stat-tile-value",style:{color:"var(--ds-accent)"},children:b(P.deliveryBudget)}),e.jsx("div",{className:"stat-tile-label",children:"Delivery Budget"})]}),e.jsxs("div",{className:"stat-tile",children:[e.jsx("div",{className:"stat-tile-value",style:{color:"var(--ds-teal)"},children:b(P.deliverySpend)}),e.jsx("div",{className:"stat-tile-label",children:"Delivery Spend"})]})]})})]})}),e.jsx("div",{className:"card-span-8",children:e.jsxs("div",{className:"ds-card",children:[e.jsxs("div",{className:"ds-card-header",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"ds-card-title",children:"Milestone Budget vs Spend"}),e.jsx("p",{className:"ds-card-subtitle",children:"Comparing billable amounts to actual costs"})]}),e.jsx(Q,{to:"/milestones",className:"ds-card-action",children:"View All â†’"})]}),e.jsxs("div",{className:"ds-card-body",children:[e.jsxs("div",{className:"milestone-legend",children:[e.jsxs("div",{className:"milestone-legend-item",children:[e.jsx("div",{className:"milestone-legend-dot budget"}),e.jsx("span",{children:"Budget"})]}),e.jsxs("div",{className:"milestone-legend-item",children:[e.jsx("div",{className:"milestone-legend-dot spend"}),e.jsx("span",{children:"Spend"})]})]}),e.jsx("div",{className:"milestone-chart",children:u.milestones?.map(y=>{const v=N[y.id]||0,A=C>0?(y.budget||0)/C*100:0,M=C>0?v/C*100:0;return e.jsxs("div",{className:"milestone-bar-group",children:[e.jsxs("div",{className:"milestone-bars",children:[e.jsx("div",{className:"milestone-bar budget",style:{height:`${Math.max(A,5)}%`},title:`Budget: ${b(y.budget||0)}`}),e.jsx("div",{className:"milestone-bar spend",style:{height:`${Math.max(M,v>0?5:0)}%`},title:`Spend: ${b(v)}`})]}),e.jsx("span",{className:"milestone-label",children:y.milestone_ref})]},y.id)})})]})]})}),e.jsx("div",{className:"card-span-4",children:e.jsxs("div",{className:"ds-card",children:[e.jsxs("div",{className:"ds-card-header",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"ds-card-title",children:"KPI Performance"}),e.jsx("p",{className:"ds-card-subtitle",children:"By category"})]}),e.jsx(Q,{to:"/kpis",className:"ds-card-action",children:"View All â†’"})]}),e.jsx("div",{className:"ds-card-body",children:e.jsx("div",{className:"kpi-categories",children:Object.entries(R.byCategory||{}).map(([y,v])=>{const A=v.length,M=v.filter(X=>X.isAchieved).length,I=A>0?M/A*100:0,U=y.includes("Time")?"time":y.includes("Quality")?"quality":"delivery";return e.jsxs("div",{className:"kpi-category",children:[e.jsx("div",{className:"kpi-category-bar-container",children:e.jsxs("div",{className:`kpi-category-bar ${U}`,style:{height:`${Math.max(I,15)}%`},children:[M,"/",A]})}),e.jsx("div",{className:"kpi-category-label",children:y.split(" ")[0]})]},y)})})})]})}),e.jsx("div",{className:"card-span-6",children:e.jsxs("div",{className:"ds-card",children:[e.jsxs("div",{className:"ds-card-header",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"ds-card-title",children:"Quality Standards"}),e.jsxs("p",{className:"ds-card-subtitle",children:[q.achieved," of ",q.total," standards achieved"]})]}),e.jsx(Q,{to:"/quality-standards",className:"ds-card-action",children:"View All â†’"})]}),e.jsx("div",{className:"ds-card-body",children:e.jsx("div",{className:"progress-list",children:q.qualityStandards?.slice(0,5).map(y=>{const v=y.calculatedValue||0,A=y.isAchieved;return e.jsxs("div",{className:"progress-item",children:[e.jsxs("div",{className:"progress-item-header",children:[e.jsxs("span",{className:"progress-item-label",children:[y.qs_ref," - ",y.name]}),e.jsxs("span",{className:"progress-item-value",children:[v,"%"]})]}),e.jsx("div",{className:"progress-bar",children:e.jsx("div",{className:`progress-bar-fill ${A?"success":"purple"}`,style:{width:`${v}%`}})})]},y.id)})})})]})}),e.jsx("div",{className:"card-span-6",children:e.jsxs("div",{className:"ds-card",children:[e.jsx("div",{className:"ds-card-header",children:e.jsxs("div",{children:[e.jsx("h3",{className:"ds-card-title",children:"Project Summary"}),e.jsx("p",{className:"ds-card-subtitle",children:"Key metrics at a glance"})]})}),e.jsx("div",{className:"ds-card-body",children:e.jsxs("div",{className:"progress-list",children:[e.jsxs("div",{className:"progress-item",children:[e.jsxs("div",{className:"progress-item-header",children:[e.jsx("span",{className:"progress-item-label",children:"Milestone Completion"}),e.jsxs("span",{className:"progress-item-value",children:[u.completed,"/",u.total]})]}),e.jsx("div",{className:"progress-bar",children:e.jsx("div",{className:"progress-bar-fill teal",style:{width:`${u.total>0?u.completed/u.total*100:0}%`}})})]}),e.jsxs("div",{className:"progress-item",children:[e.jsxs("div",{className:"progress-item-header",children:[e.jsx("span",{className:"progress-item-label",children:"Deliverables Completed"}),e.jsxs("span",{className:"progress-item-value",children:[j.delivered,"/",j.total]})]}),e.jsx("div",{className:"progress-bar",children:e.jsx("div",{className:"progress-bar-fill success",style:{width:`${j.completionPercent}%`}})})]}),e.jsxs("div",{className:"progress-item",children:[e.jsxs("div",{className:"progress-item-header",children:[e.jsx("span",{className:"progress-item-label",children:"Budget Utilization"}),e.jsxs("span",{className:"progress-item-value",children:[P.utilizationPercent,"%"]})]}),e.jsx("div",{className:"progress-bar",children:e.jsx("div",{className:"progress-bar-fill accent",style:{width:`${Math.min(P.utilizationPercent,100)}%`}})})]}),e.jsxs("div",{className:"progress-item",children:[e.jsxs("div",{className:"progress-item-header",children:[e.jsx("span",{className:"progress-item-label",children:"KPI Achievement"}),e.jsxs("span",{className:"progress-item-value",children:[R.achieved,"/",R.total]})]}),e.jsx("div",{className:"progress-bar",children:e.jsx("div",{className:"progress-bar-fill warning",style:{width:`${R.achievementPercent}%`}})})]})]})})]})})]}),e.jsxs("div",{className:"quick-links",children:[e.jsxs(Q,{to:"/milestones",className:"quick-link",children:[e.jsx("div",{className:"quick-link-icon teal",children:e.jsx(le,{size:24})}),e.jsx("div",{className:"quick-link-title",children:"Milestones"})]}),e.jsxs(Q,{to:"/deliverables",className:"quick-link",children:[e.jsx("div",{className:"quick-link-icon success",children:e.jsx(Me,{size:24})}),e.jsx("div",{className:"quick-link-title",children:"Deliverables"})]}),e.jsxs(Q,{to:"/kpis",className:"quick-link",children:[e.jsx("div",{className:"quick-link-icon accent",children:e.jsx(Ae,{size:24})}),e.jsx("div",{className:"quick-link-title",children:"KPIs"})]}),e.jsxs(Q,{to:"/quality-standards",className:"quick-link",children:[e.jsx("div",{className:"quick-link-icon purple",children:e.jsx(he,{size:24})}),e.jsx("div",{className:"quick-link-title",children:"Quality"})]}),e.jsxs(Q,{to:"/reports",className:"quick-link",children:[e.jsx("div",{className:"quick-link-icon warning",children:e.jsx(Ie,{size:24})}),e.jsx("div",{className:"quick-link-title",children:"Reports"})]})]})]})]})}const Fs=d.lazy(()=>B(()=>import("./ResetPassword-CdBU1SJh.js"),__vite__mapDeps([0,1,2,3]))),Vs=d.lazy(()=>B(()=>import("./Milestones-CGCxJKkh.js"),__vite__mapDeps([4,1,5,6,7,8,2,3]))),Hs=d.lazy(()=>B(()=>import("./MilestoneDetail-ssUMKHn7.js"),__vite__mapDeps([9,1,2,3]))),Ks=d.lazy(()=>B(()=>import("./Gantt-B3kSsT83.js"),__vite__mapDeps([10,1,5,2,3]))),Gs=d.lazy(()=>B(()=>import("./Deliverables-Onh9cwqN.js"),__vite__mapDeps([11,1,5,7,2,3]))),Qs=d.lazy(()=>B(()=>import("./Resources-ZmdLJvMq.js"),__vite__mapDeps([12,1,5,6,7,8,2,3]))),Ys=d.lazy(()=>B(()=>import("./ResourceDetail-DRRp9WXV.js"),__vite__mapDeps([13,1,5,6,2,3]))),Xs=d.lazy(()=>B(()=>import("./Partners-BRJN0d28.js"),__vite__mapDeps([14,1,5,6,7,8,2,3]))),Js=d.lazy(()=>B(()=>import("./PartnerDetail-Cpd9LN68.js"),__vite__mapDeps([15,1,5,6,2,3]))),Zs=d.lazy(()=>B(()=>import("./Timesheets-Bfc3Z6r2.js"),__vite__mapDeps([16,1,5,6,7,8,2,3]))),ea=d.lazy(()=>B(()=>import("./Expenses-D2y62zcy.js"),__vite__mapDeps([17,1,5,6,7,8,2,3,18]))),ta=d.lazy(()=>B(()=>import("./KPIs-BG_sFrqm.js"),__vite__mapDeps([19,1,5,6,7,8,2,3]))),ra=d.lazy(()=>B(()=>import("./KPIDetail-ChJwcBu9.js"),__vite__mapDeps([20,1,5,2,3]))),sa=d.lazy(()=>B(()=>import("./QualityStandards-C_LGsVj2.js"),__vite__mapDeps([21,1,5,6,7,8,2,3]))),aa=d.lazy(()=>B(()=>import("./QualityStandardDetail-C57KQdg_.js"),__vite__mapDeps([22,1,2,3]))),na=d.lazy(()=>B(()=>import("./Reports-B7kl1Ax3.js"),__vite__mapDeps([23,2,1,3]))),ia=d.lazy(()=>B(()=>import("./Users-D2N1w36E.js"),__vite__mapDeps([24,1,2,3]))),oa=d.lazy(()=>B(()=>import("./Settings-BuJpAY47.js"),__vite__mapDeps([25,1,5,7,2,3]))),la=d.lazy(()=>B(()=>import("./AccountSettings-45PUGSdf.js"),__vite__mapDeps([26,1,7,2,3]))),ca=d.lazy(()=>B(()=>import("./WorkflowSummary-BKZhDxGI.js"),__vite__mapDeps([27,1,6,7,2,3]))),da=d.lazy(()=>B(()=>import("./AuditLog-BARhvGhb.js"),__vite__mapDeps([28,1,7,2,3]))),ua=d.lazy(()=>B(()=>import("./DeletedItems-BnPkjVxW.js"),__vite__mapDeps([29,1,7,8,2,3])));function ha(){return e.jsx("div",{className:"page-container",children:e.jsx(oe,{type:"page"})})}function z({children:i}){const{user:r,isLoading:t}=ye();return t?e.jsx(me,{message:"Loading...",size:"large",fullPage:!0}):r?e.jsx(ws,{children:e.jsx(d.Suspense,{fallback:e.jsx(ha,{}),children:i||e.jsx(It,{})})}):e.jsx(Pe,{to:"/login",replace:!0})}function ma(){return e.jsx(Rt,{children:e.jsx(Yr,{children:e.jsx(ss,{children:e.jsx(Br,{children:e.jsx(Ur,{children:e.jsx($r,{children:e.jsx(ls,{children:e.jsx(Fr,{children:e.jsxs(Gr,{children:[e.jsxs(Pt,{children:[e.jsx(O,{path:"/login",element:e.jsx(Ss,{})}),e.jsx(O,{path:"/reset-password",element:e.jsx(d.Suspense,{fallback:e.jsx(me,{fullPage:!0}),children:e.jsx(Fs,{})})}),e.jsx(O,{path:"/",element:e.jsx(Pe,{to:"/dashboard",replace:!0})}),e.jsx(O,{path:"/dashboard",element:e.jsx(z,{children:e.jsx(Ws,{})})}),e.jsx(O,{path:"/milestones",element:e.jsx(z,{children:e.jsx(Vs,{})})}),e.jsx(O,{path:"/milestones/:id",element:e.jsx(z,{children:e.jsx(Hs,{})})}),e.jsx(O,{path:"/gantt",element:e.jsx(z,{children:e.jsx(Ks,{})})}),e.jsx(O,{path:"/deliverables",element:e.jsx(z,{children:e.jsx(Gs,{})})}),e.jsx(O,{path:"/resources",element:e.jsx(z,{children:e.jsx(Qs,{})})}),e.jsx(O,{path:"/resources/:id",element:e.jsx(z,{children:e.jsx(Ys,{})})}),e.jsx(O,{path:"/partners",element:e.jsx(z,{children:e.jsx(Xs,{})})}),e.jsx(O,{path:"/partners/:id",element:e.jsx(z,{children:e.jsx(Js,{})})}),e.jsx(O,{path:"/timesheets",element:e.jsx(z,{children:e.jsx(Zs,{})})}),e.jsx(O,{path:"/expenses",element:e.jsx(z,{children:e.jsx(ea,{})})}),e.jsx(O,{path:"/kpis",element:e.jsx(z,{children:e.jsx(ta,{})})}),e.jsx(O,{path:"/kpis/:id",element:e.jsx(z,{children:e.jsx(ra,{})})}),e.jsx(O,{path:"/quality-standards",element:e.jsx(z,{children:e.jsx(sa,{})})}),e.jsx(O,{path:"/quality-standards/:id",element:e.jsx(z,{children:e.jsx(aa,{})})}),e.jsx(O,{path:"/reports",element:e.jsx(z,{children:e.jsx(na,{})})}),e.jsx(O,{path:"/users",element:e.jsx(z,{children:e.jsx(ia,{})})}),e.jsx(O,{path:"/settings",element:e.jsx(z,{children:e.jsx(oa,{})})}),e.jsx(O,{path:"/account",element:e.jsx(z,{children:e.jsx(la,{})})}),e.jsx(O,{path:"/workflow-summary",element:e.jsx(z,{children:e.jsx(ca,{})})}),e.jsx(O,{path:"/audit-log",element:e.jsx(z,{children:e.jsx(da,{})})}),e.jsx(O,{path:"/deleted-items",element:e.jsx(z,{children:e.jsx(ua,{})})}),e.jsx(O,{path:"*",element:e.jsx(Pe,{to:"/dashboard",replace:!0})})]}),e.jsx(cs,{}),e.jsx(Cr,{}),e.jsx(Tr,{})]})})})})})})})})})}De.createRoot(document.getElementById("root")).render(e.jsx(tt.StrictMode,{children:e.jsx(ma,{})}));export{me as L,ms as P,fs as R,H as V,Le as a,as as b,Ge as c,ka as d,pt as e,xa as f,ja as g,ba as h,Na as i,e as j,Ea as k,x as l,Ca as m,_a as n,va as p,Ra as q,wa as r,m as s,Sa as t,ye as u};
