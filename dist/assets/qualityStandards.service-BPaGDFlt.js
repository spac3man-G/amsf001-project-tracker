import{s as c}from"./index-BcgMsB79.js";class h{constructor(t){this.tableName=t}async getAll(t,e={}){try{let r=c.from(this.tableName).select(e.select||"*").eq("project_id",t);e.filters&&Array.isArray(e.filters)&&e.filters.forEach(o=>{const{column:i,operator:u,value:l}=o;switch(u){case"eq":r=r.eq(i,l);break;case"neq":r=r.neq(i,l);break;case"gt":r=r.gt(i,l);break;case"gte":r=r.gte(i,l);break;case"lt":r=r.lt(i,l);break;case"lte":r=r.lte(i,l);break;case"like":r=r.like(i,l);break;case"ilike":r=r.ilike(i,l);break;case"in":r=r.in(i,l);break;case"is":r=r.is(i,l);break;default:r=r.eq(i,l)}}),e.orderBy&&(r=r.order(e.orderBy.column,{ascending:e.orderBy.ascending??!0}));const{data:a,error:s}=await r;if(s)throw console.error(`${this.tableName} getAll error:`,s),s;return a||[]}catch(r){throw console.error(`${this.tableName} getAll failed:`,r),r}}async getById(t,e={}){try{const{data:r,error:a}=await c.from(this.tableName).select(e.select||"*").eq("id",t).single();if(a){if(a.code==="PGRST116")return null;throw console.error(`${this.tableName} getById error:`,a),a}return r}catch(r){throw console.error(`${this.tableName} getById failed:`,r),r}}async create(t){try{if(!t.project_id)throw new Error("project_id is required");const{data:e,error:r}=await c.from(this.tableName).insert(t).select().single();if(r)throw console.error(`${this.tableName} create error:`,r),r;return e}catch(e){throw console.error(`${this.tableName} create failed:`,e),e}}async update(t,e){try{const r={...e,updated_at:new Date().toISOString()},{data:a,error:s}=await c.from(this.tableName).update(r).eq("id",t).select().single();if(s)throw console.error(`${this.tableName} update error:`,s),s;return a}catch(r){throw console.error(`${this.tableName} update failed:`,r),r}}async delete(t){try{const{error:e}=await c.from(this.tableName).delete().eq("id",t);if(e)throw console.error(`${this.tableName} delete error:`,e),e;return!0}catch(e){throw console.error(`${this.tableName} delete failed:`,e),e}}async exists(t){try{const{count:e,error:r}=await c.from(this.tableName).select("id",{count:"exact",head:!0}).eq("id",t);if(r)throw console.error(`${this.tableName} exists error:`,r),r;return e>0}catch(e){throw console.error(`${this.tableName} exists failed:`,e),e}}async count(t,e=[]){try{let r=c.from(this.tableName).select("id",{count:"exact",head:!0}).eq("project_id",t);e.forEach(o=>{const{column:i,operator:u,value:l}=o;u==="eq"?r=r.eq(i,l):u==="in"&&(r=r.in(i,l))});const{count:a,error:s}=await r;if(s)throw console.error(`${this.tableName} count error:`,s),s;return a||0}catch(r){throw console.error(`${this.tableName} count failed:`,r),r}}}class V extends h{constructor(){super("partners")}async getAll(t){return super.getAll(t,{orderBy:{column:"name",ascending:!0}})}async getActive(t){return super.getAll(t,{filters:[{column:"is_active",operator:"eq",value:!0}],orderBy:{column:"name",ascending:!0}})}async getWithResources(t){try{const{data:e,error:r}=await c.from("partners").select(`
          *,
          resources (
            id,
            name,
            daily_rate,
            cost_price,
            is_active
          )
        `).eq("id",t).single();if(r){if(r.code==="PGRST116")return null;throw console.error("Partners getWithResources error:",r),r}return e}catch(e){throw console.error("Partners getWithResources failed:",e),e}}async getSummary(t){try{const{data:e,error:r}=await c.from("partners").select(`
          id,
          name,
          contact_name,
          contact_email,
          payment_terms,
          is_active,
          created_at
        `).eq("project_id",t).order("name",{ascending:!0});if(r)throw console.error("Partners getSummary error:",r),r;return e||[]}catch(e){throw console.error("Partners getSummary failed:",e),e}}async create(t){var r;if(!((r=t.name)!=null&&r.trim()))throw new Error("Partner name is required");if(await this.findByName(t.project_id,t.name))throw new Error(`Partner "${t.name}" already exists`);return super.create({...t,name:t.name.trim(),is_active:t.is_active??!0,payment_terms:t.payment_terms||"Net 30"})}async findByName(t,e){try{const{data:r,error:a}=await c.from("partners").select("*").eq("project_id",t).ilike("name",e.trim()).single();if(a){if(a.code==="PGRST116")return null;throw a}return r}catch(r){if(r.code==="PGRST116")return null;throw console.error("Partners findByName failed:",r),r}}async toggleActive(t){const e=await this.getById(t);if(!e)throw new Error("Partner not found");return this.update(t,{is_active:!e.is_active})}async getForSelect(t,e=!0){return(e?await this.getActive(t):await this.getAll(t)).map(a=>({value:a.id,label:a.name}))}}const oe=new V;class z extends h{constructor(){super("resources")}async getAll(t,e={}){const{includePartner:r=!0,activeOnly:a=!1}=e;let s="*";r&&(s="*, partner:partners(id, name, is_active)");let o=c.from(this.tableName).select(s).eq("project_id",t).order("name");a&&(o=o.eq("is_active",!0));const{data:i,error:u}=await o;if(u)throw console.error("ResourcesService.getAll error:",u),u;return i||[]}async getById(t){const{data:e,error:r}=await c.from(this.tableName).select("*, partner:partners(id, name, contact_name, contact_email, is_active)").eq("id",t).single();if(r)throw console.error("ResourcesService.getById error:",r),r;return e}async getByType(t,e){const{data:r,error:a}=await c.from(this.tableName).select("*, partner:partners(id, name)").eq("project_id",t).eq("resource_type",e).order("name");if(a)throw console.error("ResourcesService.getByType error:",a),a;return r||[]}async getByPartner(t){const{data:e,error:r}=await c.from(this.tableName).select("*").eq("partner_id",t).order("name");if(r)throw console.error("ResourcesService.getByPartner error:",r),r;return e||[]}async getWithTimesheetSummary(t){const e=await this.getById(t);if(!e)return null;const{data:r,error:a}=await c.from("timesheets").select("id, hours_worked, hours, status, was_rejected, date").eq("resource_id",t);a&&console.error("ResourcesService.getWithTimesheetSummary timesheets error:",a);let s=0,o=0,i=0;return r&&r.forEach(u=>{const l=parseFloat(u.hours_worked||u.hours||0);s+=l,u.status==="Approved"?o+=l:u.status==="Submitted"&&!u.was_rejected&&(i+=l)}),{...e,timesheetSummary:{totalEntries:(r==null?void 0:r.length)||0,totalHours:s,approvedHours:o,pendingHours:i,daysWorked:s/8}}}async create(t){var a,s;if(!((a=t.name)!=null&&a.trim()))throw new Error("Resource name is required");if(!t.project_id)throw new Error("Project ID is required");if(!((s=t.email)!=null&&s.trim()))throw new Error("Email is required");t.resource_type==="third_party"&&!t.partner_id&&console.warn("Creating third-party resource without partner_id"),t.resource_type==="internal"&&(t.partner_id=null);const{data:e,error:r}=await c.from(this.tableName).insert([t]).select("*, partner:partners(id, name)").single();if(r)throw console.error("ResourcesService.create error:",r),r;return e}async update(t,e){e.resource_type==="internal"&&(e.partner_id=null),e.updated_at=new Date().toISOString();const{data:r,error:a}=await c.from(this.tableName).update(e).eq("id",t).select("*, partner:partners(id, name)").single();if(a)throw console.error("ResourcesService.update error:",a),a;return r}async linkToPartner(t,e){const r={partner_id:e,resource_type:e?"third_party":"internal",updated_at:new Date().toISOString()};return this.update(t,r)}async toggleType(t,e=null){const r=await this.getById(t);if(!r)throw new Error("Resource not found");const a=r.resource_type==="third_party"?"internal":"third_party";return this.update(t,{resource_type:a,partner_id:a==="third_party"?e:null})}async getForSelect(t){const{data:e,error:r}=await c.from(this.tableName).select("id, name, resource_type, role").eq("project_id",t).order("name");if(r)throw console.error("ResourcesService.getForSelect error:",r),r;return e||[]}calculateMargin(t,e){if(!t||t===0||!e)return{percent:null,amount:null,status:"unknown"};const r=(t-e)/t*100,a=t-e;let s="critical";return r>=25?s="good":r>=10&&(s="low"),{percent:r,amount:a,status:s}}async getUtilization(t){const e=await this.getWithTimesheetSummary(t);if(!e)return null;const r=e.days_allocated||0,a=e.timesheetSummary.daysWorked,s=Math.max(0,r-a),o=r>0?a/r*100:0;return{resourceId:t,resourceName:e.name,daysAllocated:r,daysUsed:a,remaining:s,utilizationPercent:o,totalValue:(e.daily_rate||0)*r,valueUsed:(e.daily_rate||0)*a}}}const ne=new z;class Y extends h{constructor(){super("timesheets")}async getAll(t,e={}){return super.getAll(t,{...e,select:e.select||`
      *,
      resources(id, name, email, daily_rate, cost_price),
      milestones(id, milestone_ref, name)
    `,orderBy:e.orderBy||{column:"date",ascending:!1}})}async getByResource(t,e={}){try{let r=c.from(this.tableName).select("*, milestones(id, milestone_ref, name)").eq("resource_id",t).order("date",{ascending:!1});e.start&&(r=r.gte("date",e.start)),e.end&&(r=r.lte("date",e.end)),e.status&&(r=r.eq("status",e.status));const{data:a,error:s}=await r;if(s)throw s;return a||[]}catch(r){throw console.error("TimesheetsService getByResource error:",r),r}}async getByPartner(t,e={}){try{const{data:r}=await c.from("resources").select("id, name, cost_price").eq("partner_id",t);if(!r||r.length===0)return[];const a=r.map(u=>u.id);let s=c.from(this.tableName).select("*, resources(id, name, cost_price), milestones(id, milestone_ref, name)").in("resource_id",a).order("date",{ascending:!1});e.start&&(s=s.gte("date",e.start)),e.end&&(s=s.lte("date",e.end)),e.status&&(s=s.eq("status",e.status));const{data:o,error:i}=await s;if(i)throw i;return o||[]}catch(r){throw console.error("TimesheetsService getByPartner error:",r),r}}async getApprovedForInvoice(t,e){if(!e.start||!e.end)throw new Error("Date range (start and end) is required for invoice queries");return this.getByPartner(t,{...e,status:"Approved"})}async getSummary(t,e={}){try{const r=await this.getAll(t,e),a={totalHours:0,totalDays:0,approvedHours:0,pendingHours:0,draftHours:0,rejectedHours:0,totalCost:0,approvedCost:0,byStatus:{Draft:{count:0,hours:0},Submitted:{count:0,hours:0},Approved:{count:0,hours:0},Rejected:{count:0,hours:0}},byMilestone:{},count:r.length};return r.forEach(s=>{var l,p,_;const o=parseFloat(s.hours_worked||s.hours||0),i=((l=s.resources)==null?void 0:l.cost_price)||0,u=o/8*i;switch(a.totalHours+=o,a.totalCost+=u,a.byStatus[s.status]&&(a.byStatus[s.status].count++,a.byStatus[s.status].hours+=o),s.status){case"Approved":a.approvedHours+=o,a.approvedCost+=u;break;case"Submitted":s.was_rejected||(a.pendingHours+=o);break;case"Draft":a.draftHours+=o;break;case"Rejected":a.rejectedHours+=o;break}if(s.milestone_id){const f=((p=s.milestones)==null?void 0:p.milestone_ref)||"Unknown";a.byMilestone[s.milestone_id]||(a.byMilestone[s.milestone_id]={ref:f,name:((_=s.milestones)==null?void 0:_.name)||"Unknown",hours:0,cost:0}),a.byMilestone[s.milestone_id].hours+=o,a.byMilestone[s.milestone_id].cost+=u}}),a.totalDays=a.totalHours/8,a}catch(r){throw console.error("TimesheetsService getSummary error:",r),r}}async create(t){if(!t.resource_id)throw new Error("resource_id is required");if(!t.date)throw new Error("date is required");const e=parseFloat(t.hours_worked||t.hours||0);if(!e||e<=0)throw new Error("hours must be greater than 0");const r={...t,hours_worked:e,hours:e,date:t.date||t.work_date,work_date:t.work_date||t.date,description:t.description||t.comments||"",comments:t.comments||t.description||"",status:t.status||"Draft"};return super.create(r)}async submit(t){return this.update(t,{status:"Submitted"})}async approve(t){return this.update(t,{status:"Approved"})}async reject(t,e=null){const r={status:"Rejected",was_rejected:!0};return e&&(r.rejection_reason=e),this.update(t,r)}calculateCost(t,e){return t/8*e}calculateBillable(t,e){return t/8*e}}new Y;class J extends h{constructor(){super("expenses")}async getAll(t,e={}){return super.getAll(t,{...e,select:e.select||"*, expense_files(*), resources(name, resource_type, partner_id)",orderBy:e.orderBy||{column:"expense_date",ascending:!1}})}async getByResource(t,e={}){try{let r=c.from(this.tableName).select("*, expense_files(*)").eq("resource_id",t).order("expense_date",{ascending:!1});e.start&&(r=r.gte("expense_date",e.start)),e.end&&(r=r.lte("expense_date",e.end));const{data:a,error:s}=await r;if(s)throw s;return a||[]}catch(r){throw console.error("ExpensesService getByResource error:",r),r}}async getByPartner(t,e={}){try{const{data:r}=await c.from("resources").select("id").eq("partner_id",t);if(!r||r.length===0)return[];const a=r.map(u=>u.id);let s=c.from(this.tableName).select("*, expense_files(*)").in("resource_id",a).order("expense_date",{ascending:!1});e.start&&(s=s.gte("expense_date",e.start)),e.end&&(s=s.lte("expense_date",e.end)),e.procurementMethod&&(s=s.eq("procurement_method",e.procurementMethod));const{data:o,error:i}=await s;if(i)throw i;return o||[]}catch(r){throw console.error("ExpensesService getByPartner error:",r),r}}async getPartnerProcuredForInvoice(t,e){if(!e.start||!e.end)throw new Error("Date range (start and end) is required for invoice queries");return this.getByPartner(t,{...e,procurementMethod:"partner"})}async getSummary(t,e={}){try{const r=await this.getAll(t,e),a={total:0,chargeable:0,nonChargeable:0,supplierProcured:0,partnerProcured:0,byCategory:{Travel:0,Accommodation:0,Sustenance:0},byStatus:{Draft:0,Submitted:0,Approved:0,Rejected:0,Paid:0},count:r.length};return r.forEach(s=>{const o=parseFloat(s.amount||0);a.total+=o,s.chargeable_to_customer!==!1?a.chargeable+=o:a.nonChargeable+=o,s.procurement_method==="partner"?a.partnerProcured+=o:a.supplierProcured+=o,a.byCategory[s.category]!==void 0&&(a.byCategory[s.category]+=o),a.byStatus[s.status]!==void 0&&(a.byStatus[s.status]+=o)}),a}catch(r){throw console.error("ExpensesService getSummary error:",r),r}}async create(t){if(!t.resource_id)throw new Error("resource_id is required");if(!t.category)throw new Error("category is required");if(!t.amount||t.amount<=0)throw new Error("amount must be greater than 0");const e={...t,status:t.status||"Draft",chargeable_to_customer:t.chargeable_to_customer??!0,procurement_method:t.procurement_method||"supplier"};return super.create(e)}async submit(t){return this.update(t,{status:"Submitted"})}async approve(t){return this.update(t,{status:"Approved"})}async reject(t,e=null){const r={status:"Rejected"};return e&&(r.rejection_reason=e),this.update(t,r)}async markPaid(t){return this.update(t,{status:"Paid"})}}new J;class X extends h{constructor(){super("partner_invoices")}async getAll(t,e={}){return super.getAll(t,{...e,select:e.select||"*, partners(name)",orderBy:e.orderBy||{column:"invoice_date",ascending:!1}})}async getByPartner(t,e={}){try{let r=c.from(this.tableName).select("*").eq("partner_id",t).order("invoice_date",{ascending:!1});e.status&&(r=r.eq("status",e.status));const{data:a,error:s}=await r;if(s)throw s;return a||[]}catch(r){throw console.error("InvoicingService getByPartner error:",r),r}}async getWithLines(t){try{const{data:e,error:r}=await c.from(this.tableName).select("*, partners(name, contact_name, contact_email, payment_terms)").eq("id",t).single();if(r)throw r;if(!e)return null;const{data:a,error:s}=await c.from("partner_invoice_lines").select("*").eq("invoice_id",t).order("line_type",{ascending:!0}).order("resource_name",{ascending:!0}).order("line_date",{ascending:!0});if(s)throw s;const o={timesheets:(a||[]).filter(i=>i.line_type==="timesheet"),supplierExpenses:(a||[]).filter(i=>i.line_type==="supplier_expense"),partnerExpenses:(a||[]).filter(i=>i.line_type==="expense")};return{...e,lines:a||[],groupedLines:o}}catch(e){throw console.error("InvoicingService getWithLines error:",e),e}}async generateInvoiceNumber(t){try{const r=`INV-${new Date().getFullYear()}-`,{data:a,error:s}=await c.from(this.tableName).select("invoice_number").eq("project_id",t).like("invoice_number",`${r}%`).order("invoice_number",{ascending:!1}).limit(1);if(s)throw s;let o=1;if(a&&a.length>0){const i=a[0].invoice_number,u=parseInt(i.replace(r,""),10);isNaN(u)||(o=u+1)}return`${r}${String(o).padStart(3,"0")}`}catch(e){throw console.error("InvoicingService generateInvoiceNumber error:",e),e}}async generateInvoice(t){const{projectId:e,partnerId:r,periodStart:a,periodEnd:s,createdBy:o,notes:i,includeSubmitted:u=!0}=t;try{const{data:l,error:p}=await c.from("resources").select("id, name, cost_price").eq("partner_id",r);if(p)throw p;if(!l||l.length===0)throw new Error("No resources linked to this partner");const _=l.map(n=>n.id),f={};l.forEach(n=>{f[n.id]=n});const F=u?["Approved","Submitted"]:["Approved"],{data:O,error:N}=await c.from("timesheets").select("id, date, hours_worked, hours, status, resource_id").in("resource_id",_).gte("date",a).lte("date",s).in("status",F);if(N)throw N;const{data:A,error:E}=await c.from("expenses").select("id, expense_date, category, reason, amount, resource_id, resource_name, procurement_method, chargeable_to_customer, status").in("resource_id",_).gte("expense_date",a).lte("expense_date",s).in("status",["Approved","Submitted","Paid"]);if(E)throw E;const H=(A||[]).filter(n=>n.procurement_method==="partner"),U=(A||[]).filter(n=>n.procurement_method==="supplier");let S=0,k=0;const B=[],g={};(O||[]).forEach(n=>{g[n.resource_id]||(g[n.resource_id]=[]),g[n.resource_id].push(n)}),Object.keys(g).forEach(n=>{const d=f[n];g[n].forEach(y=>{const w=parseFloat(y.hours_worked||y.hours||0),v=(d==null?void 0:d.cost_price)||0,M=w/8,q=M*v;S+=q,k+=q,B.push({line_type:"timesheet",timesheet_id:y.id,expense_id:null,description:`${(d==null?void 0:d.name)||"Unknown"} - ${w}h (${M.toFixed(2)} days)`,quantity:w,unit_price:v,line_total:q,resource_name:d==null?void 0:d.name,line_date:y.date,hours:w,cost_price:v,source_status:y.status,chargeable_to_customer:!0,procurement_method:null,expense_category:null})})});let b=0,P=0,I=0;const D=[];H.forEach(n=>{const d=parseFloat(n.amount||0);b+=d,n.chargeable_to_customer?P+=d:I+=d,D.push({line_type:"expense",timesheet_id:null,expense_id:n.id,description:`${n.resource_name} - ${n.category}: ${n.reason}`,quantity:1,unit_price:d,line_total:d,resource_name:n.resource_name,line_date:n.expense_date,hours:null,cost_price:null,source_status:n.status,chargeable_to_customer:n.chargeable_to_customer,procurement_method:"partner",expense_category:n.category})});let x=0,j=0,C=0;const T=[];U.forEach(n=>{const d=parseFloat(n.amount||0);x+=d,n.chargeable_to_customer?j+=d:C+=d,T.push({line_type:"supplier_expense",timesheet_id:null,expense_id:n.id,description:`${n.resource_name} - ${n.category}: ${n.reason}`,quantity:1,unit_price:d,line_total:d,resource_name:n.resource_name,line_date:n.expense_date,hours:null,cost_price:null,source_status:n.status,chargeable_to_customer:n.chargeable_to_customer,procurement_method:"supplier",expense_category:n.category})});const G=S+b,L=k+P+j,K=I+C,Q=await this.generateInvoiceNumber(e),{data:R,error:$}=await c.from(this.tableName).insert({project_id:e,partner_id:r,invoice_number:Q,invoice_date:new Date().toISOString().split("T")[0],period_start:a,period_end:s,timesheet_total:S,expense_total:b,supplier_expense_total:x,invoice_total:G,chargeable_total:L,non_chargeable_total:K,status:"Draft",notes:i||null,created_by:o}).select().single();if($)throw $;const W=[...B,...D,...T].map(n=>({...n,invoice_id:R.id}));if(W.length>0){const{error:n}=await c.from("partner_invoice_lines").insert(W);if(n)throw n}return this.getWithLines(R.id)}catch(l){throw console.error("InvoicingService generateInvoice error:",l),l}}async updateStatus(t,e){const r={status:e};return e==="Sent"?r.sent_at=new Date().toISOString():e==="Paid"&&(r.paid_at=new Date().toISOString()),this.update(t,r)}async markSent(t){return this.updateStatus(t,"Sent")}async markPaid(t){return this.updateStatus(t,"Paid")}async cancel(t){return this.updateStatus(t,"Cancelled")}async getPartnerStats(t){try{const{data:e,error:r}=await c.from(this.tableName).select("status, invoice_total").eq("partner_id",t);if(r)throw r;const a={total:0,draft:0,sent:0,paid:0,cancelled:0,count:(e==null?void 0:e.length)||0};return(e||[]).forEach(s=>{const o=parseFloat(s.invoice_total||0);switch(a.total+=o,s.status){case"Draft":a.draft+=o;break;case"Sent":a.sent+=o;break;case"Paid":a.paid+=o;break;case"Cancelled":a.cancelled+=o;break}}),a}catch(e){throw console.error("InvoicingService getPartnerStats error:",e),e}}}const ie=new X;class Z extends h{constructor(){super("milestones")}async getAllWithStats(t){try{const e=await this.getAll(t,{orderBy:{column:"start_date",ascending:!0}}),{data:r}=await c.from("timesheets").select("milestone_id, hours_worked").eq("project_id",t).not("milestone_id","is",null),a={};return(r||[]).forEach(s=>{a[s.milestone_id]||(a[s.milestone_id]=0),a[s.milestone_id]+=parseFloat(s.hours_worked||0)}),e.map(s=>({...s,logged_hours:a[s.id]||0,logged_days:(a[s.id]||0)/8}))}catch(e){throw console.error("MilestonesService getAllWithStats error:",e),e}}async getWithDeliverables(t){try{const{data:e,error:r}=await c.from(this.tableName).select("*").eq("id",t).single();if(r)throw r;const{data:a,error:s}=await c.from("deliverables").select("*").eq("milestone_id",t).order("due_date",{ascending:!0});if(s)throw s;return{...e,deliverables:a||[]}}catch(e){throw console.error("MilestonesService getWithDeliverables error:",e),e}}async getByStatus(t,e){return this.getAll(t,{filters:[{column:"status",operator:"eq",value:e}],orderBy:{column:"start_date",ascending:!0}})}async getUpcoming(t,e=30){try{const r=new Date().toISOString().split("T")[0],a=new Date;a.setDate(a.getDate()+e);const s=a.toISOString().split("T")[0],{data:o,error:i}=await c.from(this.tableName).select("*").eq("project_id",t).gte("end_date",r).lte("end_date",s).neq("status","Completed").order("end_date",{ascending:!0});if(i)throw i;return o||[]}catch(r){throw console.error("MilestonesService getUpcoming error:",r),r}}async updateStatus(t,e){return this.update(t,{status:e})}async updateCompletion(t,e){const r={completion_percentage:e};return e>=100&&(r.status="Completed"),this.update(t,r)}}new Z;class ee extends h{constructor(){super("deliverables")}async getAllWithMilestones(t){return this.getAll(t,{select:"*, milestones(name, reference)",orderBy:{column:"due_date",ascending:!0}})}async getByMilestone(t){try{const{data:e,error:r}=await c.from(this.tableName).select("*").eq("milestone_id",t).order("due_date",{ascending:!0});if(r)throw r;return e||[]}catch(e){throw console.error("DeliverablesService getByMilestone error:",e),e}}async getByStatus(t,e){return this.getAll(t,{filters:[{column:"status",operator:"eq",value:e}],orderBy:{column:"due_date",ascending:!0}})}async getOverdue(t){try{const e=new Date().toISOString().split("T")[0],{data:r,error:a}=await c.from(this.tableName).select("*, milestones(name)").eq("project_id",t).lt("due_date",e).not("status","in",'("Delivered","Cancelled")').order("due_date",{ascending:!0});if(a)throw a;return r||[]}catch(e){throw console.error("DeliverablesService getOverdue error:",e),e}}async getUpcoming(t,e=14){try{const r=new Date().toISOString().split("T")[0],a=new Date;a.setDate(a.getDate()+e);const s=a.toISOString().split("T")[0],{data:o,error:i}=await c.from(this.tableName).select("*, milestones(name)").eq("project_id",t).gte("due_date",r).lte("due_date",s).not("status","eq","Delivered").order("due_date",{ascending:!0});if(i)throw i;return o||[]}catch(r){throw console.error("DeliverablesService getUpcoming error:",r),r}}async updateStatus(t,e,r){const a={status:e};return e==="Submitted"?(a.submitted_date=new Date().toISOString(),a.submitted_by=r):e==="Delivered"&&(a.delivered_date=new Date().toISOString(),a.delivered_by=r),this.update(t,a)}async submit(t,e){return this.updateStatus(t,"Submitted",e)}async markDelivered(t,e){return this.updateStatus(t,"Delivered",e)}async reject(t,e){return this.update(t,{status:"Rejected",rejection_reason:e})}}new ee;class re extends h{constructor(){super("kpis")}async getAllWithStatus(t){try{return(await this.getAll(t,{orderBy:{column:"name",ascending:!0}})).map(r=>({...r,rag_status:this.calculateRAG(r)}))}catch(e){throw console.error("KPIsService getAllWithStatus error:",e),e}}calculateRAG(t){if(!t.target_value||t.actual_value===null||t.actual_value===void 0)return"Unknown";const e=parseFloat(t.actual_value),r=parseFloat(t.target_value),a=parseFloat(t.threshold_amber||10);return t.trend==="higher_better"?e>=r?"Green":e>=r*(1-a/100)?"Amber":"Red":e<=r?"Green":e<=r*(1+a/100)?"Amber":"Red"}async getByRAGStatus(t,e){try{return(await this.getAllWithStatus(t)).filter(a=>a.rag_status===e)}catch(r){throw console.error("KPIsService getByRAGStatus error:",r),r}}async getNeedingAttention(t){try{return(await this.getAllWithStatus(t)).filter(r=>r.rag_status==="Amber"||r.rag_status==="Red")}catch(e){throw console.error("KPIsService getNeedingAttention error:",e),e}}async updateActualValue(t,e){return this.update(t,{actual_value:e,last_updated:new Date().toISOString()})}async getHistory(t,e=12){try{const{data:r,error:a}=await c.from("kpi_history").select("*").eq("kpi_id",t).order("recorded_at",{ascending:!1}).limit(e);if(a)throw a;return r||[]}catch(r){return console.warn("KPI history not available:",r.message),[]}}async getSummary(t){try{const e=await this.getAllWithStatus(t);return{total:e.length,green:e.filter(r=>r.rag_status==="Green").length,amber:e.filter(r=>r.rag_status==="Amber").length,red:e.filter(r=>r.rag_status==="Red").length,unknown:e.filter(r=>r.rag_status==="Unknown").length}}catch(e){throw console.error("KPIsService getSummary error:",e),e}}}new re;class te extends h{constructor(){super("quality_standards")}async getAllWithStatus(t){try{return(await this.getAll(t,{orderBy:{column:"name",ascending:!0}})).map(r=>({...r,compliance_status:this.calculateCompliance(r)}))}catch(e){throw console.error("QualityStandardsService getAllWithStatus error:",e),e}}calculateCompliance(t){if(t.actual_value===null||t.actual_value===void 0)return"Not Measured";const e=parseFloat(t.actual_value),r=parseFloat(t.target_value||0);return e>=r?"Compliant":e>=r*.9?"Near Compliant":"Non-Compliant"}async getNonCompliant(t){try{return(await this.getAllWithStatus(t)).filter(r=>r.compliance_status==="Non-Compliant")}catch(e){throw console.error("QualityStandardsService getNonCompliant error:",e),e}}async updateMeasurement(t,e,r){return this.update(t,{actual_value:e,measurement_notes:r,last_measured:new Date().toISOString()})}async getSummary(t){try{const e=await this.getAllWithStatus(t);return{total:e.length,compliant:e.filter(r=>r.compliance_status==="Compliant").length,nearCompliant:e.filter(r=>r.compliance_status==="Near Compliant").length,nonCompliant:e.filter(r=>r.compliance_status==="Non-Compliant").length,notMeasured:e.filter(r=>r.compliance_status==="Not Measured").length}}catch(e){throw console.error("QualityStandardsService getSummary error:",e),e}}}new te;export{ie as i,oe as p,ne as r};
