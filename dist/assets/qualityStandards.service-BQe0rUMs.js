import{s as i}from"./index-bXTId5SU.js";const J={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function X(o){return o==null?"":typeof o!="string"?String(o):o.replace(/[&<>"'`=\/]/g,r=>J[r])}function x(o,r={}){const{maxLength:e=1e4,trim:t=!0,normalizeWhitespace:a=!0}=r;if(o==null)return"";typeof o!="string"&&(o=String(o));let s=o;return s=s.replace(/\0/g,""),s=s.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,""),t&&(s=s.trim()),a&&(s=s.replace(/[ \t]+/g," ")),s.length>e&&(s=s.substring(0,e)),s}function O(o,r=255){return o==null?"":(typeof o!="string"&&(o=String(o)),x(o,{maxLength:r}).replace(/[\r\n]/g," ").replace(/\s+/g," ").trim())}function ee(o,r=1e4){return o==null?"":(typeof o!="string"&&(o=String(o)),x(o,{maxLength:r,normalizeWhitespace:!1}).replace(/\r\n/g,`
`).replace(/\r/g,`
`).replace(/\n{3,}/g,`

`).trim())}function te(o){return o?O(o,254).toLowerCase():""}function S(o,r={}){const{min:e=-1/0,max:t=1/0,decimals:a=2}=r;if(o==null||o==="")return null;let s=String(o).replace(/[^0-9.\-]/g,""),n=parseFloat(s);return isNaN(n)?null:(n=Math.max(e,Math.min(t,n)),n=Math.round(n*Math.pow(10,a))/Math.pow(10,a),n)}function re(o){const r=S(o,{min:0,decimals:2});return r!==null?Math.round(r*100)/100:null}function ae(o){const r=S(o,{min:0,max:24,decimals:1});return r===null?null:Math.round(r*2)/2}function se(o){return S(o,{min:0,max:100,decimals:1})}function ne(o){if(!o)return null;const r=String(o).trim();return/^(javascript|data|vbscript):/i.test(r)?null:/^(https?:\/\/|\/|#)/i.test(r)?r:`https://${r}`}function oe(o,r={}){if(!o||typeof o!="object")return o;const e={...o};for(const[t,a]of Object.entries(r)){if(e[t]===void 0)continue;const{type:s="text",maxLength:n}=a;switch(s){case"singleLine":e[t]=O(e[t],n);break;case"multiLine":e[t]=ee(e[t],n);break;case"email":e[t]=te(e[t]);break;case"number":e[t]=S(e[t],a);break;case"currency":e[t]=re(e[t]);break;case"hours":e[t]=ae(e[t]);break;case"percentage":e[t]=se(e[t]);break;case"url":e[t]=ne(e[t]);break;case"html":e[t]=X(e[t]);break;default:e[t]=x(e[t],{maxLength:n})}}return e}const ie={timesheet:{description:{type:"multiLine",maxLength:2e3},hours_worked:{type:"hours"}},expense:{reason:{type:"multiLine",maxLength:2e3},amount:{type:"currency"}},resource:{name:{type:"singleLine",maxLength:100},email:{type:"email"},role:{type:"singleLine",maxLength:100},notes:{type:"multiLine",maxLength:5e3}},partner:{name:{type:"singleLine",maxLength:200},contact_name:{type:"singleLine",maxLength:100},contact_email:{type:"email"},notes:{type:"multiLine",maxLength:5e3}},milestone:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3}},deliverable:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3}},kpi:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3},target_value:{type:"number",decimals:2},actual_value:{type:"number",decimals:2}},qualityStandard:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3},target_value:{type:"percentage"}}};function z(o,r){const e=ie[o];return e?oe(r,e):(console.warn(`No sanitisation config for entity type: ${o}`),r)}class h{constructor(r,e={}){this.tableName=r,this.supportsSoftDelete=e.supportsSoftDelete!==!1,this.sanitizeConfig=e.sanitizeConfig||null}getSoftDeleteFilter(){return this.supportsSoftDelete?"is_deleted.is.null,is_deleted.eq.false":null}async getAll(r,e={}){try{let t=i.from(this.tableName).select(e.select||"*").eq("project_id",r);this.supportsSoftDelete&&!e.includeDeleted&&(t=t.or(this.getSoftDeleteFilter())),e.filters&&Array.isArray(e.filters)&&e.filters.forEach(n=>{const{column:l,operator:d,value:u}=n;switch(d){case"eq":t=t.eq(l,u);break;case"neq":t=t.neq(l,u);break;case"gt":t=t.gt(l,u);break;case"gte":t=t.gte(l,u);break;case"lt":t=t.lt(l,u);break;case"lte":t=t.lte(l,u);break;case"like":t=t.like(l,u);break;case"ilike":t=t.ilike(l,u);break;case"in":t=t.in(l,u);break;case"is":t=t.is(l,u);break;default:t=t.eq(l,u)}}),e.orderBy&&(t=t.order(e.orderBy.column,{ascending:e.orderBy.ascending??!0}));const{data:a,error:s}=await t;if(s)throw console.error(`${this.tableName} getAll error:`,s),s;return a||[]}catch(t){throw console.error(`${this.tableName} getAll failed:`,t),t}}async getDeleted(r){if(!this.supportsSoftDelete)return[];try{const{data:e,error:t}=await i.from(this.tableName).select("*").eq("project_id",r).eq("is_deleted",!0).order("deleted_at",{ascending:!1});if(t)throw console.error(`${this.tableName} getDeleted error:`,t),t;return e||[]}catch(e){throw console.error(`${this.tableName} getDeleted failed:`,e),e}}async getById(r,e={}){try{let t=i.from(this.tableName).select(e.select||"*").eq("id",r);this.supportsSoftDelete&&!e.includeDeleted&&(t=t.or(this.getSoftDeleteFilter()));const{data:a,error:s}=await t.single();if(s){if(s.code==="PGRST116")return null;throw console.error(`${this.tableName} getById error:`,s),s}return a}catch(t){throw console.error(`${this.tableName} getById failed:`,t),t}}async create(r){try{if(!r.project_id)throw new Error("project_id is required");let e=r;this.sanitizeConfig&&(e=z(this.sanitizeConfig,r)),this.supportsSoftDelete&&(delete e.is_deleted,delete e.deleted_at,delete e.deleted_by);const{data:t,error:a}=await i.from(this.tableName).insert(e).select().single();if(a)throw console.error(`${this.tableName} create error:`,a),a;return t}catch(e){throw console.error(`${this.tableName} create failed:`,e),e}}async update(r,e){try{let t=e;this.sanitizeConfig&&(t=z(this.sanitizeConfig,e));const a={...t,updated_at:new Date().toISOString()};delete a.is_deleted,delete a.deleted_at,delete a.deleted_by;const{data:s,error:n}=await i.from(this.tableName).update(a).eq("id",r).select().single();if(n)throw console.error(`${this.tableName} update error:`,n),n;return s}catch(t){throw console.error(`${this.tableName} update failed:`,t),t}}async delete(r,e=null){try{if(this.supportsSoftDelete){const{error:t}=await i.from(this.tableName).update({is_deleted:!0,deleted_at:new Date().toISOString(),deleted_by:e}).eq("id",r);if(t)throw console.error(`${this.tableName} soft delete error:`,t),t}else{const{error:t}=await i.from(this.tableName).delete().eq("id",r);if(t)throw console.error(`${this.tableName} delete error:`,t),t}return!0}catch(t){throw console.error(`${this.tableName} delete failed:`,t),t}}async hardDelete(r){try{const{error:e}=await i.from(this.tableName).delete().eq("id",r);if(e)throw console.error(`${this.tableName} hardDelete error:`,e),e;return!0}catch(e){throw console.error(`${this.tableName} hardDelete failed:`,e),e}}async restore(r){if(!this.supportsSoftDelete)throw new Error("This entity does not support soft delete");try{const{data:e,error:t}=await i.from(this.tableName).update({is_deleted:!1,deleted_at:null,deleted_by:null}).eq("id",r).select().single();if(t)throw console.error(`${this.tableName} restore error:`,t),t;return e}catch(e){throw console.error(`${this.tableName} restore failed:`,e),e}}async exists(r){try{let e=i.from(this.tableName).select("id",{count:"exact",head:!0}).eq("id",r);this.supportsSoftDelete&&(e=e.or(this.getSoftDeleteFilter()));const{count:t,error:a}=await e;if(a)throw console.error(`${this.tableName} exists error:`,a),a;return t>0}catch(e){throw console.error(`${this.tableName} exists failed:`,e),e}}async count(r,e=[]){try{let t=i.from(this.tableName).select("id",{count:"exact",head:!0}).eq("project_id",r);this.supportsSoftDelete&&(t=t.or(this.getSoftDeleteFilter())),e.forEach(n=>{const{column:l,operator:d,value:u}=n;d==="eq"?t=t.eq(l,u):d==="in"&&(t=t.in(l,u))});const{count:a,error:s}=await t;if(s)throw console.error(`${this.tableName} count error:`,s),s;return a||0}catch(t){throw console.error(`${this.tableName} count failed:`,t),t}}}class ce extends h{constructor(){super("partners")}async getAll(r){return super.getAll(r,{orderBy:{column:"name",ascending:!0}})}async getActive(r){return super.getAll(r,{filters:[{column:"is_active",operator:"eq",value:!0}],orderBy:{column:"name",ascending:!0}})}async getWithResources(r){try{const{data:e,error:t}=await i.from("partners").select(`
          *,
          resources (
            id,
            name,
            daily_rate,
            cost_price,
            is_active
          )
        `).eq("id",r).single();if(t){if(t.code==="PGRST116")return null;throw console.error("Partners getWithResources error:",t),t}return e}catch(e){throw console.error("Partners getWithResources failed:",e),e}}async getSummary(r){try{const{data:e,error:t}=await i.from("partners").select(`
          id,
          name,
          contact_name,
          contact_email,
          payment_terms,
          is_active,
          created_at
        `).eq("project_id",r).order("name",{ascending:!0});if(t)throw console.error("Partners getSummary error:",t),t;return e||[]}catch(e){throw console.error("Partners getSummary failed:",e),e}}async create(r){var t;if(!((t=r.name)!=null&&t.trim()))throw new Error("Partner name is required");if(await this.findByName(r.project_id,r.name))throw new Error(`Partner "${r.name}" already exists`);return super.create({...r,name:r.name.trim(),is_active:r.is_active??!0,payment_terms:r.payment_terms||"Net 30"})}async findByName(r,e){try{const{data:t,error:a}=await i.from("partners").select("*").eq("project_id",r).ilike("name",e.trim()).single();if(a){if(a.code==="PGRST116")return null;throw a}return t}catch(t){if(t.code==="PGRST116")return null;throw console.error("Partners findByName failed:",t),t}}async toggleActive(r){const e=await this.getById(r);if(!e)throw new Error("Partner not found");return this.update(r,{is_active:!e.is_active})}async getForSelect(r,e=!0){return(e?await this.getActive(r):await this.getAll(r)).map(a=>({value:a.id,label:a.name}))}}const we=new ce;class le extends h{constructor(){super("resources")}async getAll(r,e={}){const{includePartner:t=!0,activeOnly:a=!1}=e;let s="*";t&&(s="*, partner:partners(id, name, is_active)");let n=i.from(this.tableName).select(s).eq("project_id",r).order("name");a&&(n=n.eq("is_active",!0));const{data:l,error:d}=await n;if(d)throw console.error("ResourcesService.getAll error:",d),d;return l||[]}async getById(r){const{data:e,error:t}=await i.from(this.tableName).select("*, partner:partners(id, name, contact_name, contact_email, is_active)").eq("id",r).single();if(t)throw console.error("ResourcesService.getById error:",t),t;return e}async getByType(r,e){const{data:t,error:a}=await i.from(this.tableName).select("*, partner:partners(id, name)").eq("project_id",r).eq("resource_type",e).order("name");if(a)throw console.error("ResourcesService.getByType error:",a),a;return t||[]}async getByPartner(r){const{data:e,error:t}=await i.from(this.tableName).select("*").eq("partner_id",r).order("name");if(t)throw console.error("ResourcesService.getByPartner error:",t),t;return e||[]}async getWithTimesheetSummary(r){const e=await this.getById(r);if(!e)return null;const{data:t,error:a}=await i.from("timesheets").select("id, hours_worked, hours, status, was_rejected, date").eq("resource_id",r);a&&console.error("ResourcesService.getWithTimesheetSummary timesheets error:",a);let s=0,n=0,l=0;return t&&t.forEach(d=>{const u=parseFloat(d.hours_worked||d.hours||0);s+=u,d.status==="Approved"?n+=u:d.status==="Submitted"&&!d.was_rejected&&(l+=u)}),{...e,timesheetSummary:{totalEntries:(t==null?void 0:t.length)||0,totalHours:s,approvedHours:n,pendingHours:l,daysWorked:s/8}}}async create(r){var a,s;if(!((a=r.name)!=null&&a.trim()))throw new Error("Resource name is required");if(!r.project_id)throw new Error("Project ID is required");if(!((s=r.email)!=null&&s.trim()))throw new Error("Email is required");r.resource_type==="third_party"&&!r.partner_id&&console.warn("Creating third-party resource without partner_id"),r.resource_type==="internal"&&(r.partner_id=null);const{data:e,error:t}=await i.from(this.tableName).insert([r]).select("*, partner:partners(id, name)").single();if(t)throw console.error("ResourcesService.create error:",t),t;return e}async update(r,e){e.resource_type==="internal"&&(e.partner_id=null),e.updated_at=new Date().toISOString();const{data:t,error:a}=await i.from(this.tableName).update(e).eq("id",r).select("*, partner:partners(id, name)").single();if(a)throw console.error("ResourcesService.update error:",a),a;return t}async linkToPartner(r,e){const t={partner_id:e,resource_type:e?"third_party":"internal",updated_at:new Date().toISOString()};return this.update(r,t)}async toggleType(r,e=null){const t=await this.getById(r);if(!t)throw new Error("Resource not found");const a=t.resource_type==="third_party"?"internal":"third_party";return this.update(r,{resource_type:a,partner_id:a==="third_party"?e:null})}async getForSelect(r){const{data:e,error:t}=await i.from(this.tableName).select("id, name, resource_type, role").eq("project_id",r).order("name");if(t)throw console.error("ResourcesService.getForSelect error:",t),t;return e||[]}calculateMargin(r,e){if(!r||r===0||!e)return{percent:null,amount:null,status:"unknown"};const t=(r-e)/r*100,a=r-e;let s="critical";return t>=25?s="good":t>=10&&(s="low"),{percent:t,amount:a,status:s}}async getUtilization(r){const e=await this.getWithTimesheetSummary(r);if(!e)return null;const t=e.days_allocated||0,a=e.timesheetSummary.daysWorked,s=Math.max(0,t-a),n=t>0?a/t*100:0;return{resourceId:r,resourceName:e.name,daysAllocated:t,daysUsed:a,remaining:s,utilizationPercent:n,totalValue:(e.daily_rate||0)*t,valueUsed:(e.daily_rate||0)*a}}}const Se=new le;class ue extends h{constructor(){super("timesheets")}async getAll(r,e={}){return super.getAll(r,{...e,select:e.select||`
      *,
      resources(id, name, email, daily_rate, cost_price),
      milestones(id, milestone_ref, name)
    `,orderBy:e.orderBy||{column:"date",ascending:!1}})}async getByResource(r,e={}){try{let t=i.from(this.tableName).select("*, milestones(id, milestone_ref, name)").eq("resource_id",r).order("date",{ascending:!1});e.start&&(t=t.gte("date",e.start)),e.end&&(t=t.lte("date",e.end)),e.status&&(t=t.eq("status",e.status));const{data:a,error:s}=await t;if(s)throw s;return a||[]}catch(t){throw console.error("TimesheetsService getByResource error:",t),t}}async getByPartner(r,e={}){try{const{data:t}=await i.from("resources").select("id, name, cost_price").eq("partner_id",r);if(!t||t.length===0)return[];const a=t.map(d=>d.id);let s=i.from(this.tableName).select("*, resources(id, name, cost_price), milestones(id, milestone_ref, name)").in("resource_id",a).order("date",{ascending:!1});e.start&&(s=s.gte("date",e.start)),e.end&&(s=s.lte("date",e.end)),e.status&&(s=s.eq("status",e.status));const{data:n,error:l}=await s;if(l)throw l;return n||[]}catch(t){throw console.error("TimesheetsService getByPartner error:",t),t}}async getApprovedForInvoice(r,e){if(!e.start||!e.end)throw new Error("Date range (start and end) is required for invoice queries");return this.getByPartner(r,{...e,status:"Approved"})}async getSummary(r,e={}){try{const t=await this.getAll(r,e),a={totalHours:0,totalDays:0,approvedHours:0,pendingHours:0,draftHours:0,rejectedHours:0,totalCost:0,approvedCost:0,byStatus:{Draft:{count:0,hours:0},Submitted:{count:0,hours:0},Approved:{count:0,hours:0},Rejected:{count:0,hours:0}},byMilestone:{},count:t.length};return t.forEach(s=>{var u,p,f;const n=parseFloat(s.hours_worked||s.hours||0),l=((u=s.resources)==null?void 0:u.cost_price)||0,d=n/8*l;switch(a.totalHours+=n,a.totalCost+=d,a.byStatus[s.status]&&(a.byStatus[s.status].count++,a.byStatus[s.status].hours+=n),s.status){case"Approved":a.approvedHours+=n,a.approvedCost+=d;break;case"Submitted":s.was_rejected||(a.pendingHours+=n);break;case"Draft":a.draftHours+=n;break;case"Rejected":a.rejectedHours+=n;break}if(s.milestone_id){const _=((p=s.milestones)==null?void 0:p.milestone_ref)||"Unknown";a.byMilestone[s.milestone_id]||(a.byMilestone[s.milestone_id]={ref:_,name:((f=s.milestones)==null?void 0:f.name)||"Unknown",hours:0,cost:0}),a.byMilestone[s.milestone_id].hours+=n,a.byMilestone[s.milestone_id].cost+=d}}),a.totalDays=a.totalHours/8,a}catch(t){throw console.error("TimesheetsService getSummary error:",t),t}}async create(r){if(!r.resource_id)throw new Error("resource_id is required");if(!r.date)throw new Error("date is required");const e=parseFloat(r.hours_worked||r.hours||0);if(!e||e<=0)throw new Error("hours must be greater than 0");const t={...r,hours_worked:e,hours:e,date:r.date||r.work_date,work_date:r.work_date||r.date,description:r.description||r.comments||"",comments:r.comments||r.description||"",status:r.status||"Draft"};return super.create(t)}async submit(r){return this.update(r,{status:"Submitted"})}async approve(r){return this.update(r,{status:"Approved"})}async reject(r,e=null){const t={status:"Rejected",was_rejected:!0};return e&&(t.rejection_reason=e),this.update(r,t)}calculateCost(r,e){return r/8*e}calculateBillable(r,e){return r/8*e}}new ue;class de extends h{constructor(){super("expenses")}async getAll(r,e={}){return super.getAll(r,{...e,select:e.select||"*, expense_files(*), resources(name, resource_type, partner_id)",orderBy:e.orderBy||{column:"expense_date",ascending:!1}})}async getByResource(r,e={}){try{let t=i.from(this.tableName).select("*, expense_files(*)").eq("resource_id",r).order("expense_date",{ascending:!1});e.start&&(t=t.gte("expense_date",e.start)),e.end&&(t=t.lte("expense_date",e.end));const{data:a,error:s}=await t;if(s)throw s;return a||[]}catch(t){throw console.error("ExpensesService getByResource error:",t),t}}async getByPartner(r,e={}){try{const{data:t}=await i.from("resources").select("id").eq("partner_id",r);if(!t||t.length===0)return[];const a=t.map(d=>d.id);let s=i.from(this.tableName).select("*, expense_files(*)").in("resource_id",a).order("expense_date",{ascending:!1});e.start&&(s=s.gte("expense_date",e.start)),e.end&&(s=s.lte("expense_date",e.end)),e.procurementMethod&&(s=s.eq("procurement_method",e.procurementMethod));const{data:n,error:l}=await s;if(l)throw l;return n||[]}catch(t){throw console.error("ExpensesService getByPartner error:",t),t}}async getPartnerProcuredForInvoice(r,e){if(!e.start||!e.end)throw new Error("Date range (start and end) is required for invoice queries");return this.getByPartner(r,{...e,procurementMethod:"partner"})}async getSummary(r,e={}){try{const t=await this.getAll(r,e),a={total:0,chargeable:0,nonChargeable:0,supplierProcured:0,partnerProcured:0,byCategory:{Travel:0,Accommodation:0,Sustenance:0},byStatus:{Draft:0,Submitted:0,Approved:0,Rejected:0,Paid:0},count:t.length};return t.forEach(s=>{const n=parseFloat(s.amount||0);a.total+=n,s.chargeable_to_customer!==!1?a.chargeable+=n:a.nonChargeable+=n,s.procurement_method==="partner"?a.partnerProcured+=n:a.supplierProcured+=n,a.byCategory[s.category]!==void 0&&(a.byCategory[s.category]+=n),a.byStatus[s.status]!==void 0&&(a.byStatus[s.status]+=n)}),a}catch(t){throw console.error("ExpensesService getSummary error:",t),t}}async create(r){if(!r.resource_id)throw new Error("resource_id is required");if(!r.category)throw new Error("category is required");if(!r.amount||r.amount<=0)throw new Error("amount must be greater than 0");const e={...r,status:r.status||"Draft",chargeable_to_customer:r.chargeable_to_customer??!0,procurement_method:r.procurement_method||"supplier"};return super.create(e)}async submit(r){return this.update(r,{status:"Submitted"})}async approve(r){return this.update(r,{status:"Approved"})}async reject(r,e=null){const t={status:"Rejected"};return e&&(t.rejection_reason=e),this.update(r,t)}async markPaid(r){return this.update(r,{status:"Paid"})}}new de;class me extends h{constructor(){super("partner_invoices")}async getAll(r,e={}){return super.getAll(r,{...e,select:e.select||"*, partners(name)",orderBy:e.orderBy||{column:"invoice_date",ascending:!1}})}async getByPartner(r,e={}){try{let t=i.from(this.tableName).select("*").eq("partner_id",r).order("invoice_date",{ascending:!1});e.status&&(t=t.eq("status",e.status));const{data:a,error:s}=await t;if(s)throw s;return a||[]}catch(t){throw console.error("InvoicingService getByPartner error:",t),t}}async getWithLines(r){try{const{data:e,error:t}=await i.from(this.tableName).select("*, partners(name, contact_name, contact_email, payment_terms)").eq("id",r).single();if(t)throw t;if(!e)return null;const{data:a,error:s}=await i.from("partner_invoice_lines").select("*").eq("invoice_id",r).order("line_type",{ascending:!0}).order("resource_name",{ascending:!0}).order("line_date",{ascending:!0});if(s)throw s;const n={timesheets:(a||[]).filter(l=>l.line_type==="timesheet"),supplierExpenses:(a||[]).filter(l=>l.line_type==="supplier_expense"),partnerExpenses:(a||[]).filter(l=>l.line_type==="expense")};return{...e,lines:a||[],groupedLines:n}}catch(e){throw console.error("InvoicingService getWithLines error:",e),e}}async generateInvoiceNumber(r){try{const t=`INV-${new Date().getFullYear()}-`,{data:a,error:s}=await i.from(this.tableName).select("invoice_number").eq("project_id",r).like("invoice_number",`${t}%`).order("invoice_number",{ascending:!1}).limit(1);if(s)throw s;let n=1;if(a&&a.length>0){const l=a[0].invoice_number,d=parseInt(l.replace(t,""),10);isNaN(d)||(n=d+1)}return`${t}${String(n).padStart(3,"0")}`}catch(e){throw console.error("InvoicingService generateInvoiceNumber error:",e),e}}async generateInvoice(r){const{projectId:e,partnerId:t,periodStart:a,periodEnd:s,createdBy:n,notes:l,includeSubmitted:d=!0}=r;try{const{data:u,error:p}=await i.from("resources").select("id, name, cost_price").eq("partner_id",t);if(p)throw p;if(!u||u.length===0)throw new Error("No resources linked to this partner");const f=u.map(c=>c.id),_={};u.forEach(c=>{_[c.id]=c});const H=d?["Approved","Submitted"]:["Approved"],{data:U,error:D}=await i.from("timesheets").select("id, date, hours_worked, hours, status, resource_id").in("resource_id",f).gte("date",a).lte("date",s).in("status",H);if(D)throw D;const{data:E,error:k}=await i.from("expenses").select("id, expense_date, category, reason, amount, resource_id, resource_name, procurement_method, chargeable_to_customer, status").in("resource_id",f).gte("expense_date",a).lte("expense_date",s).in("status",["Approved","Submitted","Paid"]);if(k)throw k;const G=(E||[]).filter(c=>c.procurement_method==="partner"),K=(E||[]).filter(c=>c.procurement_method==="supplier");let b=0,A=0;const B=[],g={};(U||[]).forEach(c=>{g[c.resource_id]||(g[c.resource_id]=[]),g[c.resource_id].push(c)}),Object.keys(g).forEach(c=>{const m=_[c];g[c].forEach(y=>{const w=parseFloat(y.hours_worked||y.hours||0),N=(m==null?void 0:m.cost_price)||0,W=w/8,q=W*N;b+=q,A+=q,B.push({line_type:"timesheet",timesheet_id:y.id,expense_id:null,description:`${(m==null?void 0:m.name)||"Unknown"} - ${w}h (${W.toFixed(2)} days)`,quantity:w,unit_price:N,line_total:q,resource_name:m==null?void 0:m.name,line_date:y.date,hours:w,cost_price:N,source_status:y.status,chargeable_to_customer:!0,procurement_method:null,expense_category:null})})});let v=0,P=0,I=0;const L=[];G.forEach(c=>{const m=parseFloat(c.amount||0);v+=m,c.chargeable_to_customer?P+=m:I+=m,L.push({line_type:"expense",timesheet_id:null,expense_id:c.id,description:`${c.resource_name} - ${c.category}: ${c.reason}`,quantity:1,unit_price:m,line_total:m,resource_name:c.resource_name,line_date:c.expense_date,hours:null,cost_price:null,source_status:c.status,chargeable_to_customer:c.chargeable_to_customer,procurement_method:"partner",expense_category:c.category})});let C=0,j=0,T=0;const $=[];K.forEach(c=>{const m=parseFloat(c.amount||0);C+=m,c.chargeable_to_customer?j+=m:T+=m,$.push({line_type:"supplier_expense",timesheet_id:null,expense_id:c.id,description:`${c.resource_name} - ${c.category}: ${c.reason}`,quantity:1,unit_price:m,line_total:m,resource_name:c.resource_name,line_date:c.expense_date,hours:null,cost_price:null,source_status:c.status,chargeable_to_customer:c.chargeable_to_customer,procurement_method:"supplier",expense_category:c.category})});const Q=b+v,V=A+P+j,Y=I+T,Z=await this.generateInvoiceNumber(e),{data:M,error:F}=await i.from(this.tableName).insert({project_id:e,partner_id:t,invoice_number:Z,invoice_date:new Date().toISOString().split("T")[0],period_start:a,period_end:s,timesheet_total:b,expense_total:v,supplier_expense_total:C,invoice_total:Q,chargeable_total:V,non_chargeable_total:Y,status:"Draft",notes:l||null,created_by:n}).select().single();if(F)throw F;const R=[...B,...L,...$].map(c=>({...c,invoice_id:M.id}));if(R.length>0){const{error:c}=await i.from("partner_invoice_lines").insert(R);if(c)throw c}return this.getWithLines(M.id)}catch(u){throw console.error("InvoicingService generateInvoice error:",u),u}}async updateStatus(r,e){const t={status:e};return e==="Sent"?t.sent_at=new Date().toISOString():e==="Paid"&&(t.paid_at=new Date().toISOString()),this.update(r,t)}async markSent(r){return this.updateStatus(r,"Sent")}async markPaid(r){return this.updateStatus(r,"Paid")}async cancel(r){return this.updateStatus(r,"Cancelled")}async getPartnerStats(r){try{const{data:e,error:t}=await i.from(this.tableName).select("status, invoice_total").eq("partner_id",r);if(t)throw t;const a={total:0,draft:0,sent:0,paid:0,cancelled:0,count:(e==null?void 0:e.length)||0};return(e||[]).forEach(s=>{const n=parseFloat(s.invoice_total||0);switch(a.total+=n,s.status){case"Draft":a.draft+=n;break;case"Sent":a.sent+=n;break;case"Paid":a.paid+=n;break;case"Cancelled":a.cancelled+=n;break}}),a}catch(e){throw console.error("InvoicingService getPartnerStats error:",e),e}}}const be=new me;class he extends h{constructor(){super("milestones")}async getAllWithStats(r){try{const e=await this.getAll(r,{orderBy:{column:"start_date",ascending:!0}}),{data:t}=await i.from("timesheets").select("milestone_id, hours_worked").eq("project_id",r).not("milestone_id","is",null),a={};return(t||[]).forEach(s=>{a[s.milestone_id]||(a[s.milestone_id]=0),a[s.milestone_id]+=parseFloat(s.hours_worked||0)}),e.map(s=>({...s,logged_hours:a[s.id]||0,logged_days:(a[s.id]||0)/8}))}catch(e){throw console.error("MilestonesService getAllWithStats error:",e),e}}async getWithDeliverables(r){try{const{data:e,error:t}=await i.from(this.tableName).select("*").eq("id",r).single();if(t)throw t;const{data:a,error:s}=await i.from("deliverables").select("*").eq("milestone_id",r).order("due_date",{ascending:!0});if(s)throw s;return{...e,deliverables:a||[]}}catch(e){throw console.error("MilestonesService getWithDeliverables error:",e),e}}async getByStatus(r,e){return this.getAll(r,{filters:[{column:"status",operator:"eq",value:e}],orderBy:{column:"start_date",ascending:!0}})}async getUpcoming(r,e=30){try{const t=new Date().toISOString().split("T")[0],a=new Date;a.setDate(a.getDate()+e);const s=a.toISOString().split("T")[0],{data:n,error:l}=await i.from(this.tableName).select("*").eq("project_id",r).gte("end_date",t).lte("end_date",s).neq("status","Completed").order("end_date",{ascending:!0});if(l)throw l;return n||[]}catch(t){throw console.error("MilestonesService getUpcoming error:",t),t}}async updateStatus(r,e){return this.update(r,{status:e})}async updateCompletion(r,e){const t={completion_percentage:e};return e>=100&&(t.status="Completed"),this.update(r,t)}}new he;class pe extends h{constructor(){super("deliverables")}async getAllWithMilestones(r){return this.getAll(r,{select:"*, milestones(name, reference)",orderBy:{column:"due_date",ascending:!0}})}async getByMilestone(r){try{const{data:e,error:t}=await i.from(this.tableName).select("*").eq("milestone_id",r).order("due_date",{ascending:!0});if(t)throw t;return e||[]}catch(e){throw console.error("DeliverablesService getByMilestone error:",e),e}}async getByStatus(r,e){return this.getAll(r,{filters:[{column:"status",operator:"eq",value:e}],orderBy:{column:"due_date",ascending:!0}})}async getOverdue(r){try{const e=new Date().toISOString().split("T")[0],{data:t,error:a}=await i.from(this.tableName).select("*, milestones(name)").eq("project_id",r).lt("due_date",e).not("status","in",'("Delivered","Cancelled")').order("due_date",{ascending:!0});if(a)throw a;return t||[]}catch(e){throw console.error("DeliverablesService getOverdue error:",e),e}}async getUpcoming(r,e=14){try{const t=new Date().toISOString().split("T")[0],a=new Date;a.setDate(a.getDate()+e);const s=a.toISOString().split("T")[0],{data:n,error:l}=await i.from(this.tableName).select("*, milestones(name)").eq("project_id",r).gte("due_date",t).lte("due_date",s).not("status","eq","Delivered").order("due_date",{ascending:!0});if(l)throw l;return n||[]}catch(t){throw console.error("DeliverablesService getUpcoming error:",t),t}}async updateStatus(r,e,t){const a={status:e};return e==="Submitted"?(a.submitted_date=new Date().toISOString(),a.submitted_by=t):e==="Delivered"&&(a.delivered_date=new Date().toISOString(),a.delivered_by=t),this.update(r,a)}async submit(r,e){return this.updateStatus(r,"Submitted",e)}async markDelivered(r,e){return this.updateStatus(r,"Delivered",e)}async reject(r,e){return this.update(r,{status:"Rejected",rejection_reason:e})}}new pe;class fe extends h{constructor(){super("kpis")}async getAllWithStatus(r){try{return(await this.getAll(r,{orderBy:{column:"name",ascending:!0}})).map(t=>({...t,rag_status:this.calculateRAG(t)}))}catch(e){throw console.error("KPIsService getAllWithStatus error:",e),e}}calculateRAG(r){if(!r.target_value||r.actual_value===null||r.actual_value===void 0)return"Unknown";const e=parseFloat(r.actual_value),t=parseFloat(r.target_value),a=parseFloat(r.threshold_amber||10);return r.trend==="higher_better"?e>=t?"Green":e>=t*(1-a/100)?"Amber":"Red":e<=t?"Green":e<=t*(1+a/100)?"Amber":"Red"}async getByRAGStatus(r,e){try{return(await this.getAllWithStatus(r)).filter(a=>a.rag_status===e)}catch(t){throw console.error("KPIsService getByRAGStatus error:",t),t}}async getNeedingAttention(r){try{return(await this.getAllWithStatus(r)).filter(t=>t.rag_status==="Amber"||t.rag_status==="Red")}catch(e){throw console.error("KPIsService getNeedingAttention error:",e),e}}async updateActualValue(r,e){return this.update(r,{actual_value:e,last_updated:new Date().toISOString()})}async getHistory(r,e=12){try{const{data:t,error:a}=await i.from("kpi_history").select("*").eq("kpi_id",r).order("recorded_at",{ascending:!1}).limit(e);if(a)throw a;return t||[]}catch(t){return console.warn("KPI history not available:",t.message),[]}}async getSummary(r){try{const e=await this.getAllWithStatus(r);return{total:e.length,green:e.filter(t=>t.rag_status==="Green").length,amber:e.filter(t=>t.rag_status==="Amber").length,red:e.filter(t=>t.rag_status==="Red").length,unknown:e.filter(t=>t.rag_status==="Unknown").length}}catch(e){throw console.error("KPIsService getSummary error:",e),e}}}new fe;class ge extends h{constructor(){super("quality_standards")}async getAllWithStatus(r){try{return(await this.getAll(r,{orderBy:{column:"name",ascending:!0}})).map(t=>({...t,compliance_status:this.calculateCompliance(t)}))}catch(e){throw console.error("QualityStandardsService getAllWithStatus error:",e),e}}calculateCompliance(r){if(r.actual_value===null||r.actual_value===void 0)return"Not Measured";const e=parseFloat(r.actual_value),t=parseFloat(r.target_value||0);return e>=t?"Compliant":e>=t*.9?"Near Compliant":"Non-Compliant"}async getNonCompliant(r){try{return(await this.getAllWithStatus(r)).filter(t=>t.compliance_status==="Non-Compliant")}catch(e){throw console.error("QualityStandardsService getNonCompliant error:",e),e}}async updateMeasurement(r,e,t){return this.update(r,{actual_value:e,measurement_notes:t,last_measured:new Date().toISOString()})}async getSummary(r){try{const e=await this.getAllWithStatus(r);return{total:e.length,compliant:e.filter(t=>t.compliance_status==="Compliant").length,nearCompliant:e.filter(t=>t.compliance_status==="Near Compliant").length,nonCompliant:e.filter(t=>t.compliance_status==="Non-Compliant").length,notMeasured:e.filter(t=>t.compliance_status==="Not Measured").length}}catch(e){throw console.error("QualityStandardsService getSummary error:",e),e}}}new ge;export{be as i,we as p,Se as r};
