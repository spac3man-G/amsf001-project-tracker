import{s as i}from"./index-BiMCcVir.js";const J={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function X(n){return n==null?"":typeof n!="string"?String(n):n.replace(/[&<>"'`=\/]/g,t=>J[t])}function v(n,t={}){const{maxLength:e=1e4,trim:r=!0,normalizeWhitespace:a=!0}=t;if(n==null)return"";typeof n!="string"&&(n=String(n));let s=n;return s=s.replace(/\0/g,""),s=s.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g,""),r&&(s=s.trim()),a&&(s=s.replace(/[ \t]+/g," ")),s.length>e&&(s=s.substring(0,e)),s}function O(n,t=255){return n==null?"":(typeof n!="string"&&(n=String(n)),v(n,{maxLength:t}).replace(/[\r\n]/g," ").replace(/\s+/g," ").trim())}function ee(n,t=1e4){return n==null?"":(typeof n!="string"&&(n=String(n)),v(n,{maxLength:t,normalizeWhitespace:!1}).replace(/\r\n/g,`
`).replace(/\r/g,`
`).replace(/\n{3,}/g,`

`).trim())}function re(n){return n?O(n,254).toLowerCase():""}function y(n,t={}){const{min:e=-1/0,max:r=1/0,decimals:a=2}=t;if(n==null||n==="")return null;let s=String(n).replace(/[^0-9.\-]/g,""),o=parseFloat(s);return isNaN(o)?null:(o=Math.max(e,Math.min(r,o)),o=Math.round(o*Math.pow(10,a))/Math.pow(10,a),o)}function te(n){const t=y(n,{min:0,decimals:2});return t!==null?Math.round(t*100)/100:null}function ae(n){const t=y(n,{min:0,max:24,decimals:1});return t===null?null:Math.round(t*2)/2}function se(n){return y(n,{min:0,max:100,decimals:1})}function oe(n){if(!n)return null;const t=String(n).trim();return/^(javascript|data|vbscript):/i.test(t)?null:/^(https?:\/\/|\/|#)/i.test(t)?t:`https://${t}`}function ne(n,t={}){if(!n||typeof n!="object")return n;const e={...n};for(const[r,a]of Object.entries(t)){if(e[r]===void 0)continue;const{type:s="text",maxLength:o}=a;switch(s){case"singleLine":e[r]=O(e[r],o);break;case"multiLine":e[r]=ee(e[r],o);break;case"email":e[r]=re(e[r]);break;case"number":e[r]=y(e[r],a);break;case"currency":e[r]=te(e[r]);break;case"hours":e[r]=ae(e[r]);break;case"percentage":e[r]=se(e[r]);break;case"url":e[r]=oe(e[r]);break;case"html":e[r]=X(e[r]);break;default:e[r]=v(e[r],{maxLength:o})}}return e}const ie={timesheet:{description:{type:"multiLine",maxLength:2e3},hours_worked:{type:"hours"}},expense:{reason:{type:"multiLine",maxLength:2e3},amount:{type:"currency"}},resource:{name:{type:"singleLine",maxLength:100},email:{type:"email"},role:{type:"singleLine",maxLength:100},notes:{type:"multiLine",maxLength:5e3}},partner:{name:{type:"singleLine",maxLength:200},contact_name:{type:"singleLine",maxLength:100},contact_email:{type:"email"},notes:{type:"multiLine",maxLength:5e3}},milestone:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3}},deliverable:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3}},kpi:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3},target_value:{type:"number",decimals:2},actual_value:{type:"number",decimals:2}},qualityStandard:{name:{type:"singleLine",maxLength:200},description:{type:"multiLine",maxLength:5e3},target_value:{type:"percentage"}}};function z(n,t){const e=ie[n];return e?ne(t,e):t}class h{constructor(t,e={}){this.tableName=t,this.supportsSoftDelete=e.supportsSoftDelete!==!1,this.sanitizeConfig=e.sanitizeConfig||null}getSoftDeleteFilter(){return this.supportsSoftDelete?"is_deleted.is.null,is_deleted.eq.false":null}async getAll(t,e={}){try{let r=i.from(this.tableName).select(e.select||"*").eq("project_id",t);this.supportsSoftDelete&&!e.includeDeleted&&(r=r.or(this.getSoftDeleteFilter())),e.filters&&Array.isArray(e.filters)&&e.filters.forEach(o=>{const{column:l,operator:d,value:u}=o;switch(d){case"eq":r=r.eq(l,u);break;case"neq":r=r.neq(l,u);break;case"gt":r=r.gt(l,u);break;case"gte":r=r.gte(l,u);break;case"lt":r=r.lt(l,u);break;case"lte":r=r.lte(l,u);break;case"like":r=r.like(l,u);break;case"ilike":r=r.ilike(l,u);break;case"in":r=r.in(l,u);break;case"is":r=r.is(l,u);break;default:r=r.eq(l,u)}}),e.orderBy&&(r=r.order(e.orderBy.column,{ascending:e.orderBy.ascending??!0}));const{data:a,error:s}=await r;if(s)throw s;return a||[]}catch(r){throw r}}async getDeleted(t){if(!this.supportsSoftDelete)return[];try{const{data:e,error:r}=await i.from(this.tableName).select("*").eq("project_id",t).eq("is_deleted",!0).order("deleted_at",{ascending:!1});if(r)throw r;return e||[]}catch(e){throw e}}async getById(t,e={}){try{let r=i.from(this.tableName).select(e.select||"*").eq("id",t);this.supportsSoftDelete&&!e.includeDeleted&&(r=r.or(this.getSoftDeleteFilter()));const{data:a,error:s}=await r.single();if(s){if(s.code==="PGRST116")return null;throw s}return a}catch(r){throw r}}async create(t){try{if(!t.project_id)throw new Error("project_id is required");let e=t;this.sanitizeConfig&&(e=z(this.sanitizeConfig,t)),this.supportsSoftDelete&&(delete e.is_deleted,delete e.deleted_at,delete e.deleted_by);const{data:r,error:a}=await i.from(this.tableName).insert(e).select().single();if(a)throw a;return r}catch(e){throw e}}async update(t,e){try{let r=e;this.sanitizeConfig&&(r=z(this.sanitizeConfig,e));const a={...r,updated_at:new Date().toISOString()};delete a.is_deleted,delete a.deleted_at,delete a.deleted_by;const{data:s,error:o}=await i.from(this.tableName).update(a).eq("id",t).select().single();if(o)throw o;return s}catch(r){throw r}}async delete(t,e=null){try{if(this.supportsSoftDelete){const{error:r}=await i.from(this.tableName).update({is_deleted:!0,deleted_at:new Date().toISOString(),deleted_by:e}).eq("id",t);if(r)throw r}else{const{error:r}=await i.from(this.tableName).delete().eq("id",t);if(r)throw r}return!0}catch(r){throw r}}async hardDelete(t){try{const{error:e}=await i.from(this.tableName).delete().eq("id",t);if(e)throw e;return!0}catch(e){throw e}}async restore(t){if(!this.supportsSoftDelete)throw new Error("This entity does not support soft delete");try{const{data:e,error:r}=await i.from(this.tableName).update({is_deleted:!1,deleted_at:null,deleted_by:null}).eq("id",t).select().single();if(r)throw r;return e}catch(e){throw e}}async exists(t){try{let e=i.from(this.tableName).select("id",{count:"exact",head:!0}).eq("id",t);this.supportsSoftDelete&&(e=e.or(this.getSoftDeleteFilter()));const{count:r,error:a}=await e;if(a)throw a;return r>0}catch(e){throw e}}async count(t,e=[]){try{let r=i.from(this.tableName).select("id",{count:"exact",head:!0}).eq("project_id",t);this.supportsSoftDelete&&(r=r.or(this.getSoftDeleteFilter())),e.forEach(o=>{const{column:l,operator:d,value:u}=o;d==="eq"?r=r.eq(l,u):d==="in"&&(r=r.in(l,u))});const{count:a,error:s}=await r;if(s)throw s;return a||0}catch(r){throw r}}}class ce extends h{constructor(){super("partners")}async getAll(t){return super.getAll(t,{orderBy:{column:"name",ascending:!0}})}async getActive(t){return super.getAll(t,{filters:[{column:"is_active",operator:"eq",value:!0}],orderBy:{column:"name",ascending:!0}})}async getWithResources(t){try{const{data:e,error:r}=await i.from("partners").select(`
          *,
          resources (
            id,
            name,
            daily_rate,
            cost_price,
            is_active
          )
        `).eq("id",t).single();if(r){if(r.code==="PGRST116")return null;throw r}return e}catch(e){throw e}}async getSummary(t){try{const{data:e,error:r}=await i.from("partners").select(`
          id,
          name,
          contact_name,
          contact_email,
          payment_terms,
          is_active,
          created_at
        `).eq("project_id",t).order("name",{ascending:!0});if(r)throw r;return e||[]}catch(e){throw e}}async create(t){if(!t.name?.trim())throw new Error("Partner name is required");if(await this.findByName(t.project_id,t.name))throw new Error(`Partner "${t.name}" already exists`);return super.create({...t,name:t.name.trim(),is_active:t.is_active??!0,payment_terms:t.payment_terms||"Net 30"})}async findByName(t,e){try{const{data:r,error:a}=await i.from("partners").select("*").eq("project_id",t).ilike("name",e.trim()).single();if(a){if(a.code==="PGRST116")return null;throw a}return r}catch(r){if(r.code==="PGRST116")return null;throw r}}async toggleActive(t){const e=await this.getById(t);if(!e)throw new Error("Partner not found");return this.update(t,{is_active:!e.is_active})}async getForSelect(t,e=!0){return(e?await this.getActive(t):await this.getAll(t)).map(a=>({value:a.id,label:a.name}))}}const we=new ce;class le extends h{constructor(){super("resources")}async getAll(t,e={}){const{includePartner:r=!0,activeOnly:a=!1}=e;let s="*";r&&(s="*, partner:partners(id, name, is_active)");let o=i.from(this.tableName).select(s).eq("project_id",t).order("name");a&&(o=o.eq("is_active",!0));const{data:l,error:d}=await o;if(d)throw d;return l||[]}async getById(t){const{data:e,error:r}=await i.from(this.tableName).select("*, partner:partners(id, name, contact_name, contact_email, is_active)").eq("id",t).single();if(r)throw r;return e}async getByType(t,e){const{data:r,error:a}=await i.from(this.tableName).select("*, partner:partners(id, name)").eq("project_id",t).eq("resource_type",e).order("name");if(a)throw a;return r||[]}async getByPartner(t){const{data:e,error:r}=await i.from(this.tableName).select("*").eq("partner_id",t).order("name");if(r)throw r;return e||[]}async getWithTimesheetSummary(t){const e=await this.getById(t);if(!e)return null;const{data:r,error:a}=await i.from("timesheets").select("id, hours_worked, hours, status, was_rejected, date").eq("resource_id",t);let s=0,o=0,l=0;return r&&r.forEach(d=>{const u=parseFloat(d.hours_worked||d.hours||0);s+=u,d.status==="Approved"?o+=u:d.status==="Submitted"&&!d.was_rejected&&(l+=u)}),{...e,timesheetSummary:{totalEntries:r?.length||0,totalHours:s,approvedHours:o,pendingHours:l,daysWorked:s/8}}}async create(t){if(!t.name?.trim())throw new Error("Resource name is required");if(!t.project_id)throw new Error("Project ID is required");if(!t.email?.trim())throw new Error("Email is required");t.resource_type==="third_party"&&t.partner_id,t.resource_type==="internal"&&(t.partner_id=null);const{data:e,error:r}=await i.from(this.tableName).insert([t]).select("*, partner:partners(id, name)").single();if(r)throw r;return e}async update(t,e){e.resource_type==="internal"&&(e.partner_id=null),e.updated_at=new Date().toISOString();const{data:r,error:a}=await i.from(this.tableName).update(e).eq("id",t).select("*, partner:partners(id, name)").single();if(a)throw a;return r}async linkToPartner(t,e){const r={partner_id:e,resource_type:e?"third_party":"internal",updated_at:new Date().toISOString()};return this.update(t,r)}async toggleType(t,e=null){const r=await this.getById(t);if(!r)throw new Error("Resource not found");const a=r.resource_type==="third_party"?"internal":"third_party";return this.update(t,{resource_type:a,partner_id:a==="third_party"?e:null})}async getForSelect(t){const{data:e,error:r}=await i.from(this.tableName).select("id, name, resource_type, role").eq("project_id",t).order("name");if(r)throw r;return e||[]}calculateMargin(t,e){if(!t||t===0||!e)return{percent:null,amount:null,status:"unknown"};const r=(t-e)/t*100,a=t-e;let s="critical";return r>=25?s="good":r>=10&&(s="low"),{percent:r,amount:a,status:s}}async getUtilization(t){const e=await this.getWithTimesheetSummary(t);if(!e)return null;const r=e.days_allocated||0,a=e.timesheetSummary.daysWorked,s=Math.max(0,r-a),o=r>0?a/r*100:0;return{resourceId:t,resourceName:e.name,daysAllocated:r,daysUsed:a,remaining:s,utilizationPercent:o,totalValue:(e.daily_rate||0)*r,valueUsed:(e.daily_rate||0)*a}}}const Se=new le;class ue extends h{constructor(){super("timesheets")}async getAll(t,e={}){return super.getAll(t,{...e,select:e.select||`
      *,
      resources(id, name, email, daily_rate, cost_price),
      milestones(id, milestone_ref, name)
    `,orderBy:e.orderBy||{column:"date",ascending:!1}})}async getByResource(t,e={}){try{let r=i.from(this.tableName).select("*, milestones(id, milestone_ref, name)").eq("resource_id",t).order("date",{ascending:!1});e.start&&(r=r.gte("date",e.start)),e.end&&(r=r.lte("date",e.end)),e.status&&(r=r.eq("status",e.status));const{data:a,error:s}=await r;if(s)throw s;return a||[]}catch(r){throw r}}async getByPartner(t,e={}){try{const{data:r}=await i.from("resources").select("id, name, cost_price").eq("partner_id",t);if(!r||r.length===0)return[];const a=r.map(d=>d.id);let s=i.from(this.tableName).select("*, resources(id, name, cost_price), milestones(id, milestone_ref, name)").in("resource_id",a).order("date",{ascending:!1});e.start&&(s=s.gte("date",e.start)),e.end&&(s=s.lte("date",e.end)),e.status&&(s=s.eq("status",e.status));const{data:o,error:l}=await s;if(l)throw l;return o||[]}catch(r){throw r}}async getApprovedForInvoice(t,e){if(!e.start||!e.end)throw new Error("Date range (start and end) is required for invoice queries");return this.getByPartner(t,{...e,status:"Approved"})}async getSummary(t,e={}){try{const r=await this.getAll(t,e),a={totalHours:0,totalDays:0,approvedHours:0,pendingHours:0,draftHours:0,rejectedHours:0,totalCost:0,approvedCost:0,byStatus:{Draft:{count:0,hours:0},Submitted:{count:0,hours:0},Approved:{count:0,hours:0},Rejected:{count:0,hours:0}},byMilestone:{},count:r.length};return r.forEach(s=>{const o=parseFloat(s.hours_worked||s.hours||0),l=s.resources?.cost_price||0,d=o/8*l;switch(a.totalHours+=o,a.totalCost+=d,a.byStatus[s.status]&&(a.byStatus[s.status].count++,a.byStatus[s.status].hours+=o),s.status){case"Approved":a.approvedHours+=o,a.approvedCost+=d;break;case"Submitted":s.was_rejected||(a.pendingHours+=o);break;case"Draft":a.draftHours+=o;break;case"Rejected":a.rejectedHours+=o;break}if(s.milestone_id){const u=s.milestones?.milestone_ref||"Unknown";a.byMilestone[s.milestone_id]||(a.byMilestone[s.milestone_id]={ref:u,name:s.milestones?.name||"Unknown",hours:0,cost:0}),a.byMilestone[s.milestone_id].hours+=o,a.byMilestone[s.milestone_id].cost+=d}}),a.totalDays=a.totalHours/8,a}catch(r){throw r}}async create(t){if(!t.resource_id)throw new Error("resource_id is required");if(!t.date)throw new Error("date is required");const e=parseFloat(t.hours_worked||t.hours||0);if(!e||e<=0)throw new Error("hours must be greater than 0");const r={...t,hours_worked:e,hours:e,date:t.date||t.work_date,work_date:t.work_date||t.date,description:t.description||t.comments||"",comments:t.comments||t.description||"",status:t.status||"Draft"};return super.create(r)}async submit(t){return this.update(t,{status:"Submitted"})}async approve(t){return this.update(t,{status:"Approved"})}async reject(t,e=null){const r={status:"Rejected",was_rejected:!0};return e&&(r.rejection_reason=e),this.update(t,r)}calculateCost(t,e){return t/8*e}calculateBillable(t,e){return t/8*e}}new ue;class de extends h{constructor(){super("expenses")}async getAll(t,e={}){return super.getAll(t,{...e,select:e.select||"*, expense_files(*), resources(name, resource_type, partner_id)",orderBy:e.orderBy||{column:"expense_date",ascending:!1}})}async getByResource(t,e={}){try{let r=i.from(this.tableName).select("*, expense_files(*)").eq("resource_id",t).order("expense_date",{ascending:!1});e.start&&(r=r.gte("expense_date",e.start)),e.end&&(r=r.lte("expense_date",e.end));const{data:a,error:s}=await r;if(s)throw s;return a||[]}catch(r){throw r}}async getByPartner(t,e={}){try{const{data:r}=await i.from("resources").select("id").eq("partner_id",t);if(!r||r.length===0)return[];const a=r.map(d=>d.id);let s=i.from(this.tableName).select("*, expense_files(*)").in("resource_id",a).order("expense_date",{ascending:!1});e.start&&(s=s.gte("expense_date",e.start)),e.end&&(s=s.lte("expense_date",e.end)),e.procurementMethod&&(s=s.eq("procurement_method",e.procurementMethod));const{data:o,error:l}=await s;if(l)throw l;return o||[]}catch(r){throw r}}async getPartnerProcuredForInvoice(t,e){if(!e.start||!e.end)throw new Error("Date range (start and end) is required for invoice queries");return this.getByPartner(t,{...e,procurementMethod:"partner"})}async getSummary(t,e={}){try{const r=await this.getAll(t,e),a={total:0,chargeable:0,nonChargeable:0,supplierProcured:0,partnerProcured:0,byCategory:{Travel:0,Accommodation:0,Sustenance:0},byStatus:{Draft:0,Submitted:0,Approved:0,Rejected:0,Paid:0},count:r.length};return r.forEach(s=>{const o=parseFloat(s.amount||0);a.total+=o,s.chargeable_to_customer!==!1?a.chargeable+=o:a.nonChargeable+=o,s.procurement_method==="partner"?a.partnerProcured+=o:a.supplierProcured+=o,a.byCategory[s.category]!==void 0&&(a.byCategory[s.category]+=o),a.byStatus[s.status]!==void 0&&(a.byStatus[s.status]+=o)}),a}catch(r){throw r}}async create(t){if(!t.resource_id)throw new Error("resource_id is required");if(!t.category)throw new Error("category is required");if(!t.amount||t.amount<=0)throw new Error("amount must be greater than 0");const e={...t,status:t.status||"Draft",chargeable_to_customer:t.chargeable_to_customer??!0,procurement_method:t.procurement_method||"supplier"};return super.create(e)}async submit(t){return this.update(t,{status:"Submitted"})}async approve(t){return this.update(t,{status:"Approved"})}async reject(t,e=null){const r={status:"Rejected"};return e&&(r.rejection_reason=e),this.update(t,r)}async markPaid(t){return this.update(t,{status:"Paid"})}}new de;class me extends h{constructor(){super("partner_invoices")}async getAll(t,e={}){return super.getAll(t,{...e,select:e.select||"*, partners(name)",orderBy:e.orderBy||{column:"invoice_date",ascending:!1}})}async getByPartner(t,e={}){try{let r=i.from(this.tableName).select("*").eq("partner_id",t).order("invoice_date",{ascending:!1});e.status&&(r=r.eq("status",e.status));const{data:a,error:s}=await r;if(s)throw s;return a||[]}catch(r){throw r}}async getWithLines(t){try{const{data:e,error:r}=await i.from(this.tableName).select("*, partners(name, contact_name, contact_email, payment_terms)").eq("id",t).single();if(r)throw r;if(!e)return null;const{data:a,error:s}=await i.from("partner_invoice_lines").select("*").eq("invoice_id",t).order("line_type",{ascending:!0}).order("resource_name",{ascending:!0}).order("line_date",{ascending:!0});if(s)throw s;const o={timesheets:(a||[]).filter(l=>l.line_type==="timesheet"),supplierExpenses:(a||[]).filter(l=>l.line_type==="supplier_expense"),partnerExpenses:(a||[]).filter(l=>l.line_type==="expense")};return{...e,lines:a||[],groupedLines:o}}catch(e){throw e}}async generateInvoiceNumber(t){try{const r=`INV-${new Date().getFullYear()}-`,{data:a,error:s}=await i.from(this.tableName).select("invoice_number").eq("project_id",t).like("invoice_number",`${r}%`).order("invoice_number",{ascending:!1}).limit(1);if(s)throw s;let o=1;if(a&&a.length>0){const l=a[0].invoice_number,d=parseInt(l.replace(r,""),10);isNaN(d)||(o=d+1)}return`${r}${String(o).padStart(3,"0")}`}catch(e){throw e}}async generateInvoice(t){const{projectId:e,partnerId:r,periodStart:a,periodEnd:s,createdBy:o,notes:l,includeSubmitted:d=!0}=t;try{const{data:u,error:N}=await i.from("resources").select("id, name, cost_price").eq("partner_id",r);if(N)throw N;if(!u||u.length===0)throw new Error("No resources linked to this partner");const q=u.map(c=>c.id),x={};u.forEach(c=>{x[c.id]=c});const H=d?["Approved","Submitted"]:["Approved"],{data:U,error:D}=await i.from("timesheets").select("id, date, hours_worked, hours, status, resource_id").in("resource_id",q).gte("date",a).lte("date",s).in("status",H);if(D)throw D;const{data:E,error:k}=await i.from("expenses").select("id, expense_date, category, reason, amount, resource_id, resource_name, procurement_method, chargeable_to_customer, status").in("resource_id",q).gte("expense_date",a).lte("expense_date",s).in("status",["Approved","Submitted","Paid"]);if(k)throw k;const G=(E||[]).filter(c=>c.procurement_method==="partner"),K=(E||[]).filter(c=>c.procurement_method==="supplier");let _=0,A=0;const B=[],p={};(U||[]).forEach(c=>{p[c.resource_id]||(p[c.resource_id]=[]),p[c.resource_id].push(c)}),Object.keys(p).forEach(c=>{const m=x[c];p[c].forEach(f=>{const g=parseFloat(f.hours_worked||f.hours||0),S=m?.cost_price||0,W=g/8,b=W*S;_+=b,A+=b,B.push({line_type:"timesheet",timesheet_id:f.id,expense_id:null,description:`${m?.name||"Unknown"} - ${g}h (${W.toFixed(2)} days)`,quantity:g,unit_price:S,line_total:b,resource_name:m?.name,line_date:f.date,hours:g,cost_price:S,source_status:f.status,chargeable_to_customer:!0,procurement_method:null,expense_category:null})})});let w=0,P=0,I=0;const L=[];G.forEach(c=>{const m=parseFloat(c.amount||0);w+=m,c.chargeable_to_customer?P+=m:I+=m,L.push({line_type:"expense",timesheet_id:null,expense_id:c.id,description:`${c.resource_name} - ${c.category}: ${c.reason}`,quantity:1,unit_price:m,line_total:m,resource_name:c.resource_name,line_date:c.expense_date,hours:null,cost_price:null,source_status:c.status,chargeable_to_customer:c.chargeable_to_customer,procurement_method:"partner",expense_category:c.category})});let C=0,T=0,j=0;const $=[];K.forEach(c=>{const m=parseFloat(c.amount||0);C+=m,c.chargeable_to_customer?T+=m:j+=m,$.push({line_type:"supplier_expense",timesheet_id:null,expense_id:c.id,description:`${c.resource_name} - ${c.category}: ${c.reason}`,quantity:1,unit_price:m,line_total:m,resource_name:c.resource_name,line_date:c.expense_date,hours:null,cost_price:null,source_status:c.status,chargeable_to_customer:c.chargeable_to_customer,procurement_method:"supplier",expense_category:c.category})});const Q=_+w,V=A+P+T,Y=I+j,Z=await this.generateInvoiceNumber(e),{data:M,error:F}=await i.from(this.tableName).insert({project_id:e,partner_id:r,invoice_number:Z,invoice_date:new Date().toISOString().split("T")[0],period_start:a,period_end:s,timesheet_total:_,expense_total:w,supplier_expense_total:C,invoice_total:Q,chargeable_total:V,non_chargeable_total:Y,status:"Draft",notes:l||null,created_by:o}).select().single();if(F)throw F;const R=[...B,...L,...$].map(c=>({...c,invoice_id:M.id}));if(R.length>0){const{error:c}=await i.from("partner_invoice_lines").insert(R);if(c)throw c}return this.getWithLines(M.id)}catch(u){throw u}}async updateStatus(t,e){const r={status:e};return e==="Sent"?r.sent_at=new Date().toISOString():e==="Paid"&&(r.paid_at=new Date().toISOString()),this.update(t,r)}async markSent(t){return this.updateStatus(t,"Sent")}async markPaid(t){return this.updateStatus(t,"Paid")}async cancel(t){return this.updateStatus(t,"Cancelled")}async getPartnerStats(t){try{const{data:e,error:r}=await i.from(this.tableName).select("status, invoice_total").eq("partner_id",t);if(r)throw r;const a={total:0,draft:0,sent:0,paid:0,cancelled:0,count:e?.length||0};return(e||[]).forEach(s=>{const o=parseFloat(s.invoice_total||0);switch(a.total+=o,s.status){case"Draft":a.draft+=o;break;case"Sent":a.sent+=o;break;case"Paid":a.paid+=o;break;case"Cancelled":a.cancelled+=o;break}}),a}catch(e){throw e}}}const be=new me;class he extends h{constructor(){super("milestones")}async getAllWithStats(t){try{const e=await this.getAll(t,{orderBy:{column:"start_date",ascending:!0}}),{data:r}=await i.from("timesheets").select("milestone_id, hours_worked").eq("project_id",t).not("milestone_id","is",null),a={};return(r||[]).forEach(s=>{a[s.milestone_id]||(a[s.milestone_id]=0),a[s.milestone_id]+=parseFloat(s.hours_worked||0)}),e.map(s=>({...s,logged_hours:a[s.id]||0,logged_days:(a[s.id]||0)/8}))}catch(e){throw e}}async getWithDeliverables(t){try{const{data:e,error:r}=await i.from(this.tableName).select("*").eq("id",t).single();if(r)throw r;const{data:a,error:s}=await i.from("deliverables").select("*").eq("milestone_id",t).order("due_date",{ascending:!0});if(s)throw s;return{...e,deliverables:a||[]}}catch(e){throw e}}async getByStatus(t,e){return this.getAll(t,{filters:[{column:"status",operator:"eq",value:e}],orderBy:{column:"start_date",ascending:!0}})}async getUpcoming(t,e=30){try{const r=new Date().toISOString().split("T")[0],a=new Date;a.setDate(a.getDate()+e);const s=a.toISOString().split("T")[0],{data:o,error:l}=await i.from(this.tableName).select("*").eq("project_id",t).gte("end_date",r).lte("end_date",s).neq("status","Completed").order("end_date",{ascending:!0});if(l)throw l;return o||[]}catch(r){throw r}}async updateStatus(t,e){return this.update(t,{status:e})}async updateCompletion(t,e){const r={completion_percentage:e};return e>=100&&(r.status="Completed"),this.update(t,r)}}new he;class pe extends h{constructor(){super("deliverables")}async getAllWithMilestones(t){return this.getAll(t,{select:"*, milestones(name, reference)",orderBy:{column:"due_date",ascending:!0}})}async getByMilestone(t){try{const{data:e,error:r}=await i.from(this.tableName).select("*").eq("milestone_id",t).order("due_date",{ascending:!0});if(r)throw r;return e||[]}catch(e){throw e}}async getByStatus(t,e){return this.getAll(t,{filters:[{column:"status",operator:"eq",value:e}],orderBy:{column:"due_date",ascending:!0}})}async getOverdue(t){try{const e=new Date().toISOString().split("T")[0],{data:r,error:a}=await i.from(this.tableName).select("*, milestones(name)").eq("project_id",t).lt("due_date",e).not("status","in",'("Delivered","Cancelled")').order("due_date",{ascending:!0});if(a)throw a;return r||[]}catch(e){throw e}}async getUpcoming(t,e=14){try{const r=new Date().toISOString().split("T")[0],a=new Date;a.setDate(a.getDate()+e);const s=a.toISOString().split("T")[0],{data:o,error:l}=await i.from(this.tableName).select("*, milestones(name)").eq("project_id",t).gte("due_date",r).lte("due_date",s).not("status","eq","Delivered").order("due_date",{ascending:!0});if(l)throw l;return o||[]}catch(r){throw r}}async updateStatus(t,e,r){const a={status:e};return e==="Submitted"?(a.submitted_date=new Date().toISOString(),a.submitted_by=r):e==="Delivered"&&(a.delivered_date=new Date().toISOString(),a.delivered_by=r),this.update(t,a)}async submit(t,e){return this.updateStatus(t,"Submitted",e)}async markDelivered(t,e){return this.updateStatus(t,"Delivered",e)}async reject(t,e){return this.update(t,{status:"Rejected",rejection_reason:e})}}new pe;class fe extends h{constructor(){super("kpis")}async getAllWithStatus(t){try{return(await this.getAll(t,{orderBy:{column:"name",ascending:!0}})).map(r=>({...r,rag_status:this.calculateRAG(r)}))}catch(e){throw e}}calculateRAG(t){if(!t.target_value||t.actual_value===null||t.actual_value===void 0)return"Unknown";const e=parseFloat(t.actual_value),r=parseFloat(t.target_value),a=parseFloat(t.threshold_amber||10);return t.trend==="higher_better"?e>=r?"Green":e>=r*(1-a/100)?"Amber":"Red":e<=r?"Green":e<=r*(1+a/100)?"Amber":"Red"}async getByRAGStatus(t,e){try{return(await this.getAllWithStatus(t)).filter(a=>a.rag_status===e)}catch(r){throw r}}async getNeedingAttention(t){try{return(await this.getAllWithStatus(t)).filter(r=>r.rag_status==="Amber"||r.rag_status==="Red")}catch(e){throw e}}async updateActualValue(t,e){return this.update(t,{actual_value:e,last_updated:new Date().toISOString()})}async getHistory(t,e=12){try{const{data:r,error:a}=await i.from("kpi_history").select("*").eq("kpi_id",t).order("recorded_at",{ascending:!1}).limit(e);if(a)throw a;return r||[]}catch{return[]}}async getSummary(t){try{const e=await this.getAllWithStatus(t);return{total:e.length,green:e.filter(r=>r.rag_status==="Green").length,amber:e.filter(r=>r.rag_status==="Amber").length,red:e.filter(r=>r.rag_status==="Red").length,unknown:e.filter(r=>r.rag_status==="Unknown").length}}catch(e){throw e}}}new fe;class ge extends h{constructor(){super("quality_standards")}async getAllWithStatus(t){try{return(await this.getAll(t,{orderBy:{column:"name",ascending:!0}})).map(r=>({...r,compliance_status:this.calculateCompliance(r)}))}catch(e){throw e}}calculateCompliance(t){if(t.actual_value===null||t.actual_value===void 0)return"Not Measured";const e=parseFloat(t.actual_value),r=parseFloat(t.target_value||0);return e>=r?"Compliant":e>=r*.9?"Near Compliant":"Non-Compliant"}async getNonCompliant(t){try{return(await this.getAllWithStatus(t)).filter(r=>r.compliance_status==="Non-Compliant")}catch(e){throw e}}async updateMeasurement(t,e,r){return this.update(t,{actual_value:e,measurement_notes:r,last_measured:new Date().toISOString()})}async getSummary(t){try{const e=await this.getAllWithStatus(t);return{total:e.length,compliant:e.filter(r=>r.compliance_status==="Compliant").length,nearCompliant:e.filter(r=>r.compliance_status==="Near Compliant").length,nonCompliant:e.filter(r=>r.compliance_status==="Non-Compliant").length,notMeasured:e.filter(r=>r.compliance_status==="Not Measured").length}}catch(e){throw e}}}new ge;export{be as i,we as p,Se as r};
